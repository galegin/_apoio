entry getParam
	variables
		numeric vCdEmpresa
		string viParams, voParams, vTpQuebraCFOP, vInOptSimples
	endvariables

	viParams = ""
	putitem viParams, -1, "CD_EMPVALOR"
	putitem viParams, -1, "CD_MOTIVO_ALTVALOR_CMP"
	putitem viParams, -1, "CLIENTE_PDV"	
	activate "ADMSVCO001".GetLstParametro(viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($xCdErro$)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%$item("DESCRICAO", $xCtxErro$)", "ADICIONAL=Operação->TRASVCO004.agrupaTransacao")
		return(-1)
	elseif ($status < 0)
		return(-1)
	endif
	$CdClientePdv$ = $item("CLIENTE_PDV",voParams)	
	
	vCdEmpresa = $item("CD_EMPRESA", $xlpg$)
	viParams = ""
	putitem viParams, -1, "IN_OPT_SIMPLES"
	putitem viParams, -1, "IN_ECF_CARNE"
	putitem viParams, -1, "PADRAO_ECF"
	putitem viParams, -1, "IN_IMP_OBS_ECF_CLI_VISTA"	
	putitem viParams, -1, "CD_MODTRA_OBS_ECF_CARNE" ;-=CANONICO=- (08/02/2008) TAR 215 PRJ 102
	putitem viParams, -1, "TP_DESCRICAO_ITEM_ECF" ;-=CANONICO=- (06/03/2008) TAR 257 PRJ 102
	putitem viParams, -1, "IN_PERGUNTA_IMP_CARNE_ECF" ;-=CANONICO=- (12/05/2008) TAR 303 PRJ 102
	putitem viParams, -1, "CD_MODTRA_ECF_CARTAOPROP" ;MODA 17/08/08
	putitem viParams, -1, "CD_MODTRA_ECF_RECIBOBONUS" ;MODA 17/08/08
	putitem viParams, -1, "IN_PDV_OTIMIZADO" ;MODA 17/08/08
	putitem viParams, -1, "NR_VIAS_ECF_TERMICA" ;-=CANONICO=- Prj 102/516
	putitem viParams, -1, "TEF_ESPACO_ENTRE_CUPOM";-=CANONICO=- Prj 102/512
	putitem viParams, -1, "TP_IMPRESSAO_TEF_PAYGO" ;-=CANONICO=- 30/11/2010 TAR 982 PRJ 102 - Parametro de leitura do arquivo intpos
	putitem viParams, -1, "TP_CODIGO_ITEM_ECF" ;---Elia Proj. 156/669 03/11/2011
	activate "ADMSVCO001".GetParamEmpresa(vCdEmpresa, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($xCdErro$)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%$item("DESCRICAO", $xCtxErro$)", "ADICIONAL=Operação->ECFSVCO010.getParam")
		return(-1)
	elseif ($status < 0)
		return(-1)
	endif
	$PadraoEcf$ = $item("PADRAO_ECF",voParams)
	$InCarne$ = $item("IN_ECF_CARNE", voParams)
	$InImpObsECFCliVista$ = $item("IN_IMP_OBS_ECF_CLI_VISTA",voParams)
	$cdModTraObsEcfCarne$ = $item("CD_MODTRA_OBS_ECF_CARNE",voParams) ;-=CANONICO=- (08/02/2008) TAR 215 PRJ 102
	$tpDescricaoItemEcf$  = $item("TP_DESCRICAO_ITEM_ECF",voParams) ;-=CANONICO=- (06/03/2008) TAR 257 PRJ 102
	$InPerguntaImpCarneEcf$ = $item("IN_PERGUNTA_IMP_CARNE_ECF",voParams);-=CANONICO=- (12/05/2008) TAR 303 PRJ 102
	$cdMmodTraEcfCartaoProp$ = $item("CD_MODTRA_ECF_CARTAOPROP",voParams)	
	$cdModTraEcfReciboBonus$ = $item("CD_MODTRA_ECF_RECIBOBONUS",voParams)
	$inPdvOtimizado$ = 	$item("IN_PDV_OTIMIZADO",voParams)
	vInOptSimples = $item("IN_OPT_SIMPLES", voParams)
	$nrViasEcfTermica$ = $item("NR_VIAS_ECF_TERMICA",voParams)  ;-=CANONICO=- Prj 102/516
	$nrEspacoCupom$    = $item("TEF_ESPACO_ENTRE_CUPOM",voParams) ;-=CANONICO=- Prj 102/516
	$tpImpTefPAYGO$ = $item("TP_IMPRESSAO_TEF_PAYGO", voParams);-=CANONICO=- 30/11/2010 TAR 982 PRJ 102 - Parametro de leitura do arquivo intpos	
	$tpCodigoItemEcf$ = $item("TP_CODIGO_ITEM_ECF", voParams);---Elia Proj. 156/669 03/11/2011

	if (vInOptSimples = "S")
		$inOptSimples$ = <TRUE>
	else
		$inOptSimples$ = <FALSE>
	endif
	
	return(0)
end
;--------------------------
entry buscaTipoRegime
;--------------------------
	params
		string piCdCST : IN
	endparams

	variables
		string vCdCST
	endvariables

;	if (CD_CST.TRA_TRANSITEMSVC[2,3] = "00")
;		;Tributada Integralmente	
;		$TpRegime$ = 2
;	elseif(CD_CST.TRA_TRANSITEMSVC[2,3] = "10" | CD_CST.TRA_TRANSITEMSVC[2,3] = "60")
;		;Substituição	
;		$TpRegime$ = 1	
;	elseif(CD_CST.TRA_TRANSITEMSVC[2,3] = "30" | CD_CST.TRA_TRANSITEMSVC[2,3] = "40")
;		;Isento	
;		$TpRegime$ = 4
;	else
;		;Outros
;		$TpRegime$ = ""
;	endif	

	vCdCST = piCdCST[2 : 2]
	if (vCdCST = "00")
		$tpRegime$ = 2
	elseif (vCdCST = "10")
		$tpRegime$ = 1
	elseif (vCdCST = "20")
		$tpRegime$ = 2
	elseif (vCdCST = "30")
		$tpRegime$ = 6
	elseif (vCdCST = "40")
		$tpRegime$ = 4
	elseif (vCdCST = "41") ;-=CANONICO=- (08/07/2010) TAR 889 PRJ 102 (Inclusão do aliquota NN do tipoRegime 41)
		$tpRegime$ = 5
	elseif (vCdCST = "50")
		$tpRegime$ = 3
	elseif (vCdCST = "51")
		$tpRegime$ = 3
	elseif (vCdCST = "60")
		$tpRegime$ = 6
	elseif (vCdCST = "70")
		$tpRegime$ = 6
	elseif (vCdCST = "90")
		$tpRegime$ = 3
	else
		$tpRegime$ = 2
	endif

	return(0)
end


;--------------------------
entry preencheZero
	;--------------------------
	params        
		numeric piNumero : IN
		numeric piTamanho : IN 
		string poNumero : OUT
	endparams
	
	poNumero = piNumero
	length(poNumero)
	while ($result < piTamanho)
		poNumero = "0%%poNumero"
		length(poNumero)
	endwhile
	
	if ($result > piTamanho)
		poNumero = poNumero[$result - piTamanho + 1]
	endif
	
	return(0)
end

;---------------------------------
entry  verificaQtdTransacaoTEF
	;-----------------------------
	params
		numeric piCdEMPTRA : IN 
		numeric piNrTransacao : IN
		numeric piDtTransacao : IN	
		numeric poQtdTransacao : OUT
	endparams

	clear/e "TEF_RELTRANSASVC"
	CD_EMPTRA.TEF_RELTRANSASVC/init  =  piCdEMPTRA   
	NR_TRANSACAO.TEF_RELTRANSASVC/init =  piNrTransacao  
	DT_TRANSACAO.TEF_RELTRANSASVC/init  = piDtTransacao 
	retrieve/e "TEF_RELTRANSASVC"
	if ($status >= 0)
		poQtdTransacao = $hits("TEF_RELTRANSASVC")
	else
		poQtdTransacao = 0
	endif
	
	return(0)
end;entry  verificaQtdTransacaoTEF

;----------------------------
public operation iniciaCupom
;----------------------------
	params
		string  $xlpg$      :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams
	
	variables
		string viParams, voParams
		string vDsSerie, vInAberto, vInPermiteCancelar, vDsCupom, DsProduto, vUfOrigem
		numeric vNrTransacao, vCdEmpTra, vNrCupom, vCdEmpLogin, vCdCCusto, vCdPessoa
		date vDtTransacao
		boolean vInPjIsento, vInContribuinte, vInGravaRelacao
		numeric vStatus
	endvariables  

	vUfOrigem		 	= $item("UF_ORIGEM", $xlpg$)
	vInGravaRelacao	= $item("IN_GRAVARELACAO", piParams)  ;* Claudemir - Prj/Tarefa: 111/1989 - 20/10/2011

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "ECFSVCO010: iniciaCupom - Inicio: %%$hrInicio$"
	endif ;*

	call getParam()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	if ($status < 0)
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vCdEmpLogin = $item("CD_EMPRESA", $xlpg$)
	if (vCdEmpLogin = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa de login não informada!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vCdEmpTra = $item("CD_EMPRESA", piParams)
	if (vCdEmpTra = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vNrTransacao = $item("NR_TRANSACAO", piParams)
	if (vNrTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Numero da transação não informado!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vDtTransacao = $item("DT_TRANSACAO", piParams)
	if (vDtTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Data da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    
	
	clear/e "TRA_TRANSACAOSVC"
	CD_EMPRESA.TRA_TRANSACAOSVC/init = vCdEmpTra
	NR_TRANSACAO.TRA_TRANSACAOSVC/init = vNrTransacao
	DT_TRANSACAO.TRA_TRANSACAOSVC/init = vDtTransacao
	retrieve/e "TRA_TRANSACAOSVC" 
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação %%vNrTransacao não encontrada!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	if (TP_DOCTO.GER_OPERACAOSVC = 3);concomitante
		$vInConcomitante$ = <TRUE>
	else
		$vInConcomitante$ = <FALSE>
	endif

	if ($vInConcomitante$ = <FALSE>) ;ECF Não Concomitante
		clear/e "FIS_NFSVC"
		CD_EMPRESAORI.FIS_NFSVC/init = vCdEmpTra
		NR_TRANSACAOORI.FIS_NFSVC/init = vNrTransacao
		DT_TRANSACAOORI.FIS_NFSVC/init = vDtTransacao
		retrieve/e "FIS_NFSVC" 
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nota Fiscal não encontrada para a transação %%vNrTransacao!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	
		setocc "FIS_NFSVC", -1
		if ($totocc ("FIS_NFSVC") > 1)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Existe mais de uma nota para essa transação!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif    
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPFAT.TRA_TRANSACAOSVC
	activate "SICSVCO009".validaCentroCusto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "") 
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")    
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vCdCCusto = $item("CD_CENTROCUSTO", voParams)    
	
	if (CD_EMPFAT.TRA_TRANSACAOSVC = vCdCCusto)
		if ($PadraoEcf$ = <PADRAO_LOCALIMPFIM>)
			if($inPdvOtimizado$ != <TRUE>)
				viParams = ""
				activate "ECFSVCO001".abreGaveta(viParams, voParams, $xcderro$, $xctxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "") 
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif	
			endif
		endif
		return(0)
	endif

	;-----------------------------
	;Testa status da impressora
	;-----------------------------
	vInAberto = ""
	vInPermiteCancelar = ""
	viParams = ""
	if ($PadraoEcf$ = <PADRAO_AFRAC>)
		activate "ECFSVCO001".abrePorta(viParams, voParams, $xcderro$, $xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "ECFSVCO010: iniciaCupom - Inicio verificaEstado: %%$hrInicio$"
	endif ;*

	;-=CANONICO=- (22-11-2011) Comentando o comando verifica estado, finalidade ganho de performace evitando o filedump de um comando que foi adicionado na abertura do cupom
	;$DsCupom$ =  ""
	;viParams = ""
	;voParams = ""
	;putitem/id viParams, "IN_CONCOMITANTE", vInConcomitante
	;activate "ECFSVCO001".verificaEstado(viParams, voParams, $xcderro$, $xctxerro$)
	;if ($procerror)       
	;	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;	poCdErro = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;	return(-1)
	;elseif ($status < 0)
	;	vStatus = $status
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	poCdErro = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;	return(vStatus)
	;endif

	;caso for ECF com monitor - acumula todo o cupom em $DsCupom$ para dai entao mandar a impressão
	;vDsCupom = $item("DS_CUPOM",voParams)
	;$DsCupom$ = "%%$DsCupom$%%vDsCupom"

	;vInAberto = $item("INABERTO", voParams)
	;vInPermiteCancelar = $item("PERMITECANCELAR", voParams)

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		putmess "ECFSVCO010: iniciaCupom - Fim verificaEstado: %%$hrFim$"
	endif ;*

	;;---------------------------
;	;Busca a série da impressora
;	;---------------------------
;	if ($item("CD_SERIEECF",$$gParamGlb) = "")
;		;* Claudemir - Prj/Tarefa: 102/756
;		if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
;			$hrInicio$ = $clock
;			putmess "ECFSVCO010: iniciaCupom - Inicio leNumeroSerie: %%$hrInicio$"
;		endif ;*
;
;		viParams = ""
;		putitem/id viParams, "NM_FUNCAO", <ECF_NUMERO_SERIE>
;		activate "ECFSVCO001".leInformacaoImpressora(viParams,voParams,$xcderro$,$xctxerro$)
;		if ($procerror)       
;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			poCdErro = $xCdErro$
;			poCtxErro = $xCtxErro$
;			return(-1)
;		elseif ($status < 0)
;			vStatus = $status
;			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;			poCdErro = $xCdErro$
;			poCtxErro = $xCtxErro$
;			return(vStatus)
;		endif
;		vDsSerie = $item("NR_SERIE", voParams)
;		;vDsSerie = "EMULADOR"	;LSC remover	
;		putitem/id $$gParamGlb, "CD_SERIEECF", vDsSerie
;
;		;* Claudemir - Prj/Tarefa: 102/756
;		if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
;			$hrFim$ = $clock
;			putmess "ECFSVCO010: iniciaCupom - Fim leNumeroSerie: %%$hrFim$"
;		endif ;*
;	else
;		;vDsSerie = "EMULADOR"	;LSC remover
;		vDsSerie = $item("CD_SERIEECF",$$gParamGlb)
;	endif
;	
;	if (vDsSerie = "") 
;		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não foi possível obter o nr. de série da impressora!", "ADICIONAL=Operação->ECFSVCO010.geraCupomNaoConcomitante")
;		poCdErro = $xCdErro$
;		poCtxErro = $xCtxErro$
;		return(-1)
;	endif        
;
;	;valida impressora fiscal
;	viParams = ""
;	putitem/id viParams, "NR_SERIE", vDsSerie	
;	$instancehandle->validaImpressoraFiscal($xlpg$,viParams,voParams,$xcderro$,$xctxerro$)
;	if ($procerror)
;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;		poCdErro = $xCdErro$
;		poCtxErro = $xCtxErro$
;		return(-1)
;	elseif($status < 0)
;		poCdErro = $xCdErro$
;		poCtxErro = $xCtxErro$
;		return(-1)
;	endif
;	
	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "ECFSVCO010: iniciaCupom - Inicio abreCupom: %%$hrInicio$"
	endif ;*

	;Fiuza 27/10/07 - TEF DEDICADO - no caso das impressoras que tem corte automático de papel
	;pode-se habilitar ou não o corte do papel no cupom fiscal
	if ($PadraoEcf$ = <PADRAO_BEMATECH>) 
		viParams = ""
		voParams = ""
		putitem/id viParams, "IN_ATIVA", <FALSE>
		activate "ECFSVCO001".ativaDesativaGuilhotina(viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	;Fiuza prj 102 tar 231 - 22/02/08 - de acordo com a necessidade dos clientes os mesmos estarão
	;alterando o cliente da venda no TRAFM066 e gravando na entidade FIS_NFREMDES, portanto a partir 
	;de agora vai comparar o $CdClientePdv$ com a pessoa do FIS_NFREMDES se tiver diferente abre o cupom
	;com o CPF da pessoa contida nesta tabela. 
    ;LSC (07/08/2006) - PROJETO 26 TAREFA 8 - Passar parametro(CPF) do ECF na Abertura do Cupom 
	;viParams = ""
	;if($CdClientePdv$ != CD_PESSOA.TRA_TRANSACAOSVC)
	;	if(NR_CPFCNPJ.PES_PESSOASVC != "")
	;		 
	;	endif
	;endif
;	viParams = ""
;	if ($CdClientePdv$ != CD_PESSOA.FIS_NFREMDESSVC)
		;-=CANONICO=- (30/03/2010) TAR 844 PRJ 102 - Efetuar Leitura na entidade TRA_REMDES
		;if (NR_CPFCNPJ.FIS_NFREMDESSVC != "")
		;	putitem/id viParams, "NR_CPFCNPJ", NR_CPFCNPJ.FIS_NFREMDESSVC
		;endif

		;* Claudemir - 29/04/2010 - Comentado as linhas abaixo e copiadas mais abaixo para melhor visualização
;		if (NR_CPFCNPJ.TRA_REMDESSVC != "")
;			putitem/id viParams, "NR_CPFCNPJ", NR_CPFCNPJ.TRA_REMDESSVC
;		endif ;*

;	endif	

;-=CANONICO=- (31/03/2010) TAR 847 PRJ 102 - Remover a entidade PES_S_PESSOASVC - estouro do componente
	;* Claudemir - Prj/Tarefa: 102/828 - 03/03/2010
;	clear/e "PES_S_PESSOASVC"
	;CD_PESSOA.PES_S_PESSOASVC/init = CD_PESSOA.FIS_NFREMDESSVC ;-=CANONICO=- (30/03/2010) TAR 844 PRJ 102 - Efetuar Leitura na entidade TRA_REMDES
;	CD_PESSOA.PES_S_PESSOASVC/init = CD_PESSOA.TRA_REMDESSVC
;	retrieve/e "PES_S_PESSOASVC"
;	if ($status >= 0)
;		vInPjIsento = <FALSE>
;		if (NR_INSCESTL.PES_S_PESJURISVC = "ISENTO")  | (NR_INSCESTL.PES_S_PESJURISVC = "ISENTA") | %\
;			(NR_INSCESTL.PES_S_PESJURISVC = "ISENTOS") | (NR_INSCESTL.PES_S_PESJURISVC = "ISENTAS")
;			vInPjIsento = <TRUE>
;		endif
		
;		if (IN_CNSRFINAL.PES_S_CLIENTESVC = <TRUE>) | (TP_PESSOA.PES_S_PESSOASVC = "F") | (vInPjIsento = <TRUE>)
;			if (TP_PESSOA.PES_S_PESSOASVC = "F") & (NR_CODIGOFISCAL.PES_S_CLIENTESVC != "") & (vUfOrigem = "PR" | vUfOrigem = "SP")
;				vInContribuinte = <TRUE>
;			else
;				vInContribuinte = <FALSE>
;			endif
;		else
;			vInContribuinte = <TRUE>
;		endif	

;		if (TP_DOCTO.GER_OPERACAOSVC = 2 | TP_DOCTO.GER_OPERACAOSVC = 3) ;Cupom Fiscal
;			if (vInContribuinte = <TRUE> & IN_CNSRFINAL.PES_S_CLIENTESVC != <TRUE>)
;				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Emissão de cupom fiscal para contribuinte não é permitido. Favor emitir Nota Fiscal!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
;				poCdErro = $xCdErro$
;				poCtxErro = $xCtxErro$
;				return(-1) 
;			endif
;		endif
;	endif
;	;* 

	;* Claudemir - 29/04/2010 - copiado a validação que estava acima
	;if (NR_CPFCNPJ.TRA_REMDESSVC != "")
	;	putitem/id viParams, "NR_CPFCNPJ", NR_CPFCNPJ.TRA_REMDESSVC
	;endif ;*

   ;---Elia 30/04/2010
   if (CD_PESSOA.TRA_REMDESSVC != "")
	   vCdPessoa = CD_PESSOA.TRA_REMDESSVC
	else
		vCdPessoa = CD_PESSOA.TRA_TRANSACAOSVC
	endif
    ;
    
	;-=CANONICO=- (31/03/2010) TAR 847 PRJ 102 - Remover a entidade PES_S_PESSOASVC - estouro do componente e efetuar leitura do servico PESSVCO005.buscaDadosPessoa
   viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", vCdPessoa
	activate "PESSVCO005".buscaDadosPessoa($xlpg$,viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

    ;---Elia 30/04/2010
    if (NR_CPFCNPJ.TRA_REMDESSVC != "")
		putitem/id viParams, "NR_CPFCNPJ", NR_CPFCNPJ.TRA_REMDESSVC
	else
		putitem/id viParams, "NR_CPFCNPJ", $item("NR_CPFCNPJ", voParams)
	endif
	;

	vInPjIsento = <FALSE>
	if ($item("NR_INSCESTL", voParams) = "ISENTO")  | ($item("NR_INSCESTL", voParams) = "ISENTA") | %\
		($item("NR_INSCESTL", voParams) = "ISENTOS") | ($item("NR_INSCESTL", voParams) = "ISENTAS")
		vInPjIsento = <TRUE>
	endif
		
	if ($item("IN_CNSRFINAL", voParams) = <TRUE>) | ($item("TP_PESSOA", voParams) = "F") | (vInPjIsento = <TRUE>)
		if ($item("TP_PESSOA", voParams) = "F") & ($item("NR_CODIGOFISCAL", voParams) != "") & (vUfOrigem = "PR" | vUfOrigem = "SP")
			vInContribuinte = <TRUE>
		else
			vInContribuinte = <FALSE>
		endif
	else
		vInContribuinte = <TRUE>
	endif	

	if (TP_DOCTO.GER_OPERACAOSVC = 2 | TP_DOCTO.GER_OPERACAOSVC = 3) ;Cupom Fiscal
		if (vInContribuinte = <TRUE>) & ($item("IN_CNSRFINAL", voParams)  != <TRUE>)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Emissão de cupom fiscal para contribuinte não é permitido. Favor emitir Nota Fiscal!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1) 
		endif
	endif
	;-=

	putitem/id viParams, "IN_CONCOMITANTE", $vInConcomitante$	
	activate "ECFSVCO001".AbreCupom(viParams,voParams,$xcderro$,$xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)	
		vStatus = $status
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(vStatus)
	endif
	;caso for ECF com monitor - acumula todo o cupom em $DsCupom$ para dai entao mandar a impressão
	vDsCupom = $item("DS_CUPOM",voParams)
	$DsCupom$ = "%%$DsCupom$%%vDsCupom"
	vNrCupom = $item("NR_CUPOM", voParams)
	
	if ($vInConcomitante$ = <TRUE>) ;ECF Concomitante
		if (vNrCupom = "") ;-=CANONICO=- (21-11-2011) caso não tenha o virtualMonitor será solicitado o número cupom
			viParams = ""
			voParams = ""
			putitem/id viParams, "NM_FUNCAO", <ECF_NUMERO_CUPOM>
			activate "ECFSVCO001".leInformacaoImpressora(viParams,voParams,$xcderro$,$xctxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				vStatus = $status
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(vStatus)
			endif
			vNrCupom = $item("NR_CUPOM", voParams)
		endif

		if (vNrCupom = "") 
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não foi possível obter o número do cupom fiscal!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif 

		;---------------------------
		;Busca a série da impressora
		;---------------------------
		if ($item("CD_SERIEECF",$$gParamGlb) = "")
			;* Claudemir - Prj/Tarefa: 102/756
			if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
				$hrInicio$ = $clock
				putmess "ECFSVCO010: iniciaCupom - Inicio leNumeroSerie: %%$hrInicio$"
			endif ;*
	
			viParams = ""
			putitem/id viParams, "NM_FUNCAO", <ECF_NUMERO_SERIE>
			activate "ECFSVCO001".leInformacaoImpressora(viParams,voParams,$xcderro$,$xctxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				vStatus = $status
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(vStatus)
			endif
			vDsSerie = $item("NR_SERIE", voParams)
			putitem/id $$gParamGlb, "CD_SERIEECF", vDsSerie

			;* Claudemir - Prj/Tarefa: 102/756
			if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
				$hrFim$ = $clock
				putmess "ECFSVCO010: iniciaCupom - Fim leNumeroSerie: %%$hrFim$"
			endif ;*
		else
			vDsSerie = $item("CD_SERIEECF",$$gParamGlb)
		endif

		if (vDsSerie = "") 
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não foi possível obter o nr. de série da impressora!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif        

		;valida impressora fiscal
		viParams = ""
		putitem/id viParams, "NR_SERIE", vDsSerie	
		$instancehandle->validaImpressoraFiscal($xlpg$,viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif($status < 0)
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif ;-=CANONICO=-

	;* Claudemir - Prj/Tarefa: 191/2 - 06/09/2011
	if ($vInConcomitante$ = <TRUE>)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA",			CD_EMPRESA.TRA_TRANSACAOSVC
		putitem/id viParams, "NR_TRANSACAO",		NR_TRANSACAO.TRA_TRANSACAOSVC
		putitem/id viParams, "DT_TRANSACAO",		DT_TRANSACAO.TRA_TRANSACAOSVC
		putitem/id viParams, "CD_EMPECF",			CD_EMPRESA.FIS_ECFSVC
		putitem/id viParams, "NR_ECF",				NR_ECF.FIS_ECFSVC
		putitem/id viParams, "NR_CUPOM",			vNrCupom
		;* Claudemir - Prj/Tarefa: 111/1989 - 20/10/2011
		putitem/id viParams, "IN_GRAVARELACAO",	vInGravaRelacao		
		if (vInGravaRelacao = <TRUE>)
			;newinstance "TRASVCO016", "TRASVCO016", "TRANSACTION=TRUE" ;-=CANONICO=- TAR 691 PRJ 156 (29/11/2011) corrigindo newInstance, adicionado o else quando o IN_GRAVARELACO = <FALSE>
			newinstance "TRASVCO016", "TRASVCO016X", "TRANSACTION=TRUE" 
			activate "TRASVCO016X".gravaECFTransacao($xlpg$, viParams, voParams, $xcderro$, $xctxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
				return(-1)
			endif
			deleteinstance "TRASVCO016X"   	
		else
			activate "TRASVCO016".gravaECFTransacao($xlpg$, viParams, voParams, $xcderro$, $xctxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif  ;*
	endif  ;*

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		putmess "ECFSVCO010: iniciaCupom -  Fim Abre Cupom: %%$hrFim$"
	endif ;*

	;if ($PadraoEcf$ = <PADRAO_LOCALIMPFIM>) | (vInConcomitante = <TRUE>)
		;* Claudemir - Prj/Tarefa: 102/756
		if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
			$hrInicio$ = $clock
			putmess "ECFSVCO010: iniciaCupom - Inicio LeNumeroCupom: %%$hrInicio$"
		endif ;*
;-=CANONICO=- (21-11-2011) comentado para performace
		;viParams = ""
;		putitem/id viParams, "NM_FUNCAO", <ECF_NUMERO_CUPOM>
;		putitem/id viParams, "IN_IMPCUPOMFISCAL", <TRUE>
;		activate "ECFSVCO001".leInformacaoImpressora(viParams,voParams,$xcderro$,$xctxerro$)
;		if ($procerror)       
;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			poCdErro = $xCdErro$
;			poCtxErro = $xCtxErro$
;			return(-1)
;		elseif ($status < 0)
;			vStatus = $status	
;			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;			poCdErro = $xCdErro$
;			poCtxErro = $xCtxErro$
;			return(vStatus)
;		endif
;		;* Claudemir - Prj/Tarefa: 102/756
		if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
			$hrFim$ = $clock
			putmess "ECFSVCO010: iniciaCupom - Fim leNumeroCupom: %%$hrFim$"
		endif ;*

		;caso for ECF com monitor - acumula todo o cupom em $DsCupom$ para dai entao mandar a impressão
		;vDsCupom = $item("DS_CUPOM",voParams)
		;$DsCupom$ = "%%$DsCupom$%%vDsCupom" 
	;endif

	if ($PadraoEcf$ != <PADRAO_LOCALIMPFIM> | $vInConcomitante$ = <TRUE>)
		if (vNrCupom = 0)
			vNrCupom = $item("NR_CUPOM", voParams)
		endif
		if (vNrCupom = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não foi possível obter o nr. do cupom fiscal!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif    
		$NrCupom$ = vNrCupom
	endif

	poParams = ""
	putitem/id poParams, "CD_EMPECF", CD_EMPRESA.FIS_ECFSVC
	putitem/id poParams, "NR_ECF", NR_ECF.FIS_ECFSVC
	putitem/id poParams, "NR_CUPOM", vNrCupom

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		putmess "ECFSVCO010: iniciaCupom - Fim Inicia Cupom: %%$hrFim$"
	endif ;*
	
	return(0)
end

;------------------------------
public operation lancaItemConcomitante
;------------------------------

	;FIUZA - 20/12/05
	;PROJETO 38 TAREFA 1
	;IMPRIMIR ECF CONCOMITANTE
	params
		string  $xlpg$      :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams
	
	variables
		string viParams, voParams, vCdProduto
		string vInAberto, vDsSerie, vCdCodigoBarra, vDsProduto, vCdCST
		numeric vNrTransacao, vCdEmpTra, vCdEmpLogin, vCdCCusto, vNrItem
		date vDtTransacao
		numeric vStatus, vCdCompVend
	endvariables
	
	call getParam()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	if ($status < 0)
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	vCdEmpLogin = $item("CD_EMPRESA", $xlpg$)
	if (vCdEmpLogin = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa de login não informada!", "ADICIONAL=Operação->ECFSVCO010.lancaItemConcomitante")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vCdEmpTra = $item("CD_EMPRESA", piParams)
	if (vCdEmpTra = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.lancaItemConcomitante")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vNrTransacao = $item("NR_TRANSACAO", piParams)
	if (vNrTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Numero da transação não informado!", "ADICIONAL=Operação->ECFSVCO010.lancaItemConcomitante")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vDtTransacao = $item("DT_TRANSACAO", piParams)
	if (vDtTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Data da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.lancaItemConcomitante")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    

	vNritem = $item("NR_ITEM", piParams)
	if (vDtTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Número do item da transação não informado!", "ADICIONAL=Operação->ECFSVCO010.lancaItemConcomitante")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    
	
	clear/e "TRA_TRANSACAOSVC"
	CD_EMPRESA.TRA_TRANSACAOSVC/init = vCdEmpTra
	NR_TRANSACAO.TRA_TRANSACAOSVC/init = vNrTransacao
	DT_TRANSACAO.TRA_TRANSACAOSVC/init = vDtTransacao
	retrieve/e "TRA_TRANSACAOSVC" 
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação %%vNrTransacao não encontrada!", "ADICIONAL=Operação->ECFSVCO010.lancaItemConcomitante")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	clear/e "TRA_TRANSITEMSVC"
	NR_ITEM.TRA_TRANSITEMSVC/init = vNrItem
	retrieve/e "TRA_TRANSITEMSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Item %%vNrItem da transação %%vNrTransacao não encontrada!", "ADICIONAL=Operação->ECFSVCO010.lancaItemConcomitante")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPFAT.TRA_TRANSACAOSVC
	activate "SICSVCO009".validaCentroCusto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "") 
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")    
		return(-1)
	endif
	
	vCdCCusto = $item("CD_CENTROCUSTO", voParams)    
	
	if (CD_EMPFAT.TRA_TRANSACAOSVC = vCdCCusto)
		return(0)
	endif

	if ($PadraoECF$ = <PADRAO_BEMATECH>)
		vInAberto = ""
		viParams = ""
		activate "ECFSVCO001".verificaEstado(viParams, voParams, $xcderro$, $xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(vStatus)
		endif
	
		vInAberto = $item("INABERTO", voParams)
	
		if (vInAberto != "S")
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não existe cupom aberto na impressora!", "ADICIONAL=Operação->ECFSVCO010.lancaItemConcomitante")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		viParams = ""
		putitem/id viParams, "NM_FUNCAO", <ECF_NUMERO_SERIE>
		activate "ECFSVCO001".leInformacaoImpressora(viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(vStatus)
		endif
		vDsSerie = $item("NR_SERIE", voParams)
		;valida impressora fiscal
		viParams = ""
		putitem/id viParams, "NR_SERIE", vDsSerie
		putitem/id viParams, "IN_CUPOM", <TRUE>
		$instancehandle->validaImpressoraFiscal($xlpg$,viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif($status < 0)
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	;---Elia Proj. 111/2012 04/11/2011
	;vCdCST = CD_CST.FIS_NFITEMSVC[2:2] ;* Claudemir - Prj/Tarefa: 26/37 - 07/10/2010
	vCdCST = CD_CST.TRA_TRANSITEMSVC[2:2]	
	;

	if (vCdCST != "40") & (vCdCST != "41") & (vCdCST != "60") ;* Claudemir - Prj/Tarefa: 26/37 - 07/10/2010
		if (PR_ALIQUOTA.TRA_ITEMIMPOSSVC = 0 & !$InOptSimples$)
			if ($item("UF_ORIGEM", $xlpg$) != "RO")
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=ICMS não calculado para o item %%CD_PRODUTO.FIS_NFITEMSVC da nota %%NR_FATURA.FIS_NFSVC!", "ADICIONAL=Operação->ECFSVCO010.lancaItemConcomitante")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
	endif ;* Claudemir - Prj/Tarefa: 26/37 - 07/10/2010

	; se o regime tributário do cliente for simples atribui "zero" para aliquota ICMS
	;* Claudemir - Prj/Tarefa: 181/2 - 13/12/2010
	;if ($InOptSimples$)
	if ($InOptSimples$) & ($item("UF_ORIGEM", $xlpg$) = "PR") ;*
		PR_ALIQUOTA.TRA_ITEMIMPOSSVC/init = 0
	endif    
		
	call buscaTipoRegime(CD_CST.TRA_TRANSITEMSVC)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	clear/e "PRD_PRODUTOSVC"
	CD_PRODUTO.PRD_PRODUTOSVC/init = CD_PRODUTO.TRA_TRANSITEMSVC
	retrieve/e "PRD_PRODUTOSVC"
	
	viParams = ""
	voParams = ""

	;* Claudemir - Prj/Tarefa: 102/960 - 04/10/2010
	; Imprimir sempre o código do produto, independente do código lançado na venda

	;if (CD_BARRAPRD.TRA_TRANSITEMSVC != "" )
	;	vCdProduto = CD_BARRAPRD.TRA_TRANSITEMSVC
	;else
	;	vCdProduto = CD_PRODUTO.TRA_TRANSITEMSVC 
	;endif

	;---Elia Proj. 156/669 03/11/2011
	;vCdProduto = CD_PRODUTO.TRA_TRANSITEMSVC  ;*	
	if ($tpCodigoItemEcf$ = 1) ; 1 - CODIGO DE BARRAS DO PRODUTO
		clear/e "PRD_CODIGOBARSVC"
		IN_PADRAO.PRD_CODIGOBARSVC/init = <TRUE>
		retrieve/e "PRD_CODIGOBARSVC"
		if ($status < 0)
			clear/e "PRD_CODIGOBARSVC"
			retrieve/e "PRD_CODIGOBARSVC"
			if ($status >= 0)
				setocc "PRD_CODIGOBARSVC", 1
				vCdProduto = CD_BARRAPRD.PRD_CODIGOBARSVC
			else
				vCdProduto = CD_PRODUTO.TRA_TRANSITEMSVC
			endif
		else
			vCdProduto = CD_BARRAPRD.PRD_CODIGOBARSVC
		endif
	else
		vCdProduto = CD_PRODUTO.TRA_TRANSITEMSVC 
	endif
	;

	;Fiuza - sem tarefa - via interrupcao
	length vCdProduto
	if ($result > 13)
		vCdProduto = vCdProduto[1,13]
	endif	
	putitem/id viParams,"CD_PRODUTO", vCdProduto
	;-----------------------------------

	;-=CANONICO=- (06-03-2008) TAR 257 PRJ 102
	if ($tpDescricaoItemEcf$ = 1) ;Parametro que define como sera impresso a descricao do produto 1=imprimir o vendedor
		vDsProduto = DS_PRODUTO.PRD_PRODUTOSVC[1:23] 
		vCdCompVend = CD_COMPVEND.TRA_TRANSITEMSVC
		vDsProduto =  "%%vDsProduto%%%(%%vCdCompVend%%)%%"
		putitem/id viParams,"DS_PRODUTO", vDsProduto 
	else
		putitem/id viParams,"DS_PRODUTO", DS_PRODUTO.PRD_PRODUTOSVC
	endif
	;	
	
	putitem/id viParams,"CD_ESPECIE", CD_ESPECIE.PRD_PRODUTOSVC	
	putitem/id viParams,"QT_SOLICITADA", QT_SOLICITADA.TRA_TRANSITEMSVC
	putitem/id viParams,"PR_ALIQICMS", PR_ALIQUOTA.TRA_ITEMIMPOSSVC
	;* Claudemir - Prj/Tarefa: 191/1 - 28/09/2011
	;putitem/id viParams,"VL_DESCONTO", 0
	putitem/id viParams,"VL_DESCONTO", VL_TOTALDESC.TRA_TRANSITEMSVC ;*
	putitem/id viParams,"VL_UNITARIO", VL_UNITBRUTO.TRA_TRANSITEMSVC
	putitem/id viParams,"VL_TOTALLIQUIDO", VL_TOTALBRUTO.TRA_TRANSITEMSVC
	putitem/id viParams,"CD_ESPECIE", CD_ESPECIE.TRA_TRANSITEMSVC
	putitem/id viParams,"TP_REGIMESUB", $TpRegime$
	putitem/id viParams, "IN_CONCOMITANTE", <TRUE>
	activate "ECFSVCO001".VendeItem(viParams, voParams, $xcderro$, $xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		vStatus = $status
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(vStatus)
	endif

	$NrNivelImp$ = 0;esse nivel é controlado no fechamento do cupom quando for TEF
	$NrNivelImpPgto$ = 0 ;esse nivel é controlado no fechamento do cupom na forma de pgto quando for TEF
	return(0)
end;operation lancaItemConcomitante


;------------------------------
public operation lancaItemCupom
	;------------------------------
	params
		string  $xlpg$      :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams
	
	variables
		string viParams, voParams, vDsCupom, vDsProduto, vCdCST
		string vInAberto, vDsSerie
		numeric vNrTransacao, vCdEmpTra, vCdEmpLogin, vCdCCusto, vNrCupom
		date vDtTransacao
		boolean vInTEF
		numeric vStatus, vCdCompVend 
	endvariables

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "ECFSVCO010: lancaItemCupom - Inicio lancaItemCupom: %%$hrInicio$"
	endif ;*

	call getParam()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	if ($status < 0)
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vCdEmpLogin = $item("CD_EMPRESA", $xlpg$)
	if (vCdEmpLogin = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa de login não informada!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vCdEmpTra = $item("CD_EMPRESA", piParams)
	if (vCdEmpTra = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vNrTransacao = $item("NR_TRANSACAO", piParams)
	if (vNrTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Numero da transação não informado!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vDtTransacao = $item("DT_TRANSACAO", piParams)
	if (vDtTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Data da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    

	vInTEF = $item("IN_TEF", piParams)
	if (vInTEF = "")	
		vInTEF = <FALSE>
	endif
	
	clear/e "TRA_TRANSACAOSVC"
	CD_EMPRESA.TRA_TRANSACAOSVC/init = vCdEmpTra
	NR_TRANSACAO.TRA_TRANSACAOSVC/init = vNrTransacao
	DT_TRANSACAO.TRA_TRANSACAOSVC/init = vDtTransacao
	retrieve/e "TRA_TRANSACAOSVC" 
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação %%vNrTransacao não encontrada!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	clear/e "FIS_NFSVC"
	CD_EMPRESAORI.FIS_NFSVC/init = vCdEmpTra
	NR_TRANSACAOORI.FIS_NFSVC/init = vNrTransacao
	DT_TRANSACAOORI.FIS_NFSVC/init = vDtTransacao
	retrieve/e "FIS_NFSVC" 
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nota Fiscal não encontrada para a transação %%vNrTransacao!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	setocc "FIS_NFSVC", -1
	if ($totocc ("FIS_NFSVC") > 1)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Existe mais de uma nota para essa transação!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPFAT.TRA_TRANSACAOSVC
	activate "SICSVCO009".validaCentroCusto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "") 
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")    
		return(-1)
	endif
	
	vCdCCusto = $item("CD_CENTROCUSTO", voParams)    
	
	if (CD_EMPFAT.TRA_TRANSACAOSVC = vCdCCusto)
		return(0)
	endif

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "ECFSVCO010: lancaItemCupom - Inicio verificaEstado: %%$hrInicio$"
	endif ;*

	if ($PadraoEcf$ = <PADRAO_BEMATECH>)	
		vInAberto = ""
		viParams = ""
		activate "ECFSVCO001".verificaEstado(viParams, voParams, $xcderro$, $xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(vStatus)
		endif
	
		vInAberto = $item("INABERTO", voParams)
	
		if (vInAberto != "S")
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não existe cupom aberto na impressora!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		;$hrTempo$ = $hrFim$ - $hrInicio$
		putmess "ECFSVCO010: lancaItemCupom - Fim verificaEstado: %%$hrFim$"
	endif ;*

	;--------------------
	;ITENS DO CUPOM 
	;--------------------    
	setocc "FIS_NFITEMSVC" , 1
	while ($status >=0)

		;limpa a entidade e lê CD_IMPOSTO TIPO 1 que é ICMS
		clear/e "FIS_NFITEMIMPSVC"
		CD_IMPOSTO.FIS_NFITEMIMPSVC/init = 1
		retrieve/e "FIS_NFITEMIMPSVC"
		if ($status < 0)
			;limpa a entidade e lê CD_IMPOSTO TIPO 2 que é SUBSTITUICAO
			clear/e "FIS_NFITEMIMPSVC"
			CD_IMPOSTO.FIS_NFITEMIMPSVC/init = 2
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Imposto não encontrado para o item %%CD_PRODUTO.FIS_NFITEMSVC da nota %%NR_FATURA.FIS_NFSVC!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif		

		vCdCST = CD_CST.FIS_NFITEMSVC[2:2] ;* Claudemir - Prj/Tarefa: 26/37 - 07/10/2010

		if (vCdCST != "40") & (vCdCST != "41") & (vCdCST != "60") ;* Claudemir - Prj/Tarefa: 26/37 - 07/10/2010
			if (PR_ALIQUOTA.FIS_NFITEMIMPSVC = 0 & !$InOptSimples$)
				if ($item("UF_ORIGEM", $xlpg$) != "RO")
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=ICMS não calculado para o item %%CD_PRODUTO.FIS_NFITEMSVC da nota %%NR_FATURA.FIS_NFSVC!", "ADICIONAL=Operação->ECFSVCO010.lancaItemCupom")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
		endif  ;* Claudemir - Prj/Tarefa: 26/37 - 07/10/2010

		; se o regime tributário do cliente for simples atribui "zero" para aliquota ICMS
		if ($InOptSimples$) & ($item("UF_ORIGEM", $xlpg$) = "PR")
			PR_ALIQUOTA.FIS_NFITEMIMPSVC/init = 0
		endif 

		call buscaTipoRegime(CD_CST.FIS_NFITEMSVC)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		clear/e "PRD_PRODUTOSVC"
		CD_PRODUTO.PRD_PRODUTOSVC/init = CD_PRODUTO.FIS_NFITEMSVC
		retrieve/e "PRD_PRODUTOSVC"

		;-=CANONICO=- (06-03-2008) TAR 257 PRJ 102
		clear/e "FIS_NFITEMPROSVC"
		CD_EMPRESA.FIS_NFITEMPROSVC/init = CD_EMPRESA.FIS_NFITEMSVC
		NR_FATURA.FIS_NFITEMPROSVC/init = NR_FATURA.FIS_NFITEMSVC
		DT_FATURA.FIS_NFITEMPROSVC/init = DT_FATURA.FIS_NFITEMSVC
		NR_ITEM.FIS_NFITEMPROSVC/init = NR_ITEM.FIS_NFITEMSVC
		CD_PRODUTO.FIS_NFITEMPROSVC/init = CD_PRODUTO.FIS_NFITEMSVC
		retrieve/e "FIS_NFITEMPROSVC"
		;

		clear/e "TRA_TRANSITEMSVC"
		CD_EMPRESA.TRA_TRANSITEMSVC/init = vCdEmpTra
		NR_TRANSACAO.TRA_TRANSITEMSVC/init = vNrTransacao
		DT_TRANSACAO.TRA_TRANSITEMSVC/init = vDtTransacao
		NR_ITEM.TRA_TRANSITEMSVC/init = NR_ITEM.FIS_NFITEMSVC
		retrieve/e "TRA_TRANSITEMSVC"
			
	
		viParams = ""
		voParams = ""

		;* Claudemir - Prj/Tarefa: 102/960 - 04/10/2010
		; Imprimir sempre o código de barras, independente do código lançado na venda
		;if (CD_BARRAPRD.TRA_TRANSITEMSVC != "" )
		;	putitem/id viParams,"CD_PRODUTO", CD_BARRAPRD.TRA_TRANSITEMSVC
		;else 
		;	putitem/id viParams,"CD_PRODUTO", CD_PRODUTO.FIS_NFITEMSVC
		;endif

		putitem/id viParams,"CD_PRODUTO", CD_PRODUTO.FIS_NFITEMSVC   ;*

		;-=CANONICO=- (06-03-2008) TAR 257 PRJ 102
		if ($tpDescricaoItemEcf$ = 1) ;Parametro que define como sera impresso a descricao do produto 1=imprimir o vendedor
			vDsProduto = DS_PRODUTO.FIS_NFITEMSVC[1:23] 
			vCdCompVend = CD_COMPVEND.FIS_NFITEMPROSVC	
			vDsProduto =  "%%vDsProduto%%%(%%vCdCompVend%%)%%"
			putitem/id viParams,"DS_PRODUTO", vDsProduto 
		else
			putitem/id viParams,"DS_PRODUTO", DS_PRODUTO.FIS_NFITEMSVC
		endif
		;	
		
		putitem/id viParams,"CD_ESPECIE", CD_ESPECIE.PRD_PRODUTOSVC	
		putitem/id viParams,"QT_SOLICITADA", QT_FATURADO.FIS_NFITEMSVC
		putitem/id viParams,"PR_ALIQICMS", PR_ALIQUOTA.FIS_NFITEMIMPSVC
		;* Claudemir - Prj/Tarefa: 130/1020 - 
		;;putitem/id viParams,"VL_DESCONTO", VL_UNITDESC.FIS_NFITEMSVC
		putitem/id viParams,"VL_DESCONTO", VL_TOTALDESC.FIS_NFITEMSVC  ;*
		putitem/id viParams,"VL_ACRESCIMO", 0
		putitem/id viParams,"VL_UNITARIO", VL_UNITBRUTO.FIS_NFITEMSVC
		putitem/id viParams,"VL_TOTALLIQUIDO", VL_TOTALBRUTO.FIS_NFITEMSVC
		putitem/id viParams,"CD_ESPECIE", CD_ESPECIE.FIS_NFITEMSVC
		putitem/id viParams,"TP_REGIMESUB", $tpRegime$
		if ($PadraoEcf$ = <PADRAO_LOCAL> | $PadraoEcf$ = <PADRAO_LOCALIMPFIM>)
			if ($next(CD_PRODUTO.FIS_NFITEMSVC)= "")
				putitem/id viParams, "IN_IMPRIMEAOFINAL", <TRUE>
				if (vInTEF = <TRUE>)
					putitem/id viParams, "DS_CUPOM", $DsCupom$
					$DsCupom$ = ""
				endif
			else
				putitem/id viParams, "IN_IMPRIMEAOFINAL", <FALSE>
			endif
		endif
		putitem/id viParams,"IN_TEF", vInTEF
		activate "ECFSVCO001".VendeItem(viParams, voParams, $xcderro$, $xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(vStatus)
		endif
		vNrCupom = $item("NR_CUPOM",voParams)
		vDsCupom = $item("DS_CUPOM",voParams)
		$DsCupom$ = "%%$DsCupom$%%vDsCupom"
		vDsSerie = $item("NR_SERIE", voParams)

		setocc "FIS_NFITEMSVC", $curocc("FIS_NFITEMSVC") + 1    
	endwhile

	if (vNrCupom > 0)
		putitem/id poParams, "NR_CUPOM", vNrCupom 
	endif

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		;$hrTempo$ = $hrFim$ - $hrInicio$
		putmess "ECFSVCO010: lancaItemCupom - Fim lancaItemCupom: %%$hrFim$"
	endif ;*

	$NrNivelImp$ = 0 ;esse nivel é controlado no fechamento do cupom quando for TEF
	$NrNivelImpPgto$ = 0 ;esse nivel é controlado no fechamento do cupom na forma de pgto quando for TEF

	;-=CANONICO=- (21-11-2011) 
	if ($vInConcomitante$ = <FALSE>) ;ECF Não Concomitante
		;valida impressora fiscal
		viParams = ""
		putitem/id viParams, "NR_SERIE", vDsSerie	
		$instancehandle->validaImpressoraFiscal($xlpg$,viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif($status < 0)
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		poParams = ""
		putitem/id poParams, "CD_EMPECF", CD_EMPRESA.FIS_ECFSVC
		putitem/id poParams, "NR_ECF", NR_ECF.FIS_ECFSVC
	endif

	return(0)
end

;----------------------------
public operation encerraCupom
	;----------------------------
	params
		string  $xlpg$      :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams
	
	variables
		string viParams, voParams, vDsRegistro, vDsFormaPgto, vDsLstFormaPgto, vDsLstNF 
		string vInAberto, vDsConteudo, vDsLstTransacao, vDsAux, vDsLinha
		string vDsLstFatura, vDsFatura, vDsCupom, vDsMensagem, vNulo, vDsLstCheque, vDsCheque, vDsLstCheque2
		numeric vNrTransacao, vCdEmpTra, vVlFormaPgto, vNrCupom, vCdEmpLogin, vCdCCusto
		numeric vCdEmpECF, vNrECF, vVlDesconto, vNrFatura, vNrParcela, vlFatura, vNrNivelImpPgto, vVlCheque
		date vDtTransacao
		boolean vInTEF, vInImprimirCarner, vInCartaoProprio, vInBonus, vinImprimiGerencial, vInConcomitante, vInGravaRelacao
		numeric vStatus, vNrLinha, vPadraoECF, vVlTotalFatura, vVlTotalCheque, vQtTransacaoTEF
	endvariables

	vQtTransacaoTEF = 0

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "ECFSVCO010: encerraCupom - Inicio Encerra Cupom: %%$hrInicio$"
	endif ;*

	vInGravaRelacao	= $item("IN_GRAVARELACAO", piParams) ;* Claudemir - Prj/Tarefa: 111/1989 - 21/10/2011

	vinImprimiGerencial	= <FALSE>

	vInTEF = $item("IN_TEF", piParams)
	if (vInTEF = "")	
		vInTEF = <FALSE>
	endif

	vInConcomitante = $item("IN_CONCOMITANTE", piParams) ;* Claudemir - Prj/Tarefa: 26/31 - 25/11/2009
	
	call getParam()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	if ($status < 0)
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vCdEmpLogin = $item("CD_EMPRESA", $xlpg$)
	if (vCdEmpLogin = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa de login não informada!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vCdEmpTra = $item("CD_EMPRESA", piParams)
	if (vCdEmpTra = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vNrTransacao = $item("NR_TRANSACAO", piParams)
	if (vNrTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Numero da transação não informado!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vDtTransacao = $item("DT_TRANSACAO", piParams)
	if (vDtTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Data da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    
	
	vDsLstFormaPgto = $item("DS_LSTFORMAPGTO", piParams)
	if (vDsLstFormaPgto = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Forma de pagamento não informada!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	vVlDesconto = $item("VL_DESCONTO", piParams)
	vDsLstFatura = $item("DS_LSTFATURAS", piParams)
	vInCartaoProprio = $item("IN_CARTAOPROPRIO", piParams)
	vInBonus = $item("IN_BONUS", piParams)
	vDsLstCheque = $item("DS_LSTCHEQUE", piParams) ;* Claudemir - Prj/Tarefa: 61/670

	clear/e "TRA_TRANSACAOSVC"
	CD_EMPRESA.TRA_TRANSACAOSVC/init = vCdEmpTra
	NR_TRANSACAO.TRA_TRANSACAOSVC/init = vNrTransacao
	DT_TRANSACAO.TRA_TRANSACAOSVC/init = vDtTransacao
	retrieve/e "TRA_TRANSACAOSVC" 
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação %%vNrTransacao não encontrada!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPFAT.TRA_TRANSACAOSVC
	activate "SICSVCO009".validaCentroCusto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "") 
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")    
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vCdCCusto = $item("CD_CENTROCUSTO", voParams)   
	
	if (CD_EMPFAT.TRA_TRANSACAOSVC = vCdCCusto)
		if ($PadraoEcf$ = <PADRAO_LOCALIMPFIM>)
			if($inPdvOtimizado$ != <TRUE>)
				viParams = ""
				activate "ECFSVCO001".abreGaveta(viParams, voParams, $xcderro$, $xctxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "") 
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif	
			endif
		endif
		return(0)
	endif
	
	vCdEmpECF = $item("CD_EMPECF", piParams)
	if (vCdEmpECF = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da ECF não informada!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vNrECF = $item("NR_ECF", piParams)
	if (vNrECF = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Número da ECF não informado!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	if ($PadraoEcf$ = <PADRAO_BEMATECH>)
		vNrCupom = $item("NR_CUPOM", piParams)
		if (vNrCupom = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Número do cupom fiscal não informado!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	else
		vNrCupom = $item("NR_CUPOM", piParams)
	endif

	clear/e "FIS_ECFSVC"
	CD_EMPRESA.FIS_ECFSVC/init = vCdEmpECF
	NR_ECF.FIS_ECFSVC/init = vNrECF
	retrieve/e "FIS_ECFSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Impressora fiscal %%vCdEmpECF / %%vNrECF não cadastrada!", "ADICIONAL=Operação->ECFSVCO010.geraCupomNaoConcomitante")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	clear/e "TRA_TRANSACAOSVC"
	CD_EMPRESA.TRA_TRANSACAOSVC/init = vCdEmpTra
	NR_TRANSACAO.TRA_TRANSACAOSVC/init = vNrTransacao
	DT_TRANSACAO.TRA_TRANSACAOSVC/init = vDtTransacao
	retrieve/e "TRA_TRANSACAOSVC" 
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação %%vNrTransacao não encontrada!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	clear/e "FIS_NFSVC"
	CD_EMPRESAORI.FIS_NFSVC/init = vCdEmpTra
	NR_TRANSACAOORI.FIS_NFSVC/init = vNrTransacao
	DT_TRANSACAOORI.FIS_NFSVC/init = vDtTransacao
	retrieve/e "FIS_NFSVC" 
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nota Fiscal não encontrada para a transação %%vNrTransacao!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    
	setocc "FIS_NFSVC", -1
	if ($totocc ("FIS_NFSVC") > 1)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Existe mais de uma nota para essa transação!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	if ($PadraoEcf$ = <PADRAO_BEMATECH>)	
		;* Claudemir - Prj/Tarefa: 102/756
		if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
			$hrInicio$ = $clock
			putmess "ECFSVCO010: encerraCupom - Inicio Verifica Estado: %%$hrInicio$"
		endif ;*

		vInAberto = ""
		viParams = ""
		activate "ECFSVCO001".verificaEstado(viParams, voParams, $xcderro$, $xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(vStatus)
		endif

		;* Claudemir - Prj/Tarefa: 102/756
		if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
			$hrFim$ = $clock
			putmess "ECFSVCO010: encerraCupom - Fim Verifica Estado: %%$hrFim$"
		endif ;*
	
		vInAberto = $item("INABERTO", voParams)
	
		if (vInAberto != "S")
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não existe cupom aberto na impressora!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif    
	endif
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPFAT.TRA_TRANSACAOSVC
	activate "SICSVCO009".validaCentroCusto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "") 
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")    
		return(-1)
	endif
	
	vCdCCusto = $item("CD_CENTROCUSTO", voParams)    

	if (CD_EMPFAT.TRA_TRANSACAOSVC = vCdCCusto)
		return(0)
	endif

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "ECFSVCO010: encerraCupom - Inicio Acrescimo Desconto: %%$hrInicio$"
	endif ;*

	;--------------------
	;ACRESCIMO/DESCONTO 
	;--------------------

	;* Claudemir - Prj/Tarefa: 191/1 - 28/09/2011
	;vVlDesconto = vVlDesconto + VL_DESCONTO.TRA_TRANSACAOSVC
	if (vInConcomitante = <TRUE>)
		; na ECF concomitante, o desconto de item já foi dado, portanto só vai mandar o desconto da capa
		setocc "TRA_TRANSITEMSVC", 1
		while ($status >= 0)
			vVlDesconto	= vVlDesconto + VL_TOTALDESCCAB.TRA_TRANSITEMSVC

			setocc "TRA_TRANSITEMSVC", $curocc("TRA_TRANSITEMSVC") + 1
		endwhile		
	else
		vVlDesconto = vVlDesconto + VL_DESCONTO.TRA_TRANSACAOSVC
	endif ;*

	viParams = ""
	if (vVlDesconto > 0)
		putitem/id viParams, "IN_ACRESDESC", "D"
		putitem/id viParams, "TP_ACRESDESC", "$"
		putitem/id viParams, "VL_ACRESDESC", vVlDesconto
	else
		putitem/id viParams, "IN_ACRESDESC", ""
		putitem/id viParams, "TP_ACRESDESC", ""
		putitem/id viParams, "VL_ACRESDESC", 0
	endif
	if (vInTEF = <TRUE> & $NrNivelImp$ >= 1)
		$DsCupom$ = ""
	else
		putitem/id viParams, "IN_CONCOMITANTE", vInConcomitante ;* Claudemir - Prj/Tarefa: 26/31 - 25/11/2009
		activate "ECFSVCO001".AcrescimoDescontoCupom(viParams, voParams, $xcderro$, $xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(vStatus)
		endif
		$NrNivelImp$ = 1 ;indica que foi feito acrescimo/desconto no cupom sem nenhum problema - TEF
		vDsCupom = $item("DS_CUPOM",voParams)
		$DsCupom$ = "%%$DsCupom$%%vDsCupom"
	endif

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		putmess "ECFSVCO010: encerraCupom - Fim Acrescimo Desconto: %%$hrFim$"
	endif ;*


	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "ECFSVCO010: encerraCupom - Inicio Forma de pagamento: %%$hrInicio$"
	endif ;*

	;--------------------
	;FORMAS DE PAGAMENTO 
	;--------------------
	if (vInTEF = <TRUE> & $NrNivelImp$ >= 2)
		$DsCupom$ = ""
	else
		vNrNivelImpPgto = 0
		repeat
			getitem vDsRegistro, vDsLstFormaPgto, 1
			vDsFormaPgto = $item("DS_FORMAPGTO", vDsRegistro)
			if (vDsFormaPgto = "")
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Descrição da forma de pagamento não informada!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		
			vVlFormaPgto = $item("VL_FORMAPGTO", vDsRegistro)
			if (vVlFormaPgto = 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor da forma de pagamento não informado!", "ADICIONAL=Operação->ECFSVCO010.encerraCupom")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		
			vNrNivelImpPgto = vNrNivelImpPgto + 1

			viParams = ""
			voParams = ""
			putitem/id viParams "DS_FORMAPGTO", vDsFormaPgto 
			putitem/id viParams "VL_FORMAPGTO", vVlFormaPgto
			if (vInTEF = <TRUE> & vNrNivelImpPgto <= $NrNivelImpPgto$)
				$DsCupom$ = ""
			else
				activate "ECFSVCO001".FormaPagamento(viParams,voParams,$xcderro$,$xctxerro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					vStatus = $status
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(vStatus)
				endif
				$NrNivelImpPgto$ = $NrNivelImpPgto$ + 1 
				vDsCupom = $item("DS_CUPOM",voParams)
				$DsCupom$ = "%%$DsCupom$%%vDsCupom"
			endif

			delitem vDsLstFormaPgto, 1
		until (vDsLstFormaPgto = "")
	endif
	$NrNivelImp$ = 2 ;indica que as formas de pgto foram impressas no cupom sem nenhum problema - TEF

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		putmess "ECFSVCO010: encerraCupom - Fim Forma de pagamento: %%$hrfim$"
	endif ;*

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "ECFSVCO010: encerraCupom - Inicio Fechamento do Cupom: %%$hrInicio$"
	endif ;*
	;-=CANONICO=- 30/11/2010 TAR 982 PRJ 102 - Impressão do cupom TEF utilizando PAYGO rezumida
	;Necessario porque caso tenha mais de um cupom TEF na transação não é possivel imprimir na observação do cupom
	call verificaQtdTransacaoTEF(vCdEmpTra,vNrTransacao,vDtTransacao,vQtTransacaoTEF)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	if ($status < 0)
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	if ($tpImpTefPAYGO$ = 1 & vQtTransacaoTEF = 1);-=CANONICO=- 30/11/2010 TAR 982 PRJ 102 - Impressão do cupom TEF utilizando PAYGO rezumida
		clear/e "TEF_RELTRANSASVC"
		CD_EMPTRA.TEF_RELTRANSASVC/init =  vCdEmpTra   
		NR_TRANSACAO.TEF_RELTRANSASVC/init = vNrTransacao
		DT_TRANSACAO.TEF_RELTRANSASVC/init = vDtTransacao
		retrieve/e "TEF_RELTRANSASVC" 
		if ($status >=0)
			clear/e "TEF_TRANSACAOSVC"
			CD_EMPRESA.TEF_TRANSACAOSVC/init =   CD_EMPTEF.TEF_RELTRANSASVC   
			DT_MOVIMENTO.TEF_TRANSACAOSVC/init = DT_MOVIMENTO.TEF_RELTRANSASVC   
			NR_SEQ.TEF_TRANSACAOSVC/init      = NR_SEQ.TEF_RELTRANSASVC 
			retrieve/e "TEF_TRANSACAOSVC" 
			if ($status >= 0)
				vDsMensagem = DS_CUPOM.TEF_TRANSACAOSVC
			endif   
		endif
		
	else
		;--------------------
		;FECHAMENTO DO CUPOM 
		;--------------------
		viParams = ""
		voParams = ""
		if ($InImpObsECFCliVista$=1) ;Imprime obs no cliente a vista
			putitem/id viParams, "CD_CLIENTE", CD_PESSOA.TRA_TRANSACAOSVC
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
			putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
			putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
			putitem/id viParams, "CD_COMPVEND", CD_COMPVEND.TRA_TRANSACAOSVC ;-=CANONICO=- (25/03/2008) TAR 266 - PRJ 102
			activate "ECFSVCO012".geraObsECF($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "") 
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				vStatus = $status
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")    
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(vStatus)
			endif
			vDsMensagem = $item("DS_MENSAGEM", voParams) 
		else 
			if($CdClientePdv$ != CD_PESSOA.TRA_TRANSACAOSVC)
				putitem/id viParams, "CD_CLIENTE", CD_PESSOA.TRA_TRANSACAOSVC
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
				putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
				putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
				putitem/id viParams, "CD_COMPVEND", CD_COMPVEND.TRA_TRANSACAOSVC ;-=CANONICO=- (25/03/2008) TAR 266 - PRJ 102	
				activate "ECFSVCO012".geraObsECF($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "") 
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					vStatus = $status
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")    
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(vStatus)
				endif
				vDsMensagem = $item("DS_MENSAGEM", voParams) 
				;putitem/id viParams, "DS_MENSAGEM", vDsMensagem
			endif
		endif
	endif

	putitem/id viParams, "NR_SERIE", CD_SERIEFAB.FIS_ECFSVC
	putitem/id viParams, "NR_CUPOM", vNrCupom
	putitem/id viParams, "DS_CUPOM", $DsCupom$ ;Quando for impressao por monitor
	putitem/id viParams, "DS_MENSAGEM", vDsMensagem
	activate "ECFSVCO001".FechaCupom(viParams, voParams, $xcderro$, $xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		vStatus = $status
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(vStatus)
	endif 
	if ($PadraoEcf$ = <PADRAO_LOCALIMPFIM> & vNrCupom = 0)
		vNrCupom = $item("NR_CUPOM",voParams)
		putitem/id poParams, "NR_CUPOM", vNrCupom
	endif  
		
	if ($tpImpTefPAYGO$ = 1 & vQtTransacaoTEF = 1)
		putitem/id poparams, "TP_IMPTEFPAYGO", $tpImpTefPAYGO$ ;-=CANONICO=- 30/11/2010 TAR 982 PRJ 102 - Impressão do cupom TEF utilizando PAYGO rezumida
	endif	

	$DsCupom$ = ""
	$NrNivelImp$ = 0 ;zera esse flag quando foi fechado o cupom corretamente - TEF
	$NrNivelImpPgto$ = 0 ;zera esse flag quando foi fechado o cupom corretamente - TEF

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		putmess "ECFSVCO010: encerraCupom - Fim Fechamento do Cupom: %%$hrFim$"
	endif ;*

	if (vNrCupom = 0)
		viParams = ""
		voParams = ""
		putitem/id viParams, "NM_FUNCAO", <ECF_NUMERO_CUPOM>
		putitem/id viParams, "IN_IMPCUPOMFISCAL", <FALSE>
		activate "ECFSVCO001".leInformacaoImpressora(viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif 
		vNrCupom = $item("NR_CUPOM",voParams)
		if (vNrCupom = 0)
			vNrCupom = NR_TRANSACAO.TRA_TRANSACAOSVC
		endif
	endif	
	
	if (vInConcomitante = <FALSE>)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
		putitem/id viParams, "CD_EMPECF", vCdEmpECF
		putitem/id viParams, "NR_ECF", vNrECF
		putitem/id viParams, "NR_CUPOM", vNrCupom
		putitem/id viParams, "IN_GRAVARELACAO",	<TRUE>;-Não concomitante tenho que forçar a gravação em newinstance ;-=CANONICO=-
		;newinstance "TRASVCO016", "TRASVCO016", "TRANSACTION=TRUE" ;-=CANONICO=- (29/11/2011) corrigindo newInstance 
		newinstance "TRASVCO016", "TRASVCO016X", "TRANSACTION=TRUE" 
		activate "TRASVCO016X".gravaECFTransacao($xlpg$, viParams, voParams, $xcderro$, $xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		deleteinstance "TRASVCO016X"    
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.FIS_NFSVC
	putitem/id viParams, "NR_FATURA", NR_FATURA.FIS_NFSVC
	putitem/id viParams, "DT_FATURA", DT_FATURA.FIS_NFSVC
	putitem/id viParams, "CD_EMPECF", vCdEmpECF
	putitem/id viParams, "NR_ECF", vNrECF
	putitem/id viParams, "NR_CUPOM", vNrCupom
	activate "FISSVCO004".gravaECFNF($xlpg$, viParams, voParams, $xcderro$, $xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    

	;Aqui eh impresso o carne quando a forma de pgto é fatura
	;Fiuza 04/10/05

	;* Claudemir - Prj/Tarefa: 61/670
	;* Tambem vai imprimir carne, para cheques
	;if (vDsLstFatura != "" & $InCarne$ = "S")
	if ($InCarne$ = "S") & ((vDsLstFatura != "") | (vDsLstCheque!= ""))
		;-=CANONICO=- (12/05/2008) TAR 303 PRJ 102
		if ($InPerguntaImpCarneEcf$ = <TRUE>)	
			askmess "Deseja imprimir o carne ECF?", "Sim,Não"
			if ($status = 1)
				;-=CANONICO=- (30/05/2008) TAR 18 PRJ 26 "CODIGO E O NOME DO CLIENTE NO CARNE ECF"
				viParams = ""
				voParams = ""
				if (vDsLstFatura != "") ;* Claudemir - Prj/Tarefa: 61/670
					putitem vDsFatura, -1, "%%^%%CD_PESSOA.PES_PESSOASVC%%% %%NM_PESSOA.PES_PESSOASVC%%^"   
					repeat
						getitem vDsRegistro, vDsLstFatura, 1
						vNrFatura = $item("NR_FATURA", vDsRegistro)
						$vDtVencto$ = $item("DT_VENCIMENTO", vDsRegistro)
						vNrParcela = $item("NR_PARCELA", vDsRegistro)
						$vlFatura$ = $item("VL_FATURA", vDsRegistro)
						vVlTotalFatura = vVlTotalFatura + $vlFatura$
						putitem vDsFatura, -1, "%%vNrFatura%%%/%%vNrParcela Venc.: %%$vDtVencto$ .:R$ %%$vlFatura$"   
						delitem vDsLstFatura, 1
					until (vDsLstFatura = "")

					putitem/id viParams, "DS_LSTCUPOMVINCULADO", vDsFatura
				endif

				if (vDsLstCheque != "") ;* Claudemir - Prj/Tarefa: 61/670
					if (vDsFatura = "")
						putitem vDsCheque, -1, "%%^%%CD_PESSOA.PES_PESSOASVC%%% %%NM_PESSOA.PES_PESSOASVC%%^"   
					endif
					vDsLstCheque2 = vDsLstCheque
					repeat
						getitem vDsRegistro, vDsLstCheque2, 1
						vNrFatura = $item("NR_FATURA", vDsRegistro)
						$vDtVencto$ = $item("DT_VENCIMENTO", vDsRegistro)
						vVlCheque = $item("VL_FATURA", vDsRegistro)
						vVlTotalCheque = vVlTotalCheque + vVlCheque
						putitem vDsCheque, -1, "%%vNrFatura%%%/%%vNrParcela Venc.: %%$vDtVencto$ .:R$ %%$vlFatura$"   
						delitem vDsLstCheque2, 1
					until (vDsLstCheque2 = "")

					putitem/id viParams, "DS_LSTCUPOMVINCULADO", vDsCheque
				endif ;*
	
				;-=CANONICO=- (08/02/2008) TAR 215 PRJ 102
				if ($cdModTraObsEcfCarne$ != "")	
					vDsLstTransacao = ""
					vDsRegistro = ""
					putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
					putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
					putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
					putitem vDsLstTransacao, -1, vDsRegistro				
	
					putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
					putitem/id viParams, "CD_MODELOTRA", $cdModTraObsEcfCarne$
					putitem/id viParams, "DS_LSTCHEQUE", vDSLstCheque ;* Claudemir - Prj/Tarefa: 61/670
					activate "GERSVCO020".geraImpressaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					
					vDsAux =  $item("DS_CONTEUDO", voParams)
           
					vDsConteudo = "%%vDsConteudo%%vDsAux" 

					;delitem/id viParams, "DS_LSTCUPOMVINCULADO"
					;putitem/id viParams, "DS_LSTCUPOMVINCULADO", $item("DS_CONTEUDO", voParams)
				endif
				;

				;imprimi recibo do cartao proprio	
				if(vInCartaoProprio = <TRUE>)
					if($cdMmodTraEcfCartaoProp$ > 0)
						vDsLstTransacao = ""
						vDsRegistro = ""
						putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
						putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
						putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
						putitem vDsLstTransacao, -1, vDsRegistro
					
						putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
						putitem/id viParams, "CD_MODELOTRA", $cdMmodTraEcfCartaoProp$
						putitem/id viParams, "DS_LSTCHEQUE", vDSLstCheque ;* Claudemir - Prj/Tarefa: 61/670
						activate "GERSVCO020".geraImpressaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif    
        
						vDsAux =  $item("DS_CONTEUDO", voParams)
           
						vDsConteudo = "%%vDsConteudo%%vDsAux" 

					endif
				endif

				;imprmir recibo de bonus
				if(vInBonus = <TRUE>)
					if($cdModTraEcfReciboBonus$ > 0)

						vDsLstTransacao = ""
						vDsRegistro = ""
						putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
						putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
						putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
						putitem vDsLstTransacao, -1, vDsRegistro
						
						putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
						putitem/id viParams, "CD_MODELOTRA", $cdModTraEcfReciboBonus$
						putitem/id viParams, "DS_LSTCHEQUE", vDSLstCheque ;* Claudemir - Prj/Tarefa: 61/670
						activate "GERSVCO020".geraImpressaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
      
						vDsAux =  $item("DS_CONTEUDO", voParams)
           
						vDsConteudo = "%%vDsConteudo%%vDsAux" 

					endif
				endif

				;* Claudemir - Prj/Tarefa: 61/670
				;putitem/id viParams, "DS_FORMAPGTO", "Fatura"
				
				if (vDsFatura != "")
					putitem/id viParams, "DS_FORMAPGTO", "Fatura"
					;-=CANONICO=- (05/05/2008) TAR 304 PRJ 102 {Impressora Elgin exige que seja passado o valor exato da fatura}
					;* Claudemir - Mandar o valor total das faturas para o Cupom vinculado
					;putitem/id viParams, "VL_VALOR", $vlFatura$
					putitem/id viParams, "VL_VALOR", vVlTotalFatura
				else
					putitem/id viParams, "DS_FORMAPGTO", "Cheque"
					putitem/id viParams, "VL_VALOR", vVlTotalCheque
				endif  ;*

				putitem/id viParams, "NR_CUPOM", vNrCupom 
			
				if (vDsConteudo != "")
					putitem/id viParams, "DS_LSTCUPOMVINCULADO", vDsConteudo 
				endif

				$instancehandle->geraCupomVinculado($xlpg$, viParams, voParams, $xcderro$, $xctxerro$)
				if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif 
			endif	
		else
			if (vDsLstFatura != "") ;* Claudemir - Prj/Tarefa: 61/670
				putitem vDsFatura, -1, "%%^%%CD_PESSOA.PES_PESSOASVC%%% %%NM_PESSOA.PES_PESSOASVC%%^"   
				repeat
					viParams = ""
					voParams = ""
					getitem vDsRegistro, vDsLstFatura, 1
					vNrFatura = $item("NR_FATURA", vDsRegistro)
					$vDtVencto$ = $item("DT_VENCIMENTO", vDsRegistro)
					vNrParcela = $item("NR_PARCELA", vDsRegistro)
					$vlFatura$ = $item("VL_FATURA", vDsRegistro)
					vVlTotalFatura = vVlTotalFatura + $vlFatura$
					putitem vDsFatura, -1, "%%vNrFatura%%%/%%vNrParcela Venc.: %%$vDtVencto$ .:R$ %%$vlFatura$"   
					delitem vDsLstFatura, 1
				until (vDsLstFatura = "")
				putitem/id viParams, "DS_LSTCUPOMVINCULADO", vDsFatura
			endif

			if (vDsLstCheque != "") ;* Claudemir - Prj/Tarefa: 61/670
				if (vDsFatura = "")
					putitem vDsCheque, -1, "%%^%%CD_PESSOA.PES_PESSOASVC%%% %%NM_PESSOA.PES_PESSOASVC%%^"   
				endif
				vDsLstCheque2 = vDsLstCheque
				repeat
					getitem vDsRegistro, vDsLstCheque2, 1
					vNrFatura = $item("NR_FATURA", vDsRegistro)
					$vDtVencto$ = $item("DT_VENCIMENTO", vDsRegistro)
					vVlCheque = $item("VL_FATURA", vDsRegistro)
					vVlTotalCheque = vVlTotalCheque + vVlCheque
					putitem vDsCheque, -1, "%%vNrFatura%%%/%%vNrParcela Venc.: %%$vDtVencto$ .:R$ %%$vlFatura$"   
					delitem vDsLstCheque2, 1
				until (vDsLstCheque2 = "")

				putitem/id viParams, "DS_LSTCUPOMVINCULADO", vDsCheque
			endif ;*

			;-=CANONICO=- (08/02/2008) TAR 215 PRJ 102
			if ($cdModTraObsEcfCarne$ != "")	
				vDsLstTransacao = ""
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
				putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
				putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
				putitem vDsLstTransacao, -1, vDsRegistro
				
				putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
				putitem/id viParams, "CD_MODELOTRA", $cdModTraObsEcfCarne$
				putitem/id viParams, "DS_LSTCHEQUE", vDSLstCheque ;* Claudemir - Prj/Tarefa: 61/670
				activate "GERSVCO020".geraImpressaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				
				vDsAux =  $item("DS_CONTEUDO", voParams)
          
				vDsConteudo = "%%vDsConteudo%%vDsAux" 
				;delitem/id viParams, "DS_LSTCUPOMVINCULADO"
				;putitem/id viParams, "DS_LSTCUPOMVINCULADO", $item("DS_CONTEUDO", voParams)
			endif
			;

			;imprimi recibo do cartao proprio	
			if(vInCartaoProprio = <TRUE>)
				if($cdMmodTraEcfCartaoProp$ > 0)
					vDsLstTransacao = ""
					vDsRegistro = ""
					putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
					putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
					putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
					putitem vDsLstTransacao, -1, vDsRegistro
				
					putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
					putitem/id viParams, "CD_MODELOTRA", $cdMmodTraEcfCartaoProp$
					putitem/id viParams, "DS_LSTCHEQUE", vDSLstCheque ;* Claudemir - Prj/Tarefa: 61/670
					activate "GERSVCO020".geraImpressaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif    
       
					vDsAux =  $item("DS_CONTEUDO", voParams)
          
					vDsConteudo = "%%vDsConteudo%%vDsAux" 
				endif
			endif

			;imprmir recibo de bonus
			if(vInBonus = <TRUE>)
				if($cdModTraEcfReciboBonus$ > 0)
					vDsLstTransacao = ""
					vDsRegistro = ""
					putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
					putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
					putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
					putitem vDsLstTransacao, -1, vDsRegistro
					
					putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
					putitem/id viParams, "CD_MODELOTRA", $cdModTraEcfReciboBonus$
					putitem/id viParams, "DS_LSTCHEQUE", vDSLstCheque ;* Claudemir - Prj/Tarefa: 61/670
					activate "GERSVCO020".geraImpressaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
     
					vDsAux =  $item("DS_CONTEUDO", voParams)
          
					vDsConteudo = "%%vDsConteudo%%vDsAux" 
				endif
			endif

			if (vDsFatura != "")		
				putitem/id viParams, "DS_FORMAPGTO", "Fatura"
				putitem/id viParams, "NR_CUPOM", vNrCupom 
			
				;-=CANONICO=- (05/05/2008) TAR 304 PRJ 102 {Impressora Elgin exige que seja passado o valor exato da fatura}
				;* Claudemir - Mandar o valor total das faturas para o Cupom vinculado
				;putitem/id viParams, "VL_VALOR", $vlFatura$
				putitem/id viParams, "VL_VALOR", vVlTotalFatura ;*
			else
				putitem/id viParams, "DS_FORMAPGTO", "Cheque"
				putitem/id viParams, "VL_VALOR", vVlTotalCheque
			endif	


			if (vDsConteudo != "")
				putitem/id viParams, "DS_LSTCUPOMVINCULADO", vDsConteudo 
			endif

			$instancehandle->geraCupomVinculado($xlpg$, viParams, voParams, $xcderro$, $xctxerro$)
			if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif 
		endif
		;.

	else
		vinImprimiGerencial	= <FALSE>
		if(vInCartaoProprio = <TRUE>)
			;imprimi recibo do cartao proprio	
			if($cdMmodTraEcfCartaoProp$ > 0)
				vinImprimiGerencial	= <TRUE>
				vDsLstTransacao = ""
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
				putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
				putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
				putitem vDsLstTransacao, -1, vDsRegistro
			
				putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
				putitem/id viParams, "CD_MODELOTRA", $cdMmodTraEcfCartaoProp$
				putitem/id viParams, "DS_LSTCHEQUE", vDSLstCheque ;* Claudemir - Prj/Tarefa: 61/670
				activate "GERSVCO020".geraImpressaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif    
      		    vDsAux =  $item("DS_CONTEUDO", voParams)
				vDsConteudo = "%%vDsConteudo%%vDsAux" 
			endif
		endif
			;imprmir recibo de bonus
		if(vInBonus = <TRUE>)
			if($cdModTraEcfReciboBonus$ > 0)
				vinImprimiGerencial	= <TRUE>
				vDsLstTransacao = ""
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAOSVC
				putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAOSVC
				putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAOSVC
				putitem vDsLstTransacao, -1, vDsRegistro
					
				putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
				putitem/id viParams, "CD_MODELOTRA", $cdModTraEcfReciboBonus$
				putitem/id viParams, "DS_LSTCHEQUE", vDSLstCheque ;* Claudemir - Prj/Tarefa: 61/670
				activate "GERSVCO020".geraImpressaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
   				vDsAux =  $item("DS_CONTEUDO", voParams)
	    		vDsConteudo = "%%vDsConteudo%%vDsAux" 
			endif
		endif
		if(vinImprimiGerencial = <TRUE>)
			viParams = ""
			putitem/id viParams, "DS_FORMAPGTO", vDsFormaPgto 
			putitem/id viParams, "VL_VALOR", vVlFormaPgto
			putitem/id viParams, "NR_CUPOM", vNrCupom
			activate "ECFSVCO011".abreRelatorioGerencial(viParams,voParams,$xcderro$,$xctxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif  

			;monitor de impressão
			$DsCupom$ = ""
			vDsCupom = $item("DS_CUPOM",voParams)
			$DsCupom$ = "%%$DsCupom$%%vDsCupom"
		
			length vDsConteudo
			while($result > 0)
				scan vDsConteudo, "%%^"
				if ($result > 0)
					vDsLinha = vDsConteudo[1, $result - 1]                            
					vDsConteudo = vDsConteudo[$result + 1]            
				else
					vDsLinha = vDsConteudo
					vDsConteudo = ""
				endif
				$DsCupom$ = "%%$DsCupom$%%%025%%vDsLinha%%^"
				vDsCupom = "%%vDsCupom%%%025%%vDsLinha%%^"
				length vDsConteudo
			endwhile

			$hrInicio$ = $clock
			putmess "- Inicio impressao geraCupomVinculado: %%$hrInicio$"

			$DsCupom$ = "%%$DsCupom$%%^%%%026%%^"

			viParams = ""
			putitem/id viParams, "IN_IMPRIMEVIA", <TRUE>
			putitem/id viParams, "DS_TEXTO", $DsCupom$
			activate "ECFSVCO001".ImprimirVinculado(viParams,voParams,$xcderro$,$xctxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status = -10)
				viParams = ""
				voParams = ""
				putitem/id viParams,"TITULO", "Erro de comunicação com a ECF"
				putitem/id viParams,"MENSAGEM", $item("DESCRICAO",$xctxerro$)
				activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
	
				$hrFim$ = $clock
				$hrTempo$ = $hrFim$ - $hrInicio$
				putmess "- Fim : impressao geraCupomVinculado %%$hrFim$ - %%$hrTempo$"
			endif
		endif
	endif

	$NrCupom$ = ""

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		putmess "ECFSVCO010: encerraCupom - Fim Encerra Cupom: %%$hrFim$"
	endif
	
	return(0)
end

;-----------------------
public operation geraCupomVinculado
	;-----------------------
	params
		string  $xlpg$      :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams
	
	variables
		string DsLstCupomVinculado,vDsRegistro,viParams,voParams, DsFormaPgto, vInAberto
		string vDsConteudo, vDsLinha, vDsCupom, vDsLstTransacao, vNulo
		numeric vlValor, vNrCupom, vNrCopia, vNrLinha, vNrVia, vNrLinhasCorte, vNrLinhaCorteAtual, vDsSerie
		boolean InReimpressao, vInCorteVia
		numeric vStatus
	endvariables

	InReimpressao = <FALSE>
	vInAberto = ""    
	viParams = ""
	activate "ECFSVCO001".VerificaEstado(viParams,voParams,$xcderro$,$xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		vStatus = $status
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(vStatus)
	endif
	vDsCupom = $item("DS_CUPOM",voParams)
	$DsCupom$ = "%%$DsCupom$%%vDsCupom"
	
	InReimpressao = $item("IN_REIMPRESSAO", piParams)
	
	vInAberto = $item("INABERTO", voParams)
	if (vInAberto = "S" & InReimpressao)
		vDsRegistro = $item("DS_TEXTO", piParams)
		$instancehandle->reimpressaoCupomVinculado()
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		return(0)
	endif
	
	DsFormaPgto = $item("DS_FORMAPGTO", piParams)
	vlValor = $item("VL_VALOR", piParams)
	vNrCupom = $item("NR_CUPOM", piParams)

	;---------------------------
	;Abre cupom não fiscal vinculado
	;---------------------------
	viParams = ""
	putitem/id viParams, "DS_FORMAPGTO", DsFormaPgto
	putitem/id viParams, "VL_VALOR", vlValor
	putitem/id viParams, "NR_CUPOM", vNrCupom
	activate "ECFSVCO001".AbreComprovanteNFV(viParams,voParams,$xcderro$,$xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		vStatus = $status	
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(vStatus)
	endif    
	vDsCupom = $item("DS_CUPOM",voParams)
	$DsCupom$ = "%%$DsCupom$%%vDsCupom"
		
	DsLstCupomVinculado = $item("DS_LSTCUPOMVINCULADO",piParams)

	if (DsLstCupomVinculado != "")
		;-=CANONICO=- (16/04/2009) TAR 516 PRJ 102 - Permite imprimir o espelho do vinculado de acordo com o parametro "NR_VIAS_ECF_TERMICA"
		vNrCopia = 1
		;* Claudemir - Prj/Tarefa: 102/721 - 04/11/2009 
		; le a entidade, caso tenha o numero de vias cadastradas para a ECF, 
		; movo o valor para a variavel, caso não tenha, mantem o parâmetro
		clear/e "FIS_ECFADICSVC"			
		CD_EMPRESA.FIS_ECFADICSVC/init = CD_EMPRESA.FIS_ECFSVC
		NR_ECF.FIS_ECFADICSVC/init     = NR_ECF.FIS_ECFSVC
		retrieve/e "FIS_ECFADICSVC"
		if ($status >= 0)
			if (NR_VIACARNE.FIS_ECFADICSVC > 0)
				$nrViasEcfTermica$ = NR_VIACARNE.FIS_ECFADICSVC
			endif
			;-=CANONICO=- (25/11/2009) TAR 743 PRJ 102
			if (IN_CORTEVIA.FIS_ECFADICSVC = <TRUE>)
				vInCorteVia  = <TRUE>
			else	
				vInCorteVia  = <FALSE>
			endif
			;* Claudemir - Prj/Tarefa: 102/826 - 15/03/2010
			if (NR_LINHACORTE.FIS_ECFADICSVC > 0)
				vNrLinhasCorte = NR_LINHACORTE.FIS_ECFADICSVC
			else
				vNrLinhasCorte = 0
			endif ;*
		endif ;*		
		
		repeat
			vDsConteudo = DsLstCupomVinculado
			length vDsConteudo
			while($result > 0)
				scan vDsConteudo, "%%^"
				if ($result > 0)
					vDsLinha = vDsConteudo[1, $result - 1]                            
					vDsConteudo = vDsConteudo[$result + 1]            
				else
					vDsLinha = vDsConteudo
					vDsConteudo = ""
				endif
		
				$instancehandle->imprimeCupomVinculado(vDsLinha, vNrLinhasCorte)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				length vDsConteudo
			endwhile        
			
			if (vNrCopia >= $nrViasEcfTermica$)
				$DsCupom$ = "%%$DsCupom$%%%023%%^"
			else
				;$DsCupom$ = "%%$DsCupom$%%%080%%^" ;Comando responsavel por um intervalo de 5 segundos entre um espelho do cupom e outro. Obs. Versao monitor 2.2.a 
				;-=CANONICO=- (25/11/2009) TAR 743 PRJ 102
				vNrVia = vNrCopia + 1
				;* Claudemir - Prj/Tarefa: 102/826 - 15/03/2010
				; substituido a quantidade de linhas fixas para pular, pela configurada na tabela

				;$DsCupom$ = "%%$DsCupom$%%%022%%^%%%022%%^%%%022%%vNrVia%%%ª VIA%%^" 
				vNrLinhaCorteAtual = vNrLinhasCorte
				if (vNrLinhaCorteAtual > 0)
					while (vNrLinhaCorteAtual > 1)
						$DsCupom$ = "%%$DsCupom$%%%022%%^" 
						vNrLinhaCorteAtual = vNrLinhaCorteAtual - 1
					endwhile
				endif

				if (vInCorteVia = <TRUE>)
					$DsCupom$ = "%%$DsCupom$%%%131%%^" 
				endif

				$DsCupom$ = "%%$DsCupom$%%%022%%vNrVia%%%ª VIA%%^" 
				;*				
			endif

			vNrCopia = vNrCopia + 1
		until (vNrCopia > $nrViasEcfTermica$)
	endif
	
	;-=CANONICO=- (08/02/2008) TAR 215 PRJ 102
	if ($PadraoEcf$ = <PADRAO_LOCALIMPFIM>)
		viParams = ""
		putitem/id viParams, "DS_TEXTO", $DsCupom$
		putitem/id viParams, "IN_IMPRIMEVIA", <TRUE>
		activate "ECFSVCO001".ImprimirVinculado(viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(vStatus)
		endif 
	endif
	;

	if ($PadraoEcf$ != <PADRAO_LOCALIMPFIM>)
		viParams = ""
		putitem/id viParams, "DS_CUPOM", $DsCupom$ ;Quando nao for impressao por monitor
		activate "ECFSVCO001".FechaVinculado(viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(vStatus)
		endif
	endif
	$DsCupom$ = ""
	
	return(0)
end ; geraCupomVinculado

;-----------------------
public operation reimpressaoCupomVinculado
	;-----------------------
	params
		string vDsTexto : IN
	endparams
	variables
		string viParams, voParams, vDsConteudo, vDsLinha
		numeric vStatus
	endvariables
	
	;fecha cupom vinculado
	viParams = ""
	activate "ECFSVCO001".FechaVinculado(viParams,voParams,$xcderro$,$xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		vStatus = $status
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(vStatus)
	endif

	;Fiuza - 28/07/06 - projeto 26 tarefa 6 - a partir de agora manda linha a linha para imp.fiscal
	vDsConteudo = vDsTexto
	length vDsConteudo
	while($result > 0)
		scan vDsConteudo, "%%^"
		if ($result > 0)
			vDsLinha = vDsConteudo[1, $result - 1]                            
			vDsConteudo = vDsConteudo[$result + 1]            
		else
			vDsLinha = vDsConteudo
			vDsConteudo = ""
		endif

		;abre relatorio gerencial
		viParams = ""
		putitem/id viParams, "DS_TEXTO", vDsLinha
		activate "ECFSVCO001".ImprimirRelatorioGerencial(viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(vStatus)
		endif

		length vDsConteudo
	endwhile    

	;abre relatorio gerencial
;	viParams = ""
;	putitem/id viParams, "DS_TEXTO", vDsTexto
;	activate "ECFSVCO001".ImprimirRelatorioGerencial(viParams,voParams,$xcderro$,$xctxerro$)
;	if ($procerror)       
;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;		return(-1)
;	elseif ($status < 0)
;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;		return(-1)
;	endif    
	
	;fecha relatorio gerencial
	viParams = ""
	activate "ECFSVCO001".FechaRelatorioGerencial(viParams,voParams,$xcderro$,$xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		vStatus = $status
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(vStatus)
	endif
	
	return(0)
end;reimpressaoCupomVinculado

;-----------------------
public operation imprimeCupomVinculado
;-----------------------
	params
		string DsLstCupomVinculado : IN
		numeric vNrLinhasCorte : IN
	endparams

	variables
		string vDsRegistro, viParams, voParams, vDsCupom
		numeric vStatus, vTamanho, vContador
		boolean vInCorteVia 
	endvariables

	repeat 
		getitem vDsRegistro, DsLstCupomVinculado, 1
		viParams = ""
		putitem/id viParams, "DS_TEXTO", vDsRegistro
		if ($PadraoEcf$ != <PADRAO_LOCALIMPFIM>) ;quando nao for monitor
			activate "ECFSVCO001".ImprimirVinculado(viParams,voParams,$xcderro$,$xctxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				vStatus = $status
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(vStatus)
			endif    
		else
			;* Claudemir - Prj/Tarefa: 102/923 - 17/08/2010
			  ;vDsCupom = "022%%vDsRegistro"

			scan vDsRegistro, "[BARRA]"
			if ($result > 0)
				vTamanho = $length(vDsRegistro)
				vDsCupom = "135%%vDsRegistro[8, vTamanho]"
			else
				;* Claudemir - Prj/Tarefa: 156/662 - 10/11/2011
				;vDsCupom = "022%%vDsRegistro"
				scan vDsRegistro, "[CORTE]"
				if ($result > 0)
					vContador = 1
					while (vContador <= vNrLinhasCorte)
						vDsCupom = "%%vDsCupom%%%022%%^"
						vContador = vContador + 1
					endwhile
					vDsCupom = "%%vDsCupom%%%131%%^"
					vDsCupom = "%%vDsCupom%%%022%%^"
				else
					vDsCupom = "022%%vDsRegistro"
				endif ;*
			endif   ;*

			;-=CANONICO=- (25/11/2009) TAR 743 PRJ 102
			if (vInCorteVia = <TRUE>)
				$DsCupom$ = "%%$DsCupom$%%%022%%^%%%022%%^%%%131%%^" 
			else
				$DsCupom$ = "%%$DsCupom$%%vDsCupom%%^"
			endif
		endif

		delitem DsLstCupomVinculado, 1
	until(DsLstCupomVinculado = "")

	return(0)

end;imprimeVinculado

;------------------------------
public operation cancelaItem
	;------------------------------
	params
		string  $xlpg$      :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams
	variables
		string viParams, voParams
		numeric vNrItem, vCdEmpTra, vNrTransacao
		date vDtTransacao
		numeric vStatus
	endvariables

	vCdEmpTra = $item("CD_EMPRESA", piParams)
	if (vCdEmpTra = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.cancelaItem")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vNrTransacao = $item("NR_TRANSACAO", piParams)
	if (vNrTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Numero da transação não informado!", "ADICIONAL=Operação->ECFSVCO010.cancelaItem")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vDtTransacao = $item("DT_TRANSACAO", piParams)
	if (vDtTransacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Data da transação não informada!", "ADICIONAL=Operação->ECFSVCO010.cancelaItem")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif   

	vNrItem= $item("NR_ITEM", piParams)
	if (vNrItem = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Número do item não informado!", "ADICIONAL=Operação->ECFSVCO010.cancelaItem")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif 
	
	clear/e "TRA_TRANSACAOSVC"
	CD_EMPRESA.TRA_TRANSACAOSVC/init = vCdEmpTra
	NR_TRANSACAO.TRA_TRANSACAOSVC/init = vNrTransacao
	DT_TRANSACAO.TRA_TRANSACAOSVC/init = vDtTransacao
	retrieve/e "TRA_TRANSACAOSVC" 
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação %%vNrTransacao não encontrada!", "ADICIONAL=Operação->ECFSVCO010.iniciaCupom")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	viParams = ""
	putitem/id viParams, "NR_ITEM", vNrItem
	activate "ECFSVCO001".cancelaItem(viParams,voParams,$xcderro$,$xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		vStatus = $status
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(vStatus)
	endif 

	return(0)
end; cancelaItem

;---------------------------
public operation validaImpressoraFiscal
	;---------------------------
	params
		string  $xlpg$      :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams

	variables
		string viParams, voParams, vDsSerie
		numeric vStatus, vCdGrupoEmpresa
	endvariables
	
	vDsSerie = $item("NR_SERIE",piParams)
	if (vDsSerie = "")
		viParams = ""
		putitem/id viParams, "NM_FUNCAO", <ECF_NUMERO_SERIE>
		activate "ECFSVCO001".leInformacaoImpressora(viParams,voParams,$xcderro$,$xctxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			vStatus = $status
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(vStatus)
		endif	
		
		vDsSerie = $item("NR_SERIE",voParams)
		if (vDsSerie = "")
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não foi possível obter número de série!", "ADICIONAL=Operação->ECFSVCO010.validaImpressoraFiscal")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	clear/e "FIS_ECFSVC"
	CD_SERIEFAB.FIS_ECFSVC/init = vDsSerie
	retrieve/e "FIS_ECFSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Número de série %%vDsSerie não cadastrado p/ ECF!", "ADICIONAL=Operação->ECFSVCO010.validaImpressoraFiscal")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	;* Claudemir - 30/09/2009 - Prj/Tarefa: 102/694
	; Substituido a leitura do GER_EMPRESA, pela chamada do serviço. Motivo: componente estava estourando

	;clear/e "GER_EMPRESASVC"
	;CD_EMPRESA.GER_EMPRESASVC/init = CD_EMPRESA.FIS_ECFSVC
	;retrieve/e "GER_EMPRESASVC"
	;if ($status < 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da ECF não encontrada!", "ADICIONAL=Operação->ECFSVCO010.validaImpressoraFiscal")
	;	poCdErro = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;	return(-1)
	;else
	;	if (CD_GRUPOEMPRESA.GER_EMPRESASVC != $item("CD_GRUPOEMPRESA",$xlpg$))
	;		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da ECF não pertence a esse grupo empresa!", "ADICIONAL=Operação->ECFSVCO010.validaImpressoraFiscal")
	;		poCdErro = $xCdErro$
	;		poCtxErro = $xCtxErro$
	;		return(-1)	
	;	endif
	;endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.FIS_ECFSVC
	activate "GERSVCO032".buscaDadosEmpresa($xlpg$,viParams,voParams,$xcderro$,$xctxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		vStatus = $status
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(vStatus)
	endif	

	vCdGrupoEmpresa = $item("CD_GRUPOEMPRESA", voParams)

	if (vCdGrupoEmpresa = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da ECF não encontrada!", "ADICIONAL=Operação->ECFSVCO010.validaImpressoraFiscal")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	else
		if (vCdGrupoEmpresa != $item("CD_GRUPOEMPRESA",$xlpg$))
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa da ECF não pertence a esse grupo empresa!", "ADICIONAL=Operação->ECFSVCO010.validaImpressoraFiscal")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)	
		endif
	endif ;*

	return(0)
end;operation validaImpressoraFiscal