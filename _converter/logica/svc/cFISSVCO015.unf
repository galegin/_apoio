;--------------
entry getParam
;--------------
	params
		numeric piCdEmpresa : IN
	endparams

	variables
		string  viParams, voParams, vInOptSimples, vDsLstCFOP
		numeric vNrCFOP
	endvariables

	if (piCdEmpresa = 0)
		$instancehandle->SetStatus (<STS_ERRO>, "GEN0001", "DESCRICAO=Empresa para busca de parâmetros não infomada!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
		return(-1)
	endif

	viParams = ""
	putitem viParams, -1, "CD_EMPRESA_VALOR"
	putitem viParams, -1, "IN_OPT_SIMPLES"
	putitem viParams, -1, "IN_IMPOSTO_OFFLINE"
	putitem viParams, -1, "IN_PDV_OTIMIZADO"
	putitem viParams, -1, "IN_ATIVA_DECRETO_52104"    ;---Elia Proj. 61/259 19/02/08
	putitem viParams, -1, "NATUREZA_COMERCIAL_EMP"    ;---Elia Proj. 61/429 04/08/08
	putitem viParams, -1, "IN_SOMA_FRETE_BASEICMS"    ;---Deusdete Proj. 111/954 15/10/2009
	putitem viParams, -1, "IN_CALC_IPI_OUT_ENT_SAI"   ;-- MAD [Proj/Tar.061/778] - 26/02/2010
	putitem viParams, -1, "IN_CALC_ICMS_ENT_SIMPLES"  ;<ANO Pjt64 Trf818 - 23/04/2010>
	putitem viParams, -1, "PR_APLIC_MVA_SUB_TRIB"     ;-- MAD [Proj/Tar.061/862] - 31/08/2010
	putitem viParams, -1, "IN_ARREDONDA_TRUNCA_ICMS"  ;-- MAD [Proj/Tar.061/878] - 08/10/2010
	putitem viParams, -1, "DS_LST_MODDCTOFISCAL_AT"   ;-- MAD [Proj/Tar.061/878] - 08/10/2010
	putitem viParams, -1, "IN_DESCONTA_PISCOFINS_ALC" ;-- MAD [Proj/Tar.170/313] - 29/06/2011
	putitem viParams, -1, "IN_DESCONTA_PISCOFINS_ZFM" ;-- MAD [Proj/Tar.170/313] - 29/06/2011
	putitem viParams, -1, "IN_RED_BASE_ICMS"          ;-- MAD [Proj/Tar.175/182] - 14/07/2011
	activate "ADMSVCO001".GetParamEmpresa(piCdEmpresa, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($xCdErro$)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%$item("DESCRICAO", $xCtxErro$)", "")
		return(-1)
	endif

	$cdEmpresaValorEmp$ = $item("CD_EMPRESA_VALOR" , voParams)
	vInOptSimples       = $item("IN_OPT_SIMPLES"   , voParams)
	if (vInOptSimples = "S")
		$inOptSimples$ = <TRUE>
	else
		$inOptSimples$ = <FALSE>
	endif
	$inImpostoOffLine$        = $item("IN_IMPOSTO_OFFLINE"       , voParams)
	$inPDVOtimizado$          = $item("IN_PDV_OTIMIZADO"         , voParams)
	$inAtivaDecreto52104$     = $item("IN_ATIVA_DECRETO_52104"   , voParams) ;---Elia Proj. 61/259 19/02/08
	$naturezaComercialEmp$    = $item("NATUREZA_COMERCIAL_EMP"   , voParams) ;---Elia Proj. 61/429 04/08/08
	$inSomaFreteBaseICMS$     = $item("IN_SOMA_FRETE_BASEICMS"   , voParams) ;---Deusdete Proj. 111/954 15/10/09
	$inCalcIpiOutEntSai$      = $item("IN_CALC_IPI_OUT_ENT_SAI"  , voParams) ;-- MAD [Proj/Tar.061/778] - 26/02/2010
	$inCalculaIcmsEntSimples$ = $item("IN_CALC_ICMS_ENT_SIMPLES" , voParams) ;<ANO Pjt64 Trf818 - 23/04/2010>
	$prAplicMvaSubTrib$       = $item("PR_APLIC_MVA_SUB_TRIB"    , voParams) ;-- MAD [Proj/Tar.061/862] - 31/08/2010
	$inArredondaTruncaIcms$   = $item("IN_ARREDONDA_TRUNCA_ICMS" , voParams) ;-- MAD [Proj/Tar.061/878] - 08/10/2010
	$dsLstModDctoFiscalAT$    = $item("DS_LST_MODDCTOFISCAL_AT"  , voParams) ;-- MAD [Proj/Tar.061/878] - 08/10/2010
	$inDescontaPisCofinsAlc$  = $item("IN_DESCONTA_PISCOFINS_ALC", voParams) ;-- MAD [Proj/Tar.170/313] - 29/06/2011
	$inDescontaPisCofinsZfm$  = $item("IN_DESCONTA_PISCOFINS_ZFM", voParams) ;-- MAD [Proj/Tar.170/313] - 29/06/2011
	$inRedBaseIcms$           = $item("IN_RED_BASE_ICMS"         , voParams) ;-- MAD [Proj/Tar.175/182] - 14/07/2011

	viParams = ""
	putitem viParams, -1, "CD_EMPVALOR"
	putitem viParams, -1, "CD_CLAS_REG_ESPECIAL_SC"    ;---Elia Proj. 61/231 29/01/08
	putitem viParams, -1, "CD_ATIVIDADE_VAREJISTA"     ;---Elia Proj. 61/309 15/04/08
	putitem viParams, -1, "PR_ALIQ_ICMS_MANAUS"        ;---Elia Proj. 61/509 24/11/08
	putitem viParams, -1, "IN_PRODPROPRIA_DEC1643"     ;Rodrigo - PRJ 170 TAR 273 - 01/06/2011
	putitem viParams, -1, "DS_LST_CFOP_IPI_BC_PISCOF"  ;--> VSOUZA PRJ/TAR 175/242 - 26/09/2011
	activate "ADMSVCO001".GetLstParametro(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($xCdErro$)
		$instancehandle->SetErroApl($xCtxErro$, $xCdErro$, $xCtxErro$)
		return(-1)
	endif

	$cdEmpresaValorSis$    = $item("CD_EMPVALOR"                , voParams)
	$cdClasRegEspecialSC$  = $item("CD_CLAS_REG_ESPECIAL_SC"    , voParams) ;---Elia Proj. 61/231 29/01/08
	$cdAtividadeVarejista$ = $item("CD_ATIVIDADE_VAREJISTA"     , voParams) ;---Elia Proj. 61/309 15/04/08
	$prAliqICMSManaus$     = $item("PR_ALIQ_ICMS_MANAUS"        , voParams) ;---Elia Proj. 61/509 24/11/08
	$InProdPropriaDec1643$ = $item("IN_PRODPROPRIA_DEC1643"     , voParams) ;Rodrigo - PRJ 170 TAR 273 - 01/06/2011
	$dsLstCfopIpiBcPisCof$ = $item("DS_LST_CFOP_IPI_BC_PISCOF"  , voParams) ;--> VSOUZA PRJ/TAR 175/242 - 26/09/2011

	;--> VSOUZA PRJ/TAR 175/242 - 26/09/2011
	vDsLstCFOP = $dsLstCfopIpiBcPisCof$
   vDsLstCFOP = $replace(vDsLstCFOP, 1, ";", "·;", -1)
   clear/e "TMP_NR09SVC"
   repeat
   	getitem vNrCFOP, vDsLstCFOP,1           
      creocc "TMP_NR09SVC", -1
      NR_GERAL.TMP_NR09SVC = vNrCFOP
      retrieve/o
      delitem vDsLstCFOP, 1
   until(vDsLstCFOP = "")
	;--------------------------------------------->
	return(0)

end ;getParam

;-----------------
entry calculaICMS
;-----------------

	variables
		string  vCdCST
		numeric vVlCalc, vVlBaseCalc, vCdDecreto, vTpProduto
		date    vDtSistema
		boolean vInDecreto, vInPrRedBase, vInPrRedImposto, vInReducao
	endvariables
 
	vDtSistema = $item("DT_SISTEMA", $xlpg$)

	if ($inImpostoOffLine$ = <TRUE>)
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif

	$vlICMS$			= 0
	$cdDecreto$		= ""
	vCdDecreto		= ""
	vInDecreto		= <FALSE>

	if (CD_DECRETO.FIS_DECRETOSVC > 0)
		vCdDecreto = CD_DECRETO.FIS_DECRETOSVC
		if (DT_INIVIGENCIA.FIS_DECRETOSVC != "") & (vDtSistema < DT_INIVIGENCIA.FIS_DECRETOSVC)
			vCdDecreto = ""
		endif
		if (DT_FIMVIGENCIA.FIS_DECRETOSVC != "") & (vDtSistema > DT_FIMVIGENCIA.FIS_DECRETOSVC)
			vCdDecreto = ""
		endif
	endif

	vCdCST		= $cdCST$[2 : 2]
	vTpProduto	= $cdCST$[1 : 1]
	
	;---Elia Proj. 061/650 24/07/09
	if (vCdCST = "60")
		discard "FIS_IMPOSTOSVC"
		$cdDecreto$ = vCdDecreto
		return(0)
	;>-- MAC - PRJ 175/003 - 08/11/2010 ---
	;Acrescentado a CST 030
	;elseif (vCdCST != "00") & (vCdCST != "10") & (vCdCST != "20") & (vCdCST != "40") & (vCdCST != "41") & (vCdCST != "50") & (vCdCST != "51") & (vCdCST != "70") & (vCdCST != "90")
	elseif (vCdCST != "00") & (vCdCST != "10") & (vCdCST != "20") & (vCdCST != "30") & (vCdCST != "40") & (vCdCST != "41") & (vCdCST != "50") & (vCdCST != "51") & (vCdCST != "70") & (vCdCST != "90") 
	;--<
		;---Elia Proj. 61/276 28/03/08
		if (vCdDecreto != 2155) & (vCdDecreto != 1020) & (vCdDecreto != 45471) & (vCdDecreto != 52364) & %\
		(vCdDecreto != 23731) & (vCdDecreto != 23732) & (vCdDecreto != 23733) & (vCdDecreto != 23734) & (vCdDecreto != 23735) & %\
		(vCdDecreto != 10901) & (vCdDecreto != 10902) & (vCdDecreto != 10903) & (vCdDecreto != 10904) & %\
		(vCdDecreto != 2559) & (vCdDecreto != 52804) & %\
		(vCdDecreto != 10201) & (vCdDecreto != 10202) & (vCdDecreto != 10203);ANO Pjt91 Trf310 - 08/01/2009		
			discard "FIS_IMPOSTOSVC"
			$cdDecreto$ = vCdDecreto
			return(0)
		endif
	endif

	if (TP_ALIQICMS.FIS_REGRAFISCSVC = "") ;>-- MAC - PRJ 61 - TAR 749 - 01/02/2010 ---
		;---Elia Proj. 61/202 27/11/07
		if (TP_MODALIDADE.GER_OPERACAOSVC = "E") ; Conhecimento de Frete
			PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
		else
			;---Elia Proj. 61/509 25/11/08
			if ($tpAreaComercioOrigem$ = 2) & ($tpAreaComercioDestino$ = 2) ; 2 - Manaus
				PR_ALIQUOTA.FIS_IMPOSTOSVC = $prAliqICMSManaus$
			else
				;---Elia Proj. 061/622 17/06/09
				if ($dsUFOrigem$ = "MG") & ($dsUFDestino$ = "MG") 
					if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0) & ($inContribuinte$ = <TRUE>) & ($inProdPropria$ = <TRUE>)
						PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
					else
						PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
					endif
				else
				;
					;A alíquota diferenciada so pode se aplicada em NF estadual
					;Nas outra é obrigatorio respeitar a aliquota interestadual
					;A observação acima somente é valido quando há somente uma alíquota interna.
					;A lógica abaixo foi implementada p/ atender o Estado do PR que passou a trabalhar com várias alíquotas internas
					;Neste caso será obedecido o que está na regra fiscal tanto dentro do Estado quanto fora,
					;desde que seja venda p/ consumidor final
					;if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0) & ($dsUFOrigem$ = $dsUFDestino$) 
					if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0) 
						if ($dsUFOrigem$ = $dsUFDestino$) | ($inContribuinte$ = <FALSE>)
							PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
						else	
							PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
						endif
					else
						PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
					endif
				endif
			endif
			;
		endif
		;
	;>-- MAC - PRJ 61 TAR 749 - 01/02/2010 ---
	else
		if (TP_ALIQICMS.FIS_REGRAFISCSVC = "A"); Para transações de operação Estadual
			if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0) 
				if ($dsUFOrigem$ = $dsUFDestino$)
					PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
				else	
					PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
				endif
			else
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
			endif
		elseif (TP_ALIQICMS.FIS_REGRAFISCSVC = "B"); Para transações de operação Interestadual
			if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0) 
				if ($dsUFOrigem$ != $dsUFDestino$)
					PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
				else	
					PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
				endif
			else
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
			endif
		elseif (TP_ALIQICMS.FIS_REGRAFISCSVC = "C"); Para transações de ambas as operações
			if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0) 
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
			else
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
			endif
		endif
	endif
	;--<
	;Emissão de terceiro e diferente de devolucao ou devolução de compra com emissão própria
	if ($tpOrigemEmissao$ = 2 & TP_MODALIDADE.GER_OPERACAOSVC != 3) | ($tpOrigemEmissao$ = 1 & TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S")
		;---Elia Proj. 61/496 16/10/08
		;if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "SC") | ($dsUFOrigem$ = "MG") | ($dsUFOrigem$ = "SP") | ($dsUFOrigem$ = "RJ") | ($dsUFOrigem$ = "CE") | ($dsUFOrigem$ = "RS")
		if(!$inCalculaIcmsEntSimples$) ;<ANO Pjt61 Trf818 - 23/04/2010>
			if ($tpRegimeOrigem$) = 2 | ($tpRegimeOrigem$ = 3);2-Simples 3-EPP
				PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
			endif
		endif
		if ($tpOrigemEmissao$ = 1)
			if ($inOptSimples$ = <TRUE>)
				PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
			endif
		endif
	else
		if ($inOptSimples$ = <TRUE>)
			;---Elia Proj. 61/540 22/01/09
			if ($dsUFOrigem$ != "PR") & (TP_DOCTO.GER_OPERACAOSVC = 2 | TP_DOCTO.GER_OPERACAOSVC = 3) & (vCdCST = 00 | vCdCST = 20 | vCdCST = 51); 2 - ECF - Nao concomitante / 3 - ECF - Concomitante
			;-=CANONICO=- Proj. 61/562 17/03/09 -= Quando UF_ORIGEM nao for PR mantem a aliquota=-
			else
				PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
			endif
		endif
	endif	
 
	;---Elia Proj. 61/309 15/04/08
	if (TP_MODALIDADE.GER_OPERACAOSVC = 4 & TP_OPERACAO.GER_OPERACAOSVC = "S"); Venda
;		if (vTpProduto = 1) | (vTpProduto = 2); Produto Importado
		if (vTpProduto = 1) ;Produto Importado - Deusdete Proj. 61/669 - 24/08/2009
			if ($dsUFOrigem$ = "ES") & ($dsUFDestino$ = "ES")
				if ($inContribuinte$ = <TRUE>)
					if ($inVarejista$ = <TRUE>)
						PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
					else
						PR_ALIQUOTA.FIS_IMPOSTOSVC = 12
					endif
				else
					PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
				endif
			endif
		endif
	endif
	;
	;---Elia Proj. 61/392 01/07/08
	if (TP_MODALIDADE.GER_OPERACAOSVC = 4 & TP_OPERACAO.GER_OPERACAOSVC = "E"); Compra
		if ($dsUFOrigem$ = "SC") & ($dsUFDestino$ = "SC")
			if ($tpOrigemEmissao$ = 2) ; 2 - Emissao terceiro
				if ($tpRegimeOrigem$) = 2 | ($tpRegimeOrigem$ = 3);2-Simples 3-EPP
					PR_ALIQUOTA.FIS_IMPOSTOSVC = 7
				endif
			endif
		endif
	endif
	;
	if (vCdDecreto = 949) ; Este decreto foi revogado pelo decreto 6142 a partir de fevereiro/2006
		if ($dsUFOrigem$ = "PR")
			if ($tpOrigemEmissao$ = 1) ;Emissão própria
				if ($dsUFDestino$ = "PR") & ($inContribuinte$ = <TRUE>)
					vInDecreto = <TRUE>
				endif
			else
				if ($dsUFDestino$ = "PR") & ($inContribuinte$ = <TRUE>)
					vInDecreto = <TRUE>
				endif
			endif
		endif
		if (vInDecreto = <TRUE>)
			PR_BASECALC.FIS_IMPOSTOSVC	= 66.67
			vVlCalc 								= $vlTotalLiquidoICMS$ * PR_BASECALC.FIS_IMPOSTOSVC / 100
			VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
			$vlTotalLiquidoICMS$			= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
			vCdCST								= "20"
			$cdDecreto$							= vCdDecreto
		endif
	elseif (vCdDecreto = 6692) ; Este decreto é somente para o Estado do Mato Grosso do Sul (SM - 3653)
		if ($dsUFOrigem$ = "MS")
			if ($dsUFDestino$ = "MS") & ($inContribuinte$ = <TRUE>)
				vInDecreto = <TRUE>
			endif
			if (vInDecreto = <TRUE>)
				PR_BASECALC.FIS_IMPOSTOSVC	= 41.176
				vVlCalc								= $vlTotalLiquidoICMS$ * PR_BASECALC.FIS_IMPOSTOSVC / 100
				VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
				$vlTotalLiquidoICMS$			= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
				vCdCST 								= "20"
				$cdDecreto$							= vCdDecreto
			endif
		endif
	;---Elia Proj. 61/244 07/02/08
	elseif (vCdDecreto = 6142)
		if ($inOptSimples$ != <TRUE>)
			if ($dsUFOrigem$ = "PR")	
				if ($tpOrigemEmissao$ = 1) ;Emissão própria
					if ($dsUFDestino$ = "PR") & ($inContribuinte$ = <TRUE>)
						vInDecreto = <TRUE>
					endif
				else
					if ($dsUFDestino$ = "PR") & ($inContribuinte$ = <TRUE>)
						vInDecreto = <TRUE>
					endif
				endif
			endif
		endif
		if (vInDecreto = <TRUE>)
			$cdDecreto$ = vCdDecreto
		endif
	elseif (vCdDecreto = 11589) 
		if ($dsUFOrigem$ = "PR")
			if ($tpOrigemEmissao$ = 1) ;Emissão própria
				if ($dsUFDestino$ = "PR") & ($inContribuinte$ = <TRUE>)
					vInDecreto = <TRUE>
				endif
			else
				if ($dsUFDestino$ = "PR") & ($inContribuinte$ = <TRUE>)
					vInDecreto = <TRUE>
				endif
			endif
		endif
		if (vInDecreto = <TRUE>)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Decreto(11.589) não contemplado na legislação tributária do Paraná! Entrar em contato com os Analistas da área Fiscal da VirtualAge", "ADICIONAL=Operação->FISSVCO015.calculaICMS")
			return(-1)
			PR_ALIQUOTA.FIS_IMPOSTOSVC	= 12
			$cdDecreto$							= vCdDecreto
		endif
;	elseif (vCdDecreto = 48042 | vCdDecreto = 48786 | vCdDecreto = 48958 | vCdDecreto = 48959 | vCdDecreto = 49115) 
	elseif (vCdDecreto = 48786 | vCdDecreto = 48958 | vCdDecreto = 48959 | vCdDecreto = 49115) ; O decreto 48042 foi substituido pelo 55652 (01/04/2010 - Deusdete)

		if ($dsUFOrigem$ = "SP")
			if ($tpOrigemEmissao$ = 1) ;Emissão própria
				;Venda / Devolução de venda
				if (TP_OPERACAO.GER_OPERACAOSVC = "S" & TP_MODALIDADE.GER_OPERACAOSVC = 4) | (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 3)
					if ($dsUFDestino$ = "SP") & ($inContribuinte$ = <TRUE>)
						;---Elia Proj. 61/259 19/02/08
						if ($inAtivaDecreto52104$ = <TRUE>)
							vInDecreto = <TRUE>
						else
							if ($tpRegimeOrigem$) != 2 & ($tpRegimeOrigem$ != 3);2-Simples 3-EPP 
								vInDecreto = <TRUE>
							endif
						endif
					endif
					if ($inProdPropria$ = <TRUE>)
					else
						vInDecreto = <FALSE>
					endif					
				else
					if ($dsUFDestino$ = "SP") & ($inContribuinte$ = <TRUE>)
						;---Elia Proj. 61/259 19/02/08
						if ($inAtivaDecreto52104$ = <TRUE>)
							vInDecreto = <TRUE>
						else
							if ($tpRegimeOrigem$) != 2 & ($tpRegimeOrigem$ != 3);2-Simples 3-EPP 
								vInDecreto = <TRUE>
							endif
						endif
					endif
				endif
			else
				if ($dsUFDestino$ = "SP") & ($inContribuinte$ = <TRUE>)
					;---Elia Proj. 61/259 19/02/08
					if ($inAtivaDecreto52104$ = <TRUE>)
						if (vTpProduto = 0) ;Nacional
							vInDecreto = <TRUE>
						endif						
					else
						if ($tpRegimeOrigem$) != 2 & ($tpRegimeOrigem$ != 3);2-Simples 3-EPP
							if (vTpProduto = 0) ;Nacional
								vInDecreto = <TRUE>
							endif
						endif
					endif
					;
				endif
			endif
		endif
		if (vInDecreto = <TRUE>)
			if (PR_ALIQUOTA.FIS_IMPOSTOSVC != 18) & (PR_ALIQUOTA.FIS_IMPOSTOSVC != 25)
				vInDecreto = <FALSE>
			endif
		endif
		if (vInDecreto = <TRUE>)
			;---Elia Proj. 61/415 07/08/08
			if (PR_ALIQUOTA.FIS_IMPOSTOSVC = 18)
				PR_BASECALC.FIS_IMPOSTOSVC = 66.67
			else
				PR_BASECALC.FIS_IMPOSTOSVC = 48
			endif	
			vCdCST 								= "51";
			vVlCalc								= $vlTotalLiquidoICMS$ * PR_BASECALC.FIS_IMPOSTOSVC / 100
			VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
			$vlTotalLiquidoICMS$			= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
			$cdDecreto$							= vCdDecreto
		endif
	elseif (vCdDecreto = 55652) ; Este decreto substitui o 48042 (01/4/2010 - Deusdete)
		if ($dsUFOrigem$ = "SP")
			if ($tpOrigemEmissao$ = 1) ;Emissão própria
				;Venda / Devolução de venda
				if (TP_OPERACAO.GER_OPERACAOSVC = "S" & TP_MODALIDADE.GER_OPERACAOSVC = 4) | (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 3)
					if ($dsUFDestino$ = "SP") & ($inContribuinte$ = <TRUE>)
						if ($inAtivaDecreto52104$ = <TRUE>)
							vInDecreto = <TRUE>
						else
							if ($tpRegimeOrigem$) != 2 & ($tpRegimeOrigem$ != 3);2-Simples 3-EPP 
								vInDecreto = <TRUE>
							endif
						endif
					endif
					if ($inProdPropria$ = <TRUE>)
					else
						vInDecreto = <FALSE>
					endif					
				else
					if ($dsUFDestino$ = "SP") & ($inContribuinte$ = <TRUE>)
						if ($inAtivaDecreto52104$ = <TRUE>)
							vInDecreto = <TRUE>
						else
							if ($tpRegimeOrigem$) != 2 & ($tpRegimeOrigem$ != 3);2-Simples 3-EPP 
								vInDecreto = <TRUE>
							endif
						endif
					endif
				endif
			else
				if ($dsUFDestino$ = "SP") & ($inContribuinte$ = <TRUE>)
					;---Elia Proj. 61/259 19/02/08
					if ($inAtivaDecreto52104$ = <TRUE>)
						if (vTpProduto = 0) ;Nacional
							vInDecreto = <TRUE>
						endif						
					else
						if ($tpRegimeOrigem$) != 2 & ($tpRegimeOrigem$ != 3);2-Simples 3-EPP
							if (vTpProduto = 0) ;Nacional
								vInDecreto = <TRUE>
							endif
						endif
					endif
					;
				endif
			endif
		endif
		if (vInDecreto = <TRUE>)
			if (PR_ALIQUOTA.FIS_IMPOSTOSVC != 18) & (PR_ALIQUOTA.FIS_IMPOSTOSVC != 25)
				vInDecreto = <FALSE>
			endif
		endif
		if (vInDecreto = <TRUE>)
			if (PR_REDUBASE.FIS_REGRAFISCSVC > 0)
				PR_REDUBASE.FIS_IMPOSTOSVC = PR_REDUBASE.FIS_REGRAFISCSVC
				PR_BASECALC.FIS_IMPOSTOSVC = 100 - PR_REDUBASE.FIS_REGRAFISCSVC
			else
				;---Elia Proj. 61/415 07/08/08
				if (PR_ALIQUOTA.FIS_IMPOSTOSVC = 18)
					PR_BASECALC.FIS_IMPOSTOSVC = 38.89
				else
					PR_BASECALC.FIS_IMPOSTOSVC = 28
				endif	
			endif
			vCdCST								= "51";	
			vVlCalc 								= $vlTotalLiquidoICMS$ * PR_BASECALC.FIS_IMPOSTOSVC / 100
			VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
			$vlTotalLiquidoICMS$			= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
			$cdDecreto$							= vCdDecreto
		endif
	elseif (vCdDecreto = 2401)
		if ($tpOrigemEmissao$ = 1) ;Emissão própria
			;Venda / Devolução de venda
			if (TP_OPERACAO.GER_OPERACAOSVC = "S" & TP_MODALIDADE.GER_OPERACAOSVC = 4) | (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 3)
				if ($dsUFDestino$ != $dsUFOrigem$) & ($inContribuinte$ = <TRUE>)
					vInDecreto = <TRUE>
				endif
			else
				if ($dsUFDestino$ != $dsUFOrigem$) & ($inContribuinte$ = <TRUE>)
					vInDecreto = <TRUE>
				endif
			endif
		else
			if ($dsUFDestino$ != $dsUFOrigem$) & ($inContribuinte$ = <TRUE>)
				vInDecreto = <TRUE>
			endif
		endif
		if (vInDecreto = <TRUE>)
			if (PR_ALIQUOTA.FIS_IMPOSTOSVC != 7) & (PR_ALIQUOTA.FIS_IMPOSTOSVC != 12)
				vInDecreto = <FALSE>
			endif
		endif
		if (vInDecreto = <TRUE>)
			if (PR_ALIQUOTA.FIS_IMPOSTOSVC = 7)
				PR_REDUBASE.FIS_IMPOSTOSVC = 9.9
			elseif (PR_ALIQUOTA.FIS_IMPOSTOSVC = 12)
				PR_REDUBASE.FIS_IMPOSTOSVC = 10.49
			endif			
			vVlCalc 								= $vlTotalLiquidoICMS$ * PR_REDUBASE.FIS_IMPOSTOSVC / 100
			VL_BASECALC.FIS_IMPOSTOSVC	= $vlTotalLiquidoICMS$ - vVlCalc[round, 6]
			$vlTotalLiquidoICMS$			= vVlCalc[round, 6]
 			vCdCST								= "20"  ; vCdCST = "51" Alterado por Deusdete baseado nas orientações da IOB em 14/02/2006
			$cdDecreto$							= vCdDecreto
		endif
	;---Elia Proj. 61/222 15/01/08
;	elseif (vCdDecreto = 1643) ; Decreto valido para o estado do Espirito Santo
	elseif (vCdDecreto = 1643)&(($InProdPropriaDec1643$ = <false>)|($inProdPropria$ = <true>)) ; rodrigo - PRJ 170 TAR 273 - 02/06/2011

		;---Elia Proj. 61/369 06/06/08
		if ($dsUFOrigem$ = "ES") & ($dsUFDestino$ = "ES")
			if ($inContribuinte$ = <TRUE>) & (($tpRegimeOrigem$ = 2) | ($tpRegimeOrigem$ = 3)); 2-Simples 3-EPP
				PR_BASECALC.FIS_IMPOSTOSVC	= 41.177
				PR_REDUBASE.FIS_IMPOSTOSVC	= 58.823
				vInDecreto 							= <TRUE>
			elseif ($inContribuinte$ = <TRUE>) & ($tpRegimeOrigem$ != 2) & ($tpRegimeOrigem$ != 3); Empresa Normal
				if ($dsUFDestino$ != $dsUFOrigem$)
					; Conforme consulta ao IOB pelo Sr. Deusdete, nao foi confirmado esta reducao para operacao
					; interestadual
					;PR_BASECALC.FIS_IMPOSTOSVC = 58.333
					;PR_REDUBASE.FIS_IMPOSTOSVC = 41.667
					;vInDecreto = <TRUE>
				else
					PR_BASECALC.FIS_IMPOSTOSVC	= 70.589
					PR_REDUBASE.FIS_IMPOSTOSVC	= 29.411
					vInDecreto							= <TRUE>
				endif
			endif

			if (vInDecreto = <TRUE>)
				vVlCalc 								= $vlTotalLiquidoICMS$ * PR_BASECALC.FIS_IMPOSTOSVC / 100
				VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
				$vlTotalLiquidoICMS$			= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
				vCdCST								= "20"
				$cdDecreto$							= vCdDecreto
			endif
		endif
	;---Elia Proj. 61/229 29/01/08
	elseif (vCdDecreto = 44238) ; Decreto valido para o estado do Rio Grande do Sul
		if ($dsUFOrigem$ = "RS") & ($dsUFDestino$ = "RS")
			;---Elia Proj. 61/397 02/07/08
			if ($inContribuinte$ = <TRUE>) & ((TP_MODALIDADE.GER_OPERACAOSVC = 3) | (TP_MODALIDADE.GER_OPERACAOSVC = 4)); 3 - Devolucao / 4 - Venda/Compra 
				if ($tpOrigemEmissao$ = 1) ;Emissão própria
					if ($inProdPropria$ = <TRUE>)
						PR_BASECALC.FIS_IMPOSTOSVC	= 70.589
						PR_REDUBASE.FIS_IMPOSTOSVC	= 29.411
						vInDecreto							= <TRUE>
					endif
				else
					PR_BASECALC.FIS_IMPOSTOSVC	= 70.589
					PR_REDUBASE.FIS_IMPOSTOSVC	= 29.411
					vInDecreto							= <TRUE>
				endif
			endif

			if (vInDecreto = <TRUE>)
				vVlCalc 								= $vlTotalLiquidoICMS$ * PR_BASECALC.FIS_IMPOSTOSVC / 100
				VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
				$vlTotalLiquidoICMS$			= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
				vCdCST								= "20"
				$cdDecreto$							= vCdDecreto
			endif
		endif
	;---Elia Proj. 61/231 29/01/08
	elseif (vCdDecreto = 105) ; Decreto valido para o estado de Santa Catarina
		if ($dsUFOrigem$ = "SC")
			if ($dsUFDestino$ = "SC") & ($inContribuinte$ = <TRUE>) & ((TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 4) | (TP_OPERACAO.GER_OPERACAOSVC = "S" & TP_MODALIDADE.GER_OPERACAOSVC = 4));Compra / Venda
				if ($cdClasRegEspecialSC$ != "")
					clear/e "PES_PESSOACLASVC"
					CD_TIPOCLAS.PES_PESSOACLASVC = $cdClasRegEspecialSC$
					retrieve/e "PES_PESSOACLASVC"
					if ($status >= 0) & (CD_CLASSIFICACAO.PES_PESSOACLASVC = "S")
						PR_ALIQUOTA.FIS_IMPOSTOSVC	= 12
						vCdCST								= "00"
						$cdDecreto$							= vCdDecreto
						vInDecreto							= <TRUE>
					endif
				endif
			endif
		endif
	;---Elia Proj. 61/329 06/06/08
	elseif (vCdDecreto = 13214) ; Decreto valido para o estado do Paraná
		if ($dsUFOrigem$ = "PR") | ($dsUFDestino$ = "PR")
			if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; Venda/Compra
				if (PR_ALIQUOTA.FIS_IMPOSTOSVC = 7)
					PR_BASECALC.FIS_IMPOSTOSVC	= 100
					vInDecreto							= <TRUE>
				elseif (PR_ALIQUOTA.FIS_IMPOSTOSVC = 12)
					PR_BASECALC.FIS_IMPOSTOSVC	= 58.332
					PR_REDUBASE.FIS_IMPOSTOSVC	= 41.668
					vInDecreto							= <TRUE>
				elseif (PR_ALIQUOTA.FIS_IMPOSTOSVC = 18)
					PR_BASECALC.FIS_IMPOSTOSVC	= 38.887
					PR_REDUBASE.FIS_IMPOSTOSVC	= 61.113
					vInDecreto							= <TRUE>
				endif
			endif

			if (vInDecreto = <TRUE>)
				vVlCalc 								= $vlTotalLiquidoICMS$ * PR_BASECALC.FIS_IMPOSTOSVC / 100
				VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
				$vlTotalLiquidoICMS$			= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
				vCdCST								= "20"
				$cdDecreto$							= vCdDecreto
			endif
		endif
	;---Elia Proj. 61/426 07/08/08
	elseif (vCdDecreto = 12462) ; Decreto valido para o estado de Goiás
		if ($dsUFOrigem$ = "GO") & ($dsUFDestino$ = "GO")
			if ($inContribuinte$ = <TRUE>) & ((TP_MODALIDADE.GER_OPERACAOSVC = 2) | (TP_MODALIDADE.GER_OPERACAOSVC = 3) | (TP_MODALIDADE.GER_OPERACAOSVC = 4));2 - Transferencia / 3 - Devolucao / 4 - Venda/Compra  
				PR_BASECALC.FIS_IMPOSTOSVC	= 58.82
				PR_REDUBASE.FIS_IMPOSTOSVC	= 41.18
				vInDecreto							= <TRUE>
			endif

			if (vInDecreto = <TRUE>)
				vVlCalc 								= $vlTotalLiquidoICMS$ * PR_BASECALC.FIS_IMPOSTOSVC / 100
				VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
				$vlTotalLiquidoICMS$			= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
				vCdCST								= "20"
				$cdDecreto$							= vCdDecreto
			endif
		endif
	else
		$cdDecreto$ = vCdDecreto
	endif

	if (vCdCST = "00") | (vCdCST = "10")
		;---Elia Proj. 61/381 16/06/08
		if (vCdDecreto = 52364); Decreto do Estado de São Paulo
			if (PR_REDUBASE.FIS_REGRAFISCSVC > 0)
				PR_REDUBASE.FIS_IMPOSTOSVC	= PR_REDUBASE.FIS_REGRAFISCSVC
				PR_BASECALC.FIS_IMPOSTOSVC	= 100 - PR_REDUBASE.FIS_REGRAFISCSVC 
				vVlCalc								= $vlTotalLiquidoICMS$ - ($vlTotalLiquidoICMS$ * PR_REDUBASE.FIS_IMPOSTOSVC / 100)
				VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6] 
			else
				PR_BASECALC.FIS_IMPOSTOSVC	= 100
				VL_BASECALC.FIS_IMPOSTOSVC	= $vlTotalLiquidoICMS$
			endif
			VL_OUTRO.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
		;---Elia Proj. 61/383 19/06/08
		elseif (vCdDecreto = 23731) | (vCdDecreto = 23732) | (vCdDecreto = 23733) | (vCdDecreto = 23734) | (vCdDecreto = 23735); Decreto do Estado do Paraná
			if (PR_REDUBASE.FIS_REGRAFISCSVC > 0)
				PR_REDUBASE.FIS_IMPOSTOSVC	= PR_REDUBASE.FIS_REGRAFISCSVC
				PR_BASECALC.FIS_IMPOSTOSVC	= 100 - PR_REDUBASE.FIS_REGRAFISCSVC 
				vVlCalc								= $vlTotalLiquidoICMS$ - ($vlTotalLiquidoICMS$ * PR_REDUBASE.FIS_IMPOSTOSVC / 100)
				VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6] 
			else
				PR_BASECALC.FIS_IMPOSTOSVC = 100
				VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
			endif
			VL_OUTRO.FIS_IMPOSTOSVC	= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
			$vlTotalLiquidoICMS$		= VL_BASECALC.FIS_IMPOSTOSVC
		;---Elia Proj. 61/448 20/08/08
		elseif (vCdDecreto = 10901) | (vCdDecreto = 10902) | (vCdDecreto = 10903) | (vCdDecreto = 10904); Decreto do Estado de Espirito Santo
			if (PR_REDUBASE.FIS_REGRAFISCSVC > 0)
				if ($dsUFOrigem$ = "ES") & ($dsUFDestino$ = "ES")
					PR_BASECALC.FIS_IMPOSTOSVC = 100
					VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
				else
					PR_REDUBASE.FIS_IMPOSTOSVC	= PR_REDUBASE.FIS_REGRAFISCSVC
					PR_BASECALC.FIS_IMPOSTOSVC	= 100 - PR_REDUBASE.FIS_REGRAFISCSVC 
					vVlCalc 								= $vlTotalLiquidoICMS$ - ($vlTotalLiquidoICMS$ * PR_REDUBASE.FIS_IMPOSTOSVC / 100)
					VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6] 
				endif
			else
				PR_BASECALC.FIS_IMPOSTOSVC = 100
				VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
			endif
			VL_OUTRO.FIS_IMPOSTOSVC	= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
			$vlTotalLiquidoICMS$		= VL_BASECALC.FIS_IMPOSTOSVC
		;
		else
			PR_BASECALC.FIS_IMPOSTOSVC = 100
			VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
			;-- MAD [Proj/Tar.170/227] - 01/04/2011
			;if ($cdDecreto$ = 1643) | ($cdDecreto$ = 56066)
			if (($cdDecreto$ = 1643)&(($InProdPropriaDec1643$ = <false>)|($inProdPropria$ = <true>))) | ($cdDecreto$ = 56066); rodrigo - PRJ 170 TAR 273 - 02/06/2011
				$cdDecreto$ = ""
				vInDecreto  = <FALSE>
			endif
			;;
		endif
		;Quando for substituiçao tributária não contemplada(CST 00) para não contribuinte não é aplicado o decreto
		if (vCdCST = "00") & (CD_CST.FIS_REGRAFISCSVC = "10" | CD_CST.FIS_REGRAFISCSVC = "60" | CD_CST.FIS_REGRAFISCSVC = "70")
			$cdDecreto$ = ""
		endif
		;---Elia Proj. 061/629 30/06/09
		;;---Elia Proj. 061/610 12/06/09
		;if (vCdCST = "10") & ((TP_OPERACAO.GER_OPERACAOSVC = "E")
		if (vCdCST = "10") & (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC != 3) ; Entrada e não for devolução
		;
			if (VL_BASECALC.FIS_IMPOSTOSVC > 0)
				vVlCalc	= VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
				$vlICMS$	= vVlCalc[round, 6]
			endif
			VL_OUTRO.FIS_IMPOSTOSVC    = VL_OUTRO.FIS_IMPOSTOSVC + VL_BASECALC.FIS_IMPOSTOSVC
			VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
			VL_BASECALC.FIS_IMPOSTOSVC = 0
			PR_BASECALC.FIS_IMPOSTOSVC = 0
			PR_REDUBASE.FIS_IMPOSTOSVC = 0
		endif
		;
	;>-- MAC - PRJ 175/003 - 08/11/2010 ---
	; Acrescentado a CST 030
	;elseif (vCdCST = "20") | (vCdCST = "70")
	elseif (vCdCST = "20") | (vCdCST = "70") | (vCdCST = "30")
	;--<
		if (vInDecreto = <TRUE>)
			;---Elia Proj. 61/426 07/08/08
			;-- MAD [Proj/Tar.061/718] - 26/11/2009
			;if (vCdDecreto = 12462)
;			if (vCdDecreto = 12462) | (vCdDecreto = 1643)
			if (vCdDecreto = 12462) | ((vCdDecreto = 1643)&(($InProdPropriaDec1643$ = <false>)|($inProdPropria$ = <true>))) ; rodrigo - PRJ 170 TAR 273 - 02/06/2011
			;;
				VL_ISENTO.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
			else
				VL_OUTRO.FIS_IMPOSTOSVC  = $vlTotalLiquidoICMS$
			endif
		else
			;>-- MAC - PRJ 156 / 460 - 04/11/2010 ---
			;if (PR_REDUBASE.FIS_REGRAFISCSVC > 0)
			; Validação do cliente como contribuinte primeiramente
			vInReducao = <FALSE>
			if (PR_REDUBASE.FIS_REGRAFISCSVC > 0 & $inContribuinte$ = <TRUE>)
				if (TP_OPERACAO.GER_OPERACAOSVC = "S")
					;-- MAD [Proj/Tar.175/182] - 14/07/2011
					;if ($inProdPropria$ = <TRUE>) | (CD_CFOPPROPRIA.FIS_REGRAFISCSVC = 5551) | (TP_MODALIDADE.GER_OPERACAOSVC = "3") | %\
					;	($tpOrigemEmissao$ = 1 & $dsUFOrigem$ = "RS") ;-- MAD [Proj/Tar.175/129] - 27/04/2011
					;
					if ($inRedBaseIcms$ = <TRUE> & $inProdPropria$ = <TRUE>) | ($inRedBaseIcms$ = <FALSE>) | (CD_CFOPPROPRIA.FIS_REGRAFISCSVC = 5551) | %\
						(TP_MODALIDADE.GER_OPERACAOSVC = "3") | ($tpOrigemEmissao$ = 1 & $dsUFOrigem$ = "RS") 
					;;
						vInReducao = <TRUE>
						vCdDecreto = CD_DECRETO.FIS_DECRETOSVC
						vInDecreto = <TRUE>
					else
						vCdDecreto = ""
						vInDecreto = <FALSE>
					endif
				else
					;-- MAD [Proj/Tar.175/182] - 14/07/2011
					;if (TP_MODALIDADE.GER_OPERACAOSVC != "3" | (TP_MODALIDADE.GER_OPERACAOSVC = "3" & $inProdPropria$ = <TRUE>)) | %\
					;	($tpOrigemEmissao$ = 2 & $dsUFDestino$ = "RS") ;-- MAD [Proj/Tar.175/129] - 27/04/2011
					;
					if (TP_MODALIDADE.GER_OPERACAOSVC != "3" | (TP_MODALIDADE.GER_OPERACAOSVC = "3" & ($inRedBaseIcms$ = <TRUE> & $inProdPropria$ = <TRUE>) | ($inRedBaseIcms$ = <FALSE>))) | %\
						($tpOrigemEmissao$ = 2 & $dsUFDestino$ = "RS")
					;;
						vInReducao = <TRUE>
						vCdDecreto = CD_DECRETO.FIS_DECRETOSVC
						vInDecreto = <TRUE>
					else
						vCdDecreto = ""
						vInDecreto = <FALSE>
					endif
				endif
			else
				vCdDecreto = ""
				vInDecreto = <FALSE>
			endif

			if (vInReducao = <TRUE>)
			;--<
				;-- MAD [Proj/Tar.061/790] - 05/04/2010
				vInPrRedBase    = <FALSE>
				vInPrRedImposto = <FALSE>

				if ($inContribuinte$ = <TRUE>)
					if (TP_REDUCAO.FIS_REGRAFISCSVC = "A")
						if ($dsUFOrigem$ = $dsUFDestino$)
							vInPrRedBase	= <TRUE>
							$cdDecreto$		= vCdDecreto
						endif

					elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "B")
						if ($dsUFOrigem$ = $dsUFDestino$)
							vInPrRedImposto	= <TRUE>
							$cdDecreto$			= vCdDecreto
						endif

					elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "C")
						if ($dsUFOrigem$ = $dsUFDestino$)
							vInPrRedBase		= <TRUE>
							vInPrRedImposto	= <TRUE>
							$cdDecreto$			= vCdDecreto
						endif

					elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "D")
						if ($dsUFOrigem$ != $dsUFDestino$)
							vInPrRedBase	= <TRUE>
							$cdDecreto$		= vCdDecreto
						endif

					elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "E")
						if ($dsUFOrigem$ != $dsUFDestino$)
							vInPrRedImposto	= <TRUE>
							$cdDecreto$			= vCdDecreto
						endif

					elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "F")
						if ($dsUFOrigem$ != $dsUFDestino$)
							vInPrRedBase		= <TRUE>
							vInPrRedImposto	= <TRUE>
							$cdDecreto$			= vCdDecreto
						endif

					elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "G")
						vInPrRedBase	= <TRUE>
						$cdDecreto$		= vCdDecreto

					elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "H")
						vInPrRedImposto	= <TRUE>
						$cdDecreto$			= vCdDecreto

					elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "I")
						vInPrRedBase   	= <TRUE>
						vInPrRedImposto	= <TRUE>
						$cdDecreto$			= vCdDecreto
					endif
				else
					vInPrRedBase    = <TRUE>
					vInPrRedImposto = <TRUE>
				endif

				if (vInPrRedBase != <TRUE>) & ($cdDecreto$ != 6142)
					PR_REDUBASE.FIS_IMPOSTOSVC	= 0
					PR_BASECALC.FIS_IMPOSTOSVC	= 100
					vVlCalc 								= $vlTotalLiquidoICMS$ - ($vlTotalLiquidoICMS$ * PR_REDUBASE.FIS_IMPOSTOSVC / 100)
					VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
					$cdDecreto$							= ""
					vInDecreto							= <FALSE>
				else
				;;
					PR_REDUBASE.FIS_IMPOSTOSVC	= PR_REDUBASE.FIS_REGRAFISCSVC
					PR_BASECALC.FIS_IMPOSTOSVC	= 100 - PR_REDUBASE.FIS_REGRAFISCSVC ;---Elia Proj. 61/381 16/06/08
					vVlCalc								= $vlTotalLiquidoICMS$ - ($vlTotalLiquidoICMS$ * PR_REDUBASE.FIS_IMPOSTOSVC / 100)
					VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
				endif

			else
				vCdCST 								= "00" ;-- MAD [Proj/Tar.061/849] - 11/08/2010
				PR_BASECALC.FIS_IMPOSTOSVC	= 100
				VL_BASECALC.FIS_IMPOSTOSVC	= $vlTotalLiquidoICMS$
				;-- MAD [Proj/Tar.170/227] - 01/04/2011
				if (($cdDecreto$ = 1643)&(($InProdPropriaDec1643$ = <false>)|($inProdPropria$ = <true>))) | ($cdDecreto$ = 56066) ; rodrigo - PRJ 170 TAR 273 - 02/06/2011
					$cdDecreto$ = ""
					vInDecreto  = <FALSE>
				endif
				;;
			endif
			VL_OUTRO.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC
		endif
		;---Elia Proj. 061/610 12/06/09
		;>-- MAC - PRJ 175/003 - 08/11/2010 ---
		; Alteração da rotina de calculo do ICMS próprio para CST 070 e 030 na saída para Empresa Simples
		;if (vCdCST = "70") & (TP_OPERACAO.GER_OPERACAOSVC = "E")
		if (vCdCST = "30") | (vCdCST = "70")
			if (TP_OPERACAO.GER_OPERACAOSVC = "E") | ((TP_OPERACAO.GER_OPERACAOSVC = "S") & ($inOptSimples$ = <TRUE>))
				if (VL_BASECALC.FIS_IMPOSTOSVC > 0)
					vVlCalc = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
					$vlICMS$ = vVlCalc[round, 6]
				endif
				;if (vInReducao = <TRUE>)
				;	$vlTotalLiquidoICMS$ = VL_BASECALC.FIS_IMPOSTOSVC
				;endif
				VL_OUTRO.FIS_IMPOSTOSVC    = VL_OUTRO.FIS_IMPOSTOSVC + VL_BASECALC.FIS_IMPOSTOSVC
				VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
				VL_BASECALC.FIS_IMPOSTOSVC = 0
				PR_BASECALC.FIS_IMPOSTOSVC = 0
				PR_REDUBASE.FIS_IMPOSTOSVC = 0
			endif
		endif
		if (vCdCST = "30") & ($inOptSimples$ = <FALSE>)
			$vlTotalLiquidoICMS$	= VL_OUTRO.FIS_IMPOSTOSVC + VL_BASECALC.FIS_IMPOSTOSVC
			vVlCalc						= $vlTotalLiquidoICMS$ * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
			$vlICMS$						= vVlCalc[round, 6]
			discard "FIS_IMPOSTOSVC"
			return(0)
		endif
		;--<
		;
	elseif (vCdCST = "40") | (vCdCST = "41")
		PR_ALIQUOTA.FIS_IMPOSTOSVC	= 0
		VL_ISENTO.FIS_IMPOSTOSVC		= $vlTotalLiquidoICMS$
	elseif (vCdCST = "50")
		PR_ALIQUOTA.FIS_IMPOSTOSVC	= 0
		VL_OUTRO.FIS_IMPOSTOSVC		= $vlTotalLiquidoICMS$
	elseif (vCdCST = "51")
		if (vInDecreto = <TRUE>) 
			VL_OUTRO.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
		else
			if (PR_REDUBASE.FIS_REGRAFISCSVC > 0)
				PR_REDUBASE.FIS_IMPOSTOSVC	= PR_REDUBASE.FIS_REGRAFISCSVC
				vVlCalc								= $vlTotalLiquidoICMS$ - ($vlTotalLiquidoICMS$ * PR_REDUBASE.FIS_IMPOSTOSVC / 100)
				VL_BASECALC.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
				VL_OUTRO.FIS_IMPOSTOSVC		= $vlTotalLiquidoICMS$ - VL_BASECALC.FIS_IMPOSTOSVC					
			else
				;---Elia Proj. 61/513 19/11/08
				VL_OUTRO.FIS_IMPOSTOSVC		= $vlTotalLiquidoICMS$
				PR_ALIQUOTA.FIS_IMPOSTOSVC	= 0
				PR_BASECALC.FIS_IMPOSTOSVC	= 100
				;
			endif
		endif
	;---Elia Proj. 61/276 14/03/08
	elseif (vCdCST = "60")
		if (vInDecreto = <TRUE>)
			PR_BASECALC.FIS_IMPOSTOSVC = 100
			VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
		endif
	else
		VL_OUTRO.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
	endif
	;---Elia Proj. 61/206 27/11/07	
	; Move a base de calculo para outros quando for entrada de fornecedor optante pelo simples
	if ($tpOrigemEmissao$ = 2 & TP_MODALIDADE.GER_OPERACAOSVC != 3)
		;---Elia Proj. 61/392 04/07/08 exclusao do estado de SC
		if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "MG") | ($dsUFOrigem$ = "SP") | ($dsUFOrigem$ = "RJ") | ($dsUFOrigem$ = "CE") | ($dsUFOrigem$ = "RS") ;---Elia Proj. 61/275 10/03/08 - Incluisao do RS
			if ($tpRegimeOrigem$) = 2 | ($tpRegimeOrigem$ = 3);2-Simples 3-EPP
				VL_OUTRO.FIS_IMPOSTOSVC		= VL_OUTRO.FIS_IMPOSTOSVC + VL_BASECALC.FIS_IMPOSTOSVC
				VL_BASECALC.FIS_IMPOSTOSVC	= 0 
			endif
		endif
	endif
	;

	;Origem estrangeira - importacão direta
	if (VL_BASECALC.FIS_IMPOSTOSVC > 0) & (vTpProduto = 1) 
		;---Elia Proj. 061/572 24/03/09
		if (TP_OPERACAO.GER_OPERACAOSVC = "S") | (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 3) | (TP_MODALIDADE.GER_OPERACAOSVC = "C") ; Saída ou entrada por devolução ou C - Consignacao
			if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>)
				VL_BASECALC.FIS_IMPOSTOSVC = VL_BASECALC.FIS_IMPOSTOSVC + $vlIPI$
			endif
		else			
			VL_BASECALC.FIS_IMPOSTOSVC = VL_BASECALC.FIS_IMPOSTOSVC + $vlIPI$
		endif
	endif
	;

	if (VL_BASECALC.FIS_IMPOSTOSVC > 0)
		vVlCalc 							= VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
		VL_IMPOSTO.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
	else
		VL_IMPOSTO.FIS_IMPOSTOSVC = 0
	endif

	if ($cdDecreto$ = 6142) 
		vVlCalc 							= VL_IMPOSTO.FIS_IMPOSTOSVC * 66.67 / 100
		VL_IMPOSTO.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
	else
		;-- MAD [Proj/Tar.061/790] - 05/04/2010
		if (vInPrRedImposto = <TRUE>) & (PR_REDUBASE.FIS_REGRAFISCSVC > 0)
			if (TP_REDUCAO.FIS_REGRAFISCSVC = "B" | TP_REDUCAO.FIS_REGRAFISCSVC = "E" | TP_REDUCAO.FIS_REGRAFISCSVC = "H")
				vVlCalc							= (VL_BASECALC.FIS_IMPOSTOSVC * ((100 - PR_REDUBASE.FIS_REGRAFISCSVC)/100) * PR_ALIQUOTA.FIS_IMPOSTOSVC) / 100
				VL_IMPOSTO.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
				$cdDecreto$						= vCdDecreto
			endif

			if (TP_REDUCAO.FIS_REGRAFISCSVC = "C" | TP_REDUCAO.FIS_REGRAFISCSVC = "F" | TP_REDUCAO.FIS_REGRAFISCSVC = "I")
				vVlCalc							= (VL_IMPOSTO.FIS_IMPOSTOSVC * (100 - PR_REDUBASE.FIS_REGRAFISCSVC)) / 100
				VL_IMPOSTO.FIS_IMPOSTOSVC	= vVlCalc[round, 6]
				$cdDecreto$						= vCdDecreto
			endif
		endif
		;;
	endif

	;-- MAD [Proj/Tar.175/143] - 17/05/2011
	;if ($TpModDctoFiscal$ = 85) ; Implementado por Deusdete em 20/04/2007, zerar qdo for complemento de ICMS / CIAP
	if ($TpModDctoFiscal$ = 85) | ($TpModDctoFiscal$ = 87)
	;;
		VL_IMPOSTO.FIS_IMPOSTOSVC  = VL_BASECALC.FIS_IMPOSTOSVC
		VL_BASECALC.FIS_IMPOSTOSVC = 0
		PR_REDUBASE.FIS_IMPOSTOSVC = 0
		PR_BASECALC.FIS_IMPOSTOSVC = 0
		PR_ALIQUOTA.FIS_IMPOSTOSVC = 0	
		VL_OUTRO.FIS_IMPOSTOSVC    = 0
		VL_ISENTO.FIS_IMPOSTOSVC   = 0
	endif

	if ($vlICMS$ = 0)
		$vlICMS$ = VL_IMPOSTO.FIS_IMPOSTOSVC
	endif

	$cdCST$ = "%%$cdCST$[1, 1]%%vCdCST"

;  	========= CFC: Tar. 189 pj. 61 05/11/2007 - Zerar a alíquota se o CST=90 e o valor do ICMS for zero.
	if (vCdCST = "90") & ($vlICMS$ = 0)
		PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
	endif

;	============ CFC: Tar. 192 Pj. 61  09/11/2007 - Se a capa tiver Imposto sobre o Frete/Seguro/Desp.Acessoria será zerado o valor da Base de Calculo e jogado para o Vl.Outros.
	if (vCdCST = "90") & (($vlFrete$ > 0) | ($vlSeguro$ > 0) | ($vlDespAcessor$ > 0)) & ($vlICMS$ > 0)
		VL_OUTRO.FIS_IMPOSTOSVC    = VL_BASECALC.FIS_IMPOSTOSVC
		VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
		PR_BASECALC.FIS_IMPOSTOSVC = 0
		VL_BASECALC.FIS_IMPOSTOSVC = 0
		PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
	endif
;	============

	return(0)

end ;calculaICMS

;----------------------
entry calculaICMSSubst
;----------------------

	variables
		string  vCdCST, vPrIVA, viParams, voParams, vTpOperacao
		numeric vVlCalc, vVlBaseCalc, vVlICMS, vTpProduto, vCdDecreto, vVlAliquotaInter, vVlAliquotaIntra, vCdCFOP
		numeric vPrIvaPrd, vPrICMS, vVlAliquotaDestino, vVlAliquotaOrigem
		boolean vInDecreto, vInCalcula
		date    vDtSistema, vDtIniVigencia, vDtFimVigencia
	endvariables

	if ($inImpostoOffLine$ = <TRUE>)
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif

	vDtSistema	= $item("DT_SISTEMA", $xlpg$)
	vTpProduto	= $cdCST$[1 : 1]
	vCdCST		= $cdCST$[2 : 2]
	vTpOperacao	= TP_OPERACAO.GER_OPERACAOSVC

	;-- MAD [Proj/Tar.061/723] - 02/12/2009
	;;---Elia Proj. 61/597 03/06/09
	;if ($inContribuinte$ = <TRUE>) & (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) & (vCdCST = "10")
	;	discard "FIS_IMPOSTOSVC"
	;	return(0)
	;endif
	;;

	;---Elia Proj. 61/276 04/04/08
	if (vCdCST != "10") & (vCdCST != "30") & (vCdCST != "60") & (vCdCST != "70")
		if ($cdDecreto$ = 2155) | ($cdDecreto$ = 1020) | ($cdDecreto$ = 45471) | ($cdDecreto$ = 23731) | %\
		   ($cdDecreto$ = 23732) | ($cdDecreto$ = 23733) | ($cdDecreto$ = 23734) | ($cdDecreto$ = 23735) | %\
			($cdDecreto$ = 10201) | ($cdDecreto$ = 10202) | ($cdDecreto$ = 10203);ANO Pjt91 Trf310 - 08/01/2009
			$cdDecreto$ = ""
		endif	
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif
	;
	$cdDecreto$ = ""
	vCdDecreto = ""
	vInDecreto = <FALSE>

	;---Elia Proj. 61/276 17/03/08
	if ($cdDecretoItemCapa$ != 0)
		clear/e "F_FIS_DECRETOSVC"
		CD_DECRETO.F_FIS_DECRETOSVC/init = $cdDecretoItemCapa$
		retrieve/e "F_FIS_DECRETOSVC"
		if ($status >= 0)
			vCdDecreto     = CD_DECRETO.F_FIS_DECRETOSVC
			vDtIniVigencia = DT_INIVIGENCIA.F_FIS_DECRETOSVC
			vDtFimVigencia = DT_FIMVIGENCIA.F_FIS_DECRETOSVC
		endif
	else
		if (CD_DECRETO.FIS_DECRETOSVC > 0)
			vCdDecreto     = CD_DECRETO.FIS_DECRETOSVC
			vDtIniVigencia = DT_INIVIGENCIA.FIS_DECRETOSVC
			vDtFimVigencia = DT_FIMVIGENCIA.FIS_DECRETOSVC
		endif
	endif

	if (vCdDecreto > 0)
		if (vDtIniVigencia != "") & (vDtSistema < vDtIniVigencia)
			vCdDecreto = ""
		endif
		if (vDtFimVigencia != "") & (vDtSistema > vDtFimVigencia)
			vCdDecreto = ""
		endif
	endif
	;
	;A alíquota diferencia so pode se aplicada em NF estadual
	;Nas outra é obrigatorio respeitar a aliquota interestadual
	if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0) & ($dsUFOrigem$ = $dsUFDestino$)
		PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
	;else --- Alterado por Deusdete em caráter de urgência com anuência do Eliã (10/06/2009)
	elseif (vCdDecreto != "")
		;---Elia Proj. 061/571 09/04/09 - Acha aliquota interna da UF destino
		;PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
		clear/e "FIS_ALIQUOTAISVC"
		CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$
		CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
		retrieve/e "FIS_ALIQUOTAISVC"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
			return(-1)
		endif
		PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
	endif

	vPrIVA = 30

	;Emissão de terceiro e diferente de devolucao ou devolução de compra com emissão própria
	if ($tpOrigemEmissao$ = 2 & TP_MODALIDADE.GER_OPERACAOSVC != 3) | ($tpOrigemEmissao$ = 1 & TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S")
		if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "SC") | ($dsUFOrigem$ = "MG") | ($dsUFOrigem$ = "SP") | ($dsUFOrigem$ = "RJ") | ($dsUFOrigem$ = "CE")
			if ($tpRegimeOrigem$) = 2 | ($tpRegimeOrigem$ = 3);2-Simples 3-EPP
				PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
			endif
		endif
		if ($tpOrigemEmissao$ = 1)
			;-- MAD [Proj/Tar.170/050] - 09/09/2010
			;if ($inOptSimples$ = <TRUE>)
			;	PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
			;endif
			;;
		endif
	else
		;-- MAD [Proj/Tar.170/050] - 09/09/2010
		;if ($inOptSimples$ = <TRUE>)
		;	PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
		;endif
		;;
	endif

	;---Elia Proj. 61/276 17/03/08
	if (vCdDecreto = 2155) ; Decreto do Estado do Parana
		;---Elia Proj. 61/359 28/05/08
		if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "RS") | ($dsUFOrigem$ = "SC")
			if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; 4 - Venda/Compra
				if ($dsUFDestino$ = "PR") | ($dsUFDestino$ = "RS") | ($dsUFDestino$ = "SC")
					vPrIVA     = 65.86
					vInDecreto = <TRUE>
				endif
			endif
		endif

		if (vInDecreto = <TRUE>)
			;---Elia Proj. 061/578 09/04/09
			if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0) & ($dsUFOrigem$ = "PR") & ($dsUFDestino$ = "PR")
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
			else
				;---Acha aliquota interna da UF destino
				clear/e "FIS_ALIQUOTAISVC"
				CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$
				CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
				retrieve/e "FIS_ALIQUOTAISVC"
				if ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
					return(-1)
				endif
				;
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
			endif
			;
					
			vVlCalc                    = $vlTotalLiquidoICMS$ + $vlIPI$ + (($vlTotalLiquidoICMS$ + $vlIPI$) * vPrIVA) / 100 
			VL_BASECALC.FIS_IMPOSTOSVC = vVlCalc[round, 6]
			PR_BASECALC.FIS_IMPOSTOSVC = 100

			vVlCalc                   = VL_BASECALC.FIS_IMPOSTOSVC * (PR_ALIQUOTA.FIS_IMPOSTOSVC / 100)
			vVlICMS                   = vVlCalc[round, 6] 
			VL_IMPOSTO.FIS_IMPOSTOSVC = vVlICMS - $vlICMS$
			$cdDecreto$               = vCdDecreto
		endif
	;---Elia Proj. 61/315 22/04/08  ;ANO Pjt91 Trf310 - 08/01/2009
	elseif (vCdDecreto = 1020 | vCdDecreto = 10201 | vCdDecreto = 10202 | vCdDecreto = 10203) ; Decreto do Estado de Santa Catarina ;arley
		;---Elia Proj. 61/359 28/05/08
		;if ($dsUFOrigem$ = "SC")
		;---Elia Proj. 91/336 02/02/09
		if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "SC") | ($dsUFOrigem$ = "MG") ;Incluído o Estado de MG SM 31977 Tarefa 61 - 880 (Deusdete)
			if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; 4 - Venda/Compra
				;---Elia Proj. 91/336 02/02/09
				;if ($dsUFOrigem$ = "SC") | ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "RS")
				;---MFGALEGO 05/02/09
				;if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "SC")
				if ($dsUFDestino$ = "PR") | ($dsUFDestino$ = "SC") | ($dsUFDestino$ = "MG") ;Incluído o Estado de MG SM 31977 Tarefa 61 - 880 (Deusdete)
					;thamati 19/10/2010 [Proj. 0061 - Tar. 0885]
;					;=== ANO Pjt91 Trf310 - 08/01/2009
;					if (vCdDecreto = 1020 )
;						vPrIVA = 65.86	
;					elseif (vCdDecreto = 10201)
;						;vPrIVA = 59.26	; Percentual alterado Conf. Prot. ICMS 73/09
;						vPrIVA = 62.99	
;					elseif (vCdDecreto = 10202)
;						vPrIVA = 37.78	
;					elseif (vCdDecreto = 10203)
;						if ($dsUFOrigem$ = $dsUFDestino$)
;							vPrIVA = 41.34	
;						else
;							vPrIVA = 49.86	
;						endif
;					endif
;					;==================================
					if (vCdDecreto = 1020 )
						vPrIVA = 65.86	
						if ($dsUFDestino$ = "SC") & ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3) ;2-Simples 3-EPP
							vPrIVA = 19.758
						endif
					elseif (vCdDecreto = 10201)
						vPrIVA = 62.99	
						if ($dsUFDestino$ = "SC") & ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)
							vPrIVA = 18.897	
						endif
					elseif (vCdDecreto = 10202)
						vPrIVA = 37.78	
						if ($dsUFDestino$ = "SC") & ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)
							vPrIVA = 11.334	
						endif
					elseif (vCdDecreto = 10203)
						if ($dsUFOrigem$ = $dsUFDestino$)
							vPrIVA = 41.34	
							if ($dsUFDestino$ = "SC") & ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)
								vPrIVA = 12.402	
							endif
						else
							vPrIVA = 49.86	
							if ($dsUFDestino$ = "SC") & ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)
								vPrIVA = 14.958
							endif
						endif
					endif
				;
					vInDecreto = <TRUE>
				endif
			endif
		endif

		if (vInDecreto = <TRUE>)
			;-- MAD [Proj/Tar.061/912] - 17/12/2010
			clear/e "FIS_ALIQUOTAISVC"
			CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFOrigem$
			CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
			retrieve/e "FIS_ALIQUOTAISVC"
			if ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
				return(-1)
			endif
			vVlAliquotaInter = PR_ALIQICMS.FIS_ALIQUOTAISVC
			;;
			;-- MAD [Proj/Tar.175/112] - 06/04/2011
			viParams = ""
			putitem/id viParams, "CD_PRODUTO" , CD_PRODUTO.PRD_PRODUTOSVC
			putitem/id viParams, "UF_ORIGEM"  , $dsUFOrigem$
			putitem/id viParams, "UF_DESTINO" , $dsUFDestino$
			putitem/id viParams, "TP_OPERACAO", vTpOperacao
			activate "FISSVCO035".buscaDadosFiscalProduto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			vVlAliquotaIntra = $item("PR_ICMS", voParams)	

			if (vVlAliquotaIntra = 0)
			;;
				;---Acha aliquota interna da UF destino
				clear/e "FIS_ALIQUOTAISVC"
				CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$
				CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
				retrieve/e "FIS_ALIQUOTAISVC"
				if ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
					return(-1)
				endif
				vVlAliquotaIntra = PR_ALIQICMS.FIS_ALIQUOTAISVC
			endif
			;-- MAD [Proj/Tar.061/912] - 17/12/2010
			if ($dsUFDestino$ != $dsUFOrigem$)
				vPrIVA = ((1 + (vPrIVA/100)) * ((1 - (vVlAliquotaInter/100)) / (1 - (vVlAliquotaIntra/100))) -1) * 100
			endif
			;;	
			;---Elia Proj. 91/313 16/01/09
			if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0)
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
			else
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
			endif
			;
			;---Elia Proj. 91/313 16/01/09
			;vVlCalc = $vlTotalLiquidoICMS$ + $vlIPI$ + (($vlTotalLiquidoICMS$ + $vlIPI$) * vPrIVA) / 100 
			;VL_BASECALC.FIS_IMPOSTOSVC = vVlCalc[round, 6]
			;PR_BASECALC.FIS_IMPOSTOSVC = 100
			;PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
			;vVlCalc = VL_BASECALC.FIS_IMPOSTOSVC * (PR_ALIQUOTA.FIS_IMPOSTOSVC / 100)
			;vVlICMS = vVlCalc[round, 6] 
			;---Elia Proj. 91/336 02/02/09
			vVlCalc                    = $vlTotalLiquidoICMS$ + $vlIPI$ + (($vlTotalLiquidoICMS$ + $vlIPI$) * vPrIVA) / 100
			VL_BASECALC.FIS_IMPOSTOSVC = vVlCalc[round, 6]
			PR_BASECALC.FIS_IMPOSTOSVC = 100
			vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * (PR_ALIQUOTA.FIS_IMPOSTOSVC / 100)
			vVlICMS                    = vVlCalc[round, 6] 
			VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlICMS - $vlICMS$
			$cdDecreto$                = vCdDecreto
		endif
	elseif (vCdDecreto = 45471) ; Decreto do Estado do Rio Grande do Sul
		;---Elia Proj. 61/359 28/05/08
		if ($dsUFOrigem$ = "RS") | ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "SC")
			if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4); 4 - Venda/Compra
		;
				if ($dsUFDestino$ = "PR") | ($dsUFDestino$ = "RS")  | ($dsUFDestino$ = "SC")
					vPrIVA     = 65.86
					vInDecreto = <TRUE>
				endif
			endif
		endif

		if (vInDecreto = <TRUE>)
			;---Acha aliquota interna da UF destino
			clear/e "FIS_ALIQUOTAISVC"
			CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$
			CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
			retrieve/e "FIS_ALIQUOTAISVC"
			if ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
				return(-1)
			endif
			;
			vVlCalc                    = $vlTotalLiquidoICMS$ + $vlIPI$ + (($vlTotalLiquidoICMS$ + $vlIPI$) * vPrIVA) / 100 
			VL_BASECALC.FIS_IMPOSTOSVC = vVlCalc[round, 6]
			PR_BASECALC.FIS_IMPOSTOSVC = 100
			vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * (PR_ALIQICMS.FIS_ALIQUOTAISVC / 100)
			vVlICMS                    = vVlCalc[round, 6] 
			PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
			VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlICMS - $vlICMS$
			$cdDecreto$                = vCdDecreto
		endif
	;---Elia Proj. 61/348 26/05/08
	elseif (vCdDecreto = 52364); Decreto do Estado de São Paulo
		if ($dsUFOrigem$ = "SP") | ($dsUFDestino$ = "SP")
			;---Elia Proj. 61/411 04/08/08
			if (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 4) | (TP_OPERACAO.GER_OPERACAOSVC = "S" & TP_MODALIDADE.GER_OPERACAOSVC = 3); 4 - Compra / 3 - Devolução
				;---Aliquota aplicada pelo Fornecedor
				clear/e "FIS_ALIQUOTAISVC"
				CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFOrigem$
				CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
				retrieve/e "FIS_ALIQUOTAISVC"
				if ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
					return(-1)
				endif

				; Aliquota interna de SP
				if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0)
					vVlAliquotaIntra = PR_ALIQICMS.FIS_REGRAFISCSVC 
				else
					vVlAliquotaIntra = PR_ALIQICMS.FIS_ALIQUOTAISVC
				endif
				vVlAliquotaInter = PR_ALIQICMS.FIS_ALIQUOTAISVC ; Aliquota aplicada pelo Fornecedor

				if (PR_ALIQUOTA.FIS_IMPOSTOSVC = 12) | (PR_ALIQUOTA.FIS_IMPOSTOSVC = 18)
					if ($dsUFOrigem$ = "SP") & ($dsUFDestino$ = "SP")
						vPrIVA = 38.90 
					else
						vPrIVA = ((1 + (38.90/100)) * ((1 - (vVlAliquotaInter/100)) / (1 - (vVlAliquotaIntra/100))) -1) * 100
					endif
					vInDecreto = <TRUE>
				elseif (PR_ALIQUOTA.FIS_IMPOSTOSVC = 25)
					if ($dsUFOrigem$ = "SP") & ($dsUFDestino$ = "SP")
						vPrIVA = 71.60 
					else
						vPrIVA = ((1 + (71.60/100)) * ((1 - (vVlAliquotaInter/100)) / (1 - (vVlAliquotaIntra/100))) -1) * 100
					endif
					vInDecreto = <TRUE>
				endif
			endif
		endif

		if (vInDecreto = <TRUE>)
			vVlCalc                    = $vlTotalLiquidoICMS$ + $vlIPI$ + (($vlTotalLiquidoICMS$ + $vlIPI$) * vPrIVA) / 100 
			VL_BASECALC.FIS_IMPOSTOSVC = vVlCalc[round, 6]
			PR_BASECALC.FIS_IMPOSTOSVC = 100		
			vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * (vVlAliquotaIntra / 100)
			vVlICMS                    = vVlCalc[round, 6] 
			PR_ALIQUOTA.FIS_IMPOSTOSVC = vVlAliquotaIntra
			VL_IMPOSTO.FIS_IMPOSTOSVC  = ($vlTotalLiquidoICMS$ + $vlIPI$) * (1 + (vPrIVA / 100)) * (vVlAliquotaIntra/100) - $vlICMS$	
			$cdDecreto$                = vCdDecreto
		endif
	;---Elia Proj. 61/363 03/06/08
	elseif (vCdDecreto = 23731) | (vCdDecreto = 23732) | (vCdDecreto = 23733) | (vCdDecreto = 23734) | (vCdDecreto = 23735); Decreto do Estado do Paraná
		if ($dsUFOrigem$ = "PR") | ($dsUFDestino$ = "PR")
			if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; 4 - Venda/Compra
				if (vCdDecreto = 23731)
					vPrIVA     = 59.26
					vInDecreto = <TRUE>
				elseif (vCdDecreto = 23732)
					vPrIVA     = 37.78
					vInDecreto = <TRUE>
				elseif (vCdDecreto = 23733)
					if ($dsUFOrigem$ = $dsUFDestino$)
						vPrIVA = 41.34
					else
						vPrIVA = 49.86
					endif
					vInDecreto = <TRUE>
				elseif (vCdDecreto = 23734)
					if ($dsUFOrigem$ = $dsUFDestino$)
						vPrIVA = 33.05
					else
						vPrIVA = 41.06
					endif
					vInDecreto = <TRUE>
				elseif (vCdDecreto = 23735)
					if ($dsUFOrigem$ = $dsUFDestino$)
						vPrIVA = 38.24
					else
						vPrIVA = 46.56
					endif
					vInDecreto = <TRUE>
				endif
			endif
		endif

		if (vInDecreto = <TRUE>)
			;---Elia Proj. 061/578 09/04/09
			if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0) & ($dsUFOrigem$ = "PR") & ($dsUFDestino$ = "PR")
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_REGRAFISCSVC
			else
				;---Acha aliquota interna da UF destino
				clear/e "FIS_ALIQUOTAISVC"
				CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$
				CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
				retrieve/e "FIS_ALIQUOTAISVC"
				if ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
					return(-1)
				endif
				;
				PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQICMS.FIS_ALIQUOTAISVC
			endif

			;---Elia Proj. 61/471 12/09/08
			if (PR_REDUBASE.FIS_REGRAFISCSVC != 0)
				vVlCalc = ($vlTotalLiquido$ + $vlIPI$) - (($vlTotalLiquido$ + $vlIPI$) * PR_REDUBASE.FIS_REGRAFISCSVC) / 100
			else	
				vVlCalc = $vlTotalLiquido$ + $vlIPI$
			endif
			vVlBaseCalc                = vVlCalc + (vVlCalc * vPrIVA) / 100 
			VL_BASECALC.FIS_IMPOSTOSVC = vVlBaseCalc[round, 6]
			PR_BASECALC.FIS_IMPOSTOSVC = 100
			vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * (PR_ALIQUOTA.FIS_IMPOSTOSVC / 100)
			vVlICMS                    = vVlCalc[round, 6] 
			VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlICMS - $vlICMS$
			$cdDecreto$                = vCdDecreto
		endif
	;---Elia Proj. 61/393 01/07/08
	elseif (vCdDecreto = 2559); Decreto do Paraná
		if ($dsUFOrigem$ = "PR") | ($dsUFDestino$ = "PR")
			if (TP_MODALIDADE.GER_OPERACAOSVC = 4); Venda/Compra
				if (TP_OPERACAO.GER_OPERACAOSVC = "E")
					; Aliquota interna de PR
					clear/e "FIS_ALIQUOTAISVC"
					CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$
					CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
					retrieve/e "FIS_ALIQUOTAISVC"
					if ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
						return(-1)
					endif
				else
					; Aliquota interna de PR
					clear/e "FIS_ALIQUOTAISVC"
					CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFOrigem$ 
					CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFOrigem$
					retrieve/e "FIS_ALIQUOTAISVC"
					if ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
						return(-1)
					endif
				endif

				; Aliquota interna de PR
				if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0)
					vVlAliquotaIntra = PR_ALIQICMS.FIS_REGRAFISCSVC 
				else
					vVlAliquotaIntra = PR_ALIQICMS.FIS_ALIQUOTAISVC
				endif
				vVlAliquotaInter = PR_ALIQUOTA.FIS_IMPOSTOSVC ; Aliquota aplicada pelo Fornecedor
				;---Elia Proj. 61/534 22/01/09 
				if ($inProdPropria$ = <TRUE>)
					vCdCFOP = CD_CFOPPROPRIA.FIS_REGRAFISCSVC
				else
					vCdCFOP = CD_CFOPTERCEIRO.FIS_REGRAFISCSVC
				endif
				vCdCFOP = vCdCFOP[2,4]				
				if (vCdCFOP = 407)
					vPrIVA = $abs(vVlAliquotaInter - vVlAliquotaIntra)
				else
					if ($dsUFOrigem$ = "PR") & ($dsUFDestino$ = "PR")
						vPrIVA = 40
					else
						vPrIVA = ((1 + (40/100)) * ((1 - (vVlAliquotaInter/100)) / (1 - (vVlAliquotaIntra/100))) -1) * 100
					endif
				endif
				;
				vInDecreto = <TRUE>
			endif
		endif

		if (vInDecreto = <TRUE>)
			vVlCalc                    = $vlTotalLiquidoICMS$ + $vlIPI$ + (($vlTotalLiquidoICMS$ + $vlIPI$) * vPrIVA) / 100 
			VL_BASECALC.FIS_IMPOSTOSVC = vVlCalc[round, 6]
			PR_BASECALC.FIS_IMPOSTOSVC = 100		
			vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * (vVlAliquotaInter / 100)
			vVlICMS                    = vVlCalc[round, 6] 
			PR_ALIQUOTA.FIS_IMPOSTOSVC = vVlAliquotaInter
			VL_IMPOSTO.FIS_IMPOSTOSVC  = ($vlTotalLiquidoICMS$ + $vlIPI$) * (1 + (vPrIVA / 100)) * (vVlAliquotaInter/100) - $vlICMS$	
			$cdDecreto$                = vCdDecreto
		endif
	;---Elia Proj. 61/398 02/07/08
	elseif (vCdDecreto = 52804); Decreto do Estado de São Paulo
		if ($dsUFOrigem$ = "SP") | ($dsUFDestino$ = "SP")
			if (TP_MODALIDADE.GER_OPERACAOSVC = 4); Compra/Venda
				if (TP_OPERACAO.GER_OPERACAOSVC = "E")
					; Aliquota interna de SP
					clear/e "FIS_ALIQUOTAISVC"
					CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$ 
					CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
					retrieve/e "FIS_ALIQUOTAISVC"
					if ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
						return(-1)
					endif
				else
					; Aliquota interna de SP
					clear/e "FIS_ALIQUOTAISVC"
					CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFOrigem$ 
					CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFOrigem$
					retrieve/e "FIS_ALIQUOTAISVC"
					if ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
						return(-1)
					endif
				endif

				; Aliquota interna de SP
				if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0)
					vVlAliquotaIntra = PR_ALIQICMS.FIS_REGRAFISCSVC 
				else
					vVlAliquotaIntra = PR_ALIQICMS.FIS_ALIQUOTAISVC
				endif
				vVlAliquotaInter = PR_ALIQUOTA.FIS_IMPOSTOSVC ; Aliquota aplicada pelo Fornecedor
				if ($dsUFOrigem$ = "SP") & ($dsUFDestino$ = "SP")
					vPrIVA = 17.32
				else
					vPrIVA = ((1 + (17.32/100)) * ((1 - (vVlAliquotaInter/100)) / (1 - (vVlAliquotaIntra/100))) -1) * 100
				endif
				vInDecreto = <TRUE>
			endif
		endif

		if (vInDecreto = <TRUE>)
			vVlCalc                    = $vlTotalLiquidoICMS$ + $vlIPI$ + (($vlTotalLiquidoICMS$ + $vlIPI$) * vPrIVA) / 100 
			VL_BASECALC.FIS_IMPOSTOSVC = vVlCalc[round, 6]
			PR_BASECALC.FIS_IMPOSTOSVC = 100		
			vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * (vVlAliquotaIntra / 100)
			vVlICMS                    = vVlCalc[round, 6] 
			PR_ALIQUOTA.FIS_IMPOSTOSVC = vVlAliquotaInter
			VL_IMPOSTO.FIS_IMPOSTOSVC  = ($vlTotalLiquidoICMS$ + $vlIPI$) * (1 + (vPrIVA / 100)) * (vVlAliquotaInter/100) - $vlICMS$	
			$cdDecreto$                = vCdDecreto
		endif
	;---Elia Proj. 61/448 20/08/08 - Decreto do Espirito Santo
	elseif (vCdDecreto = 10901) | (vCdDecreto = 10902) | (vCdDecreto = 10903) | (vCdDecreto = 10904); Decreto do Espirito Santo
		if ($dsUFOrigem$ = "ES") | ($dsUFDestino$ = "ES")
			if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4 | TP_MODALIDADE.GER_OPERACAOSVC = 3) ; 4 - Venda/Compra / 3 - Devolucao
				if (vCdDecreto = 10901)
					vPrIVA     = 42
					vInDecreto = <TRUE>
				elseif (vCdDecreto = 10902)
					vPrIVA     = 32
					vInDecreto = <TRUE>
				elseif (vCdDecreto = 10903)
					vPrIVA     = 60
					vInDecreto = <TRUE>
				elseif (vCdDecreto = 10904)
					vPrIVA     = 45
					vInDecreto = <TRUE>
				endif
			endif
		endif

		if (vInDecreto = <TRUE>)
			;---Aliquota aplicada no destino
			clear/e "FIS_ALIQUOTAISVC"
			;CD_UFORIGEM.FIS_ALIQUOTAISVC/init = $dsUFOrigem$ ;---Elia Proj. 5/32 04/11/08
			CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$
			CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
			retrieve/e "FIS_ALIQUOTAISVC"
			if ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
				return(-1)
			endif
			; Aliquota interna do destino
			if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0)
				vVlAliquotaIntra = PR_ALIQICMS.FIS_REGRAFISCSVC 
			else
				vVlAliquotaIntra = PR_ALIQICMS.FIS_ALIQUOTAISVC
			endif
			vVlCalc                    = $vlTotalLiquidoICMS$ + $vlIPI$ + (($vlTotalLiquidoICMS$ + $vlIPI$) * vPrIVA) / 100 
			VL_BASECALC.FIS_IMPOSTOSVC = vVlCalc[round, 6]
			PR_BASECALC.FIS_IMPOSTOSVC = 100		
			vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * (vVlAliquotaIntra / 100)
			vVlICMS                    = vVlCalc[round, 6] 
			PR_ALIQUOTA.FIS_IMPOSTOSVC = vVlAliquotaIntra
			VL_IMPOSTO.FIS_IMPOSTOSVC  = ($vlTotalLiquidoICMS$ + $vlIPI$) * (1 + (vPrIVA / 100)) * (vVlAliquotaIntra/100) - $vlICMS$
			$cdDecreto$               = vCdDecreto
			if ($dsUFOrigem$ = "ES") & ($dsUFDestino$ = "ES")
				vCdCST = "10"
			else
				vCdCST = "70"
			endif
		endif
	else
		;---Elia Proj. 061/571 27/03/09
		vTpOperacao = ""
		; Alterado por Deusdete em 16/07/2009 c/ anuência do Marcio (Não pode ser a mesma lógica quanto a origem emissão)
		;if (TP_OPERACAO.GER_OPERACAOSVC = "E") | (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S") ; 3 - Devolucao de compra
		;	vTpOperacao = "E" 
		;elseif (TP_OPERACAO.GER_OPERACAOSVC = "S") | (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "E") ; 3 - Devolucao de venda
		;	vTpOperacao = "S"
		;endif
		vTpOperacao = TP_OPERACAO.GER_OPERACAOSVC

		viParams = ""
		putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.PRD_PRODUTOSVC
		putitem/id viParams, "UF_ORIGEM", $dsUFOrigem$
		putitem/id viParams, "UF_DESTINO", $dsUFDestino$
		putitem/id viParams, "TP_OPERACAO", vTpOperacao
		activate "FISSVCO035".buscaDadosFiscalProduto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		vPrIvaPrd = $item("PR_SUBSTRIB", voParams)	
		vPrICMS   = $item("PR_ICMS", voParams)

		if (vPrIvaPrd > 0)
			vPrIVA = vPrIvaPrd
		endif

		if (vPrICMS > 0) 
			PR_ALIQUOTA.FIS_IMPOSTOSVC = vPrICMS
		endif
		;
		;--- Alterado por Deusdete em caráter de urgência com anuência do Eliã (10/06/2009)
		if (PR_ALIQUOTA.FIS_IMPOSTOSVC = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada na Tabela de Sub.Trib.do NCM de %%$dsUFOrigem$ para %%$dsUFDestino$%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
			return(-1)
		endif
		;-- MAD [Proj/Tar.061/723] - 02/12/2009
		vInCalcula = <FALSE>
		if ($dsUFOrigem$ != $dsUFDestino$) & (TP_MODALIDADE.GER_OPERACAOSVC = 4); Venda/Compra
			if (TP_OPERACAO.GER_OPERACAOSVC = "S")
				if ($inContribuinte$ = <TRUE>) & (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>)
					vInCalcula = <TRUE>
				endif
			else
				if ($inProdPropria$ = <TRUE>)
					vCdCFOP = CD_CFOPPROPRIA.FIS_REGRAFISCSVC
				else
					vCdCFOP = CD_CFOPTERCEIRO.FIS_REGRAFISCSVC
				endif
				vCdCFOP = vCdCFOP[2,4]				

				if (vCdCFOP = 407)
					vInCalcula = <TRUE>
				endif
			endif

			if (vInCalcula = <TRUE>)
				; Aliquota interna destino
				clear/e "FIS_ALIQUOTAISVC"
				CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$
				CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
				retrieve/e "FIS_ALIQUOTAISVC"
				if ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
					return(-1)
				endif
				vVlAliquotaDestino = PR_ALIQICMS.FIS_ALIQUOTAISVC

				; Aliquota interna origem
				clear/e "FIS_ALIQUOTAISVC"
				CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFOrigem$ 
				CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFOrigem$
				retrieve/e "FIS_ALIQUOTAISVC"
				if ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
					return(-1)
				endif
				vVlAliquotaOrigem = PR_ALIQICMS.FIS_ALIQUOTAISVC

				;Se tiver aliquota na regra fiscal será passado para AliquotaOrigem
				if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0)
					vVlAliquotaOrigem = PR_ALIQICMS.FIS_REGRAFISCSVC 
				endif

				vPrIVA                     = 0
   			PR_ALIQUOTA.FIS_IMPOSTOSVC = $abs(vVlAliquotaOrigem - vVlAliquotaDestino)

			else ;-- MAD [Proj/Tar.170/180] - 03/02/2011

				;; ICJ [PROJ/TAR 61/908] (14/12/2010)
				clear/e "FIS_ALIQUOTAISVC"
				CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFOrigem$
				CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
				retrieve/e "FIS_ALIQUOTAISVC"
				if ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
					return(-1)
				endif
				vVlAliquotaInter = PR_ALIQICMS.FIS_ALIQUOTAISVC

				;<Arley - Proj/Tar.175/112 - 06/04/2011>
				viParams = ""
				putitem/id viParams, "CD_PRODUTO" , CD_PRODUTO.PRD_PRODUTOSVC
				putitem/id viParams, "UF_ORIGEM"  , $dsUFOrigem$
				putitem/id viParams, "UF_DESTINO" , $dsUFDestino$
				putitem/id viParams, "TP_OPERACAO", vTpOperacao
				activate "FISSVCO035".buscaDadosFiscalProduto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif

				vVlAliquotaIntra = $item("PR_ICMS", voParams)	

				if (vVlAliquotaIntra = 0)
				;<Arley - Proj/Tar.175/112 - 06/04/2011>
					;---Acha aliquota interna da UF destino
					clear/e "FIS_ALIQUOTAISVC"
					CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFDestino$
					CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
					retrieve/e "FIS_ALIQUOTAISVC"
					if ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
						return(-1)
					endif
					vVlAliquotaIntra = PR_ALIQICMS.FIS_ALIQUOTAISVC
				endif

				if ($dsUFDestino$ != $dsUFOrigem$)
				   vPrIVA = ((1 + (vPrIVA/100)) * ((1 - (vVlAliquotaInter/100)) / (1 - (vVlAliquotaIntra/100))) -1) * 100
				endif
				;;
			endif
		endif
		;;
		;-- MAD [Proj/Tar.061/862] - 31/08/2010
		if ($prAplicMvaSubTrib$ != "") 
			if (vTpOperacao = "S" & $dsUFDestino$ = "SC" & $inContribuinte$ = <TRUE> & ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)) | %\ 
			   (vTpOperacao = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 3 & ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)) | %\ ; 2-Micro Empresa / 3-EPP
			   (vTpOperacao = "E" & $inOptSimples$ = <TRUE>)
				if (vPrIVA = 0)
					vPrIva = vPrIvaPrd
				endif
				vPrIVA = (vPrIVA * $prAplicMvaSubTrib$)/100
			endif
		endif
		;;
		if (vCdCST = "10")
			vVlCalc                    = ($vlTotalLiquidoICMS$ + $vlIPI$) + (($vlTotalLiquidoICMS$ + $vlIPI$) * vPrIVA) / 100
			VL_BASECALC.FIS_IMPOSTOSVC = vVlCalc[round, 6]
			PR_BASECALC.FIS_IMPOSTOSVC = 100
		elseif (vCdCST = "70") ;Implementado por Deusdete em caráter de urgência em 28/04/2009, lógica revisada c/ Eliã
			vVlCalc = $vlTotalLiquidoICMS$ + $vlIPI$
			if ($naturezaComercialEmp$ != 3 & $naturezaComercialEmp$ != 2) ;Varejo e Atacado(p/ atender o Lojão e Brascol)
				if (PR_REDUBASE.FIS_REGRAFISCSVC != 0)
					if (vTpOperacao = "S")
						vVlCalc                    = vVlCalc - (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_REDUBASE.FIS_REGRAFISCSVC) / 100
						;>-- MAC - PRJ 175/003 - 08/11/2010 ---
						PR_BASECALC.FIS_IMPOSTOSVC = 100 - PR_REDUBASE.FIS_REGRAFISCSVC
						PR_REDUBASE.FIS_IMPOSTOSVC = PR_REDUBASE.FIS_REGRAFISCSVC
					elseif (vTpOperacao = "E")
						if ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)
							vVlCalc                    = vVlCalc - (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_REDUBASE.FIS_REGRAFISCSVC) / 100
							PR_BASECALC.FIS_IMPOSTOSVC = 100 - PR_REDUBASE.FIS_REGRAFISCSVC
							PR_REDUBASE.FIS_IMPOSTOSVC = PR_REDUBASE.FIS_REGRAFISCSVC
						;--<
						endif					
					endif			
				endif
			endif
			vVlBaseCalc                = vVlCalc + ((vVlCalc * vPrIVA) / 100)
			VL_BASECALC.FIS_IMPOSTOSVC = vVlBaseCalc[round, 6]
			if (PR_REDUBASE.FIS_IMPOSTOSVC = 0)
				PR_BASECALC.FIS_IMPOSTOSVC = 100
			endif
		elseif (vCdCST = "30")
			;>-- MAC - PRJ 175/003 - 08/11/2010 ---
			vVlCalc = $vlTotalLiquidoICMS$ + $vlIPI$
			if ($inOptSimples$ = <TRUE>)
				if ($naturezaComercialEmp$ != 3 & $naturezaComercialEmp$ != 2) ;Varejo e Atacado(p/ atender o Lojão e Brascol)
					if (PR_REDUBASE.FIS_REGRAFISCSVC != 0)
						if (vTpOperacao = "S")
							vVlCalc                    = vVlCalc - (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_REDUBASE.FIS_REGRAFISCSVC) / 100
							;>-- MAC - PRJ 175/003 - 08/11/2010 ---
							PR_BASECALC.FIS_IMPOSTOSVC = 100 - PR_REDUBASE.FIS_REGRAFISCSVC
							PR_REDUBASE.FIS_IMPOSTOSVC = PR_REDUBASE.FIS_REGRAFISCSVC
						elseif (vTpOperacao = "E")
							if ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)
								vVlCalc                    = vVlCalc - (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_REDUBASE.FIS_REGRAFISCSVC) / 100
								PR_BASECALC.FIS_IMPOSTOSVC = 100 - PR_REDUBASE.FIS_REGRAFISCSVC
								PR_REDUBASE.FIS_IMPOSTOSVC = PR_REDUBASE.FIS_REGRAFISCSVC
							;--<
							endif					
						endif			
					endif
				endif
			endif
			vVlBaseCalc                = vVlCalc + ((vVlCalc * vPrIVA) / 100 )
			VL_BASECALC.FIS_IMPOSTOSVC = vVlBaseCalc[round, 6]
			if (PR_REDUBASE.FIS_IMPOSTOSVC = 0)
				PR_BASECALC.FIS_IMPOSTOSVC = 100
			endif
			;VL_ISENTO.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
			;--<
		;---Elia Proj. 061/650 24/07/09
		;elseif (vCdCST = "60")
		;	VL_OUTRO.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
		;
		else
			VL_OUTRO.FIS_IMPOSTOSVC = $vlTotalLiquidoICMS$
		endif

		;-- MAD [Proj/Tar.061/723] - 02/12/2009
		if (vInCalcula = <TRUE>) 
			vVlCalc                   = (VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC) / 100
			vVlCalc                   = vVlCalc[round, 6]
			VL_IMPOSTO.FIS_IMPOSTOSVC = vVlCalc
		else
		;;
			if (VL_BASECALC.FIS_IMPOSTOSVC > 0)
				;---Elia Proj. 061/629 30/06/09
				;;---Elia/Deusdete 06/05/09 - Sem tarefa para Brascol
				;;;---Elia Proj. 061/579 14/04/09
				;;if ($inOptSimples$ = <TRUE>) 
				;if ($inOptSimples$ = <TRUE>) | (($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3) & (TP_OPERACAO.GER_OPERACAOSVC = "E")) ;2-Simples 3-EPP
				if ($inOptSimples$ = <TRUE>) | (($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3) & %\ 
					((TP_OPERACAO.GER_OPERACAOSVC = "E") | (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S"))) ;2-Simples 3-EPP / Entrada ou Devolucao de compra
				;
					if (PR_ALIQUOTA.FIS_IMPOSTOSVC != 0)
						vVlCalc = (VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC) / 100
						vVlICMS = vVlCalc[round, 6]		
					
						;>-- MAC - PRJ 175/003 - 08/11/2010 ---
						if (vCdCST = "30") | (vCdCST = "70")
							if ($inOptSimples$ = <TRUE>)
								if (TP_OPERACAO.GER_OPERACAOSVC = "E")
									if ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)
										if (PR_REDUBASE.FIS_REGRAFISCSVC != 0)
											$vlTotalLiquidoICMS$ = ($vlTotalLiquidoICMS$ + $vlIPI$) - (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_REDUBASE.FIS_REGRAFISCSVC) / 100
										endif
									endif
								elseif (TP_OPERACAO.GER_OPERACAOSVC = "S")
									if (PR_REDUBASE.FIS_REGRAFISCSVC != 0)
										$vlTotalLiquidoICMS$ = ($vlTotalLiquidoICMS$ + $vlIPI$) - (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_REDUBASE.FIS_REGRAFISCSVC) / 100
									endif
								endif
							elseif ($inOptSimples$ = <FALSE>) & (vCdCST = "70")
								if ($tpRegimeOrigem$ = 2 | $tpRegimeOrigem$ = 3)
									if (PR_REDUBASE.FIS_REGRAFISCSVC != 0)
										$vlTotalLiquidoICMS$ = ($vlTotalLiquidoICMS$ + $vlIPI$) - (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_REDUBASE.FIS_REGRAFISCSVC) / 100
									endif
								endif
							endif
						endif
						
						if ($dsUFOrigem$ = $dsUFDestino$)
							if (PR_ALIQICMS.FIS_REGRAFISCSVC > 0)
								vVlCalc = (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_ALIQICMS.FIS_REGRAFISCSVC) / 100
							else
								clear/e "FIS_ALIQUOTAISVC"
								CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFOrigem$
								CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
								retrieve/e "FIS_ALIQUOTAISVC"
								if ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
									return(-1)
								endif
								vVlCalc = (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_ALIQICMS.FIS_ALIQUOTAISVC) / 100
							endif
						else
						;--<
							;---Elia Proj. 061/653 11/08/09
							;vVlCalc = ($vlTotalLiquidoICMS$ * 7) /100
							clear/e "FIS_ALIQUOTAISVC"
							CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $dsUFOrigem$
							CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $dsUFDestino$
							retrieve/e "FIS_ALIQUOTAISVC"
							if ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastrada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaICMSSubst")
								return(-1)
							endif
							vVlCalc = (($vlTotalLiquidoICMS$ + $vlIPI$) * PR_ALIQICMS.FIS_ALIQUOTAISVC) / 100
							;
						endif				
						vVlCalc                   = vVlCalc[round, 6]
						VL_IMPOSTO.FIS_IMPOSTOSVC = vVlICMS - vVlCalc
					endif
				else
					vVlCalc                   = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
					vVlICMS                   = vVlCalc[round, 6] 
					VL_IMPOSTO.FIS_IMPOSTOSVC = vVlICMS - $vlICMS$
				endif
				;
			else
				VL_IMPOSTO.FIS_IMPOSTOSVC = 0
			endif
		endif
	endif

	;---Elia Proj. 061/650 24/07/09
	if (vCdCST = "60")
		;-- MAD [Proj/Tar.170/081] - 24/09/2010
		; A linha abaixo foi "descomentada"
		PR_ALIQUOTA.FIS_IMPOSTOSVC = 0 ;Comentado por Deusdete em 28/07/2009 por estar acusando erro na Nota Fiscal Paulista
		;;
		VL_OUTRO.FIS_IMPOSTOSVC    = $vlTotalLiquidoICMS$
		VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
		VL_BASECALC.FIS_IMPOSTOSVC = 0
		PR_BASECALC.FIS_IMPOSTOSVC = 0
		PR_REDUBASE.FIS_IMPOSTOSVC = 0
	endif
	;
	$cdCST$ = "%%$cdCST$[1, 1]%%vCdCST"

	return(0)

end ;calculaICMSSubst

;----------------------
entry calculaIPI
;----------------------

	variables
		numeric vVlCalc, vVlBaseCalc, vCdDecreto
		boolean vInDecreto
		date    vDtIniVigencia, vDtFimVigencia, vDtSistema
	endvariables
		
	if ($tpOrigemEmissao$ = 1) ;Própria
		if (IN_IPI.FIS_REGRAFISCSVC != <TRUE>)
			discard "FIS_IMPOSTOSVC"
			return(0)
		endif
	else
		if ($prIPI$ = 0) | ($vlIPI$ = 0) 
			if (IN_IPI.FIS_REGRAFISCSVC != <TRUE>) ;---Elia Proj. 61/429 04/08/08
				discard "FIS_IMPOSTOSVC"
				return(0)
			endif
		endif		
	endif

	;---Elia Proj. 61/330 09/06/08
	$cdDecreto$ = ""
	vCdDecreto  = ""
	vInDecreto  = <FALSE>
	vDtSistema  = $item("DT_SISTEMA", $xlpg$)
	
	if ($cdDecretoItemCapa$ != 0)
		clear/e "F_FIS_DECRETOSVC"
		CD_DECRETO.F_FIS_DECRETOSVC/init = $cdDecretoItemCapa$
		retrieve/e "F_FIS_DECRETOSVC"
		if ($status >= 0)
			vCdDecreto     = CD_DECRETO.F_FIS_DECRETOSVC
			vDtIniVigencia = DT_INIVIGENCIA.F_FIS_DECRETOSVC
			vDtFimVigencia = DT_FIMVIGENCIA.F_FIS_DECRETOSVC
		endif
	else
		if (CD_DECRETO.FIS_DECRETOSVC > 0)
			vCdDecreto     = CD_DECRETO.FIS_DECRETOSVC
			vDtIniVigencia = DT_INIVIGENCIA.FIS_DECRETOSVC
			vDtFimVigencia = DT_FIMVIGENCIA.FIS_DECRETOSVC
		endif
	endif

	if (vCdDecreto > 0)
		if (vDtIniVigencia != "") & (vDtSistema < vDtIniVigencia)
			vCdDecreto = ""
		endif
		if (vDtFimVigencia != "") & (vDtSistema > vDtFimVigencia)
			vCdDecreto = ""
		endif
	endif
	;
	PR_BASECALC.FIS_IMPOSTOSVC = 100
	VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalBruto$
	if ($tpOrigemEmissao$ = 1) ;Própria
		if($prIPI$ != "")
			PR_ALIQUOTA.FIS_IMPOSTOSVC = $prIPI$
		else
			PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_IPI.FIS_TIPISVC
		endif
		vVlCalc                   = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
		VL_IMPOSTO.FIS_IMPOSTOSVC = vVlCalc[round, 2]
	else
		if ($vlIPI$ = 0) ;;ICJ [PROJ/TAR 61/889] (26/10/2010)
			if ($prIPI$ != "")
				PR_ALIQUOTA.FIS_IMPOSTOSVC = $prIPI$
			endif
			;VL_IMPOSTO.FIS_IMPOSTOSVC = $vlIPI$ ;ICJ [PROJ/TAR 61/889] (26/10/2010)
			vVlCalc                   = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
			VL_IMPOSTO.FIS_IMPOSTOSVC = vVlCalc[round, 2]
		;;ICJ [PROJ/TAR 61/889] (26/10/2010)
		else
			PR_ALIQUOTA.FIS_IMPOSTOSVC = $prIPI$
			VL_IMPOSTO.FIS_IMPOSTOSVC  = $vlIPI$
		;;
		endif
	endif
	;---Elia Proj. 61/330 09/06/08
	if (vCdDecreto = 8248) ; Decreto para reduzir o valor do IPI em 95% para produto de informática
		if (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; 4 - Venda/Compra
			vInDecreto = <TRUE>
		endif

		if (vInDecreto = <TRUE>)
			vVlCalc                   = VL_IMPOSTO.FIS_IMPOSTOSVC * (1 - 0.95)
			VL_IMPOSTO.FIS_IMPOSTOSVC = vVlCalc[round, 2]
			$cdDecreto$               = vCdDecreto
		endif
	endif
	;
	;---Elia Proj. 91/362 26/02/09
	if (TP_MODALIDADE.GER_OPERACAOSVC != 3 | TP_OPERACAO.GER_OPERACAOSVC != "S") ;Devolucao / Saida
		;-- MAD [Proj/Tar.061/849] - 11/08/2010
		;if($cdServico$ > 0 | TP_MODALIDADE.GER_OPERACAOSVC = 5 | TP_MODALIDADE.GER_OPERACAOSVC = 6) ; 5 - Outras entradas/saidas / 6 - Producao
		if ($cdServico$ > 0 | TP_MODALIDADE.GER_OPERACAOSVC = 5 | TP_MODALIDADE.GER_OPERACAOSVC = 6 | TP_MODALIDADE.GER_OPERACAOSVC = "F") ; 5-Outras entradas/saidas / 6-Producao / F-Remessa/Retorno
		;;
			if ($inCalcIpiOutEntSai$ != <TRUE>) ;-- MAD [Proj/Tar.061/778] - 26/02/2010
				VL_OUTRO.FIS_IMPOSTOSVC    = VL_BASECALC.FIS_IMPOSTOSVC
				VL_BASECALC.FIS_IMPOSTOSVC = 0
				VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
				PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
				PR_BASECALC.FIS_IMPOSTOSVC = ""
			endif
		;---Elia Proj. 061/599 12/06/09
		elseif (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "E") ; Devolução de Venda
			if ($dsUFDestino$ = "AC" | $dsUFDestino$ = "AM" | $dsUFDestino$ = "RO" | $dsUFDestino$ = "RR" | $dsUFOrigem$ = "EX" | $dsUFDestino$ = "EX")
				VL_OUTRO.FIS_IMPOSTOSVC    = VL_BASECALC.FIS_IMPOSTOSVC
				VL_BASECALC.FIS_IMPOSTOSVC = 0
				VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
				PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
				PR_BASECALC.FIS_IMPOSTOSVC = ""
			endif
		else
			if ($naturezaComercialEmp$ = 4) 	; 4 - IPI suspenso
				if (VL_IMPOSTO.FIS_IMPOSTOSVC = 0)
					VL_OUTRO.FIS_IMPOSTOSVC    = VL_BASECALC.FIS_IMPOSTOSVC
					VL_BASECALC.FIS_IMPOSTOSVC = 0
					;<ANO Pjt61 Trf826 - 14/05/2010>
					PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
					PR_BASECALC.FIS_IMPOSTOSVC = ""
					;</ANO Pjt61 Trf826 - 14/05/2010>
				endif
			;endif;<ANO Pjt61 Trf826 - 14/05/2010> , comentado o endif e incluido elseif a condição abaixo que era apenas if.
			;---Elia Proj. 91/320 16/01/09
			elseif (TP_MODALIDADE.GER_OPERACAOSVC = 4 & TP_OPERACAO.GER_OPERACAOSVC = "S") ; 4 - Venda
				;---Elia Proj. 061/599 12/06/09
				;if ($dsUFDestino$ = "EX")
				if ($dsUFDestino$ = "EX" | $dsUFDestino$ = "AC" | $dsUFDestino$ = "AM" | $dsUFDestino$ = "RO" | $dsUFDestino$ = "RR")
				;
					VL_OUTRO.FIS_IMPOSTOSVC    = VL_BASECALC.FIS_IMPOSTOSVC
					VL_BASECALC.FIS_IMPOSTOSVC = 0
					VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
					PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
					PR_BASECALC.FIS_IMPOSTOSVC = ""
				elseif ($tpAreaComercioOrigem$ = 0) & ($tpAreaComercioDestino$ > 0)
					VL_OUTRO.FIS_IMPOSTOSVC    = VL_BASECALC.FIS_IMPOSTOSVC
					VL_BASECALC.FIS_IMPOSTOSVC = 0
					VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
					PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
					PR_BASECALC.FIS_IMPOSTOSVC = ""
				endif
			endif
		endif
	else
		;thamati 18/10/2010 [Proj. 0170 - Tar. 0090]
		if (PR_ALIQUOTA.FIS_IMPOSTOSVC = 0)
			VL_OUTRO.FIS_IMPOSTOSVC    = VL_BASECALC.FIS_IMPOSTOSVC
			VL_BASECALC.FIS_IMPOSTOSVC = 0
			VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
			PR_ALIQUOTA.FIS_IMPOSTOSVC = 0
			PR_BASECALC.FIS_IMPOSTOSVC = ""
		endif
		;
	endif
	;
	if ($inImpostoOffLine$ = <TRUE>)
		VL_BASECALC.FIS_IMPOSTOSVC = 0
		VL_IMPOSTO.FIS_IMPOSTOSVC  = 0
	endif

	$prIPI$ = PR_ALIQUOTA.FIS_IMPOSTOSVC
	$vlIPI$ = VL_IMPOSTO.FIS_IMPOSTOSVC

	return(0)

end ;calculaIPI

;----------------------
entry calculaISS
;----------------------

	variables
		numeric vVlCalc, vVlBaseCalc
		string  vCdCST
	endvariables

	if ($inImpostoOffLine$ = <TRUE>)
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif
	;-- MAD [Proj/Tar.061/727] - 10/12/2009
	vCdCST = $cdCST$[2 : 2]

	if (vCdCST = "40") | (vCdCST = "41")
		PR_BASECALC.FIS_IMPOSTOSVC = 0
		VL_BASECALC.FIS_IMPOSTOSVC = 0
		PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQISS.FIS_REGRAFISCSVC
		vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
		VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlCalc[round, 6]
		VL_ISENTO.FIS_IMPOSTOSVC   = $vlTotalLiquido$
	
	elseif (vCdCST = "90")
		PR_BASECALC.FIS_IMPOSTOSVC = 0
		VL_BASECALC.FIS_IMPOSTOSVC = 0
		PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQISS.FIS_REGRAFISCSVC
		vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
		VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlCalc[round, 6]
		VL_OUTRO.FIS_IMPOSTOSVC    = $vlTotalLiquido$
	else
	;;
		PR_BASECALC.FIS_IMPOSTOSVC = 100
		VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquido$
		PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQISS.FIS_REGRAFISCSVC
		vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
		VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlCalc[round, 6]
	endif

	return(0)

end ;calculaISS

;-------------------
entry calculaCOFINS
;-------------------

	variables
		numeric vVlCalc
	endvariables

	if ($inImpostoOffLine$ = <TRUE>)
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif
	;-- MAD [Proj/Tar.170/285] - 30/05/2011
	;if (IN_COFINS.FIS_REGRAFISCSVC != <TRUE>) | (PR_ALIQCOFINS.FIS_REGRAFISCSVC = 0)
	if (IN_COFINS.FIS_REGRAFISCSVC != <TRUE>)
	;;
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif
	;-- MAD [Proj/Tar.170/188] - 18/02/2011
	clear/e "FIS_REGRAIMPOSVC"
	CD_IMPOSTO.FIS_REGRAIMPOSVC/init     = CD_IMPOSTO.FIS_IMPOSTOSVC
	CD_REGRAFISCAL.FIS_REGRAIMPOSVC/init = CD_REGRAFISCAL.FIS_REGRAFISCSVC
	retrieve/e "FIS_REGRAIMPOSVC"
	if ($status >= 0)
		CD_CST.FIS_IMPOSTOSVC = CD_CST.FIS_REGRAIMPOSVC
	endif
	;;

	;-- MAD [Proj/Tar.170/313] - 29/06/2011
	if ($tpAreaComercioOrigem$ = 0) & (($tpAreaComercioDestino$ = 1 & $inDescontaPisCofinsAlc$ = 0) | %\
	   ($tpAreaComercioDestino$ = 2 & $inDescontaPisCofinsZfm$ = 0))
		PR_ALIQCOFINS.FIS_REGRAFISCSVC = 0
		CD_CST.FIS_IMPOSTOSVC          = "06"
	endif
	;;
	PR_BASECALC.FIS_IMPOSTOSVC = 100
	VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquido$
	;--> VSOUZA PRJ/TAR 175/242 26/09/2011
	if ($dsLstCfopIpiBcPisCof$ != "")
		creocc "TMP_NR09SVC", -1
		if ($inProdPropria$ = <TRUE>)
 			NR_GERAL.TMP_NR09SVC = CD_CFOPPROPRIA.FIS_REGRAFISCSVC
		else
			NR_GERAL.TMP_NR09SVC = CD_CFOPTERCEIRO.FIS_REGRAFISCSVC
		endif
		retrieve/o "TMP_NR09SVC"
	   if ($status = 4)
			VL_BASECALC.FIS_IMPOSTOSVC = VL_BASECALC.FIS_IMPOSTOSVC + $vlIPI$
		else
		   discard "TMP_NR09SVC", -1
	   endif
	endif
	;------------------------------------------->
	PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQCOFINS.FIS_REGRAFISCSVC
	vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
	VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlCalc[round, 6]

	return(0)

end ;calculaCOFINS

;----------------------
entry calculaPIS
;----------------------

	variables
		numeric vVlCalc
	endvariables

	if ($inImpostoOffLine$ = <TRUE>)
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif
	;-- MAD [Proj/Tar.170/285] - 30/05/2011
	;if (IN_PIS.FIS_REGRAFISCSVC != <TRUE>) | (PR_ALIQPIS.FIS_REGRAFISCSVC = 0)
	if (IN_PIS.FIS_REGRAFISCSVC != <TRUE>)
	;;
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif
	;-- MAD [Proj/Tar.170/188] - 18/02/2011
	clear/e "FIS_REGRAIMPOSVC"
	CD_IMPOSTO.FIS_REGRAIMPOSVC/init     = CD_IMPOSTO.FIS_IMPOSTOSVC
	CD_REGRAFISCAL.FIS_REGRAIMPOSVC/init = CD_REGRAFISCAL.FIS_REGRAFISCSVC
	retrieve/e "FIS_REGRAIMPOSVC"
	if ($status >= 0)
		CD_CST.FIS_IMPOSTOSVC = CD_CST.FIS_REGRAIMPOSVC
	endif
	;;
	;-- MAD [Proj/Tar.170/313] - 29/06/2011
	if ($tpAreaComercioOrigem$ = 0) & (($tpAreaComercioDestino$ = 1 & $inDescontaPisCofinsAlc$ = 0) | %\
	   ($tpAreaComercioDestino$ = 2 & $inDescontaPisCofinsZfm$ = 0))
		PR_ALIQPIS.FIS_REGRAFISCSVC = 0
		CD_CST.FIS_IMPOSTOSVC       = "06"
	endif
	;;
	PR_BASECALC.FIS_IMPOSTOSVC = 100
	VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquido$
	;--> VSOUZA PRJ/TAR 175/242 26/09/2011
	if ($dsLstCfopIpiBcPisCof$ != "")
		creocc "TMP_NR09SVC", -1
		if ($inProdPropria$ = <TRUE>)
 			NR_GERAL.TMP_NR09SVC = CD_CFOPPROPRIA.FIS_REGRAFISCSVC
		else
			NR_GERAL.TMP_NR09SVC = CD_CFOPTERCEIRO.FIS_REGRAFISCSVC
		endif
		retrieve/o "TMP_NR09SVC"
	   if ($status = 4)
			VL_BASECALC.FIS_IMPOSTOSVC = VL_BASECALC.FIS_IMPOSTOSVC + $vlIPI$
		else
		   discard "TMP_NR09SVC", -1
	   endif
	endif
	;------------------------------------------->
	PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQPIS.FIS_REGRAFISCSVC
	vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
	VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlCalc[round, 6]

	return(0)

end ;calculaPIS

;----------------------
entry calculaPASEP
;----------------------

	variables
		numeric vVlCalc
	endvariables

	if ($inImpostoOffLine$ = <TRUE>)
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif

	if (IN_PASEP.FIS_REGRAFISCSVC != <TRUE>) | (PR_ALIQPASEP.FIS_REGRAFISCSVC = 0)
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif

	PR_BASECALC.FIS_IMPOSTOSVC = 100
	VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquido$
	PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQPASEP.FIS_REGRAFISCSVC
	vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
	VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlCalc[round, 6]

	return(0)

end ;calculaPASEP

;----------------------
entry calculaCSLL
;----------------------

	variables
		numeric vVlCalc
	endvariables

	if ($inImpostoOffLine$ = <TRUE>)
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif

	if (IN_CSL.FIS_REGRAFISCSVC != <TRUE>) | (PR_ALIQCSL.FIS_REGRAFISCSVC = 0)
		discard "FIS_IMPOSTOSVC"
		return(0)
	endif

	PR_BASECALC.FIS_IMPOSTOSVC = 100
	VL_BASECALC.FIS_IMPOSTOSVC = $vlTotalLiquido$
	PR_ALIQUOTA.FIS_IMPOSTOSVC = PR_ALIQCSL.FIS_REGRAFISCSVC
	vVlCalc                    = VL_BASECALC.FIS_IMPOSTOSVC * PR_ALIQUOTA.FIS_IMPOSTOSVC / 100
	VL_IMPOSTO.FIS_IMPOSTOSVC  = vVlCalc[round, 6]

	return(0)

end ;calculaPASEP

;-------------------------
public operation buscaCFOP
;-------------------------

	params
		string  xlpg        :IN
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams
	
	variables
		string  viParams, voParams, vDsLstEmpresa, vCdMPTer, vTpOperacao, vDsUF, vCdCSTOperacao
		numeric vCdEmpresa, vCdEmpresaParam, vCdProduto, vCdOperacao, vCdPessoa, vCdCST, vCdCFOPOperacao
		numeric vCdRegraFiscal, vCdCFOP, vTpAreaComercio, vTpAreaComercioOrigem, vCdCFOPServico, vPrIvaPrd
		boolean vInProdPropria, vInDecreto, vInOrgaoPublico
	endvariables

	$xlpg$ 						= xlpg
	if($item("UF_ORIGEM", piParams) != "")
		$dsUFOrigem$			= $item("UF_ORIGEM", piParams)
		$dsUFDestino$			= $item("UF_DESTINO", piParams)
	else
		$dsUFOrigem$			= $item("UF_ORIGEM", $xlpg$)
		$dsUFDestino$			= $item("UF_DESTINO", piParams)
	endif
	vCdProduto					= $item("CD_PRODUTO", piParams)
	vCdMPTer						= $item("CD_MPTER", piParams)
	$cdServico$					= $item("CD_SERVICO", piParams)
	vCdOperacao					= $item("CD_OPERACAO", piParams)
	vCdPessoa					= $item("CD_PESSOA", piParams)
	vTpAreaComercio			= $item("TP_AREACOMERCIO", piParams)
	vTpAreaComercioOrigem	= $item("TP_AREA_COMERCIO_ORIGEM", $xlpg$) ;---Elia Proj. 61/509 25/11/08
	vCdEmpresaParam			= $item("CD_EMPRESA", piParams)
	if (vCdEmpresaParam = 0)
		vCdEmpresaParam		= $item("CD_EMPRESA", $xlpg$)
	endif
	$TpModDctoFiscal$			= $item("TP_MODDCTOFISCAL", piParams)
	$tpOrigemEmissao$			= $item("TP_ORIGEMEMISSAO", piParams) ;1 - Própria / 2 - Terceiros
	$inContribuinte$			= ""
	vCdCFOP						= ""
	vInDecreto 					= <FALSE>
	$cdDecreto$ 				= ""
	
	if ($dsUFDestino$ = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=UF destino não informada!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif	

	if (vCdOperacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação não informada!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	if (vCdPessoa = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa não informada!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	clear/e "GER_OPERACAOSVC"
	CD_OPERACAO.GER_OPERACAOSVC/init = vCdOperacao
	retrieve/e "GER_OPERACAOSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação %%vCdOperacao não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	if (vCdProduto = 0) & (vCdMPTer = "") & ($cdServico$ = 0)
		return(0)
	endif

	;---Elia Proj. 061/573 27/03/09
	if (vCdMPTer != "")
		clear/e "CDF_MPTERSVC"
		CD_PESSOA.CDF_MPTERSVC/init	= vCdPessoa
		CD_MPTER.CDF_MPTERSVC/init	= vCdMPTer
		retrieve/e "CDF_MPTERSVC"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Matéria-prima %%vCdMPTer não cadastrada para a pessoa %%vCdPessoa%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	else
		clear/e "PRD_PRODUTOSVC"	
		CD_PRODUTO.PRD_PRODUTOSVC/init = vCdProduto
		retrieve/e "PRD_PRODUTOSVC"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Produto %%vCdProduto não cadastrado!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	;

	clear/e "PES_PESSOASVC"
	CD_PESSOA.PES_PESSOASVC/init = vCdPessoa
	retrieve/e "PES_PESSOASVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa %%vCdPessoa não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	if (TP_OPERACAO.GER_OPERACAOSVC = "S" & TP_MODALIDADE.GER_OPERACAOSVC = 4) | (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 3) ;Venda / Devolução de venda
		setocc "PES_CLIENTESVC", 1
		if (!$dbocc("PES_CLIENTESVC"))
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cliente %%vCdPessoa não cadastrado!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	; Implementado por Deusdete em 22/03/2007, situação emergencial na Krindges
	; Se for pessoa Jurídica e não tiver inscrição estadual, isto é, Isento, deverá ser tratado para fazer o cálculo do imposto
	; com a alíquota interna.
	$inPjIsento$ = <FALSE>
	if (NR_INSCESTL.PES_PESJURIDISVC = "ISENTO")  | (NR_INSCESTL.PES_PESJURIDISVC = "ISENTA") | %\
       (NR_INSCESTL.PES_PESJURIDISVC = "ISENTOS") | (NR_INSCESTL.PES_PESJURIDISVC = "ISENTAS")
		if (TP_REGIMETRIB.PES_PESJURIDISVC != "6") ; MEI (Micro Empresário Individual) ;-- MAD [Proj/Tar.170/135] - 24/11/2010
			$inPjIsento$ = <TRUE>
		endif
	endif

	;---Elia Proj. 061/650 22/07/09
	if ($tpOrigemEmissao$ = 2) ;Terceiros
		if (TP_MODALIDADE.GER_OPERACAOSVC != 3) ;Devolução
			vDsUF 			= $dsUFOrigem$
			$dsUFOrigem$	= $dsUFDestino$
			$dsUFDestino$	= vDsUF
		endif
	else
		if (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S") ;Devolução compra
			vDsUF				= $dsUFOrigem$
			$dsUFOrigem$	= $dsUFDestino$
			$dsUFDestino$	= vDsUF			
		endif
	endif
	;

	;---Elia Proj. 61/542 02/02/09
	viParams = ""
	putitem/id viParams, "CD_PESSOA", vCdPessoa
	activate "FCRSVCO057".validaPessoaOrgaoPublico($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    
	vInOrgaoPublico = $item("IN_ORGAOPUBLICO", voParams)

	if (vInOrgaoPublico = <TRUE>) & ($dsUFOrigem$ = "DF")
		$inContribuinte$ = <TRUE>
	else
		if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) | (TP_PESSOA.PES_PESSOASVC = "F") | ($inPjIsento$ = <TRUE>)
			;---Elia Proj. 61/577 14/04/09
			if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) & (TP_PESSOA.PES_PESSOASVC = "J") & ($inPjIsento$ = <FALSE>)
				$inContribuinte$ = <TRUE>
			else
				;---Elia Proj. 61/196 28/11/07
				;---Elia Proj. 061/625 29/06/09 Inclusao do RS.
				if (TP_PESSOA.PES_PESSOASVC = "F") & (NR_CODIGOFISCAL.PES_CLIENTESVC != "") & ($dsUFOrigem$ = "PR" | $dsUFOrigem$ = "SP" | $dsUFOrigem$ = "RS")
					$inContribuinte$ = <TRUE>
				else
					$inContribuinte$ = <FALSE>
				endif
				;
			endif
		else
			$inContribuinte$ = <TRUE>
		endif
	endif
	;

	;---Elia Proj. 061/650 22/07/09
	;if ($inContribuinte$ = <FALSE>) & ($dsUFDestino$ != "EX")
	;	$dsUFDestino$ = $dsUFOrigem$
	;endif
	;

	vCdRegraFiscal = 0
	
	if ($cdServico$ > 0)
		vInProdPropria = <FALSE>
		vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC
		if (vCdRegraFiscal = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	elseif (vCdMPTer != "")
		vInProdPropria = <FALSE>

		vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC

		if (vCdRegraFiscal = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	else
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", vCdEmpresaParam
		putitem/id viParams, "CD_PRODUTO", vCdProduto    
		activate "PRDSVCO008".buscaDadosFilial($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif	

		vInProdPropria = $item("IN_PRODPROPRIA", voParams)

		clear/e "PRD_PRDREGRAFSVC"
		CD_PRODUTO.PRD_PRDREGRAFSVC/init	= vCdProduto
		CD_OPERACAO.PRD_PRDREGRAFSVC/init	= vCdOperacao
		retrieve/e "PRD_PRDREGRAFSVC"
		if ($status >= 0)
			;---Elia 05/03/09 - Sem tarefa
			clear/e "FIS_REGRAFISCSVC"
			CD_REGRAFISCAL.FIS_REGRAFISCSVC/init = CD_REGRAFISCAL.PRD_PRDREGRAFSVC
			retrieve/e "FIS_REGRAFISCSVC"
			if ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Regra fiscal %%vCdRegraFiscal não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			else
				;---Elia Proj. 61/465 02/09/08
				if (CD_DECRETO.FIS_REGRAFISCSVC = 2155) | (CD_DECRETO.FIS_REGRAFISCSVC = 1020) | (CD_DECRETO.FIS_REGRAFISCSVC = 45471) | %\
					(CD_DECRETO.FIS_REGRAFISCSVC = 23731) | (CD_DECRETO.FIS_REGRAFISCSVC = 23732) | (CD_DECRETO.FIS_REGRAFISCSVC = 23733) | %\
					(CD_DECRETO.FIS_REGRAFISCSVC = 23734) | (CD_DECRETO.FIS_REGRAFISCSVC = 23735) | %\
					(CD_DECRETO.FIS_REGRAFISCSVC = 10201) | (CD_DECRETO.FIS_REGRAFISCSVC = 10202) | (CD_DECRETO.FIS_REGRAFISCSVC = 10203);;ANO Pjt91 Trf310 - 08/01/2009
					;---Elia Proj. 61/276 07/04/08
					if ($inContribuinte$ = <TRUE>)
						vCdRegraFiscal = CD_REGRAFISCAL.PRD_PRDREGRAFSVC
					else
						vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC
					endif	
					;
				else
					vCdRegraFiscal = CD_REGRAFISCAL.PRD_PRDREGRAFSVC
				endif
				;
			endif
			;
		else
			vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC
		endif
	
		if (vCdRegraFiscal = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ o produto %%vCdProduto e a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1] ;---Elia Proj. 061/573 27/03/09
	endif

	clear/e "FIS_REGRAFISCSVC"
	CD_REGRAFISCAL.FIS_REGRAFISCSVC/init = CD_REGRAFISCAL.GER_OPERACAOSVC
	retrieve/e "FIS_REGRAFISCSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Regra fiscal %%vCdRegraFiscal não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	if (vInProdPropria = <TRUE>)
		vCdCFOPOperacao = CD_CFOPPROPRIA.FIS_REGRAFISCSVC
	else
		vCdCFOPOperacao = CD_CFOPTERCEIRO.FIS_REGRAFISCSVC
	endif
	vCdCSTOperacao = CD_CST.FIS_REGRAFISCSVC[1 : 2]

	clear/e "FIS_REGRAFISCSVC"
	CD_REGRAFISCAL.FIS_REGRAFISCSVC/init = vCdRegraFiscal
	retrieve/e "FIS_REGRAFISCSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Regra fiscal %%vCdRegraFiscal não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	else
		;---Elia Proj. 61/302 08/04/08
		if (CD_DECRETO.FIS_REGRAFISCSVC = 2155)
			;---Elia Proj. 61/359 28/05/08
			if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "RS") | ($dsUFOrigem$ = "SC")
				if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; 4 - Venda/Compra
			;
					if ($dsUFDestino$ = "PR") | ($dsUFDestino$ = "RS") | ($dsUFDestino$ = "SC")
						if (TP_OPERACAO.GER_OPERACAOSVC = "S") ; S - Saida
							if (vInProdPropria = <TRUE>)
								vCdCFOP = 5401
							else
								vCdCFOP = 5403
							endif
						else
							;---Elia/Deusdete 06/08/08
							if (vInProdPropria = <TRUE>)
								vCdCFOP = 1401
							else
								vCdCFOP = 1403
							endif
							;
						endif
						vInDecreto = <TRUE>
					endif
				endif
			endif
		;---Elia Proj. 61/315 22/04/08 ;ANO Pjt91 Trf310 - 08/01/2009
		elseif (CD_DECRETO.FIS_REGRAFISCSVC = 1020 | CD_DECRETO.FIS_REGRAFISCSVC = 10201 | CD_DECRETO.FIS_REGRAFISCSVC = 10202 | CD_DECRETO.FIS_REGRAFISCSVC = 10203) ;ANO Pjt91 Trf310 - 08/01/2009
			;---Elia Proj. 61/359 28/05/08
			;if ($dsUFOrigem$ = "SC")
			;---Elia Proj. 91/336 02/02/09
			if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "SC") | ($dsUFOrigem$ = "MG")
				if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; 4 - Venda/Compra
					;---Elia Proj. 91/336 02/02/09
					if ($dsUFDestino$ = "PR") | ($dsUFDestino$ = "SC")  | ($dsUFDestino$ = "MG")
					;
						if (TP_OPERACAO.GER_OPERACAOSVC = "S") ; S - Saida
							if (vInProdPropria = <TRUE>)
								vCdCFOP = 5401
							else
								vCdCFOP = 5403
							endif
						else
							;---Elia/Deusdete 06/08/08
							if (vInProdPropria = <TRUE>)
								vCdCFOP = 1401
							else
								vCdCFOP = 1403
							endif
							;
						endif
						vInDecreto = <TRUE>
					endif
				endif
			endif
		elseif (CD_DECRETO.FIS_REGRAFISCSVC = 45471)
			;---Elia Proj. 61/359 28/05/08
			if ($dsUFOrigem$ = "RS") | ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "SC")
				if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4); 4 - Venda/Compra
					if ($dsUFDestino$ = "PR") | ($dsUFDestino$ = "RS") | ($dsUFDestino$ = "SC")
						if (TP_OPERACAO.GER_OPERACAOSVC = "S") ; S - Saida
							if (vInProdPropria = <TRUE>)
								vCdCFOP = 5401
							else
								vCdCFOP = 5403
							endif
						else
							;---Elia/Deusdete 06/08/08
							if (vInProdPropria = <TRUE>)
								vCdCFOP = 1401
							else
								vCdCFOP = 1403
							endif
							;
						endif
						vInDecreto = <TRUE>
					endif
				endif
			endif
		;---Elia Proj. 61/363 03/06/08
		elseif (CD_DECRETO.FIS_REGRAFISCSVC = 23731) | (CD_DECRETO.FIS_REGRAFISCSVC = 23732) | (CD_DECRETO.FIS_REGRAFISCSVC = 23733) | %\
			   (CD_DECRETO.FIS_REGRAFISCSVC = 23734) | (CD_DECRETO.FIS_REGRAFISCSVC = 23735)

			if ($dsUFOrigem$ = "PR") | ($dsUFDestino$ = "PR")
				if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; 4 - Venda/Compra
					if (TP_OPERACAO.GER_OPERACAOSVC = "S") ; S - Saida
						if (vInProdPropria = <TRUE>)
							vCdCFOP = 5401
						else
							vCdCFOP = 5403
						endif
					else
						;---Elia/Deusdete 06/08/08
						if (vInProdPropria = <TRUE>)
							vCdCFOP = 1401
						else
							vCdCFOP = 1403
						endif
					endif
					vInDecreto = <TRUE>
				endif
			endif
		endif
	endif	

	if (vInDecreto = <FALSE>)
		if (vInProdPropria = <TRUE>)
			vCdCFOP = CD_CFOPPROPRIA.FIS_REGRAFISCSVC
		else
			vCdCFOP = CD_CFOPTERCEIRO.FIS_REGRAFISCSVC
		endif

		if (vTpAreaComercio > 0)
			;---Elia Proj. 61/509 26/11/08
			if (vTpAreaComercio = 2) & (vTpAreaComercioOrigem = 2) ; 2 - Manaus
			else
				if (TP_OPERACAO.GER_OPERACAOSVC = "S") & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ;Venda
					;---Elia Proj. 061/573 25/03/09
					vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
					if (vCdCST = 1); | (vCdCST = 2) - VSOUZA PRJ/TAR 189/017 21/09/2011 ; Produto importado
						if (vInProdPropria = <TRUE>)
							vCdCFOP = 5101
						else
							vCdCFOP = 5102
						endif
					else
						if (vInProdPropria = <TRUE>)
							vCdCFOP = 5109
						else
							vCdCFOP = 5110
						endif
					endif
				endif
			endif
		endif
	endif

	;---Elia Proj. 130/360 27/02/09
	if ($cdServico$ > 0)
		viParams = ""
		putitem/id viParams, "CD_REGRAFISCAL", vCdRegraFiscal
		activate "FISSVCO033".buscaDadosRegraFiscal($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif	
		
		vCdCFOPServico = $item("CD_CFOPSERVICO", voParams)
		if (vCdCFOPServico != 0)
			vCdCFOP = vCdCFOPServico
		endif
	else
		if (CD_CST.FIS_REGRAFISCSVC[1 : 2] = 60)	
			vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
			;-- MAD [Proj/Tar.061/917] - 18/01/2011
			;if ($dsUFOrigem$ != $dsUFDestino$) & ($inContribuinte$ = <TRUE>)
			;	vCdCST = "%%vCdCST%%%10"
			if ($dsUFOrigem$ != $dsUFDestino$) 
				if ($inContribuinte$ = <TRUE>)
					vCdCST  = "%%vCdCST%%%10"
				else
					vCdCST  = "%%vCdCST%%vCdCSTOperacao"
					vCdCFOP = vCdCFOPOperacao
				endif
			;;
			else
				vCdCST = "%%vCdCST%%%60"
			endif
		endif

		if (vInDecreto = <FALSE>) ; Deusdete - 24/03/2010 - Só chamar este serviço se não tiver decreto na regra
			if (CD_CST.FIS_REGRAFISCSVC[1 : 2] = 10) | (vCdCST[1 : 2] = 10)
				vTpOperacao = ""
				; Alterado por Deusdete em 16/07/2009 c/ anuência do Marcio (Não pode ser a mesma lógica quanto a origem emissão)
				;if (TP_OPERACAO.GER_OPERACAOSVC = "E") | (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S") ; 3 - Devolucao de compra
				;	vTpOperacao = "E" 
				;elseif (TP_OPERACAO.GER_OPERACAOSVC = "S") | (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "E") ; ; 3 - Devolucao de venda
				;	vTpOperacao = "S"
				;endif
				vTpOperacao = TP_OPERACAO.GER_OPERACAOSVC

				viParams = ""
				putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.PRD_PRODUTOSVC
				putitem/id viParams, "UF_ORIGEM", $dsUFOrigem$
				putitem/id viParams, "UF_DESTINO", $dsUFDestino$
				putitem/id viParams, "TP_OPERACAO", vTpOperacao
				activate "FISSVCO035".buscaDadosFiscalProduto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$		
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$	
					return(-1)
				endif
				vPrIvaPrd = $item("PR_SUBSTRIB", voParams)
	
				if (vPrIvaPrd = 0)
					vCdCFOP = vCdCFOPOperacao
				endif
			endif
		endif
	endif
	
	if (TP_OPERACAO.GER_OPERACAOSVC = "E") ;Entrada
		if (vCdCFOP >= 4000)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=CFOP %%vCdCFOP do produto %%vCdProduto incompatível com a operação de entrada %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
		
		if (vCdCFOP < 3000) ;Somente CFOP nacionais
			if ($dsUFOrigem$ = $dsUFDestino$)
				if (vCdCFOP >= 2000)
					vCdCFOP = vCdCFOP - 1000
				endif
			else
				if (vCdCFOP < 2000)
					vCdCFOP = vCdCFOP + 1000
				endif
			endif	
		endif
	else		
		if (vCdCFOP < 5000)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=CFOP %%vCdCFOP do produto %%vCdProduto incompatível com a operação de saída %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif

		if (vCdCFOP < 7000) ;Somente CFOP nacionais
			if ($dsUFOrigem$ = $dsUFDestino$)
				if (vCdCFOP >= 6000)
					vCdCFOP = vCdCFOP - 1000
				endif
			elseif ($dsUFOrigem$ != $dsUFDestino$) & ($dsUFDestino$ != "EX")
				if (vCdCFOP < 6000)
					vCdCFOP = vCdCFOP + 1000
				endif
			endif	
		endif
	endif

	if (vCdCFOP = 6101) & ($inContribuinte$ = <FALSE>)
		vCdCFOP = 6107
	endif

	if (vCdCFOP = 6102) & ($inContribuinte$ = <FALSE>)
		vCdCFOP = 6108
	endif	

	; Deusdete - 19/05/2006
	if (CD_CST.FIS_REGRAFISCSVC[1 : 2] = 70)
		if ($dsUFOrigem$ = "GO")
			if ($dsUFOrigem$ != $dsUFDestino$ | vInProdPropria != <TRUE> | $inContribuinte$ != <TRUE>)
				if (vCdCFOP = 5405) 		  ; Como a regra fiscal esta como a CFOP generica 06, pois toda venda p/
					if (vInProdPropria = <TRUE>)  ; não contribuinte deverá sair com o CFOP interno de venda
 						vCdCFOP = 5101 
					else
						vCdCFOP = 5102 
					endif
				endif
				if (vCdCFOP = 6401) 		   
					if ($inContribuinte$ = <TRUE>)   
 						vCdCFOP = 6101 		  ; Condição implementada por Deusdete em 19/05/2006, pois toda venda p/
					else
						vCdCFOP = 6107 
					endif
				endif
			endif
		endif
	endif

	if (CD_CST.FIS_REGRAFISCSVC[1 : 2] = 60)
		if ($dsUFOrigem$ = "GO")
			if ($dsUFOrigem$ != $dsUFDestino$ | vInProdPropria != <TRUE>)
				if (vCdCFOP = 6405) 		   
					vCdCFOP = 6404 		 
				endif
			endif
		endif
	endif

	;---Elia Proj. 61/299 02/04/08
	if (vCdCFOP = 6405)
		vCdCFOP = 6403
	endif
	;

	;-- MAD [Proj/Tar.175/243] - 20/10/2011
	if ($dsUFDestino$ = "EX") | ($dsUFOrigem$ = "EX")
		viParams = ""
		putitem/id viParams, "CD_REGRAFISCAL", vCdRegraFiscal
		activate "FISSVCO033".buscaCfopExterior($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		if (vInProdPropria = <TRUE>)
			vCdCFOP = $item("CD_CFOPEXPRO", voParams)
		else
			vCdCFOP = $item("CD_CFOPEXTER", voParams)
		endif
	endif
	;;

	poParams = ""
	putitem/id poParams, "CD_CFOP", vCdCFOP	
	
	return(0)
end ; operation buscaCFOP

;-------------------------
public operation buscaCST
;-------------------------
	params
		string  xlpg        :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams

	variables
		string  viParams, voParams, vDsLstEmpresa, vCdCST, vCdMPTer, vTpOperacao, vCdCSTOperacao, vDsUF, vInOptSimples
		numeric vCdEmpresa, vCdEmpresaParam, vCdProduto, vCdOperacao, vCdPessoa, vCdCFOP
		numeric vCdRegraFiscal, vTpAreaComercio, vTpAreaComercioOrigem, vPrIvaPrd
		boolean vInProdPropria, vInDecreto, vInOrgaoPublico, vInPrReducao
	endvariables

	$xlpg$						= xlpg
	$dsUFOrigem$				= $item("UF_ORIGEM", $xlpg$)
;--> VSOUZA PRJ/TAR 189/015 21/09/2011
	vInOptSimples				= $item("IN_OPT_SIMPLES", $xlpg$)
	if (vInOptSimples = "S")
		$inOptSimples$ = <TRUE>
	else
		$inOptSimples$ = <FALSE>
	endif
;-------------------------------------->
	$dsUFDestino$				= $item("UF_DESTINO", piParams)
	vCdProduto 					= $item("CD_PRODUTO", piParams)
	vCdMPTer						= $item("CD_MPTER", piParams)
	$cdServico$					= $item("CD_SERVICO", piParams)
	vCdPessoa					= $item("CD_PESSOA", piParams)
	vCdOperacao					= $item("CD_OPERACAO", piParams)
	vTpAreaComercio			= $item("TP_AREACOMERCIO", piParams)
	vTpAreaComercioOrigem	= $item("TP_AREA_COMERCIO_ORIGEM", $xlpg$) ;---Elia Proj. 61/509 25/11/08
	vCdCFOP 						= $item("CD_CFOP", piParams) ;thamati 05/11/2009 [Proj. 0061 - Tar. 0692]
	vCdEmpresaParam 			= $item("CD_EMPRESA", piParams)
	if (vCdEmpresaParam = 0)
		vCdEmpresaParam 		= $item("CD_EMPRESA", $xlpg$)
	endif
	$TpModDctoFiscal$ 		= $item("TP_MODDCTOFISCAL", piParams)
	$tpOrigemEmissao$ 		= $item("TP_ORIGEMEMISSAO", piParams) ;1 - Própria / 2 - Terceiros
	$inContribuinte$ 			= ""
	vInDecreto 					= <FALSE>

	if (vCdOperacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação não informada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	if (vCdPessoa = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa não informada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	clear/e "GER_OPERACAOSVC"
	CD_OPERACAO.GER_OPERACAOSVC/init = vCdOperacao
	retrieve/e "GER_OPERACAOSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação %%vCdOperacao não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	if (vCdProduto = 0) & (vCdMPTer = "") & ($cdServico$ = 0)
		return(0)
	endif

	;thamati 05/11/2009 [Proj. 0061 - Tar. 0692]
	if (vCdCFOP = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=CFOP não informada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif
	;

	if (vCdMPTer != "")
		clear/e "CDF_MPTERSVC"
		CD_PESSOA.CDF_MPTERSVC/init	= vCdPessoa
		CD_MPTER.CDF_MPTERSVC/init	= vCdMPTer
		retrieve/e "CDF_MPTERSVC"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Matéria-prima %%vCdMPTer não cadastrada para a pessoa %%vCdPessoa%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
	else
		clear/e "PRD_PRODUTOSVC"	
		CD_PRODUTO.PRD_PRODUTOSVC/init = vCdProduto
		retrieve/e "PRD_PRODUTOSVC"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Produto %%vCdProduto não cadastrado!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
	endif

	clear/e "GER_OPERACAOSVC"
	CD_OPERACAO.GER_OPERACAOSVC/init = vCdOperacao
	retrieve/e "GER_OPERACAOSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação %%vCdOperacao não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	clear/e "FIS_REGRAFISCSVC"
	CD_REGRAFISCAL.FIS_REGRAFISCSVC/init = CD_REGRAFISCAL.GER_OPERACAOSVC
	retrieve/e "FIS_REGRAFISCSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Regra fiscal %%vCdRegraFiscal não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif
	vCdCSTOperacao = CD_CST.FIS_REGRAFISCSVC[1 : 2]
	clear/e "FIS_REGRAFISCSVC"

	clear/e "PES_PESSOASVC"
	CD_PESSOA.PES_PESSOASVC/init = vCdPessoa
	retrieve/e "PES_PESSOASVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa %%vCdPessoa não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	;-- MAD [Proj/Tar.175/205] - 10/08/2011
	clear/e "PES_PFADICSVC"
	CD_PESSOA.PES_PFADICSVC/init = CD_PESSOA.PES_PESSOASVC
	retrieve/e "PES_PFADICSVC"
	if ($status < 0)
		clear/e "PES_PFADICSVC"
	endif
	;;
	if (TP_OPERACAO.GER_OPERACAOSVC = "S" & TP_MODALIDADE.GER_OPERACAOSVC = 4) | (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 3) ;Venda / Devolução de venda
		setocc "PES_CLIENTESVC", 1
		if (!$dbocc("PES_CLIENTESVC"))
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cliente %%vCdPessoa não cadastrado!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
	endif

	; Implementado por Deusdete em 22/03/2007, situação emergencial na Krindges
	; Se for pessoa Jurídica e não tiver inscrição estadual, isto é, Isento, deverá ser tratado para fazer o cálculo do imposto
	; com a alíquota interna.
	$inPjIsento$ = <False>
	if (NR_INSCESTL.PES_PESJURIDISVC = "ISENTO")  | (NR_INSCESTL.PES_PESJURIDISVC = "ISENTA") | %\
       (NR_INSCESTL.PES_PESJURIDISVC = "ISENTOS") | (NR_INSCESTL.PES_PESJURIDISVC = "ISENTAS")
		$inPjIsento$ = <TRUE>
	endif

	;---Elia Proj. 061/650 22/07/09
	if ($tpOrigemEmissao$ = 2) ;Terceiros
		if (TP_MODALIDADE.GER_OPERACAOSVC != 3) ;Devolução
			vDsUF = $dsUFOrigem$
			$dsUFOrigem$	= $dsUFDestino$
			$dsUFDestino$	= vDsUF
		endif
	else
		if (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S") ;Devolução compra
			vDsUF = $dsUFOrigem$
			$dsUFOrigem$	= $dsUFDestino$
			$dsUFDestino$	= vDsUF			
		endif
	endif
	;
	;---Elia Proj. 61/542 02/02/09
	viParams = ""
	putitem/id viParams, "CD_PESSOA", vCdPessoa
	activate "FCRSVCO057".validaPessoaOrgaoPublico($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif    
	vInOrgaoPublico = $item("IN_ORGAOPUBLICO", voParams)

	if (vInOrgaoPublico = <TRUE>) & ($dsUFOrigem$ = "DF")
		$inContribuinte$ = <TRUE>
	else
		if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) | (TP_PESSOA.PES_PESSOASVC = "F") | ($inPjIsento$ = <TRUE>)
			;---Elia Proj. 61/577 14/04/09
			if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) & (TP_PESSOA.PES_PESSOASVC = "J") & ($inPjIsento$ = <FALSE>)
				$inContribuinte$ = <TRUE>
			else
				;---Elia Proj. 61/196 28/11/07
				;---Elia Proj. 061/625 29/06/09 Inclusao do RS.
				if (TP_PESSOA.PES_PESSOASVC = "F") & (NR_CODIGOFISCAL.PES_CLIENTESVC != "") & ($dsUFOrigem$ = "PR" | $dsUFOrigem$ = "SP" | $dsUFOrigem$ = "RS")
					$inContribuinte$ = <TRUE>
				else
					$inContribuinte$ = <FALSE>
				endif
			endif
		else
			$inContribuinte$ = <TRUE>
		endif
	endif
	;

	;---Elia Proj. 061/650 22/07/09
	;if ($inContribuinte$ = <FALSE>) & ($dsUFDestino$ != "EX")
	;	$dsUFDestino$ = $dsUFOrigem$
	;endif
	;

	vCdRegraFiscal = 0
	
	if ($cdServico$ > 0)
		vInProdPropria = <FALSE>
		vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC
		if (vCdRegraFiscal = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
		vCdCST = "0"
	elseif (vCdMPTer != "")
		vInProdPropria = <FALSE>
		vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC
		if (vCdRegraFiscal = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
		vCdCST = CD_CST.CDF_MPTERSVC[1 : 1]
	else
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", vCdEmpresaParam
		putitem/id viParams, "CD_PRODUTO", vCdProduto    
		activate "PRDSVCO008".buscaDadosFilial($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif

		vInProdPropria = $item("IN_PRODPROPRIA", voParams)	

		clear/e "PRD_PRDREGRAFSVC"
		CD_PRODUTO.PRD_PRDREGRAFSVC/init	= vCdProduto
		CD_OPERACAO.PRD_PRDREGRAFSVC/init	= vCdOperacao
		retrieve/e "PRD_PRDREGRAFSVC"
		if ($status >= 0)
			;---Elia 05/03/09 - Sem tarefa
			clear/e "FIS_REGRAFISCSVC"
			CD_REGRAFISCAL.FIS_REGRAFISCSVC/init = CD_REGRAFISCAL.PRD_PRDREGRAFSVC
			retrieve/e "FIS_REGRAFISCSVC"
			if ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Regra fiscal %%vCdRegraFiscal não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
				poCdErro		= $xCdErro$
				poCtxErro	= $xCtxErro$
				return(-1)
			else
				if (CD_DECRETO.FIS_REGRAFISCSVC = 2155) | (CD_DECRETO.FIS_REGRAFISCSVC = 1020) | (CD_DECRETO.FIS_REGRAFISCSVC = 45471) | %\
					(CD_DECRETO.FIS_REGRAFISCSVC = 23731) | (CD_DECRETO.FIS_REGRAFISCSVC = 23732) | (CD_DECRETO.FIS_REGRAFISCSVC = 23733) | %\
					(CD_DECRETO.FIS_REGRAFISCSVC = 23734) | (CD_DECRETO.FIS_REGRAFISCSVC = 23735) | %\	
					(CD_DECRETO.FIS_REGRAFISCSVC = 10201) | (CD_DECRETO.FIS_REGRAFISCSVC = 10202) | (CD_DECRETO.FIS_REGRAFISCSVC = 10203);;ANO Pjt91 Trf310 - 08/01/2009	
					;---Elia Proj. 61/276 07/04/08
					if ($inContribuinte$ = <TRUE>)
						vCdRegraFiscal = CD_REGRAFISCAL.PRD_PRDREGRAFSVC
					else
						vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC
					endif
				else
					vCdRegraFiscal = CD_REGRAFISCAL.PRD_PRDREGRAFSVC
				endif
			endif
		else
			vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC
		endif	

		if (vCdRegraFiscal = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ o produto %%vCdProduto e a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif

		vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
	endif

	clear/e "FIS_REGRAFISCSVC"
	CD_REGRAFISCAL.FIS_REGRAFISCSVC/init = vCdRegraFiscal
	retrieve/e "FIS_REGRAFISCSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Regra fiscal %%vCdRegraFiscal não cadastrada!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	else
		;---Elia Proj. 61/302 08/04/08
		if (CD_DECRETO.FIS_REGRAFISCSVC = 2155)
			;---Elia Proj. 61/359 28/05/08
			if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "RS") | ($dsUFOrigem$ = "SC")
				if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; 4 - Venda/Compra
			;
					if ($dsUFDestino$ = "PR") | ($dsUFDestino$ = "RS") | ($dsUFDestino$ = "SC")
						vCdCST 		= CD_CST.PRD_PRODUTOSVC[1 : 1]
						vCdCST 		= "%%vCdCST%%%10"
						vInDecreto	= <TRUE>
					endif
				endif
			endif
		;---Elia Proj. 61/315 22/04/08
		elseif (CD_DECRETO.FIS_REGRAFISCSVC = 1020) | (CD_DECRETO.FIS_REGRAFISCSVC = 10201) | (CD_DECRETO.FIS_REGRAFISCSVC = 10202) | (CD_DECRETO.FIS_REGRAFISCSVC = 10203);;ANO Pjt91 Trf310 - 08/01/2009
			;---Elia Proj. 61/359 28/05/08
			;if ($dsUFOrigem$ = "SC")
			;---Elia Proj. 91/336 02/02/09
			if ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "SC") | ($dsUFOrigem$ = "MG")
				if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ; 4 - Venda/Compra
					;---Elia Proj. 91/336 02/02/09
					if ($dsUFDestino$ = "PR") | ($dsUFDestino$ = "SC") | ($dsUFDestino$ = "MG")
						vCdCST 		= CD_CST.PRD_PRODUTOSVC[1 : 1]
						vCdCST 		= "%%vCdCST%%%10"
						vInDecreto	= <TRUE>
					endif
				endif
			endif
		elseif (CD_DECRETO.FIS_REGRAFISCSVC = 45471)
			;---Elia Proj. 61/359 28/05/08
			if ($dsUFOrigem$ = "RS") | ($dsUFOrigem$ = "PR") | ($dsUFOrigem$ = "SC")
				if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4); 4 - Venda/Compra
					if ($dsUFDestino$ = "PR") | ($dsUFDestino$ = "RS") | ($dsUFDestino$ = "SC")
						vCdCST 		= CD_CST.PRD_PRODUTOSVC[1 : 1]
						vCdCST 		= "%%vCdCST%%%10"
						vInDecreto	= <TRUE>
					endif
				endif
			endif
		;---Elia Proj. 61/363 03/06/08
		elseif (CD_DECRETO.FIS_REGRAFISCSVC = 23731) | (CD_DECRETO.FIS_REGRAFISCSVC = 23732) | (CD_DECRETO.FIS_REGRAFISCSVC = 23733) | %\
			   (CD_DECRETO.FIS_REGRAFISCSVC = 23734) | (CD_DECRETO.FIS_REGRAFISCSVC = 23735)
			if ($dsUFOrigem$ = "PR") | ($dsUFDestino$ = "PR")
				if ($inContribuinte$ = <TRUE>) & (TP_MODALIDADE.GER_OPERACAOSVC = 4); 4 - Venda/Compra
					vCdCST 		= CD_CST.PRD_PRODUTOSVC[1 : 1]
					vCdCST 		= "%%vCdCST%%%10"
					vInDecreto	= <TRUE>
				endif
			endif
		endif
		;
	endif

	if (vInDecreto = <FALSE>)
		vCdCST = "%%vCdCST%%CD_CST.FIS_REGRAFISCSVC[1 : 2]"
		if (vTpAreaComercio > 0)
			;---Elia Proj. 61/509 26/11/08
			if (vTpAreaComercio = 2) & (vTpAreaComercioOrigem = 2) ; 2 - Manaus
			else
				if (TP_OPERACAO.GER_OPERACAOSVC = "S") & (TP_MODALIDADE.GER_OPERACAOSVC = 4) ;Venda
					vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
					;---Elia Proj. 061/573 25/03/09
					if (vCdCST = 1) | (vCdCST = 2) ; Produto inportado
						vCdCST = "%%vCdCST%%%00"
					else
						vCdCST = "%%vCdCST%%%40"
					endif
					;
				endif
			endif
			;
		endif

		if (CD_CST.FIS_REGRAFISCSVC[1 : 2] = 70)
			if ($dsUFOrigem$ = "GO")
				if ($dsUFOrigem$ != $dsUFDestino$ | vInProdPropria != <TRUE> | $inContribuinte$ != <TRUE>) ; Deusdete - 18/05/2006
					vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
					vCdCST = "%%vCdCST%%%00"
				endif
			endif
		endif

		if (CD_CST.FIS_REGRAFISCSVC[1 : 2] = 60)	
			vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
			;-- MAD [Proj/Tar.061/917] - 18/01/2011
			;if ($dsUFOrigem$ != $dsUFDestino$) & ($inContribuinte$ = <TRUE>)
			;	vCdCST = "%%vCdCST%%%10"
			if ($dsUFOrigem$ != $dsUFDestino$) 
				if ($inContribuinte$ = <TRUE>)
					vCdCST  = "%%vCdCST%%%10"
				else
					vCdCST  = "%%vCdCST%%vCdCSTOperacao"
				endif
			;;
			else
				vCdCST = "%%vCdCST%%%60"
			endif
		endif

		if (CD_CST.FIS_REGRAFISCSVC[1 : 2] = 10) | (vCdCST[2 : 2] = "10")

			vTpOperacao = ""
			; Alterado por Deusdete em 16/07/2009 c/ anuência do Marcio (Não pode ser a mesma lógica quanto a origem emissão)
			;if (TP_OPERACAO.GER_OPERACAOSVC = "E") | (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S") ; 3 - Devolucao de compra
			;	vTpOperacao = "E" 
			;elseif (TP_OPERACAO.GER_OPERACAOSVC = "S") | (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "E") ; ; 3 - Devolucao de venda
			;	vTpOperacao = "S"
			;endif
			vTpOperacao = TP_OPERACAO.GER_OPERACAOSVC

			viParams = ""
			putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.PRD_PRODUTOSVC
			putitem/id viParams, "UF_ORIGEM", $dsUFOrigem$
			putitem/id viParams, "UF_DESTINO", $dsUFDestino$
			putitem/id viParams, "TP_OPERACAO", vTpOperacao
			activate "FISSVCO035".buscaDadosFiscalProduto($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro		= $xCdErro$
				poCtxErro	= $xCtxErro$		
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro		= $xCdErro$
				poCtxErro	= $xCtxErro$	
				return(-1)
			endif

			vPrIvaPrd = $item("PR_SUBSTRIB", voParams)

			if (vPrIvaPrd = 0)
				vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
				vCdCST = "%%vCdCST%%vCdCSTOperacao"
			elseif (vCdCST[2 : 2] != "10")
				vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
				vCdCST = "%%vCdCST%%CD_CST.FIS_REGRAFISCSVC[1 : 2]"
			endif
		endif

		;-- MAD [Proj/Tar.061/790] - 05/04/2010
		if ($inContribuinte$ = <TRUE>) & (vCdCST[2 : 2] = "20")
			vInPrReducao = <FALSE>

			if (TP_REDUCAO.FIS_REGRAFISCSVC = "A")
				if ($dsUFOrigem$ = $dsUFDestino$)
					vInPrReducao = <TRUE>
				endif

			elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "B")
				if ($dsUFOrigem$ = $dsUFDestino$)
					vInPrReducao = <TRUE>
				endif

			elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "C")
				if ($dsUFOrigem$ = $dsUFDestino$)
					vInPrReducao = <TRUE>
				endif

			elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "D")
				if ($dsUFOrigem$ != $dsUFDestino$)
					vInPrReducao = <TRUE>
				endif

			elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "E")
				if ($dsUFOrigem$ != $dsUFDestino$)
					vInPrReducao = <TRUE>
				endif

			elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "F")
				if ($dsUFOrigem$ != $dsUFDestino$)
					vInPrReducao = <TRUE>
				endif

			elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "G")
				vInPrReducao = <TRUE>

			elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "H")
				vInPrReducao = <TRUE>

			elseif (TP_REDUCAO.FIS_REGRAFISCSVC = "I")
				vInPrReducao = <TRUE>
			endif
		
			if (vInPrReducao = <FALSE>)
				vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
				vCdCST = "%%vCdCST%%%00"
			endif
		endif
		;;
	endif
	
	;thamati 19/10/2009 [Proj. 0061 - Tar. 0692]
	if (vCdCFOP = 5912 | vCdCFOP = 1912)   
		vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
		;-- MAD [Proj/Tar.175/186] - 15/07/2011
		if ($inOptSimples$ = <TRUE>)
			vCdCST = "%%vCdCST%%%41"
		else
		;;
			vCdCST = "%%vCdCST%%%50"
		endif
	elseif (vCdCFOP = 6912 | vCdCFOP = 2912)
		vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
		;-- MAD [Proj/Tar.175/186] - 15/07/2011
		if ($inOptSimples$ = <TRUE>)
			vCdCST = "%%vCdCST%%%41"
		else
		;;
			vCdCST = "%%vCdCST%%%00"
		endif
	endif
	;
	;--- Alterado por Deusdete em caráter de urgência com anuência do Eliã (10/06/2009)
	if ((IN_CNSRFINAL.PES_CLIENTESVC = <TRUE> | $inContribuinte$ = <FALSE>) & vCdCST[2 : 2] = "10")
		;-- MAD [Proj/Tar.061/723] - 02/12/2009
		if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE> & $inContribuinte$ = <TRUE>) | %\
		   (IN_AMBULANTE.PES_PFADICSVC = <TRUE>) ;-- MAD [Proj/Tar.175/205] - 10/08/2011
		else
		;;
			vCdCST = CD_CST.PRD_PRODUTOSVC[1 : 1]
			vCdCST = "%%vCdCST%%%60"
		endif
	endif
	;
	if ($cdServico$ > 0) & (IN_ISS.FIS_REGRAFISCSVC = <TRUE>)
		vCdCST = "090"
	endif

	clear/e "FIS_CSTSVC"
	CD_CST.FIS_CSTSVC/init = vCdCST
	retrieve/e "FIS_CSTSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=CST %%vCdCST não cadastrado!", "ADICIONAL=Operação->FISSVCO015.buscaCST")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif	

	poParams = ""
	putitem/id poParams, "CD_CST", vCdCST

	return(0)
end ; operation buscaCST

;----------------------------------
public operation calculaImpostoCapa
;----------------------------------

	params
		string  xlpg        :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams

	variables
		string  viParams, voParams, vDsUF, vDsRegistro, vDsLstImposto, vDsLstCdImposto, vCdCST, vNmMunicipio
		numeric vCdEmpresa, vCdEmpresaParam, vCdOperacao, vCdPessoa, vCdRegraFiscal, vNrSeqEnd, vCdProduto
		numeric vVlCalc, vVlBaseCalc, vCdImposto, vVlFrete, vVlSeguro, vVlDespAcessor, vCdDecreto, vCdImpRetorno
		boolean vInIPI, vInSomaFrete, vInOrgaoPublico, vInSubstituicao
		date    vDtSistema, vDtIniVigencia, vDtFimVigencia, vDtVigencia
	endvariables

	poParams	= ""
	$xlpg$	= xlpg

	vCdEmpresa = $item("CD_EMPRESA", piParams)
	if (vCdEmpresa = 0)
		vCdEmpresa = $item("CD_EMPRESA", $xlpg$)
	endif

	$dsUFOrigem$            = $item("UF_ORIGEM", $xlpg$)
	$dsUFDestino$           = $item("UF_DESTINO", piParams)
	$tpOrigemEmissao$       = $item("TP_ORIGEMEMISSAO", piParams) ;1 - Própria / 2 - Terceiros
	vCdOperacao             = $item("CD_OPERACAO", piParams)
	vCdPessoa               = $item("CD_PESSOA", piParams)
	vCdProduto              = $item("CD_PRODUTO", piParams) ;---Elia Proj. 061/571 30/03/09
	vVlFrete                = $item("VL_FRETE", piParams)
	vVlSeguro               = $item("VL_SEGURO", piParams)
	vVlDespAcessor          = $item("VL_DESPACESSOR", piParams)
	vCdCst                  = $item("CD_CST", piParams) ;---Elia Proj. 61/198 19/11/07
	vInIPI                  = $item("IN_IPI", piParams) ;---Elia Proj. 61/198 19/11/07
	$prIPI$                 = $item("PR_IPI", piParams) ;---Elia Proj. 61/198 19/11/07
	$cdDecretoItemCapa$     = $item("CD_DECRETO", piParams) ;---Elia Proj. 61/276 28/03/08
	vDtSistema              = $item("DT_SISTEMA", $xlpg$)   ;---Elia Proj. 61/276 28/03/08
	$tpAreaComercioOrigem$  = $item("TP_AREA_COMERCIO_ORIGEM", $xlpg$) ;---Elia Proj. 61/509 25/11/08
	$tpAreaComercioDestino$ = ""
	$inContribuinte$        = ""
	vInSubstituicao         = <FALSE>
	
;	======= CFC: Tar. 192 Pj. 61 - 09/11/2007  
   $VlFrete$			= $item("VL_FRETE", piParams)
	$VlSeguro$			= $item("VL_SEGURO", piParams)
	$VlDespAcessor$	= $item("VL_DESPACESSOR", piParams)
;	=================

	if (vVlFrete = 0) & (vVlSeguro = 0) & (vVlDespAcessor = 0) 
		return(0)
	endif

	if ($tpOrigemEmissao$ = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Tipo emissão não informado!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	if ($dsUFDestino$ = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=UF destino não informada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif
	
	if (vCdOperacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação não informada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	clear/e "PRD_PRODUTOSVC"

	clear/e "GER_OPERACAOSVC"
	CD_OPERACAO.GER_OPERACAOSVC/init = vCdOperacao
	retrieve/e "GER_OPERACAOSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação %%vCdOperacao não cadastrada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	if (IN_CALCIMPOSTO.GER_OPERACAOSVC != <TRUE>)
		return(0)
	endif

	;---Elia Proj. 061/571 30/03/09
	; Carrega o codigo do primeiro produto da nota fiscal para a nova logica de Subst. tributaria.
	if (vCdProduto != 0)
		clear/e "PRD_PRODUTOSVC"	
		CD_PRODUTO.PRD_PRODUTOSVC/init = vCdProduto
		retrieve/e "PRD_PRODUTOSVC"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Produto %%vCdProduto não cadastrado!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif

		;Incluído por Deusdete, para calcular corretamente o imposto sobre os valores da capa (23/02/2010)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", vCdEmpresa
		putitem/id viParams, "CD_PRODUTO", vCdProduto    
		activate "PRDSVCO008".buscaDadosFilial($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
		
		$inProdPropria$ = $item("IN_PRODPROPRIA", voParams)
		;
	endif 
	;

	call getParam(vCdEmpresa)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif
	if ($status < 0)
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	clear/e "PES_PESSOASVC"
	CD_PESSOA.PES_PESSOASVC/init = vCdPessoa
	retrieve/e "PES_PESSOASVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa %%vCdPessoa não cadastrada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	if (TP_OPERACAO.GER_OPERACAOSVC = "S" & TP_MODALIDADE.GER_OPERACAOSVC = 4) | (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 3) ;Venda / Devolução de venda
		setocc "PES_CLIENTESVC", 1
		if (!$dbocc("PES_CLIENTESVC"))
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cliente %%vCdPessoa não cadastrado!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
	endif

	$inPjIsento$ = <FALSE>
	if (NR_INSCESTL.PES_PESJURIDISVC = "ISENTO")  | (NR_INSCESTL.PES_PESJURIDISVC = "ISENTA") | %\
       (NR_INSCESTL.PES_PESJURIDISVC = "ISENTOS") | (NR_INSCESTL.PES_PESJURIDISVC = "ISENTAS")
		$inPjIsento$ = <TRUE>
	endif

	;---Elia Proj. 61/309 15/04/08
	$inVarejista$ = <FALSE>
	if (CD_ATIVIDADE.PES_PESJURIDISVC = $cdAtividadeVarejista$) & ($cdAtividadeVarejista$ != "")
		$inVarejista$ = <TRUE>
	endif

	;---Elia Proj. 061/650 22/07/09
	if ($tpOrigemEmissao$ = 2) ;Terceiros
		if (TP_MODALIDADE.GER_OPERACAOSVC != 3) ;Devolução
			vDsUF				= $dsUFOrigem$
			$dsUFOrigem$	= $dsUFDestino$
			$dsUFDestino$	= vDsUF
		endif
	else
		if (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S") ;Devolução compra
			vDsUF				= $dsUFOrigem$
			$dsUFOrigem$	= $dsUFDestino$
			$dsUFDestino$	= vDsUF			
		endif
	endif
	;
	;---Elia Proj. 61/390 01/07/08
	viParams = ""
	putitem/id viParams, "CD_PESSOA", vCdPessoa
	activate "FCRSVCO057".validaPessoaOrgaoPublico($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif    
	vInOrgaoPublico = $item("IN_ORGAOPUBLICO", voParams)
	;---Elia Proj. 61/542 02/02/09
	if (vInOrgaoPublico = <TRUE>) & ($dsUFOrigem$ = "DF")
		$inContribuinte$ = <TRUE>
	else
 		if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) | (TP_PESSOA.PES_PESSOASVC = "F") | ($inPjIsento$ = <TRUE>)
			;---Elia Proj. 61/577 14/04/09
			;;---Elia Proj. 61/364 06/06/08
			;if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) & (TP_PESSOA.PES_PESSOASVC = "J") & ($inPjIsento$ = <FALSE>) & ($dsUFOrigem$ = "MS")
			if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) & (TP_PESSOA.PES_PESSOASVC = "J") & ($inPjIsento$ = <FALSE>)
				$inContribuinte$ = <TRUE>
			else
				;---Elia Proj. 61/196 28/11/07
				;---Elia Proj. 061/625 29/06/09 Inclusao do RS.
				if (TP_PESSOA.PES_PESSOASVC = "F") & (NR_CODIGOFISCAL.PES_CLIENTESVC != "") & ($dsUFOrigem$ = "PR" | $dsUFOrigem$ = "SP" | $dsUFOrigem$ = "RS") 
					$inContribuinte$ = <TRUE>
				else
					$inContribuinte$ = <FALSE>
				endif
				;
			endif
			;
		else
			$inContribuinte$ = <TRUE>
		endif
	endif
	;	
	;---Elia Proj. 91/320 19/01/09
	;;---Elia Proj. 61/509 25/11/08
	;if ($tpAreaComercioOrigem$ = 2) ; 2 - Manaus
	if ($inOptSimples$ = <TRUE>)
		$tpAreaComercioDestino$ = ""
	else
		clear/e "V_PES_ENDFATSVC"
		CD_PESSOA.V_PES_ENDFATSVC/init = vCdPessoa
		retrieve/e "V_PES_ENDFATSVC"
		if ($status >= 0)
			$tpAreaComercioDestino$ = TP_AREA_COMERCIO.V_PES_ENDFATSVC
		endif
	endif
	;
	;   A verificação de pessoa jurídica foi comentado dentro do if e colocado aki, pois estava carregando a variável $tpRegimeOrigem$ somente
	;   quando era emissão de terceiros. Esta variável está sendo usado tbm para emissão própria no cálculo do ICMS.
	;   Por Deusdete em 10/10/2006
	if (TP_PESSOA.PES_PESSOASVC != "F")
		if ($empty("PES_PESJURIDISVC") != 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa %%vCdPessoa não é jurídica!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
			poCdErro		= $xCdErro$
			poCtxErro 	= $xCtxErro$
			return(-1)
		endif
		$tpRegimeOrigem$ = TP_REGIMETRIB.PES_PESJURIDISVC
	endif

	;---Elia Proj. 61/542 03/02/09
	if ($inContribuinte$ = <FALSE>) & ($dsUFDestino$ != "EX")
		$dsUFDestino$ = $dsUFOrigem$
	endif
	;

	if ($dsUFDestino$ = $dsUFOrigem$)
		;Deusdete Proj 111/954 - 15/10/2009
		if ($inSomaFreteBaseICMS$ = <TRUE>)
			vInSomaFrete = <TRUE>
		else
		;
		;---Elia Proj. 061/650 22/07/09
			if ($tpOrigemEmissao$ = 1) & ($inContribuinte$ = <FALSE>) ; 1 -Emissão própria
				vInSomaFrete = <TRUE>
			else
				vInSomaFrete = <FALSE>
			endif
		endif
		;
	else
		vInSomaFrete = <TRUE>
	endif

	vVlBaseCalc = vVlSeguro + vVlDespAcessor
	if (vInSomaFrete = <TRUE>)
		vVlBaseCalc = vVlBaseCalc + vVlFrete
	endif

	$vlTotalLiquido$			= vVlBaseCalc
	$vlTotalLiquidoICMS$	= vVlBaseCalc ;---Elia Proj. 61/461 02/09/08
	$vlTotalBruto$				= vVlSeguro + vVlDespAcessor + vVlFrete

	if ($tpOrigemEmissao$ = 2) ;Terceiros
		vVlCalc = $vlTotalBruto$ * $prIPI$ / 100
		$vlIPI$ = vVlCalc[round, 2]
	endif

	vCdRegraFiscal = 0	
	vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC

	;-- MAD [Proj/Tar.061/775] - 25/02/2010
	clear/e "PRD_PRDREGRAFSVC"
	CD_PRODUTO.PRD_PRDREGRAFSVC/init  = vCdProduto
	CD_OPERACAO.PRD_PRDREGRAFSVC/init = vCdOperacao
	retrieve/e "PRD_PRDREGRAFSVC"
	if ($status >= 0)
		vCdRegraFiscal = CD_REGRAFISCAL.PRD_PRDREGRAFSVC
	endif
	;;
	
	if (vCdRegraFiscal = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	clear/e "FIS_REGRAFISCSVC"
	CD_REGRAFISCAL.FIS_REGRAFISCSVC/init = vCdRegraFiscal
	retrieve/e "FIS_REGRAFISCSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Regra fiscal %%vCdRegraFiscal não cadastrada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif	
		
	;---Elia Proj. 61/198 19/11/07	
	if (vCdCST != "")
		$cdCST$ = vCdCST
	else
		$cdCST$ = "0%%CD_CST.FIS_REGRAFISCSVC" ;Busch proj.61/118
	endif
	;
	;---Elia Proj. 061/631 24/06/09
	vCdCST = $cdCST$[2 : 2]
	if (vCdCST = "10") | (vCdCST = "30") | (vCdCST = "60") | (vCdCST = "70")
		vInSubstituicao = <TRUE>
	endif
	;
	;---Elia Proj. 61/276 17/03/08
	if ($cdDecretoItemCapa$ != 0)
		clear/e "F_FIS_DECRETOSVC"
		CD_DECRETO.F_FIS_DECRETOSVC/init = $cdDecretoItemCapa$
		retrieve/e "F_FIS_DECRETOSVC"
		if ($status >= 0)
			vCdDecreto			= CD_DECRETO.F_FIS_DECRETOSVC
			vDtIniVigencia		= DT_INIVIGENCIA.F_FIS_DECRETOSVC
			vDtFimVigencia		= DT_FIMVIGENCIA.F_FIS_DECRETOSVC
		endif
	else
		if (CD_DECRETO.FIS_DECRETOSVC > 0)
			vCdDecreto			= CD_DECRETO.FIS_DECRETOSVC
			vDtIniVigencia		= DT_INIVIGENCIA.FIS_DECRETOSVC
			vDtFimVigencia		= DT_FIMVIGENCIA.FIS_DECRETOSVC
		endif
	endif

	if (vCdDecreto > 0)
		if (vDtIniVigencia != "") & (vDtSistema < vDtIniVigencia)
			vCdDecreto = ""
		endif
		if (vDtFimVigencia != "") & (vDtSistema > vDtFimVigencia)
			vCdDecreto = ""
		endif
	endif
	;

	clear/e "FIS_ALIQUOTAISVC"
	CD_UFORIGEM.FIS_ALIQUOTAISVC/init	= $dsUFOrigem$
	CD_UFDESTINO.FIS_ALIQUOTAISVC/init	= $dsUFDestino$
	retrieve/e "FIS_ALIQUOTAISVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
		poCdErro = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	;Busch proj.61-113
	clear/e "FIS_IMPOSTOSVC"
	$vlICMS$ = 0

	vDsLstCdImposto = ""
	;---Elia Proj. 61/198 19/11/07
	;Para nao calcular o IPI, ganho de Performance
	if (vInIPI != <FALSE>)
		putitem vDsLstCdImposto, -1, 3
	endif
	;
	putitem vDsLstCdImposto, -1, 1

	;---Elia Proj. 61/276 17/03/08
	if (vCdDecreto = 2155) | (vCdDecreto = 1020) | (vCdDecreto = 45471) | (vCdDecreto = 23731) | (vCdDecreto = 23732) | %\
	   (vCdDecreto = 23733) | (vCdDecreto = 23734) | (vCdDecreto = 23735) | %\
		(vCdDecreto = 10201) | (vCdDecreto = 10202) | (vCdDecreto = 10203) | vInSubstituicao = <TRUE> ;ANO Pjt91 Trf310 - 08/01/2009
		putitem vDsLstCdImposto, -1, 2
	endif
	;
	;-- MAD [Proj/Tar.061/775] - 25/02/2010
	putitem vDsLstCdImposto, -1, 5
	putitem vDsLstCdImposto, -1, 6
	;;

	repeat
		getitem vCdImposto, vDsLstCdImposto, 1
		
		;--> VSOUZA PRJ/TAR 192/013 04/11/2011
		vDtVigencia = ""
		viParams    = ""
		voParams    = ""
		putitem/id viParams, "CD_IMPOSTO"    , vCdImposto
		putitem/id viParams, "DT_INIVIGENCIA", $item("DT_INIVIGENCIA", piParams)			
		activate "FISSVCO069".retornaImposto($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif   

		if (voParams != "")
			vDtVigencia   = $item("DT_INIVIGENCIA", voParams)
			vCdImpRetorno = $item("CD_IMPOSTO"    , voParams)
		;--------------------------------------<

			creocc "FIS_IMPOSTOSVC", -1
			;CD_IMPOSTO.FIS_IMPOSTOSVC/init = vCdImposto ;--> VSOUZA PRJ/TAR 192/013 04/11/2011
			CD_IMPOSTO.FIS_IMPOSTOSVC/init     = vCdImpRetorno
			DT_INIVIGENCIA.FIS_IMPOSTOSVC/init = vDtVigencia
			retrieve/o "FIS_IMPOSTOSVC"
			if ($status = -7)
				retrieve/x "FIS_IMPOSTOSVC"
			elseif ($status = 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Imposto %%vCdImposto não cadastrado!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
				poCdErro		= $xCdErro$
				poCtxErro	= $xCtxErro$
				return(-1)
			endif
	
			selectcase vCdImposto
				case 1 ;ICMS
					call calculaICMS()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				case 2 ;ICMSSubst
					call calculaICMSSubst()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				case 3 ;IPI - Saída é calculado / Entrada é digitado na tela
					call calculaIPI()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				;-- MAD [Proj/Tar.061/775] - 25/02/2010
				case 5 ;COFINS
					call calculaCOFINS()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				case 6 ;PIS/PASEP
					call calculaPIS()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				;;
			endselectcase

		endif
		
		delitem vDsLstCdImposto, 1
	
	until (vDsLstCdImposto = "")

	vDsLstImposto   = ""

	if ($empty("FIS_IMPOSTOSVC") = 0)
		sort/e "FIS_IMPOSTOSVC", "CD_IMPOSTO.FIS_IMPOSTOSVC"
		setocc "FIS_IMPOSTOSVC", 1
		while ($status >=0)
			vDsRegistro = ""
			putlistitems/occ vDsRegistro, "FIS_IMPOSTOSVC"
			putitem vDsLstImposto, -1, vDsRegistro
			setocc "FIS_IMPOSTOSVC" , $curocc("FIS_IMPOSTOSVC") + 1
		endwhile
	endif

	clear/e "FIS_CSTSVC"
	CD_CST.FIS_CSTSVC/init = $cdCST$
	retrieve/e "FIS_CSTSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=CST %%$cdCST$ não cadastrado!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif	

	poParams = ""
	putitem/id poParams, "CD_CST", $cdCST$
	putitem/id poParams, "CD_DECRETO", $cdDecreto$
	putitem/id poParams, "DS_LSTIMPOSTO", vDsLstImposto

	return(0)
end ; operation calculaImpostoCapa

;----------------------------------
public operation calculaImpostoItem
;----------------------------------

	params
		string  xlpg        :IN    
		string  piParams    :IN
		string  poParams    :OUT
		string  poCdErro    :OUT
		string  poCtxErro   :OUT
	endparams

	variables
		string  viParams, voParams, vDsUF, vDsRegistro, vDsLstImposto, vDsLstCdImposto, vCdMPTer, vNmMunicipio
		numeric vCdEmpresa, vCdEmpresaParam, vCdProduto, vCdOperacao, vCdPessoa, vNrSeqEnd
		numeric vCdImposto, vCdRegraFiscal , vCdImpRetorno
		boolean vInOrgaoPublico
		date    vDtIniVigencia
	endvariables

	poParams	= ""
	$xlpg$	= xlpg

	vCdEmpresa 					= $item("CD_EMPRESA", piParams)
	if (vCdEmpresa = 0)
		vCdEmpresa				= $item("CD_EMPRESA", $xlpg$)
	endif
	$dsUFOrigem$					= $item("UF_ORIGEM", $xlpg$)
	$dsUFDestino$					= $item("UF_DESTINO", piParams)
	$tpOrigemEmissao$				= $item("TP_ORIGEMEMISSAO", piParams) ;1 - Própria / 2 - Terceiros
	vCdProduto						= $item("CD_PRODUTO", piParams)
	vCdMPTer							= $item("CD_MPTER", piParams)
	$cdServico$						= $item("CD_SERVICO", piParams)	
	vCdOperacao						= $item("CD_OPERACAO", piParams)
	vCdPessoa						= $item("CD_PESSOA", piParams)
	$cdCST$							= $item("CD_CST", piParams)
	$vlTotalBruto$					= $item("VL_TOTALBRUTO", piParams)
	$vlTotalLiquido$				= $item("VL_TOTALLIQUIDO", piParams)
	$vlTotalLiquidoICMS$		= $item("VL_TOTALLIQUIDO", piParams) ;---Elia Proj. 61/461 02/09/08
	$prIPI$							= $item("PR_IPI", piParams)
	$vlIPI$							= $item("VL_IPI", piParams)
	$TpModDctoFiscal$				= $item("TP_MODDCTOFISCAL", piParams)
	vDsLstCdImposto				= $item("DS_LST_CD_IMPOSTO", piParams) ;-- MAD [Proj/Tar.170/285] - 30/05/2011
	$tpAreaComercioOrigem$		= $item("TP_AREA_COMERCIO_ORIGEM", $xlpg$) ;---Elia Proj. 61/509 25/11/08
	$tpAreaComercioDestino$	= ""
	$inContribuinte$				= ""
	$cdDecretoItemCapa$			= ""

	if ($tpOrigemEmissao$ = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Tipo emissão não informado!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	if ($dsUFDestino$ = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=UF destino não informada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif	
	
	if (vCdOperacao = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação não informada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	clear/e "PRD_PRODUTOSVC"

	clear/e "GER_OPERACAOSVC"
	CD_OPERACAO.GER_OPERACAOSVC/init = vCdOperacao
	retrieve/e "GER_OPERACAOSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação %%vCdOperacao não cadastrada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	if (vCdProduto = 0) & (vCdMPTer = "") & ($cdServico$ = 0)
		return(0)
	endif

	if (IN_CALCIMPOSTO.GER_OPERACAOSVC != <TRUE>)
		return(0)
	endif

	if ($cdCST$ = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=CST não informado!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	call getParam(vCdEmpresa)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif
	if ($status < 0)
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	if ($inPDVOtimizado$ != <TRUE>)
		if ($vlTotalBruto$ = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor total bruto não informado p/ o produto %%vCdProduto!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif

		if ($vlTotalLiquido$ = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor total líquido não informado p/ oproduto %%vCdProduto!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
	endif

	clear/e "PES_PESSOASVC"
	CD_PESSOA.PES_PESSOASVC/init = vCdPessoa
	retrieve/e "PES_PESSOASVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa %%vCdPessoa não cadastrada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	if (TP_OPERACAO.GER_OPERACAOSVC = "S" & TP_MODALIDADE.GER_OPERACAOSVC = 4) | (TP_OPERACAO.GER_OPERACAOSVC = "E" & TP_MODALIDADE.GER_OPERACAOSVC = 3) ;Venda / Devolução de venda
		setocc "PES_CLIENTESVC", 1
		if (!$dbocc("PES_CLIENTESVC"))
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cliente %%vCdPessoa não cadastrado!", "ADICIONAL=Operação->FISSVCO015.buscaCFOP")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
	endif

	$inPjIsento$ = <FALSE>
	if (NR_INSCESTL.PES_PESJURIDISVC = "ISENTO")  | (NR_INSCESTL.PES_PESJURIDISVC = "ISENTA") | %\
       (NR_INSCESTL.PES_PESJURIDISVC = "ISENTOS") | (NR_INSCESTL.PES_PESJURIDISVC = "ISENTAS")
		$inPjIsento$ = <TRUE>
	endif

	;---Elia Proj. 61/309 15/04/08
	$inVarejista$ = <FALSE>
	if (CD_ATIVIDADE.PES_PESJURIDISVC = $cdAtividadeVarejista$) & ($cdAtividadeVarejista$ != "")
		$inVarejista$ = <TRUE>
	endif
	;
	;---Elia Proj. 061/650 22/07/09
	if ($tpOrigemEmissao$ = 2) ;Terceiros
		if (TP_MODALIDADE.GER_OPERACAOSVC != 3) ;Devolução
			vDsUF				= $dsUFOrigem$
			$dsUFOrigem$	= $dsUFDestino$
			$dsUFDestino$	= vDsUF
		endif
	else
		if (TP_MODALIDADE.GER_OPERACAOSVC = 3 & TP_OPERACAO.GER_OPERACAOSVC = "S") ;Devolução compra
			vDsUF				= $dsUFOrigem$
			$dsUFOrigem$	= $dsUFDestino$
			$dsUFDestino$	= vDsUF			
		endif
	endif
	;
	;---Elia Proj. 61/390 01/07/08
	viParams = ""
	putitem/id viParams, "CD_PESSOA", vCdPessoa
	activate "FCRSVCO057".validaPessoaOrgaoPublico($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif
    
	vInOrgaoPublico = $item("IN_ORGAOPUBLICO", voParams)
	
	;---Elia Proj. 61/542 02/02/09
	if (vInOrgaoPublico = <TRUE>) & ($dsUFOrigem$ = "DF")
	;
		$inContribuinte$ = <TRUE>
	else
		if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) | (TP_PESSOA.PES_PESSOASVC = "F") | ($inPjIsento$ = <TRUE>)
			;---Elia Proj. 61/577 14/04/09
			;;---Elia Proj. 61/364 06/06/08
			;if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) & (TP_PESSOA.PES_PESSOASVC = "J") & ($inPjIsento$ = <FALSE>) & ($dsUFOrigem$ = "MS")
			if (IN_CNSRFINAL.PES_CLIENTESVC = <TRUE>) & (TP_PESSOA.PES_PESSOASVC = "J") & ($inPjIsento$ = <FALSE>)
				$inContribuinte$ = <TRUE>
			else
				;---Elia Proj. 61/196 28/11/07
				;---Elia Proj. 061/625 29/06/09 Inclusao do RS.
				if (TP_PESSOA.PES_PESSOASVC = "F") & (NR_CODIGOFISCAL.PES_CLIENTESVC != "") & ($dsUFOrigem$ = "PR" | $dsUFOrigem$ = "SP" | $dsUFOrigem$ = "RS") 
					$inContribuinte$ = <TRUE>
				else
					$inContribuinte$ = <FALSE>
				endif
			endif
		else
			$inContribuinte$ = <TRUE>
		endif
	endif
	;
	;---Elia Proj. 91/320 19/01/09
	;;---Elia Proj. 61/509 25/11/08
	;if ($tpAreaComercioOrigem$ = 2) ; 2 - Manaus
	if ($inOptSimples$ = <TRUE>)
		$tpAreaComercioDestino$ = ""
	else
		clear/e "V_PES_ENDFATSVC"
		CD_PESSOA.V_PES_ENDFATSVC/init = vCdPessoa
		retrieve/e "V_PES_ENDFATSVC"
		if ($status >= 0)
			$tpAreaComercioDestino$ = TP_AREA_COMERCIO.V_PES_ENDFATSVC
		endif
	endif
	;
	;   Este retrieve foi comentado dentro do if e colocado aki, pois estava carregando a variável $tpRegimeOrigem$ somente
	;   quando era emissão de terceiros. Esta variável está sendo usado tbm para emissão própria no cálculo do ICMS.
	;   Por Deusdete em 10/10/2006
	if (TP_PESSOA.PES_PESSOASVC != "F")	
		if ($empty("PES_PESJURIDISVC") != 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa %%vCdPessoa não é jurídica!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoCapa")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
		$tpRegimeOrigem$ = TP_REGIMETRIB.PES_PESJURIDISVC
	endif

	;---Elia Proj. 61/542 03/02/09
	if ($inContribuinte$ = <FALSE>) & ($dsUFDestino$ != "EX")
		$dsUFDestino$ = $dsUFOrigem$
	endif
	;

	if (TP_MODALIDADE.GER_OPERACAOSVC = "D" & $TpModDctoFiscal$ = "") ; Condição implementada por Deusdete em 18/05/07 para o CIAP
		$TpModDctoFiscal$ = 85
	;-- MAD [Proj/Tar.175/143] - 17/05/2011
	elseif (TP_MODALIDADE.GER_OPERACAOSVC = "G" & $TpModDctoFiscal$ = "") 
		$TpModDctoFiscal$ = 87 ; Nota Fiscal CIAP
	;;
	endif

	vCdRegraFiscal = 0

	if ($cdServico$ > 0)
		$inProdPropria$ = <FALSE>
		vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC
		if (vCdRegraFiscal = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
	elseif (vCdMPTer != "")
		$inProdPropria$	= <FALSE>
		vCdRegraFiscal		= CD_REGRAFISCAL.GER_OPERACAOSVC
		if (vCdRegraFiscal = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
	else	
		clear/e "PRD_PRODUTOSVC"
		CD_PRODUTO.PRD_PRODUTOSVC/init = vCdProduto
		retrieve/e "PRD_PRODUTOSVC"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Produto %%vCdProduto não cadastrado!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif

		viParams = ""
		putitem/id viParams, "CD_EMPRESA", vCdEmpresa
		putitem/id viParams, "CD_PRODUTO", vCdProduto    
		activate "PRDSVCO008".buscaDadosFilial($xlpg$, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
		
		$inProdPropria$ = $item("IN_PRODPROPRIA", voParams)

		clear/e "PRD_PRDREGRAFSVC"
		CD_PRODUTO.PRD_PRDREGRAFSVC/init	= vCdProduto
		CD_OPERACAO.PRD_PRDREGRAFSVC/init	= vCdOperacao
		retrieve/e "PRD_PRDREGRAFSVC"
		if ($status >= 0)
			vCdRegraFiscal = CD_REGRAFISCAL.PRD_PRDREGRAFSVC
		else
			vCdRegraFiscal = CD_REGRAFISCAL.GER_OPERACAOSVC
		endif
		
		if (vCdRegraFiscal = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma regra fiscal cadastrada p/ o produto %%vCdProduto e a operação %%vCdOperacao%%%!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
			poCdErro		= $xCdErro$
			poCtxErro	= $xCtxErro$
			return(-1)
		endif
	endif

	clear/e "FIS_REGRAFISCSVC"
	CD_REGRAFISCAL.FIS_REGRAFISCSVC/init = vCdRegraFiscal
	retrieve/e "FIS_REGRAFISCSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Regra fiscal %%vCdRegraFiscal não cadastrada!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif	
 
	clear/e "FIS_ALIQUOTAISVC"
	CD_UFORIGEM.FIS_ALIQUOTAISVC/init		= $dsUFOrigem$
	CD_UFDESTINO.FIS_ALIQUOTAISVC/init		= $dsUFDestino$
	retrieve/e "FIS_ALIQUOTAISVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma alíquota cadastada de %%CD_UFORIGEM.FIS_ALIQUOTAISVC para %%CD_UFDESTINO.FIS_ALIQUOTAISVC%%%!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	clear/e "FIS_IMPOSTOSVC"
	$vlICMS$ = 0
	;-- MAD [Proj/Tar.170/285] - 30/05/2011
	;vDsLstCdImposto = ""
	if (vDsLstCdImposto = "")
	;;
		if ($cdServico$	> 0)
			;---Marcio/Elia Proj. 130/282 16/12/08
			if (IN_ISS.FIS_REGRAFISCSVC = <TRUE>)
				putitem vDsLstCdImposto, -1, 4
			else
;				putitem vDsLstCdImposto, -1, 3
				putitem vDsLstCdImposto, -1, 1
				putitem vDsLstCdImposto, -1, 2
			endif
;oda comentei pois somente deveria calcular esse imposto se estivesse marcado na regra fiscal
;			putitem vDsLstCdImposto, -1, 10 ;MARTINEZ - PRJ/TAR 180/292 - 27/10/2011
		else
			putitem vDsLstCdImposto, -1, 3
			putitem vDsLstCdImposto, -1, 1
			putitem vDsLstCdImposto, -1, 2
		endif
		putitem vDsLstCdImposto, -1, 5
		putitem vDsLstCdImposto, -1, 6
		putitem vDsLstCdImposto, -1, 7
	endif

	repeat
		getitem vCdImposto, vDsLstCdImposto, 1
		
		;--> VSOUZA PRJ/TAR 192/013 04/11/2011
		vDtIniVigencia = ""
		viParams       = ""
		voParams       = ""
		putitem/id viParams, "CD_IMPOSTO"    , vCdImposto
		putitem/id viParams, "DT_INIVIGENCIA", $item("DT_INIVIGENCIA", piParams)			
		activate "FISSVCO069".retornaImposto($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif   

		if (voParams != "")
			vDtIniVigencia  = $item("DT_INIVIGENCIA", voParams)
			vCdImpRetorno   = $item("CD_IMPOSTO"    , voParams)
		;--------------------------------------<
			creocc "FIS_IMPOSTOSVC", -1
			;CD_IMPOSTO.FIS_IMPOSTOSVC/init     = vCdImposto ;--> VSOUZA PRJ/TAR 192/013 04/11/2011
			CD_IMPOSTO.FIS_IMPOSTOSVC/init     = vCdImpRetorno
			DT_INIVIGENCIA.FIS_IMPOSTOSVC/init = vDtIniVigencia
			retrieve/o "FIS_IMPOSTOSVC"
			if ($status = -7)
				retrieve/x "FIS_IMPOSTOSVC"
			elseif ($status = 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Imposto %%vCdImposto não cadastrado!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
				poCdErro		= $xCdErro$
				poCtxErro	= $xCtxErro$
				return(-1)
			endif
	
			selectcase vCdImposto
				case 1 ;ICMS
					call calculaICMS()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				case 2 ;ICMSSubst
					call calculaICMSSubst()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				case 3 ;IPI - Saída é calculado / Entrada é digitado na tela
					call calculaIPI()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				case 4 ;ISS
					call calculaISS()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				case 5 ;COFINS
					call calculaCOFINS()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				case 6 ;PIS
					call calculaPIS()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				case 7 ;PASEP
					call calculaPASEP()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				;MARTINEZ - PRJ/TAR 180/292 - 27/10/2011
				case 10 ;CSLL
					call calculaCSLL()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
					if ($status < 0)
						poCdErro		= $xCdErro$
						poCtxErro	= $xCtxErro$
						return(-1)
					endif
				;
			endselectcase

		endif		

		delitem vDsLstCdImposto, 1

	until (vDsLstCdImposto = "")

	vDsLstImposto = ""

	if ($empty("FIS_IMPOSTOSVC") = 0)
		sort/e "FIS_IMPOSTOSVC", "CD_IMPOSTO.FIS_IMPOSTOSVC"
		setocc "FIS_IMPOSTOSVC", 1
		while ($status >=0)
			vDsRegistro = ""
			putlistitems/occ vDsRegistro, "FIS_IMPOSTOSVC"
			putitem vDsLstImposto, -1, vDsRegistro
			setocc "FIS_IMPOSTOSVC" , $curocc("FIS_IMPOSTOSVC") + 1
		endwhile
	endif

	clear/e "FIS_CSTSVC"
	CD_CST.FIS_CSTSVC/init = $cdCST$
	retrieve/e "FIS_CSTSVC"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=CST %%$cdCST$ não cadastrado!", "ADICIONAL=Operação->FISSVCO015.calculaImpostoItem")
		poCdErro		= $xCdErro$
		poCtxErro	= $xCtxErro$
		return(-1)
	endif

	poParams = ""
	putitem/id poParams, "CD_CST", $cdCST$
	putitem/id poParams, "CD_DECRETO", $cdDecreto$
	putitem/id poParams, "DS_LSTIMPOSTO", vDsLstImposto

	return(0)
end ; operation calculaImpostoItem