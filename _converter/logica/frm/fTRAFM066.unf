;-------------------------
entry preCLEAR 
	;-------------------------
	;O clear dever ser executado desta forma porque na template ele ter por padrão rollback e no
	;caso deste componente não pode ser dado rollback
	clear
	if ($status >= 0)
		$instancehandle->SetStatus(<STS_DICA>,"APL0006","","")
	endif
	
	;oda coloquei essa chamada pois ao limpar aparecia os campos novamente. E deve sumir caso nao necessite.
	$instancehandle->carregaVlMaxTroco()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif    
	if ($status < 0)
		exit(-1)
	endif
	
	$instancehandle->carregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	if ($status < 0)
		exit(-1)
	endif
	
	;oda coloquei pois ao limpar sumia os valores de adiantamento.
	$instancehandle->carregaAdiantamento()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif    
	
	$instancehandle->criaValor()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	
	$inLiberaTpDocumento$ = <FALSE>
	;>-- MAC - PRJ 156 TAR 174 - 10/02/2010 ---
	if ($inTrocoMaximo$ = <TRUE>)
		fieldsyntax IN_ADIANTATROCO.SIS_DUMMY3, "DIM"
	else
		fieldsyntax IN_ADIANTATROCO.SIS_DUMMY3, ""
	endif
	;--<    
	$prompt = VL_DOCUMENTO.SIS_VALOR
	
	return(-1)
End ; operation preCLEAR

;------------------------
entry preEDIT 
	;------------------------
	variables
		string viParams, voParams
	endvariables
	
	$cdEmpECF$ = 0
	$nrECF$ = 0
	$nrCupom$ = 0
	$nrParcelas$ = 0    
	$inErroRecebimento$ = <FALSE>
	$dsLstTransacao$    = $item("DS_LSTTRANSACAO", $xlpi$)
	$cdPessoa$          = $item("CD_PESSOA",       $xlpi$)
	$inTrocoMaximo$     = $item("IN_TROCOMAXIMO",  $xlpi$)
	$vlTrocoMaximo$     = $item("VL_TROCOMAXIMO",  $xlpi$)
	$cdEmpECF$          = $item("CD_EMPECF",       $xlpi$)    
	$NrECF$             = $item("NR_ECF",          $xlpi$)
	$NrCupom$           = $item("NR_CUPOM",        $xlpi$)
	$nrUltimoBanco$     = ""
	$nrUltimaAgencia$   = ""
	$dsUltimaConta$     = ""
	$nrUltimoCheque$    = ""
	;indica se vai apenas trocar o tipo de documento de uma determinada transacao, para não emitir cupom novamente.
	$inTrocaDocumento$  = $item("IN_TROCADOCUMENTO", $xlpi$)
	$inRecAutomatico$   = $item("IN_RECAUTOMATICO",  $xlpi$)
	$inFCRFP001$        = $item("IN_FCRFP001",       $xlpi$)
	
	if($item("IN_DESCPROMOCAO", $xlpi$) = <TRUE> & $item("IN_IMPRIMI_ECF_NFP", $xlplemp$) = 1)
		$indesF7$ = <TRUE>
	endif
	
	clear/e "TMP_NR10"
	clear/e "TEF_TRANSACAO"
	
	if ($dsLstTransacao$ = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Lista de transação não informada!", "")
		exit(-1)
	endif
	
	if ($inTrocoMaximo$ = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Indicador de controle de troco máximo não informado!", "")
		exit(-1)
	endif
	
	;>-- MAC - PRJ 156 TAR 174 - 10/02/2010 ---
	if ($inTrocoMaximo$ = <TRUE>)
		fieldsyntax IN_ADIANTATROCO.SIS_DUMMY3, "DIM"
	else
		fieldsyntax IN_ADIANTATROCO.SIS_DUMMY3, ""
	endif
	;--<
	
	$instancehandle->carregaVlMaxTroco()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif    
	if ($status < 0)
		exit(-1)
	endif
	
	$instancehandle->carregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	if ($status < 0)
		exit(-1)
	endif
	
	$instancehandle->carregaVlBrutoLiquido()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif
	if ($status < 0)
		exit(-1)
	endif
	
	if (IN_FINANCEIRO.GER_OPERACAO = <FALSE>)
		viParams = ""
		putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
		putitem/id viParams, "TP_SITUACAO",     4 ;Atendida
		activate "TRASVCO004".alteraSituacaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			exit(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			exit(-1)
		endif
		
		;-- MAD [Proj/Tar.149/101] - 30/11/2010
		$instancehandle->geraNFe()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
		if ($status < 0)
			exit(-1)
		endif
		;;
		
		exit(0)        
	endif
	
	if ($xCdNivel$ = 2)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Usuário possui somente nível de consulta no componente TRAFM066!", "")
		exit(-1)
	endif
	
	$instancehandle->carregaCtaCliente()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	
	if ($status < 0)
		exit(-1)
	endif
	
	$instancehandle->carregaCaixa()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	
	if ($status < 0)
		exit(-1)
	endif
	
	$instancehandle->carregaAdiantamento()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	
	if ($status < 0)
		exit(-1)
	endif
	
	$inLiberaTpDocumento$ = <FALSE>
	$dsLstTpDocumento$    = ""
	
	$instancehandle->carregaTipoDocumento()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	
	if ($status < 0)
		exit(-1)
	endif
	
	$instancehandle->criaValor()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	
	;-=CANONICO=- TAR 494 PRJ 102 (01/04/2009)
	if ($tpTEF$ = 1) | ($tpTEF$ = 2)
		$instancehandle->efetivaTEFPendente(<FALSE>, <TRUE>)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif
		if ($status < 0)
			exit(-1)
		endif
	endif
	
	if ($inECF$ = <TRUE>)
		$inF7$ = <TRUE>
		BT_F11.SIS_BOTOES2 = "F11 Encerrar"
	else
		$inF7$ = <FALSE>
		BT_F11.SIS_BOTOES2 = "F11 Encerrar"
	endif
	
	$CdEmpContrato$     = 0    
	$NrSeqContrato$     = 0
	$NrSeqItemContrato$ = 0
	$DsContrato$        = ""
	viParams            = ""
	voParams            = ""
	putitem/id viParams, "CD_EMPRESA",   CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "IMBSVCO003".buscaContratoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")    
		$CdEmpContrato$     = $item("CD_EMPCONTRATO", voParams)    
		$NrSeqContrato$     = $item("NR_SEQCONTRATO", voParams)
		$NrSeqItemContrato$ = $item("NR_SEQITEM",     voParams)
		$DsContrato$        = voParams
	endif    
	
	clear/e "PED_PEDIDOTRA"
	CD_EMPTRANSACAO.PED_PEDIDOTRA/init = CD_EMPRESA.TRA_TRANSACAO
	NR_TRANSACAO.PED_PEDIDOTRA/init    = NR_TRANSACAO.TRA_TRANSACAO
	DT_TRANSACAO.PED_PEDIDOTRA/init    = DT_TRANSACAO.TRA_TRANSACAO
	retrieve/e "PED_PEDIDOTRA"
	if ($status >= 0)
		if ($tpBloqAltFat$ = 02 | $tpBloqAltFat$ = 03) & ($inTrocoMaximo$ != <TRUE>)
			$instancehandle->BT_06()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
			if ($status < 0)
				exit(-1)
			endif
			$instancehandle->BT_11()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
			if ($status < 0)
				exit(-1)
			endif
		endif
	else
		;foi implementado para a imobiliaria mas pode ser usado para outras situações
		;basta informar o flag "IN_RECAUTOMATICO" como <TRUE>
		if ($inRecAutomatico$ = <TRUE>)
			$instancehandle->BT_06()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
			if ($status < 0)
				exit(-1)
			endif
			$instancehandle->BT_11()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
			if ($status < 0)
				exit(-1)
			endif
		endif
	endif
	
	$prompt = VL_DOCUMENTO.SIS_VALOR
	
	return(0)
End ; operation preEDIT

;------------------------
entry posEDIT 
	;------------------------
	variables
		boolean vInMostraTroco
	endvariables

	;>-- MAC - PRJ 102/926 - 27/08/2010 ---    
	$xlpo$ = ""
	putitem/id $xlpo$, "IN_FATURA", $inFatura$
	;--<
	
	;Hugo em 28/12/2010 Tarefa 180-32
	vInMostraTroco = $item("IN_MOSTRA_TROCO_RECEB", $xlplemp$)
	
	if (vInMostraTroco = <TRUE>) & (IN_ADIANTATROCO.SIS_DUMMY3!= <TRUE>)
		putitem/id $xlpo$, "VL_TROCO", VL_TROCO.SIS_DUMMY3
	endif
	;
	;-=CANONICO=- (11/08/2011) TAR 125 PRJ 186 -ERRO CONTA CORRENTE- no gravarecibimento foi alterado apos o gravaLiqTransacao, as variaveis por compVariables
	if ($cdReciboTra$ > 0)	
		putitem/id $xlpo$, "CD_EMPLIQ", $CdEmpLiq$
		putitem/id $xlpo$, "DT_LIQ",    $DtLiq$
		putitem/id $xlpo$, "NR_SEQLIQ", $NrSeqLiq$
	endif
	
	return(0)
End ; operation posEDIT

;------------------------
entry preQUIT 
	;------------------------
	if ($inPDVOtimizado$ = <TRUE>)
		if ($inErroRecebimento$ != <TRUE>)
			return(-1)            
		endif
	endif    
	
	if ($tpTEF$ = 1) | ($tpTEF$ = 2)
		$instancehandle->efetivaTEFPendente(<TRUE>, <FALSE>)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif    
	endif

	exit(-1)    
End ; operation preQUIT

;---------------------
partner operation INIT
	;-----------------
	$keyboard = "KB_PDV"
	$formtitle = "%%$componentname - Recebimento de Transação de Venda-"

	$xlpl$ = ""
	putitem $xlpl$, -1, "CLIENTE_PDV"
	activate "ADMSVCO001".GetLstParametro($xlpl$, $xlpl$, $xcderro$, $xctxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	elseif ($xcdErro$)
		$instancehandle->SetErroApl($xCtxErro$, $xCdErro$, $xCtxErro$)
	endif

	$cdClientePDV$ = $item("CLIENTE_PDV", $xlpl$)

	;Parametros por empresa
	$xlplemp$ = ""
	putitem $xlplemp$, -1, "TP_FORMAPGTO"
	putitem $xlplemp$, -1, "TEF_TIPO"
	putitem $xlplemp$, -1, "LIMITE_CREDITO"
	putitem $xlplemp$, -1, "TP_IMPRESSAO_FAT_VD"
	putitem $xlplemp$, -1, "TP_IMPRESSAO_TRA_VD"
	putitem $xlplemp$, -1, "CD_MODELO_NF_PROMISSORIA"
	putitem $xlplemp$, -1, "NR_FILA_SPOOL_NF_PROMIS"
	putitem $xlplemp$, -1, "TP_BLOQ_ALT_FAT_PED"
	putitem $xlplemp$, -1, "IN_PDV_OTIMIZADO"
	putitem $xlplemp$, -1, "IN_DES_FUNCAO7"
	putitem $xlplemp$, -1, "TP_IMPRESSAO_TEF"
	putitem $xlplemp$, -1, "TEF_IN_AGRUPA_CARTAO"
	putitem $xlplemp$, -1, "TEF_ULTIMAPGTO_CARTAO"
	putitem $xlplemp$, -1, "IN_VALIDA_TROCO"
	putitem $xlplemp$, -1, "TP_SIMULADOR_FAT"
	putitem $xlplemp$, -1, "IN_SIMULADOR_FAT_PRODUTO"
	putitem $xlplemp$, -1, "CD_TIPODESC_PONTUAL_PED"
	putitem $xlplemp$, -1, "CD_TIPODESC_BONIFIC_PED"
	putitem $xlplemp$, -1, "CD_MOD_IMP_RECEBTRA"
	putitem $xlplemp$, -1, "NR_PRAZOMEDIO_MAX_FAT"
	putitem $xlplemp$, -1, "IN_IMP_CONTRATO_AUTO"
	putitem $xlplemp$, -1, "TEF_ESCOLHE_IMP_VIA_CUPOM"
	putitem $xlplemp$, -1, "IN_PERGUNTA_CPFCNPJ_ECF"
	putitem $xlplemp$, -1, "IN_BLOQ_DT_VENC_VD"
	putitem $xlplemp$, -1, "NR_DIAS_PRAZOMED_LIB_FAT"
	putitem $xlplemp$, -1, "TP_COBRANCA_VD"
	putitem $xlplemp$, -1, "IN_IMPRIMI_ECF_NFP"
	putitem $xlplemp$, -1, "TP_MULTIPLOS_CARTOES_SIMU"
	putitem $xlplemp$, -1, "TP_BONUS_DESCONTO"
	putitem $xlplemp$, -1, "VL_VD_CREDITO_BONUS_DESC"
	putitem $xlplemp$, -1, "VL_CREDITO_BONUS_DESCONTO"
	putitem $xlplemp$, -1, "IN_LIMITE_FAMILIAR_VD"
	putitem $xlplemp$, -1, "IN_DESCPROMOCIONAL_CARTAO" ;* Claudemir - Prj/Tarefa: 102/809 - 03/03/2010
	putitem $xlplemp$, -1, "IN_VENDA_CHQ_CLIENTE_BLOQ" ;Projeto 078 - Tarefa 3289 - Aloisio Gargantini - 11/04/2010
	putitem $xlplemp$, -1, "IN_SIMULADOR_COND_PGTO"    ;>-- MAC - PRJ 156/383 - 12/08/2010 ---
	putitem $xlplemp$, -1, "TP_IMP_RICHTEXT_VD"        ;>-- MAC - PRJ 102/926 - 26/08/2010 ---
	putitem $xlplemp$, -1, "IN_GERA_NFE_AUTOMATIC"     ;-- MAD [Proj/Tar.149/101] - 30/11/2010
	putitem $xlplemp$, -1, "IN_GERA_REGC140_FIN"       ;-- MAD [Proj/Tar.149/101] - 30/11/2010
	putitem $xlplemp$, -1, "IN_MOSTRA_TROCO_RECEB"     ;Hugo em 28/12/2010 Tarefa 180-32
	putitem $xlplemp$, -1, "TP_NR_FATURA_CONTRATO"     ;Hugo em 21/01/11 Tarefa 105-73
	putitem $xlplemp$, -1, "IN_ECF_CUPOM_PRESENTE"     ;-=CANONICO=- (09/03/2010) TAR 26 / PRJ 183
	putitem $xlplemp$, -1, "CD_TIPODES_ABATIMENTO_PED" ;Hugo em 11/04/11 Tarefa 22-1805
	putitem $xlplemp$, -1, "CD_TIPO_ABATIMENTO_PED"    ;Hugo em 11/04/11 Tarefa 22-1805
	putitem $xlplemp$, -1, "CD_MOTIVO_ABATI_PED"       ;Hugo em 11/04/11 Tarefa 22-1805
	putitem $xlplemp$, -1, "TP_CHEQUE_PRESENTE"        ;Projeto 180 - Tarefa 0185 - Aloisio Gargantini - 02/06/2011
	putitem $xlplemp$, -1, "IN_DESCTO_ANTEC_FAT_SIMU"  ;==BY BIANCHINI[PRJ/TAREFA 180/225] 25/07/2011==;
	putitem $xlplemp$, -1, "TP_FECHAMENTO_ROYALTY"     ;--Douglas Ferreira - [Prj/Tarefa 180/0270] - 22/09/2011
	activate "ADMSVCO001".GetParamEmpresa($item("CD_EMPRESA", $$gParamGlb), $xlplemp$, $xlplemp$, $xcderro$, $xctxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	elseif ($xcdErro$)
		$instancehandle->SetErroApl($xCtxErro$, $xCdErro$, $xCtxErro$)
	endif

	$tpDocumento$              = $item("TP_FORMAPGTO"             , $xlplemp$)
	$tpTEF$                    = $item("TEF_TIPO"                 , $xlplemp$)
	$dsLimiteCredito$          = $item("LIMITE_CREDITO"           , $xlplemp$)
	$tpImpressaoFatVenda$      = $item("TP_IMPRESSAO_FAT_VD"      , $xlplemp$)
	$tpImpressaoTraVenda$      = $item("TP_IMPRESSAO_TRA_VD"      , $xlplemp$)
	$cdModeloNFPromissoria$    = $item("CD_MODELO_NF_PROMISSORIA" , $xlplemp$)
	$nrFilaSpool$              = $item("NR_FILA_SPOOL_NF_PROMIS"  , $xlplemp$)
	$tpBloqAltFat$             = $item("TP_BLOQ_ALT_FAT_PED"      , $xlplemp$)
	$inPDVOtimizado$           = $item("IN_PDV_OTIMIZADO"         , $xlplemp$)
	$inDesF7$                  = $item("IN_DES_FUNCAO7"           , $xlplemp$)
	$tpImpressaoTEF$           = $item("TP_IMPRESSAO_TEF"         , $xlplemp$)
	$inAgrupaCartaoTEF$        = $item("TEF_IN_AGRUPA_CARTAO"     , $xlplemp$)
	$inUltimaPgtoCartaoTEF$    = $item("TEF_ULTIMAPGTO_CARTAO"    , $xlplemp$)
	$inValidaMsgTroco$         = $item("IN_VALIDA_TROCO"          ,$xlplemp$)
	$tpSimuladorFat$           = $item("TP_SIMULADOR_FAT"         , $xlplemp$)
	$inSimuladorProduto$       = $item("IN_SIMULADOR_FAT_PRODUTO" , $xlplemp$)
	$prDescPontualPed$         = $item("CD_TIPODESC_PONTUAL_PED"  , $xlplemp$)
	$prDescBonificPed$         = $item("CD_TIPODESC_BONIFIC_PED"  , $xlplemp$)
	$cdReciboTra$              = $item("CD_MOD_IMP_RECEBTRA"      , $xlplemp$)
	$NrPrazoMedMax$            = $item("NR_PRAZOMEDIO_MAX_FAT"    , $xlplemp$)
	$InImpContratoAuto$        = $item("IN_IMP_CONTRATO_AUTO"     , $xlplemp$)
	$tpImpViaCupomTEF$         = $item("TEF_ESCOLHE_IMP_VIA_CUPOM", $xlplemp$)
	$inPerguntaCpfCnpj$        = $item("IN_PERGUNTA_CPFCNPJ_ECF"  , $xlplemp$)
	$tpMultiploCartao$         = $item("TP_MULTIPLOS_CARTOES_SIMU", $xlplemp$)
	$vInDescPromocionalCartao$ = $item("IN_DESCPROMOCIONAL_CARTAO", $xlplemp$) ;* Claudemir - Prj/Tarefa: 102/809 - 03/03/2010
	$inVendaChqClienteBloq$    = $item("IN_VENDA_CHQ_CLIENTE_BLOQ", $xlplemp$) ;Projeto 078 - Tarefa 3289 - Aloisio Gargantini - 11/04/2010
	$inSimuladorCondPgto$      = $item("IN_SIMULADOR_COND_PGTO"   , $xlplemp$) ;>-- MAC - PRJ 156/383 - 12/08/2010 ---	
	$tpImpRichTextVD$          = $item("TP_IMP_RICHTEXT_VD"       , $xlplemp$) ;>-- MAC - PRJ 102/926 - 26/08/2010 ---
	;-- MAD [Proj/Tar.149/101] - 30/11/2010
	$inGeraNfeAutomatic$       = $item("IN_GERA_NFE_AUTOMATIC"    , $xlplemp$)
	$inGeraRegC140Fin$         = $item("IN_GERA_REGC140_FIN"      , $xlplemp$)
	;;
	$inEcfCupomPresente$       = $item("IN_ECF_CUPOM_PRESENTE"    , $xlplemp$) ;-=CANONICO=- (09/03/2010) TAR 26 / PRJ 183
	$tpChequePresente$         = $item("TP_CHEQUE_PRESENTE"       , $xlplemp$) ;Projeto 180 - Tarefa 0185 - Aloisio Gargantini - 02/06/2011
	;==BY BIANCHINI[PRJ/TAREFA 180/225] 25/07/2011==;
	$inDesctoAntecFatSimu$     = $item("IN_DESCTO_ANTEC_FAT_SIMU" , $xlplemp$)
	$tpFechamentoRoyalty$      = $item("TP_FECHAMENTO_ROYALTY"    , $xlplemp$) ;--Douglas Ferreira - [Prj/Tarefa 180/0270] - 22/09/2011
	return(0)
End ;operation INIT

;------------------------
partner operation CLEANUP 
	;------------------------
	$keyboard = "KB_GLOBAL"

	return(0)
End ; operation CLEANUP

;----------------------------------
partner operation carregaCtaCliente
;----------------------------------
	variables
		string viParams, voParams
		numeric vCdPessoa, vCdEmpresa
	endvariables

	if ($inTroca$ = <TRUE>)
		vCdEmpresa = CD_EMPFAT.R_TRA_TRANSACAO		
		vCdPessoa  = CD_PESSOA.R_TRA_TRANSACAO
	else
		vCdEmpresa = CD_EMPFAT.TRA_TRANSACAO
		vCdPessoa  = $cdPessoa$
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", vCdEmpresa
	putitem/id viParams, "CD_PESSOA",  vCdPessoa
	if (TP_OPERACAO.TRA_TRANSACAO = "S")
		putitem/id viParams, "TP_CONTA", "C" ;Cliente
	else
		putitem/id viParams, "TP_CONTA", "F" ;Fornecedor
	endif
	putitem/id viParams, "IN_OBRIGATORIO", <FALSE>
	activate "FCCSVCO002".buscaContaPessoa($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		exit(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		exit(-1)
	endif
	
	$nrCtaCliente$ = $item("NR_CTAPES", voParams)
	
	return(0)
end

;-----------------------------
partner operation carregaCaixa
;-----------------------------
	variables
		string  viParams, voParams
		numeric vCdTerminal
	endvariables

	vCdTerminal = $item("CD_TERMINAL", $xlpi$)

	;Hugo - 31/01/06
	;Acrescentei esse if para o fechamento de caixa do lojao
	;pois ele que passara as informações de caixa, podendo
	;ser realizado o recebimento em um caixa que ja foi
	;anteriormente fechado.
	if (vCdTerminal > 0)
		$cdEmpresa$    = $item("CD_EMPTERMINAL", $xlpi$)
		$cdTerminal$   = vCdTerminal
		$dtAbertura$   = $item("DT_ABERTURA",    $xlpi$)
		$nrSeq$        = $item("NR_SEQ",         $xlpi$)
		$nrCtaUsuario$ = $item("NR_CTAPES",      $xlpi$)
	else
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPFAT.TRA_TRANSACAO
		activate "FCXSVCO001".buscaCaixa($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			exit(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			exit(-1)
		endif

		$cdEmpresa$    = $item("CD_EMPRESA",  voParams)
		$cdTerminal$   = $item("CD_TERMINAL", voParams)
		$dtAbertura$   = $item("DT_ABERTURA", voParams)
		$nrSeq$        = $item("NR_SEQ",      voParams)
		$nrCtaUsuario$ = $item("NR_CTAPES",   voParams)
	endif

	return(0)
end

;------------------------------------
partner operation carregaAdiantamento
	;------------------------------------
	variables
		string viParams, viValores, voParams
		numeric vVlCREDEV
		date vDtSaldo
	endvariables
	
	VL_ADIANTAMENTO.SIS_ADIANTAMENTO = ""
	VL_CREDDEV.SIS_ADIANTAMENTO      = ""	
	fieldsyntax VL_ADIANTAMENTO.SIS_ADIANTAMENTO, "HID"
	fieldsyntax VL_CREDDEV.SIS_ADIANTAMENTO     , "HID"
	
	if ($nrCtaCliente$ = 0)
		if ($inTroca$ = <TRUE>)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cliente não possui conta de adiantamento/CREDEV!", "")
			return(-1)
		endif
		return(0)
	endif
	
	vDtSaldo = $item("DT_SISTEMA", $$gParamGlb)
	vVlCREDEV = ""

	if (CD_PESSOA.TRA_TRANSACAO = $cdClientePDV$)
		vVlCREDEV = VL_TOTAL.R_TRA_TRANSACAO
	else
		viParams = ""
		putitem/id viParams, "NR_CTAPES"       , $nrCtaCliente$
		putitem/id viParams, "TP_DOCUMENTO"    , 10 ;Adiantamento
		putitem/id viParams, "NR_SEQHISTRELSUB", 1
		putitem/id viParams, "DT_SALDO"        , vDtSaldo
		activate "FCCSVCO002".buscaSaldoCtaTp($$gParamGlb, viParams, viValores, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	
		VL_ADIANTAMENTO.SIS_ADIANTAMENTO/init = $item("VL_SALDO", voParams)

		viParams = ""
		putitem/id viParams, "NR_CTAPES",        $nrCtaCliente$
		putitem/id viParams, "TP_DOCUMENTO",     20 ;CREDEV
		putitem/id viParams, "NR_SEQHISTRELSUB", 1
		putitem/id viParams, "DT_SALDO",         vDtSaldo
		activate "FCCSVCO002".buscaSaldoCtaTp($$gParamGlb, viParams, viValores, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	
		vVlCREDEV = $item("VL_SALDO", voParams)
	endif
	
	if ($inTroca$ = <TRUE>)
		if (VL_TOTAL.R_TRA_TRANSACAO > vVlCREDEV)
			if($inPdvOtimizado$ != <TRUE>)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor do vale troca maior que o saldo de CREDEV do cliente!", "")
				return(-1)
			endif
		endif		
		VL_CREDDEV.SIS_ADIANTAMENTO/init = VL_TOTAL.R_TRA_TRANSACAO
	else
		VL_CREDDEV.SIS_ADIANTAMENTO/init = vVlCREDEV
	endif
	
	if (VL_ADIANTAMENTO.SIS_ADIANTAMENTO > 0)
		fieldsyntax VL_ADIANTAMENTO.SIS_ADIANTAMENTO, "NED"
	endif

	if (VL_CREDDEV.SIS_ADIANTAMENTO > 0)
		fieldsyntax VL_CREDDEV.SIS_ADIANTAMENTO,      "NED"
	endif
	
	return(0)
end

;----------------------------------
partner operation carregaVlMaxTroco
	;----------------------------------
	variables
		string viParams, voParams
	endvariables

	$inDinheiro$ = <FALSE>
	
	fieldsyntax VL_MAXTROCO.SIS_ADIANTAMENTO, "HID"
	fieldsyntax VL_DIF.SIS_ADIANTAMENTO,      "HID"
	
	if ($inTrocoMaximo$ = <TRUE>)
		VL_MAXTROCO.SIS_ADIANTAMENTO/init = $vlTrocoMaximo$
		if ($vlTrocoMaximo$ = 0)
			$inDinheiro$ = <TRUE>
		endif
		fieldsyntax VL_MAXTROCO.SIS_ADIANTAMENTO, "NED"
		fieldsyntax VL_DIF.SIS_ADIANTAMENTO,      "NED"
	else
		VL_MAXTROCO.SIS_ADIANTAMENTO/init = ""
	endif	
	
	return(0)
end

;--------------------------------------
partner operation carregaVlBrutoLiquido
;--------------------------------------
	variables
		string viParams, voParams
	endvariables

	$vlTotalBruto$   = 0
	$vlTotalLiquido$ = 0

	viParams = $xlpi$
	activate "SICSVCO005".buscaVlBrutoLiquido($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	$vlTotalBruto$   = $item("VL_TOTALBRUTO",   voParams)
	$vlTotalLiquido$ = $item("VL_TOTALLIQUIDO", voParams)
	
	return(0)
end

;-------------------------------------
partner operation carregaTipoDocumento
	;-------------------------------------

	variables
		string  viParams, voParams, vDsLstTotal, vDsGeral, vDsNulo
		string  vDsTpDocumento, vDsLstTpDocumento
		numeric vTpDocumento
		boolean vInTroco, vInAdiantamento, vInCREDEV, vInUtilizar, vInOrgaoPublico
	endvariables
	
	$inParcelaFatura$ = <FALSE>
	$inParcelaCheque$ = <FALSE>	
	$inParcelaNotaP$  = <FALSE>
	
	vDsNulo           = ""
	vInTroco          = <FALSE>
	vInAdiantamento   = <FALSE>
	vInCREDEV         = <FALSE>
	vDsLstTotal       = $valrep(TP_DOCUMENTO.FCX_HISTREL)
	vDsLstTpDocumento = ""
		
	;------------------------------
	;Hugo em 12/09/08 Tarefa: 114-1
	viParams = ""
	putitem/id viParams, "CD_PESSOA", $cdPessoa$ ;oda
	activate "FCRSVCO057".validaPessoaOrgaoPublico($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	vInOrgaoPublico = $item("IN_ORGAOPUBLICO", voParams)
	
	if (vInOrgaoPublico = <TRUE>) ;Somente Fatura para Orgao Publico
		vDsGeral       = $item("1", vDsLstTotal)
		vDsTpDocumento = ""
		putitem/id vDsTpDocumento, "1", vDsGeral
		putitem vDsLstTpDocumento, -1,  vDsTpDocumento
		$valrep(TP_DOCUMENTO.SIS_VALOR) = vDsLstTpDocumento
	
		return(0)
	endif
	;------------------------------
	clear/e "FCX_HISTREL"
	if ($inLiberaTpDocumento$ = <FALSE>)
		IN_FATURAMENTO.FCX_HISTREL/init = <TRUE>
	else
		TP_DOCUMENTO.FCX_HISTREL/init   = $dsLstTpDocumento$
	endif
	retrieve/e "FCX_HISTREL"
	if ($status >= 0)
		sort   "FCX_HISTREL", "VL_AUX.FCX_HISTREL" ;---Elia Proj. 78/1902 15/10/08
		setocc "FCX_HISTREL", 1            
		while ($status >= 0)
			if (TP_DOCUMENTO.FCX_HISTREL = 9) ;Troco
				vInTroco    = <TRUE>
			else		
				vInUtilizar = <TRUE>
				if ($inLiberaTpDocumento$ = <FALSE>)
					;---Elia Proj. 133/007 16/08/08
					if ($cdCartao$ != 0)
						viParams = ""
						putitem/id viParams, "CD_CARTAO",    $cdCartao$
						putitem/id viParams, "TP_DOCUMENTO", TP_DOCUMENTO.FCX_HISTREL
						activate "CTCSVCO004".verificaTpDocumentoCartao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)     
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif				

						if (voParams != "")
							vInUtilizar = $item("IN_VALIDO", voParams)
						endif
					else
						viParams = ""
						putitem/id viParams, "CD_PESSOA",      $cdPessoa$
						putitem/id viParams, "CD_EMPRESA",     CD_EMPFAT.TRA_TRANSACAO ;<ANO Pjt78 Trf3390 - 11/05/2010>
						putitem/id viParams, "TP_DOCUMENTO",   TP_DOCUMENTO.FCX_HISTREL
						putitem/id viParams, "IN_FATURAMENTO", <TRUE>
						activate "FCXSVCO005".validaHistRel($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)     
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif				

						if (voParams != "")
							vInUtilizar = $item("IN_VALIDO", voParams)
						endif
					endif
				endif
				
				if (vInUtilizar = <TRUE>)	
					if (TP_DOCUMENTO.FCX_HISTREL = 10) ;Adiantamento
						if (VL_ADIANTAMENTO.SIS_ADIANTAMENTO > 0)
							vInAdiantamento = <TRUE>
							vDsGeral        = "Adiantamento"
							vDsTpDocumento  = ""
							putitem/id vDsTpDocumento, TP_DOCUMENTO.FCX_HISTREL, vDsGeral
							putitem vDsLstTpDocumento, -1, vDsTpDocumento
						endif
					elseif (TP_DOCUMENTO.FCX_HISTREL = 20) ;CREDEV
						if (VL_CREDDEV.SIS_ADIANTAMENTO > 0)
							vInCREDEV      = <TRUE>
							vDsGeral       = $item(TP_DOCUMENTO.FCX_HISTREL, vDsLstTotal)
							vDsTpDocumento = ""
							putitem/id vDsTpDocumento, TP_DOCUMENTO.FCX_HISTREL, vDsGeral
							putitem vDsLstTpDocumento, -1, vDsTpDocumento
						endif
					else
						if (TP_DOCUMENTO.FCX_HISTREL = 1) ;Fatura
							$inParcelaFatura$ = <TRUE>
						elseif (TP_DOCUMENTO.FCX_HISTREL = 2) ;Cheque
							$inParcelaCheque$ = <TRUE>
						elseif (TP_DOCUMENTO.FCX_HISTREL = 14) ;Nota promissória
							$inParcelaNotaP$  = <TRUE>
						endif
						vDsGeral       = $item(TP_DOCUMENTO.FCX_HISTREL, vDsLstTotal)
						vDsTpDocumento = ""
						putitem/id vDsTpDocumento, TP_DOCUMENTO.FCX_HISTREL, vDsGeral
						putitem vDsLstTpDocumento, -1, vDsTpDocumento
						if (TP_DOCUMENTO.FCX_HISTREL = 4 | TP_DOCUMENTO.FCX_HISTREL = 5) & ($inPDVOtimizado$ = <TRUE>) ;Cartao de credito
							clear/e "FCX_HISTRELSUB"
							TP_DOCUMENTO.FCX_HISTRELSUB/init  = TP_DOCUMENTO.FCX_HISTREL
							DS_HISTRELSUB.FCX_HISTRELSUB/init = "·!·=%%vDsNulo"
							retrieve/e "FCX_HISTRELSUB"	
							if ($status >= 0)
								sort   "FCX_HISTRELSUB", "VL_AUX.FCX_HISTRELSUB" ;---Elia Proj. 78/1902 15/10/08
								setocc "FCX_HISTRELSUB", 1            
								while ($status >= 0)
									vTpDocumento = (TP_DOCUMENTO.FCX_HISTREL * 10000) + NR_SEQHISTRELSUB.FCX_HISTRELSUB
									vDsTpDocumento = ""
									putitem/id vDsTpDocumento, vTpDocumento, DS_HISTRELSUB.FCX_HISTRELSUB[1 : 15]
									putitem vDsLstTpDocumento, -1, vDsTpDocumento
									setocc "FCX_HISTRELSUB", $curocc("FCX_HISTRELSUB") + 1
								endwhile
							endif							
						endif
					endif
					putitem $dsLstTpDocumento$, -1, TP_DOCUMENTO.FCX_HISTREL
				endif
			endif
			setocc "FCX_HISTREL", $curocc("FCX_HISTREL") + 1
		endwhile
	endif
	
	if (vInTroco = <FALSE>) & ($inLiberaTpDocumento$ = <FALSE>)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Tipo de documento Troco não cadastrado.%%^%%%Utilizar o FCXFL002 para cadastro!", "")
		return(-1)
	endif
	
	if (VL_ADIANTAMENTO.SIS_ADIANTAMENTO > 0) & (vInAdiantamento = <FALSE>)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Tipo de documento Adiantamento de Cliente não cadastrado.%%^%%%Utilizar o FCXFL002 para cadastro!", "")
		return(-1)
	endif

	if (VL_CREDDEV.SIS_ADIANTAMENTO > 0) & (vInCREDEV = <FALSE>)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Tipo de documento CREDEV não cadastrado.%%^%%%Utilizar o FCXFL002 para cadastro!", "")
		return(-1)
	endif

	$valrep(TP_DOCUMENTO.SIS_VALOR) = vDsLstTpDocumento
	
	return(0)
end

;---------------------------------
partner operation carregaTransacao
	;---------------------------------
	variables
		string  vDsRegistro, vDsLstTransacao, vDsSituacao, viParams, voParams
		numeric vCdEmpresa, vNrTransacao, vVlFinanceiro
		date    vDtTransacao
	endvariables	
	
	$inECF$         = <FALSE>
	$inCupomAberto$ = <FALSE>
	$cdCartao$      = 0
	$nrSeqCartao$   = 0
	$vlTotBonus$    = 0
	$inFinanceiro$  = <FALSE>

	clear/e "TRA_TRANSACAO"
	VL_TOTAL.SIS_DUMMY3/init    = ""
	VL_RESTANTE.SIS_DUMMY3/init = ""
	
	vDsLstTransacao = $dsLstTransacao$
	repeat
		getitem vDsRegistro, vDsLstTransacao, 1
		
		vCdEmpresa   = $item("CD_EMPRESA",   vDsRegistro)
		vNrTransacao = $item("NR_TRANSACAO", vDsRegistro)
		vDtTransacao = $item("DT_TRANSACAO", vDsRegistro)
		
		if (vCdEmpresa = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Empresa não informada!", "")
			return(-1)
		endif
		
		if (vNrTransacao = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Nr. transação não informado!", "")
			return(-1) 
		endif
		
		if (vDtTransacao = "")
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Dt. transação não informada!", "")
			return(-1)
		endif
		
		creocc "TRA_TRANSACAO", -1
		CD_EMPRESA.TRA_TRANSACAO/init   = vCdEmpresa
		NR_TRANSACAO.TRA_TRANSACAO/init = vNrTransacao
		DT_TRANSACAO.TRA_TRANSACAO/init = vDtTransacao
		retrieve/o "TRA_TRANSACAO"
		if ($status = -7)
			retrieve/x "TRA_TRANSACAO"
			if (TP_DOCTO.GER_OPERACAO = 2) | (TP_DOCTO.GER_OPERACAO = 3) ;ECF
				if ($inTrocaDocumento$ != <TRUE>)
					$inECF$ = <TRUE>
				else
					$inECF$ = <FALSE>
				endif
			endif
			
			if (TP_MODALIDADE.GER_OPERACAO = 8) ;Troca
				$inTroca$ = <TRUE>
			endif

			if (!$empty("CTC_TRACARTAO"))
				if ($cdCartao$ != 0) & (CD_CARTAO.CTC_TRACARTAO != $cdCartao$)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível fazer recebimento com cartões diferentes!", "")
					return(-1) 
				endif
				$cdCartao$    = CD_CARTAO.CTC_TRACARTAO
				$nrSeqCartao$ = NR_SEQCARTAO.CTC_TRACARTAO ;---Elia Proj. 78/1886 02/10/08
				$vlTotBonus$  = $vlTotBonus$ + VL_BONUSUTIL.CTC_TRACARTAO
			endif
			
			viParams = ""
			putitem/id viParams, "CD_EMPRESA",   CD_EMPRESA.TRA_TRANSACAO
			putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			activate "GERSVCO058".buscaValorFinanceiroTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			vVlFinanceiro = $item("VL_FINANCEIRO", voParams)
			
			if (vVlFinanceiro != VL_TOTAL.TRA_TRANSACAO)
				$inFinanceiro$ = <TRUE>
				fieldsyntax BT_F6.SIS_BOTOES2, "DIM"
				$inF6$ = <FALSE>
			endif
			
			VL_TOTAL.TRA_TRANSACAO/init = vVlFinanceiro
		elseif($status = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Transação %%vNrTransacao não cadastrada!", "")
			return(-1) 
		endif

		if ($cdPessoa$ = 0)
			$cdPessoa$ = CD_PESSOA.TRA_TRANSACAO
		endif
		
		VL_TOTAL.SIS_DUMMY3    = VL_TOTAL.SIS_DUMMY3 + VL_TOTAL.TRA_TRANSACAO
		VL_RESTANTE.SIS_DUMMY3 = VL_RESTANTE.SIS_DUMMY3 + VL_TOTAL.TRA_TRANSACAO
		
		delitem vDsLstTransacao, 1
	until (vDsLstTransacao = "")
	
	if ($inECF$ = <TRUE>) & ($totocc("TRA_TRANSACAO") > 1)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Não é permitido o recebimento de mais de uma transação ECF ao mesmo tempo!", "")
		return(-1)
	endif

	if ($inTroca$ = <TRUE>)
		if ($totocc("TRA_TRANSACAO") > 1)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Não é permitido o recebimento de mais de uma transação de troca ao mesmo tempo!", "")
			return(-1)
		endif
		clear/e "TRA_TROCA"
		CD_EMPVEN.TRA_TROCA/init = CD_EMPRESA.TRA_TRANSACAO
		NR_TRAVEN.TRA_TROCA/init = NR_TRANSACAO.TRA_TRANSACAO
		DT_TRAVEN.TRA_TROCA/init = DT_TRANSACAO.TRA_TRANSACAO
		retrieve/e "TRA_TROCA"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Nenhuma transação de devolução relacionada com a transação de troca!", "")
			return(-1)
		endif
	endif
	
	if ($cdPessoa$ = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Pessoa não informada!", "")
		return(-1) 
	endif
	
;oda	clear/e "PES_PESSOA"
;	CD_PESSOA.PES_PESSOA/init = $cdPessoa$
;	retrieve/e "PES_PESSOA"
;	if ($status < 0)
;		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa %%$cdPessoa$ não cadastrada!", "")
;		return(-1) 
;	endif
	
	setocc "TRA_TRANSACAO", 1		

	$nrFaturaPadrao$ = ""

	;---Elia Proj. 102/19 28/01/08	
	if (TP_DOCTO.GER_OPERACAO = 2) | (TP_DOCTO.GER_OPERACAO = 3) ;ECF
		$nrFaturaPadrao$ = vNrTransacao
	else
	;
		clear/e "FIS_NF"
		retrieve/e "FIS_NF"
		if ($status >= 0)
			setocc "FIS_NF", 1
;			if (TP_SITUACAO.FIS_NF = "E") ;Emitida
			if (NR_NF.FIS_NF > 0)
				$nrFaturaPadrao$ = NR_NF.FIS_NF
			endif
		endif
	endif

	if ($inPDVOtimizado$ = <TRUE>)
		fieldsyntax VL_DOCUMENTO.SIS_TOTAL,     "HID"
		fieldsyntax IN_ADIANTATROCO.SIS_DUMMY3, "HID"
	endif
	
	viParams = ""
	putitem/id viParams, "CD_OPERACAO", CD_OPERACAO.GER_OPERACAO
	activate "GERSVCO054".dadosAdicionaisOperacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif	
	
	if ($item("TP_IMPRESSAOTRA", voParams) = 1)
		$tpImpressaoTraVenda$ = 0
	endif

	return(0)    
end

;---------------------------------
partner operation validaTransacao
	;---------------------------------
	variables
		string  vDsRegistro, vDsLstTransacao, vDsSituacao
		numeric vCdEmpresa, vNrTransacao
		date    vDtTransacao
	endvariables
	
	if ($inPerguntaCpfCnpj$ = <TRUE>)
		if (CD_PESSOA.TRA_TRANSACAO = $cdClientePDV$ & $inPdvOtimizado$ = <TRUE>)
			askmess "O CPF/CNPJ não foi informado! Deseja continuar?", "Não,Sim" 
			if($status = 1)
				return(-1)
			endif
		endif
	endif

	clear/e "TRA_S_TRANSACAO"
	
	vDsLstTransacao = $dsLstTransacao$
	repeat
		getitem vDsRegistro, vDsLstTransacao, 1
		
		vCdEmpresa   = $item("CD_EMPRESA",   vDsRegistro)
		vNrTransacao = $item("NR_TRANSACAO", vDsRegistro)
		vDtTransacao = $item("DT_TRANSACAO", vDsRegistro)
		
		if (vCdEmpresa = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Empresa não informada!", "")
			return(-1)
		endif
		
		if (vNrTransacao = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Nr. transação não informado!", "")
			return(-1) 
		endif
		
		if (vDtTransacao = "")
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Dt. transação não informada!", "")
			return(-1)
		endif		
		
		creocc "TRA_S_TRANSACAO", -1
		CD_EMPRESA.TRA_S_TRANSACAO/init   = vCdEmpresa
		NR_TRANSACAO.TRA_S_TRANSACAO/init = vNrTransacao
		DT_TRANSACAO.TRA_S_TRANSACAO/init = vDtTransacao
		retrieve/o "TRA_S_TRANSACAO"		
		if ($status = -7)
			retrieve/x "TRA_S_TRANSACAO"
			if (TP_SITUACAO.TRA_S_TRANSACAO != 5)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Transação %%vNrTransacao não está encerrada!", "")
				return(-1)
			endif
		elseif($status = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Transação %%vNrTransacao não cadastrada!", "")
			return(-1) 
		endif
		
		delitem vDsLstTransacao, 1
	until (vDsLstTransacao = "")
	
	return(0)
end

;--------------------------
partner operation criaValor
;--------------------------
	variables
		string  viParams, voParams
		numeric vNrFat
	endvariables
	
	setocc "SIS_VALOR", 1
	
	if ($tpSimuladorFat$ > 0 | $inSimuladorProduto$ = <TRUE> | $inSimuladorCondPgto$ = <TRUE>) & ($inDinheiro$ != <TRUE>) & (VL_TRANSACAO.TRA_TRANSACAO > VL_TOTAL.R_TRA_TRANSACAO) ;-=CANONICO=- TAR593/PRJ102 (13/07/2009) - condição transacao maior que a troca 
		$instancehandle->carregaSimulacao()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
		
		$instancehandle->calculaPrazoMedio()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif
		
		$instancehandle->calculaTotal()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif
		
		setocc "SIS_VALOR", 1
	else
		if ($inDinheiro$ = <TRUE>) | ($inTroca$ = <TRUE>)
			viParams = ""
			putitem/id viParams, "NM_ENTIDADE", "FCR_FATURAI"
			activate "GERSVCO031".getNumSeq($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			
			vNrFat = $item("NR_SEQUENCIA", voParams)		
			
			if ($inDinheiro$= <TRUE>)
				VL_DOCUMENTO.SIS_VALOR  = VL_TOTAL.SIS_DUMMY3
				TP_DOCUMENTO.SIS_VALOR  = 3 ;Dinheiro
				NR_DOCUMENTO.SIS_VALOR  = vNrFat
				DT_VENCIMENTO.SIS_VALOR = $item("DT_SISTEMA", $$gParamGlb)
				VL_DOCUMENTO.SIS_TOTAL  = VL_DOCUMENTO.SIS_VALOR
			elseif ($inTroca$ = <TRUE>)
				VL_DOCUMENTO.SIS_VALOR  = VL_CREDDEV.SIS_ADIANTAMENTO
				TP_DOCUMENTO.SIS_VALOR  = 20 ;CREDEV
				NR_DOCUMENTO.SIS_VALOR  = vNrFat
				DT_VENCIMENTO.SIS_VALOR = $item("DT_SISTEMA", $$gParamGlb)
				VL_DOCUMENTO.SIS_TOTAL  = VL_DOCUMENTO.SIS_VALOR
			endif
			
			$instancehandle->calculaTotal()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
			endif	
			
			creocc "SIS_VALOR", -1
		endif
		
		if ($tpDocumento$ > 0)
			if (VL_RESTANTE.SIS_DUMMY3 > 0)
				if ($tpDocumento$ = 3) ;Dinheiro
					viParams = ""
					putitem/id viParams, "NM_ENTIDADE", "FCR_FATURAI"
					activate "GERSVCO031".getNumSeq($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					vNrFat = $item("NR_SEQUENCIA", voParams)
					NR_DOCUMENTO.SIS_VALOR  = vNrFat
					DT_VENCIMENTO.SIS_VALOR = $item("DT_SISTEMA", $$gParamGlb)
				endif	
				VL_DOCUMENTO.SIS_VALOR = VL_RESTANTE.SIS_DUMMY3
				TP_DOCUMENTO.SIS_VALOR = $tpDocumento$
				VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL + VL_DOCUMENTO.SIS_VALOR
			endif	
			
			$instancehandle->calculaTotal()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
			endif		
		endif
	endif
	
	return(0)
end

;----------------------------------
partner operation calculaPrazoMedio
	;----------------------------------
	variables
		numeric vNrOcc, vVlCalc, vVlTotal
		date    vDtSistema
	endvariables
	
	vDtSistema = $item("DT_SISTEMA", $$gParamGlb)
	
	vVlTotal = 0
	VL_DOCUMENTO.SIS_TOTAL = 0 ;* Claudemir - Prj/Tarefa: 156/209 - 02/03/2010
	vNrOcc = $curocc("SIS_VALOR")
	setocc ("SIS_VALOR") , 1
	while ($status >= 0)
		if (TP_DOCUMENTO.SIS_VALOR != 18) ;Cheque presente	;--Douglas Ferreira - [Prj/Tarefa 180/0040] - 06/01/2011
			vVlTotal = vVlTotal + (VL_DOCUMENTO.SIS_VALOR * (DT_VENCIMENTO.SIS_VALOR - vDtSistema))
			VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL + VL_DOCUMENTO.SIS_VALOR ;* Claudemir - Prj/Tarefa: 156/209 - 02/03/2010
		endif
		setocc "SIS_VALOR" , $curocc("SIS_VALOR") + 1        
	endwhile
	
	vVlCalc = vVlTotal / VL_DOCUMENTO.SIS_TOTAL
	QT_PRAZOMEDIO.SIS_TOTAL/init = vVlCalc[round, 1]
	
	setocc ("SIS_VALOR"), vNrOcc
	
	return(0)
end

;-----------------------------
partner operation calculaTotal
	;----------------------------- 
	
	variables
		numeric vNrOcc
	endvariables
	
    VL_DOCUMENTO.SIS_TOTAL = ""
	
	vNrOcc = $curocc("SIS_VALOR")
	setocc ("SIS_VALOR") , 1
	while ($status >= 0)
		VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL + VL_DOCUMENTO.SIS_VALOR
		setocc "SIS_VALOR" , $curocc("SIS_VALOR") + 1        
	endwhile
	
	setocc ("SIS_VALOR"), vNrOcc
   
	VL_RESTANTE.SIS_DUMMY3 = VL_TOTAL.SIS_DUMMY3 - VL_DOCUMENTO.SIS_TOTAL
	if (VL_RESTANTE.SIS_DUMMY3 < 0)
		VL_TROCO.SIS_DUMMY3    = $abs(VL_RESTANTE.SIS_DUMMY3)
		VL_RESTANTE.SIS_DUMMY3 = ""
	else
		VL_TROCO.SIS_DUMMY3    = ""
	endif
	if (VL_MAXTROCO.SIS_ADIANTAMENTO > 0)
		VL_DIF.SIS_ADIANTAMENTO = VL_MAXTROCO.SIS_ADIANTAMENTO - VL_DOCUMENTO.SIS_TOTAL
	endif
	
	return(0)
end

;----------------------------------
partner operation validaRecebimento
;----------------------------------    

	variables
		string  viParams, voParams, vDsLstParcelamento, vDsRegistro, vDsConta, vDsBanda, vDsAdicional
		numeric vVlCalc, vVlDinheiro, vVlCheque, vVlChequeVista, vVlDesconto, vNrDias, vNrDiasTotal, vNrCheque, vNrAgencia, vNrBanco
		numeric vVlDOFNI, vPrTroco, vNrSeqTotTEF, vVlVista, vVlPrazo, vNrPrzMedioMax, vNrPrazoMedioPgto
		date    vDtSistema
		boolean vInCheque, vInCartaoProprio
		string  vDsLstUsuario, vDsRestricao
	endvariables
	
	vDtSistema = $item("DT_SISTEMA", $$gParamGlb)
	vNrDias    = $item("NR_DIAS_PRAZOMED_LIB_FAT", $xlplemp$)
	
	vVlDinheiro        = 0
	vVlCheque          = 0
	vVlDesconto        = 0
	$vlVista$          = 0
	$vlPrazo$          = 0
	$vlAdiantamento$   = 0
	$vlCREDEV$         = 0
	vDsLstParcelamento = ""
	
	if ($tpSimuladorFat$ = 2)
		if (vNrDias != "")
			vNrDiasTotal = vNrDias + $nrPrazoMedio$
			
			if (QT_PRAZOMEDIO.SIS_TOTAL > vNrDiasTotal)
				if (vNrDias = 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Prazo médio %%QT_PRAZOMEDIO.SIS_TOTAL%%% superior ao escolhido pela simulação que é de %%$nrPrazoMedio$ dia(s)!", "")
				else
					$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Prazo médio %%QT_PRAZOMEDIO.SIS_TOTAL%%% superior ao escolhido pela simulação que é de %%$nrPrazoMedio$ dia(s)%%^ Mais o número de dias do parâmetro NR_DIAS_PRAZOMED_LIB_FAT que é de %%vNrDias%%%!", "")
				endif	
				
				$instancehandle->verificaRestricao($componentname,"IN_LIBERA_PRAZOMEDIO",0)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					return(-1)
				endif
			endif
		endif
	else
		viParams = ""
		putitem/id viParams, "CD_CONDPGTO", CD_CONDPGTO.TRA_TRANSACAO
		activate "GERSVCO013".calcPrzMedio(viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		
		vNrPrazoMedioPgto = $item("NR_PRAZOMEDIO", voParams)
		
		if (vNrDias != "")
			vNrDiasTotal = vNrDias + vNrPrazoMedioPgto
			if (QT_PRAZOMEDIO.SIS_TOTAL > vNrDiasTotal)
				if (vNrDias = 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Prazo médio %%QT_PRAZOMEDIO.SIS_TOTAL%%% superior ao da forma de pagamento que é %%vNrPrazoMedioPgto dia(s)!", "")
				else
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Prazo médio %%QT_PRAZOMEDIO.SIS_TOTAL%%% superior ao da forma de pagamento que é %%vNrPrazoMedioPgto dia(s)%%^ Mais o número de dias do parâmetro NR_DIAS_PRAZOMED_LIB_FAT que é de %%vNrDias%%%!", "")
				endif
				
				$instancehandle->verificaRestricao($componentname,"IN_LIBERA_PRAZOMEDIO",0)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					return(-1)
				endif
			endif
		endif			
	endif
	
	;limite transações TEF
	vNrSeqTotTEF   = 0
	$vInTefCartao$ = <FALSE> ;* Claudemir - Prj/Tarefa: 102/809 - 03/03/2010
	setocc "SIS_VALOR", 1
	while ($status >= 0)
		;-=CANONICO=- (18/03/2009) TAR 495 PRJ 102 - ADICIONADO TECBAN E HYPERCARD
		if (TP_DOCUMENTO.SIS_VALOR = 7) | ($tpTEF$ = 2 & TP_DOCUMENTO.SIS_VALOR = 8) | (TP_DOCUMENTO.SIS_VALOR = 19) | (TP_DOCUMENTO.SIS_VALOR = 22) ; TEF / Cheque TEF / TEF/TECBAN / TEF/HYPERCARD
			$inTEF$      = <TRUE>
			vNrSeqTotTEF = vNrSeqTotTEF + 1
		endif
		;* Claudemir - Prj/Tarefa: 102/809 - 03/03/2010
		; Verifica se o recebimento é em TEF ou Cartao debito ou Cartao credito
			; Cartao credito                ; Cartao debito               ; TEF                          ;Cheque TEF                    ;TEF - TECBAN                   ;TEF HYPERCARD 
		if  (TP_DOCUMENTO.SIS_VALOR = 4) | (TP_DOCUMENTO.SIS_VALOR = 5) | (TP_DOCUMENTO.SIS_VALOR = 7) | (TP_DOCUMENTO.SIS_VALOR = 8) | (TP_DOCUMENTO.SIS_VALOR = 19) | (TP_DOCUMENTO.SIS_VALOR = 22)
			$vInTefCartao$ = <TRUE>	
		endif ;*
		setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
	endwhile
	;-=CANONICO=- (18/03/2009) TAR 495 PRJ 102 - Limitado a 5 cartões. Motivo o Rel.Gerencial permance somente 2 minutos aberto.
	if (vNrSeqTotTEF > 5)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Venda limitada somente a 5 transações TEF!", "")
		return(-1)
	endif

	clear/e "TMP_NR10"

	if ($empty("SIS_VALOR") != 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhum valor informado!", "")
		return(-1) 
	endif
	
	if (VL_RESTANTE.SIS_DUMMY3 > 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor recebido menor que o valor a receber!", "")
		return(-1) 
	endif

	if (IN_ADIANTATROCO.SIS_DUMMY3 = <TRUE>) & (VL_TROCO.SIS_DUMMY3 > 0)
		askmess "Deseja lançar troco como adiantamento?", "Confirmar,Cancelar"
		if ($status = 2)
			return (-1)
		endif
	endif
	;Projeto 078 - Tarefa 3596 - Aloisio Gargantini - 05/08/2010
	clear/e "TMP_NR10"
	;
	setocc "SIS_VALOR", 1
	while ($status >= 0)    
		if (TP_DOCUMENTO.SIS_VALOR = 0)
			if (VL_DOCUMENTO.SIS_VALOR > 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor sem tipo de documento informado!", "")
				return(-1) 
			else
				discard "SIS_VALOR"
				if ($status <= 0)
					$status = -1
				endif
			endif
		else
			if (VL_DOCUMENTO.SIS_VALOR = 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Tipo documento sem valor informado!", "")
				return(-1)
			endif
			if (NR_DOCUMENTO.SIS_VALOR = 0)
				if (TP_DOCUMENTO.SIS_VALOR = 2) ;Cheque
				else
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor sem documento informado!", "")
					return(-1)
				endif
			endif
			if (TP_DOCUMENTO.SIS_VALOR = 3) ;Dinheiro
				vVlDinheiro = vVlDinheiro + VL_DOCUMENTO.SIS_VALOR
			elseif (TP_DOCUMENTO.SIS_VALOR = 2) ;Cheque
				;Projeto 078 - Tarefa 3596 - Aloisio Gargantini - 05/08/2010
				;if (NR_GERAL.TMP_NR10 > 0)
				if (NR_DOCUMENTO.SIS_VALOR > 0)
				;
					creocc "TMP_NR10", -1
					NR_GERAL.TMP_NR10/init = NR_DOCUMENTO.SIS_VALOR
					retrieve/o "TMP_NR10"
					if ($status = 4)
						askmess "Existe mais de um cheque com o número %%NR_DOCUMENTO.SIS_VALOR%%%! Continuar?", "Não, Sim"
						if ($status = 1) 
							return(-1) 
						endif	
					endif	
				endif
				vVlCheque = vVlCheque + VL_DOCUMENTO.SIS_VALOR
				if (DT_VENCIMENTO.SIS_VALOR = vDtSistema)
					vVlChequeVista = vVlChequeVista + VL_DOCUMENTO.SIS_VALOR
				endif
			;Projeto 180 - Tarefa 0185 - Aloisio Gargantini - 16/06/2011
			elseif (TP_DOCUMENTO.SIS_VALOR = 18) ;Cheque Presente
				if (NR_DOCUMENTO.SIS_VALOR > 0)
					creocc "TMP_NR10", -1
					NR_GERAL.TMP_NR10/init = NR_DOCUMENTO.SIS_VALOR
					retrieve/o "TMP_NR10"
					if ($status = 4)
						$instancehandle->setStatus(<STS_AVISO>, "GEN001", "DESCRICAO=Existe mais de um lançamento para o mesmo cheque presente!", "")
						return(-1) 
					endif	
				endif
			;
			elseif (TP_DOCUMENTO.SIS_VALOR = 10) ;Adiantamento
				$vlAdiantamento$ = $vlAdiantamento$ + VL_DOCUMENTO.SIS_VALOR
			elseif (TP_DOCUMENTO.SIS_VALOR = 11) ;Desconto
				vVlDesconto = vVlDesconto + VL_DOCUMENTO.SIS_VALOR
			elseif (TP_DOCUMENTO.SIS_VALOR = 12) ;DOFNI
				vVlDOFNI = vVlDOFNI + VL_DOCUMENTO.SIS_VALOR
			elseif (TP_DOCUMENTO.SIS_VALOR = 15) ;Cheque garantido
				;Projeto 078 - Tarefa 3596 - Aloisio Gargantini - 05/08/2010
				;if (NR_GERAL.TMP_NR10 > 0)
				if (NR_DOCUMENTO.SIS_VALOR > 0)
				;
					creocc "TMP_NR10", -1
					NR_GERAL.TMP_NR10/init = NR_DOCUMENTO.SIS_VALOR
					retrieve/o "TMP_NR10"
					if ($status = 4)
						askmess "Existe mais de um cheque com o número %%NR_DOCUMENTO.SIS_VALOR%%%! Continuar?", "Não, Sim"
						if ($status = 1) 
							return(-1) 
						endif	
					endif	
				endif
				viParams = ""
				putitem/id viParams, "CD_GUIA",       CD_GUIA.TRA_TRANSACAO
				putitem/id viParams, "NR_CHEQUE",     $item("NR_CHEQUE",  DS_ADICIONAL.SIS_VALOR) 
				putitem/id viParams, "DT_EMISSAO",    $item("DT_SISTEMA", $$gParamGlb)		
				putitem/id viParams, "VL_CHEQUE",     VL_DOCUMENTO.SIS_VALOR
				putitem/id viParams, "DT_VENCIMENTO", DT_VENCIMENTO.SIS_VALOR
				activate "FGRSVCO024".validarCheque($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif

				vVlCheque = vVlCheque + VL_DOCUMENTO.SIS_VALOR
				if (DT_VENCIMENTO.SIS_VALOR = vDtSistema)
					vVlChequeVista = vVlChequeVista + VL_DOCUMENTO.SIS_VALOR
				endif
			elseif (TP_DOCUMENTO.SIS_VALOR = 20) ;Adiantamento
				$vlCREDEV$ = $vlCREDEV$ + VL_DOCUMENTO.SIS_VALOR
			endif

			if (TP_DOCUMENTO.SIS_VALOR = 1) | (TP_DOCUMENTO.SIS_VALOR = 14) ;Fatura / Nota promissória
				$vlPrazo$ = $vlPrazo$ + VL_DOCUMENTO.SIS_VALOR
			;---Elia Proj. 102/404 01/10/08
			elseif (TP_DOCUMENTO.SIS_VALOR = 4) ; 4 - Cartao de credito
				if ($cdCartao$ != 0)
					viParams = ""
					putitem/id viParams, "CD_CARTAO",        $cdCartao$
					putitem/id viParams, "TP_DOCUMENTO",     TP_DOCUMENTO.SIS_VALOR
					putitem/id viParams, "NR_SEQHISTRELSUB", $item("NR_SEQHISTRELSUB", DS_ADICIONAL.SIS_VALOR)
					activate "CTCSVCO004".verificaTipoCartao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					vInCartaoProprio = $item("IN_CARTAOPROPRIO", voParams)

					if (vInCartaoProprio = <TRUE>)
						$vlPrazo$ = $vlPrazo$ + VL_DOCUMENTO.SIS_VALOR
					else
						$vlVista$ = $vlVista$ + VL_DOCUMENTO.SIS_VALOR
					endif
				else
					$vlVista$ = $vlVista$ + VL_DOCUMENTO.SIS_VALOR
				endif
			;
			else
				if (DT_VENCIMENTO.SIS_VALOR = vDtSistema)
					$vlVista$ = $vlVista$ + VL_DOCUMENTO.SIS_VALOR
				else
					$vlPrazo$ = $vlPrazo$ + VL_DOCUMENTO.SIS_VALOR
				endif
			endif

			;---Elia Proj. 133/007 18/08/08
			vDsRegistro = ""
			putitem/id vDsRegistro, "TP_DOCUMENTO",     TP_DOCUMENTO.SIS_VALOR
			putitem/id vDsRegistro, "NR_SEQHISTRELSUB", $item("NR_SEQHISTRELSUB", DS_ADICIONAL.SIS_VALOR)
			putitem vDsLstParcelamento, -1, vDsRegistro
			;
			setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
		endif
	endwhile
	;Projeto 078 - Tarefa 3596 - Aloisio Gargantini - 05/08/2010
	clear/e "TMP_K04NRDS"
	setocc  "SIS_VALOR", 1
	while ($status >= 0)    
		if (TP_DOCUMENTO.SIS_VALOR = 2) | (TP_DOCUMENTO.SIS_VALOR = 15) ;Cheque/Cheque garantido	

			vDsAdicional = DS_ADICIONAL.SIS_VALOR			
			;* Claudemir - Prj/Tarefa: 102/985 - 26/10/2010 - Adicionado o "if" abaixo (apenas)
			if (vDsAdicional != "") ;* 
				vNrBanco   = $item("NR_BANCO",   vDsAdicional)
				vNrAgencia = $item("NR_AGENCIA", vDsAdicional)
				vNrCheque  = $item("NR_CHEQUE",  vDsAdicional)
				vDsConta   = $item("NR_CONTA",   vDsAdicional)
				vDsBanda   = $item("NR_BANDA",   vDsAdicional)
				if (vDsBanda != "")
					clear/e "FCR_CHEQUE"
					DS_BANDA.FCR_CHEQUE/init = vDsBanda
					retrieve/e "FCR_CHEQUE"
					if ($status >=0)
						setocc "FCR_CHEQUE", 1
						while ($status >= 0)
							clear/e "F_FCR_FATURAI"
							CD_EMPRESA.F_FCR_FATURAI/init = CD_EMPRESA.FCR_CHEQUE
							CD_CLIENTE.F_FCR_FATURAI/init = CD_CLIENTE.FCR_CHEQUE
							NR_FAT.F_FCR_FATURAI/init     = NR_FAT.FCR_CHEQUE
							NR_PARCELA.F_FCR_FATURAI/init = NR_PARCELA.FCR_CHEQUE
							retrieve/e "F_FCR_FATURAI"
							if ($status >= 0) & (TP_SITUACAO.F_FCR_FATURAI = 1) ; Normal
								$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Banda de cheque já cadastrada.", "")
								return(-1)
							endif						
						
							setocc "FCR_CHEQUE", $curocc("FCR_CHEQUE") + 1
						endwhile
					endif
				elseif (vNrBanco > 0) & (vNrAgencia > 0) & (vNrCheque > 0) & (vDsConta != "")
					clear/e "FCR_CHEQUE"
					NR_BANCO.FCR_CHEQUE/init   = vNrBanco
					NR_AGENCIA.FCR_CHEQUE/init = vNragencia
					DS_CONTA.FCR_CHEQUE/init   = vDsConta
					NR_CHEQUE.FCR_CHEQUE/init  = vNrCheque
					retrieve/e "FCR_CHEQUE"
					if ($status >= 0)
						setocc "FCR_CHEQUE", 1
						while ($status >= 0)
							clear/e "F_FCR_FATURAI"
							CD_EMPRESA.F_FCR_FATURAI/init = CD_EMPRESA.FCR_CHEQUE
							CD_CLIENTE.F_FCR_FATURAI/init = CD_CLIENTE.FCR_CHEQUE
							NR_FAT.F_FCR_FATURAI/init     = NR_FAT.FCR_CHEQUE
							NR_PARCELA.F_FCR_FATURAI/init = NR_PARCELA.FCR_CHEQUE
							retrieve/e "F_FCR_FATURAI"
							if ($status >= 0) & (TP_SITUACAO.F_FCR_FATURAI = 1) ; Normal
								$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cheque já cadastrado.", "")
								return(-1)
							endif						
							
							setocc "FCR_CHEQUE", $curocc("FCR_CHEQUE") + 1
						endwhile
					endif
				endif
				creocc "TMP_K04NRDS", -1
				NR_CHAVE01.TMP_K04NRDS = vNrBanco
				NR_CHAVE02.TMP_K04NRDS = vNrAgencia
				NR_CHAVE03.TMP_K04NRDS = vNrCheque
				DS_CHAVE04.TMP_K04NRDS = vDsConta
				retrieve/o "TMP_K04NRDS"	
				if ($status = 4) 
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cheque já lançado. Favor excluir o duplicado e incluir outro válido.", "")
					return(-1)
				endif
				DS_BANDA.TMP_K04NRDS = vDsBanda

			endif ;* Claudemir - Prj/Tarefa: 102/985 - 26/10/2010

		endif

		setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
	endwhile


	;---Elia Proj. 133/007 18/08/08
	if ($cdCartao$ != 0)
		viParams = ""
		putitem/id viParams, "CD_CARTAO", $cdCartao$
		putitem/id viParams, "DS_LSTPARCELAMENTO", vDsLstParcelamento
		activate "CTCSVCO004".verificaParcelamentoCartao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		$inParCartaoProprio$ = $item("IN_PARCARTAOPROPRIO", voParams)
	endif
	;

	$instancehandle->validaLimite()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif

	if ($status < 0)
		return(-1)
	endif
	
;	if (VL_MAXTROCO.SIS_ADIANTAMENTO > 0)
	if ($inTrocoMaximo$ = <TRUE>)
		viParams = ""
		putitem/id viParams, "VL_MAXTROCO",    VL_MAXTROCO.SIS_ADIANTAMENTO
		putitem/id viParams, "VL_RECEBER",     VL_TOTAL.SIS_DUMMY3
		putitem/id viParams, "VL_RECEBIDO",    VL_DOCUMENTO.SIS_TOTAL		
		putitem/id viParams, "VL_CHEQUEVISTA", vVlCheque
		putitem/id viParams, "VL_DINHEIRO",    vVlDinheiro
		activate "SICSVCO005".validaVlMaxTroco($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	else    
		if (VL_TROCO.SIS_DUMMY3 > 0)
			if (vVlDinheiro > 0)
				if (VL_TROCO.SIS_DUMMY3 >= vVlDinheiro)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Valor de troco maior que o valor em dinheiro!", "")
					return(-1) 
				endif
;			elseif (vVlChequeVista > 0)
			elseif (vVlCheque > 0)
				if (VL_TROCO.SIS_DUMMY3 >= vVlCheque)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Valor de troco maior que o valor em cheque!", "")
					return(-1) 
				endif
			elseif (vVlDOFNI > 0)
				if (VL_TROCO.SIS_DUMMY3 >= vVlDOFNI)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Valor de troco maior que o valor em DOFNI!", "")
					return(-1) 
				endif
			elseif ($vlCREDEV$ > 0) & ($inTroca$ = <TRUE>)
				if (VL_TROCO.SIS_DUMMY3 > $vlCREDEV$)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Valor de troco maior que o valor em CREDEV de troca!", "")
					return(-1) 
				endif
			else
				$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Valor de troco inválido! Não exite valor em dinheiro, cheque, DOFNI ou CREDEV de troca!", "")
				return(-1) 
			endif
			if ($inPDVOtimizado$ != <TRUE>)
				vPrTroco = (VL_TROCO.SIS_DUMMY3 / VL_TOTAL.SIS_DUMMY3) * 100
				if (vPrTroco > 10) & ($inValidaMsgTroco$ = <TRUE>)
					askmess "Troco maior que 10% do valor recebido! Deseja realmente continuar?", "Não, Sim"
					if ($status = 1)
						return(-1)
					endif
				endif
			endif
		endif
	endif

	if (vVlDesconto > 0)
		clear/e "TRA_LIMDESCONTO"
		CD_OPERACAO.TRA_LIMDESCONTO/init = CD_OPERACAO.TRA_TRANSACAO
		CD_USUARIO.TRA_LIMDESCONTO/init  = $item("CD_USUARIO", $$gParamGlb)
		retrieve/e "TRA_LIMDESCONTO"
		if ($status >= 0)
			$prDescMaximo$ = PR_DESCMAX.TRA_LIMDESCONTO
		else
			clear/e "TRA_LIMDESCONTO"
			$prDescMaximo$ = 0
		endif
		;>-- MAC - PRJ 156 TAR 181 - 10/02/2010 ---
		vDsRestricao = "VL_DESC_MAX_FINANC"
		viParams     = ""
		putitem/id viParams, "CD_COMPONENTE", $componentname  ;Componente em execução
		putitem/id viParams, "DS_CAMPO"     , vDsRestricao
		activate "ADMSVCO009".verificaUsuarioRestricao($$gParamGlb,viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxerro$, "")
			return(-1)
		endif
		vDsLstUsuario = $item("DS_LSTUSUARIO", voParams)

		if(vDsLstUsuario != "")
			$instancehandle->verificaRestricao($componentname,vDsRestricao,vVlDesconto)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				return(-1)
			endif
		endif
		;--<
		
		vVlCalc = (($vlTotalBruto$ - $vlTotalLiquido$) + vVlDesconto) / $vlTotalBruto$ * 100
		$prDescTransacao$ = vVlCalc[round, 6]
		if ($prDescTransacao$ > $prDescMaximo$)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Perc. de desconto %%$prDescTransacao$ maior que o máximo permitido de %%$prDescMaximo$%%%! Existe desconto na(s) transação(ões)!", "")
			return(-1)
		endif
	endif
	
	if ($vlAdiantamento$ > 0)
		if ($vlAdiantamento$ > VL_ADIANTAMENTO.SIS_ADIANTAMENTO)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor maior que o saldo de Adiantamento!", "")
			return(-1)
		endif
	endif
	
	if ($vlCREDEV$ > 0)
		if ($vlCREDEV$ > VL_CREDDEV.SIS_ADIANTAMENTO)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor maior que o saldo de CREDEV!", "")
			return(-1)
		endif
	endif
	
	if (vVlCheque > 0) ;Inclusão dos dados dos cheques
		vInCheque = <FALSE>
		setocc "SIS_VALOR", 1
		while ($status >= 0)
			if (TP_DOCUMENTO.SIS_VALOR = 2) & (DS_OBSERVACAO.SIS_VALOR = "")
				$instancehandle->BT_12()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif
				if ($status < 0)
					return(-1)
				endif
				vInCheque = <TRUE>
			endif
			setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1        
		endwhile
		if (vInCheque = <TRUE>)
			return(-1)
		endif
	endif
	
	if ($NrPrazoMedMax$ > 0)
		if (QT_PRAZOMEDIO.SIS_TOTAL > $NrPrazoMedMax$)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Prazo médio %%QT_PRAZOMEDIO.SIS_TOTAL maior que %%$NrPrazoMedMax$ permitido no parâmetro NR_PRAZOMEDIO_MAX_FAT!", "")
			$instancehandle->verificaRestricao($componentname, "IN_LIBERA_PRAZOMEDIO", 0)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				return(-1)
			endif
		endif			
	endif
	
	viParams = ""
	putitem/id viParams, "CD_PESSOA", CD_PESSOA.TRA_TRANSACAO
	;activate "GERSVCO046".buscaDadosPessoa($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$) ANO Pjt102 Trf358 - 18/07/2008
	activate "PESSVCO005".buscaDadosPessoa($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	vNrPrzMedioMax = $item("NR_PRZMEDIOMAX", voParams)
	
	if (vNrPrzMedioMax > 0) & (QT_PRAZOMEDIO.SIS_TOTAL > vNrPrzMedioMax)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Prazo médio do recebimento %%QT_PRAZOMEDIO.SIS_TOTAL ultrapassa o prazo médio máximo do cliente %%CD_PESSOA.TRA_TRANSACAO que é de %%vNrPrzMedioMax%%%!", "")
		return(-1)			  
	endif
	
	return(0)
end

;------------------------------------
partner operation descontoPromocional
;------------------------------------
	variables
		string viParams, voParams
	endvariables

	viParams = ""    
	putitem/id viParams, "CD_EMPRESA",   CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "SICSVCO001".descontoPromocional($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif 
	
	viParams = ""    
	putitem/id viParams, "CD_EMPRESA",   CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "SICSVCO001".validaDesconto($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	$tpImpressaoTEF$ = 4
	
	return(0)
end

;------------------------------------------
partner operation descontoPromocionalCCusto
;------------------------------------------
	variables
		string viParams, voParams
	endvariables
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA",   CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "SICSVCO001".descontoPromocionalCCusto($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	return(0)
end

;----------------------------------
partner operation incluiChequeBanda
;----------------------------------
	params
		string piDsLstCheque : IN
	endparams

	variables
		string  vDsRegistro, vDsLstCheque, vDsBanda, vDsAdicional
		numeric vNrBanco, vNrAgencia, vNrConta, vNrCheque, vVlCheque, vNrSeq
		date    vDtVencimento
	endvariables
	
	if (piDsLstCheque = "")
		return(0)
	endif
	
	vNrSeq       = 0
	vDsLstCheque = piDsLstCheque
	
	repeat
		vNrSeq = vNrSeq + 1
		if (vNrSeq > 1)
			creocc "SIS_VALOR", -1
		endif
		
		getitem vDsRegistro, vDsLstCheque, 1
		vNrBanco      = $item("NR_BANCO",      vDsRegistro)
		vNrAgencia    = $item("NR_AGENCIA",    vDsRegistro)
		vNrConta      = $item("NR_CONTA",      vDsRegistro)
		vNrCheque     = $item("NR_CHEQUE",     vDsRegistro)
		vDsBanda      = $item("DS_BANDA",      vDsRegistro)
		vVlCheque     = $item("VL_CHEQUE",     vDsRegistro)
		vDtVencimento = $item("DT_VENCIMENTO", vDsRegistro)
		
		vDsAdicional  = ""
		putitem/id vDsAdicional, "NR_BANCO",   vNrBanco
		putitem/id vDsAdicional, "NR_AGENCIA", vNrAgencia
		putitem/id vDsAdicional, "NR_CONTA",   vNrConta
		putitem/id vDsAdicional, "NR_CHEQUE",  vNrCheque
		putitem/id vDsAdicional, "NR_BANDA",   vDsBanda
		DS_ADICIONAL.SIS_VALOR/init = vDsAdicional
		
		vDsAdicional = "Banco: %%vNrBanco %%%/ Agência: %%vNrAgencia %%%/ Conta: %%vNrConta %%^%%%Nr. cheque: %%vNrCheque"    
		DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional    
		
		VL_DOCUMENTO.SIS_VALOR/init  = vVlCheque
		TP_DOCUMENTO.SIS_VALOR/init  = 2 ;Cheque
		NR_DOCUMENTO.SIS_VALOR/init  = vNrCheque		
		DT_VENCIMENTO.SIS_VALOR/init = vDtVencimento
		
		VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL + (VL_DOCUMENTO.SIS_VALOR)
		
		$instancehandle->calculaTotal()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif
		
		delitem vDsLstCheque, 1
	until (vDsLstCheque = "")
	
	creocc "SIS_VALOR", -1
	
	return(0)
end

;-------------------------
partner operation lancaTEF
;-------------------------
	params
		numeric piNrSequencia : IN
	endparams
	
	variables
		string  viParams, voParams, vDsAprovado, vDsMensagem, vDsAdicional, vDsConteudo
		numeric vNrLinhaCupom, vTpDocumento, vNrSeqHistRelSub, vVlParcela, vVlResto
		numeric vVlCalc, vNrOccAtual, vNrPrimeiraOcc, vNrDocumento, vNrParcela
		numeric vCdEmpresa, vNrSeq, vNrNsu, vCdAutorizacao  
		date    vDtMovimento
	endvariables
	
	$nrExtensao$ = piNrSequencia
	
	if ($tpTEF$ = 1) & ($tpImpViaTEF$ = 0)
		if ($tpImpViaCupomTEF$ = 4) 
			askmess "Imprimir via(s) do TEF:%%^","Ambas,Via do cliente, Via do estab."
			$tpImpViaTEF$ = $status
		else
			$tpImpViaTEF$ = $tpImpViaCupomTEF$		
		endif
	endif
	
	viParams = ""
	if (TP_DOCUMENTO.SIS_VALOR = 7) | (TP_DOCUMENTO.SIS_VALOR = 19) | (TP_DOCUMENTO.SIS_VALOR = 22) ; TEF - TEF/TECABAN - TEF/HIPERCARD
		;-=CANONICO=- (20/03/2009) TAR 495 PRJ 102
		if ($tpTEF$ = 2) ;TEF DISCADO	
			selectcase TP_DOCUMENTO.SIS_VALOR
			case 07 ;TEF
				$vDsCaminho$ = ":\TEF_DIAL\" 
			case 19 ;TEF/TECABAN
				$vDsCaminho$ = ":\TEF_DISC\" 
			case 22 ;TEF/HIPERCARD
				$vDsCaminho$ = ":\HiperTEF\" 
			elsecase
				$vDsCaminho$ = ""
			endselectcase    
		endif
		putitem/id viParams, "000-000", "CRT"
		putitem/id viParams, "001-000", NR_DOCUMENTO.SIS_VALOR
		if ($nrCupom$ > 0)
			putitem/id viParams, "002-000", $nrCupom$
		else
			putitem/id viParams, "002-000", NR_TRANSACAO.TRA_TRANSACAO
		endif
		putitem/id viParams, "003-000", "%%VL_DOCUMENTO.SIS_VALOR"
		putitem/id viParams, "502-001", "1"
		putitem/id viParams, "999-999", "0"
	elseif (TP_DOCUMENTO.SIS_VALOR = 8)
		putitem/id viParams, "000-000", "CHQ"
		putitem/id viParams, "001-000", NR_DOCUMENTO.SIS_VALOR
		if ($nrCupom$ > 0)
			putitem/id viParams, "002-000", $nrCupom$
		else
			putitem/id viParams, "002-000", NR_TRANSACAO.TRA_TRANSACAO
		endif
		putitem/id viParams, "003-000", "%%VL_DOCUMENTO.SIS_VALOR"
		putitem/id viParams, "999-999", "0"
	elseif (TP_DOCUMENTO.SIS_VALOR = 17)
		putitem/id viParams, "000-000", "PRE"
		putitem/id viParams, "001-000", NR_DOCUMENTO.SIS_VALOR
		if ($nrCupom$ > 0)
			putitem/id viParams, "002-000", $nrCupom$
		else
			putitem/id viParams, "002-000", NR_TRANSACAO.TRA_TRANSACAO
		endif
		putitem/id viParams, "003-000", "%%VL_DOCUMENTO.SIS_VALOR"
		putitem/id viParams, "999-999", "0"
	endif
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <TRUE>
	if ($tpTEF$ = 2)
		putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ ;-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
	endif
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-2)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-2)
	endif
	
	vDsConteudo = voParams
	
	vDsAprovado    = $item("009-000", vDsConteudo)
	vNrNsu         = $item("012-000", vDsConteudo) ;-=CANONICO=- (02/02/2011) TAR 507 PRJ 156 - Retornar NSU para poder conciliar extrato eletronico(FCRFP091)
	vCdAutorizacao = $item("013-000", vDsConteudo) ;-=CANONICO=- (18/03/2011) TAR 541 PRJ 156 - Baixa de cartão com TEF
	vNrLinhaCupom  = $item("028-000", vDsConteudo)
	vDsMensagem    = $item("030-000", vDsConteudo)

	if (vDsAprovado != "0")
		if ($tpTEF$ = 1)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=%%vDsMensagem%%%!", "")
		elseif ($tpTEF$ = 2)
			;no TEF DISCADO não deve existir exclamação ao final da mensagem
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=%%vDsMensagem", "")
		endif

		return(-2)
	endif

	;homologacao - FIUZA 13/11/06 - quando for consulta garantia de cheque na redecard não tem cupom
	;para ser impresso e sim somente um número de autorização para ser mostrado em tela
	if (TP_DOCUMENTO.SIS_VALOR != 8) | (TP_DOCUMENTO.SIS_VALOR = 8 & vNrLinhaCupom > 0)
		viParams = vDsConteudo
		putitem/id viParams, "CD_EMPRESA",      CD_EMPFAT.TRA_TRANSACAO
		putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".gravaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif

		vCdEmpresa   = $item("CD_EMPRESA",   voParams)
		vDtMovimento = $item("DT_MOVIMENTO", voParams)
		vNrSeq       = $item("NR_SEQ",       voParams)

		creocc "TEF_TRANSACAO", -1
		CD_EMPRESA.TEF_TRANSACAO   = vCdEmpresa
		DT_MOVIMENTO.TEF_TRANSACAO = vDtMovimento
		NR_SEQ.TEF_TRANSACAO       = vNrSeq
		retrieve/o "TEF_TRANSACAO"
		if ($status = -7)
			retrieve/x "TEF_TRANSACAO"
		elseif ($status = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Transação TEF %%vNrSeq não cadastrada!", "")
		endif

		if (vNrLinhaCupom = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=%%vDsMensagem%%%!", "")
			clear/e "TEF_TRANSACAO"
			return(-2)
		endif
	
		viParams = vDsConteudo
		activate "TEFSVCO010".buscaDadoCartao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif

		vTpDocumento     = $item("TP_DOCUMENTO",     voParams)
		vNrSeqHistRelSub = $item("NR_SEQHISTRELSUB", voParams)
	else
		;homologacao - FIUZA 13/11/06 - muda o documento para cheque para fechar o cupom fiscal
		;quando for redecard - consulta garantia de cheque	
		vTpDocumento     = 2
		vNrSeqHistRelSub = 1
		if (vNrLinhaCupom = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=%%vDsMensagem%%%!", "")
			clear/e "TEF_TRANSACAO"
		endif
	endif
	
	if (vTpDocumento = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Tipo documentoi não informado!", "")
		return(-1)
	endif
	
	if (vNrSeqHistRelSub = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Sequência cartão não informada!", "")
		return(-1)
	endif
	
	clear/e "FCX_HISTRELSUB"
	TP_DOCUMENTO.FCX_HISTRELSUB/init     = vTpDocumento
	NR_SEQHISTRELSUB.FCX_HISTRELSUB/init = vNrSeqHistRelSub
	retrieve/e "FCX_HISTRELSUB"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Histórico auxiliar de parcelamento %%NR_SEQHISTRELSUB.FCX_HISTRELSUB não cadastrado!", "")
		return(-1)
	endif
	
	vNrDocumento = NR_DOCUMENTO.SIS_VALOR
	vVlResto     = VL_DOCUMENTO.SIS_VALOR
	vVlCalc      = VL_DOCUMENTO.SIS_VALOR / NR_PARCELAS.FCX_HISTRELSUB
	vVlParcela   = vVlCalc[round, 2]
	
	$nrParcelas$ = $nrParcelas$ +  NR_PARCELAS.FCX_HISTRELSUB ;-=CANONICO=- (05/12/2008) TAR 415 PRJ 102
	
	vDsAdicional = DS_ADICIONAL.SIS_VALOR ;faz uma salva no caso do Cheque TEF
	discard "SIS_VALOR"
	vNrOccAtual  = $curocc("SIS_VALOR")
	
	vNrParcela     = 1
	vNrPrimeiraOcc = 0
	while (vNrParcela <= NR_PARCELAS.FCX_HISTRELSUB)
		creocc "SIS_VALOR", -1
		if (vNrPrimeiraOcc = 0)
			vNrPrimeiraOcc = $curocc("SIS_VALOR")
		endif
		VL_DOCUMENTO.SIS_VALOR/init  = vVlParcela
		TP_DOCUMENTO.SIS_VALOR/init  = TP_DOCUMENTO.FCX_HISTRELSUB
		NR_DOCUMENTO.SIS_VALOR/init  = vNrDocumento
		DT_VENCIMENTO.SIS_VALOR/init = $item("DT_SISTEMA", $$gParamGlb)
		if (TP_DOCUMENTO.SIS_VALOR = 4) | (TP_DOCUMENTO.SIS_VALOR = 5)
			vDsAdicional = ""
			putitem/id vDsAdicional, "NR_SEQHISTRELSUB", NR_SEQHISTRELSUB.FCX_HISTRELSUB
			putitem/id vDsAdicional, "NR_TRANSACAOTEF",  NR_SEQ.TEF_TRANSACAO
			putitem/id vDsAdicional, "CD_AUTORIZACAO",   vCdAutorizacao ;-=CANONICO=- (18/03/2011) TAR 541 PRJ 156 - Baixa de cartão com TEF
			putitem/id vDsAdicional, "NR_NSU",           vNrNsu ;-=CANONICO=- (18/03/2011) TAR 541 PRJ 156 - Baixa de cartão com TEF
			DS_ADICIONAL.SIS_VALOR/init = vDsAdicional
			vDsAdicional = "Operadora: %%NR_PORTADOR.FCX_HISTRELSUB - %%DS_PORTADOR.FGR_PORTADOR / %%DS_HISTRELSUB.FCX_HISTRELSUB"        
			DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional
		elseif (TP_DOCUMENTO.SIS_VALOR = 2)
			DS_ADICIONAL.SIS_VALOR/init  = vDsAdicional
		endif
		
		vVlResto   = vVlResto   - vVlParcela
		vNrParcela = vNrParcela + 1
	endwhile
	
	if (vVlResto != 0)
		setocc "SIS_VALOR", vNrPrimeiraOcc
		VL_DOCUMENTO.SIS_VALOR/init = VL_DOCUMENTO.SIS_VALOR + vVlResto
	endif
	
	setocc "SIS_VALOR", vNrOccAtual
	
	return(0)
end

;--------------------------------
partner operation imprimeCupomTEF
;--------------------------------
	variables
		string  viParams, voParams, vDsRegistro, vDsLstCartao, vNrSerie, vDsCupom
		string  vDs1Via, vDs2Via, vDsLinha, vDsConteudo
		boolean vInAchouCorte		
		boolean vInLoopImpressao, vInLoopConfirmacao, vInErroGerencial, vInErroVinculado, vInFaltaPapel
		numeric vTpImpressora, vTamNrSerie, vVlValorTEF
	endvariables

	vInFaltaPapel = <FALSE>
	vInErroVinculado = <FALSE>
	if ($empty("TEF_TRANSACAO") = 0)
		vVlValorTEF = 0
		setocc "TEF_TRANSACAO", -1
		setocc "TEF_TRANSACAO", 1
		while ($status >= 0)
			vVlValorTEF = vVlValorTEF + VL_TRANSACAO.TEF_TRANSACAO
			setocc "TEF_TRANSACAO", $curocc("TEF_TRANSACAO") + 1
		endwhile

		setocc "TEF_TRANSACAO", 1
		while ($status >= 0)
			clear/e "TEF_TIPOTRANS"
			TP_TEF.TEF_TIPOTRANS/init = TP_TEF.TEF_TRANSACAO
			TP_TRANSACAO.TEF_TIPOTRANS/init = TP_TRANSACAO.TEF_TRANSACAO
			retrieve/e "TEF_TIPOTRANS"
			if ($status >= 0)
				;no caso do TEF DEDICADO chama o serviço para montar a via que o cliente escolheu antes
				;de chamar o TEF.
				if ($tpTEF$ = 1)
					viParams = ""
					voParams = ""
					putitem/id viParams, "TP_VIA", $tpImpViaTEF$
					putitem/id viParams, "DS_CUPOM", DS_CUPOM.TEF_TRANSACAO
					activate "TEFSVCO010".buscaViaCartao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					vDsCupom = $item("DS_CUPOM", voParams)
				else
					vDsCupom = DS_CUPOM.TEF_TRANSACAO
				endif
				vDsRegistro = ""
				putitem/id vDsRegistro, "DS_MENSAGEM", DS_MENSAGEM.TEF_TRANSACAO
				putitem/id vDsRegistro, "DS_CUPOM", vDsCupom
				vDsLstCartao = ""
				putitem vDsLstCartao, -1, vDsRegistro

				viParams = ""
				putitem/id viParams, "DS_LSTCUPOM", vDsLstCartao
				if (TP_OPERCREDITO.TEF_TIPOTRANS = 1) ;Cartão crédito
					if ($inAgrupaCartaoTEF$ = <TRUE>)
						putitem/id viParams, "DS_FORMAPGTO", "Cartao"
					else
						putitem/id viParams, "DS_FORMAPGTO", "Cartao credito"
					endif
				elseif (TP_OPERCREDITO.TEF_TIPOTRANS = 2 | TP_OPERCREDITO.TEF_TIPOTRANS = 4) ;Cartão débito/CDC
					if ($inAgrupaCartaoTEF$ = <TRUE>)
						putitem/id viParams, "DS_FORMAPGTO", "Cartao"
					else
						putitem/id viParams, "DS_FORMAPGTO", "Cartao debito"
					endif
				elseif (TP_OPERCREDITO.TEF_TIPOTRANS = 3) ;Cheque TEF
					putitem/id viParams, "DS_FORMAPGTO", "Cheque"
				endif
				putitem/id viParams, "TP_IMPRESSAO", 1 ;Cupom não fiscal vinculado
				putitem/id viParams, "NR_CUPOM", $nrCupom$
				putitem/id viParams, "VL_VALOR", VL_TRANSACAO.TEF_TRANSACAO				
				putitem/id viParams, "VL_VALORTEF", vVlValorTEF

				;* Claudemir - Prj/Tarefa: 26/34 - 02/03/2010

				;if ($curocc("TEF_TRANSACAO") = 1)
				;	putitem/id viParams, "IN_ABREVINCULADO", <TRUE>
				;else
				;	putitem/id viParams, "IN_ABREVINCULADO", <FALSE>
				;endif
				;if ($next("CD_EMPRESA.TEF_TRANSACAO") = 0)
				;	putitem/id viParams, "IN_FECHAVINCULADO", <TRUE>
				;else
				;	putitem/id viParams, "IN_FECHAVINCULADO", <FALSE>
				;endif 

				; se for agrupar os cartões, abre e fecha apenas uma vez o cupom vinculado
				if ($inAgrupaCartaoTEF$ = <TRUE>)
					if ($curocc("TEF_TRANSACAO") = 1)
						putitem/id viParams, "IN_ABREVINCULADO", <TRUE>
					else
						putitem/id viParams, "IN_ABREVINCULADO", <FALSE>
					endif
					if ($next("CD_EMPRESA.TEF_TRANSACAO") = 0)
						putitem/id viParams, "IN_FECHAVINCULADO", <TRUE>
					else
						putitem/id viParams, "IN_FECHAVINCULADO", <FALSE>
					endif 
				else
					; se não for agrupar, para cada cartão é aberto um vinculado
					putitem/id viParams, "IN_ABREVINCULADO", <TRUE>
					putitem/id viParams, "IN_FECHAVINCULADO", <TRUE>
				endif
				;*

				putitem/id viParams, "TP_IMPRESSAOTEF", $tpImpressaoTEF$
				putitem/id viParams, "TP_IMPVIATEF", $tpImpViaTEF$
				putitem/id viParams, "NR_PARCELAS", $nrParcelas$ ;-=CANONICO=- (05/12/2008) TAR 415 PRJ 102
				putitem/id viParams, "CD_REDETEF", CD_REDETEF.TEF_TRANSACAO ;-=CANONICO=- (23/03/2009) TAR 917 PRJ 102
				putitem/id viParams, "TP_TRANSACAO", TP_TRANSACAO.TEF_TRANSACAO ;-=CANONICO=- (23/03/2009) TAR 917 PRJ 102
				putitem/id viParams, "IN_AGRUPA_CARTAO_TEF", $inAgrupaCartaoTEF$ ;* Claudemir - Prj/Tarefa: 26/34 - 02/03/2010
				putitem/id viParams, "TP_IMPTEFPAYGO", $tpImpTefPAYGO$ ;-=CANONICO=- (30/11/2010) PRJ 102 TAR 995 - Impressão rezumida PAYGO
				activate "TEFFP002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$hrInicio$ = $clock
					putmess "- Inicio fechamento TRAFM066 : %%$hrInicio$"
					;message/info "Cartao impresso corretamente %%$status" 
					if ($tpImpressaoTEF$ = 1) | ($tpImpressaoTEF$ = 2) | ($tpImpressaoTEF$ = 4)
					else
						if ($status = -2)
							return(-1)
						elseif ($status = -11)
							vInFaltaPapel = <TRUE>
						endif
						vInErroVinculado = <TRUE>
						break
					endif
				endif	
				$hrInicio$ = $clock
				putmess "- Inicio fechamento TRAFM066 : %%$hrInicio$"
			endif
			setocc "TEF_TRANSACAO", $curocc("TEF_TRANSACAO") + 1
		endwhile
	else
		;homologacao - FIUZA 13/11/06 - quando for consulta garantia de cheque na redecard não tem cupom
		;para ser impresso
		return(0)
	endif

	if (vInErroVinculado = <TRUE>)
		vDsLstCartao = ""
		if ($empty("TEF_TRANSACAO") = 0)
			setocc "TEF_TRANSACAO", -1
			setocc "TEF_TRANSACAO", 1
			while ($status >= 0)
				clear/e "TEF_TIPOTRANS"
				TP_TEF.TEF_TIPOTRANS/init = TP_TEF.TEF_TRANSACAO
				TP_TRANSACAO.TEF_TIPOTRANS/init = TP_TRANSACAO.TEF_TRANSACAO
				retrieve/e "TEF_TIPOTRANS"
				if ($status >= 0)
					;no caso do TEF DEDICADO chama o serviço para montar a via que o cliente escolheu antes
					;de chamar o TEF.
					if ($tpTEF$ = 1)
						viParams = ""
						voParams = ""
						putitem/id viParams, "TP_VIA", $tpImpViaTEF$
						putitem/id viParams, "DS_CUPOM", DS_CUPOM.TEF_TRANSACAO
						activate "TEFSVCO010".buscaViaCartao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						vDsCupom = $item("DS_CUPOM", voParams)
					else
						vDsCupom = DS_CUPOM.TEF_TRANSACAO
					endif
					vDsRegistro = ""
					putitem/id vDsRegistro, "DS_MENSAGEM", DS_MENSAGEM.TEF_TRANSACAO
					putitem/id vDsRegistro, "DS_CUPOM", vDsCupom
					putitem vDsLstCartao, -1, vDsRegistro
				endif
				setocc "TEF_TRANSACAO", $curocc("TEF_TRANSACAO") + 1
			endwhile
		endif
		vInLoopImpressao = <TRUE>
		repeat
			if (vInFaltaPapel = <TRUE>)
				askmess "Falta de papel! Tentar imprimir novamente?", "Sim, Não"
			else	
				askmess "Impressora não responde! Tentar imprimir novamente?", "Sim, Não"
			endif
			if ($status = 2) 
				;if ($tpTEF$ = 1) 
					;TEF DEDICADO
					;$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação não efetuada.%%^ Favor reter o cupom!", "") 
				;endif	
				return(-1)
			endif	
			viParams = ""
			putitem/id viParams, "DS_LSTCUPOM", vDsLstCartao
			putitem/id viParams, "TP_IMPRESSAO", 2 ;Relatório gerencial
			putitem/id viParams, "TP_IMPRESSAOTEF", $tpImpressaoTEF$
			putitem/id viParams, "NR_PARCELAS", $nrParcelas$ ;-=CANONICO=- (05/12/2008) TAR 415 PRJ 102
			putitem/id viParams, "CD_REDETEF", CD_REDETEF.TEF_TRANSACAO ;-=CANONICO=- (23/03/2009) TAR 917 PRJ 102
			activate "TEFFP002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")						
			endif
			if ($status >= 0)
				vInLoopImpressao = <FALSE>
			endif
		until (vInLoopImpressao = <FALSE>)
	endif	

	setocc "TEF_TRANSACAO", 1
	while ($status >= 0)
		if (TP_SITUACAO.TEF_TRANSACAO = 1)
			;homologacao - FIUZA 13/11/06 - no tef discado não deve alterar o status para 2
			;porque caso aconteça algo de errado deve-se mandar um NCN para a transação
			putmess "Efetivando TEF(status = 2) para %%NR_SEQ.TEF_TRANSACAO"
			if ($tpTEF$ = 1)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", 2 ;Transação com cupom impresso e não confirmada
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				TP_SITUACAO.TEF_TRANSACAO/init = 2
			endif
		elseif (TP_SITUACAO.TEF_TRANSACAO = 4)
			;caso for múltiplos cartões já grava a transação como confirmada
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
			putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
			putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
			putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
			newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
			activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")	
			endif
			TP_SITUACAO.TEF_TRANSACAO/init = 3
		endif
		setocc "TEF_TRANSACAO", $curocc("TEF_TRANSACAO") + 1
	endwhile

	setocc "TEF_TRANSACAO", 1
	while ($status >= 0)
		if (TP_SITUACAO.TEF_TRANSACAO = 2) | (TP_SITUACAO.TEF_TRANSACAO = 1 & $tpTEF$ = 2)
			putmess "Efetivando TEF(status = 3) para %%NR_SEQ.TEF_TRANSACAO"
			viParams = ""
			putitem/id viParams, "000-000", "CNF"
			putitem/id viParams, "001-000", NR_DOCUMENTO.SIS_VALOR
			putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
			$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
			$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"	
			putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO
			;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO		
			;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
			;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
			;endif
			if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
				putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
			endif
			putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
			putitem/id viParams, "999-999", "0"
			putitem/id viParams, "DS_EXTENSAO", "001"
			putitem/id viParams, "IN_P1", <FALSE>
			if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
				putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
			endif
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")	
				endif
				TP_SITUACAO.TEF_TRANSACAO/init = 3
			elseif ($tpTEF$ = 2) ;somente TEF DISCADO - Loop aguardando GP ATIVO 
				vInLoopConfirmacao = <FALSE>
				repeat
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					$instancehandle->setDisplay("Aguardando comunicação...", "", "")
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					endif
					if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
						putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
					endif
					activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status >= 0)
						vInLoopConfirmacao = <TRUE>
						viParams = ""
						putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
						putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
						putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
						putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
						newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
						activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")	
						endif
						TP_SITUACAO.TEF_TRANSACAO/init = 3
					endif
					$instancehandle->setDisplay(" ", "", "")
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					endif	
				until (vInLoopConfirmacao = <TRUE>)
			endif
		endif

		setocc "TEF_TRANSACAO", $curocc("TEF_TRANSACAO") + 1
	endwhile

	return(0)
end

;-----------------------------------
partner operation efetivaTEFPendente
;-----------------------------------
	params
		boolean piInCorrente : IN
		boolean piInGeral : IN
	endparams

	variables
		string viParams, voParams, vDsLstEmpresa 
		string vDsLstCupom, vDsRegistro, vDsConteudo, vDsMensagem, vDsAprovado
		boolean vInLoopConfirmacao, vInLoopImpressao
		numeric vNrLinhaCupom, vNrSequencia 
	endvariables

	$hrInicio$ = $clock
	putmess "- Inicio efetiva pendente : %%$hrInicio$"

	if ($empty("TEF_TRANSACAO") = 0) & (piInCorrente = <TRUE>) & (CD_EMPRESA.TEF_TRANSACAO = CD_EMPFAT.TRA_TRANSACAO)
		if ($tpTEF$ = 2)
			;ordena TEF_TRANSACAO por TP_SITUACAO, pois no TEF DISCADO usando múltiplos cartões
			;é necessário mandar o NCN da ultima transação cuja o TP_SITUACAO = 1  e depois cancelar
			;todas as transações TP_SITUACAO = 4, ou seja mandar CNC  
			sort/e "TEF_TRANSACAO","TP_SITUACAO.TEF_TRANSACAO"
		endif
		message/hint "Aguarde. Aplicaçao TEF sendo executada."
		setocc "TEF_TRANSACAO", 1
		while ($status >= 0)
			if (TP_SITUACAO.TEF_TRANSACAO = 1) 
				;-=CANONICO=- (11/07/2011) PRJ 156 TAR 586
				;Transaçao autorizada sem cupom impresso
				$instancehandle->efetivaTEFPendente_NCN()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
				endif
			elseif (TP_SITUACAO.TEF_TRANSACAO = 2) 
				;Transação com cupom impresso e não confirmada
				$instancehandle->efetivaTEFPendente_CNF()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
				endif
			elseif (TP_SITUACAO.TEF_TRANSACAO = 4) & ($tpTEF$ = 2)
				;transação autorizada sem cupom impresso - TEF DISCADO
				message/hint "Aguarde. Aplicaçao TEF sendo executada."
				viParams = ""
				putitem/id viParams, "000-000", "CNC"
				putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
;				$vlTEF$ = VL_TRANSACAO.TEF_TRANSACAO
				putitem/id viParams, "003-000", "%%VL_TRANSACAO.TEF_TRANSACAO"
				putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
				;$nrNSU$ = NR_NSU.TEF_TRANSACAO
				;ate então a VISA trabalha somente com 6 digitos na NSU
				$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
				$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"	
				putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
				
				;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
				;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
				;endif
				if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
					putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
				endif
				$dtTEF$ = DT_TRANSACAO.TEF_TRANSACAO
				putitem/id viParams, "022-000", "%%$dtTEF$"
				$hrTEF$ = HR_TRANSACAO.TEF_TRANSACAO
				putitem/id viParams, "023-000", "%%$hrTEF$"
				putitem/id viParams, "999-999", "0"
				putitem/id viParams, "DS_EXTENSAO", "001"
				putitem/id viParams, "IN_P1", <TRUE>
				if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
					putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
				endif
				activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)    	   
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
				elseif ($status >= 0)
					vDsConteudo = voParams
					vNrLinhaCupom = $item("028-000", vDsConteudo)
					vDsAprovado = $item("009-000", vDsConteudo)
					vDsMensagem = $item("030-000", vDsConteudo)
					if (vDsAprovado != "0");caso nao seja confirmado retorna a mensagem
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%vDsMensagem%%%!", "")        
					endif
				elseif ($tpTEF$ = 2) ;somente TEF DISCADO - Loop aguardando GP ATIVO 
					vInLoopConfirmacao = <FALSE>
					repeat
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						message/hint "Aguardando comunicação..."	
						if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
							putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
						endif
						activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
						elseif ($status >= 0)
							vDsConteudo = voParams
							vNrLinhaCupom = $item("028-000", vDsConteudo)
							vDsAprovado = $item("009-000", vDsConteudo)
							vDsMensagem = $item("030-000", vDsConteudo)
							if (vDsAprovado != "0");caso nao seja confirmado retorna a mensagem
								$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%vDsMensagem%%%!", "")        
							endif
							if (vNrLinhaCupom > 0)
								vInLoopConfirmacao = <TRUE>
							endif
						endif
						message/hint " "
					until (vInLoopConfirmacao = <TRUE>)
				endif

				if (vNrLinhaCupom > 0)
					viParams = ""
					putitem/id viParams, "NM_ENTIDADE", "TEF_TRANSACAO"
					activate "GERSVCO031".getNumSeq($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					vNrSequencia = $item("NR_SEQUENCIA", voParams)

					;grava o registro no TEF_TRANSACAO    
					viParams = vDsConteudo
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
					putitem/id viParams, "000-000", "CNC"
					putitem/id viParams, "001-000", vNrSequencia
;					$vlTEF$ = VL_TRANSACAO.TEF_TRANSACAO
					putitem/id viParams, "003-000", "%%VL_TRANSACAO.TEF_TRANSACAO"
					putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
					;-=CANONICO=- (20/08/2009) HOMOLOGACAO PAY GO, ao enviar a CNC o sistema deve gravar a NSU da CNC
					;putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO
					putitem/id viParams, "011-000", TP_TRANSACAO.TEF_TRANSACAO
					putitem/id viParams, "012-000", $item("012-000", vDsConteudo)
					putitem/id viParams, "022-000", $item("022-000", vDsConteudo)
					putitem/id viParams, "023-000", $item("023-000", vDsConteudo)
					putitem/id viParams, "027-000", $item("027-000", vDsConteudo)
					putitem/id viParams, "NR_NSUAUX", NR_NSU.TEF_TRANSACAO
					;
					putitem/id viParams, "TP_SITUACAO", 1
					newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
					activate "TEFSVCO011".gravaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					vDsConteudo = $item("DS_CUPOM",voParams)
				endif	

				;Imprime cupom TEF
				if (vNrLinhaCupom > 0)
					$instancehandle->efetivaTEFPendente_CNC(vDsMensagem,vDsConteudo,vNrSequencia)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
					endif
				endif
			endif
		
			setocc "TEF_TRANSACAO", $curocc("TEF_TRANSACAO") + 1
		endwhile
	endif

	if (piInGeral = <TRUE>)
		clear/e "GER_EMPRESA"
		CD_GRUPOEMPRESA.GER_EMPRESA = CD_GRUPOEMPRESA.TRA_TRANSACAO
		retrieve/e "GER_EMPRESA"
		if ($status >= 0)
			setocc "GER_EMPRESA", -1
			setocc "GER_EMPRESA", 1
			putlistitems vDsLstEmpresa, CD_EMPRESA.GER_EMPRESA
		endif

		clear/e "F_TEF_TRANSACAO"
		CD_EMPRESA.F_TEF_TRANSACAO/init = vDsLstEmpresa
		CD_TERMINAL.F_TEF_TRANSACAO/init = $item("CD_TERMINAL", $$gParamGlb)
		TP_SITUACAO.F_TEF_TRANSACAO/init = "1·;2·;4"
		retrieve/e "F_TEF_TRANSACAO"
		if ($status >= 0)
			if ($tpTEF$ = 2)
				sort/e "F_TEF_TRANSACAO","TP_SITUACAO.F_TEF_TRANSACAO"
			endif	
			setocc "F_TEF_TRANSACAO", 1
			while ($status >= 0)
				creocc "TEF_TRANSACAO", -1
				CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO
				DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
				NR_SEQ.TEF_TRANSACAO/init = NR_SEQ.F_TEF_TRANSACAO
				retrieve/o "TEF_TRANSACAO"
				if ($status = 4)
					;Transação já está nas lista das correntes
				else
					message/hint "Aguarde. Aplicaçao TEF sendo executada."
					discard "TEF_TRANSACAO"
					if (TP_SITUACAO.F_TEF_TRANSACAO = 1)
;		           -=CANONICO=- (11/07/2011) PRJ 156 TAR 586
;						;quando não for homologação
;						if ($inUltimaPgtoCartaoTEF$ != <TRUE>)
;                		;informa ao usuário a transação pendente
;							$instancehandle->efetivaTEFPendente_MSG(CD_EMPRESA.F_TEF_TRANSACAO,NR_SEQ.F_TEF_TRANSACAO,DT_MOVIMENTO.F_TEF_TRANSACAO,VL_TRANSACAO.F_TEF_TRANSACAO,NM_REDETEF.F_TEF_TRANSACAO[1,10],CD_OPERADOR.F_TEF_TRANSACAO)
;							if ($procerror)
;								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
;							elseif ($status >= 0)
;             				;Transaçao autorizada sem cupom impresso
;								$instancehandle->efetivaTEFPendenteGeral_NCN()
;								if ($procerror)
;									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
;								endif
;							endif
;						else
							;Transaçao autorizada sem cupom impresso
							$instancehandle->efetivaTEFPendenteGeral_NCN()
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
							endif
;						endif
					elseif (TP_SITUACAO.F_TEF_TRANSACAO = 2)
						;Transação com cupom impresso e não confirmada
						$instancehandle->efetivaTEFPendenteGeral_CNF()
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
						endif
					elseif (TP_SITUACAO.F_TEF_TRANSACAO = 4)  & ($tpTEF$ = 2) 
                 ;Transação autorizada sem cupom impresso SOMENTE TEF DISCADO	
						viParams = ""
						putitem/id viParams, "000-000", "CNC"
						putitem/id viParams, "001-000", NR_SEQ.F_TEF_TRANSACAO
;						$vlTEF$ = VL_TRANSACAO.F_TEF_TRANSACAO
						putitem/id viParams, "003-000", "%%VL_TRANSACAO.F_TEF_TRANSACAO"
						putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
						;$nrNSU$ = NR_NSU.F_TEF_TRANSACAO
						;ate então a VISA trabalha somente com 6 digitos na NSU
						$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
						$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"	
						putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
						;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO		
						;if (NM_REDETEF.F_TEF_TRANSACAO = "VISANET")
						;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
						;endif
						if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
							putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
						endif
						$dtTEF$ = DT_TRANSACAO.F_TEF_TRANSACAO
						putitem/id viParams, "022-000", "%%$dtTEF$"
						$hrTEF$ = HR_TRANSACAO.F_TEF_TRANSACAO
						putitem/id viParams, "023-000", "%%$hrTEF$"
						putitem/id viParams, "999-999", "0"
						putitem/id viParams, "DS_EXTENSAO", "001"
						putitem/id viParams, "IN_P1", <TRUE>
						if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
							putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
						endif
						activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)    	   
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
						elseif ($status >= 0)
							vDsConteudo = voParams
							vNrLinhaCupom = $item("028-000", vDsConteudo)
							vDsAprovado = $item("009-000", vDsConteudo)
							vDsMensagem = $item("030-000", vDsConteudo)
							if (vDsAprovado != "0");caso nao seja confirmado retorna a mensagem
								$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%vDsMensagem%%%!", "")        
								return(-1)
							endif
						elseif($tpTEF$ = 2);Loop aguardando GP ATIVO 
							vInLoopConfirmacao = <FALSE>
							repeat
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								message/hint "Aguardando comunicação..."	
								if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
									putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
								endif
								activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
								if ($procerror)       
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
								elseif ($status >= 0)
									vDsConteudo = voParams
									vNrLinhaCupom = $item("028-000", vDsConteudo)
									vDsAprovado = $item("009-000", vDsConteudo)
									vDsMensagem = $item("030-000", vDsConteudo)
									if (vDsAprovado != "0");caso nao seja confirmado retorna a mensagem
										$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%vDsMensagem%%%!", "")        
										return(-1)
									endif	
									viParams = ""
									viParams = vDsConteudo
									if (vNrLinhaCupom > 0)
										vInLoopConfirmacao = <TRUE>
									endif
								endif
								message/hint " "
							until (vInLoopConfirmacao = <TRUE>)
						endif

						if (vNrLinhaCupom > 0)
							viParams = ""
							putitem/id viParams, "NM_ENTIDADE", "TEF_TRANSACAO"
							activate "GERSVCO031".getNumSeq($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
							if ($procerror)       
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								return(-1)
							endif
							vNrSequencia = $item("NR_SEQUENCIA", voParams)

							;grava o registro no TEF_TRANSACAO    
							viParams = vDsConteudo
							putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
							putitem/id viParams, "000-000", "CNC"
							putitem/id viParams, "001-000", vNrSequencia
;							$vlTEF$ = VL_TRANSACAO.F_TEF_TRANSACAO
							putitem/id viParams, "003-000", "%%VL_TRANSACAO.F_TEF_TRANSACAO"
							putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
							;-=CANONICO=- (20/08/2009) HOMOLOGACAO PAY GO, ao enviar a CNC o sistema deve gravar a NSU da CNC
							;putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO
							putitem/id viParams, "011-000", $item("011-000", vDsConteudo)
							putitem/id viParams, "012-000", $item("012-000", vDsConteudo)
							putitem/id viParams, "022-000", $item("022-000", vDsConteudo)
							putitem/id viParams, "023-000", $item("023-000", vDsConteudo)
							putitem/id viParams, "027-000", $item("027-000", vDsConteudo)
							putitem/id viParams, "NR_NSUAUX", NR_NSU.F_TEF_TRANSACAO
							;
							putitem/id viParams, "TP_SITUACAO", 1
							newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
							activate "TEFSVCO011".gravaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
							if ($procerror)       
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								return(-1)
							endif
							vDsConteudo = $item("DS_CUPOM",voParams)
						endif
			
						;Imprime cupom TEF
						if (vNrLinhaCupom > 0)
							$instancehandle->efetivaTEFPendenteGeral_CNC(vDsMensagem,vDsConteudo,vNrSequencia)
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
							endif
				        endif
					endif
				endif
				setocc "F_TEF_TRANSACAO", $curocc("F_TEF_TRANSACAO") + 1
			endwhile
		endif
	endif

	;tratamento de TEF DISCADO para múltiplos cartões
	;manda um CNF para cada transação TEF
	if (piInCorrente = <FALSE> & piInGeral = <FALSE>)	
		if ($tpTEF$ = 2)
			viParams = ""
			putitem/id viParams, "000-000", "CNF"
			putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
			putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
			;$nrNSU$ = NR_NSU.TEF_TRANSACAO
			;ate então a VISA trabalha somente com 6 digitos na NSU
			$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
			$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"			
			putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
			;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
			;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
			;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
			;endif
			if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
				putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
			endif
			putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
			putitem/id viParams, "999-999", "0"
			putitem/id viParams, "DS_EXTENSAO", "001"
			putitem/id viParams, "IN_P1", <FALSE>	
			if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
				putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
			endif
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", 4 ;Transação confirmada sem cupom impresso
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")	
				endif
				TP_SITUACAO.TEF_TRANSACAO/init = 4
			else 
				vInLoopConfirmacao = <FALSE>
				repeat
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					message/hint "Aguardando comunicação..."	
					if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
						putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
					endif
					activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status >= 0)
						vInLoopConfirmacao = <TRUE>
						viParams = ""
						putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
						putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
						putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
						putitem/id viParams, "TP_SITUACAO", 4 ;Transação confirmada sem cupom impresso
						newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
						activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")	
						endif
						TP_SITUACAO.TEF_TRANSACAO/init = 4
					endif
					message/hint " "
				until (vInLoopConfirmacao = <TRUE>)
			endif
		endif
	endif

	$hrFim$ = $clock
	$hrTempo$ = $hrFim$ - $hrInicio$
	putmess "- Fim : efetiva pendente %%$hrFim$ - %%$hrTempo$"

	message/hint ""
	
	return(0)
end ;operation efetivaTEFPendente

;-----------------------------------
partner operation efetivaTEFPendente_MSG
;-----------------------------------
	params
		numeric vCdEmpresa : IN
		numeric vNrSeq : IN
		date vDtMovimento : IN
		numeric vlValor : IN
		string vDsRedeTef : IN
		numeric vCdOperador	: IN	
	endparams
	variables
		string viParams, voParams, vNmLogin
		boolean vInCancelou	
	endvariables

	clear/e "TEF_RELTRANSACAO"
	CD_EMPTEF.TEF_RELTRANSACAO/init = vCdEmpresa
	NR_SEQ.TEF_RELTRANSACAO/init = vNrSeq
	DT_MOVIMENTO.TEF_RELTRANSACAO/init = vDtMovimento
	retrieve/e "TEF_RELTRANSACAO"

;comentado ODA. estouro de componente
;	clear/e "ADM_USUARIO"
;	CD_USUARIO.ADM_USUARIO/init = vCdOperador
;	retrieve/e "ADM_USUARIO"
	;vNmLogin = $item("NM_LOGIN", $$gparamGlb)
	;--->MNT - Prj 094/1320 - 18/03/2010
	if (vCdOperador > 0)
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_USUARIO", vCdOperador
		activate "ADMSVCO027".validaUsuarioEspecial($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)	
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus("",$xCdErro$, $xCtxErro$, "")
			return(-1)
		endif

		if(voParams != "")
			vNmLogin = $item("NM_LOGIN", voParams)
		endif
	else
		vNmLogin = ""
	endif
	;<---
	;foi incluso esta logica, pois na delfiori estava cancelando transações...
	;com essa logica é a Supervisora de caixa que irá determinar o que vai ser feito durante a venda do TEF
	;somente executa essa logica se o parametro $inUltimaPgtoCartaoTEF$ de não homologação estiver setado
	repeat 
		vInCancelou = <FALSE>
		if (NR_TRANSACAO.TRA_TRANSACAO != NR_TRANSACAO.TEF_RELTRANSACAO) | (CD_EMPRESA.TRA_TRANSACAO != CD_EMPTRA.TEF_RELTRANSACAO)
			message/info "Transacao %%NR_TRANSACAO.TEF_RELTRANSACAO da Empresa %%CD_EMPTRA.TEF_RELTRANSACAO no Valor de %%vlValor da rede %%vDsRedeTef efetuada pelo usuario %%vNmLogin esta pendente na operadora."
;			message/info "Transacao %%NR_TRANSACAO.TEF_RELTRANSACAO da Empresa %%CD_EMPTRA.TEF_RELTRANSACAO no Valor de %%vlValor da rede %%vDsRedeTef efetuada pelo usuario %%NM_LOGIN.ADM_USUARIO esta pendente na operadora."
		else
;			askmess "Transacao %%NR_TRANSACAO.TEF_RELTRANSACAO da Empresa %%CD_EMPTRA.TEF_RELTRANSACAO no Valor de %%vlValor da rede %%vDsRedeTef efetuada pelo usuario %%NM_LOGIN.ADM_USUARIO esta pendente na operadora. %%^ Deseja cancelar a transação?","Sim,Não"
			askmess "Transacao %%NR_TRANSACAO.TEF_RELTRANSACAO da Empresa %%CD_EMPTRA.TEF_RELTRANSACAO no Valor de %%vlValor da rede %%vDsRedeTef efetuada pelo usuario %%vNmLogin esta pendente na operadora. %%^ Deseja cancelar a transação?","Sim,Não"
			if ($status = 1)
				vInCancelou = <TRUE>
			endif
		endif
		viParams = ""
		putitem/id viParams, "IN_USULOGADO", <TRUE>
		putitem/id viParams, "DS_COMPONENTE", "TRAFM060EX"
		activate "ADMFM020".exec(viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)  
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")     
			return (-1)
		endif
	until ($status >= 0)

	if (vInCancelou = <FALSE>)
		return(-1)	
	endif

	return(0)
end

;-----------------------------------
partner operation efetivaTEFPendente_NCN
;-----------------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao
	endvariables

	viParams = ""
	putitem/id viParams, "000-000", "NCN"
	putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
	putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"		
	putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
	;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
	;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
		putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
	endif
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		if ($tpTEF$ = 1) 
			;TEF DEDICADO
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação não efetuada.%%^ Favor reter o cupom!", "") 
		endif
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		if ($tpTEF$ = 2);TEF DISCADO
			if (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO = 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
			elseif (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO > 0)
				;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO		
				;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
				;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%$nrNSU6DIG$%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "")
				;else 
					;$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
					;-=canonico=-/oda tef homologacao
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO %%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
				;endif
			else
				;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
				;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%$nrNSU6DIG$%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
				;else
					;$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO %%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
				;endif
			endif
		endif
	elseif ($tpTEF$ = 2) ;somente TEF DISCADO - Loop aguardando GP ATIVO 
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			$instancehandle->setDisplay("Aguardando comunicação...", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif	
			if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
				putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
			endif
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				if (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO = 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
				elseif (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO > 0)
					;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO
					;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
					;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%$nrNSU6DIG$%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "")
					;else 
						;$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
					;endif
				else
					;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
					;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%$nrNSU6DIG$%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO %%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
					;else
					;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
					;endif
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			$instancehandle->setDisplay(" ", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif	
		until (vInLoopConfirmacao = <TRUE>)	
	endif

	return(0)
end

;-----------------------------------
partner operation efetivaTEFPendente_CNF
;-----------------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao
	endvariables

	viParams = ""
	putitem/id viParams, "000-000", "CNF"
	putitem/id viParams, "001-000", NR_DOCUMENTO.SIS_VALOR
	putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"
	putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
	;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
	;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
		putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
	endif
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)    	   
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
	elseif ($tpTEF$ = 2)
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			$instancehandle->setDisplay("Aguardando comunicação...", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif	
			if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
				putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
			endif
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			$instancehandle->setDisplay(" ", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif	
		until (vInLoopConfirmacao = <TRUE>)
	endif

	return(0)
end

;-----------------------------------
partner operation efetivaTEFPendente_CNC
;-----------------------------------
	params
		string vDsMensagem : IN
		string vDsConteudo : IN
		numeric vNrSequencia : IN
	endparams
	variables
		string viParams, voParams, vDsLstEmpresa
		string vDsLstCupom, vDsRegistro, vDsAprovado
		boolean vInLoopConfirmacao, vInLoopImpressao
	endvariables

	vDsLstCupom = ""
	vDsRegistro = ""
	putitem/id vDsRegistro, "DS_MENSAGEM", vDsMensagem
	putitem/id vDsRegistro, "DS_CUPOM", vDsConteudo
	putitem vDsLstCupom, -1, vDsRegistro
	viParams = ""
	putitem/id viParams, "DS_LSTCUPOM", vDsLstCupom
	putitem/id viParams, "DS_FORMAPGTO", ""
	putitem/id viParams, "TP_IMPRESSAO", 2 ;Relatório gerencial
	putitem/id viParams, "TP_IMPRESSAOTEF", $tpImpressaoTEF$
	activate "TEFFP002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		vInLoopImpressao = <TRUE>
		repeat
			askmess "Impressora não responde! Tentar novamente?", "Sim, Não"	
			if ($status = 2)
				viParams = ""
				;-=CANONICO=- (21/08/2009) Homologacao
				clear/e "F_TEF_TRANSACAO"
				CD_EMPRESA.F_TEF_TRANSACAO/init = CD_EMPRESA.TEF_TRANSACAO	
				DT_MOVIMENTO.F_TEF_TRANSACAO/init = DT_MOVIMENTO.TEF_TRANSACAO
				CD_ARQUIVO.F_TEF_TRANSACAO/init = "CNC"	
				TP_TRANSACAO.F_TEF_TRANSACAO/init = TP_TRANSACAO.TEF_TRANSACAO
				;TP_SITUACAO.TEF_TRANSACAO/init = 1				
				NR_NSUAUX.F_TEF_TRANSACAO/init = NR_NSU.TEF_TRANSACAO 
				retrieve/e "F_TEF_TRANSACAO"	
				if ($status >= 0)
					putitem/id viParams, "000-000", "NCN"
					putitem/id viParams, "001-000", NR_SEQ.F_TEF_TRANSACAO
					putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
					putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO
					putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
				else
					putitem/id viParams, "000-000", "NCN"
					putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
					putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
					;$nrNSU$ = NR_NSU.TEF_TRANSACAO
					;ate então a VISA trabalha somente com 6 digitos na NSU
					$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
					$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"
					putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
					;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
					;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
					;    putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
					;endif
					if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
						putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
					endif
					putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
				endif
				putitem/id viParams, "999-999", "0"
				putitem/id viParams, "DS_EXTENSAO", "001"
				putitem/id viParams, "IN_P1", <FALSE>
				if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
					putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
				endif
				activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
				elseif ($status >= 0)
					if (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO = 0)
		         	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
	            elseif (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO > 0)
						;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO		
		            ;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
		            ; 	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%$nrNSU6DIG$%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
		            ;else
                 	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
	               ;endif
	            else
	  		         ;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
                  ;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%$nrNSU6DIG$%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
						;else
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
						;endif	
					endif
					;homologacao teste

					;Fiuza/Canonico 19/08/09 - estamos usando a functional devido ao homologador ter feito duas transações TEF
					;e na impressao da segunda transacao desligar a impressora e nao confirmar a impressao em seguida sera aberto
                    ;um CNC para a primeira transacao que foi impressa e não confirmada que até então esta com status "4". Durante
					;a impressão do CNC será desligado a impressora novamente e não confirmada a transação, nesse caso dever gravar
					;o status "-1" para a transação que estava com status "4" e o CNC que esta com status "1".
					clear/e "F_TEF_TRANSACAO"
					CD_EMPRESA.F_TEF_TRANSACAO/init = CD_EMPRESA.TEF_TRANSACAO	
					DT_MOVIMENTO.F_TEF_TRANSACAO/init = DT_MOVIMENTO.TEF_TRANSACAO
					CD_ARQUIVO.F_TEF_TRANSACAO/init = "CNC"	
					TP_TRANSACAO.F_TEF_TRANSACAO/init = TP_TRANSACAO.TEF_TRANSACAO			
					NR_NSUAUX.F_TEF_TRANSACAO/init = NR_NSU.TEF_TRANSACAO 
					retrieve/e "F_TEF_TRANSACAO"	
					if ($status >= 0)	
						viParams = ""
						putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
						putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
						putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
						putitem/id viParams, "TP_SITUACAO", -1 ;Transação não impressa
						newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
						activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
					    	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						endif
						return(-1)
					endif
					;homologacao teste		
					viParams = ""
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
					putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
					putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
					putitem/id viParams, "TP_SITUACAO", -1 ;Transação não impressa
					newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
					activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
				    	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					endif
					return(-1)	
				elseif ($tpTEF$ = 2)
					vInLoopConfirmacao = <FALSE>
					repeat
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")						
						$instancehandle->setDisplay("Aguardando comunicação...", "", "")
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						endif	
						if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
							putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
						endif
						activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
						elseif ($status >= 0)
							if (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO = 0)
								$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
							elseif (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO > 0)
								;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO
								;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
								;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%$nrNSU6DIG$%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
								;else
									$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
								;endif
							else
								;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
								;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%$nrNSU6DIG$%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
								;else
									$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
								;endif	
							endif

							;homologacao teste	
							;Fiuza/Canonico 19/08/09 - estamos usando a functional devido ao homologador ter feito duas transações TEF
							;e na impressao da segunda transacao desligar a impressora e nao confirmar a impressao em seguida sera aberto
  	   		                ;um CNC para a primeira transacao que foi impressa e não confirmada que até então esta com status "4". Durante
							;a impressão do CNC será desligado a impressora novamente e não confirmada a transação, nesse caso dever gravar
							;o status "-1" para a transação que estava com status "4" e o CNC que esta com status "1".
							clear/e "F_TEF_TRANSACAO"
							CD_EMPRESA.F_TEF_TRANSACAO/init = CD_EMPRESA.TEF_TRANSACAO	
							DT_MOVIMENTO.F_TEF_TRANSACAO/init = DT_MOVIMENTO.TEF_TRANSACAO
							CD_ARQUIVO.F_TEF_TRANSACAO/init = "CNC"	
							TP_TRANSACAO.F_TEF_TRANSACAO/init = TP_TRANSACAO.TEF_TRANSACAO			
							NR_NSU.F_TEF_TRANSACAO/init = NR_NSU.TEF_TRANSACAO 
							retrieve/e "F_TEF_TRANSACAO"	
							if ($status >= 0)	
								viParams = ""
								putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
								putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
								putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
								putitem/id viParams, "TP_SITUACAO", -1 ;Transação não impressa
								newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
								activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
								if ($procerror)       
							    	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								endif
								return(-1)
							endif
							;homologacao teste		
							viParams = ""
							putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
							putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
							putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
							putitem/id viParams, "TP_SITUACAO", -1 ;Transação não impressa
							newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
							activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
							if ($procerror)       
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							endif
							return(-1)	
						endif						
						$instancehandle->setDisplay(" ", "", "")
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						endif	
					until (vInLoopConfirmacao = <TRUE>)
				endif
			else
				viParams = ""
				putitem/id viParams, "DS_LSTCUPOM", vDsLstCupom
				putitem/id viParams, "DS_FORMAPGTO", ""
				putitem/id viParams, "TP_IMPRESSAO", 2 ;Relatório gerencial
				putitem/id viParams, "TP_IMPRESSAOTEF", $tpImpressaoTEF$
				activate "TEFFP002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")                        
				endif
				if ($status >= 0)
					viParams = ""
			
					;-=CANONICO=- (21/08/2009) Homologacao
					clear/e "F_TEF_TRANSACAO"	
					CD_EMPRESA.F_TEF_TRANSACAO/init = CD_EMPRESA.TEF_TRANSACAO	
					DT_MOVIMENTO.F_TEF_TRANSACAO/init = DT_MOVIMENTO.TEF_TRANSACAO
					CD_ARQUIVO.F_TEF_TRANSACAO/init = "CNC"	
					TP_TRANSACAO.F_TEF_TRANSACAO/init = TP_TRANSACAO.TEF_TRANSACAO			
					NR_NSUAUX.F_TEF_TRANSACAO/init = NR_NSU.TEF_TRANSACAO 
					retrieve/e "F_TEF_TRANSACAO"	
					if ($status >= 0)
						putitem/id viParams, "000-000", "CNF"
						putitem/id viParams, "001-000", vNrSequencia
						putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
						putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO
						putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
					else

						putitem/id viParams, "000-000", "CNF"
						putitem/id viParams, "001-000", vNrSequencia
						putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
						;$nrNSU$ = NR_NSU.TEF_TRANSACAO
						;ate então a VISA trabalha somente com 6 digitos na NSU
						$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
						$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"		
						putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
						;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
						;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
						;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
						;endif
						if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
							putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
						endif
						putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
					endif
					
					putitem/id viParams, "999-999", "0"
					putitem/id viParams, "DS_EXTENSAO", "001"
					putitem/id viParams, "IN_P1", <FALSE>
					if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
						putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
					endif
					activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status >= 0)
					elseif ($tpTEF$ = 2)
						vInLoopConfirmacao = <FALSE>
						repeat
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							$instancehandle->setDisplay("Aguardando comunicação...", "", "")
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							endif	
							if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
								putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
							endif
							activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
							if ($procerror)       
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
							elseif ($status >= 0)
								vInLoopConfirmacao = <TRUE>
							endif							
							$instancehandle->setDisplay(" ", "", "")
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							endif	
						until (vInLoopConfirmacao = <TRUE>)
					endif
					;confirma o CNC gerado
					viParams = ""
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
					putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
					putitem/id viParams, "NR_SEQ", vNrSequencia
					putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
					newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
					activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					endif
					
					;-=CANONICO=- (21/08/2009) Homologacao	
					clear/e "F_TEF_TRANSACAO"
					CD_EMPRESA.F_TEF_TRANSACAO/init = CD_EMPRESA.TEF_TRANSACAO	
					DT_MOVIMENTO.F_TEF_TRANSACAO/init = DT_MOVIMENTO.TEF_TRANSACAO
					CD_ARQUIVO.F_TEF_TRANSACAO/init = "CRT"	
					TP_TRANSACAO.F_TEF_TRANSACAO/init = TP_TRANSACAO.TEF_TRANSACAO			
					NR_NSU.F_TEF_TRANSACAO/init = NR_NSU.TEF_TRANSACAO 
					retrieve/e "F_TEF_TRANSACAO"	
	
					;altera o status da transação CRT para -1. Que outrora estava em pendência = 4
					viParams = ""	
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
					putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
					putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
					putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
					newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
					activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					endif
					vInLoopImpressao = <FALSE>
				endif
			endif    
		until (vInLoopImpressao = <FALSE>)
	else
		viParams = ""
		;-=CANONICO=- (21/08/2009) Homologacao
		clear/e "F_TEF_TRANSACAO"	
		CD_EMPRESA.F_TEF_TRANSACAO/init = CD_EMPRESA.TEF_TRANSACAO	
		DT_MOVIMENTO.F_TEF_TRANSACAO/init = DT_MOVIMENTO.TEF_TRANSACAO
		CD_ARQUIVO.F_TEF_TRANSACAO/init = "CNC"	
		TP_TRANSACAO.F_TEF_TRANSACAO/init = TP_TRANSACAO.TEF_TRANSACAO			
		NR_NSUAUX.F_TEF_TRANSACAO/init = NR_NSU.TEF_TRANSACAO 
		retrieve/e "F_TEF_TRANSACAO"	
		if ($status >= 0)
			putitem/id viParams, "000-000", "CNF"
			putitem/id viParams, "001-000", vNrSequencia
			putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
			putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO
			putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
		else
		
			putitem/id viParams, "000-000", "CNF"
			putitem/id viParams, "001-000", vNrSequencia
			putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
			;$nrNSU$ = NR_NSU.TEF_TRANSACAO
			;ate então a VISA trabalha somente com 6 digitos na NSU
			$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
			putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
			;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
			;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
			;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
			;endif
			putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
		endif	
		putitem/id viParams, "999-999", "0"
		putitem/id viParams, "DS_EXTENSAO", "001"
		putitem/id viParams, "IN_P1", <FALSE>
		if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
			putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
		endif
		activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status >= 0)
		elseif ($tpTEF$ = 2)
			vInLoopConfirmacao = <FALSE>
			repeat
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				$instancehandle->setDisplay("Aguardando comunicação...", "", "")
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif	
				if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
					putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
				endif
				activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
				elseif ($status >= 0)
					vInLoopConfirmacao = <TRUE>
				endif
				$instancehandle->setDisplay(" ", "", "")
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif	
			until (vInLoopConfirmacao = <TRUE>)
		endif
		;confirma o CNC gerado
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", vNrSequencia
		putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif

		;-=CANONICO=- (21/08/2009) Homologacao	
		clear/e "F_TEF_TRANSACAO"
		CD_EMPRESA.F_TEF_TRANSACAO/init = CD_EMPRESA.TEF_TRANSACAO	
		DT_MOVIMENTO.F_TEF_TRANSACAO/init = DT_MOVIMENTO.TEF_TRANSACAO
		CD_ARQUIVO.F_TEF_TRANSACAO/init = "CRT"	
		TP_TRANSACAO.F_TEF_TRANSACAO/init = TP_TRANSACAO.TEF_TRANSACAO			
		NR_NSU.F_TEF_TRANSACAO/init = NR_NSU.TEF_TRANSACAO 
		retrieve/e "F_TEF_TRANSACAO"	
		
		;altera o status da transação CRT para -1. Que outrora estava em pendência = 4
		viParams = ""
		viParams = vDsConteudo
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
	endif 

	return(0)
end; operation efetivaTEFPendente_CNC

;------------------------------
partner operation efetivaTEFPendenteGeral_NCN
;------------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao, vInLoopImpressao
	endvariables

	viParams = ""
	putitem/id viParams, "NM_ENTIDADE", "TEF_TRANSACAO"
	putitem/id viParams, "NM_ATRIBUTO", "NR_TRANSACAO"
	activate "GERSVCO031".getNumSeq($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	$vNrTransacao$ = $item("NR_SEQUENCIA", voParams)


	viParams = ""
	putitem/id viParams, "000-000", "NCN"
	putitem/id viParams, "001-000", $vNrTransacao$;NR_SEQ.F_TEF_TRANSACAO
	putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.F_TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"	
	putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
	;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO
	;if (NM_REDETEF.F_TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	if ($tpTEF$ = 2)
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
	endif
	if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
		putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
	endif
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		if (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO", "") 
		elseif (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO > 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO", "") 
		else
			if ($tpTEF$ = 1)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação não efetuada.%%^ Favor reter o cupom!", "") 			
			else
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.F_TEF_TRANSACAO", "") 
			endif
		endif
	elseif ($tpTEF$ = 2) ;somente TEF DISCADO - Loop aguardando GP ATIVO 
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			message/hint "Aguardando comunicação..."	
			if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
				putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
			endif
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				if (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO = 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO", "") 
				elseif (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO > 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO", "") 
				else
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO %%^Valor: %%VL_TRANSACAO.F_TEF_TRANSACAO", "") 
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			message/hint " "
		until (vInLoopConfirmacao = <TRUE>)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	endif

	return(0)

end;efetivaTEFPendenteGeral_NCN


;------------------------------
partner operation efetivaTEFPendenteGeral_CNF
;------------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao, vInLoopImpressao
	endvariables

	viParams = ""
	putitem/id viParams, "000-000", "CNF"
	putitem/id viParams, "001-000", NR_SEQ.F_TEF_TRANSACAO
	putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.F_TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"		
	putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
	;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO
	;if (NM_REDETEF.F_TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
		putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
	endif
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
	elseif ($tpTEF$ = 2)
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			message/hint "Aguardando comunicação..."	
			if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
				putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
			endif
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			message/hint " "
		until (vInLoopConfirmacao = <TRUE>)			
	endif	

	return(0)
end;efetivaTEFPendenteGeral_CNF

;------------------------------
partner operation efetivaTEFPendenteGeral_CNC
;------------------------------
	params
		string vDsMensagem : IN
		string vDsConteudo : IN
		numeric vNrSequencia : IN
	endparams
	variables
		string viParams, voParams, vDsLstCupom, vDsRegistro, vDsAprovado, vDsLstEmpresa
		boolean vInLoopConfirmacao, vInLoopImpressao
		numeric vNrLinhaCupom
	endvariables

	vDsLstCupom = ""
	vDsRegistro = ""
	putitem/id vDsRegistro, "DS_MENSAGEM", vDsMensagem
	putitem/id vDsRegistro, "DS_CUPOM", vDsConteudo
	putitem vDsLstCupom, -1, vDsRegistro
	viParams = ""
	putitem/id viParams, "DS_LSTCUPOM", vDsLstCupom
	putitem/id viParams, "DS_FORMAPGTO", ""
	putitem/id viParams, "TP_IMPRESSAO", 2 ;Relatório gerencial
	activate "TEFFP002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		vInLoopImpressao = <TRUE>
		repeat
			askmess "Impressora não responde! Tentar novamente?", "Sim, Não"	
			if ($status = 2) 
				viParams = ""
				;-=CANONICO=- (21/08/2009) Homologacao
				clear/e "TEF_TRANSACAO"
				CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO	
				DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
				CD_ARQUIVO.TEF_TRANSACAO/init = "CNC"	
				TP_TRANSACAO.TEF_TRANSACAO/init = TP_TRANSACAO.F_TEF_TRANSACAO			
				NR_NSUAUX.TEF_TRANSACAO/init = NR_NSU.F_TEF_TRANSACAO 
				retrieve/e "TEF_TRANSACAO"	
				if ($status >= 0)
					putitem/id viParams, "000-000", "NCN"
					putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
					putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
					putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO
					putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
				else
					putitem/id viParams, "000-000", "NCN"
					putitem/id viParams, "001-000", NR_SEQ.F_TEF_TRANSACAO
					putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
					;$nrNSU$ = NR_NSU.TEF_TRANSACAO
					;ate então a VISA trabalha somente com 6 digitos na NSU
					$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
					$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"
					putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
					;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
					;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
					;    putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
					;endif
					if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
						putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
					endif
					putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
				endif
	
			   putitem/id viParams, "999-999", "0"
			   putitem/id viParams, "DS_EXTENSAO", "001"
			   putitem/id viParams, "IN_P1", <FALSE>
				if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
					putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
				endif
			   activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			   if ($procerror)       
				   $instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			   elseif ($status >= 0)
				if (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO = 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO", "") 
				elseif (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO > 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO", "") 
				else
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO %%^Valor: %%VL_TRANSACAO.F_TEF_TRANSACAO", "") 
				endif
			elseif ($tpTEF$ = 2)
				vInLoopConfirmacao = <FALSE>
				repeat
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					message/hint "Aguardando comunicação..."	
					if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
						putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
					endif
					activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
					   $instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
					elseif ($status >= 0)
						if (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO = 0)
							$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO", "") 
	               elseif (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO > 0)
		            	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO", "") 
	               else
		            	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO %%^Valor: %%VL_TRANSACAO.F_TEF_TRANSACAO", "") 
	               endif
		            	vInLoopConfirmacao = <TRUE>
					endif
					message/hint " "
				until (vInLoopConfirmacao = <TRUE>)
				endif
			else
				viParams = ""
			   putitem/id viParams, "DS_LSTCUPOM", vDsLstCupom
				putitem/id viParams, "DS_FORMAPGTO", ""
				putitem/id viParams, "TP_IMPRESSAO", 2 ;Relatório gerencial
				activate "TEFFP002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")                        
				endif
				if ($status >= 0)
					viParams = ""
					;-=CANONICO=- (21/08/2009) Homologacao
					clear/e "TEF_TRANSACAO"	
					CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO	
					DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
					CD_ARQUIVO.TEF_TRANSACAO/init = "CNC"	
					TP_TRANSACAO.TEF_TRANSACAO/init = TP_TRANSACAO.F_TEF_TRANSACAO			
					NR_NSUAUX.TEF_TRANSACAO/init = NR_NSU.F_TEF_TRANSACAO 
					retrieve/e "TEF_TRANSACAO"	
					if ($status >= 0)
						putitem/id viParams, "000-000", "CNF"
						putitem/id viParams, "001-000", vNrSequencia
						putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
						putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO
						putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
					else

						putitem/id viParams, "000-000", "CNF"
						putitem/id viParams, "001-000", vNrSequencia
						putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
						;$nrNSU$ = NR_NSU.TEF_TRANSACAO
						;ate então a VISA trabalha somente com 6 digitos na NSU
						$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
						$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"		
						putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
						;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
						;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
						;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
						;endif
						if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
							putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
						endif
						putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
					endif
					putitem/id viParams, "999-999", "0"
					putitem/id viParams, "DS_EXTENSAO", "001"
					putitem/id viParams, "IN_P1", <FALSE>
					if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
						putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
					endif
					activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status >= 0)
					elseif ($tpTEF$ = 2)
						vInLoopConfirmacao = <FALSE>
						repeat
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							message/hint "Aguardando comunicação..."	
							if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
								putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
							endif
							activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
							if ($procerror)       
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
							elseif ($status >= 0)
								vInLoopConfirmacao = <TRUE>
							endif
							message/hint " "
						until (vInLoopConfirmacao = <TRUE>)
					endif
					;confirma o CNC gerado
					viParams = ""
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
					putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
					putitem/id viParams, "NR_SEQ", vNrSequencia
					putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
					newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
					activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					endif

					;-=CANONICO=- (21/08/2009) Homologacao	
					clear/e "TEF_TRANSACAO"
					CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO	
					DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
					CD_ARQUIVO.TEF_TRANSACAO/init = "CRT"	
					TP_TRANSACAO.TEF_TRANSACAO/init = TP_TRANSACAO.F_TEF_TRANSACAO			
					NR_NSU.TEF_TRANSACAO/init = NR_NSU.F_TEF_TRANSACAO 
					retrieve/e "TEF_TRANSACAO"	

					;altera o status da transação CRT para -1. Que outrora estava em pendência = 4
					viParams = ""
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
					putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
					putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
					putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
					newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
					activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					endif	
					vInLoopImpressao = <FALSE>
				endif
			endif    
		until (vInLoopImpressao = <FALSE>)
	else

		;-=CANONICO=- (21/08/2009) Homologacao
		clear/e "TEF_TRANSACAO"	
		CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO	
		DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
		CD_ARQUIVO.TEF_TRANSACAO/init = "CNC"	
		TP_TRANSACAO.TEF_TRANSACAO/init = TP_TRANSACAO.F_TEF_TRANSACAO
		TP_SITUACAO.TEF_TRANSACAO/init = 1			
		NR_NSUAUX.TEF_TRANSACAO/init = NR_NSU.F_TEF_TRANSACAO 
		retrieve/e "TEF_TRANSACAO"	
		if ($status >= 0)
			putitem/id viParams, "000-000", "CNF"
			putitem/id viParams, "001-000", vNrSequencia
			putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
			putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO
			putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
		else
			putitem/id viParams, "000-000", "CNF"
			putitem/id viParams, "001-000", vNrSequencia
			putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
			;$nrNSU$ = NR_NSU.TEF_TRANSACAO
			;ate então a VISA trabalha somente com 6 digitos na NSU
			$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
			$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"		
			putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
			;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
			;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
			;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
			;endif
			if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
				putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
			endif
			putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
		endif

		putitem/id viParams, "999-999", "0"
		putitem/id viParams, "DS_EXTENSAO", "001"
		putitem/id viParams, "IN_P1", <FALSE>
		if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
			putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
		endif
		activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status >= 0)
		elseif ($tpTEF$ = 2)
			vInLoopConfirmacao = <FALSE>
			repeat
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			   message/hint "Aguardando comunicação..."	
				if ($tpTEF$ = 2);-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
					putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ 
				endif
			   activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			   if ($procerror)       
			       $instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			   elseif ($status >= 0)
					vInLoopConfirmacao = <TRUE>
				endif
				message/hint " "
			until (vInLoopConfirmacao = <TRUE>)
		endif
		;confirma o CNC gerado
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", vNrSequencia
		putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		;altera o status da transação CRT para -1. Que outrora estava em pendência = 4
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		clear/e "TEF_TRANSACAO" ;-=CANONICO=- (14/07/2011) TAR 583 PRJ 156 - Quando saia do TRAFM066 a transacao TEF estava carregada	
	endif 

	return(0)

end;efetivaTEFPendenteGeral_CNC

;---------------------------------
partner operation gravaRecebimento
	;---------------------------------
	variables
		date    vDtSistema, vDtMovim, vDtTransacao, vDtVencimento
		string  viParams, voParams, viValores, vDsLstParamCC, vDsRegFormaPgto, vDsIndice, vDsFiltro
		string  vDsCheque, vDsRegistro, vDsLstFatura, vDsLstCartao, vDsObs, vDsLstFaturaImp, vDsLstLiqMov
		string  vDsLstFormaPgto, vDsLstComissao, vDsLstNF, vDsLstMovCC, vDsFormaPgto, vLstTransacao
		string  vDsClas, vDsLstClas, vDsLstFatura2, vDsLstSeguro, vDsLstNaoSeguro
		string  vDsLstComisGuia, vDsLstComisRepre, vDsLstTransacao, vDsLstClassificacao, vDsLstCheque, vDsLstMovimento
		numeric vCdEmpresa, vCdCliente, vNrFatura, vCdOperador, vNrFatTroco, vVlDesconto, vPrDescBonific, vNrSequencia
		numeric vTpFaturamento, vTpCobranca, vNrSeqTotTEF, vNrTransacao, vNrParcela
		numeric vNrDOFNI, vNrCtaPes, vNrSeqMov, vNrSeqTEF, vNrStatus, vPrDescPontual, vPrDescBonificm, vTpCobrancaVd
		numeric vVlBonus, vTpBonus, vCdDescAbatiPed, vPrDescAbatiPed, vCdAbatiPed, vCdMotivoAbat, vVlAbatimento
		boolean vInErro, vInCobLoja, vInFatura, vInImpressaoOK, vInAgRecebimento, vInCheque, vInConcomitante
	endvariables

	;* Claudemir - Prj/Tarefa: 26/31 - 25/11/2009
	if (TP_DOCTO.GER_OPERACAO = 3) ; concomitante
		vInConcomitante = <TRUE>
	else
		vInConcomitante = <FALSE>
	endif ;*
	
	;Hugo em 11/04/11 Tarefa 22-1805
	vCdDescAbatiPed = $item("CD_TIPODES_ABATIMENTO_PED", $xlplemp$)
	vCdAbatiPed     = $item("CD_TIPO_ABATIMENTO_PED",    $xlplemp$)
	vCdMotivoAbat   = $item("CD_MOTIVO_ABATI_PED",       $xlplemp$)
	;
		
	if (!$empty("TRA_TRANSACAO"))
		setocc "TRA_TRANSACAO", 1
		while ($status >= 0)
			vDsRegistro = ""
			putitem/id vDsRegistro, "CD_EMPTRANSACAO", CD_EMPRESA.TRA_TRANSACAO
			putitem/id vDsRegistro, "CD_EMPRESA",      CD_EMPRESA.TRA_TRANSACAO
			putitem/id vDsRegistro, "DT_TRANSACAO",    DT_TRANSACAO.TRA_TRANSACAO
			putitem/id vDsRegistro, "NR_TRANSACAO",    NR_TRANSACAO.TRA_TRANSACAO
			putitem vLstTransacao, -1, vDsRegistro
			
			setocc "TRA_TRANSACAO", $curocc(TRA_TRANSACAO) + 1
		endwhile
		setocc "TRA_TRANSACAO", 1
	endif

	;Projeto 180 - Tarefa 063 - Aloisio Gargantini - 27/01/2011 - lock nas transações
	viParams = ""
	putitem/id viParams, "DS_LSTTRANSACAO", vLstTransacao
	activate "TRASVCO019".lockTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	;	
	vDtSistema          = $item("DT_SISTEMA", $$gParamGlb)
	vCdOperador         = $item("CD_USUARIO", $$gParamGlb)
	vDsLstFatura        = ""
	vDsLstFatura2       = ""
	vDsLstFaturaImp     = ""
	vDsLstMovCC         = ""
	vDsLstClassificacao = ""
	vTpCobrancaVd       = $item("TP_COBRANCA_VD", $xlplemp$)
	vNrSequencia        = 100
	vVlAbatimento       = 0
	
	if (QT_PRAZOMEDIO.SIS_TOTAL > 0)
		vTpFaturamento = 2 ;A prazo
	else
		vTpFaturamento = 1 ;A vista
	endif
	
	if (VL_TROCO.SIS_DUMMY3 > 0)
		viParams = ""
		putitem/id viParams, "NM_ENTIDADE", "FCR_FATURAI"
		activate "GERSVCO031".getNumSeq($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-2)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-2)
		endif
		
		vNrFatTroco = $item("NR_SEQUENCIA", voParams)
		
		creocc "SIS_VALOR", 1
		NR_DOCUMENTO.SIS_VALOR/init = vNrFatTroco        
		VL_DOCUMENTO.SIS_VALOR      = VL_TROCO.SIS_DUMMY3
		TP_DOCUMENTO.SIS_VALOR      = 9 ;Troco
		DT_VENCIMENTO.SIS_VALOR     = vDtSistema
	endif	 
	
	if ($inECF$ = <TRUE>) 	
		if ($NrCupom$ = 0)
			;FIUZA 21/12/05 - ECF NAO CONCOMITANTE
			if ($inCupomAberto$ = <FALSE>)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA"  , CD_EMPRESA.TRA_TRANSACAO
				putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
				putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO		
				activate "ECFSVCO010".iniciaCupom($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-2)
				elseif ($status = -10)
					viParams = ""
					voParams = ""
					putitem/id viParams,"TITULO"  , "Erro de comunicação com a ECF"
					putitem/id viParams,"MENSAGEM", $item("DESCRICAO", $xctxerro$)
					activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-2)
					endif
					return(-2)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-2)
				endif
				$cdEmpECF$ = $item("CD_EMPECF", voParams)
				$nrECF$    = $item("NR_ECF"   , voParams)
				$nrCupom$  = $item("NR_CUPOM" , voParams)

				;verifica se tem TEF
				setocc "SIS_VALOR", 1
				while ($status >= 0)
					if (TP_DOCUMENTO.SIS_VALOR = 7) | ($tpTEF$ = 2 & TP_DOCUMENTO.SIS_VALOR = 8) ; TEF / Cheque TEF
						$inTEF$ = <TRUE>
						break
					endif
					setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
				endwhile 

				viParams = ""
				putitem/id viParams, "CD_EMPRESA",   CD_EMPRESA.TRA_TRANSACAO
				putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
				putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO	
				putitem/id viParams, "IN_TEF", $inTEF$
				activate "ECFSVCO010".lancaItemCupom($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-2)
				elseif ($status = -10)
					viParams = ""
					voParams = ""
					putitem/id viParams,"TITULO",   "Erro de comunicação com a ECF"
					putitem/id viParams,"MENSAGEM", $item("DESCRICAO",$xctxerro$)
					activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-2)
					endif
					return(-2)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-2)
				endif
				$inCupomAberto$ = <TRUE>
				if ($inTEF$ = <TRUE>) & ($nrCupom$ = 0)
					$nrCupom$ = $item("NR_CUPOM", voParams)
				endif

				;-=CANONICO=- (21-11-2011) Alterado para performace no ECF
				if ($cdEmpECF$ = "") | ($nrECF$ = "")
					$cdEmpECF$ = $item("CD_EMPECF", voParams)
					$nrECF$    = $item("NR_ECF"   , voParams)
				endif		
			else
				viParams = ""
				voParams = ""
				activate "ECFSVCO001".abreGaveta(viParams,voParams,$xcderro$,$xctxerro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-2)
				endif
			endif
		endif
	endif

	;TEF
	if ($inTEF$ = "")
		;em caso de multiplos cartões pode acontecer de o cliente passar vários cartões e cancelar o ultimo
		;cartão ou mesmo não ter crédito dai o cliente pode optar por outra forma de pgto mas os cartões anteriores
		;devem ser impressos uma vez que já foram confirmados!
		$inTEF$ = <FALSE>
	endif	
	vNrSeqTEF    = 0	
	vNrSeqTotTEF = 0
	;verifica o total de transações TEF - múltiplos cartões
	;TEF DISCADO
	setocc "SIS_VALOR", 1
	while ($status >= 0)
		if (TP_DOCUMENTO.SIS_VALOR = 7) | ($tpTEF$ = 2 & TP_DOCUMENTO.SIS_VALOR = 8) | (TP_DOCUMENTO.SIS_VALOR = 19) | (TP_DOCUMENTO.SIS_VALOR = 22); TEF /Cheque TEF / TECBAN / HIPERCARD
			vNrSeqTotTEF = vNrSeqTotTEF + 1
		endif
		setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
	endwhile 
	;------------------------------------------------------
	setocc "SIS_VALOR", 1
	while ($status >= 0)
		if (TP_DOCUMENTO.SIS_VALOR = 7) | (TP_DOCUMENTO.SIS_VALOR = 17) | (TP_DOCUMENTO.SIS_VALOR = 19) | (TP_DOCUMENTO.SIS_VALOR = 22) | ($tpTEF$ = 2 & TP_DOCUMENTO.SIS_VALOR = 8) ; TEF / Cheque TEF / TECBAN / HIPERCARD
			vNrSeqTEF = vNrSeqTEF + 1
			$instancehandle->lancaTEF(vNrSeqTEF)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-2)
			endif
			if ($status < 0)
				vNrStatus = $status
				return(vNrStatus)
			endif
			if (vNrSeqTEF = 1 & $tpTEF$ = 1)
				;somente TEF DEDICADO
				$instancehandle->efetivaTEFPendente(<FALSE>, <TRUE>)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
				endif
			elseif ($tpTEF$ = 2)
				if (vNrSeqTotTEF > 1 & vNrSeqTEF < vNrSeqTotTEF)
					;somente TEF DISCADO - múltiplos cartões
					$instancehandle->efetivaTEFPendente(<FALSE>, <FALSE>)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
					endif				
				endif
			endif
			$inTEF$ = <TRUE>
		else
			setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
		endif		
	endwhile

	vTpCobranca    = ""
	vPrDescPontual = 0
	vPrDescBonific = 0

	clear/e "PED_PEDIDOTRA"
	CD_EMPTRANSACAO.PED_PEDIDOTRA/init = CD_EMPRESA.TRA_TRANSACAO
	NR_TRANSACAO.PED_PEDIDOTRA/init    = NR_TRANSACAO.TRA_TRANSACAO
	DT_TRANSACAO.PED_PEDIDOTRA/init    = DT_TRANSACAO.TRA_TRANSACAO
	retrieve/e "PED_PEDIDOTRA"
	if ($status >= 0)
		if (CD_EMPFAT.TRA_TRANSACAO = $item("CD_EMPRESA", $$gParamGlb))
			if (TP_COBRANCA.PED_PEDIDOC != "")
				vTpCobranca = TP_COBRANCA.PED_PEDIDOC
			endif
		else
			if (TP_COBRANCAPADRAO.PED_PEDIDOC != "")
				vTpCobranca = TP_COBRANCAPADRAO.PED_PEDIDOC
			elseif (TP_COBRANCA.PED_PEDIDOC != "")
				vTpCobranca = TP_COBRANCA.PED_PEDIDOC
			endif
		endif
		
		if ($prDescPontualPed$ > 0)
			clear/e "PED_PEDTIPODESC"
			CD_TIPODESC.PED_PEDTIPODESC/init = $prDescPontualPed$
			retrieve/e "PED_PEDTIPODESC"
			if ($status >= 0)
				vPrDescPontual = PR_DESCONTO.PED_PEDTIPODESC
			endif
		endif
		
		if ($prDescBonificPed$ > 0)
			clear/e "PED_PEDTIPODESC"
			CD_TIPODESC.PED_PEDTIPODESC/init = $prDescBonificPed$
			retrieve/e "PED_PEDTIPODESC"
			if ($status >= 0)
				vPrDescBonific = PR_DESCONTO.PED_PEDTIPODESC
			endif
		endif
		
		;Hugo em 11/04/11 Tarefa 22-1805
		if (vCdDescAbatiPed > 0)
			clear/e "PED_PEDTIPODESC"
			CD_TIPODESC.PED_PEDTIPODESC/init = vCdDescAbatiPed
			retrieve/e "PED_PEDTIPODESC"
			if ($status >= 0)
				vPrDescAbatiPed = PR_DESCONTO.PED_PEDTIPODESC
			endif
		endif
		;
		
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.PED_PEDIDOC
		putitem/id viParams, "CD_PEDIDO" , CD_PEDIDO.PED_PEDIDOC
		activate "TRASVCO016".buscaRelacClasPedidoFatura($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		
		vDsLstClassificacao = $item("DS_LSTCLASSIFICACAO", voParams)
	else
		viParams = ""
		putitem/id viParams, "CD_CLIENTE", $cdPessoa$;CD_PESSOA.PES_PESSOA
		activate "PESSVCO011".buscaPreferenciaCliente($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		
		vTpCobranca = $item("TP_COBRANCA", voParams)
	endif 

	if (vTpCobranca = "")
		vTpCobranca = vTpCobrancaVd
		
		if (vTpCobranca = "")
			vTpCobranca = 0
		endif
	endif
	
	;---Elia Proj. 105/037 30/01/09
	if ($CdEmpContrato$ > 0) & ($NrSeqContrato$ > 0) & ($NrSeqItemContrato$ > 0) 
		viParams = ""
		putitem/id viParams, "CD_EMPCONTRATO",  $CdEmpContrato$
		putitem/id viParams, "NR_SEQCONTRATO",  $NrSeqContrato$
		putitem/id viParams, "NR_SEQITEM",      $NrSeqItemContrato$
		putitem/id viParams, "CD_EMPTRANSACAO", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO",    NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO",    DT_TRANSACAO.TRA_TRANSACAO
		activate "IMBSVCO003".buscaClassificaoFatura($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		vDsLstClassificacao = $item("DS_LSTCLASSIFICACAO", voParams)
	endif
	;
	
	clear/e "TMP_K02NR10"
	vDsLstParamCC = ""
	vDsLstLiqMov  = ""
	
	vDsLstSeguro    = ""
	vDsLstNaoSeguro = ""
	
	setocc "SIS_VALOR", 1
	while ($status >= 0)		
		vDsCheque = "" 
		viParams  = "" 
		
		if (TP_DOCUMENTO.SIS_VALOR != 0)
			clear/e "FCR_FATURAI"
			CD_EMPRESA.FCR_FATURAI/init       = CD_EMPFAT.TRA_TRANSACAO
			CD_CLIENTE.FCR_FATURAI/init       = $cdPessoa$
			NR_FAT.FCR_FATURAI/init           = NR_DOCUMENTO.SIS_VALOR
			TP_SITUACAO.FCR_FATURAI/init      = 1 ;Normal
			TP_DOCUMENTO.FCR_FATURAI/init     = TP_DOCUMENTO.SIS_VALOR
			TP_FATURAMENTO.FCR_FATURAI/init   = vTpFaturamento
			TP_COBRANCA.FCR_FATURAI/init      = 0 ;Não está em cobrança
			TP_INCLUSAO.FCR_FATURAI/init      = 2 ;Automático
			TP_BAIXA.FCR_FATURAI/init         = 0 ;Não baixado
			CD_MOTIVOPRORR.FCR_FATURAI/init   = ""
			CD_MOTIVOJURDESC.FCR_FATURAI/init = ""
			NR_PARCELAORIGEM.FCR_FATURAI/init = ""
			NR_COMISSAOPAGA.FCR_FATURAI/init  = ""
			
			; Localiza portador 
			clear/e "FCX_HISTREL" 
			clear/e "FCX_HISTRELSUB"
			if (TP_DOCUMENTO.SIS_VALOR = 4 | TP_DOCUMENTO.SIS_VALOR = 5) ;Cartco crédito/Cartão débito
				TP_DOCUMENTO.FCX_HISTRELSUB/init     = TP_DOCUMENTO.SIS_VALOR
				NR_SEQHISTRELSUB.FCX_HISTRELSUB/init = $item("NR_SEQHISTRELSUB", DS_ADICIONAL.SIS_VALOR)
				retrieve/e "FCX_HISTRELSUB"
				if ($status >= 0)
					NR_PORTADOR.FCR_FATURAI/init = NR_PORTADOR.FCX_HISTRELSUB
				else 
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Histórico auxiliar de parcelamento %%NR_SEQHISTRELSUB.FCX_HISTRELSUB não cadastrado!", "")
					return(-1)
				endif
				NR_HISTRELSUB.FCR_FATURAI/init = NR_SEQHISTRELSUB.FCX_HISTRELSUB
			else
				TP_DOCUMENTO.FCX_HISTREL/init  = TP_DOCUMENTO.SIS_VALOR
				retrieve/e "FCX_HISTREL"
				if ($status >= 0)
					NR_PORTADOR.FCR_FATURAI/init = NR_PORTADOR.FCX_HISTREL
				else
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Histórico auxiliar não cadastrado para a tipo de documento %%TP_DOCUMENTO.FCX_HISTREL%%%!", "")
					return(-1)
				endif
			endif
			CD_OPERBAIXA.FCR_FATURAI/init     = ""
			CD_OPERCANCEL.FCR_FATURAI/init    = ""
			CD_OPERALTERACAO.FCR_FATURAI/init = ""
			CD_OPERIMPFAT.FCR_FATURAI/init    = ""
			DT_EMISSAO.FCR_FATURAI/init       = vDtSistema
			DT_ALTERACAO.FCR_FATURAI/init     = ""
			DT_CANCELAMENTO.FCR_FATURAI/init  = ""
			DT_VENCIMENTO.FCR_FATURAI/init    = DT_VENCIMENTO.SIS_VALOR
			DT_VENCTOORIGEM.FCR_FATURAI/init  = ""
			DT_IMPFAT.FCR_FATURAI/init        = ""
			CD_EMPLIQ.FCR_FATURAI/init        = ""
			DT_LIQ.FCR_FATURAI/init           = ""
			NR_SEQLIQ.FCR_FATURAI/init        = ""
			NR_DOCUMENTO.FCR_FATURAI/init     = NR_DOCUMENTO.SIS_VALOR
			VL_FATURA.FCR_FATURAI/init        = VL_DOCUMENTO.SIS_VALOR
			VL_ORIGINAL.FCR_FATURAI/init      = VL_DOCUMENTO.SIS_VALOR
			VL_PAGO.FCR_FATURAI/init          = 0
			VL_JUROS.FCR_FATURAI/init         = 0
			VL_DESCONTO.FCR_FATURAI/init      = 0
			VL_OUTACRES.FCR_FATURAI/init      = 0
			VL_OUTDESC.FCR_FATURAI/init       = 0
			VL_ABATIMENTO.FCR_FATURAI/init    = 0
			VL_DESPFIN.FCR_FATURAI/init       = 0
			VL_ACRESCIMO.FCR_FATURAI/init     = 0
			; o componente é passado abaixo antes de chamar o serviço
			
			if (TP_DOCUMENTO.SIS_VALOR = 1) ;Fatura
				;==BY BIANCHINI[PRJ/TAREFA 180/0225] 25/07/2011 ==;
				if ($inDesctoAntecFatSimu$ = <TRUE>)
					putitem/id viParams, "CD_EMPRESA"  , CD_EMPRESA.TRA_TRANSACAO
					putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
					putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
					activate "TRASVCO022".buscaDadosTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if ($item("PR_SIMULADOR", voParams) != "") & ($item("PR_SIMULADOR", voParams) > 0)
						PR_DESCANTECIP1.FCR_FATURAI/init = $item("PR_SIMULADOR" , voParams)
						vDtVencimento                    = DT_VENCIMENTO.SIS_VALOR - 1d
						DT_DESCANTECIP1.FCR_FATURAI/init = vDtVencimento
					endif
				endif
				;==
				PR_DESCPGPRAZO.FCR_FATURAI/init = vPrDescPontual
				TP_COBRANCA.FCR_FATURAI/init    = vTpCobranca
				if (vTpCobranca = 18) ;Direto boleto
					IN_ACEITE.FCR_FATURAI/init   = <TRUE>
				endif

				vInCobLoja = $item("IN_COBLOJA", DS_ADICIONAL.SIS_VALOR)
				if (vInCobLoja = <TRUE>)
					TP_COBRANCA.FCR_FATURAI/init = 16 ;Cobrança em loja
				endif

				if ($CdEmpContrato$ > 0) & ($NrSeqContrato$ > 0)
					;Cobrança em loja - Fiuza/Elia prj 22 tar 557 - 07/05/08
					vInAgRecebimento = $item("IN_AGRECEBIMENTO", DS_ADICIONAL.SIS_VALOR)
					if (vInAgRecebimento = <TRUE>)
						TP_COBRANCA.FCR_FATURAI/init = 17 ;Aguardando recebimento
					endif
					if ($item("CD_INDICE", DS_ADICIONAL.SIS_VALOR) != "")
						vDsIndice = ""
						putitem/id vDsIndice, "CD_INDICE",   $item("CD_INDICE",   DS_ADICIONAL.SIS_VALOR)
						putitem/id vDsIndice, "DT_CORRECAO", $item("DT_CORRECAO", DS_ADICIONAL.SIS_VALOR)
					endif
				endif
			
				VL_OUTDESC.FCR_FATURAI/init = vPrDescBonific * VL_FATURA.FCR_FATURAI / 100
				VL_OUTDESC.FCR_FATURAI/init = VL_OUTDESC.FCR_FATURAI[round, 2]
				
				;Hugo em 11/04/11 Tarefa 22-1805
				vVlAbatimento = vPrDescAbatiPed * VL_FATURA.FCR_FATURAI / 100
				vVlAbatimento = vVlAbatimento[round, 2]
				;
				;--Douglas Ferreira - [Prj/Tarefa 186/0158] - 22/08/2011
				if ($cdCartao$ > 0)
					NR_RESUMOCARTAO.FCR_FATURAI/init = $cdCartao$
					DS_RESUMOCARTAO.FCR_FATURAI/init = "PROPRIO"
				endif
				;
			elseif (TP_DOCUMENTO.SIS_VALOR = 2) | (TP_DOCUMENTO.SIS_VALOR = 15) ;Cheque / Cheque garantido
				
				TP_DOCUMENTO.FCR_FATURAI/init = TP_DOCUMENTO.SIS_VALOR
				;---Elia Proj. 102/537 04/05/09
				if ($item("CD_CLIENTE", DS_ADICIONAL.SIS_VALOR) != 0)
					CD_CLIENTE.FCR_FATURAI/init = $item("CD_CLIENTE", DS_ADICIONAL.SIS_VALOR)
				endif
				;
				;--Douglas Ferreira - [Prj/Tarefa 186/0158] - 22/08/2011
				if ($cdCartao$ > 0) & (TP_DOCUMENTO.SIS_VALOR = 2)
					NR_RESUMOCARTAO.FCR_FATURAI/init = $cdCartao$
					DS_RESUMOCARTAO.FCR_FATURAI/init = "PROPRIO"
				endif
				;
				vDsCheque = ""
				putitem/id vDsCheque, "NR_BANCO",    $item("NR_BANCO",    DS_ADICIONAL.SIS_VALOR)
				putitem/id vDsCheque, "NR_AGENCIA",  $item("NR_AGENCIA",  DS_ADICIONAL.SIS_VALOR)
				putitem/id vDsCheque, "NR_CONTA"     $item("NR_CONTA",    DS_ADICIONAL.SIS_VALOR)
				putitem/id vDsCheque, "NR_CHEQUE"    $item("NR_CHEQUE",   DS_ADICIONAL.SIS_VALOR)
				putitem/id vDsCheque, "DS_BANDA"     $item("NR_BANDA",    DS_ADICIONAL.SIS_VALOR)
				putitem/id vDsCheque, "DS_TELEFONE"  $item("NR_TELEFONE", DS_ADICIONAL.SIS_VALOR)
				putitem/id vDsCheque, "DS_DOCUMENTO" $item("NR_CPFCNPJ",  DS_ADICIONAL.SIS_VALOR)
				putitem/id vDsCheque, "IN_TERCEIRO", $item("IN_TERCEIRO", DS_ADICIONAL.SIS_VALOR) ;MTF(30/08/2006) - Projeto 078, tarefa 028.
				
			elseif (TP_DOCUMENTO.SIS_VALOR = 3) ;Dinheiro
				
				DT_LIQ.FCR_FATURAI/init       = vDtSistema
				VL_PAGO.FCR_FATURAI/init      = VL_DOCUMENTO.SIS_VALOR
				TP_BAIXA.FCR_FATURAI/init     = 10 ;Via faturamento
				;Projeto 078 - Tarefa 3640 - Aloisio Gargantini - 17/08/2010
				DT_BAIXA.FCR_FATURAI/init     = vDtSistema
				CD_OPERBAIXA.FCR_FATURAI/init = $item("CD_USUARIO", $$gParamGlb)
				;
			elseif (TP_DOCUMENTO.SIS_VALOR = 4) ;Cartão de crédito

				TP_BAIXA.FCR_FATURAI/init = 10 ;Via faturamento
			elseif (TP_DOCUMENTO.SIS_VALOR = 5) ;Cartão de débito

				TP_BAIXA.FCR_FATURAI/init = 10 ;Via faturamento
			elseif (TP_DOCUMENTO.SIS_VALOR = 7) ; TEF

			elseif (TP_DOCUMENTO.SIS_VALOR = 9) ; Troco

				DT_LIQ.FCR_FATURAI/init       = vDtSistema
				VL_PAGO.FCR_FATURAI/init      = VL_DOCUMENTO.SIS_VALOR
				TP_BAIXA.FCR_FATURAI/init     = 10 ;Via faturamento
				;Projeto 078 - Tarefa 3640 - Aloisio Gargantini - 17/08/2010
				DT_BAIXA.FCR_FATURAI/init     = vDtSistema
				CD_OPERBAIXA.FCR_FATURAI/init = $item("CD_USUARIO", $$gParamGlb)
				;
			elseif (TP_DOCUMENTO.SIS_VALOR = 10) ;Adiantamento

				DT_LIQ.FCR_FATURAI/init       = vDtSistema
				VL_PAGO.FCR_FATURAI/init      = VL_DOCUMENTO.SIS_VALOR
				TP_BAIXA.FCR_FATURAI/init     = 10 ;Via faturamento
				;Projeto 078 - Tarefa 3640 - Aloisio Gargantini - 17/08/2010
				DT_BAIXA.FCR_FATURAI/init     = vDtSistema
				CD_OPERBAIXA.FCR_FATURAI/init = $item("CD_USUARIO", $$gParamGlb)
				;
			elseif (TP_DOCUMENTO.SIS_VALOR = 11) ;Desconto

				DT_LIQ.FCR_FATURAI/init       = vDtSistema
				TP_BAIXA.FCR_FATURAI/init     = 10 ;Via faturamento
				;Projeto 078 - Tarefa 3640 - Aloisio Gargantini - 17/08/2010
				DT_BAIXA.FCR_FATURAI/init     = vDtSistema
				CD_OPERBAIXA.FCR_FATURAI/init = $item("CD_USUARIO", $$gParamGlb)
				;
			elseif (TP_DOCUMENTO.SIS_VALOR = 12) ;DOFNI

				vNrDOFNI = $item("NR_DOFNI", DS_ADICIONAL.SIS_VALOR)

				if (vNrDOFNI > 0)
					creocc "FCR_DOFNI", -1
					NR_DOFNI.FCR_DOFNI/init = vNrDOFNI
					retrieve/o "FCR_DOFNI"
					if ($status = 4)
						CD_CLIENTE.FCR_FATURAI/init = CD_PESSOA.FCR_DOFNI
					else
						discard "FCR_DOFNI"
					endif
				endif

				DT_LIQ.FCR_FATURAI/init       = vDtSistema
				VL_PAGO.FCR_FATURAI/init      = VL_DOCUMENTO.SIS_VALOR
				TP_BAIXA.FCR_FATURAI/init     = 10 ;Via faturamento
				;Projeto 078 - Tarefa 3640 - Aloisio Gargantini - 17/08/2010
				DT_BAIXA.FCR_FATURAI/init     = vDtSistema
				CD_OPERBAIXA.FCR_FATURAI/init = $item("CD_USUARIO", $$gParamGlb)
				;
			;Projeto 078 - Tarefa 1486 - Aloisio Gargantini 
			elseif (TP_DOCUMENTO.SIS_VALOR = 18) ;Cheque Presente

				DT_LIQ.FCR_FATURAI/init   = vDtSistema
				VL_PAGO.FCR_FATURAI/init  = VL_DOCUMENTO.SIS_VALOR
				TP_BAIXA.FCR_FATURAI/init = 10 ;Via faturamento
			;
				;Projeto 078 - Tarefa 3640 - Aloisio Gargantini - 17/08/2010
				DT_BAIXA.FCR_FATURAI/init      = vDtSistema
				CD_OPERBAIXA.FCR_FATURAI/init  = $item("CD_USUARIO", $$gParamGlb)
				;
			elseif (TP_DOCUMENTO.SIS_VALOR = 13) ;Vale

				DT_LIQ.FCR_FATURAI/init       = vDtSistema
				VL_PAGO.FCR_FATURAI/init      = VL_DOCUMENTO.SIS_VALOR
				TP_BAIXA.FCR_FATURAI/init     = 10 ;Via faturamento
				;Projeto 078 - Tarefa 3640 - Aloisio Gargantini - 17/08/2010
				DT_BAIXA.FCR_FATURAI/init     = vDtSistema
				CD_OPERBAIXA.FCR_FATURAI/init = $item("CD_USUARIO", $$gParamGlb)
				;
			elseif (TP_DOCUMENTO.SIS_VALOR = 14) ;Nota promissória

				PR_DESCPGPRAZO.FCR_FATURAI/init = vPrDescPontual
				vInCobLoja = $item("IN_COBLOJA", DS_ADICIONAL.SIS_VALOR)
				if (vInCobLoja = <TRUE>)
					TP_COBRANCA.FCR_FATURAI/init = 16 ;Cobrança em loja
				endif

				VL_OUTDESC.FCR_FATURAI/init = vPrDescBonific * VL_FATURA.FCR_FATURAI / 100
				VL_OUTDESC.FCR_FATURAI/init = VL_OUTDESC.FCR_FATURAI[round, 2]
			elseif (TP_DOCUMENTO.SIS_VALOR = 20) ;CREDEV

				DT_LIQ.FCR_FATURAI/init       = vDtSistema
				VL_PAGO.FCR_FATURAI/init      = VL_DOCUMENTO.SIS_VALOR
				TP_BAIXA.FCR_FATURAI/init     = 10 ;Via faturamento
				;Projeto 078 - Tarefa 3640 - Aloisio Gargantini - 17/08/2010
				DT_BAIXA.FCR_FATURAI/init     = vDtSistema
				CD_OPERBAIXA.FCR_FATURAI/init = $item("CD_USUARIO", $$gParamGlb)
				;
			endif

			vDsLstComissao = ""

			if ($inPdvOtimizado$ != <TRUE>);nao tem comissao de guia ou representante
				;--------------------------------------------
				;I  M  P  O  R  T  A  N  T  E
				;--------------------------------------------
				;PROJETO : 79
				;TAREFA  : 60
				;DATA    : 02/07/07
				;DESEN.  : HUGO ANDREO
				;PERMITIR GERAR COMISSAO PARA O TIPO DE DOCUMENTO ADIANTAMENTO (10)
				;A CONDICAÇÃO ABAIXO COMENTADA NAO PERMITIA QUE O TIPO DE DOCUMENTO ADIANTAMENTO
				;GERASSE UMA COMISSAO, A PARTIR DA TAREFA SOLICITADA PELO SR. MIGUEL
				;FOI REMOVIDO ESSE TIPO DE DOCUMENTO DA CONDICAO
				;if (TP_DOCUMENTO.SIS_VALOR != 10) & (TP_DOCUMENTO.SIS_VALOR != 11) & (TP_DOCUMENTO.SIS_VALOR != 20) ;Adiantamento / Desconto / CREDEV
				if (TP_DOCUMENTO.SIS_VALOR != 11) & (TP_DOCUMENTO.SIS_VALOR != 20) ;Adiantamento / Desconto / CREDEV

					if ($CdEmpContrato$ > 0) & ($NrSeqContrato$ > 0) ;& ($NrSeqItemContrato$ > 0) DIONE |094/1786| 16/05/11
						viParams = ""
						putitem/id viParams, "CD_EMPCONTRATO",  $CdEmpContrato$
						putitem/id viParams, "NR_SEQCONTRATO",  $NrSeqContrato$
						putitem/id viParams, "NR_SEQITEM",      $NrSeqItemContrato$
						putitem/id viParams, "VL_FATURA",       VL_FATURA.FCR_FATURAI
						; --- DIONE |094/1786| 16/05/11
						putitem/id viParams, "CD_EMPTRANSACAO", CD_EMPRESA.TRA_TRANSACAO
						putitem/id viParams, "NR_TRANSACAO",    NR_TRANSACAO.TRA_TRANSACAO
						putitem/id viParams, "DT_TRANSACAO",    DT_TRANSACAO.TRA_TRANSACAO
						; ---
						activate "COMSVCO002".calculaComissaoContrato($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						vDsLstComisRepre = $item("DS_LSTCOMISSAO", voParams)
						if (vDsLstComisRepre != "")
							vDsLstComissao = vDsLstComisRepre
						endif
					else
						viParams = ""
						putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
						putitem/id viParams, "VL_FATURA",       VL_FATURA.FCR_FATURAI
						putitem/id viParams, "TP_DOCUMENTO",    TP_DOCUMENTO.FCR_FATURAI
						activate "COMSVCO002".calculaComissaoGuia($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
	
						vDsLstComisGuia = $item("DS_LSTCOMISSAO", voParams)			

						activate "COMSVCO002".calculaComissaoRepre($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif

						vDsLstComisRepre = $item("DS_LSTCOMISSAO", voParams)
	
						if (vDsLstComisGuia = "")
							vDsLstComissao = vDsLstComisRepre
						else
							vDsLstComissao = vDsLstComisGuia
							if (vDsLstComisRepre != "")
								vDsLstComissao = "%%vDsLstComissao%%%·;%%vDsLstComisRepre%%"
							endif
						endif
					endif
				endif
			endif
;oda 			
			if (TP_DOCUMENTO.SIS_VALOR = 4 | TP_DOCUMENTO.SIS_VALOR = 5) ;Cartão de crédito/Cartão de débito
				creocc "TMP_K02NR10", -1
				NR_CHAVE01.TMP_K02NR10/init = NR_PORTADOR.FCR_FATURAI
				NR_CHAVE02.TMP_K02NR10/init = NR_FAT.FCR_FATURAI
				retrieve/o "TMP_K02NR10"
				if ($status = -7)
					retrieve/x "TMP_K02NR10"
				endif
				putlistitems/occ vDsRegistro, "FCR_FATURAI"
				if (vDsLstComissao != "")
					putitem/id vDsRegistro, "DS_FATCOMISSAO", vDsLstComissao
				endif
				NR_SEQHISTRELSUB.TMP_K02NR10/init = NR_SEQHISTRELSUB.FCX_HISTRELSUB
				putitem DS_LSTFATURA.TMP_K02NR10, -1, vDsRegistro                
			else
				if (TP_DOCUMENTO.SIS_VALOR = 9) & (IN_ADIANTATROCO.SIS_DUMMY3 = <TRUE>) ;Troco
					TP_DOCUMENTO.FCR_FATURAI = 10 ;adiantamento
					viParams = ""
					putlistitems/occ vDsRegistro, "FCR_FATURAI"
					putitem/id viParams, "DS_FATURAI",      vDsRegistro
					putitem/id viParams, "DS_CHEQUE",       vDsCheque
					putitem/id viParams, "IN_ALTSOFATURAI", <FALSE>
					putitem/id viParams, "IN_SEMCOMISSAO",  <TRUE>
					putitem/id viParams, "IN_SEMIMPOSTO",   <TRUE>
					putitem/id viParams, "CD_COMPONENTE",   $componentname
					putitem/id viParams, "LST_TRANSACAO",   vLstTransacao
					activate "FCRSVCO001".geraFatura($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						;--Douglas Ferreira - [Prj/Tarefa 180/86] - 09/02/2011
						;return(-3)
						return(-1)
						;
					endif
					if (voParams = "")
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma fatura retornada pela serviço de gravação!", "")
						return(-1)
					endif
					vNrParcela = $item("NR_PARCELA", voParams)
					
					viParams = ""
					putitem/id viParams, "CD_EMPRESA",  CD_EMPFAT.TRA_TRANSACAO
					putitem/id viParams, "CD_PESSOA",   $cdPessoa$
					putitem/id viParams, "TP_CONTA",    "C" ;Cliente
					putitem/id viParams, "IN_NATUREZA", "C" ;Credora
					activate "FCCSVCO002".criaContaPessoa($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					vNrCtaPes = $item("NR_CTAPES", voParams)
					
					viValores = ""
					viParams = ""
					putitem/id viParams, "CD_EMPRESA",       CD_EMPFAT.TRA_TRANSACAO
					putitem/id viParams, "NR_CTAPES",        vNrCtaPes
					putitem/id viParams, "DT_MOVIMENTO",     vDtSistema
					;Projeto 078 - Tarefa 3422 - Aloisio Gargantini - 25/05/2010
					;putitem/id viParams, "CD_HISTORICO",     900
					putitem/id viParams, "CD_HISTORICO",     933 ;Crédito de adiantamento a cliente por troco.
					;
					putitem/id viParams, "TP_DOCUMENTO",     10 ;Adiantamento
					putitem/id viParams, "NR_SEQHISTRELSUB", 1
					putitem/id viParams, "VL_LANCTO",        VL_DOCUMENTO.SIS_VALOR
					putitem/id viParams, "IN_ESTORNO",       <FALSE>
					putitem/id viParams, "DS_DOC",           NR_TRANSACAO.TRA_TRANSACAO
					putitem/id viParams, "DS_AUX",           ""
					putitem/id viParams, "DT_CONCI",         ""
					putitem/id viParams, "CD_OPERCONCI",     ""
					activate "FCCSVCO002".movimentaConta($$gParamGlb, viParams, viValores, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					vNrCtaPes   = $item("NR_CTAPES", voParams)
					vDtMovim    = $item("DT_MOVIM",  voParams)
					vNrSeqMov   = $item("NR_SEQMOV", voParams)
					vDsRegistro = ""
					putitem/id vDsRegistro, "NR_CTAPES", vNrCtaPes
					putitem/id vDsRegistro, "DT_MOVIM",  vDtMovim
					putitem/id vDsRegistro, "NR_SEQMOV", vNrSeqMov
					putitem vDsLstMovCC, -1, vDsRegistro
					
					vDsLstMovimento = ""
					putitem vDsLstMovimento, -1, vDsRegistro
					
					vDsRegistro = ""
					putitem/id vDsRegistro, "DS_LSTMOVCC",   vDsLstMovimento
					putitem/id vDsRegistro, "TP_LIQUIDACAO", 3 ;Recebimento.
					putitem/id vDsRegistro, "CD_EMPRESA",    CD_EMPRESA.FCR_FATURAI
					putitem/id vDsRegistro, "NR_FAT",        NR_FAT.FCR_FATURAI
					putitem/id vDsRegistro, "NR_PARCELA",    vNrParcela
					putitem/id vDsRegistro, "TP_DOCUMENTO",  TP_DOCUMENTO.FCR_FATURAI
					putitem/id vDsRegistro, "VL_PAGO",       VL_DOCUMENTO.SIS_VALOR
					putitem/id vDsRegistro, "NR_SEQUENCIA",  vNrSequencia
					putitem/id vDsRegistro, "CD_CLIENTE",    $cdPessoa$
					putitem/id vDsRegistro, "CD_PESSOA",     $cdPessoa$
					putitem vDsLstLiqMov, -1, vDsRegistro
					vNrSequencia = vNrSequencia + 1
				else
					viParams = ""
					putlistitems/occ vDsRegistro, "FCR_FATURAI"
					if (vDsLstComissao != "")
						putitem/id vDsRegistro, "DS_FATCOMISSAO", vDsLstComissao
					;coloquei esta linha por causa do email do Jorge, verificar
					else
						putitem/id viParams,    "IN_SEMCOMISSAO", <TRUE>
					endif
					putitem/id viParams, "DS_FATURAI",      vDsRegistro
					putitem/id viParams, "DS_INDICE",       vDsIndice
					putitem/id viParams, "DS_CHEQUE",       vDsCheque
					;coloquei esta linha por causa do email do Jorge, verificar
					putitem/id viParams, "IN_ALTSOFATURAI", <FALSE>
					;coloquei esta linha por causa do email do Jorge, verificar
					putitem/id viParams, "IN_SEMIMPOSTO",   <TRUE>
					putitem/id viParams, "CD_COMPONENTE",   $componentname
					putitem/id viParams, "LST_TRANSACAO",   vLstTransacao ;MTF(18/07/2008) - Projeto 078, tarefa 1670.
					activate "FCRSVCO001".geraFatura($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						;--Douglas Ferreira - [Prj/Tarefa 180/86] - 09/02/2011
						;return(-3)
						return(-1)
						;
					endif
					if (voParams = "")
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma fatura retornada pela serviço de gravação!", "")
						return(-1)
					endif	

					vNrParcela = $item("NR_PARCELA", voParams)	
					
					vDsRegistro = voParams ;Monta a lista com as faturas p/ gravar a liquidação
					putitem/id vDsRegistro, "NR_CTAPESCX", $nrCtaUsuario$
					;Projeto 180 - Tarefa 0227 - Aloisio Gargantini - 27/07/2011
					if (TP_DOCUMENTO.SIS_VALOR = 18) ;Cheque presente
						putitem/id vDsRegistro, "NR_CTAPES",     $item("NR_CTAPES" ,  DS_ADICIONAL.SIS_VALOR)
						putitem/id vDsRegistro, "CD_EMPRESACHE", $item("CD_EMPRESA" , DS_ADICIONAL.SIS_VALOR)
						putitem/id vDsRegistro, "CD_CLIENTECHE", $item("CD_CLIENTE" , DS_ADICIONAL.SIS_VALOR)
						putitem/id vDsRegistro, "NR_CHEQUE",     $item("NR_CHEQUE" ,  DS_ADICIONAL.SIS_VALOR)
						putitem/id vDsRegistro, "VL_CHEQUE",     $item("VL_CHEQUE" ,  DS_ADICIONAL.SIS_VALOR)
					endif
					;
					putitem vDsLstFatura, -1, vDsRegistro
					if (TP_DOCUMENTO.SIS_VALOR = 1) | (TP_DOCUMENTO.SIS_VALOR = 14) ;Fatura / Nota promissória
						putitem vDsLstFaturaImp, -1, vDsRegistro
					endif
					;Projeto 078 - Tarefa 1486 - Aloisio Gargantini - 29/05/2008
					if (TP_DOCUMENTO.SIS_VALOR = 18) ;Cheque presente
						DS_REGISTRO.SIS_VALOR/init = vDsRegistro
					endif
					;
					
					;Hugo em 11/04/11 Tarefa 22-1805
					if (vCdDescAbatiPed != 0) & (TP_DOCUMENTO.SIS_VALOR = 1) ;Fatura
						if (vCdAbatiPed = 0)
							$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Ambos parâmetros empresa deve estar configurados: CD_TIPODES_ABATIMENTO_PED e CD_TIPO_ABATIMENTO_PED!", "")
							return(-1)
						endif
						
						if (vVlAbatimento != 0)
							viParams = ""
							putitem/id viParams, "CD_EMPRESA",    CD_EMPRESA.FCR_FATURAI
							putitem/id viParams, "CD_CLIENTE",    CD_CLIENTE.FCR_FATURAI
							putitem/id viParams, "NR_FAT",        NR_FAT.FCR_FATURAI
							putitem/id viParams, "NR_PARCELA",    vNrParcela
							putitem/id viParams, "VL_ABATIMENTO", vVlAbatimento
							putitem/id viParams, "IN_PARCIAL", <TRUE> ; DIONE |156/0647| 26/09/2011
							activate "FCRSVCO019".gerarAbatimentoLiq($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								return(-1)
							endif
							
							viParams = ""
							putitem/id viParams, "CD_EMPRESA",    CD_EMPRESA.FCR_FATURAI
							putitem/id viParams, "CD_CLIENTE",    CD_CLIENTE.FCR_FATURAI
							putitem/id viParams, "NR_FAT",        NR_FAT.FCR_FATURAI
							putitem/id viParams, "NR_PARCELA",    vNrParcela
							putitem/id viParams, "CD_TIPOABAT",   vCdAbatiPed
							putitem/id viParams, "VL_ABATIMENTO", vVlAbatimento
							putitem/id viParams, "CD_MOTIVO",     vCdMotivoAbat
							putitem/id viParams, "CD_EMPLIQ",     $item("CD_EMPLIQ", voParams)
							putitem/id viParams, "DT_LIQ",        $item("DT_LIQ",    voParams)
							putitem/id viParams, "NR_SEQLIQ",     $item("NR_SEQLIQ", voParams)
							activate "FCRSVCO019".gerarAbatimento($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
							if ($procerror)       
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								return(-1)
							endif
						endif
					endif
					;
				endif
			endif
			
			if (TP_DOCUMENTO.SIS_VALOR = 9) & (IN_ADIANTATROCO.SIS_DUMMY3 = <TRUE>) ;Troco
			else
				viParams = ""
				putitem/id viParams, "CD_EMPRESA",   CD_EMPFAT.TRA_TRANSACAO
				putitem/id viParams, "NR_CTAPES",    $nrCtaUsuario$
				putitem/id viParams, "DT_MOVIMENTO", vDtSistema
				if (TP_DOCUMENTO.SIS_VALOR = 9) ;Troco
					putitem/id viParams, "CD_HISTORICO", 935 ;Troco
				else
					putitem/id viParams, "CD_HISTORICO", 930 ;Venda
				endif
				putitem/id viParams, "TP_DOCUMENTO", TP_DOCUMENTO.SIS_VALOR
				if (TP_DOCUMENTO.SIS_VALOR = 4 | TP_DOCUMENTO.SIS_VALOR = 5) ;Cartão de crédito/Cartão de débito
					putitem/id viParams, "NR_SEQHISTRELSUB", NR_SEQHISTRELSUB.FCX_HISTRELSUB
				else
					putitem/id viParams, "NR_SEQHISTRELSUB", 1
				endif
				putitem/id viParams, "VL_LANCTO",    VL_DOCUMENTO.SIS_VALOR
				putitem/id viParams, "IN_ESTORNO",   <FALSE>
				putitem/id viParams, "DS_DOC",       NR_DOCUMENTO.SIS_VALOR
				putitem/id viParams, "DS_AUX",       "CLIENTE: %%$cdPessoa$"
				putitem/id viParams, "DT_CONCI",     ""
				putitem/id viParams, "CD_OPERCONCI", ""
				putitem vDsLstParamCC, -1, viParams 
				;Grava um lista de parametros para a chamada da rotina de CC depois que
				;for gravada a liquidação, pois a FCCSVCO002 precisa da chave da liquidação
			endif

			; --- DIONE |179/0008| 07/01/11
			if ($item("CD_TIPOCLASFCR", DS_REGISTRO.SIS_VALOR) > 0) & ($item("CD_CLASFCR", DS_REGISTRO.SIS_VALOR) > 0)

				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPFAT.TRA_TRANSACAO
				putitem/id vDsRegistro, "CD_CLIENTE", $cdPessoa$
				putitem/id vDsRegistro, "NR_FAT",     NR_DOCUMENTO.SIS_VALOR
				putitem/id vDsRegistro, "NR_PARCELA", vNrParcela
				
				putitem vDsLstSeguro, -1, vDsRegistro ;Hugo em 23/02/11 Tarefa 179-18

				vDsClas = ""
				vDsLstClas	= ""
				putitem/id vDsClas, "CD_TIPOCLAS",      $item("CD_TIPOCLASFCR", DS_REGISTRO.SIS_VALOR)
				putitem/id vDsClas, "CD_CLASSIFICACAO", $item("CD_CLASFCR",     DS_REGISTRO.SIS_VALOR)
				putitem vDsLstClas, -1, vDsClas

				putitem/id vDsRegistro, "DS_LSTCLASSIFICACAO", vDsLstClas
				putitem vDsLstFatura2, -1, vDsRegistro

				viParams = ""
				putitem/id viParams, "DS_LSTFATURA", vDsLstFatura2
				activate "FCRSVCO001".gravaClassificacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)                      
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					;rollback ;--Douglas Ferreira - [Prj/Tarefa 180/86] - 09/02/2011
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					;rollback ;--Douglas Ferreira - [Prj/Tarefa 180/86] - 09/02/2011
					return(-1)
				endif
			;Hugo em 23/02/11 Tarefa 179-18
			else
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPFAT.TRA_TRANSACAO
				putitem/id vDsRegistro, "CD_CLIENTE", $cdPessoa$
				putitem/id vDsRegistro, "NR_FAT",     NR_DOCUMENTO.SIS_VALOR
				putitem/id vDsRegistro, "NR_PARCELA", vNrParcela
				
				putitem vDsLstNaoSeguro, -1, vDsRegistro
			;
			endif
			; --- 
		endif
		
		setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
	endwhile
	
	;Hugo em 23/02/11 Tarefa 179-18
	if (vDsLstNaoSeguro != "") & (vDsLstSeguro != "")
		viParams = ""
		putitem/id viParams, "DS_LSTPRODUTO", vDsLstNaoSeguro
		putitem/id viParams, "DS_LSTSEGURO",  vDsLstSeguro
		activate "FCRSVCO119".gravaRelacFatSeguro($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)                      
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	endif
	;
	
	if ($empty("TMP_K02NR10") = 0) ;Gravar os cartões(Crédito/Débito)
		setocc "TMP_K02NR10", 1
		while ($status >= 0)
			viParams = ""
			putitem/id viParams, "NR_PORTADOR"  , NR_CHAVE01.TMP_K02NR10
			putitem/id viParams, "DS_LSTFATURA" , DS_LSTFATURA.TMP_K02NR10
			putitem/id viParams, "CD_COMPONENTE", $componentname
			putitem/id viParams, "CD_CARTAO"    , $cdCartao$
			;Projeto 133 - Tarefa 119 - Aloisio Gargantini - 06/10/2009
			putitem/id viParams, "NR_SEQCARTAO" , $nrSeqCartao$
			;
			;MTF(02/10/2006) - Projeto 078, tarefa 038.
			;Este flag tem finalidade para qdo o usuario for pagar com cartao de credito e o mesmo tem convenio,
			;os vencimentos das parcelas serao geradas de acordo com o dia de vencimento do convenio. Como outros
			;programas usam esta rotina e somente o vencimento de convenio sera gerado no faturamento houve a
			;necessidade de colocar este flag.
			putitem/id viParams, "IN_FATURAMENTO", <TRUE>
			;
			;Projeto 078 - Tarefa 2398 - Aloisio Gargantini - 24/06/2009
			putitem/id viParams, "CD_AUTORIZACAO", $item("CD_AUTORIZACAO", ds_adicional.sis_valor)
			;
			putitem/id viParams, "NR_NSU",         $item("NR_NSU", ds_adicional.sis_valor) ;-=CANONICO=- (18/03/2011) TAR 541 PRJ 156 - Baixa de cartão com TEF

			newinstance "FCRSVCO005", "FCRSVCO005", ""
			activate "FCRSVCO005".geraCartao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			deleteinstance "FCRSVCO005"
			vDsLstCartao = $item("DS_LSTFATURA", voParams)
			if (vDsLstCartao = "")
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma fatura de cartão retornada pela serviço de gravação!", "")
				return(-1)
			endif
			repeat
				getitem vDsRegistro, vDsLstCartao, 1 ;Monta a lista com as faturas p/ gravar a liquidação
				putitem/id vDsRegistro, "NR_CTAPESCX",      $nrCtaUsuario$
				putitem/id vDsRegistro, "NR_SEQHISTRELSUB", NR_SEQHISTRELSUB.TMP_K02NR10
				putitem vDsLstFatura, -1, vDsRegistro
				delitem vDsLstCartao, 1
			until (vDsLstCartao = "")    
			
			setocc "TMP_K02NR10", $curocc("TMP_K02NR10") + 1
		endwhile
	endif
	
	viParams = ""
	putitem/id viParams, "CD_PESSOA",         $cdPessoa$
	putitem/id viParams, "DS_LSTTRANSACAO",   $dsLstTransacao$
	putitem/id viParams, "DS_LSTFATURA",      vDsLstFatura
	putitem/id viParams, "DS_LSTMOVCC",       vDsLstMovCC
	putitem/id viParams, "TP_CHEQUEPRESENTE", $tpChequePresente$
	activate "TRASVCO011".gravaLiqTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)    
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams = "")
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma liquidação retornada pela serviço de gravação!", "")
		return(-1)
	else
		$CdEmpLiq$ = $item("CD_EMPLIQ", voParams)
		$DtLiq$    = $item("DT_LIQ",    voParams)
		$NrSeqLiq$ = $item("NR_SEQLIQ", voParams)
	endif

	;---Elia Proj. 133/007 16/08/08
	if ($vlTotBonus$ != 0)
		viParams = ""
		putitem/id viParams, "CD_CARTAO",     $cdCartao$
		putitem/id viParams, "NR_SEQCARTAO",  $nrSeqCartao$ ;---Elia Proj. 78/1886 02/10/08
		putitem/id viParams, "VL_BONUS",      $vlTotBonus$
		putitem/id viParams, "TP_OPERACAO",   "D" ; D - Debito
		putitem/id viParams, "DT_BONUS",      $DtLiq$
		putitem/id viParams, "DT_VENCIMENTO", $DtLiq$
		putitem/id viParams, "CD_EMPLIQ",     $CdEmpLiq$
		putitem/id viParams, "DT_LIQ",        $DtLiq$
		putitem/id viParams, "NR_SEQLIQ",     $NrSeqLiq$
		activate "CTCSVCO001".gravarBonus($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)     
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif		
	endif
	;
	
	repeat ;Faz os lançamentos no conta corrente
		viValores = ""
		getitem viParams, vDsLstParamCC, 1
		putitem/id viParams, "CD_EMPLIQ",   $CdEmpLiq$
		putitem/id viParams, "DT_LIQ",      $DtLiq$
		putitem/id viParams, "NR_SEQLIQ",   $NrSeqLiq$
		putitem/id viParams, "IN_CAIXA",    <TRUE>
		putitem/id viParams, "CD_TERMINAL", $cdTerminal$
		putitem/id viParams, "DT_ABERTURA", $dtAbertura$
		putitem/id viParams, "NR_SEQCAIXA", $nrSeq$
		activate "FCCSVCO002".movimentaConta($$gParamGlb, viParams, viValores, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		delitem vDsLstParamCC, 1
	until (vDsLstParamCC = "")
	
	if (vDsLstLiqMov != "") ;Gera movimento para adiantamento de troco
		repeat
			viParams = ""
			getitem viParams, vDsLstLiqMov, 1
			putitem/id viParams, "CD_EMPLIQ", $CdEmpLiq$
			putitem/id viParams, "DT_LIQ",    $DtLiq$
			putitem/id viParams, "NR_SEQLIQ", $NrSeqLiq$
			activate "FCRSVCO007".gravaLiqMov($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			
			delitem vDsLstLiqMov, 1
		until (vDsLstLiqMov = "")
	endif
	
	if ($vlAdiantamento$ > 0) ;Faz o lançamento no CC p/ abater o valor de adiantamento 
		viValores = ""
		viParams = ""
		putitem/id viParams, "CD_EMPRESA",       CD_EMPFAT.TRA_TRANSACAO
		putitem/id viParams, "NR_CTAPES",        $nrCtaCliente$
		putitem/id viParams, "DT_MOVIMENTO",     vDtSistema
		putitem/id viParams, "CD_HISTORICO",     901
		putitem/id viParams, "TP_DOCUMENTO",     10 ;Adiantamento
		putitem/id viParams, "NR_SEQHISTRELSUB", 1
		putitem/id viParams, "VL_LANCTO",        $vlAdiantamento$
		putitem/id viParams, "IN_ESTORNO",       <FALSE>
		putitem/id viParams, "DS_DOC",           ""
		putitem/id viParams, "DS_AUX",           ""
		putitem/id viParams, "DT_CONCI",         ""
		putitem/id viParams, "CD_OPERCONCI",     ""
		putitem/id viParams, "CD_EMPLIQ",        $CdEmpLiq$
		putitem/id viParams, "DT_LIQ",           $DtLiq$
		putitem/id viParams, "NR_SEQLIQ",        $NrSeqLiq$
		activate "FCCSVCO002".movimentaConta($$gParamGlb, viParams, viValores, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	endif

	if ($vlCREDEV$ > 0) ;Faz o lançamento no CC p/ abater o valor de CREDEV
		viValores = ""
		viParams = ""
		putitem/id viParams, "CD_EMPRESA",      CD_EMPFAT.TRA_TRANSACAO
		putitem/id viParams, "NR_CTAPES",        $nrCtaCliente$
		putitem/id viParams, "DT_MOVIMENTO",     vDtSistema
		putitem/id viParams, "CD_HISTORICO",     901
		putitem/id viParams, "TP_DOCUMENTO",     20 ;CREDEV
		putitem/id viParams, "NR_SEQHISTRELSUB", 1
		putitem/id viParams, "VL_LANCTO",        $vlCREDEV$
		putitem/id viParams, "IN_ESTORNO",       <FALSE>
		putitem/id viParams, "DS_DOC",           ""
		putitem/id viParams, "DS_AUX",           ""
		putitem/id viParams, "DT_CONCI",         ""
		putitem/id viParams, "CD_OPERCONCI",     ""
		putitem/id viParams, "CD_EMPLIQ",        $CdEmpLiq$
		putitem/id viParams, "DT_LIQ",           $DtLiq$
		putitem/id viParams, "NR_SEQLIQ",        $NrSeqLiq$
		activate "FCCSVCO002".movimentaConta($$gParamGlb, viParams, viValores, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	endif
	
	setocc "SIS_VALOR", 1
	while ($status >= 0)		
		if (TP_DOCUMENTO.SIS_VALOR = 12) ;DOFNI
			viParams = ""
			putitem/id viParams, "NR_DOFNI",  NR_DOCUMENTO.SIS_VALOR
			putitem/id viParams, "CD_EMPLIQ", $CdEmpLiq$
			putitem/id viParams, "DT_LIQ",    $DtLiq$
			putitem/id viParams, "NR_SEQLIQ", $NrSeqLiq$
			activate "FCRSVCO012".baixaDofni($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status)
				$instancehandle->setStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
		;Projeto 078 - Tarefa 1486 - Aloisio Gargantini - 29/05/2008
		elseif (TP_DOCUMENTO.SIS_VALOR = 18) ;Cheque presente
			;Projeto 180 - Tarefa 0185 - Aloisio Gargantini - 02/06/2011
			if ($tpChequePresente$ = 1) ;1=Cheque presente com controle por conta corrente.
			;Projeto 180 - Tarefa 0227 - Aloisio Gargantini - 27/07/2011
			;	viParams = ""
			;	putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", DS_ADICIONAL.SIS_VALOR)
			;	putitem/id viParams, "CD_CLIENTE", $item("CD_CLIENTE", DS_ADICIONAL.SIS_VALOR)
			;	putitem/id viParams, "NR_CHEQUE" , $item("NR_CHEQUE" , DS_ADICIONAL.SIS_VALOR)
			;	putitem/id viParams, "VL_CHEQUE" , $item("VL_CHEQUE" , DS_ADICIONAL.SIS_VALOR)
			;	putitem/id viParams, "CD_EMPLIQ" , vCdEmpLiq
			;	putitem/id viParams, "DT_LIQ"    , vDtLiq
			;	putitem/id viParams, "NR_SEQLIQ" , vNrSeqLiq
			;	putitem/id viParams, "TP_LIQ"    , 3 ;Recebimento
			;	putitem/id viParams, "NR_CTAPES" , $item("NR_CTAPES" , DS_ADICIONAL.SIS_VALOR)
			;	activate "FCRSVCO068".gravarMovimentacaoCartaoPresente($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			;	if ($procerror)
			;		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			;		return(-1)
			;	elseif ($status)
			;		$instancehandle->setStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			;		return(-1)
			;	endif
			else
			;
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", DS_ADICIONAL.SIS_VALOR)
				putitem/id viParams, "CD_CLIENTE", $item("CD_CLIENTE", DS_ADICIONAL.SIS_VALOR)
				putitem/id viParams, "NR_CHEQUE" , $item("NR_CHEQUE" , DS_ADICIONAL.SIS_VALOR)
				putitem/id viParams, "CD_EMPFAT" , $item("CD_EMPRESA", DS_REGISTRO.SIS_VALOR)
				putitem/id viParams, "CD_CLIFAT" , $item("CD_CLIENTE", DS_REGISTRO.SIS_VALOR)
				putitem/id viParams, "NR_FAT"    , $item("NR_FAT"    , DS_REGISTRO.SIS_VALOR)
				putitem/id viParams, "NR_PARCELA", $item("NR_PARCELA", DS_REGISTRO.SIS_VALOR)
				putitem/id viParams, "CD_EMPLIQ" , $CdEmpLiq$
				putitem/id viParams, "DT_LIQ"    , $DtLiq$
				putitem/id viParams, "NR_SEQLIQ" , $NrSeqLiq$
				activate "FCRSVCO068".gravarUtilizacaoChequePresente($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status)
					$instancehandle->setStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
			endif
		;
		endif	
		setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
	endwhile
	
	viParams = ""
	putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
	putitem/id viParams, "TP_SITUACAO",     4 ;Atendida
	activate "TRASVCO004".alteraSituacaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	if (vDsLstClassificacao != "")
		viParams = ""    
		putitem/id viParams, "DS_LSTFATURA",        vDsLstFatura
		putitem/id viParams, "DS_LSTCLASSIFICACAO", vDsLstClassificacao
		activate "FCRSVCO001".gravaClassificacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)    
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	endif

	; --- DIONE |PRJ 156/0334| 14/06/10
	viParams = ""
	putitem/id viParams, "CD_EMPRESA",   CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "TRASVCO016".buscaDadosAdicionais($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	if($item("CD_PROPRIEDADE", voParams) > 0)
		viParams = ""    
		putitem/id viParams, "CD_PESSOA",      CD_PESSOA.TRA_TRANSACAO
		putitem/id viParams, "CD_PROPRIEDADE", $item("CD_PROPRIEDADE", voParams)
		putitem/id viParams, "DS_LSTFATURA",   vDsLstFatura
		activate "FCRSVCO090".gravarClasPropRuralFatura($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif		
	endif
	; ---
	
	vDsLstTransacao = $dsLstTransacao$
	repeat
		getitem vDsRegistro, vDsLstTransacao, 1
		
		vCdEmpresa   = $item("CD_EMPRESA",   vDsRegistro)
		vNrTransacao = $item("NR_TRANSACAO", vDsRegistro)
		vDtTransacao = $item("DT_TRANSACAO", vDsRegistro)
		
		viParams = ""
		putitem/id viParams, "CD_EMPRESA",    vCdEmpresa
		putitem/id viParams, "NR_TRANSACAO",  vNrTransacao
		putitem/id viParams, "DT_TRANSACAO",  vDtTransacao
		putitem/id viParams, "NR_PRAZOMEDIO", QT_PRAZOMEDIO.SIS_TOTAL
		putitem/id viParams, "IN_PRAZOMEDIO", <TRUE>
		activate "TRASVCO016".gravaDadosAdicionais($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif            
		
		delitem vDsLstTransacao, 1
	until (vDsLstTransacao = "")
	
	if ($inLiberaTpDocumento$ = <TRUE>)
		vDsObs   = "Recebimento com tipo documento liberado pelo usuario %%$cdUsuLib$"
		viParams = ""
		putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
		putitem/id viParams, "CD_COMPONENTE",   $componentname
		putitem/id viParams, "DS_OBSERVACAO",   vDsObs
		activate "TRASVCO016".gravaObsTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	endif
	
	;--Douglas Ferreira - [Prj/Tarefa 180/0270] - 22/09/2011
	if ($tpFechamentoRoyalty$ = 1)
		viParams = ""
		putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
		activate "ROYSVCO001".calculaRoyaltyFatura($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->setStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	endif
	;
	
	if ($inECF$    = <TRUE>)
		vVlDesconto = 0
		vInFatura   = <FALSE>
		clear/e "F_TMP_K02NR10"
		setocc "SIS_VALOR", 1
		while ($status >= 0)
			if (TP_DOCUMENTO.SIS_VALOR != 9) ;Troco
				creocc "F_TMP_K02NR10", -1
				
				if (TP_DOCUMENTO.SIS_VALOR = 1) ;Fatura
					NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
					vInFatura = <TRUE>
				elseif (TP_DOCUMENTO.SIS_VALOR = 2) | (TP_DOCUMENTO.SIS_VALOR = 15) ;Cheque / Cheque garantido (central guia)
					NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
					vInCheque = <TRUE> ;* Claudemir - Prj/Tarefa: 61/670
					if (TP_DOCUMENTO.SIS_VALOR = 15)
						NR_CHAVE01.F_TMP_K02NR10 = 2 ; vira cheque normal para a ECF
					endif
				elseif (TP_DOCUMENTO.SIS_VALOR = 3) ;Dinheiro
					if ($inUltimaPgtoCartaoTEF$ = <TRUE>)
						NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
					else
						;Tem que ficar por último por causa do troco no dinheiro
						NR_CHAVE01.F_TMP_K02NR10 = 99
					endif
				elseif (TP_DOCUMENTO.SIS_VALOR = 4) ;Cartão crédito
					if ($inUltimaPgtoCartaoTEF$ = <TRUE>)
						;na homologacao do TEF DISCADO a forma de pgto cartão deve ser a ultima
						NR_CHAVE01.F_TMP_K02NR10 = 97
					else
						if ($inAgrupaCartaoTEF$ = <TRUE>)
							NR_CHAVE01.F_TMP_K02NR10 = 97 ;agrupando para multiplos cartoes
						else
							NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
						endif	
					endif
				elseif (TP_DOCUMENTO.SIS_VALOR = 5) ;Cartao débito
					if ($inUltimaPgtoCartaoTEF$ = <TRUE>)
						;na homologacao do TEF DISCADO a forma de pgto cartão deve ser a ultima
						NR_CHAVE01.F_TMP_K02NR10 = 98
					else
						if ($inAgrupaCartaoTEF$ = <TRUE>)
							NR_CHAVE01.F_TMP_K02NR10 = 97 ;agrupando para multiplos cartoes
						else
							NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
						endif	
					endif
				elseif (TP_DOCUMENTO.SIS_VALOR = 10) ;Adiantamento
					NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
				elseif (TP_DOCUMENTO.SIS_VALOR = 11) ;Desconto
					NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
					vVlDesconto = vVlDesconto + VL_DOCUMENTO.SIS_VALOR
				elseif (TP_DOCUMENTO.SIS_VALOR = 12) ;DOFNI
					NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
				elseif (TP_DOCUMENTO.SIS_VALOR = 13) ;Vale -=CANONICO=- (15/02/2011) TAR 515 PRJ 156 "Venda tipo Vale vai imprimir na ECF Vale, antes imprimia dinheiro"
					NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
				elseif (TP_DOCUMENTO.SIS_VALOR = 14) ;Nota promissória
					NR_CHAVE01.F_TMP_K02NR10 = 1 ;Fatura
					vInFatura = <TRUE>
				elseif (TP_DOCUMENTO.SIS_VALOR = 20) ;CREDEV
					NR_CHAVE01.F_TMP_K02NR10 = TP_DOCUMENTO.SIS_VALOR
				else
					NR_CHAVE01.F_TMP_K02NR10 = 3 ;Dinheiro
				endif

				if (TP_DOCUMENTO.SIS_VALOR = 4 | TP_DOCUMENTO.SIS_VALOR = 5 | TP_DOCUMENTO.SIS_VALOR = 97 | TP_DOCUMENTO.SIS_VALOR = 98) & ($inTEF$ = <TRUE>) ;Cartão crédito/Cartão débito
					if ($inAgrupaCartaoTEF$ = <TRUE>)
						NR_CHAVE02.F_TMP_K02NR10 = 1
					else
						NR_CHAVE02.F_TMP_K02NR10 = $item("NR_TRANSACAOTEF", DS_ADICIONAL.SIS_VALOR)
					endif
				else
					NR_CHAVE02.F_TMP_K02NR10 = 1
				endif

				retrieve/o "F_TMP_K02NR10"
				if ($status = 4)
					retrieve/x "F_TMP_K02NR10"
				endif
				VL_DOCUMENTO.F_TMP_K02NR10 = VL_DOCUMENTO.F_TMP_K02NR10 + VL_DOCUMENTO.SIS_VALOR
			endif

			setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1	
		endwhile

		vDsLstFormaPgto = ""
		if ($empty("F_TMP_K02NR10") = 0)
			vDsFormaPgto = $valrep(NR_CHAVE01.F_TMP_K02NR10)	
			sort/e "F_TMP_K02NR10", "NR_CHAVE01.F_TMP_K02NR10, NR_CHAVE02.F_TMP_K02NR10"
			setocc "F_TMP_K02NR10", 1
			while ($status >= 0)
				vDsRegFormaPgto = ""
				putitem/id vDsRegFormaPgto, "DS_FORMAPGTO", $item(NR_CHAVE01.F_TMP_K02NR10, vDsFormaPgto)
				if (NR_CHAVE01.F_TMP_K02NR10 = 4 | NR_CHAVE01.F_TMP_K02NR10 = 5 | NR_CHAVE01.F_TMP_K02NR10 = 97 | NR_CHAVE01.F_TMP_K02NR10 = 98) & ($inAgrupaCartaoTEF$ = <TRUE>)
					putitem/id vDsRegFormaPgto, "DS_FORMAPGTO", "Cartao"
				endif
				putitem/id vDsRegFormaPgto, "VL_FORMAPGTO", VL_DOCUMENTO.F_TMP_K02NR10
				putitem vDsLstFormaPgto, -1 , vDsRegFormaPgto 
				setocc "F_TMP_K02NR10", $curocc("F_TMP_K02NR10") + 1	
			endwhile
		endif
		
		;Fiuza - 04/10/05 - impressao de carnê quando a forma pgto é fatura
		vDsLstFatura = ""
		vDsLstCheque = "" ;* Claudemir - Prj/Tarefa: 61/670
		;if (vInFatura = <TRUE>)
		if (vInFatura = <TRUE>) | (vInCheque = <TRUE>) ;* Claudemir - Prj/Tarefa: 61/670
			setocc "SIS_VALOR", 1
			while ($status >= 0)
				if (TP_DOCUMENTO.SIS_VALOR = 1) | (TP_DOCUMENTO.SIS_VALOR = 14) ;Fatura/Nota promissória				
					vDsRegistro = ""
					putitem/id vDsRegistro, "NR_FATURA",     NR_DOCUMENTO.SIS_VALOR
					putitem/id vDsRegistro, "NR_PARCELA",    $curocc("SIS_VALOR")
					putitem/id vDsRegistro, "DT_VENCIMENTO", DT_VENCIMENTO.SIS_VALOR
					putitem/id vDsRegistro, "VL_FATURA",     VL_DOCUMENTO.SIS_VALOR
					putitem vDsLstFatura, -1 , vDsRegistro
				endif
				;* Claudemir - Prj/Tarefa: 61/670
				;* Será impresso também quando for Cheque
				if (TP_DOCUMENTO.SIS_VALOR = 2) | (TP_DOCUMENTO.SIS_VALOR = 15) ;Cheque / Cheque garantido (central guia)
					vDsRegistro = ""
					putitem/id vDsRegistro, "CD_EMPRESA",    $item("CD_EMPRESA", DS_ADICIONAL.SIS_VALOR)
					putitem/id vDsRegistro, "CD_CLIENTE",    $item("CD_CLIENTE", DS_ADICIONAL.SIS_VALOR)
					putitem/id vDsRegistro, "NR_BANCO",      $item("NR_BANCO",   DS_ADICIONAL.SIS_VALOR)
					putitem/id vDsRegistro, "NR_AGENCIA",    $item("NR_AGENCIA", DS_ADICIONAL.SIS_VALOR)
					putitem/id vDsRegistro, "NR_CONTA",      $item("NR_CONTA",   DS_ADICIONAL.SIS_VALOR)
					putitem/id vDsRegistro, "NR_CHEQUE" ,    $item("NR_CHEQUE" , DS_ADICIONAL.SIS_VALOR)
					putitem/id vDsRegistro, "CD_EMPFAT" ,    $item("CD_EMPRESA", DS_REGISTRO.SIS_VALOR)
					putitem/id vDsRegistro, "CD_CLIFAT" ,    $item("CD_CLIENTE", DS_REGISTRO.SIS_VALOR)
					putitem/id vDsRegistro, "NR_FAT"    ,    $item("NR_FAT"    , DS_REGISTRO.SIS_VALOR)
					putitem/id vDsRegistro, "NR_PARCELA",    $item("NR_PARCELA", DS_REGISTRO.SIS_VALOR)
					putitem/id vDsRegistro, "DT_VENCIMENTO", DT_VENCIMENTO.SIS_VALOR
					putitem/id vDsRegistro, "VL_FATURA",     VL_DOCUMENTO.SIS_VALOR  
					putitem vDsLstCheque, -1 , vDsRegistro
				endif ;*
				setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
			endWhile
		endif		

		;* Claudemir - Prj/Tarefa: 102/951 - 23/09/2010
		if ($inPDVOtimizado$ = <FALSE>)
			vDsLstNF = ""
			if ($empty("FIS_NF") = 0)
				setocc "FIS_NF", 1
				while ($status >= 0)
					vDsRegistro = ""
					putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.FIS_NF
					putitem/id vDsRegistro, "NR_FATURA",	 NR_FATURA.FIS_NF
					putitem/id vDsRegistro, "DT_FATURA",	 DT_FATURA.FIS_NF
					putitem vDsLstNF, -1, vDsRegistro
					setocc "FIS_NF", $curocc("FIS_NF") + 1
				endwhile		    
				setocc "FIS_NF", 1
			endif
			viParams = ""
			putitem/id viParams, "DS_LSTNF",   vDsLstNF
			putitem/id viParams, "IN_ESTORNO", <FALSE>
			;---Elia Proj. 130/487 22/05/09
			;activate "FISSVCO004".atualizaEstoqueNF($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			activate "FISSVCO038".atualizaEstoqueNF($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			;
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif			
		endif  ;*

		vInImpressaoOK = <FALSE>
		repeat
			viParams = ""
			putitem/id viParams, "CD_EMPRESA",      CD_EMPRESA.TRA_TRANSACAO
			putitem/id viParams, "NR_TRANSACAO",    NR_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "DT_TRANSACAO",    DT_TRANSACAO.TRA_TRANSACAO		
			putitem/id viParams, "DS_LSTFORMAPGTO", vDsLstFormaPgto
			putitem/id viParams, "DS_LSTFATURAS",   vDsLstFatura
			putitem/id viParams, "VL_DESCONTO",     vVlDesconto
			putitem/id viParams, "CD_EMPECF",       $cdEmpECF$
			putitem/id viParams, "NR_ECF",          $nrECF$
			putitem/id viParams, "NR_CUPOM",        $nrCupom$
			putitem/id viParams, "IN_TEF",          $inTEF$
			putitem/id viParams, "DS_LSTCHEQUE",    vDsLstCheque
			if($cdCartao$ > 0 & $inParCartaoProprio$ = <TRUE>)
				putitem/id viParams, "IN_CARTAOPROPRIO", <TRUE>
			endif
			if($vlTotBonus$ > 0)
				putitem/id viParams, "IN_BONUS", <TRUE>
			endif
			putitem/id viParams, "IN_CONCOMITANTE", vInConcomitante ;* Claudemir - Prj/Tarefa: 26/31 - 25/11/2009
			activate "ECFSVCO010".encerraCupom($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status = -10)
				viParams = ""
				voParams = ""
				putitem/id viParams, "TITULO",   "Erro de comunicação com a ECF"
				putitem/id viParams, "MENSAGEM", $item("DESCRICAO", $xctxerro$)
				activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				endif
				if ($inTEF$ = <TRUE>)
					askmess "Impressora não responde! Tentar imprimir novamente?", "Sim, Não"
					if ($status = 2) 
						return(-1)
					endif
				else
					return(-1)
				endif
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				if ($inTEF$ = <TRUE>)
					askmess "Impressora não responde! Tentar imprimir novamente?", "Sim, Não"
					if ($status = 2) 
						return(-1)
					endif
				else
					return(-1)
				endif
			elseif ($status >= 0)
				vInImpressaoOK = <TRUE>	
				if ($NrCupom$ = 0)
					$NrCupom$ = $item("NR_CUPOM",voParams)
				endif
				$tpImpTefPAYGO$ = $item("TP_IMPTEFPAYGO",voParams) ;-=CANONICO=- (30/11/2010) TAR 995 PRJ 102 - aqui o ECFSVCO010 devolve o tipo para ser consumido no imprimiCupomTEF
			endif
		until(vInImpressaoOK = <TRUE>)
		message/hint " "
	endif
	
	vTpBonus       = $item("TP_BONUS_DESCONTO",         $xlplemp$)
	vVlBonus       = $item("VL_VD_CREDITO_BONUS_DESC",  $xlplemp$)
	$vlDisponivel$ = $item("VL_CREDITO_BONUS_DESCONTO", $xlplemp$)
	
	if (vTpBonus = 1) & (VL_TOTAL.SIS_DUMMY3 >= vVlBonus)
		viParams = ""
		putitem/id viParams, "CD_PESSOA",       CD_PESSOA.TRA_TRANSACAO
		putitem/id viParams, "TP_OPERACAO",     "C"
		putitem/id viParams, "CD_COMPONENTE",   $componentname
		putitem/id viParams, "CD_HISTORICO", 3  ;Crédito por Venda
		putitem/id viParams, "CD_EMPTRANSACAO", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO",    DT_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO",    NR_TRANSACAO.TRA_TRANSACAO
		activate "PESSVCO035".lancaBonusDesconto($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		else
			message/info "Cliente %%NM_PESSOA.SIS_PESSOA%%%, ganhou R$%%$vlDisponivel$ de bônus desconto!"
		endif
	endif
	
	if ($inTEF$ = <TRUE>)
		$instancehandle->imprimeCupomTEF()
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			-=CANONICO=- (12/07/2011) TAR 582 PRJ 156
;			;na homologação devera abortar o processo
;			if ($inUltimaPgtoCartaoTEF$ = <TRUE>)
				return(-1)
;			endif
		elseif ($status < 0)
;			-=CANONICO=- (12/07/2011) TAR 582 PRJ 156
;			;na homologação devera abortar o processo
;			if ($inUltimaPgtoCartaoTEF$ = <TRUE>)
				return(-1)
;			endif
		endif
	endif

	if ($tpImpressaoTraVenda$ = 05);imprime transacao apos recebimento direto
		putitem/id viParams, "IN_DIRETO",       <TRUE>
		putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
		activate "TRAFP004".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif    
	elseif ($tpImpressaoTraVenda$ = 06);imprimir transacao apos recebimento escolhendo job 
		putitem/id viParams, "IN_DIRETO",       <FALSE>
		putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
		activate "TRAFP004".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
	elseif ($tpImpressaoTraVenda$ = 07 | $tpImpressaoTraVenda$ = 08);imprimir transacao apos recebimento escolhendo job 
		viParams = ""
		putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
		activate "SISFP002".exec("TRAR016", vDsFiltro, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
	;;;DBB |PRJ/TAR 102/0342 | 30/06/2008
	elseif ($tpImpressaoTraVenda$ = 09);imprimir transacao impressora de 40 colunas
		viParams = ""
		putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
		activate "SISFP002".exec("TRAR017", vDsFiltro, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
	;;;
	endif

	if (vDsLstFaturaImp != "")
		if ($tpImpressaoFatVenda$ > 0)
			if ($tpImpressaoFatVenda$ != 3) | ($inFCRFP001$ = <TRUE>)
				viParams = ""
				putitem/id viParams, "DS_LISTAFATURA", vDsLstFaturaImp
				putitem/id viParams, "IN_AGRUPAR",     <TRUE>
				$keyboard = "KB_GLOBAL"
				activate "FCRFP001".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
				$keyboard = "KB_PDV"
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif
			else
				viParams = ""
				;--Douglas Ferreira - [Prj/Tarefa 180/0003] - 29/11/2010
				;putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
				putitem/id viParams, "LST_FATURA", vDsLstFaturaImp
				;
				$keyboard = "KB_GLOBAL"
				activate "FCRFP098".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
				$keyboard = "KB_PDV"
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif
			endif
		endif

		if ($cdModeloNFPromissoria$ > 0)
			vDsLstNF = ""
			if ($empty("FIS_NF") = 0)
				setocc "FIS_NF", 1
				while ($status >= 0)
					vDsRegistro = ""
					putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.FIS_NF
					putitem/id vDsRegistro, "NR_FATURA",  NR_FATURA.FIS_NF
					putitem/id vDsRegistro, "DT_FATURA",  DT_FATURA.FIS_NF
					putitem vDsLstNF, -1, vDsRegistro
					setocc "FIS_NF", $curocc("FIS_NF") + 1
				endwhile		    
				setocc "FIS_NF", 1
			endif
			viParams = ""
			putitem/id viParams, "DS_LSTNF",     vDsLstNF
			putitem/id viParams, "CD_MODELONF",  $cdModeloNFPromissoria$
			putitem/id viParams, "IN_DIRETO",    <FALSE>
			putitem/id viParams, "NR_FILASPOOL", $nrFilaSpool$
			activate "FISFP008".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
		endif
	endif

	;Quando for ECF, deve-se baixa o estoque somente após a emissão do cupom e não
	;na geração do FIS_NF como é o caso de quando for nota fiscal
	if ($inECF$ = <TRUE>)
		;* Claudemir - Prj/Tarefa: 102/951 - 23/09/2010
		if ($inPDVOtimizado$ = <TRUE>)
			vDsLstNF = ""
			if ($empty("FIS_NF") = 0)
				setocc "FIS_NF", 1
				while ($status >= 0)
					vDsRegistro = ""
					putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.FIS_NF
					putitem/id vDsRegistro, "NR_FATURA",  NR_FATURA.FIS_NF
					putitem/id vDsRegistro, "DT_FATURA",  DT_FATURA.FIS_NF
					putitem vDsLstNF, -1, vDsRegistro
					setocc "FIS_NF", $curocc("FIS_NF") + 1
				endwhile		    
				setocc "FIS_NF", 1
			endif
			viParams = ""
			putitem/id viParams, "DS_LSTNF",   vDsLstNF
			putitem/id viParams, "IN_ESTORNO", <FALSE>
			;---Elia Proj. 130/487 22/05/09
			;activate "FISSVCO004".atualizaEstoqueNF($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			activate "FISSVCO038".atualizaEstoqueNF($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			;
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			endif
		endif  ;*

		viParams = ""
		putitem/id viParams, "DS_LSTNF", vDsLstNF
		putitem/id viParams, "IN_ECF",   <TRUE>
		activate "FISSVCO004".emiteNF($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
	endif
	
	if ($CdEmpContrato$ > 0) & ($NrSeqContrato$ > 0)
		if ($InImpContratoAuto$ = <TRUE>)
			viParams = ""
			putitem/id viParams, "CD_EMPCONTRATO", $CdEmpContrato$
			putitem/id viParams, "NR_SEQCONTRATO", $NrSeqContrato$
			activate "GERSVCO034".previewContrato($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			endif
		endif
	endif	

	;>-- MAC - PRJ 102/926 - 26/08/2010 ---
	if ($tpImpRichTextVD$ = 1)
		vInFatura = <FALSE>
		setocc "SIS_VALOR", 1
		while ($status >= 0)
			if (TP_DOCUMENTO.SIS_VALOR = 1) ;Fatura
				vInFatura = <TRUE>
			elseif (TP_DOCUMENTO.SIS_VALOR = 14) ;Nota promissória
				vInFatura = <TRUE>
			endif
			setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1	
		endwhile
		
		$inFatura$ = vInFatura
	endif
	;--<
	
	return(0)
end

;----------------------
partner operation BT_04
;----------------------
	variables
		string  viParams, voParams, vDsLstParcela, vDsRegistro, vDsAdicional
		numeric vTpDocumento, vNrDocumento, vNrParcela, vNrOcc
		boolean vInCobLoja
	endvariables

	if (VL_DOCUMENTO.SIS_VALOR > 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Existe item de recebimento não definido!", "")
		return(-1)
	endif
	   
	;Fiuza - projeto imobiliaria MA -10/05/07
	viParams = ""
	putitem/id viParams, "CD_EMPTRANSACAO", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "NR_FATURAPADRAO", $nrFaturaPadrao$
	putitem/id viParams, "IN_FATURA", $inParcelaFatura$
	putitem/id viParams, "IN_CHEQUE", $inParcelaCheque$
	putitem/id viParams, "IN_NOTAPROMISSORIA", $inParcelaNotaP$
	$keyboard = "KB_GLOBAL"
	activate "TRAFM067".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif 
	
	if ($status < 0)
		return(-1)
	endif
	
	vDsLstParcela = $item("DS_LSTPARCELA", voParams)
	vTpDocumento = $item("TP_DOCUMENTO", voParams)
	vNrDocumento = $item("NR_DOCUMENTO", voParams)
	vInCobLoja = $item("IN_COBLOJA", voParams)

	vNrOcc = 0
	
	if (vDsLstParcela != "")
		;        discard "SIS_VALOR"
		repeat
			getitem vDsRegistro, vDsLstParcela, 1

			vNrParcela = $item("NR_PARCELA", vDsRegistro)
			if (vNrParcela > 1)
				creocc "SIS_VALOR", -1
			endif

			if (vNrOcc = 0)
				vNrOcc = $curocc("SIS_VALOR")
			endif

			VL_DOCUMENTO.SIS_VALOR = $item("VL_PARCELA", vDsRegistro)
			TP_DOCUMENTO.SIS_VALOR = vTpDocumento
			NR_DOCUMENTO.SIS_VALOR = vNrDocumento
			DT_VENCIMENTO.SIS_VALOR = $item("DT_VENCIMENTO", vDsRegistro)
			;* Claudemir - Prj/Tarefa: 156/209 - 02/03/2010
			;VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL + VL_DOCUMENTO.SIS_VALOR ;*	
			if (vInCobLoja = <TRUE>)
				validateocc "SIS_VALOR"
				if ($status < 0)
					return (-1)
				endif
			endif

			if (TP_DOCUMENTO.SIS_VALOR = 1) | (TP_DOCUMENTO.SIS_VALOR = 14) ;Fatura/Nota promissória
				vDsAdicional = ""
				putitem/id vDsAdicional, "IN_COBLOJA", vInCobLoja
				DS_ADICIONAL.SIS_VALOR/init = vDsAdicional

				if (vInCobLoja = <TRUE>)
					vDsAdicional = "Cobrança na loja"
				else
					vDsAdicional = ""
				endif
				DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional
			endif
			delitem vDsLstParcela, 1
		until (vDsLstParcela = "")
	endif	
	
	$instancehandle->calculaPrazoMedio()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif

	$instancehandle->calculaTotal()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif

	if (vTpDocumento = 2) ;Cheque
		setocc "SIS_VALOR", vNrOcc
	endif

	$prompt = VL_DOCUMENTO.SIS_VALOR
	
	return(0)
end

;----------------------
partner operation BT_05
;----------------------
	variables
		string  viParams, voParams, vDsLstTransacao, vDsRegistro
	endvariables
	
	viParams = ""
	putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
	if ($tpImpressaoTraVenda$ = 02)
		putitem/id viParams, "IN_DIRETO", <FALSE>
	else
		putitem/id viParams, "IN_DIRETO", <TRUE>
	endif
	activate "TRAFP004".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif    
	
	return(0)
end

;----------------------
partner operation BT_06
;----------------------
	variables
		string vDsObservacao, vDsIndice, vNrAuxiliar
		boolean vInCobLoja
		numeric vCdIndice, vNrContrato, vTpUtilizacaoContrato, vNrFatura, vTpNrContrato
	endvariables
	
;	if ($totocc("TRA_TRANSACAO") > 1)
;		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Esta opção não é permitida para recebimento de mais de uma transação ao mesmo tempo!", "")
;		return(-1)
;	endif

	;Hugo em 21/01/11 Tarefa 105-73
	;vTpUtilizacaoContrato = $item("TP_UTILIZACAO_CONTRATO", $$gParamGlb)
	vTpNrContrato = $item("TP_NR_FATURA_CONTRATO", $xlplemp$)
	;
	
	clear/e "SIS_VALOR"
	clear/e "SIS_TOTAL"
	
	if ($empty("TRA_TRANSACAO") = 0)
		setocc "TRA_TRANSACAO", 1
		while ($status >= 0)
			;Hugo em 28/02/11 Tarefa 156-532
			;;>-- MAC - PRJ 156/313 - 18/05/2010 ---
			;clear/e "FIS_NF"
			;CD_EMPRESAORI.FIS_NF/init   = CD_EMPRESA.TRA_TRANSACAO
			;NR_TRANSACAOORI.FIS_NF/init = NR_TRANSACAO.TRA_TRANSACAO
			;DT_TRANSACAOORI.FIS_NF/init = DT_TRANSACAO.TRA_TRANSACAO
			;retrieve/e "FIS_NF"
			;;--<
			clear/e "FIS_NF"
			TP_SITUACAO.FIS_NF = "N·;E"
			retrieve/e "FIS_NF"
			;
			if ($status >= 0)
				$nrFaturaPadrao$ = ""
				
				setocc "FIS_NF", 1
				while ($status >=0)
					if ($empty("FIS_NFVENCTO") != 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação %%NR_TRANSACAO.TRA_TRANSACAO sem parcelamento cadastrado!", "")
						return(-1)
					endif
					
					vNrFatura = ""
					
					if ($cdEmpContrato$ > 0) & ($nrSeqContrato$ > 0)
						vNrContrato = $item("NR_CONTRATO", $dsContrato$)
						vNrFatura = vNrContrato
					endif
					
					if (vNrFatura = 0)
						vNrFatura = NR_NF.FIS_NF
					endif

					;---Elia Proj. 102/661 14/08/09					
					if (vNrFatura = 0) & (TP_DOCTO.GER_OPERACAO = 0) ; 0 - Não definido
						vNrFatura = NR_FATURA.FIS_NF
					endif
					;

					if (vNrFatura = 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=NF da transação %%NR_TRANSACAO.TRA_TRANSACAO não foi emitida!", "")
						return(-1)
					endif
					
;					if ($nrFaturaPadrao$ = 0)
;						$nrFaturaPadrao$ = vNrFatura
;					endif
					
					setocc "FIS_NFVENCTO", 1
					while ($status >=0)	
						;Hugo em 21/01/11 Tarefa 105-73
						;if (vTpUtilizacaoContrato = 2)
						;	vNrAuxiliar = $nrFaturaPadrao$[1:5]
						;	$nrNSU6DIG$ = DT_VENCIMENTO.FIS_NFVENCTO[M]
						;	vNrAuxiliar = "%%vNrAuxiliar%%$nrNSU6DIG$[5:2]"
						;	$nrNSU6DIG$ = DT_VENCIMENTO.FIS_NFVENCTO[Y]
						;	vNrAuxiliar = "%%vNrAuxiliar%%$nrNSU6DIG$[5:2]"
						;	$nrFaturaPadrao$ = vNrAuxiliar
						;endif
						
						if ($cdEmpContrato$ > 0) & ($nrSeqContrato$ > 0)
							if (vTpNrContrato = 0)
								vNrAuxiliar = $item("NR_CONTRATO", $dsContrato$)
							elseif (vTpNrContrato = 1)
								vNrAuxiliar = NR_NF.FIS_NF
							elseif (vTpNrContrato = 2)
								vNrAuxiliar = $item("NR_CONTRATO", $dsContrato$)
								vNrAuxiliar = vNrAuxiliar[1:5]
								vNrAuxiliar = "%%vNrAuxiliar%%DT_VENCIMENTO.FIS_NFVENCTO[5:2]"
								vNrAuxiliar = "%%vNrAuxiliar%%DT_VENCIMENTO.FIS_NFVENCTO[3:2]"
							endif
						else
							vNrAuxiliar = vNrFatura
						endif

						if ($nrFaturaPadrao$ = 0)
							$nrFaturaPadrao$ = vNrAuxiliar
						endif
						;
						
						creocc "SIS_VALOR", -1
						VL_DOCUMENTO.SIS_VALOR/init = VL_PARCELA.FIS_NFVENCTO
						TP_DOCUMENTO.SIS_VALOR/init = 1 ;Fatura
						NR_DOCUMENTO.SIS_VALOR/init = vNrAuxiliar ;vNrFatura
						DT_VENCIMENTO.SIS_VALOR/init = DT_VENCIMENTO.FIS_NFVENCTO
						VL_DOCUMENTO.SIS_TOTAL/init = VL_DOCUMENTO.SIS_TOTAL + VL_DOCUMENTO.SIS_VALOR
						
						vCdIndice = $item("CD_INDICE", $DsContrato$)
						vDsIndice = $item("CD_INDICE", $DsContrato$)
						
						if ($CdEmpContrato$ > 0) & ($NrSeqContrato$ > 0) & (vCdIndice > 0)
							if (TP_FORMAPGTO.FIS_NFVENCTO = 16) ;Cobrança em loja - Fiuza/Elia prj 22 tar 557 - 07/05/08
								vInCobLoja = <TRUE>
								vDsObservacao = ""
								putitem/id vDsObservacao, "IN_COBLOJA", vInCobLoja
								DS_ADICIONAL.SIS_VALOR/init = vDsObservacao
								if (vInCobLoja = <TRUE>)
									vDsObservacao = "Cobrança na loja%%^"
									addmonths -12, DT_VENCIMENTO.FIS_NFVENCTO
									$Data$ = $result
									putitem/id DS_ADICIONAL.SIS_VALOR, "CD_INDICE", vCdIndice
									putitem/id DS_ADICIONAL.SIS_VALOR, "DT_CORRECAO", $Data$
									vDsObservacao = "%%vDsObservacao Dt.base Correcao: %%$Data$%%^ Índice : %%vCdIndice %%vDsIndice"
								else
									vDsObservacao = ""
								endif
								DS_OBSERVACAO.SIS_VALOR/init = vDsObservacao
							elseif (TP_FORMAPGTO.FIS_NFVENCTO = 17) ;Cobrança em loja - Fiuza/Elia prj 22 tar 557 - 07/05/08
								vInCobLoja = <TRUE>
								vDsObservacao = ""
								putitem/id vDsObservacao, "IN_COBLOJA", vInCobLoja
								putitem/id vDsObservacao, "IN_AGRECEBIMENTO", <TRUE>
								DS_ADICIONAL.SIS_VALOR/init = vDsObservacao
								if (vInCobLoja = <TRUE>)
									vDsObservacao = "Cobrança na loja - Aguardando recebimento%%^"
									addmonths -12, DT_VENCIMENTO.FIS_NFVENCTO
									$Data$ = $result
									putitem/id DS_ADICIONAL.SIS_VALOR, "CD_INDICE", vCdIndice
									putitem/id DS_ADICIONAL.SIS_VALOR, "DT_CORRECAO", $Data$
									vDsObservacao = "%%vDsObservacao Dt.base Correcao: %%$Data$%%^ Índice : %%vCdIndice %%vDsIndice"
								else
									vDsObservacao = ""
								endif
								DS_OBSERVACAO.SIS_VALOR/init = vDsObservacao
							else
								addmonths -12, DT_VENCIMENTO.FIS_NFVENCTO
								$Data$ = $result
								putitem/id DS_ADICIONAL.SIS_VALOR, "CD_INDICE", vCdIndice
								putitem/id DS_ADICIONAL.SIS_VALOR, "DT_CORRECAO", $Data$
								vDsObservacao = "Dt.base Correcao: %%$Data$%%^ Índice : %%vCdIndice %%vDsIndice"
								DS_OBSERVACAO.SIS_VALOR = vDsObservacao
							endif
						endif
						setocc "FIS_NFVENCTO" , $curocc("FIS_NFVENCTO") + 1
					endwhile
					setocc "FIS_NF" , $curocc("FIS_NF") + 1
				endwhile
			endif
			setocc "TRA_TRANSACAO", $curocc("TRA_TRANSACAO") + 1
		endwhile
	endif
;	
	$instancehandle->calculaPrazoMedio()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif

	$instancehandle->calculaTotal()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	
	setocc "TRA_TRANSACAO", 1	
	
	return(0)
end

;----------------------
partner operation BT_07
;----------------------
	variables
		boolean vInDescontoPromocional
	endvariables

	$instancehandle->validaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	if ($status < 0)
		setocc "SIS_VALOR", 1
		$prompt = VL_DOCUMENTO.SIS_VALOR
		return(-1)
	endif
	$instancehandle->validaRecebimento()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	if ($status < 0)
		setocc "SIS_VALOR", 1
		$prompt = VL_DOCUMENTO.SIS_VALOR
		return(-1)
	endif
	
	vInDescontoPromocional = <TRUE>	
	;Cupom não concomitante
	if (TP_DOCTO.GER_OPERACAO = 2)
		if($inDesF7$ = <TRUE>)
			vInDescontoPromocional = <FALSE>
		;* Claudemir - Prj/Tarefa: 102/809 - 03/03/2010

		elseif($inPDVOtimizado$ = <TRUE>) & ($inTEF$ = <TRUE>)
				vInDescontoPromocional = <FALSE>	
		elseif ($vInTefCartao$ = <TRUE>) ;Identifico se o recebimento é em TEF ou Cartao credito ou Cartao debito
			if ($vInDescPromocionalCartao$ = 01)
				vInDescontoPromocional = <TRUE>	
			else
				vInDescontoPromocional = <FALSE>
			endif
		endif ;*
	endif

	if (vInDescontoPromocional = <TRUE>)
		$instancehandle->descontoPromocional()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif
		if ($status < 0)
			$inErroRecebimento$ = <TRUE>
			macro "^QUIT"		
		endif
		$instancehandle->carregaTransacao()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif
		if ($status < 0)
			$inErroRecebimento$ = <TRUE>
			macro "^QUIT"		
		endif
		$instancehandle->carregaCaixa()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif
		if ($status < 0)
			$inErroRecebimento$ = <TRUE>
			macro "^QUIT"
		endif	
	endif

	$instancehandle->gravaRecebimento()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	if ($status = -2)
		if (VL_TROCO.SIS_DUMMY3 > 0)
			setocc "SIS_VALOR", 1 ;Remove o troco
			if (TP_DOCUMENTO.SIS_VALOR = 9) ;Troco
				discard "SIS_VALOR"
			endif
		endif
		setocc "SIS_VALOR", 1
		$prompt = VL_DOCUMENTO.SIS_VALOR
		return(-1)
	elseif ($status = -3)
		macro "^CLEAR"
		return(-1)
	endif

	if ($status < 0)
		$inErroRecebimento$ = <TRUE>
		macro "^QUIT"
	endif
	
	macro "^ACCEPT"
	
	return(0)
end

;----------------------
partner operation BT_08
;----------------------
	variables
		numeric vNrSeqTransacaoTef
	endvariables

	if ($tpSimuladorFat$ = 1)
		return(-1)
	endif

	if ($inTroca$ = <TRUE>)
		if (TP_DOCUMENTO.SIS_VALOR = 20) ;CREDEV
			return(-1)
		endif
	endif

	$vlAnterior$ = VL_DOCUMENTO.SIS_VALOR

	if (VL_DOCUMENTO.SIS_VALOR > 0)
		if (TP_DOCUMENTO.SIS_VALOR = 12) ;DOFNI
			creocc "FCR_DOFNI", -1
			NR_DOFNI.FCR_DOFNI/init = NR_DOCUMENTO.SIS_VALOR
			retrieve/o "FCR_DOFNI"
			if ($status = 4)
				discard "FCR_DOFNI"
			else
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=DOFNI %%NR_DOCUMENTO.SIS_VALOR não encontrado!", "")
				return(-1)
			endif
		endif
		
		if ($inTEF$ = <TRUE>)
			;Fiuza 13/09/06 - TEF DISCADO
			;em caso de múltiplos cartões, quando já foi passado e aprovado um cartão esse mesmo
			;não deve ser excluído visto que já foi autorizado pela operadora embora ainda não confirmado
			;mas deve permanecer na forma de pgto e o cliente optar para pagar o restante do valor com outra forma
			;de pgto.
			vNrSeqTransacaoTef = $item("NR_TRANSACAOTEF",DS_ADICIONAL.SIS_VALOR)
			if (vNrSeqTransacaoTef = "")
				vNrSeqTransacaoTef = 0
			endif	
			if (vNrSeqTransacaoTef > 0)
				return(-1)
			endif
			;-----------------------------------------------------------------------------------------------------
		endif

		askmess "Deseja realmente remover o registro?","Remover,Cancelar"
		if ($status = 1) 
			remocc "SIS_VALOR"
		else
			return (-1)
		endif
	else
		remocc "SIS_VALOR"
	endif

	VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL - $vlAnterior$

	$instancehandle->calculaPrazoMedio()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif

	$instancehandle->calculaTotal()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif

	return(0)
end

;----------------------
partner operation BT_09
;----------------------
	variables
		string viParams, voParams, vDsLstCheque, vDsRegistro, vDsLstFatura, vDsAdicional
		boolean vInChequeBanda, vInLiberaTpDocumento
		numeric vPosOcc
	endvariables

	;Fiuza - projeto imobiliaria MA -10/05/07
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "IN_ECF", $inECF$ ;-=CANONICO=- (08/07/2009) TAR/567/PRJ/102 -Utilizado para alterar o CPF/CNPJ da pessoa
	if ($empty("SIS_VALOR") = 0)
		vDsLstFatura = ""
		vPosOcc = $curocc("SIS_VALOR")
		setocc "SIS_VALOR", 1
		while ($status >= 0)
			if (TP_DOCUMENTO.SIS_VALOR = 1)
				putitem/id DS_ADICIONAL.SIS_VALOR, "NR_POSOCC", $curocc("SIS_VALOR")
				vDsRegistro = ""
				putlistitems/occ vDsRegistro, "SIS_VALOR" 
				putitem vDsLstFatura, -1, vDsRegistro
			endif
			setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
		endwhile
		setocc "SIS_VALOR", vPosOcc
		putitem/id viParams, "DS_LSTFATURA", vDsLstFatura
	endif
	;-----------------------------

	if ($empty("SIS_VALOR") != 0)
		putitem/id viParams, "DS_LSTTPDOCUMENTO", $dsLstTpDocumento$
	endif
	$keyboard = "KB_GLOBAL"
	activate "TRAFP012".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif	

	if ($status < 0)
		return(-1)
	endif

	if ($item("IN_DESCPROMOCAO", voParams) = <TRUE> & $item("IN_IMPRIMI_ECF_NFP", $xlplemp$) = 1)
		$indesF7$ = <TRUE>
	endif

	vInChequeBanda = $item("IN_CHEQUEBANDA", voParams)
	vInLiberaTpDocumento = $item("IN_LIBERATPDOCUMENTO", voParams)

	if (vInChequeBanda = <TRUE>)
		vDsLstCheque = $item("DS_LSTCHEQUE", voParams)
		$instancehandle->incluiChequeBanda(vDsLstCheque)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif	
	elseif (vInLiberaTpDocumento = <TRUE>)
		$inLiberaTpDocumento$ = <TRUE>
		$dsLstTpDocumento$ = $item("DS_LSTTPDOCUMENTO", voParams)
		$cdUsuLib$ = $item("CD_USULIB", voParams)
		$instancehandle->carregaTipoDocumento()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif	
	endif	

	;Fiuza - projeto imobiliaria MA -10/05/07
	vDsLstFatura = ""
	vDsLstFatura = $item("DS_LSTFATURA", voParams)
	if (vDsLstFatura != "")
		vPosOcc = $curocc("SIS_VALOR")
		setocc "SIS_VALOR", 1
		while ($status >= 0)
			if (TP_DOCUMENTO.SIS_VALOR = 1)
				repeat
					vDsRegistro = ""
					getitem vDsRegistro, vDsLstFatura, 1
					vDsAdicional = ""
					vDsAdicional = $item("DS_ADICIONAL",vDsRegistro)
					if ($item("NR_POSOCC",vDsAdicional) = $curocc("SIS_VALOR"))
						getlistitems/occ vDsRegistro, "SIS_VALOR"
						validateocc "SIS_VALOR"
						if ($status < 0)
							return (-1)
						endif
						DS_ADICIONAL.SIS_VALOR/init =  $item("DS_ADICIONAL",vDsRegistro)
						DS_OBSERVACAO.SIS_VALOR/init = $item("DS_OBSERVACAO",vDsRegistro)
						delitem/id DS_ADICIONAL.SIS_VALOR, "NR_POSOCC"
					endif

					delitem vDsLstFatura, 1
				until (vDsLstFatura = "")
				vDsLstFatura = $item("DS_LSTFATURA", voParams)
			endif
			setocc "SIS_VALOR", $curocc("SIS_VALOR") + 1
		endwhile
		setocc "SIS_VALOR", vPosOcc	
	endif
	;-----------------------------

	$prompt = VL_DOCUMENTO.SIS_VALOR
	
	return(0)
end

;----------------------
partner operation BT_03
;----------------------
	variables
		string viParams, voParams, vDsLstValor, vDsRegistro
		numeric vVlRecebido
	endvariables
	
	vDsLstValor = ""
	
	vDsRegistro = ""
	putitem/id vDsRegistro, "DS_VALOR", "Valor troco"
	putitem/id vDsRegistro, "VL_VALOR", VL_TROCO.SIS_DUMMY3
	putitem vDsLstValor, -1, vDsRegistro
	
	vDsRegistro = ""
	putitem/id vDsRegistro, "DS_VALOR", "Valor restante"
	putitem/id vDsRegistro, "VL_VALOR", VL_RESTANTE.SIS_DUMMY3
	putitem vDsLstValor, -1, vDsRegistro
	
	vDsRegistro = ""
	putitem/id vDsRegistro, "DS_VALOR", "Valor venda"
	putitem/id vDsRegistro, "VL_VALOR", VL_TOTAL.SIS_DUMMY3
	putitem vDsLstValor, -1, vDsRegistro
	
	vVlRecebido = VL_TOTAL.SIS_DUMMY3 + VL_TROCO.SIS_DUMMY3 - VL_RESTANTE.SIS_DUMMY3
	
	vDsRegistro = ""
	putitem/id vDsRegistro, "DS_VALOR", "Valor recebido"
	putitem/id vDsRegistro, "VL_VALOR", vVlRecebido
	putitem vDsLstValor, -1, vDsRegistro
	
	viParams = ""
	putitem/id viParams, "DT_COTACAO", $item("DT_SISTEMA", $$gParamGlb)
	putitem/id viParams, "DS_LSTVALOR", vDsLstValor
	$keyboard = "KB_GLOBAL"
	activate "GERFL069".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif	
	if ($status < 0)
		return(-1)
	endif
	
	return(0)
end

;------------------------
partner operation CTRL_09
;------------------------
	variables
		string viParams, voParams, vDsLstCheque, vDsRegistro, vDsLstFatura, vDsAdicional, vDsLstTransacao
		boolean vInChequeBanda, vInLiberaTpDocumento
		numeric vPosOcc, vCdEmpresa, vNrTransacao
		date vDtTransacao
	endvariables
	
	viParams = ""
	putitem/id viParams, "DS_LSTTRANSACAO", $dsLstTransacao$
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	$keyboard = "KB_GLOBAL"
	activate "TRAFP039".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif	
	if ($status < 0)
		return(-1)
	endif
	
	$cdPessoa$ = 0
	
	clear/e "TRA_TRANSACAO"
	vDsLstTransacao = $dsLstTransacao$
	repeat
		getitem vDsRegistro, vDsLstTransacao, 1
		
		vCdEmpresa = $item("CD_EMPRESA", vDsRegistro)
		vNrTransacao = $item("NR_TRANSACAO", vDsRegistro)
		vDtTransacao = $item("DT_TRANSACAO", vDsRegistro)
		
		creocc "TRA_TRANSACAO", -1
		CD_EMPRESA.TRA_TRANSACAO/init = vCdEmpresa
		NR_TRANSACAO.TRA_TRANSACAO/init = vNrTransacao
		DT_TRANSACAO.TRA_TRANSACAO/init = vDtTransacao
		retrieve/o "TRA_TRANSACAO"
		if ($status = -7)
			retrieve/x "TRA_TRANSACAO"
		endif
		
		if ($cdPessoa$ = 0)
			$cdPessoa$ = CD_PESSOA.TRA_TRANSACAO
		endif
		
		delitem vDsLstTransacao, 1
	until (vDsLstTransacao = "")
	
;oda	clear/e "PES_PESSOA"
;	CD_PESSOA.PES_PESSOA/init = $cdPessoa$
;	retrieve/e "PES_PESSOA"
;	if ($status < 0)
;		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa %%$cdPessoa$ não cadastrada!", "")
;		return(-1) 
;	endif
	
	$prompt = VL_DOCUMENTO.SIS_VALOR
	
	return(0)
end

;----------------------
partner operation BT_11
;----------------------
	variables
		string vDsLstTransacao, vDsLstNF, vDsRegistro, viParams, voParams
	endvariables
	
	;* Claudemir - Prj/Tarefa: 102/756
	if ( $item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		$hrTotal$ = $hrInicio$
		putmess "TRAFM066: BT_11 - Inicio F11 : %%$hrInicio$"
	endif ;*

	;impressao TEF - quando teclava-se F7 encerrava o TEF e voltava para o TRAFM066
	; e teclava F11 estava com problema na impressao	
	$tpImpressaoTEF$ = $item("TP_IMPRESSAO_TEF", $xlplemp$)

	$instancehandle->validaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	if ($status < 0)
		setocc "SIS_VALOR", 1
		$prompt = VL_DOCUMENTO.SIS_VALOR
		return(-1)
	endif
	
	if ($inFinanceiro$ = <TRUE>) & (VL_TOTAL.SIS_DUMMY3 = 0)
		vDsLstTransacao = ""
		vDsRegistro = ""
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem vDsLstTransacao, -1, vDsRegistro
		viParams = ""
		putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
		putitem/id viParams, "TP_SITUACAO", 4 ;Atendida
		putitem/id viParams, "CD_COMPONENTE", $componentname
		activate "TRASVCO004".alteraSituacaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		
		macro "^ACCEPT"
	endif
	
	$instancehandle->validaRecebimento()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	if ($status < 0)
		setocc "SIS_VALOR", 1
		$prompt = VL_DOCUMENTO.SIS_VALOR
		return(-1)
	endif

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrInicio$ = $clock
		putmess "TRAFM066: BT_11 - Inicio grava recebimento : %%$hrInicio$"
	endif ;*
	$instancehandle->gravaRecebimento()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
	endif
	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		putmess "TRAFM066: BT_11 - Fim grava recebimento : %%$hrInicio$"
	endif ;*

	if ($status = -2)
		if (VL_TROCO.SIS_DUMMY3 > 0)
			setocc "SIS_VALOR", 1 ;Remove o troco
			if (TP_DOCUMENTO.SIS_VALOR = 9) ;Troco
				discard "SIS_VALOR"
			endif
		endif
		setocc "SIS_VALOR", 1
		$prompt = VL_DOCUMENTO.SIS_VALOR
		return(-1)
	elseif ($status = -3)
		macro "^CLEAR"
		return(-1)
	endif
	
	if ($status < 0)
		$inErroRecebimento$ = <TRUE>
		macro "^QUIT"
	endif

	;-- MAD [Proj/Tar.149/101] - 30/11/2010
	$instancehandle->geraNFe()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	elseif ($status < 0)
		setocc "SIS_VALOR", 1
		$prompt = VL_DOCUMENTO.SIS_VALOR
		return(-1)
	endif
	;;

	;-=CANONICO=- TAR 26 - PRJ 183 (10/03/2011)
	$instancehandle->imprimirCupomPresente(CD_EMPRESA.TRA_TRANSACAO,NR_TRANSACAO.TRA_TRANSACAO,DT_TRANSACAO.TRA_TRANSACAO,$nrCupom$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	elseif ($status < 0)
		setocc "SIS_VALOR", 1
		$prompt = VL_DOCUMENTO.SIS_VALOR
		return(-1)
	endif

	;* Claudemir - Prj/Tarefa: 102/756
	if ($item("IN_LOG_TEMPO_VENDA", $$gParamGlb) = 1)
		$hrFim$ = $clock
		$hrTotal$ = $hrFim$ - $hrTotal$
		putmess "TRAFM066: BT_11 - Fim F11: %%$hrFim$ tempo total %%$hrTotal$"
	endif ;*
	
	macro "^ACCEPT"
	
	return(0)
end

;----------------------
partner operation BT_12
;----------------------
	variables
		string viParams, voParams, vDsAdicional, vDsBanda, vDsRegistro, vDsLstParcela 
		string vNrTelefone, vCpfCnpj, vDsLstDOFNI, vDsConta
		numeric vNrBanco, vNrAgencia, vNrCheque, vNrParcela, vCdCliente, vCdEmpresa, vVlSoma, vNrDocumentoChequePresente
		numeric vNrSeqHistRelSub, vNrDocumento, vNrDOFNI, vTpDocumento, vVlCheque, vCdAutorizacao
		date vDtVencimento, vDtCheque
		boolean vInCobLoja, vInTerceiro
	endvariables
	
	if (TP_DOCUMENTO.SIS_VALOR = 1) | (TP_DOCUMENTO.SIS_VALOR = 14) ;Fatura/Nota promissória
		vInCobLoja = $item("IN_COBLOJA", DS_ADICIONAL.SIS_VALOR)

		viParams = ""    
		putitem/id viParams, "IN_COBLOJA", vInCobLoja
		$keyboard = "KB_GLOBAL"
		activate "FGRFM007".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif 
		
		if ($status < 0)
			return(-1)
		endif

		vInCobLoja = $item("IN_COBLOJA", voParams)

		vDsAdicional = ""
		putitem/id vDsAdicional, "IN_COBLOJA", vInCobLoja
		DS_ADICIONAL.SIS_VALOR/init = vDsAdicional

		if (vInCobLoja = <TRUE>)
			vDsAdicional = "Cobrança na loja"
		else
			vDsAdicional = ""
		endif
		DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional

	elseif (TP_DOCUMENTO.SIS_VALOR = 2) | (TP_DOCUMENTO.SIS_VALOR = 15) | ($tpTEF$ = 2 & TP_DOCUMENTO.SIS_VALOR = 8) ;Cheque / Cheque garantido /Cheque TEF
		vNrBanco = $item("NR_BANCO", DS_ADICIONAL.SIS_VALOR)
		vNrAgencia = $item("NR_AGENCIA", DS_ADICIONAL.SIS_VALOR)
		vDsConta = $item("NR_CONTA", DS_ADICIONAL.SIS_VALOR)
		vNrCheque = $item("NR_CHEQUE", DS_ADICIONAL.SIS_VALOR)
		vDsBanda = $item("NR_BANDA", DS_ADICIONAL.SIS_VALOR)
		vCpfCnpj = $item("NR_CPFCNPJ", DS_ADICIONAL.SIS_VALOR)
		vNrTelefone = $item("NR_TELEFONE", DS_ADICIONAL.SIS_VALOR)
		;MTF(30/08/2006) - Projeto 078, tarefa 028.
		vInTerceiro = $item("IN_TERCEIRO", ds_adicional.sis_valor)
		;
		
		viParams = ""    
		putitem/id viParams, "CD_CLIENTE", CD_PESSOA.TRA_TRANSACAO
		putitem/id viParams, "VL_CHEQUE", VL_DOCUMENTO.SIS_VALOR
		putitem/id viParams, "NR_BANCO", vNrBanco
		putitem/id viParams, "NR_AGENCIA", vNrAgencia
		putitem/id viParams, "NR_CONTA", vDsConta
		putitem/id viParams, "NR_CHEQUE", vNrCheque
		putitem/id viParams, "NR_BANDA", vDsBanda
		putitem/id viParams, "DT_VENCIMENTO", DT_VENCIMENTO.SIS_VALOR
		putitem/id viParams, "NR_CPFCNPJ", vCpfCnpj
		putitem/id viParams, "NR_TELEFONE", vNrTelefone
;		if (VL_RESTANTE.SIS_DUMMY3 = 0)
			putitem/id viParams, "NR_ULTIMOBANCO", $nrUltimoBanco$
			putitem/id viParams, "NR_ULTIMAAGENCIA", $nrUltimaAgencia$
			putitem/id viParams, "DS_ULTIMACONTA", $dsUltimaConta$
			putitem/id viParams, "NR_ULTIMOCHEQUE", $nrUltimoCheque$
;		endif
		;MTF(30/08/2006) - Projeto 078, tarefa 028.
		putitem/id viParams, "IN_TERCEIRO",   vInTerceiro
		;
		;Projeto 078 - Tarefa 3162 - Aloisio Gargantini - 05/04/2010
		putitem/id viParams, "IN_VALIDACHEQUE", <TRUE>
		;
		;Projeto 078 - Tarefa 3289 - Aloisio Gargantini - 13/04/2010
		if ($inVendaChqClienteBloq$ = <TRUE>)
			putitem/id viParams, "IN_RECEBIMENTO", <TRUE>
		endif
		;
		$keyboard = "KB_GLOBAL"
		activate "FGRFM001".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif 
		
		if ($status < 0)
			return(-1)
		endif
		
		vCdCliente = $item("CD_CLIENTE", voParams)
		vNrBanco = $item("NR_BANCO", voParams)
		vNrAgencia = $item("NR_AGENCIA", voParams)
		vDsConta = $item("NR_CONTA", voParams)
		vNrCheque = $item("NR_CHEQUE", voParams)
		vDsBanda = $item("NR_BANDA", voParams)
		vDtVencimento = $item("DT_VENCIMENTO", voParams)
		vCpfCnpj = $item("NR_CPFCNPJ", voParams)
		vNrTelefone = $item("NR_TELEFONE", voParams)

		if (vNrBanco > 0)
			$nrUltimoBanco$ = vNrBanco
		endif
		if (vNrAgencia > 0)
			$nrUltimaAgencia$ = vNrAgencia
		endif
		if (vDsConta != "")
			$dsUltimaConta$ = vDsConta
		endif
		if (vNrCheque > 0)
			$nrUltimoCheque$ = vNrCheque
		endif
		;MTF(30/08/2006) - Projeto 078, tarefa 028.
		vInTerceiro = $item("IN_TERCEIRO", voParams)
		;
		
		vDsAdicional = ""
		putitem/id vDsAdicional, "CD_CLIENTE", vCdCliente
		putitem/id vDsAdicional, "NR_BANCO", vNrBanco
		putitem/id vDsAdicional, "NR_AGENCIA", vNrAgencia
		putitem/id vDsAdicional, "NR_CONTA", vDsConta
		putitem/id vDsAdicional, "NR_CHEQUE", vNrCheque
		putitem/id vDsAdicional, "NR_BANDA", vDsBanda
		putitem/id vDsAdicional, "NR_CPFCNPJ", vCpfCnpj
		putitem/id vDsAdicional, "NR_TELEFONE", vNrTelefone
		;MTF(30/08/2006) - Projeto 078, tarefa 028.
		putitem/id vDsAdicional, "IN_TERCEIRO", vInTerceiro
		;
		DS_ADICIONAL.SIS_VALOR/init = vDsAdicional
		
		vDsAdicional = "Cliente: %%vCdCliente %%%/ Banco: %%vNrBanco %%%/ Agência: %%vNrAgencia %%%/ Conta: %%vDsConta %%^%%%Nr. cheque: %%vNrCheque"    
		DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional    
		
		NR_DOCUMENTO.SIS_VALOR/init = vNrCheque
		DT_VENCIMENTO.SIS_VALOR/init = vDtVencimento

		$instancehandle->calculaPrazoMedio()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif
		
	elseif (TP_DOCUMENTO.SIS_VALOR = 4) ;Cartão de crédito
		viParams = ""    
		putitem/id viParams, "VL_DOCUMENTO", VL_DOCUMENTO.SIS_VALOR
		putitem/id viParams, "TP_ARREDONDAMENTO", 1
		putitem/id viParams, "CD_CARTAO", $cdCartao$ ;---Elia Proj. 133/87 30/10/08
		$keyboard = "KB_GLOBAL"
		activate "FGRFM003".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif 
		
		if ($status < 0)
			return(-1)
		endif
		
		vNrSeqHistRelSub = $item("NR_SEQHISTRELSUB", voParams)
		vNrDocumento = $item("NR_DOCUMENTO", voParams)
		vDsLstParcela = $item("DS_LSTPARCELA", voParams)
		;Projeto 078 - Tarefa 2398 - Aloisio Gargantini - 24/06/2009
		vCdAutorizacao   = $item("CD_AUTORIZACAO", voParams)
		;
		if (vNrSeqHistRelSub = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Sequência cartão não informada!", "")
			return(-1)
		endif
		
		clear/e "FCX_HISTRELSUB"
		TP_DOCUMENTO.FCX_HISTRELSUB/init = 4
		NR_SEQHISTRELSUB.FCX_HISTRELSUB/init = vNrSeqHistRelSub
		retrieve/e "FCX_HISTRELSUB"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Sequência cartão %%vNrSeqHistRelSub não cadastrada!", "")
			return(-1)
		endif        
		
		if (vDsLstParcela != "")
			;discard "SIS_VALOR"
			repeat
				getitem vDsRegistro, vDsLstParcela, 1
				vNrParcela = $item("NR_PARCELA", vDsRegistro)
				if (vNrParcela > 1)
					creocc "SIS_VALOR", -1
				endif
				VL_DOCUMENTO.SIS_VALOR/init = $item("VL_PARCELA", vDsRegistro)
				TP_DOCUMENTO.SIS_VALOR/init = 4
				NR_DOCUMENTO.SIS_VALOR/init = vNrDocumento
				DT_VENCIMENTO.SIS_VALOR/init = $item("DT_VENCIMENTO", vDsRegistro)
				vDsAdicional = ""
				putitem/id vDsAdicional, "NR_SEQHISTRELSUB", vNrSeqHistRelSub        
				;Projeto 078 - Tarefa 2398 - Aloisio Gargantini - 24/06/2009
				putitem/id vDsAdicional, "CD_AUTORIZACAO"  , vCdAutorizacao
				;
				DS_ADICIONAL.SIS_VALOR/init = vDsAdicional
				vDsAdicional = "Operadora: %%NR_PORTADOR.FCX_HISTRELSUB - %%DS_PORTADOR.FGR_PORTADOR / %%DS_HISTRELSUB.FCX_HISTRELSUB"        
				DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional    
				delitem vDsLstParcela, 1
			until (vDsLstParcela = "")
		endif

	elseif (TP_DOCUMENTO.SIS_VALOR >= 40000 & TP_DOCUMENTO.SIS_VALOR < 49999) ;Cartão de crédito otimizado
		vTpDocumento = TP_DOCUMENTO.SIS_VALOR
		vNrSeqHistRelSub = TP_DOCUMENTO.SIS_VALOR - 40000	

		viParams = ""    
		putitem/id viParams, "VL_DOCUMENTO", VL_DOCUMENTO.SIS_VALOR
		putitem/id viParams, "TP_ARREDONDAMENTO", 1
		putitem/id viParams, "NR_SEQHISTRELSUB", vNrSeqHistRelSub
		putitem/id viParams, "IN_DIRETO", <TRUE>
		$keyboard = "KB_GLOBAL"
		activate "FGRFM003".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif 
		
		if ($status < 0)
			return(-1)
		endif

		vNrDocumento = $item("NR_DOCUMENTO", voParams)
		vDsLstParcela = $item("DS_LSTPARCELA", voParams)
		;Projeto 078 - Tarefa 2398 - Aloisio Gargantini - 24/06/2009
		vCdAutorizacao   = $item("CD_AUTORIZACAO", voParams)
		;
		clear/e "FCX_HISTRELSUB"
		TP_DOCUMENTO.FCX_HISTRELSUB/init = 4
		NR_SEQHISTRELSUB.FCX_HISTRELSUB/init = vNrSeqHistRelSub
		retrieve/e "FCX_HISTRELSUB"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Sequência cartão %%vNrSeqHistRelSub não cadastrada!", "")
			return(-1)
		endif
		
		if (vDsLstParcela != "")
			;            discard "SIS_VALOR"
			repeat
				getitem vDsRegistro, vDsLstParcela, 1
				vNrParcela = $item("NR_PARCELA", vDsRegistro)
				if (vNrParcela > 1)
					creocc "SIS_VALOR", -1
				endif
				VL_DOCUMENTO.SIS_VALOR/init = $item("VL_PARCELA", vDsRegistro)
				TP_DOCUMENTO.SIS_VALOR/init = 4
				NR_DOCUMENTO.SIS_VALOR/init = vNrDocumento
				DT_VENCIMENTO.SIS_VALOR/init = $item("DT_VENCIMENTO", vDsRegistro)
				vDsAdicional = ""
				putitem/id vDsAdicional, "NR_SEQHISTRELSUB", vNrSeqHistRelSub        
				;Projeto 078 - Tarefa 2398 - Aloisio Gargantini - 24/06/2009
				putitem/id vDsAdicional, "CD_AUTORIZACAO"  , vCdAutorizacao
				;
				DS_ADICIONAL.SIS_VALOR/init = vDsAdicional
				vDsAdicional = "Operadora: %%NR_PORTADOR.FCX_HISTRELSUB - %%DS_PORTADOR.FGR_PORTADOR / %%DS_HISTRELSUB.FCX_HISTRELSUB"        
				DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional    
				delitem vDsLstParcela, 1
			until (vDsLstParcela = "")
		endif

	elseif (TP_DOCUMENTO.SIS_VALOR = 5) ;Cartão de débito
		vNrSeqHistRelSub = $item("NR_SEQHISTRELSUB", DS_ADICIONAL.SIS_VALOR)
		
		viParams = ""    
		putitem/id viParams, "NR_SEQHISTRELSUB", vNrSeqHistRelSub
		putitem/id viParams, "NR_DOCUMENTO", NR_DOCUMENTO.SIS_VALOR		
		$keyboard = "KB_GLOBAL"
		activate "FGRFM002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif 
		
		if ($status < 0)
			return(-1)
		endif
		
		vNrSeqHistRelSub = $item("NR_SEQHISTRELSUB", voParams)
		;Projeto 078 - Tarefa 2398 - Aloisio Gargantini - 24/06/2009
		vCdAutorizacao   = $item("CD_AUTORIZACAO", voParams)
		;
		TP_DOCUMENTO.SIS_VALOR/init = 5
		NR_DOCUMENTO.SIS_VALOR/init = $item("NR_DOCUMENTO", voParams)
		DT_VENCIMENTO.SIS_VALOR/init = $item("DT_VENCIMENTO", voParams)
		
		if (vNrSeqHistRelSub = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Sequência cartão não informada!", "")
			return(-1)
		endif

		clear/e "FCX_HISTRELSUB"
		TP_DOCUMENTO.FCX_HISTRELSUB/init = 5
		NR_SEQHISTRELSUB.FCX_HISTRELSUB/init = vNrSeqHistRelSub
		retrieve/e "FCX_HISTRELSUB"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Sequência cartão %%vNrSeqHistRelSub não cadastrada!", "")
			return(-1)
		endif
		
		vDsAdicional = ""
		putitem/id vDsAdicional, "NR_SEQHISTRELSUB", vNrSeqHistRelSub
		;Projeto 078 - Tarefa 2398 - Aloisio Gargantini - 24/06/2009
		putitem/id vDsAdicional, "CD_AUTORIZACAO"  , vCdAutorizacao
		;
		DS_ADICIONAL.SIS_VALOR/init = vDsAdicional		
		vDsAdicional = "Operadora: %%NR_PORTADOR.FCX_HISTRELSUB - %%DS_PORTADOR.FGR_PORTADOR / %%DS_HISTRELSUB.FCX_HISTRELSUB"
		DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional

	elseif (TP_DOCUMENTO.SIS_VALOR >= 50000 & TP_DOCUMENTO.SIS_VALOR < 59999) ;Cartão de débito otimizado
		vNrSeqHistRelSub = TP_DOCUMENTO.SIS_VALOR - 50000
		
		viParams = ""    
		putitem/id viParams, "NR_SEQHISTRELSUB", vNrSeqHistRelSub
		putitem/id viParams, "NR_DOCUMENTO", NR_DOCUMENTO.SIS_VALOR
		putitem/id viParams, "IN_DIRETO", <TRUE>
		$keyboard = "KB_GLOBAL"
		activate "FGRFM002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif 
		
		if ($status < 0)
			return(-1)
		endif
		
		vNrSeqHistRelSub = $item("NR_SEQHISTRELSUB", voParams)
		TP_DOCUMENTO.SIS_VALOR/init = 5
		NR_DOCUMENTO.SIS_VALOR/init = $item("NR_DOCUMENTO", voParams)
		DT_VENCIMENTO.SIS_VALOR/init = $item("DT_VENCIMENTO", voParams)
		
		if (vNrSeqHistRelSub = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Sequência cartão não informada!", "")
			return(-1)
		endif

		clear/e "FCX_HISTRELSUB"
		TP_DOCUMENTO.FCX_HISTRELSUB/init = 5
		NR_SEQHISTRELSUB.FCX_HISTRELSUB/init = vNrSeqHistRelSub
		retrieve/e "FCX_HISTRELSUB"
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Sequência cartão %%vNrSeqHistRelSub não cadastrada!", "")
			return(-1)
		endif
		
		vDsAdicional = ""
		putitem/id vDsAdicional, "NR_SEQHISTRELSUB", vNrSeqHistRelSub
		DS_ADICIONAL.SIS_VALOR/init = vDsAdicional		
		vDsAdicional = "Operadora: %%NR_PORTADOR.FCX_HISTRELSUB - %%DS_PORTADOR.FGR_PORTADOR / %%DS_HISTRELSUB.FCX_HISTRELSUB"
		DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional

	elseif (TP_DOCUMENTO.SIS_VALOR = 12) ;DOFNI
		viParams = ""
		putitem/id viParams, "IN_RECEBIMENTO", <TRUE>
		putitem/id viParams, "CD_PESSOA", $cdPessoa$;CD_PESSOA.PES_PESSOA
		setocc "FCR_DOFNI", 1
		putlistitems vDsLstDOFNI, NR_DOFNI.FCR_DOFNI
		putitem/id viParams, "DS_DOFNI", vDsLstDOFNI
		$keyboard = "KB_GLOBAL"
		activate "FCRFL011".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "ADICIONAL=  / leave field -> TP_DOCUMENTO.SIS_VALOR chamando FCRFL011")
			return(-1)
		endif

		if ($status < 0)
			return(-1)
		endif

		vNrDOFNI = $item("NR_DOFNI", voParams)

		if (vNrDOFNI = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhum DOFNI selecionado!", "")
			return(-1)
		endif

		creocc "FCR_DOFNI", -1
		NR_DOFNI.FCR_DOFNI/init = vNrDOFNI
		retrieve/o "FCR_DOFNI"
		if ($status = -7)
			retrieve/x "FCR_DOFNI"
		elseif ($status = 4)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=DOFNI %%vNrDOFNI já utilizado!", "")
			return(-1)
		endif

		VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL - VL_DOCUMENTO.SIS_VALOR
		$instancehandle->calculaTotal()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif

		VL_DOCUMENTO.SIS_VALOR = $item("VL_DOFNI", voParams)
		NR_DOCUMENTO.SIS_VALOR = $item("NR_DOFNI", voParams)
		DT_VENCIMENTO.SIS_VALOR = $item("DT_SISTEMA", $$gParamGlb)

		vDsAdicional = ""
		putitem/id vDsAdicional, "NR_DOFNI", NR_DOCUMENTO.SIS_VALOR
		DS_ADICIONAL.SIS_VALOR/init = vDsAdicional
		
		vDsAdicional = "DOFNI: %%NR_DOCUMENTO.SIS_VALOR"
		DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional

		VL_DOCUMENTO.SIS_VALOR = $abs(VL_DOCUMENTO.SIS_VALOR)
		VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL + VL_DOCUMENTO.SIS_VALOR
		$instancehandle->calculaTotal()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif

		if ($inTrocoMaximo$ = <TRUE>)
			IN_ADIANTATROCO.SIS_DUMMY3/init = <FALSE>
		else
			IN_ADIANTATROCO.SIS_DUMMY3/init = <TRUE>
		endif
	;Projeto 078 - Tarefa 1486 - Aloisio Gargantini - 29/05/2008
	elseif (TP_DOCUMENTO.SIS_VALOR = 18) ;Cheque presente
		;Projeto 180 - Tarefa 0185 - Aloisio Gargantini - 02/06/2011
		if ($tpChequePresente$ = 1) ;cartão presente com saldo em movimentação de conta corrente.
			viParams = ""    
			if (VL_DOCUMENTO.SIS_VALOR > 0)
				vVlSoma = VL_DOCUMENTO.SIS_VALOR + VL_RESTANTE.SIS_DUMMY3
				putitem/id viParams, "VL_UTILIZAR", vVlSoma
			else
				putitem/id viParams, "VL_UTILIZAR", VL_RESTANTE.SIS_DUMMY3
			endif
			$keyboard = "KB_GLOBAL"
			activate "FCRFC075".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
			$keyboard = "KB_PDV"
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif 
			VL_DOCUMENTO.SIS_VALOR = $item("VL_CHEQUE", voParams)
			VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL - VL_DOCUMENTO.SIS_VALOR
			$instancehandle->calculaTotal()
			if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
			endif
			;VL_DOCUMENTO.SIS_VALOR = ""
			fieldsyntax "VL_DOCUMENTO.SIS_VALOR", "DIM"
		else
		;
			VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL - VL_DOCUMENTO.SIS_VALOR
			$instancehandle->calculaTotal()
			if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
			endif
			VL_DOCUMENTO.SIS_VALOR = ""
			fieldsyntax "VL_DOCUMENTO.SIS_VALOR", ""

			viParams = ""    
			putitem/id viParams, "VL_DOCUMENTO", VL_DOCUMENTO.SIS_VALOR
			$keyboard = "KB_GLOBAL"
			activate "FCRFP085".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
			$keyboard = "KB_PDV"
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif 
		endif
		if ($status < 0)
			return(-1)
		endif

		vCdEmpresa = $item("CD_EMPRESA", voParams)
		if (vCdEmpresa = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Código da empresa não informada!", "")
			return(-1)
		endif
		vCdCliente = $item("CD_CLIENTE", voParams)
		if (vCdCliente = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Código do cliente não informado!", "")
			return(-1)
		endif
		vNrCheque = $item("NR_CHEQUE", voParams)
		if (vNrCheque = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Número do cheque não informado!", "")
			return(-1)
		endif
		vVlCheque = $item("VL_CHEQUE", voParams)
		if (vVlCheque = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor do cheque não informado!", "")
			return(-1)
		endif

		vDsAdicional = ""
		putitem/id vDsAdicional, "CD_EMPRESA", $item("CD_EMPRESA", voParams)
		putitem/id vDsAdicional, "CD_CLIENTE", $item("CD_CLIENTE", voParams)
		putitem/id vDsAdicional, "NR_CHEQUE" , $item("NR_CHEQUE", voParams)
		putitem/id vDsAdicional, "DT_CHEQUE" , $item("DT_CHEQUE", voParams)
		;Projeto 180 - Tarefa 0185 - Aloisio Gargantini - 02/06/2011
		putitem/id vDsAdicional, "VL_CHEQUE" , $item("VL_CHEQUE", voParams)
		putitem/id vDsAdicional, "NR_CTAPES" , $item("NR_CTAPES", voParams)
		;
		DS_ADICIONAL.SIS_VALOR/init = vDsAdicional

		TP_DOCUMENTO.SIS_VALOR/init  = 18

		; --- DIONE |156/0616| 25/08/2011
		;NR_DOCUMENTO.SIS_VALOR/init  = $item("NR_CHEQUE", voParams)
		$instancehandle->getNrDocumento(vNrDocumentoChequePresente)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)        
		endif
		NR_DOCUMENTO.SIS_VALOR/init = vNrDocumentoChequePresente
		; ---

		DT_VENCIMENTO.SIS_VALOR/init = $item("DT_CHEQUE", voParams)
		VL_DOCUMENTO.SIS_VALOR       = $item("VL_CHEQUE", voParams)
		if (VL_DOCUMENTO.SIS_VALOR > 0)
			fieldsyntax "VL_DOCUMENTO.SIS_VALOR", "DIM"
		endif
		vDsAdicional = "Cheque presente: %%vNrCheque / Cliente %%vCdCliente"

		DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional
		VL_DOCUMENTO.SIS_VALOR = $abs(VL_DOCUMENTO.SIS_VALOR)
		VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL + VL_DOCUMENTO.SIS_VALOR
		$instancehandle->calculaTotal()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif

		$instancehandle->calculaTotal()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		endif
	;
	endif

	validateocc "SIS_VALOR"
	if ($status < 0)
		return (-1)
	endif
	
	return(0)
end

;---------------------------------
partner operation carregaSimulacao
;---------------------------------
	variables
		string viParams, voParams, vDsLstFormaPgto, vDsLinha, vDsObservacao
		string vDsLstParcela, vDsAdicional, vDsRegistro, vDsAdic
		numeric vNrSeqHistRelSub, vNrDocumento, vCdAutorizacao, vVlDocumento, vNrParcela
	endvariables
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "TP_MULTIPLOCARTAO", $tpMultiploCartao$
	activate "TRASVCO017".carregaFormaPagamento($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)    
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	vDsLstFormaPgto = $item("DS_FORMAPGTO", voParams)
	$nrPrazoMedio$ = $item("NR_PRAZOMEDIO", voParams)
	
	if (vDsLstFormaPgto != "")
		repeat
			getitem vDsLinha, vDsLstFormaPgto, 1
			
			creocc "SIS_VALOR", -1
			getlistitems/occ vDsLinha, "SIS_VALOR"
			vVlDocumento = VL_DOCUMENTO.SIS_VALOR
			vDsAdic = DS_ADICIONAL.SIS_VALOR

			putitem/id DS_REGISTRO.SIS_VALOR , "CD_TIPOCLASFCR", $item("CD_TIPOCLASFCR", vDsLinha)
			putitem/id DS_REGISTRO.SIS_VALOR , "CD_CLASFCR", $item("CD_CLASFCR", vDsLinha)
			
			if ($tpMultiploCartao$ = 1) & (TP_DOCUMENTO.SIS_VALOR = 4) ;Cartao de credito
				while (vVlDocumento > 0)
					viParams = ""    
					putitem/id viParams, "VL_DOCUMENTO", VL_DOCUMENTO.SIS_VALOR
					putitem/id viParams, "TP_ARREDONDAMENTO", 1
					putitem/id viParams, "NR_PORTADOR", $item("NR_PORTADOR", DS_ADICIONAL.SIS_VALOR)
					putitem/id viParams, "NR_SEQHISTRELSUB", $item("NR_SEQHISTRELSUB", DS_ADICIONAL.SIS_VALOR)
					putitem/id viParams, "IN_SIMULADOR", <TRUE>
					$keyboard = "KB_GLOBAL"
					activate "FGRFM003".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
					$keyboard = "KB_PDV"
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status < 0)
						macro "^CLEAR"
						return(-1)
					endif
					
					vNrSeqHistRelSub = $item("NR_SEQHISTRELSUB", voParams)
					vNrDocumento = $item("NR_DOCUMENTO", voParams)
					vDsLstParcela = $item("DS_LSTPARCELA", voParams)
					vCdAutorizacao = $item("CD_AUTORIZACAO", voParams)
					
					if (vNrSeqHistRelSub = 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Sequência cartão não informada!", "")
						return(-1)
					endif
					
					clear/e "FCX_HISTRELSUB"
					TP_DOCUMENTO.FCX_HISTRELSUB/init = 4
					NR_SEQHISTRELSUB.FCX_HISTRELSUB/init = vNrSeqHistRelSub
					retrieve/e "FCX_HISTRELSUB"
					if ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Sequência cartão %%vNrSeqHistRelSub não cadastrada!", "")
						return(-1)
					endif        
					
					if (vDsLstParcela != "")
						repeat
							getitem vDsRegistro, vDsLstParcela, 1
							
							vNrParcela = $item("NR_PARCELA", vDsRegistro)
							if (vNrParcela > 1)
								creocc "SIS_VALOR", -1
							endif
							
							VL_DOCUMENTO.SIS_VALOR/init = $item("VL_PARCELA", vDsRegistro)
							TP_DOCUMENTO.SIS_VALOR/init = 4
							NR_DOCUMENTO.SIS_VALOR/init = vNrDocumento
							DT_VENCIMENTO.SIS_VALOR/init = $item("DT_VENCIMENTO", vDsRegistro)
							
							vDsAdicional = ""
							putitem/id vDsAdicional, "NR_SEQHISTRELSUB", vNrSeqHistRelSub        
							putitem/id vDsAdicional, "CD_AUTORIZACAO", vCdAutorizacao
							
							DS_ADICIONAL.SIS_VALOR/init = vDsAdicional
							vDsAdicional = "Operadora: %%NR_PORTADOR.FCX_HISTRELSUB - %%DS_PORTADOR.FGR_PORTADOR / %%DS_HISTRELSUB.FCX_HISTRELSUB"        
							DS_OBSERVACAO.SIS_VALOR/init = vDsAdicional
							
							vVlDocumento = vVlDocumento - VL_DOCUMENTO.SIS_VALOR
							VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL + VL_DOCUMENTO.SIS_VALOR
							
							delitem vDsLstParcela, 1
						until (vDsLstParcela = "")
					endif
					
					if (vVlDocumento > 0)
						creocc "SIS_VALOR", -1
						VL_DOCUMENTO.SIS_VALOR/init = vVlDocumento
						TP_DOCUMENTO.SIS_VALOR/init = 4
						DS_ADICIONAL.SIS_VALOR/init = vDsAdic
					endif
				endwhile
			else
				VL_DOCUMENTO.SIS_TOTAL = VL_DOCUMENTO.SIS_TOTAL + VL_DOCUMENTO.SIS_VALOR
				
				if ($tpSimuladorFat$ = 1)
					if (TP_DOCUMENTO.SIS_VALOR != 3) ;Dinheiro
						fieldsyntax VL_DOCUMENTO.SIS_VALOR, "NED"
					endif
					fieldsyntax TP_DOCUMENTO.SIS_VALOR, "NED"
					fieldsyntax NR_DOCUMENTO.SIS_VALOR, "NED"
					fieldsyntax DT_VENCIMENTO.SIS_VALOR, "NED"
				endif
			endif

			delitem vDsLstFormaPgto, 1
		until (vDsLstFormaPgto = "")
	endif
	
	return(0)
end

;----------------------------
partner operation validaLimite
	;----------------------------
	variables
		string viParams, voParams
		numeric vTpLiberacao
		boolean vInValidaFamiliar
	endvariables
	
	if ($dsLimiteCredito$ != "S") & ($dsLimiteCredito$ != "V")
		return(0)
	endif

	;* Claudemir - Prj/Tarefa: 156/236 - 25/03/2010
	if ($inSimuladorProduto$ = <TRUE>)
		return(0)
	endif ;*

	;--> MAC - PRJ 156/491 - 10/12/2010 ---
	if ($inSimuladorCondPgto$ = <TRUE>)
		return(0)
	endif 
	;--<
	
	if (TP_OPERACAO.TRA_TRANSACAO = "E") ;Entrada
		return(0)
	endif

	if (IN_FINANCEIRO.GER_OPERACAO = <FALSE> & TP_MODALIDADE.GER_OPERACAO != 7)
		return(0)
	endif

	if (CD_PESSOA.TRA_TRANSACAO = $cdClientePDV$)	
		return(0)
	endif

	if ($vlPrazo$ = 0)
		return(0)
	endif
	
	viParams = ""
	putitem/id viParams, "CD_GRUPOEMPRESA", CD_GRUPOEMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "TRASVCO016".consultaLiberacaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	vTpLiberacao = $item("TP_LIBERACAO", voParams)
	if (vTpLiberacao = 1) | (vTpLiberacao = 3) ;1- Limite / 3 - Limite/Atraso
		return(0)	
	endif
	
	vInValidaFamiliar = $item("IN_LIMITE_FAMILIAR_VD", $xlplemp$)
	if (vInValidaFamiliar = <TRUE>)
		vInValidaFamiliar = <FALSE>
		
		clear/e "TRA_TRANSACADIC"
		CD_EMPRESA.TRA_TRANSACADIC/init = CD_EMPRESA.TRA_TRANSACAO
		DT_TRANSACAO.TRA_TRANSACADIC/init = DT_TRANSACAO.TRA_TRANSACAO
		NR_TRANSACAO.TRA_TRANSACADIC/init = NR_TRANSACAO.TRA_TRANSACAO
		retrieve/e "TRA_TRANSACADIC"
		if ($status >= 0) & (CD_FAMILIAR.TRA_TRANSACADIC != 0)
			vInValidaFamiliar = <TRUE>
		endif
	endif
	
	viParams = ""
	putitem/id viParams, "CD_CLIENTE", CD_PESSOA.TRA_TRANSACAO
	putitem/id viParams, "IN_TOTAL", <TRUE>
	
	if (vInValidaFamiliar = <TRUE>) & (CD_FAMILIAR.TRA_TRANSACADIC != 0)
		putitem/id viParams, "CD_FAMILIAR", CD_FAMILIAR.TRA_TRANSACADIC
	else
		vInValidaFamiliar = <FALSE>
	endif
	
	activate "FCRSVCO015".buscaLimiteCliente($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	if (vInValidaFamiliar = <TRUE>)
		$vlDisponivel$ = $item("VL_SALDOFAMILIAR", voParams)
	else
		$vlDisponivel$ = $item("VL_SALDO", voParams)
	endif
	
	if ($vlPrazo$ > $vlDisponivel$)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Valor a prazo %%$vlPrazo$ maior que o valor disponível %%$vlDisponivel$%%%!", "")
		return(-1)
	endif
	
	return(0)
end

;-----------------------------------
partner operation verificaRestricao	
;-----------------------------------
	params
		string vDsComponente : IN
		string vDsCampo      : IN
		string piVlResticao  : IN
	endparams

	variables
		string viParams, voParams
	endvariables
	
	viParams = ""
	putitem/id viParams, "CD_COMPONENTE"  ,vDsComponente;COMPONENTE EM EXECUÇÃO
	putitem/id viParams, "DS_CAMPO"       ,vDsCampo                  
	putitem/id viParams, "CD_EMPRESA"     ,$item("CD_EMPRESA" ,$$gParamGlb)
	putitem/id viParams, "CD_USUARIO"     ,$item("CD_USUARIO" ,$$gParamGlb)
	;>-- MAC - PRJ 156 TAR 181 - 11/02/2010 ---	
	if (vDsCampo = "IN_LIBERA_PRAZOMEDIO")
		putitem/id viParams, "VL_VALOR"       ,""; VALOR A SER VALIDADO
	elseif (vDsCampo = "VL_DESC_MAX_FINANC")
		putitem/id viParams, "VL_VALOR"       , piVlResticao;""  ; Valor a ser validado
		putitem/id viParams, "IN_VALIDASENHA" , <False>  
	endif
	;--<
	activate "ADMSVCO009".VerificaRestricao(viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Usuário com restrição para executar processo.%%^Restrição - %%vDsCampo", "")
		return(-1)
	endif
	return (0)
End ; operation verificaRestricao	

;------------------------
partner operation efetua_NCN 
	;------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao, vInLoopImpressao
	endvariables

	viParams = ""
	putitem/id viParams, "000-000", "NCN"
	putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
	putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.F1_TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"	
	putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
	;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	if ($tpTEF$ = 2)
		putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ ;-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
	endif
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		if (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
		elseif (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO > 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
		else
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
		endif
	elseif ($tpTEF$ = 2) ;somente TEF DISCADO - Loop aguardando GP ATIVO 
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			message/hint "Aguardando comunicação..."	
			if ($tpTEF$ = 2)
				putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ ;-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
			endif
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				if (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO = 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
				;elseif (VL_TRANSACAO.F1_TEF_TRANSACAO = 0 & NR_NSU.F1_TEF_TRANSACAO > 0)
				elseif (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO > 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
				else
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Rede: %%NM_REDETEF.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			message/hint " "
		until (vInLoopConfirmacao = <TRUE>)
	endif

	return(0)
End ; operation efetua_NCN


;------------------------
partner operation efetua_CNF 
	;------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao, vInLoopImpressao
	endvariables

	viParams = ""
	putitem/id viParams, "000-000", "CNF"
	putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
	putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"	
	putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
	;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
	;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	if ($tpTEF$ = 2)
		putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ ;-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
	endif
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
	elseif ($tpTEF$ = 2)
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			message/hint "Aguardando comunicação..."	
			if ($tpTEF$ = 2)
				putitem/id viParams, "DS_CAMINHO", $vDsCaminho$ ;-=CANONICO=- (18/10/2011) TAR 25 PRJ 181
			endif
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			message/hint " "
		until (vInLoopConfirmacao = <TRUE>)			
	endif	

	return(0)

End; operation efetua_CNF

;----------------------------------------
;-- MAD [Proj/Tar.149/101] - 30/11/2010
partner operation geraNFe
;----------------------------------------

	variables
		string viParams, voParams, vDsLstNF, vDsRegistro
	endvariables

	if ($inGeraNfeAutomatic$ = 1) & ($inGeraRegC140Fin$ = 1)

		vDsLstNF = ""
		if ($empty("FIS_NF") = 0)
			setocc "FIS_NF", 1
			while ($status >= 0)
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.FIS_NF
				putitem/id vDsRegistro, "NR_FATURA" , NR_FATURA.FIS_NF
				putitem/id vDsRegistro, "DT_FATURA" , DT_FATURA.FIS_NF
				putitem vDsLstNF, -1, vDsRegistro
				setocc "FIS_NF", $curocc("FIS_NF") + 1
			endwhile
			setocc "FIS_NF", 1
		endif
	;--Douglas Ferreira - [Prj/Tarefa 180/86] - 09/02/2011
	;	if (vDsLstNF != "")
	;		viParams = ""
	;		putitem/id viParams, "DS_LSTNF", vDsLstNF
	;		putitem/id viParams, "IN_GERA_NFE_AUTOMATIC", <TRUE>
	;		activate "FISFP042".EXEC(viParams, voParams, $xCdErro$, $xCtxerro$)
	;		if ($procerror)
	;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;			return(-1)
	;		endif
	;	endif
	endif
	putitem/id $xlpo$, "DS_LSTNF", vDsLstNF
	;

	return(0)

End ;operation geraNFe

;--------------------------------------
partner operation imprimirCupomPresente
	;-----------------------------------	
	params
		numeric pCdEmpTransacao : IN	
		numeric pNrTransacao	: IN
		date pDtTransacao  : IN
		numeric pNrCupom      : IN
	endparams
	variables
		string viParams, voParams
		boolean vInRelacListaPrd 
	endvariables

	if ($inEcfCupomPresente$ = <FALSE> ) 
		return(0)
	endif
	
	viParams = ""
	putitem/id viParams, "CD_EMPTRANSACAO", pCdEmpTransacao
	putitem/id viParams, "NR_TRANSACAO", pNrTransacao
	putitem/id viParams, "DT_TRANSACAO", pDtTransacao
	activate "TRASVCO032".validaTransacaoListaPrd($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	endif
	vInRelacListaPrd = $item("IN_RELACLISTAPRD",voParams)

	if (vInRelacListaPrd = <TRUE>) 
		askmess "Deseja imprimir Cupom Presente?", "Sim,Não" 
		if($status = 1)
			viParams = ""
			putitem/id viParams, "CD_EMPTRANSACAO", pCdEmpTransacao
			putitem/id viParams, "NR_TRANSACAO", pNrTransacao
			putitem/id viParams, "DT_TRANSACAO", pDtTransacao  
			putitem/id viParams, "NR_CUPOM", pNrCupom		      
			activate "TRASVCO032".imprimeCupomPresente($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			endif
		endif
	endif

	return(0)
End;operation imprimirCupomPresente

;-------------------------------
partner operation getNrDocumento
;-------------------------------
; DIONE |156/0616| 25/08/2011
;-------------------------------
	params
		Numeric vNrSequencia : OUT
	endparams

	variables
		String viParams, voParams
	endvariables

	viParams = ""
	putitem/id viParams, "NM_ENTIDADE", "FCR_FATURAI"
	activate "GERSVCO031".getNumSeq($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	vNrSequencia =  $item("NR_SEQUENCIA", voParams)

	return(0)
End ; operation getNrDocumento