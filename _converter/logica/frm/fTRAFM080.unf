;-------------------------
entry posCLEAR 
	;-------------------------

	variables
		string viParams, voParams
	endvariables

	;* Claudemir - Prj/Tarefa: 191/2 - 07/10/2011
	if ($tpCancelaTraAndamento$ = 1)
		;>-- MAC - TAR 111 / 2010 - 03/11/2011 ---
;		clear/e "GER_OPERACAO"
;		CD_OPERACAO.GER_OPERACAO/init	= $cdOperacaoVenda$
;		retrieve/e "GER_OPERACAO"
;		if ($status >= 0)
;			if (TP_DOCTO.GER_OPERACAO = 3) ; ECF concomitante
;
;			endif
;		endif

		viParams = ""
		putitem/id viParams, "CD_OPERACAO", $cdOperacaoVenda$
		activate "GERSVCO054".dadosAdicionaisOperacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		
		if ($item("TP_DOCTO", voParams) = 3)
			$instancehandle->verificaTransacaoAberta()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			endif				
		endif
		;--<
	endif ;*

	$instancehandle->carregaDadosIniciais()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif
	
	;FIUZA - 20/12/05 - IMPRESSAO ECF CONCOMITANTE
	$InCupomAberto$ = "N"
	
;	;* Claudemir - Prj/Tarefa: 191/2 - 07/10/2011
;	if ($tpCancelaTraAndamento$ = 1)
;		clear/e "GER_OPERACAO"
;		CD_OPERACAO.GER_OPERACAO/init	= $cdOperacaoVenda$
;		retrieve/e "GER_OPERACAO"
;		if ($status >= 0)
;			if (TP_DOCTO.GER_OPERACAO = 3) ; ECF concomitante
;				$instancehandle->verificaTransacaoAberta()
;				if ($procerror)
;					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;					return(-1)
;				endif				
;			endif
;		endif
;	endif ;*

	return(0)
End ; operation posCLEAR

;------------------------
entry preEDIT 
;------------------------

	variables
		string viParams, voParams
	endvariables

	;* Claudemir - Prj/Tarefa: 191/2 - 07/10/2011
	if ($tpCancelaTraAndamento$ = 1)
		;>-- MAC - TAR 111 / 2010 - 03/11/2011 ---
;		clear/e "GER_OPERACAO"
;		CD_OPERACAO.GER_OPERACAO/init	= $cdOperacaoVenda$
;		retrieve/e "GER_OPERACAO"
;		if ($status >= 0)
;			if (TP_DOCTO.GER_OPERACAO = 3) ; ECF concomitante
;
;			endif
;		endif

		viParams = ""
		putitem/id viParams, "CD_OPERACAO", $cdOperacaoVenda$
		activate "GERSVCO054".dadosAdicionaisOperacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		
		if ($item("TP_DOCTO", voParams) = 3)
			$instancehandle->verificaTransacaoAberta()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			endif				
		endif
		;--<
	endif ;*


	if ($tpValidacaoSaldoPed$ > 0)
		$instancehandle->setStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Este componente não pode ser utilizado pois o parametro empresa TP_VALIDACAO_SALDO_PED está cadastrado como %%$tpValidacaoSaldoPed$%%%!", "")
		exit(-1)
	endif

	$instancehandle->carregaDadosIniciais()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif
	
	$instancehandle->carregaListas()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif
	
	if ($status < 0)
		exit(-1)
	endif
	
	$inMostraTotal$ = <TRUE>
	
	if ($cdOperacaoVenda$ = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação de venda não cadastrada!", "ADICIONAL=Parâmetro->CD_OPER_ECF")
		exit(-1)
	endif
	
	if ($cdOperacaoValeTroca$ = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação de vale troca não cadastrada!", "ADICIONAL=Parâmetro->CD_OPER_VALETROCA")
		exit(-1)
	endif
	
	if ($cdOperacaoTroca$ = 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Operação de vale troca não cadastrada!", "ADICIONAL=Parâmetro->CD_OPER_TROCA")
		exit(-1)
	endif
	
	;FIUZA - 20/12/05 - IMPRESSAO ECF CONCOMITANTE
	$InCupomAberto$ = "N"

	$instancehandle->efetivaTEFPendente()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	elseif ($status < 0)
		if ($tpTEF$ = 2)
			exit(-1)
		endif	
	endif

;	;* Claudemir - Prj/Tarefa: 191/2 - 07/10/2011
;	if ($tpCancelaTraAndamento$ = 1)
;;		clear/e "GER_OPERACAO"
;;		CD_OPERACAO.GER_OPERACAO/init	= $cdOperacaoVenda$
;;		retrieve/e "GER_OPERACAO"
;;		if ($status >= 0)
;;			if (TP_DOCTO.GER_OPERACAO = 3) ; ECF concomitante
;;
;;			endif
;;		endif
;
;		viParams = ""
;		putitem/id viParaMs, "CD_OPERACAO", $cdOperacaoVenda$
;		activate "TRASVCO004".gravaCapaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
;		if ($procerror)       
;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			return(-1)
;		elseif ($status < 0)
;			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;			return(-1)
;		endif
;		
;		if ($item("TP_DOCTO", voParams) = 3)
;			$instancehandle->verificaTransacaoAberta()
;			if ($procerror)
;				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;				return(-1)
;			endif				
;		endif
;	endif ;*
	
	return(0)
End ; operation preEDIT

;------------------------
entry preQUIT 
	;------------------------
	variables
		string viParams, voParams
	endvariables

	;---Elia Proj. 102/434 29/10/08
	;if ($inBloqExcluiItem$ = <TRUE>)
	if ($inBloqExcluiItem$ = 1) | ($inBloqExcluiItem$ = 3)
	;
		viParams = ""
		putitem/id viParams, "IN_USULOGADO", <TRUE>
		;putitem/id viParams, "CD_USUARIO", $item("CD_USUARIO", $$gParamGlb)
		putitem/id viParams, "DS_COMPONENTE", "TRAFM060EX"
		activate "ADMFM020".exec(viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)  
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")     
			return (-1)
		endif
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Função bloqueada!", "ADICIONAL=Parâmetro empresa->IN_BLOQ_EXCLUIR_ITEM")
			return(-1)		
		endif
	else
		if ($empty("TRA_TRANSACAO") = 0)
			askmess "Deseja realmente sair?","Sair,Cancelar"
			if ($status = 2) 
				return (-1)
			endif
		endif
	endif
	
	return(0)
End ; operation preQUIT

;---------------------
partner operation INIT  
;---------------------
	putitem/id $$gParamglb,"DS_TECLADO","KB_PDV"
	$keyboard = "KB_PDV"    
	$formtitle = "%%$componentname - Lançamento de Transação Resumido"

	;Retire o comentário das linhas abaixo para carregar os parâmetros locais
	;Parametros gerais
	$xlpl$ = ""
	putitem $xlpl$, -1, "CONDPGTO_PDV"
	putitem $xlpl$, -1, "CLIENTE_PDV"
	putitem $xlpl$, -1, "VENDEDOR_PDV"
	activate "ADMSVCO001".GetLstParametro($xlpl$, $xlpl$, $xcderro$, $xctxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	elseif ($xcdErro$)
		$instancehandle->SetErroApl($xCtxErro$, $xCdErro$, $xCtxErro$)
	endif

	$cdCondPgto$ = $item("CONDPGTO_PDV", $xlpl$)
	$cdCliente$ = $item("CLIENTE_PDV", $xlpl$)
	$cdVendedor$ = $item("VENDEDOR_PDV", $xlpl$)

	;Parametros por empresa
	$xlplemp$ = ""
	putitem $xlplemp$, -1, "CD_OPER_ECF"
	putitem $xlplemp$, -1, "CD_OPER_VALETROCA"
	putitem $xlplemp$, -1, "CD_OPER_TROCA"
	putitem $xlplemp$, -1, "IN_DADOS_ADIC_TRA_AUTO"
	putitem $xlplemp$, -1, "TP_IMPRESSAO_TRA_VD"
	putitem $xlplemp$, -1, "TP_IMPRESSAO_NF_VD"
	putitem $xlplemp$, -1, "TP_AGRUPAMENTO_ITEM_VD"
	putitem $xlplemp$, -1, "IN_CONFERENTE"
	putitem $xlplemp$, -1, "IN_PDV_OTIMIZADO"
	putitem $xlplemp$, -1, "IN_BLOQ_QTD"
	putitem $xlplemp$, -1, "LIMITE_CREDITO"
	putitem $xlplemp$, -1, "IN_BLOQ_EXCLUIR_ITEM"
	putitem $xlplemp$, -1, "TP_VALIDACAO_SALDO_PED"	
	putitem $xlplemp$, -1, "TP_CONSULTA_PRD_PDV"	;MTF(13/11/2006) - Projeto 041, tarefa 106.	
	putitem $xlplemp$, -1, "IN_MANTEM_VEND_VALETROCA" ;RAH - 24/11/2006 (Prj041/Trf112) - nao alterar vendedor no vale troca
	putitem $xlplemp$, -1, "TP_SIMULADOR_FAT"
	putitem $xlplemp$, -1, "IN_SIMULADOR_FAT_PRODUTO" ;Fiuza prj 41 tar 98 25/01/07 - bloquear desconto para item em promoção	
	putitem $xlplemp$, -1, "IN_BLOQ_DESC_ITEM_PROM"
	putitem $xlplemp$, -1, "IN_IMAGEM_PDV" ;Fiuza prj 102 tar 58 19/06/07 - validar clientes em atraso	
	putitem $xlplemp$, -1, "NR_DIA_ATRASO_BLOQ_FAT"
	putitem $xlplemp$, -1, "IN_HOMOLOGACAO_AM" ;---Elia Proj. 115/4 11/10/07
	putitem $xlplemp$, -1, "TP_LIBERACAO_TRA_VD"
	putitem $xlplemp$, -1, "QT_PECAS_DESCONTO_VL_MIN" ;---Elia Proj. 102/324 30/05/08
	putitem $xlplemp$, -1, "IN_VALIDA_PRD_VALETROCA" ;---Elia Proj. 102/337 27/06/08
	putitem $xlplemp$, -1, "IN_UTILIZA_CTC" ;---Elia Proj. 133/007 15/08/08
	putitem $xlplemp$, -1, "TP_AVISA_ANIVERSARIO"
	putitem $xlplemp$, -1, "IN_LIMITE_CREDITO_ITEM_VD"
	putitem $xlplemp$, -1, "TP_LIMITE_DESCONTO" ;<ANO Pjt102 Trf784 - 21/01/2010>
	putitem $xlplemp$, -1, "CD_OPER_TROCA_VALOR_VD"
	putitem $xlplemp$, -1, "VL_TROCA_TPVALOR_VD"
	putitem $xlplemp$, -1, "TP_VALIDACAO_CONF_TRA"
	putitem $xlplemp$, -1, "TP_VALIDA_VENEDOR_VD"
	putitem $xlplemp$, -1, "TP_VARIACAO_DESCONTO_VD"
	putitem $xlplemp$, -1, "TP_BONUS_DESCONTO"
	putitem $xlplemp$, -1, "IN_LIMITE_FAMILIAR_VD"
	putitem $xlplemp$, -1, "NR_DIAS_CARENCIA_ATRASO" ; DIONE |156/0380| 30/07/2010
	putitem $xlplemp$, -1, "IN_SIMULADOR_COND_PGTO"  ;>-- MAC - PRJ 156/383 - 12/08/2010 ---
	putitem $xlplemp$, -1, "TP_COEFICIENTE_PRD_VD" ;>-- MAC - PRJ 102/926 - 25/08/2010	
	putitem $xlplemp$, -1, "CD_MOD_RICHTEXT_VD" ;>-- MAC - PRJ 102/926 - 25/08/2010
	putitem $xlplemp$, -1, "TP_IMP_RICHTEXT_VD" ;>-- MAC - PRJ 102/926 - 25/08/2010
	putitem $xlplemp$, -1, "TP_BUSCA_VL_VALETROCA" ;>-- MAC - PRJ 156/395 - 16/09/2010 ---
	putitem $xlplemp$, -1, "IN_RESIMULACAO_FAT" ;Hugo em 30/12/2010 Tarefa 156-494
	putitem $xlplemp$, -1, "IN_MOSTRA_TROCO_RECEB" ;Hugo em 28/12/2010 Tarefa 180-32
	putitem $xlplemp$, -1, "TP_UTILIZA_ETIQ_RFID_PDV" ;-=CANONICO=- (10/06/2011) PRJ 156 TAR 570
	putitem $xlplemp$, -1, "TEF_TIPO"
	putitem $xlplemp$, -1, "TP_CONSULTA_SALDO_CREDEV" ;-=CANONICO=- (10/08/2011) TAR 111 PRJ 182
	putitem $xlplemp$, -1, "CD_MOD_IMP_RECEBTRA" ;-=CANONICO=- (11/08/2011) TAR 125 PRJ 186
	putitem $xlplemp$, -1, "TP_CANCELA_TRA_ANDAMENTO" ;* Claudemir - Prj/Tarefa: 191/2 07/010/2011
	putitem $xlplemp$, -1, "TP_UTILIZA_BOLETA" ;-- ALX - 191/11 - 11/11/2011 --;
	putitem $xlplemp$, -1, "TP_IMPRESSAO_TEF_PAYGO" ;-=CANONICO=- 30/11/2010 TAR 982 PRJ 102 - Parametro de leitura do arquivo intpos
	activate "ADMSVCO001".GetParamEmpresa($item("CD_EMPRESA", $$gParamGlb), $xlplemp$, $xlplemp$, $xcderro$, $xctxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	elseif ($xcdErro$)
		$instancehandle->SetErroApl($xCtxErro$, $xCdErro$, $xCtxErro$)
	endif
	
	$cdOperacaoVenda$				= $item("CD_OPER_ECF", $xlplemp$)
	$cdOperacaoValeTroca$		= $item("CD_OPER_VALETROCA", $xlplemp$)
	$cdOperacaoTroca$				= $item("CD_OPER_TROCA", $xlplemp$)
	$limiteCredito$				= $item("LIMITE_CREDITO" , $xlplemp$)
	$inDadosAdicionaisAuto$	= $item("IN_DADOS_ADIC_TRA_AUTO", $xlplemp$)
	$tpImpressaoTraVenda$		= $item("TP_IMPRESSAO_TRA_VD", $xlplemp$)
	$tpImpressaoNFVenda$		= $item("TP_IMPRESSAO_NF_VD", $xlplemp$)
	$tpAgrupamento$				= $item("TP_AGRUPAMENTO_ITEM_VD", $xlplemp$)
	$inConferente$					= $item("IN_CONFERENTE", $xlplemp$)
	$inBloqQtde$					= $item("IN_BLOQ_QTD",$xlplemp$)
	$inBloqExcluiItem$			= $item("IN_BLOQ_EXCLUIR_ITEM",$xlplemp$)
	$tpValidacaoSaldoPed$		= $item("TP_VALIDACAO_SALDO_PED", $xlplemp$)
	$tpConsultaPrdPdv$			= $item("TP_CONSULTA_PRD_PDV", $xlplemp$);
	$InMantVendValeTroca$		= $item("IN_MANTEM_VEND_VALETROCA", $xlplemp$) ;RAH - 24/11/2006 (Prj041/Trf112) - nao alterar vendedor no vale troca
	$tpSimuladorFat$				= $item("TP_SIMULADOR_FAT", $xlplemp$)
	$inSimuladorProduto$		= $item("IN_SIMULADOR_FAT_PRODUTO", $xlplemp$)	
	$InBloqDesItemProm$			= $item("IN_BLOQ_DESC_ITEM_PROM", $xlplemp$) ;Fiuza prj 41 tar 98 25/01/07 - bloquear desconto para item em promoção
	$inImagem$						= $item("IN_IMAGEM_PDV", $xlplemp$)	
	$nrDiaVencto$					= $item("NR_DIA_ATRASO_BLOQ_FAT" , $xlplemp$) ;Fiuza prj 102 tar 58 19/06/07 - validar clientes em atraso
	$InHomologacaoAm$				= $item("IN_HOMOLOGACAO_AM", $xlplemp$);---Elia Proj. 115/4 11/10/07
	$tpLiberacaoTraVd$			= $item("TP_LIBERACAO_TRA_VD", $xlplemp$)
	$inValidaPrdValeTroca$ 	= $item("IN_VALIDA_PRD_VALETROCA", $xlplemp$);---Elia Proj. 102/337 27/06/08
	$qtPecasDescontoVlMin$		= $item("QT_PECAS_DESCONTO_VL_MIN", $xlplemp$);---Elia Proj. 102/324 30/05/08
	if($qtPecasDescontoVlMin$ = 1)
		message/info "Valor do parâmetro empresa QT_PECAS_DESCONTO_VL_MIN deve ser maior que 1!"
		exit(0)
	endif
	$inUtilizaCTC$					= $item("IN_UTILIZA_CTC", $xlplemp$);---Elia Proj. 133/007 15/08/08
	$tpLimiteDesconto$			= $item("TP_LIMITE_DESCONTO", $xlplemp$) ;<ANO Pjt102 Trf784 - 21/01/2010>
	$nrDiasCarenciaAtraso$		= $item("NR_DIAS_CARENCIA_ATRASO", $xlplemp$) ; DIONE |156/0380| 30/07/2010
	$inSimuladorCondPgto$  	= $item("IN_SIMULADOR_COND_PGTO", $xlplemp$) ;>-- MAC - PRJ 156/383 - 12/08/2010 ---
	$tpCoeficientePrdVd$		= $item("TP_COEFICIENTE_PRD_VD", $xlplemp$) ;>-- MAC - PRJ 102/926 - 25/08/2010	
	$cdModRichTextVD$				= $item("CD_MOD_RICHTEXT_VD", $xlplemp$) ;>-- MAC - PRJ 102/926 - 25/08/2010
	$tpImpRichTextVD$				= $item("TP_IMP_RICHTEXT_VD", $xlplemp$) ;>-- MAC - PRJ 102/926 - 25/08/2010
	$tpBuscaVlValeTroca$		= $item("TP_BUSCA_VL_VALETROCA", $xlplemp$) ;>-- MAC - PRJ 156/395 - 16/09/2010 ---
	$tpUtilizaEtiqRfidPdv$ 	= $item("TP_UTILIZA_ETIQ_RFID_PDV", $xlplemp$) ;-=CANONICO=- (10/06/2011) PRJ 156 TAR 570
	$tpTEF$							= $item("TEF_TIPO", $xlplemp$)
	$tpConsultaSaldoCredev$	= $item("TP_CONSULTA_SALDO_CREDEV",$xlplemp$) ;-=CANONICO=- (10/08/2011) TAR 111 PRJ 182
	$cdModImpRecebTra$			= $item("CD_MOD_IMP_RECEBTRA", $xlplemp$) ;-=CANONICO=- (11/08/2011) TAR 125 PRJ 186
	$tpCancelaTraAndamento$	= $item("TP_CANCELA_TRA_ANDAMENTO", $xlplemp$)  ;* Claudemir - Prj/Tarefa: 191/2 07/010/2011
	$tpUtilizaBoleta$         = $item("TP_UTILIZA_BOLETA", $xlplemp$) ;-- ALX - 191/11 - 11/11/2011 --;
	$tpImpTefPAYGO$           = $item("TP_IMPRESSAO_TEF_PAYGO", $xlplemp$);-=CANONICO=- 30/11/2010 TAR 982 PRJ 102 - Parametro de leitura do arquivo intpos	

	return(0)
End ; operation INIT

;------------------------
partner operation CLEANUP 
	;------------------------
	putitem/id $$gParamglb,"DS_TECLADO",""
	$keyboard = "KB_GLOBAL"
	return(0)
End ; operation CLEANUP

;----------------------
partner operation BT_02
	;----------------------
	variables
		string viParams, voParams
	endvariables

	;---Elia Proj. 102/434 29/10/08
	;if ($inBloqExcluiItem$ = <TRUE>)
	if ($inBloqExcluiItem$ = 1) | ($inBloqExcluiItem$ = 2) | ($inBloqExcluiItem$ = 3); 1 - Sim - Nao permiti sair do componente / 2 - Sim - Permiti sai do componente
	;
		viParams = ""
		putitem/id viParams, "IN_USULOGADO", <TRUE>
		;putitem/id viParams, "CD_USUARIO", $item("CD_USUARIO", $$gParamGlb)
		putitem/id viParams, "DS_COMPONENTE", "TRAFM060EX"
		activate "ADMFM020".exec(viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)  
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")     
			return (-1)
		endif
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Função bloqueada!", "ADICIONAL=Parâmetro empresa->IN_BLOQ_EXCLUIR_ITEM")
			return(-1)		
		endif
	endif

	macro "^CLEAR"

	$prompt = CD_AUXILIAR.PES_VENDEDOR	
	
	return(0)
end

;----------------------
partner operation BT_03
	;----------------------
	variables
		string viParams, voParams
	endvariables

	;Fiuza - projeto 41 tarefa 146 - bloquear entrada por qtd usando restrição quando
	;o parametro IN_BLOQ_QTD estiver setado como "1"
	if ($inBloqQtde$ = <TRUE>)
		viParams = ""
		putitem/id viParams, "CD_COMPONENTE"  , $componentname
		putitem/id viParams, "DS_CAMPO"       , "IN_LANCAR_QTDE"                   
		putitem/id viParams, "CD_EMPRESA"     , $item("CD_EMPRESA" ,$$gParamGlb)
		putitem/id viParams, "CD_USUARIO"     , $item("CD_USUARIO" ,$$gParamGlb)
		putitem/id viParams, "VL_VALOR"       , ""    
		activate "ADMSVCO009".VerificaRestricao(viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Usuário com restrição para executar processo.%%^Restrição - IN_LANCAR_QTDE", "")
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Função bloqueada!", "ADICIONAL=Parâmetro empresa->IN_BLOQ_QTD")
			return(-1)
		endif	
	endif

	if (TP_INCLUSAO.TRA_TRANSACAO = "QUANTIDADE")
		TP_INCLUSAO.TRA_TRANSACAO = "CODIGO"
		BT_F3.SIS_BOTOES = "F3 Entrada por quantidade"
	else
		TP_INCLUSAO.TRA_TRANSACAO = "QUANTIDADE"
		BT_F3.SIS_BOTOES = "F3 Entrada por código"
	endif
		
	$instancehandle->posicionaCursor()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif    

	return(0)
end

;----------------------
partner operation BT_04
;----------------------	
	variables
		string viParams, voParams
		numeric vNrTransacao, vCdPessoa
		date vDtTransacao
	endvariables

	if (!$dbocc("TRA_TRANSACAO"))
		$instancehandle->validaVendedor()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
		if ($status < 0)
			return(-1)
		endif
	endif

	viParams = ""
	putlistitems/occ viParams, "TRA_TRANSACAO"
	activate "TRASVCO004".gravaCapaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif

	if (NR_TRANSACAO.TRA_TRANSACAO = 0)
		vNrTransacao = $item("NR_TRANSACAO", voParams)
		NR_TRANSACAO.TRA_TRANSACAO/init = vNrTransacao
		;* Claudemir - Prj/Tarefa: 102/943 - 20/09/2010
		; O usuário conseguia gravar data retroativa ao teclar F4,
		; foi alterado o TRASVCO004 para gravar a data do sistema quando a transação ainda não estiver gravada no banco,
		; portanto sempre que a transação for vazia, irá recarregar a data da transação que veio do TRASVCO004
		vDtTransacao = $item("DT_TRANSACAO", voParams)
		DT_TRANSACAO.TRA_TRANSACAO/init = vDtTransacao ;*
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "NR_CARTAO", $nrCartao$
	$keyboard = "KB_GLOBAL"
	activate "TRAFM081".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif

	$nrCartao$ = $item("NR_CARTAO", voParams) ;---Elia Proj. 102/492 13/04/09
	
	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif

	if ($inconferente$ = 1 & $item("CD_CONFERENTE", voParams) != "") ;recarrega o codigo e nome do conferente, caso mude o conferente nos dados adicionais
		$dsConferente$ = $item("DS_CONFERENTE", voParams)
		putitem/id $$gParamGlb, "CD_USUCONF", $item("CD_CONFERENTE", voParams)
	else
		clear/e "ADM_USUARIO"
		CD_USUARIO.ADM_USUARIO/init = $item("CD_USUARIO", $$gParamGlb)
		retrieve/e "ADM_USUARIO"
		;$dsConferente$ = NM_LOGIN.ADM_USUARIO
		if($status >= 0)
			;--->MNT - Prj 094/1320 - 18/03/2010
			if (CD_USUARIO.ADM_USUARIO > 0)
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_USUARIO", CD_USUARIO.ADM_USUARIO
				activate "ADMSVCO027".validaUsuarioEspecial($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)	
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus("",$xCdErro$, $xCtxErro$, "")
					return(-1)
				endif

				if(voParams != "")
					$dsConferente$ = $item("NM_LOGIN", voParams)
				endif
			else
				$dsConferente$ = ""
			endif
			;<---
		endif
	endif

	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif

	$prompt = TP_TRANSACAO.TRA_TRANSACAO
	
	return(0)
end

;----------------------
partner operation BT_05
;----------------------
	variables
		string viParams, voParams, vDsRegTroca, vDsSerie
		numeric vNrTransacao
		numeric vVlTotalDesc, vPrTotalDesc, vVlTotalLiquido, vVlCalc
		numeric vVlBrutoTransacao, vVlLiquidoTransacao
		date vDtSistema
	endvariables	

	;Fiuza - projeto 41 tarefa 146 - bloquear entrada por qtd usando restrição quando
	;o parametro IN_BLOQ_QTD estiver setado como "1"
	if (TP_INCLUSAO.TRA_TRANSACAO = "QUANTIDADE")
		if ($inBloqQtde$ = <TRUE>)
			viParams = ""
			putitem/id viParams, "CD_COMPONENTE"  , $componentname
			putitem/id viParams, "DS_CAMPO"       , "IN_LANCAR_QTDE"                   
			putitem/id viParams, "CD_EMPRESA"     , $item("CD_EMPRESA" ,$$gParamGlb)
			putitem/id viParams, "CD_USUARIO"     , $item("CD_USUARIO" ,$$gParamGlb)
			putitem/id viParams, "VL_VALOR"       , ""    
			activate "ADMSVCO009".VerificaRestricao(viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Usuário com restrição para executar processo.%%^Restrição - IN_LANCAR_QTDE", "")
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Função bloqueada!", "ADICIONAL=Parâmetro empresa->IN_BLOQ_QTD")
				return(-1)
			endif	
		endif
	endif	
	
	vDtSistema = $item("DT_SISTEMA", $$gParamGlb)

	if (TP_FOCO.TRA_TRANSACAO = "C") | (TP_FOCO.TRA_TRANSACAO = "I")
		;---Elia Proj. 102/353 01/08/08
		if (!$dbocc("TRA_TRANSACAO")) & (DT_TRANSACAO.TRA_TRANSACAO != vDtSistema)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Data da transação diferente da data do sistema!", "")
			$prompt = DT_TRANSACAO.TRA_TRANSACAO
			return(-1)
		endif
		;

		viParams = ""
		putlistitems/occ viParams, "TRA_TRANSACAO"
		if ($nrDiaVencto$ > 0)
			putitem/id viParams, "IN_VALIDA_CLIENTE_ATRASO", <TRUE>
		endif
		activate "TRASVCO004".gravaCapaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			if ($status = -2)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				askmess "Cliente %%CD_PESSOA.TRA_TRANSACAO esta com faturas em atraso! Deseja continuar?","Sim,Não"
				if ($status = 1)
					viParams = ""
					putlistitems/occ viParams, "TRA_TRANSACAO"
					putitem/id viParams, "IN_VALIDA_CLIENTE_ATRASO", <FALSE>
					activate "TRASVCO004".gravaCapaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)	
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif	
				else
					return(-1)
				endif		
			else
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
		endif
		
		commit
		if ($status < 0)
			rollback
			return (-1) 
		else
			$instancehandle->SetHint("ID=APLINFO002")
		endif
	
		if (NR_TRANSACAO.TRA_TRANSACAO = 0)
			vNrTransacao = $item("NR_TRANSACAO", voParams)
			NR_TRANSACAO.TRA_TRANSACAO/init = vNrTransacao
		endif

		if (TP_FOCO.TRA_TRANSACAO = "C") & ($inDadosAdicionaisAuto$ = <TRUE>)
			$instancehandle->BT_04()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif  
		endif
		
		TP_FOCO.TRA_TRANSACAO/init = "B"    
		BT_F5.SIS_BOTOES/init = "F5 Navegar item"
	elseif (TP_FOCO.TRA_TRANSACAO = "B")
		TP_FOCO.TRA_TRANSACAO/init = "I"
		BT_F5.SIS_BOTOES/init = "F5 Lançar item"
	endif

	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif

	$prompt = TP_TRANSACAO.TRA_TRANSACAO

	;* Claudemir - Prj/Tarefa: 102/751 - 04/12/2009 
	;  Se for ECF não concomitante e o número de série não estiver carregado na global,
	;  leio o número de série da ECF e carrego na global
;	if (TP_DOCTO.GER_OPERACAO = 2) & ($item("CD_SERIEECF",$$gParamGlb) = "")
;		viParams = ""
;		putitem/id viParams, "NM_FUNCAO", <ECF_NUMERO_SERIE>
;		activate "ECFSVCO001".leInformacaoImpressora(viParams,voParams,$xcderro$,$xctxerro$)
;		if ($procerror)       
;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			return(-1)	
;		elseif ($status < 0)
;			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;			return(-1)
;		endif	
;		vDsSerie = $item("NR_SERIE", voParams)
;		putitem/id $$gParamGlb, "CD_SERIEECF", vDsSerie
;	endif ;*
;comentei pois existem micros que nao possuem ECF - MODA
	return(0)
end

;----------------------
partner operation BT_06
;----------------------
	variables
		string viParams, voParams
		numeric vVlTotalDesc, vPrTotalDesc, vVlTotalLiquido, vVlCalc
		numeric vVlDesconto, vVlResto,  vVlMaior, vNrOcc, vCdUsuario       
		numeric vVlBrutoTransacao, vVlLiquidoTransacao
	endvariables

	;---Elia Proj. 102/314 02/06/08
	;if ($tpSimuladorFat$ > 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível aplicar desconto item o parâmetro por empresa TP_SIMULADOR_FAT está configurado!", "")
	;	return(-1)
	;endif
	;
	
	if (VL_TOTALDESCCAB.TRA_TRANSITEM != 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível aplicar desconto item após já ter sido aplicado desconto total!", "")
		return(-1)
	endif
	
	;Fiuza prj 41 tar 98 25/01/07 - bloquear desconto para item em promoção
	if (($InBloqDesItemProm$ = <TRUE>) & (CD_PROMOCAO.TRA_TRANSITEM > 0))
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível aplicar desconto para item em promoção! IN_BLOQ_DESC_ITEM_PROM", "")
		return(-1)
	endif

	$cdUsuarioDesc$ = ""
	vCdUsuario = $item("CD_USUARIO", $$gParamGlb)


	;>-- MAC - PRJ 102 TAR 789 - 03/02/2010 ----------------------;
	; Sempre ao chamar o componente TRAFM062 passar os valores    ;
	; da transacao e comentar a leitura da tabela TRA_LIMDESCONTO ;
	;-------------------------------------------------------------;
	;<ANO Pjt102 Trf784 - 21/01/2010>	
	;if($tpLimiteDesconto$ = 1)
	putitem/id viParams, "CD_EMPTRA"   , CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	;</ANO Pjt102 Trf784 - 21/01/2010>
	;else
	;	viParams = ""
	;	clear/e "TRA_LIMDESCONTO"
	;	CD_OPERACAO.TRA_LIMDESCONTO/init = CD_OPERACAO.TRA_TRANSACAO
	;	CD_USUARIO.TRA_LIMDESCONTO/init = $item("CD_USUARIO", $$gParamGlb)
	;	retrieve/e "TRA_LIMDESCONTO"
	;	if ($status >= 0)
	;		putitem/id viParams, "PR_DESCMAXIMO", PR_DESCMAX.TRA_LIMDESCONTO
	;	else	
	;		clear/e "TRA_LIMDESCONTO"
	;		putitem/id viParams, "PR_DESCMAXIMO", 0
	;	endif
	;endif
	;-------------------------------------------------------------<
	putitem/id viParams, "VL_TOTALBRUTO", VL_TOTALBRUTO.TRA_TRANSITEM
	putitem/id viParams, "VL_BASEDESC", VL_TOTALBRUTO.TRA_TRANSITEM
	putitem/id viParams, "VL_DESCONTO", VL_TOTALDESC.TRA_TRANSITEM
	putitem/id viParams, "IN_ARREDONDAPRECO", <FALSE>
	putitem/id viParams, "IN_ALTERAVLLIQUIDO", <TRUE>
	putitem/id viParams, "CD_OPERACAO", CD_OPERACAO.TRA_TRANSACAO
	putitem/id viParams, "CD_PESSOA", CD_PESSOA.TRA_TRANSACAO
	$keyboard = "KB_GLOBAL"
	activate "TRAFM062".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif  

	if ($status < 0)
		return(-1) 
	endif

	vVlTotalDesc = $item("VL_TOTALDESC", voParams)
	vPrTotalDesc = $item("PR_TOTALDESC", voParams)
	vVlTotalLiquido = $item("VL_TOTALLIQUIDO", voParams)

	;* Claudemir - Prj/Tarefa: 191/1 - 30/09/2011
	; se o desconto retornado for o mesmo que ja esta gravado no item, não faz nada
	if (VL_TOTALDESC.TRA_TRANSITEM = vVlTotalDesc)
		return(0)
	endif ;*

	;* Claudemir - Prj/Tarefa: 191/1 - 30/09/2011
	if (TP_DOCTO.GER_OPERACAO = 3)
		if (VL_TOTALDESC.TRA_TRANSITEM > 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é permitido alterar desconto para ECF concomitante!", "")
			return(-1)			
		endif
	endif ;*

	VL_TOTALDESC.TRA_TRANSITEM = vVlTotalDesc
	VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)	
	vVlCalc = VL_TOTALDESC.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
	VL_UNITDESC.TRA_TRANSITEM = vVLCalc[round, 6]
	vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
	VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]

	viParams = ""
	putlistitems/occ viParams, "TRA_TRANSITEM"
	activate "TRASVCO004".gravaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	;Mendes - PRJ=156/TAR=682 - 23/11/2011
	if ($item("DS_MENSAGEM", voParams) != "")
		message/info "%%$item("DS_MENSAGEM", voParams)"
	endif
	;;;   

	if (TP_DOCTO.GER_OPERACAO = 3)
		if ($InCupomAberto$ = "S")
			;* Claudemir - Prj/Tarefa: 191/1 - 28/09/2011
			;if (VL_UNITDESC.TRA_TRANSITEM > 0)
			if (VL_TOTALDESC.TRA_TRANSITEM > 0) ;*
				;* Claudemir - Prj/Tarefa: 191/1 - 28/09/2011
				putitem/id viParams,"NR_ITEM", NR_ITEM.TRA_TRANSITEM	
				;putitem/id viParams,"VL_DESCONTO", VL_UNITDESC.TRA_TRANSITEM
				putitem/id viParams,"VL_DESCONTO", VL_TOTALDESC.TRA_TRANSITEM
				putitem/id viParams,"DS_ACRESDESC", "D" ;*
				activate "ECFSVCO001".acrescimoDescontoItem(viParams, voParams, $xcderro$, $xctxerro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					rollback
					return(-1)
				elseif ($status = -10)
					viParams = ""
					voParams = ""
					putitem/id viParams,"TITULO", "Erro de comunicação com a ECF"
					putitem/id viParams,"MENSAGEM", $item("DESCRICAO",$xctxerro$)
					activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						rollback
						return(-1)
					endif
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					rollback
					return(-1)
				endif
			endif	
		endif
	endif

	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif	

	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif    
	
	$prompt = TP_TRANSACAO.TRA_TRANSACAO	

	return(0)
end

;----------------------
partner operation BT_07
;----------------------	

	variables
		string viParams, voParams, vDsRegTroca, vDsLstTransacao, vDsRegistro, vDsLinha
		numeric vNrTransacao, vCdUsuario, vPrDescMaximo 
		numeric vVlDesconto, vVlTotalDesc, vPrTotalDesc, vVlResto, vVlCalc, vVlMaior, vNrOcc        
		numeric vVlBrutoTransacao, vVlLiquidoTransacao, vVlLiquido, vCdUsuAntLib
	endvariables

	if ($inSimuladorProduto$ = <TRUE>)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível aplicar desconto total o parâmetro por empresa IN_SIMULADOR_FAT_PRODUTO está configurado!", "")
		return(-1)
	endif

	if ($inSimuladorCondPgto$ = <TRUE>)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível aplicar desconto total o parâmetro por empresa IN_SIMULADOR_COND_PGTO está configurado!", "")
		return(-1)
	endif
	
	if ($tpSimuladorFat$ > 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível aplicar desconto total o parâmetro por empresa TP_SIMULADOR_FAT está configurado!", "")
		return(-1)
	endif
	
	$cdUsuarioDesc$ = ""
	vCdUsuario = $item("CD_USUARIO", $$gParamGlb)

	vVlLiquido = 0
	vVlDesconto = 0
	if ($empty("TRA_TRANSITEM") = 0)
		setocc "TRA_TRANSITEM", 1
		while ($status >= 0)
			;Fiuza prj 41 tar 98 25/01/07 - bloquear desconto para item em promoção
			if (($InBloqDesItemProm$ = <TRUE>) & (CD_PROMOCAO.TRA_TRANSITEM > 0))
			else
				vVlLiquido = vVlLiquido +  VL_TOTALLIQUIDO.TRA_TRANSITEM
				vVlDesconto = vVlDesconto + VL_TOTALDESCCAB.TRA_TRANSITEM
			endif
			setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
		endwhile
	endif

	;>-- MAC - PRJ 102 TAR 789 - 03/02/2010 ----------------------;
	; Sempre ao chamar o componente TRAFM062 passar os valores    ;
	; da transacao e comentar a leitura da tabela TRA_LIMDESCONTO ;
	;-------------------------------------------------------------;
	;<ANO Pjt102 Trf784 - 21/01/2010>	
	;if($tpLimiteDesconto$ = 1)
	viParams = ""
	putitem/id viParams, "CD_EMPTRA"   , CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	;</ANO Pjt102 Trf784 - 21/01/2010>
	;else
	;	viParams = ""
	;	clear/e "TRA_LIMDESCONTO"
	;	CD_OPERACAO.TRA_LIMDESCONTO/init = CD_OPERACAO.TRA_TRANSACAO
	;	CD_USUARIO.TRA_LIMDESCONTO/init = $item("CD_USUARIO", $$gParamGlb)
	;	retrieve/e "TRA_LIMDESCONTO"
	;	if ($status >= 0)
	;		putitem/id viParams, "PR_DESCMAXIMO", PR_DESCMAX.TRA_LIMDESCONTO
	;	else	
	;		clear/e "TRA_LIMDESCONTO"
	;		putitem/id viParams, "PR_DESCMAXIMO", 0
	;	endif
	;endif
	;-------------------------------------------------------------<
	putitem/id viParams, "VL_TOTALBRUTO", VL_TRANSACAO.TRA_TRANSACAO
	;vVlCalc = VL_TRANSACAO.TRA_TRANSACAO + vVlDesconto
	vVlCalc = vVlLiquido + vVlDesconto
	putitem/id viParams, "VL_BASEDESC", vVlCalc
	putitem/id viParams, "VL_DESCONTO", vVlDesconto
	putitem/id viParams, "IN_ARREDONDA_PRECO", <FALSE>
	putitem/id viParams, "CD_OPERACAO", CD_OPERACAO.TRA_TRANSACAO
	putitem/id viParams, "CD_PESSOA", CD_PESSOA.TRA_TRANSACAO
	activate "TRAFM062".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif  
	
	if ($status < 0)
		return(-1) 
	endif

	vVlTotalDesc = $item("VL_TOTALDESC", voParams)
	vPrTotalDesc = $item("PR_TOTALDESC", voParams)
	$cdUsuarioDesc$ = $item("CD_USUARIODESC", voParams)
	vPrDescMaximo = $item("PR_DESCMAXIMO", voParams) ;thamati 12/05/2010 [Proj. 0156 - Tar. 0305]	

	if ($cdUsuarioDesc$ > 0) & ($cdUsuarioDesc$ != vCdUsuario)
		clear/e "TRA_LIMDESCONTO"
		CD_OPERACAO.TRA_LIMDESCONTO/init = CD_OPERACAO.TRA_TRANSACAO
		CD_USUARIO.TRA_LIMDESCONTO/init = $cdUsuarioDesc$
		retrieve/e "TRA_LIMDESCONTO"
		if ($status < 0)
			clear/e "TRA_LIMDESCONTO"
		endif
	endif
	
	;thamati 12/05/2010 [Proj. 0156 - Tar. 0305]
;	if ($dbocc("TRA_LIMDESCONTO"))
;		vVlBrutoTransacao = VL_TRANSACAO.TRA_TRANSACAO + VL_DESCONTO.TRA_TRANSACAO
;		vVlLiquidoTransacao = VL_TRANSACAO.TRA_TRANSACAO - vVlTotalDesc
;		vVlCalc = (vVlBrutoTransacao - vVlLiquidoTransacao) / vVlBrutoTransacao * 100
;		$prDescTransacao$ = vVlCalc[round, 6]
;		if ($prDescTransacao$ > PR_DESCMAX.TRA_LIMDESCONTO)
;			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Perc. de desconto na transação de %%$prDescTransacao$ maior que o máximo permitido de %%PR_DESCMAX.TRA_LIMDESCONTO%%%! Existe desconto nos itens!", "")
;			return(-1)
;		endif
;	endif
	;

	vVlResto = vVlTotalDesc
	
	if ($empty("TRA_TRANSITEM") = 0)
		$instancehandle->agrupaItem(<FALSE>)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif

		vVlMaior = 0
		setocc "TRA_TRANSITEM", 1 
		while ($status >= 0)
			;Fiuza prj 41 tar 98 25/01/07 - bloquear desconto para item em promoção
			if (($InBloqDesItemProm$ = <TRUE>) & (CD_PROMOCAO.TRA_TRANSITEM > 0))
			else
				;>-- MAC - PRJ 156/276 - 29/04/2010 ---
				;vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM * vPrTotalDesc / 100
				;VL_TOTALDESCCAB.TRA_TRANSITEM = vVlCalc[round, 2]
				;VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
				;vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
				;VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
				;vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
				;VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]

				vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM
				vVlCalc = vVlCalc * vPrTotalDesc / 100			
				VL_TOTALDESCCAB.TRA_TRANSITEM = vVlCalc[round, 2]
				VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
				vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
				VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
				vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
				VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]

				if (VL_TOTALDESCCAB.TRA_TRANSITEM > vVlResto)				
					VL_TOTALDESCCAB.TRA_TRANSITEM = vVlResto 
	   				VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
					vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
					VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
					vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
					VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]
					vVlResto = 0
					break
				endif
				;--<

				vVlResto = vVlResto - VL_TOTALDESCCAB.TRA_TRANSITEM
				if (VL_TOTALLIQUIDO.TRA_TRANSITEM > vVlMaior)
					vVlMaior = VL_TOTALLIQUIDO.TRA_TRANSITEM
					vNrOcc = $curocc("TRA_TRANSITEM")
				endif
			endif
			setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
		endwhile
		if (vVlResto != 0)
			setocc "TRA_TRANSITEM", vNrOcc
			VL_TOTALDESCCAB.TRA_TRANSITEM = VL_TOTALDESCCAB.TRA_TRANSITEM + vVlResto
			VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
			vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
			VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
			vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
			VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]
		endif
	
		setocc "TRA_TRANSITEM", 1 
		while ($status >= 0)
			viParams = ""
			putlistitems/occ viParams, "TRA_TRANSITEM"
			activate "TRASVCO004".gravaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
		endwhile

		;Mendes - PRJ=156/TAR=682 - 23/11/2011
		if ($item("DS_MENSAGEM", voParams) != "")
			message/info "%%$item("DS_MENSAGEM", voParams)"
		endif
		;;;

		;thamati 12/05/2010 [Proj. 0156 - Tar. 0305]	
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "PR_DESCMAXIMO", vPrDescMaximo
		$keyboard = "KB_GLOBAL"
		activate "TRAFP059".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"	
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			rollback
			return(-1)			
		elseif ($status < 0)		
			rollback
			return(-1)
		endif  
		
		vCdUsuAntLib    = $cdUsuarioDesc$ ;Hugo em 08/04/11 Tarefa 182-39
		$cdUsuarioDesc$ = $item("CD_USUARIODESC", voParams)

		if ($cdUsuarioDesc$ > 0) & ($cdUsuarioDesc$ != vCdUsuario)
			clear/e "TRA_LIMDESCONTO"
			CD_OPERACAO.TRA_LIMDESCONTO/init = CD_OPERACAO.TRA_TRANSACAO
			CD_USUARIO.TRA_LIMDESCONTO/init = $cdUsuarioDesc$
			retrieve/e "TRA_LIMDESCONTO"
			if ($status < 0)
				clear/e "TRA_LIMDESCONTO"
			endif
			
			vDsLstTransacao = ""
			vDsRegistro = ""
			putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			putitem vDsLstTransacao, -1, vDsRegistro

			vDsLinha = "Desconto liberado pelo usuario %%$cdUsuarioDesc$, componente TRAFP059"
			viParams = ""
			putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
			putitem/id viParams, "DS_OBSERVACAO", vDsLinha
			putitem/id viParams, "CD_COMPONENTE", $componentname
			putitem/id viParams, "IN_MANUTENCAO", <FALSE>
			putitem/id viParams, "IN_OBSNF", <FALSE>
			activate "TRASVCO016".gravaObsTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)     
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif

			;Hugo em 08/04/11 Tarefa 182-39
			$cdUsuarioDesc$ = ""
		elseif ($cdUsuarioDesc$ = "") & (vCdUsuAntLib != "") 
			$cdUsuarioDesc$ = vCdUsuAntLib 
		endif
		;

		commit
		if ($status < 0)
			rollback
			return (-1) 
		else
			$instancehandle->SetHint("ID=APLINFO002")
		endif	
	endif	

	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif    
	
	$prompt = TP_TRANSACAO.TRA_TRANSACAO

	return(0)
end

;----------------------
partner operation BT_08
	;----------------------
	variables
		string viParams, voParams
		numeric vNrOcc, vNrItemAnt 
	endvariables
	
	if ($empty("TRA_TRANSITEM") != 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação não possui nenhuma item a ser removido!", "")
		return(-1)
	endif

	;---Elia Proj. 102/551 13/05/09
	;;---Elia Proj. 102/434 29/10/08
	;;---Elia Proj. 102/162 27/11/07
	;;if ($inBloqExcluiItem$ = <TRUE>) 
	;;if ($inBloqExcluiItem$ = <TRUE>) & (CD_USUIMPRESSAO.TRA_TRANSACAO > 0)
	;if ($inBloqExcluiItem$ = 1) | ($inBloqExcluiItem$ = 2) ; 1 - Sim - Nao permiti sair do componente / 2 - Sim - Permiti sai do componente
	;* Claudemir - Prj/Tarefa: 156/99  - 04/11/2009 (Inclusão da validação da opção 4 do parâmetro: IN_BLOQ_EXCLUIR_ITEM)
	;if ((($inBloqExcluiItem$ = 1) | ($inBloqExcluiItem$ = 2)) & (CD_USUIMPRESSAO.TRA_TRANSACAO > 0)) | ($inBloqExcluiItem$ = 3) ;
	if ((($inBloqExcluiItem$ = 1) | ($inBloqExcluiItem$ = 2)) & (CD_USUIMPRESSAO.TRA_TRANSACAO > 0)) | ($inBloqExcluiItem$ = 3) | ($inBloqExcluiItem$ = 4) ;* 	
		viParams = ""
		putitem/id viParams, "IN_USULOGADO", <TRUE>
		;putitem/id viParams, "CD_USUARIO", $item("CD_USUARIO", $$gParamGlb)
		putitem/id viParams, "DS_COMPONENTE", "TRAFM060EX"
		activate "ADMFM020".exec(viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)  
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")     
			return (-1)
		endif
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Função bloqueada!", "ADICIONAL=Parâmetro empresa->IN_BLOQ_EXCLUIR_ITEM")
			return(-1)		
		endif
	endif

	askmess "Deseja realmente remover o registro?","Remover,Cancelar"
	if ($status = 2) 
		return (-1)
	endif
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "NR_ITEM", NR_ITEM.TRA_TRANSITEM
	activate "TRASVCO004".removeItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	if (TP_DOCTO.GER_OPERACAO = 3)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "NR_ITEM", NR_ITEM.TRA_TRANSITEM		
		activate "ECFSVCO010".cancelaItem($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status = -10)
			viParams = ""
			voParams = ""
			putitem/id viParams,"TITULO", "Erro de comunicação com a ECF"
			putitem/id viParams,"MENSAGEM", $item("DESCRICAO",$xctxerro$)
			activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				rollback
				return(-1)
			endif
			rollback
			return(-1)
		elseif ($status = -50)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			apexit
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		;-=LSC=- (14/04/2008) TAR 280 PRJ 102 - ITEM ECF CONCOMITANTE NAO PERDER A SEQUENCIA
		vNrItemAnt = NR_ITEM.TRA_TRANSITEM
		if (vNrItemAnt > $vNrItem$) 
			$vNrItem$ = vNrItemAnt	
		endif
		;
	endif
	
	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif
	
	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif    
	
	$prompt = TP_TRANSACAO.TRA_TRANSACAO
	
	return(0)
end

;----------------------
partner operation BT_09
;----------------------
	variables
		string viParams, voParams, vDsLstColetor
		boolean vInAgruparItem, vInColetor
		numeric vCdPessoa, vCdPessoaAnt
	endvariables

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "TP_FOCO", TP_FOCO.TRA_TRANSACAO
	if($empty("TRA_TRANSITEM") = 1)
		putitem/id viParams, "IN_ITENS", <FALSE>
	endif
	$keyboard = "KB_GLOBAL"
	activate "TRAFP011".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif	

	if ($status >= 0)
		vInAgruparItem = $item("IN_AGRUPARITEM", voParams)
		if (vInAgruparItem = <TRUE>)
			$instancehandle->agrupaItem(<TRUE>)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif	
		endif
		if ($item("IN_AGRUPATRANSACAO", voParams) = <TRUE>);carrega transacao agrupada
			clear/e "TRA_TRANSACAO"
			DT_TRANSACAO.TRA_TRANSACAO = $item("DT_TRANSACAO", voParams)
			NR_TRANSACAO.TRA_TRANSACAO = $item("NR_TRANSACAO",voParams)
			retrieve/e "TRA_TRANSACAO"
		endif
		vInColetor = $item("IN_ENTRADACOLETOR", voParams)
		if (vInColetor = <TRUE>)
			vDsLstColetor = $item("DS_LSTCOLETOR",voParams)	
			if (vDsLstColetor != "")
				$instancehandle->entradaColetor(vDsLstColetor)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif
			endif
		endif	
	endif

	vCdPessoa = $item("CD_PESSOA", voParams)
	vCdPessoaAnt = CD_PESSOA.TRA_TRANSACAO

	if ($dbocc("TRA_TRANSACAO"))
		$instancehandle->recarregaTransacao()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif	
	endif
	
	if (NR_TRANSACAO.TRA_TRANSACAO > 0) & (vCdPessoa > 0) & (vCdPessoa != vCdPessoaAnt)
		clear/e "PES_PESSOA"
		CD_PESSOA.PES_PESSOA/init = vCdPessoa
		retrieve/e "PES_PESSOA"
		
		viParams = ""
		putlistitems/occ viParams, "TRA_TRANSACAO"
		activate "TRASVCO004".gravaCapaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		
		commit
		if ($status < 0)
			rollback
			return (-1) 
		else
			$instancehandle->SetHint("ID=APLINFO002")
		endif
		
		if (vCdPessoa != $cdCliente$)
			$instancehandle->buscaAniversario()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
		endif
	endif

	$prompt = TP_TRANSACAO.TRA_TRANSACAO
	
	return(0)
end

;----------------------
partner operation BT_11
;----------------------

	variables
		string viParams, voParams, vDsLstTransacao, vDsLstEncargoFin, vDsLstVariacao
		string vDsRegistro, vDsComponente, vDsLinha, vDsLstEmpresa, vDsLstNF, vDsLstLiquidacao
		numeric vVlTrocoMaximoTra, vVlTrocoMaximoEnc, vCdUsuario, vStatus, vTpVariacao, vVlDescVariacao
		numeric vCdOperTroca, vVlTroca, vCdOperNF, vTpValidacaoConf, vQtTotal, vPrDescVariacao, vQtMinima, vQtMaxima
		boolean vInImprimir, vInTrocoMaximo, vInSangria, vInFatura, vInMostraTroco, vInConsultaSaldoCredev
		numeric vVlResto, vVlCalc, vVlMaior, vPrTotalDesc, vNrOcc, vVlTotalDesconto, vVlTotalBruto, vTotalDescCab, vPrTotalDescCab
	endvariables

	vTpValidacaoConf = $item("TP_VALIDACAO_CONF_TRA", $xlplemp$)
	
	if ($empty("R_TRA_TRANSACAO") = 0)
		if (CD_PESSOA.TRA_TRANSACAO != CD_PESSOA.R_TRA_TRANSACAO)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Pessoa da transação de vale troca(%%CD_PESSOA.R_TRA_TRANSACAO%%%) diferente da transação de troca(%%CD_PESSOA.TRA_TRANSACAO%%%)!", "")
			return(-1)
		endif

		if ($InMantVendValeTroca$ = <FALSE>);;
			viParams = ""
			putitem/id viParams "CD_EMPRESA", CD_EMPRESA.R_TRA_TRANSACAO
			putitem/id viParams "NR_TRANSACAO", NR_TRANSACAO.R_TRA_TRANSACAO
			putitem/id viParams "DT_TRANSACAO", DT_TRANSACAO.R_TRA_TRANSACAO
			putitem/id viParams "CD_COMPVEND", CD_COMPVEND.TRA_TRANSACAO
			activate "TRASVCO004".alteraVendedorTransacaoNF($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				rollback
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				rollback
				return(-1)
			endif	
		endif	
	endif
	
	if (CD_COMPVEND.TRA_TRANSACAO = 0) & ($cdCompVend$ != 0)
		clear/e "PES_VENDEDOR"
		CD_VENDEDOR.PES_VENDEDOR/init = $cdCompVend$
		retrieve/e "PES_VENDEDOR"
	endif
	
	;------------------------------
	;Hugo em 02/02/11 Tarefa 182-14
	if (TP_MODALIDADE.GER_OPERACAO = 4) & (TP_OPERACAO.TRA_TRANSACAO = "S") ;Venda
		viParams = ""
		putitem/id viParams, "CD_OPERACAO", CD_OPERACAO.TRA_TRANSACAO
		activate "GERSVCO054".dadosAdicionaisOperacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		
		vQtMinima = $item("QT_MINIMA", voParams)
		vQtMaxima = $item("QT_MAXIMA", voParams)
		
		if (vQtMinima > 0) & (QT_SOLICITADA.TRA_TRANSACAO < vQtMinima)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação %%NR_TRANSACAO.TRA_TRANSACAO não possui quantidade mínima %%vQtMinima%%% por operação!", "")
			return(-1)
		elseif (vQtMaxima > 0) & (QT_SOLICITADA.TRA_TRANSACAO > vQtMaxima)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação %%NR_TRANSACAO.TRA_TRANSACAO ultrapassou a quantidade máxima %%vQtMaxima%%% por operação!", "")
			return(-1)
		endif
	endif
	;------------------------------
	
	viParams = ""
	putlistitems/occ viParams, "TRA_TRANSACAO"
	activate "TRASVCO004".gravaCapaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		rollback
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		rollback
		return(-1)
	endif

	; --- DIONE |156/380| 30/07/2010
	if($nrDiaAtraso$ <= $nrDiasCarenciaAtraso$) & ($nrDiasCarenciaAtraso$ > 0) & ($nrDiaAtraso$ > 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Cliente com %%$nrDiaAtraso$ dias em atraso!", "")
	endif
	; ---

	if (vTpValidacaoConf = 2) | (vTpValidacaoConf = 3)
		viParams = ""
		$keyboard = "KB_GLOBAL"
		putitem/id viParams, "QT_TOTAL", QT_SOLICITADA.TRA_TRANSACAO ; DIONE |156/381| 30/07/2010	
		activate "TRAFP058".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Quantidade para conferência obrigatória!", "")
			return(-1)
		endif
		
		; --- DIONE |156/381| 30/07/2010
		if(vTpValidacaoConf = 3)	
			
			CD_USUCONF.TRA_TRANSACAO = $item("CD_USUCONF", voParams)	
			viParams = ""
			putlistitems/occ viParams, "TRA_TRANSACAO"
			activate "TRASVCO004".gravaCapaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif	
		endif
		; ---		
	endif
	
	if ($tpAgrupamento$ = 0 | $tpAgrupamento$ = 3)
		$instancehandle->agrupaItem(<FALSE>)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			rollback
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			rollback
			return(-1)
		endif
	endif

	vCdUsuario = $item("CD_USUARIO", $$gParamGlb)

	if ($cdUsuarioDesc$ > 0) & ($cdUsuarioDesc$ != vCdUsuario)
		vDsLstTransacao = ""
		vDsRegistro = ""
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem vDsLstTransacao, -1, vDsRegistro

		vDsLinha = "Desconto liberado pelo usuario %%$cdUsuarioDesc$"
		viParams = ""
		putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
		putitem/id viParams, "DS_OBSERVACAO", vDsLinha
		putitem/id viParams, "CD_COMPONENTE", $componentname
		putitem/id viParams, "IN_OBSNF", <FALSE>
		activate "TRASVCO016".gravaObsTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)     
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			rollback
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			rollback
			return(-1)
		endif
		$cdUsuarioDesc$ = ""
	endif
	
	;--> ALX - 191/11 - 11/11/2011 --;
	if($tpUtilizaBoleta$ = 2)
		viParams = ""
		$keyboard = "KB_GLOBAL"
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		activate "TRAFM140".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			return(-1)
		endif
	endif
	;--<

	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif    

	vCdOperTroca = $item("CD_OPER_TROCA_VALOR_VD", $xlplemp$)
	vVlTroca = $item("VL_TROCA_TPVALOR_VD", $xlplemp$)

	if (vCdOperTroca != 0) & (VL_TRANSACAO.TRA_TRANSACAO >= vVlTroca) & (TP_MODALIDADE.GER_OPERACAO = 4) & (TP_OPERACAO.TRA_TRANSACAO = "S") ;Venda
		$vlTransacaoAnt$ = VL_TRANSACAO.TRA_TRANSACAO
		
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "CD_OPERACAO", vCdOperTroca
		putitem/id viParams, "CD_OPERACAONF", vCdOperNF
		activate "TRASVCO024".trocaOperacaoTra($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif	
		
		commit
		if ($status < 0)
			rollback
			return (-1) 
		else
			$instancehandle->SetHint("ID=APLINFO002")
		endif
		
		$instancehandle->recarregaTransacao()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
		
		message/info "Valor total antigo: %%$vlTransacaoAnt$   Valor total novo: %%VL_TRANSACAO.TRA_TRANSACAO%%%.%%^Troca de operação, parâmetros: CD_OPER_TROCA_VALOR_VD e VL_TROCA_TPVALOR_VD"
	endif
	
	if (TP_MODALIDADE.GER_OPERACAO = 4) & (TP_OPERACAO.TRA_TRANSACAO = "S") ;Venda
		if ($qtPecasDescontoVlMin$ > 0)
			$instancehandle->aplicaQtPecasDescontoVlMin()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				rollback
				return(-1)
			elseif ($status < 0)
				rollback
				return(-1)
			endif
		endif
		
		vTpVariacao = $item("TP_VARIACAO_DESCONTO_VD", $xlplemp$)
		if (vTpVariacao = 1)
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			activate "TRASVCO005".descontoVariacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif			
			
			vDsLstVariacao  = $item("DS_LSTRETORNO", voParams)
			vVlDescVariacao = $item("VL_DESCONTO", voParams)
			vPrDescVariacao = $item("PR_DESCONTO", voParams)

			;* Claudemir - Prj/Tarefa: 102/965 - 06/10/2010
			if (vDsLstVariacao != "")
				viParams = ""
				putitem/id viParams, "TITULO", "Item com variação de desconto"
				putitem/id viParams, "MENSAGEM", vDsLstVariacao
				activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					rollback
					return(-1)
				endif

				askmess "Confirma variação de desconto?" , "Sim, Não"
				if ($status = 2) ;Não
					rollback ; <-- Hugo em 20/10/10 Precisava do rollback para desfazer a aplicação do desconto
					return(-1)
				endif
			endif	  ;*

			if (vPrDescVariacao > 0)
				;* Claudemir - Prj/Tarefa: 102/965 - 06/10/2010
				vPrTotalDescCab = 0
				vTotalDescCab   = 0
				setocc "TRA_TRANSITEM", 1 
				while ($status >= 0)
					vTotalDescCab   = vTotalDescCab + VL_TOTALDESCCAB.TRA_TRANSITEM
					setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
				endwhile
				vPrTotalDescCab = (vTotalDescCab / (VL_TRANSACAO.TRA_TRANSACAO + vTotalDescCab)) * 100 ;*

				;* Claudemir - Prj/Tarefa: 102/965 - 06/10/2010
				;vVlResto     = vVlDescVariacao
				vVlResto     = vVlDescVariacao + vTotalDescCab ;*

				;* Claudemir - Prj/Tarefa: 102/965 - 06/10/2010
				;vPrTotalDesc = vPrDescVariacao
				vPrTotalDesc = vPrDescVariacao + vPrTotalDescCab ;*
			
				if ($empty("TRA_TRANSITEM") = 0)
					vVlMaior = 0
					setocc "TRA_TRANSITEM", 1 
					while ($status >= 0)
						vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM
						vVlCalc = vVlCalc * vPrTotalDesc / 100			
						VL_TOTALDESCCAB.TRA_TRANSITEM = vVlCalc[round, 2]
	
						VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
						vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
						VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
						vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
						VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]
					
						if (VL_TOTALDESCCAB.TRA_TRANSITEM > vVlResto)				
							VL_TOTALDESCCAB.TRA_TRANSITEM = vVlResto 
	   					VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
							vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
							VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
							vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
							VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]
							vVlResto = 0
							break
						endif
					
						vVlResto = vVlResto - VL_TOTALDESCCAB.TRA_TRANSITEM
					
						if (VL_TOTALLIQUIDO.TRA_TRANSITEM > vVlMaior)
							vVlMaior = VL_TOTALLIQUIDO.TRA_TRANSITEM
							vNrOcc = $curocc("TRA_TRANSITEM")
						endif
					
						setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
					endwhile
				endif
			
				if (vVlResto != 0)
					setocc "TRA_TRANSITEM", vNrOcc
					VL_TOTALDESCCAB.TRA_TRANSITEM = VL_TOTALDESCCAB.TRA_TRANSITEM + vVlResto
					VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
					vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
					VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
					vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
					VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]
				endif
			
				setocc "TRA_TRANSITEM", 1 
				while ($status >= 0)
					viParams = ""
					putlistitems/occ viParams, "TRA_TRANSITEM"
					putitem/id viParams, "IN_TOTAL", <FALSE>
					putitem/id viParams, "IN_NAOVALIDALOTE", <TRUE>
					activate "TRASVCO004".gravaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
				endwhile

				;Mendes - PRJ=156/TAR=682 - 23/11/2011
				if ($item("DS_MENSAGEM", voParams) != "")
					message/info "%%$item("DS_MENSAGEM", voParams)"
				endif
				;;;
			
				vDsLstTransacao = ""
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
				putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
				putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
				putitem vDsLstTransacao, -1, vDsRegistro    
				putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
				activate "TRASVCO004".gravaTotalTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif	
			
				commit
				if ($status < 0)
					rollback
					return (-1) 
				else
					$instancehandle->SetHint("ID=APLINFO002")
				endif
			
				;* Claudemir - Prj/Tarefa: 102/965 - 06/10/2010
				; movida a lógica abaixo para cima

				;if (vDsLstVariacao != "")
				;	viParams = ""
				;	putitem/id viParams, "TITULO", "Item com variação de desconto"
				;	putitem/id viParams, "MENSAGEM", vDsLstVariacao
				;	activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
				;	if ($procerror)       
				;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				;		rollback
				;		return(-1)
				;	endif
				;endif ;*
			
				$instancehandle->recarregaTransacao()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif
			endif
		endif
	endif
		
	if ($inUtilizaCTC$ = <TRUE>)
		$instancehandle->carregaBonusCartao()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			rollback
			return(-1)
		elseif ($status < 0)
			rollback
			return(-1)
		endif
	endif
	
	$instancehandle->bonusDesconto()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		rollback
		return(-1)
	elseif ($status < 0)
		rollback
		return(-1)
	endif

	$instancehandle->carregaFormaPagamento()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
		rollback
		return(-1)
	elseif ($status < 0)
		rollback
		return(-1)
	endif
	
	vInImprimir = <TRUE>
	if ($tpImpressaoTraVenda$ != 1) & ($tpImpressaoTraVenda$ != 2)
		vInImprimir = <FALSE>
	endif
	
	if (vInImprimir = <TRUE>)
		viParams = ""
		putitem/id viParams, "CD_OPERACAO", CD_OPERACAO.GER_OPERACAO
		activate "GERSVCO054".dadosAdicionaisOperacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif	
		
		if ($item("TP_IMPRESSAOTRA", voParams) = 1)
			vInImprimir = <FALSE>
		endif
	endif
	
	if (vInImprimir = <TRUE>)
		viParams = ""
		vDsLstTransacao = ""
		vDsRegistro = ""
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem vDsLstTransacao, -1, vDsRegistro	
		putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
		if (TP_MODALIDADE.GER_OPERACAO = 4 | TP_MODALIDADE.GER_OPERACAO = 3 | TP_MODALIDADE.GER_OPERACAO = 8) ;Venda/Devolucao/Troca
			if ($tpImpressaoTraVenda$ = 02)
				putitem/id viParams, "IN_DIRETO", <FALSE>
			else
				putitem/id viParams, "IN_DIRETO", <TRUE>
			endif
		else
			putitem/id viParams, "IN_DIRETO", <FALSE>
		endif
		
		$keyboard = "KB_GLOBAL"
		activate "TRAFP004".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
		if ($status >= 0)
			commit
			if ($status < 0)
				rollback
			else
				$instancehandle->SetHint("ID=APLINFO002")
			endif
		else
			rollback
		endif   
	endif	
	
	if ($tpLiberacaoTraVd$ = 01 | $tpLiberacaoTraVd$ = 02) & (TP_MODALIDADE.GER_OPERACAO = 4) & (TP_OPERACAO.TRA_TRANSACAO = "S") ;Venda
		vDsLstTransacao = ""
		vDsRegistro = ""
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem vDsLstTransacao, -1, vDsRegistro
		viParams = ""
		putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
		if ($tpLiberacaoTraVd$ = 01)
			putitem/id viParams, "TP_SITUACAO", 2 ;Liberada para faturamento
		else
			putitem/id viParams, "TP_SITUACAO", 8 ;Bloqueada
		endif
		putitem/id viParams, "CD_COMPONENTE", $componentname
		activate "TRASVCO004".alteraSituacaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		commit
		if ($status < 0)
			rollback
			return (-1) 
		else
			$instancehandle->SetHint("ID=APLINFO002")
		endif
	endif
	
	vDsComponente = "TRAFM061"
	activate "LOGSVCO003".GetNivelComponente($$gCdUsuario, $$gCdEmpresa, vDsComponente, $xCdNivel$, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>,$procerror,$procerrorcontext,"ADICIONAL=LOGSVCO003.GETNIVELCOMPONENTE")
	elseif ($xCdNivel$ > 0)	
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "CD_USUARIODESC", $cdUsuarioDesc$
		;ECF Concomitante / ECF Não concomitante
		if (TP_DOCTO.GER_OPERACAO = 2) | (TP_DOCTO.GER_OPERACAO = 3)
			putitem/id viParams, "IN_DIRETO", <TRUE>
		else
			putitem/id viParams, "IN_DIRETO", <FALSE>
		endif
		$keyboard = "KB_GLOBAL"
		activate "TRAFM061".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		endif	
		if ($status >= 0) | ($status = -3) ;Status -3 é pq a transacao foi bloqueada no TRAFM061
			vStatus = $status
			commit
			if ($status < 0)
				rollback
				return (-1) 
			else
				$instancehandle->SetHint("ID=APLINFO002")
			endif
			
			if (vStatus = -3)
				$instancehandle->recarregaTransacao()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif
				
				return(-1)
			endif
		else
			rollback
			return(-1)
		endif

		if (TP_DOCTO.GER_OPERACAO = 1) ;Nota Fiscal
			viParams = voParams
			if (TP_MODALIDADE.GER_OPERACAO = 4) ;Venda
				if ($tpImpressaoNFVenda$ = 01)
					putitem/id viParams, "IN_DIRETO", <FALSE>
				else
					putitem/id viParams, "IN_DIRETO", <TRUE>
				endif
			else
				putitem/id viParams, "IN_DIRETO", <FALSE>
			endif
			$keyboard = "KB_GLOBAL"	;>-- MAC - PRJ 61 TAR 716 - 25/11/2009
			activate "FISFP008".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
			$keyboard = "KB_PDV"  ;>-- MAC - PRJ 61 TAR 716 - 25/11/2009
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
			if ($status >= 0)
				commit
				if ($status < 0)
					rollback
				else
					$instancehandle->SetHint("ID=APLINFO002")
				endif
			else
				rollback
			endif   
		endif

		;-=CANONICO=- (10/08/2011) TAR 111 PR 182 IMPRESSAO DE SALDO CREDEV ECF		
		;vInConsultaSaldoCredev = <FALSE>					
		;selectcase $tpConsultaSaldoCredev$
		;case 1 ;PERGUNTA
		;	askmess "Deseja consultar Saldo Credev?", "Sim,Não"
		;	if ($status = 1)
		;		vInConsultaSaldoCredev = <TRUE>					
		;	endif
		;case 2 ;AUTOMATICO
		;	vInConsultaSaldoCredev = <TRUE>
		;endselectcase    
		; --- DIONE |156/0641| 22/09/2011
		;if (vInConsultaSaldoCredev = <TRUE>)
		;	viParams = ""
		;	putitem/id viParams, "CD_EMPRESA"  , CD_EMPRESA.TRA_TRANSACAO
		;	putitem/id viParams, "CD_PESSOA"   , CD_PESSOA.TRA_TRANSACAO
		;	activate "TRAFC018".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		;	if ($procerror)       
		;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		;		return(-1)
		;	endif
		;endif
		; ---

		if (TP_MODALIDADE.GER_OPERACAO = 3) ;Devolução
			vDsComponente = "TRAFM068"
		else
			vDsComponente = "TRAFM066"
		endif
		activate "LOGSVCO003".GetNivelComponente($$gCdUsuario, $$gCdEmpresa, vDsComponente, $xCdNivel$, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>,$procerror,$procerrorcontext,"ADICIONAL=LOGSVCO003.GETNIVELCOMPONENTE")
		elseif ($xCdNivel$ > 0)	
			viParams = ""
			vDsLstTransacao = ""
			vDsRegistro = ""
			putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			putitem vDsLstTransacao, -1, vDsRegistro    
			putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
			activate "SICSVCO005".validaRecebimento($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				macro "^CLEAR"
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				macro "^CLEAR"
				return(-1)
			endif

			vDsLstTransacao = $item("DS_LSTTRANSACAO", voParams)
			vDsLstEncargoFin = $item("DS_LSTENCARGOFIN", voParams)

			if (vDsLstTransacao = "") & (vDsLstEncargoFin = "")
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Nenhuma transação validada para recebimento!", "")
				macro "^CLEAR"
				return(-1)
			endif

			viParams = ""
			putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
			putitem/id viParams, "DS_LSTENCARGOFIN", vDsLstEncargoFin
			activate "SICSVCO005".buscaMaxTroco($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				macro "^CLEAR"
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				macro "^CLEAR"
				return(-1)
			endif

			$tpTrocoMaximo$ = $item("TP_TROCOMAXIMO", voParams)
			vVlTrocoMaximoTra = $item("VL_TROCOMAXIMOTRA", voParams)	
			vVlTrocoMaximoEnc = $item("VL_TROCOMAXIMOENC", voParams)

			vInTrocoMaximo = <FALSE>

			if ($tpTrocoMaximo$ = 1)
				vInTrocoMaximo = <TRUE>
			elseif ($tpTrocoMaximo$ = 2)
				askmess "Utiliza controle de troco máximo?", "Sim, Não"
				if ($status = 1) 
					vInTrocoMaximo = <TRUE>
				else
					vInTrocoMaximo = <FALSE>
				endif
			endif

			if (vDsLstTransacao != "")
				viParams = ""
				putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
				putitem/id viParams, "IN_TROCOMAXIMO", vInTrocoMaximo
				putitem/id viParams, "VL_TROCOMAXIMO", vVlTrocoMaximoTra
				putitem/id viParams, "CD_EMPECF", $CdEmpEcf$
				putitem/id viParams, "NR_ECF", $NrEcf$
				putitem/id viParams, "NR_CUPOM", $NrCupom$
				if (TP_MODALIDADE.GER_OPERACAO = 3) ;Devolução
					$keyboard = "KB_GLOBAL"
					activate "TRAFM068".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
					$keyboard = "KB_PDV"
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						macro "^CLEAR"
						return(-1)
					endif	
				else
					$keyboard = "KB_GLOBAL"
					activate "TRAFM066".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
					$keyboard = "KB_PDV"
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						macro "^CLEAR"
						return(-1)
					endif
					vInFatura = $item("IN_FATURA", voParams) ;>-- MAC - PRJ 102/926 - 27/08/2010 ---
					$vlTroco$ = $item("VL_TROCO" , voParams) ;Hugo em 28/12/2010 Tarefa 180-32
					vDsLstNF  = $item("DS_LSTNF" , voParams) ;--Douglas Ferreira - [Prj/Tarefa 180/86] - 09/02/2011
					;-=CANONICO=- (11/08/2011) TAR 125 PRJ 186 -ERRO CONTA CORRENTE
					if ($item("CD_EMPLIQ", voParams)!= '') & ($item("DT_LIQ", voParams)!= '') & $item("NR_SEQLIQ", voParams)
						vDsRegistro = ""
						putitem/id vDsRegistro, "CD_EMPLIQ"  , $item("CD_EMPLIQ", voParams)
						putitem/id vDsRegistro, "DT_LIQ"     , $item("DT_LIQ", voParams)
						putitem/id vDsRegistro, "NR_SEQLIQ"  , $item("NR_SEQLIQ", voParams)
						vDsLstLiquidacao = ""
						putitem vDsLstLiquidacao, -1, vDsRegistro
					endif
				endif
			else
				$status = 0
			endif

			if ($status >= 0) & (vDsLstEncargoFin != "")
				viParams = ""
				putitem/id viParams, "DS_LSTTRANSACAO", vDsLstEncargoFin
				putitem/id viParams, "IN_TROCOMAXIMO", vInTrocoMaximo
				putitem/id viParams, "VL_TROCOMAXIMO", vVlTrocoMaximoEnc
				putitem/id viParams, "CD_EMPECF", $CdEmpEcf$
				putitem/id viParams, "NR_ECF", $NrEcf$
				putitem/id viParams, "NR_CUPOM", $NrCupom$
				if (TP_MODALIDADE.GER_OPERACAO = 3) ;Devolução
					$keyboard = "KB_GLOBAL"
					activate "TRAFM068".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
					$keyboard = "KB_PDV"
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						macro "^CLEAR"
						return(-1)
					endif	
				else
					$keyboard = "KB_GLOBAL"
					activate "TRAFM066".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
					$keyboard = "KB_PDV"
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						macro "^CLEAR"
						return(-1)
					endif	
					;-=CANONICO=- (11/08/2011) TAR 125 PRJ 186 -ERRO CONTA CORRENTE
					if ($item("CD_EMPLIQ", voParams)!= '') & ($item("DT_LIQ", voParams)!= '') & $item("NR_SEQLIQ", voParams)
						vDsRegistro = ""
						putitem/id vDsRegistro, "CD_EMPLIQ"  , $item("CD_EMPLIQ", voParams)
						putitem/id vDsRegistro, "DT_LIQ"     , $item("DT_LIQ", voParams)
						putitem/id vDsRegistro, "NR_SEQLIQ"  , $item("NR_SEQLIQ", voParams)
						putitem vDsLstLiquidacao, -1, vDsRegistro
					endif
				endif
			endif

			if ($status >= 0)
				commit
				if ($status < 0)
					rollback
					macro "^CLEAR"
					return(-1)
				else
					$instancehandle->SetHint("ID=APLINFO002")
				endif
			else
				rollback
				clear
				$prompt = TP_TRANSACAO.TRA_TRANSACAO
				macro "^CLEAR"
				return(-1)
			endif 
			
			;-=CANONICO=- (11/08/2011) TAR 125 PRJ 186 -ERRO CONTA CORRENTE
			if (vDsLstLiquidacao != '') & ($cdModImpRecebTra$ > 0)
				repeat
					getitem vDsRegistro, vDsLstLiquidacao , 1

					viParams = ""
					putitem/id viParams, "CD_EMPLIQ", $item("CD_EMPLIQ", vDsRegistro)
					putitem/id viParams, "DT_LIQ", $item("DT_LIQ", vDsRegistro)
					putitem/id viParams, "NR_SEQLIQ", $item("NR_SEQLIQ", vDsRegistro)
					putitem/id viParams, "CD_MODFIN", $cdModImpRecebTra$
					putitem/id viParams, "IN_FATURAMENTO", <TRUE>
					activate "FCRFF002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					endif

					delitem vDsLstLiquidacao , 1
				until (vDsLstLiquidacao = "")	
			endif			

			;Hugo em 28/12/2010 Tarefa 180-32
			vInMostraTroco = $item("IN_MOSTRA_TROCO_RECEB", $xlplemp$)
			
			if (vInMostraTroco = <TRUE>) & (TP_MODALIDADE.GER_OPERACAO != 3) & ($vlTroco$ != 0) ;Devolução
				message/info "VALOR TROCO: R$ %%$vlTroco$%%%"
			endif
			;
			;--Douglas Ferreira - [Prj/Tarefa 180/86] - 09/02/2011
			if (vDsLstNF != "")
				viParams = ""
				putitem/id viParams, "DS_LSTNF"             , vDsLstNF
				putitem/id viParams, "IN_GERA_NFE_AUTOMATIC", <TRUE>
				activate "FISFP042".EXEC(viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif
			endif
			;			
			;>-- MAC - PRJ 102/926 - 27/08/2010 ---
			if (vDsLstTransacao != "") & ($tpImpRichTextVD$ = 1) & ($cdModRichTextVD$ != "") & (vInFatura = <TRUE>)

				viParams = ""
				putitem/id viParams, "CD_EMPRESA"   , CD_EMPRESA.TRA_TRANSACAO
				putitem/id viParams, "DT_TRANSACAO" , DT_TRANSACAO.TRA_TRANSACAO
				putitem/id viParams, "NR_TRANSACAO" , NR_TRANSACAO.TRA_TRANSACAO
				putitem/id viParams, "CD_MODELO"    , "TRA"
				putitem/id viParams, "CD_RICHTEXT"  , $cdModRichTextVD$
				activate "TRAFP061".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				endif
			endif
			;--<
		endif
		
		; --- DIONE |156/0641| 22/09/2011
		vInConsultaSaldoCredev = <FALSE>					
		selectcase $tpConsultaSaldoCredev$
		case 1 ;PERGUNTA
			askmess "Deseja consultar Saldo Credev?", "Sim,Não"
			if ($status = 1)
				vInConsultaSaldoCredev = <TRUE>					
			endif
		case 2 ;AUTOMATICO
			vInConsultaSaldoCredev = <TRUE>
		endselectcase  
		if (vInConsultaSaldoCredev = <TRUE>)
			viParams = ""
			putitem/id viParams, "CD_EMPRESA"  , CD_EMPRESA.TRA_TRANSACAO
			putitem/id viParams, "CD_PESSOA"   , CD_PESSOA.TRA_TRANSACAO
			activate "TRAFC018".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			endif
		endif
		; ---

		viParams = ""
		putitem/id viParams, "LST_EMPRESA", $item("CD_EMPRESA", $$gParamGlb)
		activate "FCXSVCO001".buscarSaldoCaixaUsuario($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		
		vInSangria = $item("IN_SANGRIA", voParams)
		
		if (vInSangria = <TRUE>)
			message/info "<<<< ATENÇÃO >>>>%%^%%^Efetuar sangria de caixa!"
		endif
	endif

	clear
	macro "^CLEAR"
	
	return(0)
end

;------------------------------
partner operation carregaListas
;------------------------------
	variables
		string viParams, voParams, vDsLstOperacao
		numeric vCdEmpresa, vCdUsuario
	endvariables
	
	vCdEmpresa = $item("CD_EMPRESA", $$gParamGlb)
	vCdUsuario = $item("CD_USUARIO", $$gParamGlb)
	
	vDsLstOperacao = ""
	clear/e "ADM_USUOPERCMP"
	CD_EMPRESA.ADM_USUOPERCMP/init = vCdEmpresa
	CD_USUARIO.ADM_USUOPERCMP/init = vCdUsuario
	CD_COMPONENTE.ADM_USUOPERCMP/init = $componentname
	retrieve/e "ADM_USUOPERCMP"
	if ($status >= 0)
		$tpTransacaoPadrao$ = 0
		$qtOperacao$ = 0
		setocc "ADM_USUOPERCMP", 1
		while ($status >=0)
			if (CD_OPERACAO.ADM_USUOPERCMP = $cdOperacaoVenda$)
				putitem vDsLstOperacao, -1, "1=Venda"
				$qtOperacao$ = $qtOperacao$ + 1
				if ($tpTransacaoPadrao$ = 0)
					$tpTransacaoPadrao$ = 1
				endif
			elseif (CD_OPERACAO.ADM_USUOPERCMP = $cdOperacaoValeTroca$)				
				putitem vDsLstOperacao, -1, "2=Vale troca"
				$qtOperacao$ = $qtOperacao$ + 1
				if ($tpTransacaoPadrao$ = 0)
					$tpTransacaoPadrao$ = 2
				endif
			elseif (CD_OPERACAO.ADM_USUOPERCMP = $cdOperacaoTroca$)
				putitem vDsLstOperacao, -1, "3=Troca"
				$qtOperacao$ = $qtOperacao$ + 1
				if ($tpTransacaoPadrao$ = 0)
					$tpTransacaoPadrao$ = 3
				endif
			endif
			setocc "ADM_USUOPERCMP", $curocc("ADM_USUOPERCMP") + 1
		endwhile
		if (vDsLstOperacao = "")
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Usuário %%vCdUsuario não possui permissão em nenhuma das operações utilizadas por este componente(%%$cdOperacaoVenda$ / %%$cdOperacaoValeTroca$ / %%$cdOperacaoTroca$%%%)!", "")
			return(-1)
		else
			$valrep(TP_TRANSACAO.TRA_TRANSACAO) = vDsLstOperacao	
		endif		
	else
		$tpTransacaoPadrao$ = 1
		$qtOperacao$ = 3
	endif

	TP_TRANSACAO.TRA_TRANSACAO = $tpTransacaoPadrao$

	return(0)
end

;--------------------------------
partner operation posicionaCursor
	;--------------------------------
	variables
		boolean vInCodigo
	endvariables
	
	if ($empty("TRA_TRANSITEM") = 0)
		setocc "TRA_TRANSITEM", -1
		$prompt = NR_ITEM.TRA_TRANSITEM
	endif        
	
	vInCodigo = IN_CODIGO.SIS_FILTRO
	clear/e "SIS_FILTRO"
	IN_CODIGO.SIS_FILTRO = vInCodigo
	
	if (TP_INCLUSAO.TRA_TRANSACAO = "QUANTIDADE")
		QT_SOLICITADA.SIS_FILTRO = ""
		fieldsyntax QT_SOLICITADA.SIS_FILTRO, ""    
		$prompt = QT_SOLICITADA.SIS_FILTRO
	else
		QT_SOLICITADA.SIS_FILTRO = 1
		fieldsyntax QT_SOLICITADA.SIS_FILTRO, "DIM"    
		$prompt = CD_BARRAPRD.SIS_FILTRO
	endif
	
	return(0)
end

;-------------------------------
partner operation validaVendedor
;-------------------------------
	variables
		string  viParams, voParams, vDsErro
	endvariables
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "CD_AUXILIAR", CD_AUXILIAR.PES_VENDEDOR
	activate "PESSVCO015".validaVendedor($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		vDsErro = $item("DESCRICAO", $xCtxErro$)
		vDsErro = "%%vDsErro%%^%%%Continuar?"
		repeat
			askmess vDsErro, "Não, Sim"
		until ($status = 2)
		$prompt = CD_AUXILIAR.PES_VENDEDOR
		return(-1)
	endif  

	clear/e "PES_VENDEDOR"
	CD_VENDEDOR.PES_VENDEDOR/init = $item("CD_VENDEDOR", voParams)
	retrieve/e "PES_VENDEDOR"
	
	return(0)
end

;---------------------------
partner operation validaItem
;---------------------------

	variables
		string  viParams, voParams, vDsErro, vDsRegistro, vDsLstProduto, vCdEmpresa, vDsTrasvco004
		numeric vNrItem, vCdProduto, vQtEmbalagem, vCdGrupoEmpresa, vVlTransacao, vTpValidaVendedor, vQtSolicitada, vVlUnitLiquido
		numeric vInLimiteCredito
		boolean vInValidaItem
	endvariables

	vInValidaItem = <TRUE>
	vInLimiteCredito = $item("IN_LIMITE_CREDITO_ITEM_VD", $xlplemp$)
	
	if (IN_CODIGO.SIS_FILTRO != <TRUE>)
		viParams = ""
		putitem/id viParams, "CD_BARRAPRD", CD_BARRAPRD.SIS_FILTRO
		putitem/id viParams, "IN_CODIGO", IN_CODIGO.SIS_FILTRO
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		activate "PRDSVCO004".verificaProduto($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
			return(-1)
		elseif ($xCdErro$)
			vDsErro = $item("DESCRICAO", $xCtxErro$)
			vDsErro = "%%vDsErro%%^%%%Continuar?"
			repeat
				askmess vDsErro, "Não, Sim"
			until ($status = 2)
			CD_BARRAPRD.SIS_FILTRO = CD_BARRAPRD.SIS_FILTRO
			$prompt = CD_BARRAPRD.SIS_FILTRO 
			return(-1)
		else
			vDsLstProduto = $item("DS_LSTPRODUTO", voParams)
			if (vDsLstProduto != "")
				vInValidaItem = <FALSE>
				
				repeat
					getitem vDsRegistro, vDsLstProduto, 1
					
					vCdProduto = $item("CD_PRODUTO", vDsRegistro)
					vQtEmbalagem = $item("QT_PRODUTO", vDsRegistro)
					vQtEmbalagem = vQtEmbalagem * QT_SOLICITADA.SIS_FILTRO
					
					viParams = ""
					;>-- MAC - PRJ 156/395 - 16/09/2010 ---
					if ($tpBuscaVlValeTroca$ = 1) & (TP_MODALIDADE.GER_OPERACAO = 3) & (TP_OPERACAO.TRA_TRANSACAO = "E") ;Entrada de devolução
						viParams = ""
						putitem/id viParams, "CD_EMPRESA"  , CD_EMPRESA.TRA_TRANSACAO
						putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
						putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
						putitem/id viParams, "CD_PRODUTO"  , vCdProduto
						putitem/id viParams, "IN_CODIGO", <TRUE> ;Codigo de Produto e Nao de Barras
						$keyboard = "KB_GLOBAL"
						activate "TRAFP062".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
						$keyboard = "KB_PDV"
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						endif

						viParams = ""
						putitem/id viParams, "VL_BRUTO"    , $item("VL_UNITBRUTO"   , voParams)
						putitem/id viParams, "VL_DESCONTO" , $item("VL_UNITDESC"    , voParams)
						putitem/id viParams, "VL_LIQUIDO"  , $item("VL_UNITLIQUIDO" , voParams)
					endif
					;--<
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
					putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
					putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
					putitem/id viParams, "CD_BARRAPRD", vCdProduto
					putitem/id viParams, "IN_CODIGO", <TRUE> ;Codigo de Produto e Nao de Barras
;					if (TP_INCLUSAO.TRA_TRANSACAO = "QUANTIDADE")
						putitem/id viParams, "QT_SOLICITADA", vQtEmbalagem
;					endif
					putitem/id viParams, "CD_CFOP", CD_CFOP.TRA_TRANSACAO
					putitem/id viParams, "CD_CST", CD_CST.TRA_TRANSACAO
					putitem/id viParams, "CD_TABPRECO", $cdTabPreco$ ;---Elia Proj. 102/317 11/06/08
					activate "TRASVCO004".validaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						vDsErro = $item("DESCRICAO", $xCtxErro$)
						vDsErro = "%%vDsErro%%^%%%Continuar?"
						repeat
							askmess vDsErro, "Não, Sim"
						until ($status = 2)
						CD_BARRAPRD.SIS_FILTRO = CD_BARRAPRD.SIS_FILTRO
						$prompt = CD_BARRAPRD.SIS_FILTRO 
						return(-1)
					endif 

					;---Elia Proj. 102/337 27/06/08
					vDsTrasvco004 = voParams
					if (TP_TRANSACAO.TRA_TRANSACAO = 2) & ($inValidaPrdValeTroca$ = <TRUE>);2 - Valetroca
						;---Elia Proj. 102/351 11/07/08 Comentada a logica para nao fazer a verificacao por empresa
						;clear/e "GER_EMPRESA"
						;CD_EMPRESA.GER_EMPRESA/init = CD_EMPRESA.TRA_TRANSACAO
						;retrieve/e "GER_EMPRESA"
						;if ($status >= 0)
						;	vCdGrupoEmpresa = CD_GRUPOEMPRESA.GER_EMPRESA
						;	clear/e "GER_EMPRESA"
						;	CD_GRUPOEMPRESA.GER_EMPRESA/init = vCdGrupoEmpresa
						;	retrieve/e "GER_EMPRESA"
						;	if ($status >= 0)
						;		setocc "GER_EMPRESA", -1
						;		setocc "GER_EMPRESA", 1
						;		putlistitems vCdEmpresa, CD_EMPRESA.GER_EMPRESA
						;	endif
						;endif
		
						clear/e "V_FIS_NFITEMPROD"
						;CD_EMPFAT.V_FIS_NFITEMPROD/init = vCdEmpresa
						CD_PRODUTO.V_FIS_NFITEMPROD/init = vCdProduto
						CD_PESSOA.V_FIS_NFITEMPROD/init = CD_PESSOA.TRA_TRANSACAO
						TP_OPERACAO.V_FIS_NFITEMPROD/init = "S"
						TP_MODALIDADE.V_FIS_NFITEMPROD/init = "4"
							TP_SITUACAO.V_FIS_NFITEMPROD/init = "N·;E"
						retrieve/e "V_FIS_NFITEMPROD"
						if ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Produto %%vCdProduto nunca foi vendido para este cliente!", "")
							viParams = ""
							putitem/id viParams, "CD_COMPONENTE", $componentname
							putitem/id viParams, "DS_CAMPO", "IN_LIBERA_VALETROCA"
							putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $$gParamGlb)
							putitem/id viParams, "CD_USUARIO", $item("CD_USUARIO", $$gParamGlb)
							putitem/id viParams, "VL_VALOR", ""
							activate "ADMSVCO009".verificaRestricao(viParams, voParams, $xCdErro$, $xCtxerro$)
							if ($procerror)       
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Usuário com restrição para executar processo.%%^Restrição - IN_LIBERA_VALETROCA", "")
								$prompt = CD_BARRAPRD.SIS_FILTRO
								return(-1)
							endif
						endif
		
					;	clear/e "GER_EMPRESA" ;; Marcus Vinicius - 156/384 - 02/08/2010
						clear/e "V_FIS_NFITEMPROD"
					endif
						
					if (vInLimiteCredito > 0) & ($vlLimite$ != "")
						vVlTransacao = VL_TRANSACAO.TRA_TRANSACAO + $item("VL_TOTALLIQUIDO", vDsTrasvco004)
						
						if (vVlTransacao > $vlLimite$)
							if (vInLimiteCredito = 1)
								askmess/question "Limite do cliente ultrapassado. Deseja continuar?", "Não,Sim"
								if ($status = 1)
									$prompt = CD_BARRAPRD.SIS_FILTRO
									return(-1)
								endif
							elseif (vInLimiteCredito = 2)
								viParams = ""
								putitem/id viParams, "CD_COMPONENTE", $componentname
								putitem/id viParams, "DS_CAMPO", "IN_LIBERA_LIMITE"                   
								putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA" ,$$gParamGlb)
								putitem/id viParams, "CD_USUARIO", $item("CD_USUARIO" ,$$gParamGlb)
								putitem/id viParams, "VL_VALOR", ""    
								activate "ADMSVCO009".VerificaRestricao(viParams, voParams, $xCdErro$, $xCtxerro$)
								if ($procerror)       
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Limite do cliente ultrapassado. Usuário com restrição para executar processo.%%^Restrição - IN_LIBERA_LIMITE", "")
									return(-1)
								endif	
							endif
						endif
					endif
			
					;viParams = voParams
					viParams =	vDsTrasvco004
					;
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
					putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
					putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
					;-=LSC=- (14/04/2008) TAR 280 PRJ 102 - ITEM ECF CONCOMITANTE NAO PERDER A SEQUENCIA
					if (TP_DOCTO.GER_OPERACAO = 3)
						$vNrItem$ = $vNrItem$ + 1
						putitem/id viParams, "NR_ITEM", $vNrItem$
					endif
					;
					activate "TRASVCO004".gravaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif  

					;Mendes - PRJ=156/TAR=682 - 23/11/2011
					if ($item("DS_MENSAGEM", voParams) != "")
						message/info "%%$item("DS_MENSAGEM", voParams)"
					endif
					;;;
				 	
					vNrItem = $item("NR_ITEM",voParams)

					;FIUZA 20/12/05 - IMPRESSAO ECF CONCOMITANTE
					if (TP_DOCTO.GER_OPERACAO = 3)
						if ($InCupomAberto$ = "S")
							viParams = ""
							putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
							putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
							putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
							putitem/id viParams, "NR_ITEM", vNrItem		
							activate "ECFSVCO010".lancaItemConcomitante($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
							if ($procerror)       
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status = -10)
								viParams = ""
								voParams = ""
								putitem/id viParams,"TITULO", "Erro de comunicação com a ECF"
								putitem/id viParams,"MENSAGEM", $item("DESCRICAO",$xctxerro$)
								activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
								if ($procerror)       
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									rollback
									return(-1)
								endif
								rollback
								$prompt = CD_BARRAPRD.SIS_FILTRO
								return(-1)
							elseif ($status = -50)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								apexit
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								rollback
								$prompt = CD_BARRAPRD.SIS_FILTRO
								return(-1)
							endif
						endif
			
						creocc "TMP_NR09", -1
						NR_GERAL.TMP_NR09 = vNrItem
					endif
					
					commit
					if ($status < 0)
						rollback
						return (-1) 
					else
						$instancehandle->SetHint("ID=APLINFO002")
					endif

					clear/e "SIS_PRODUTO"
					;MARTINEZ - PRJ/TAR 182/042 - 15/04/2011
					;CD_PRODUTO.SIS_PRODUTO = $item("CD_PRODUTO", viParams)
					;DS_PRODUTO.SIS_PRODUTO = $item("DS_PRODUTO", viParams)
					;QT_SOLICITADA.SIS_PRODUTO = $item("QT_SOLICITADA", viParams)
					;VL_UNITARIO.SIS_PRODUTO = $item("VL_UNITLIQUIDO", viParams)
					;VL_TOTAL.SIS_PRODUTO = $item("VL_TOTALLIQUIDO", viParams)
					CD_PRODUTO.SIS_PRODUTO = $item("CD_PRODUTO", vDsTrasvco004)
					DS_PRODUTO.SIS_PRODUTO = $item("DS_PRODUTO", vDsTrasvco004)
					QT_SOLICITADA.SIS_PRODUTO = $item("QT_SOLICITADA", vDsTrasvco004)
					VL_UNITARIO.SIS_PRODUTO = $item("VL_UNITLIQUIDO", vDsTrasvco004)
					VL_TOTAL.SIS_PRODUTO = $item("VL_TOTALLIQUIDO", vDsTrasvco004)
					;

					if ($inImagem$ = <TRUE>)
						clear/e "PRD_PRDIMAGEM"
						CD_PRODUTO.PRD_PRDIMAGEM/init = CD_PRODUTO.SIS_PRODUTO
						IN_PADRAO.PRD_PRDIMAGEM/init = <TRUE>
						retrieve/e "PRD_PRDIMAGEM"
						if ($status >= 0)
							CD_IMAGEM.SIS_PRODUTO/init = CD_IMAGEM.PRD_PRDIMAGEM
						else
							clear/e "PRD_PRDIMAGEM"
							CD_PRODUTO.PRD_PRDIMAGEM/init = CD_PRODUTO.SIS_PRODUTO
							retrieve/e "PRD_PRDIMAGEM"
							if ($status >= 0)
								CD_IMAGEM.SIS_PRODUTO/init = CD_IMAGEM.PRD_PRDIMAGEM
							endif
						endif
					endif
					
					if (TP_MODALIDADE.GER_OPERACAO = 5) ;Outras Saídas/Entradas
						setocc "TRA_TRANSITEM", -1
						$instancehandle->alteraItem()
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						endif
					endif
								
					delitem vDsLstProduto, 1
				until (vDsLstProduto = "")
				
				$instancehandle->recarregaTransacao()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif
			endif
		endif
	endif
	
	if (vInValidaItem = <TRUE>)
		viParams = ""
		;>-- MAC - PRJ 156/395 - 16/09/2010 ---
		if ($tpBuscaVlValeTroca$ = 1) & (TP_MODALIDADE.GER_OPERACAO = 3) & (TP_OPERACAO.TRA_TRANSACAO = "E") ;Entrada de devolução
			viParams = ""
			putitem/id viParams, "CD_EMPRESA"  , CD_EMPRESA.TRA_TRANSACAO
			putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "CD_PRODUTO"  , CD_BARRAPRD.SIS_FILTRO
			putitem/id viParams, "IN_CODIGO"   , IN_CODIGO.SIS_FILTRO
			$keyboard = "KB_GLOBAL"
			activate "TRAFP062".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
			$keyboard = "KB_PDV"
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				return(-1)
			endif

			viParams = ""
			putitem/id viParams, "VL_BRUTO"    , $item("VL_UNITBRUTO"   , voParams)
			putitem/id viParams, "VL_DESCONTO" , $item("VL_UNITDESC"    , voParams)
			putitem/id viParams, "VL_LIQUIDO"  , $item("VL_UNITLIQUIDO" , voParams)
		endif
		;--<
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "CD_BARRAPRD", CD_BARRAPRD.SIS_FILTRO
		putitem/id viParams, "IN_CODIGO", IN_CODIGO.SIS_FILTRO
		if (TP_INCLUSAO.TRA_TRANSACAO = "QUANTIDADE")
			putitem/id viParams, "QT_SOLICITADA", QT_SOLICITADA.SIS_FILTRO
		endif
		putitem/id viParams, "CD_CFOP", CD_CFOP.TRA_TRANSACAO
		putitem/id viParams, "CD_CST", CD_CST.TRA_TRANSACAO
		putitem/id viParams, "CD_TABPRECO", $cdTabPreco$ ;---Elia Proj. 102/317 11/06/08
		activate "TRASVCO004".validaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			vDsErro = $item("DESCRICAO", $xCtxErro$)
			vDsErro = "%%vDsErro%%^%%%Continuar?"
			repeat
				askmess vDsErro, "Não, Sim"
			until ($status = 2)
			CD_BARRAPRD.SIS_FILTRO = CD_BARRAPRD.SIS_FILTRO
			$prompt = CD_BARRAPRD.SIS_FILTRO 
			return(-1)
		endif    

		;---Elia Proj. 102/337 27/06/08
		vDsTrasvco004 = voParams
		vCdProduto = $item("CD_PRODUTO", voParams)
		vVlUnitLiquido = $item("VL_UNITLIQUIDO", voParams)
		vQtSolicitada = $item("QT_SOLICITADA", voParams)

		if (TP_TRANSACAO.TRA_TRANSACAO = 2) & ($inValidaPrdValeTroca$ = <TRUE>); 2 - Valetroca
			;---Elia Proj. 102/351 11/07/08 Comentada a logica para nao fazer a verificacao por empresa
			;clear/e "GER_EMPRESA"
			;CD_EMPRESA.GER_EMPRESA/init = CD_EMPRESA.TRA_TRANSACAO
			;retrieve/e "GER_EMPRESA"
			;if ($status >= 0)
			;	vCdGrupoEmpresa = CD_GRUPOEMPRESA.GER_EMPRESA
			;	clear/e "GER_EMPRESA"
			;	CD_GRUPOEMPRESA.GER_EMPRESA/init = vCdGrupoEmpresa
			;	retrieve/e "GER_EMPRESA"
			;	if ($status >= 0)
			;		setocc "GER_EMPRESA", -1
			;		setocc "GER_EMPRESA", 1
			;		putlistitems vCdEmpresa, CD_EMPRESA.GER_EMPRESA
			;	endif
			;endif
		
			clear/e "V_FIS_NFITEMPROD"
			;CD_EMPFAT.V_FIS_NFITEMPROD/init = vCdEmpresa
			CD_PRODUTO.V_FIS_NFITEMPROD/init = vCdProduto
			CD_PESSOA.V_FIS_NFITEMPROD/init = CD_PESSOA.TRA_TRANSACAO
			TP_OPERACAO.V_FIS_NFITEMPROD/init = "S"
			TP_MODALIDADE.V_FIS_NFITEMPROD/init = "4"
			TP_SITUACAO.V_FIS_NFITEMPROD/init = "N·;E"
			retrieve/e "V_FIS_NFITEMPROD"
			if ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Produto %%vCdProduto nunca foi vendido para este cliente!", "")
				viParams = ""
				putitem/id viParams, "CD_COMPONENTE", $componentname
				putitem/id viParams, "DS_CAMPO", "IN_LIBERA_VALETROCA"
				putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $$gParamGlb)
				putitem/id viParams, "CD_USUARIO", $item("CD_USUARIO", $$gParamGlb)
				putitem/id viParams, "VL_VALOR", ""
				activate "ADMSVCO009".verificaRestricao(viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Usuário com restrição para executar processo.%%^Restrição - IN_LIBERA_VALETROCA", "")
					$prompt = CD_BARRAPRD.SIS_FILTRO
					return(-1)
				endif
			endif
		;	clear/e "GER_EMPRESA" ;; Marcus Vinicius - 156/384 - 02/08/2010
			clear/e "V_FIS_NFITEMPROD"
		endif
		
		;Tarefa 102-939 Hugo em 14/09/2010
		if (TP_OPERACAO.GER_OPERACAO = "S") ; S - Saida
			if ($tpCoeficientePrdVd$ = 01) & (TP_MODALIDADE.GER_OPERACAO = 4)
				$instancehandle->validaItemCoeficiente(vCdProduto, vVlUnitLiquido, vQtSolicitada)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					$prompt = CD_BARRAPRD.SIS_FILTRO
					return (-1)
				elseif ($status < 0)
					$prompt = CD_BARRAPRD.SIS_FILTRO
					return (-1)
				endif
				
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
				putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
				putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
				putitem/id viParams, "CD_BARRAPRD", vCdProduto
				putitem/id viParams, "IN_CODIGO", <TRUE>
				putitem/id viParams, "QT_SOLICITADA", vQtSolicitada
				putitem/id viParams, "CD_CFOP", CD_CFOP.TRA_TRANSACAO
				putitem/id viParams, "CD_CST", CD_CST.TRA_TRANSACAO
				putitem/id viParams, "VL_BRUTO", vVlUnitLiquido
				putitem/id viParams, "VL_LIQUIDO", vVlUnitLiquido
				putitem/id viParams, "CD_TABPRECO", $cdTabPreco$ ;---Elia Proj. 102/317 11/06/08
				activate "TRASVCO004".validaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				endif
				
				vDsTrasvco004 = voParams
			endif
		endif
		;
		
		if (vInLimiteCredito > 0) & ($vlLimite$ != "")
			vVlTransacao = VL_TRANSACAO.TRA_TRANSACAO + $item("VL_TOTALLIQUIDO", vDsTrasvco004)
			
			if (vVlTransacao > $vlLimite$)
				if (vInLimiteCredito = 1)
					askmess/question "Limite do cliente ultrapassado. Deseja continuar?", "Não,Sim"
					if ($status = 1)
						$prompt = CD_BARRAPRD.SIS_FILTRO
						return(-1)
					endif
				elseif (vInLimiteCredito = 2)
					viParams = ""
					putitem/id viParams, "CD_COMPONENTE", $componentname
					putitem/id viParams, "DS_CAMPO", "IN_LIBERA_LIMITE"                   
					putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA" ,$$gParamGlb)
					putitem/id viParams, "CD_USUARIO", $item("CD_USUARIO" ,$$gParamGlb)
					putitem/id viParams, "VL_VALOR", ""    
					activate "ADMSVCO009".VerificaRestricao(viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN001", "DESCRICAO=Limite do cliente ultrapassado. Usuário com restrição para executar processo.%%^Restrição - IN_LIBERA_LIMITE", "")
						return(-1)
					endif	
				endif
			endif
		endif
		
		;viParams = voParams
		viParams =	vDsTrasvco004
		;		
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		;-=LSC=- (14/04/2008) TAR 280 PRJ 102 - ITEM ECF CONCOMITANTE NAO PERDER A SEQUENCIA
		if (TP_DOCTO.GER_OPERACAO = 3)
			$vNrItem$ = $vNrItem$ + 1
			putitem/id viParams, "NR_ITEM", $vNrItem$
		endif
		;
		activate "TRASVCO004".gravaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif  

		;Mendes - PRJ=156/TAR=682 - 23/11/2011
		if ($item("DS_MENSAGEM", voParams) != "")
			message/info "%%$item("DS_MENSAGEM", voParams)"
		endif
		;;;
	 	
		vNrItem = $item("NR_ITEM",voParams)

		;FIUZA 20/12/05 - IMPRESSAO ECF CONCOMITANTE
		if (TP_DOCTO.GER_OPERACAO = 3)
			if ($InCupomAberto$ = "S")
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
				putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
				putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
				putitem/id viParams, "NR_ITEM", vNrItem		
				activate "ECFSVCO010".lancaItemConcomitante($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status = -10)
					viParams = ""
					voParams = ""
					putitem/id viParams,"TITULO", "Erro de comunicação com a ECF"
					putitem/id viParams,"MENSAGEM", $item("DESCRICAO",$xctxerro$)
					activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						rollback
						return(-1)
					endif
					rollback
					$prompt = CD_BARRAPRD.SIS_FILTRO
					return(-1)
				elseif ($status = -50)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					apexit
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					rollback
					$prompt = CD_BARRAPRD.SIS_FILTRO
					return(-1)
				endif
			endif
			
			creocc "TMP_NR09", -1
			NR_GERAL.TMP_NR09 = vNrItem
		endif
		
		commit
		if ($status < 0)
			rollback
			return (-1) 
		else
			$instancehandle->SetHint("ID=APLINFO002")
		endif
	
		clear/e "SIS_PRODUTO"
		;MARTINEZ - PRJ/TAR 182/042 - 15/04/2011
		;CD_PRODUTO.SIS_PRODUTO = $item("CD_PRODUTO", viParams)
		;DS_PRODUTO.SIS_PRODUTO = $item("DS_PRODUTO", viParams)
		;QT_SOLICITADA.SIS_PRODUTO = $item("QT_SOLICITADA", viParams)
		;VL_UNITARIO.SIS_PRODUTO = $item("VL_UNITLIQUIDO", viParams)
		;VL_TOTAL.SIS_PRODUTO = $item("VL_TOTALLIQUIDO", viParams)
		CD_PRODUTO.SIS_PRODUTO = $item("CD_PRODUTO", vDsTrasvco004)
		DS_PRODUTO.SIS_PRODUTO = $item("DS_PRODUTO", vDsTrasvco004)
		QT_SOLICITADA.SIS_PRODUTO = $item("QT_SOLICITADA", vDsTrasvco004)
		VL_UNITARIO.SIS_PRODUTO = $item("VL_UNITLIQUIDO", vDsTrasvco004)
		VL_TOTAL.SIS_PRODUTO = $item("VL_TOTALLIQUIDO", vDsTrasvco004)
		;
		
		if($inImagem$ = <TRUE>)
			clear/e "PRD_PRDIMAGEM"
			CD_PRODUTO.PRD_PRDIMAGEM/init = CD_PRODUTO.SIS_PRODUTO
			IN_PADRAO.PRD_PRDIMAGEM/init = <TRUE>
			retrieve/e "PRD_PRDIMAGEM"
			if ($status >= 0)
				CD_IMAGEM.SIS_PRODUTO/init = CD_IMAGEM.PRD_PRDIMAGEM
			else
				clear/e "PRD_PRDIMAGEM"
				CD_PRODUTO.PRD_PRDIMAGEM/init = CD_PRODUTO.SIS_PRODUTO
				retrieve/e "PRD_PRDIMAGEM"
				if ($status >= 0)
					CD_IMAGEM.SIS_PRODUTO/init = CD_IMAGEM.PRD_PRDIMAGEM
				endif
			endif
		endif
		$instancehandle->recarregaTransacao()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
		
		if (TP_MODALIDADE.GER_OPERACAO = 5) ;Outras Saídas/Entradas
			setocc "TRA_TRANSITEM", -1
			$instancehandle->alteraItem()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
		endif
	endif
	
	vTpValidaVendedor = $item("TP_VALIDA_VENEDOR_VD", $xlplemp$)
	
	if (vTpValidaVendedor = 1) %\
	 & ((TP_MODALIDADE.GER_OPERACAO = 4 & TP_OPERACAO.GER_OPERACAO = "S") %\ ;Venda
	 | (TP_MODALIDADE.GER_OPERACAO = 3 & TP_OPERACAO.GER_OPERACAO = "E") %\ ;Vale Troca
	 | (TP_MODALIDADE.GER_OPERACAO = 8)) ;Troca
		$cdCompVend$ = CD_COMPVEND.TRA_TRANSACAO
		
		$instancehandle->BT_05()
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
		
		$inFocoVendedor$ = <TRUE>
	endif
	
	$prompt = TP_TRANSACAO.TRA_TRANSACAO
	
	return(0)
end

;---------------------------
partner operation validaQuantidade
;---------------------------
	variables
		string vDsMsg
	endvariables

	if (QT_SOLICITADA.SIS_FILTRO > 100)
		vDsMsg = "Quantidade maior que 100%%^%%%Continuar?"
		repeat
			askmess vDsMsg, "Não, Sim"
		until ($status = 2)
	endif

	return(0)
end

;---------------------------
partner operation alteraItem
;---------------------------
	variables
		string viParams, voParams
		numeric vInLimiteCredito
	endvariables

	vInLimiteCredito = $item("IN_LIMITE_CREDITO_ITEM_VD", $xlplemp$)
	
	viParams = ""
	putlistitems/occ viParams, "TRA_TRANSITEM"
	putitem/id viParams, "TP_ALTERAITEM", TP_ALTERAITEM.TRA_TRANSACAO
	putitem/id viParams, "IN_LIMITECREDITO", vInLimiteCredito
	putitem/id viParams, "VL_LIMITE", $vlLimite$
	putitem/id viParams, "VL_TRANSACAO", VL_TRANSACAO.TRA_TRANSACAO
	$keyboard = "KB_GLOBAL"
	activate "TRAFM071".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif 

	if ($status < 0)
		return(-1)
	endif

	CD_CFOP.TRA_TRANSACAO/init = $item("CD_CFOP", voParams)
	CD_CST.TRA_TRANSACAO/init = $item("CD_CST", voParams)

	viParams = voParams
	activate "TRASVCO004".gravaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif   

	;Mendes - PRJ=156/TAR=682 - 23/11/2011
	if ($item("DS_MENSAGEM", voParams) != "")
		message/info "%%$item("DS_MENSAGEM", voParams)"
	endif
	;;;

	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif    

	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif	

	$prompt = TP_TRANSACAO.TRA_TRANSACAO
	
	return(0)
end

;---------------------------
partner operation agrupaItem
;---------------------------
	params
		boolean vInConfirmacao : IN
	endparams

	variables
		string  viParams, voParams, vDsErro
	endvariables

	if (TP_DOCTO.GER_OPERACAO = 3) ;ECF concomitante
		return(0)
	endif
	
	if (vInConfirmacao = <TRUE>)
		askmess "Deseja agrupar os itens da transação?", "Sim, Não"
		if ($status = 2) 
			return(-1)
		endif        
	endif
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "TRASVCO010".agrupaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif   
	
	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif    
	
	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif
	
	return(0)
end

;-------------------------------
partner operation relacionaTroca
;-------------------------------
	variables
		string viParams, voParams, vDsRegTroca
		numeric vCdEmpresaDev, vNrTransacaoDev
		date vDtTransacaoDev
	endvariables

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	$keyboard = "KB_GLOBAL"
	activate "TRAFM082".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif
	if ($status < 0)
		return(-1)
	endif

	vCdEmpresaDev = $item("CD_EMPRESA", voParams)
	vNrTransacaoDev = $item("NR_TRANSACAO", voParams)
	vDtTransacaoDev = $item("DT_TRANSACAO", voParams)

	if (vNrTransacaoDev = 0)
		return(-1)
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPDEV", vCdEmpresaDev
	putitem/id viParams, "NR_TRADEV", vNrTransacaoDev
	putitem/id viParams, "DT_TRADEV", vDtTransacaoDev
	putitem/id viParams, "CD_EMPVEN", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRAVEN", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRAVEN", DT_TRANSACAO.TRA_TRANSACAO
	activate "TRASVCO016".gravaTrocaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

;	Esta alteracao ficou no final(F11)
;	viParams = ""
;	putitem/id viParams "CD_EMPRESA", vCdEmpresaDev
;	putitem/id viParams "NR_TRANSACAO", vNrTransacaoDev
;	putitem/id viParams "DT_TRANSACAO", vDtTransacaoDev
;	putitem/id viParams "CD_COMPVEND", CD_COMPVEND.TRA_TRANSACAO
;	activate "TRASVCO004".alteraVendedorTransacaoNF($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
;	if($procerror)
;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;		return(-1)
;	elseif ($status < 0)
;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;		return(-1)
;	endif	

	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif

	return(0)
end

;-----------------------------------
partner operation recarregaTransacao
;-----------------------------------
	variables
		string vTpFoco, vTpInclusao, vTpAlteraItem, vDsProduto
		numeric vCdEmpresa, vNrTransacao, vNrOcc, vTpTransacao, vCdPessoa
		numeric vCdProduto, vCdImagem, vQtSolicitada, vVlUnitario, vVlTotal
		date vDtTransacao
		boolean vInCodigo
	endvariables    
	
	vCdEmpresa = CD_EMPRESA.TRA_TRANSACAO
	vNrTransacao = NR_TRANSACAO.TRA_TRANSACAO
	vDtTransacao = DT_TRANSACAO.TRA_TRANSACAO
	vCdPessoa = CD_PESSOA.TRA_TRANSACAO
	vTpFoco = TP_FOCO.TRA_TRANSACAO
	vTpInclusao = TP_INCLUSAO.TRA_TRANSACAO
	vTpAlteraItem = TP_ALTERAITEM.TRA_TRANSACAO
	vTpTransacao = TP_TRANSACAO.TRA_TRANSACAO
	vInCodigo = IN_CODIGO.SIS_FILTRO
	vCdProduto = CD_PRODUTO.SIS_PRODUTO
	vDsProduto = DS_PRODUTO.SIS_PRODUTO
	vCdImagem = CD_IMAGEM.SIS_PRODUTO
	vQtSolicitada = QT_SOLICITADA.SIS_PRODUTO
	vVlUnitario = VL_UNITARIO.SIS_PRODUTO
	vVlTotal = VL_TOTAL.SIS_PRODUTO
	vNrOcc = $curocc("TRA_TRANSITEM")
	
	clear/e "TRA_TRANSACAO"
	CD_EMPRESA.TRA_TRANSACAO/init = vCdEmpresa
	NR_TRANSACAO.TRA_TRANSACAO/init = vNrTransacao
	DT_TRANSACAO.TRA_TRANSACAO/init = vDtTransacao
	retrieve/e "TRA_TRANSACAO"
	if ($status >= 0)
		TP_FOCO.TRA_TRANSACAO/init = vTpFoco
		TP_INCLUSAO.TRA_TRANSACAO/init = vTpInclusao
		TP_ALTERAITEM.TRA_TRANSACAO/init = vTpAlteraItem
		TP_TRANSACAO.TRA_TRANSACAO/init = vTpTransacao
		IN_CODIGO.SIS_FILTRO/init = vInCodigo
		CD_PRODUTO.SIS_PRODUTO/init = vCdProduto
		DS_PRODUTO.SIS_PRODUTO/init = vDsProduto
		CD_IMAGEM.SIS_PRODUTO/init = vCdImagem
		QT_SOLICITADA.SIS_PRODUTO/init = vQtSolicitada
		VL_UNITARIO.SIS_PRODUTO/init = vVlUnitario
		VL_TOTAL.SIS_PRODUTO/init = vVlTotal
		if (CD_IMAGEM.SIS_PRODUTO > 0)
			clear/e "PRD_IMAGEM"
			CD_IMAGEM.PRD_IMAGEM/init = CD_IMAGEM.SIS_PRODUTO
			retrieve/e "PRD_IMAGEM"
			if ($status >= 0)
				DS_IMAGEM.SIS_IMAGEM/init = DS_ARQUIVO.PRD_IMAGEM
			endif
		endif
		
		if (vCdPessoa != CD_PESSOA.TRA_TRANSACAO) & (CD_PESSOA.TRA_TRANSACAO != $cdCliente$)
			$instancehandle->buscaAniversario()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
		endif
		
		setocc "TRA_TRANSITEM", vNrOcc
	endif

	;* Claudemir - Prj/Tarefa: 191/1 - 27/09/2011
	; permitir desconto no cupom concomitante
	;; --- DIONE |102/0961| 14/10/2010
	;; Cupom Concomitante desabilita desconto por item.	
	;if(TP_DOCTO.GER_OPERACAO = 3) 
	;	fieldsyntax BT_F6.SIS_BOTOES, "DIM"
	;	$inF6$ = <FALSE>
	;endif
	;; ---  ;*

	return(0)
end

;-------------------------------------
partner operation carregaDadosIniciais
;-------------------------------------
	variables
		string viParams, voParams
	endvariables

	if($inConferente$ = 1);se o parametro estiver habilitado para usar o conferente
		if ($item("CD_USUCONF", $$gParamGlb) < 1)
			$keyboard = "KB_GLOBAL"
			activate "GERFM039".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
			$keyboard = "KB_PDV"
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			endif
			if($status < 0)
				exit(-1)
			endif
		endif
		if ($item("CD_USUCONF", $$gParamGlb) >= 1);carrega a descricao do confenrente
			clear/e "ADM_USUARIO"
			CD_USUARIO.ADM_USUARIO/init = $item("CD_USUCONF", $$gParamGlb)
			retrieve/e "ADM_USUARIO"
;			$dsConferente$ = NM_LOGIN.ADM_USUARIO
			if($status >= 0)
			;--->MNT - Prj 094/1320 - 18/03/2010
				if (CD_USUARIO.ADM_USUARIO > 0)
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_USUARIO", CD_USUARIO.ADM_USUARIO
					activate "ADMSVCO027".validaUsuarioEspecial($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)	
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus("",$xCdErro$, $xCtxErro$, "")
						return(-1)
					endif

					if(voParams != "")
						$dsConferente$ = $item("NM_LOGIN", voParams)
					endif
				else
					$dsConferente$ = ""
				endif
				;<---	
			endif
		else;se não tiver conferente o conferente é o proprio caixa
			clear/e "ADM_USUARIO"
			CD_USUARIO.ADM_USUARIO/init = $item("CD_USUARIO", $$gParamGlb)
			retrieve/e "ADM_USUARIO"
			;$dsConferente$ = NM_LOGIN.ADM_USUARIO
			if($status >= 0)
			;--->MNT - Prj 094/1320 - 18/03/2010
				if (CD_USUARIO.ADM_USUARIO > 0)
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_USUARIO", CD_USUARIO.ADM_USUARIO
					activate "ADMSVCO027".validaUsuarioEspecial($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)	
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus("",$xCdErro$, $xCtxErro$, "")
						return(-1)
					endif

					if(voParams != "")
						$dsConferente$ = $item("NM_LOGIN", voParams)
					endif
				else
					$dsConferente$ = ""
				endif
				;<---	
			endif
;			DS_CONFERENTE.TRA_TRANSACAO/init = NM_LOGIN.ADM_USUARIO
		endif		
	endif
	
	;carrega a descricao do caixa.
	clear/e "ADM_USUARIO"
	CD_USUARIO.ADM_USUARIO/init = $item("CD_USUARIO", $$gParamGlb)
	retrieve/e "ADM_USUARIO"
	if ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Código do usuário não encontrado!", "")
		return(-1)
	else
		;$dsCaixa$ = NM_LOGIN.ADM_USUARIO
		;--->MNT - Prj 094/1320 - 18/03/2010
		if (CD_USUARIO.ADM_USUARIO > 0)
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_USUARIO", CD_USUARIO.ADM_USUARIO
			activate "ADMSVCO027".validaUsuarioEspecial($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)	
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus("",$xCdErro$, $xCtxErro$, "")
				return(-1)
			endif

			if(voParams != "")
				$dsCaixa$ = $item("NM_LOGIN", voParams)
			endif
		else
			$dsCaixa$ = ""
		endif
		;<---	
	endif
	;carrega a descricao do terminal

	if($item("CD_TERMINAL", $$gParamGlb) != "")
		clear/e "GER_TERMINAL"
		CD_EMPRESA.GER_TERMINAL/init = $item("CD_EMPRESA", $$gParamGlb)
		CD_TERMINAL.GER_TERMINAL/init = $item("CD_TERMINAL", $$gParamGlb)
		retrieve/e "GER_TERMINAL"
		$dsTerminal$ = DS_TERMINAL.GER_TERMINAL
	endif

	$cdUsuarioDesc$ = ""
	$nrCartao$ = ""

	return(0)
end

;----------------------------
partner operation BT_CTRL_A
;----------------------------
	variables
		string viParams, voParams
		numeric vNrTransacao
	endvariables

	viParams = ""
	activate "FCXFM004".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif 

	return(0)
end;bt_ctrl_D


;----------------------------
partner operation BT_CTRL_D
;----------------------------
	variables
		string viParams, voParams
		numeric vNrTransacao
	endvariables

	viParams = ""
	activate "FCXFM005".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif 

	return(0)
end;bt_ctrl_D

;----------------------------
partner operation BT_CTRL_G
;----------------------------
	variables
		string viParams, voParams
		numeric vNrTransacao
	endvariables

	viParams = ""
	putlistitems/occ viParams, "TRA_TRANSACAO"
	activate "TRASVCO004".gravaCapaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif

	if (NR_TRANSACAO.TRA_TRANSACAO = 0)
		vNrTransacao = $item("NR_TRANSACAO", voParams)
		NR_TRANSACAO.TRA_TRANSACAO/init = vNrTransacao
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	$keyboard = "KB_GLOBAL"
	activate "TRAFM081".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif
	
	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif

	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif
	
	$prompt = TP_TRANSACAO.TRA_TRANSACAO
	
	return(0)
end;bt_ctrl_G

;----------------------------
partner operation BT_CTRL_S
;----------------------------
	variables
		string viParams, voParams
		numeric vNrTransacao
	endvariables

	viParams = ""
	activate "FCXFM006".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif 

	return(0)
end;bt_ctrl_S

;-----------------------------------
partner operation entradaColetor
;-----------------------------------
	;FIUZA PROJETO 41 TAREFA 15 - 02/03/06
	;FOI INCLUSO O BOTAO PARA ENTRADA POR COLETOR NA TRANSAÇÃO
	params
		string vDsLstColetor : IN
	endparams
	variables
		string viParams, voParams, vCdBarra, vDsRegistro
		numeric vCdProduto, vQtSolicitada, vNrSeq
		date vDtTransacao
	endvariables 

	if ($empty("TRA_TRANSITEM") = 0)
		setocc "TRA_TRANSITEM", -1
		vNrSeq = NR_ITEM.TRA_TRANSITEM + 1
	else
		vNrSeq = 1
	endif

	repeat
		vDsRegistro = ""
		getitem vDsRegistro, vDsLstColetor, 1
		vCdProduto = $item("CD_PRODUTO",vDsRegistro)
		vCdBarra = $item("CD_BARRAPRD", vDsRegistro)
		vQtSolicitada = $item("QT_COLETA",vDsRegistro)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		if ($tpUtilizaEtiqRfidPdv$ > 0) ;-=CANONICO=- (10/06/2011) TAR 570 / PRJ 156 - Gravar o codigo de Barra RFID
			putitem/id viParams, "CD_BARRAPRD", vCdBarra
			putitem/id viParams, "IN_CODIGO", <FALSE>    
		else
			putitem/id viParams, "CD_BARRAPRD", vCdProduto
			putitem/id viParams, "IN_CODIGO", <TRUE>    
		endif
		putitem/id viParams, "QT_SOLICITADA", vQtSolicitada
		putitem/id viParams, "CD_TABPRECO", $cdTabPreco$ ;---Elia Proj. 102/317 11/06/08
		activate "TRASVCO004".validaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif    
		if ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		if ($status >= 0)
			clear/e "TRA_TRANSITEM"
			creocc "TRA_TRANSITEM", -1
			getlistitems/occ voParams, "TRA_TRANSITEM"
			NR_ITEM.TRA_TRANSITEM = vNrSeq
			CD_EMPFAT.TRA_TRANSITEM = CD_EMPFAT.TRA_TRANSACAO
			CD_GRUPOEMPRESA.TRA_TRANSITEM = CD_GRUPOEMPRESA.TRA_TRANSACAO

			viParams = ""
			putlistitems/occ viParams, "TRA_TRANSITEM"
			activate "TRASVCO004".gravaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				rollback
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				rollback	
			endif 

			;Mendes - PRJ=156/TAR=682 - 23/11/2011
			if ($item("DS_MENSAGEM", voParams) != "")
				message/info "%%$item("DS_MENSAGEM", voParams)"
			endif
			;;;

			commit
			if ($status < 0)
				rollback 
			else
				$instancehandle->SetHint("ID=APLINFO002")
			endif
		endif

		vNrSeq = vNrSeq + 1

		delitem vDsLstColetor, 1
	until (vDsLstColetor = "")
	
	return(0)
end

;==================== ANO Pjt 90 Trf 1 20/12/2006
;---------------------------
partner operation observacao
	;---------------------------
	variables
		string  viParams, voParams
	endvariables
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "TRAFM065".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif 
	
	if ($status < 0)
		rollback
		return(-1)
	endif
	
	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif    
	
	return(0)
end ;observacao

;--------------------------------------
partner operation carregaFormaPagamento
;--------------------------------------
	variables
		string viParams, voParams, vDsLstParcela
	endvariables
	
	if ($tpSimuladorFat$ = 0) & ($inSimuladorProduto$ = <FALSE>) & ($inSimuladorCondPgto$ = <FALSE>)
		;Hugo em 31/01/11 Tarefa 156-504
		commit
		if ($status < 0)
			rollback
		else
			$instancehandle->SetHint("ID=APLINFO002")
		endif
		;
		
		return(0)
	endif

	;-=CANONICO=- (03/07/2009) TAR 593 PRJ 102 - Não chamar o simulador quando valor devolução menor ou igual a transação
	if (TP_OPERACAO.TRA_TRANSACAO = "S") & (TP_MODALIDADE.GER_OPERACAO = 8) & (VL_TRANSACAO.TRA_TRANSACAO <= VL_TOTAL.R_TRA_TRANSACAO)
		;------------------------------
		;Comentado por Hugo em 02/02/10
		;Tarefa 156-162
		;------------------------------
		;;>-- MAC - PRJ 156 TAR 161 - 28/01/2010 ---
		;if ($inSimuladorProduto$ = <TRUE>)
		;	viParams = ""    
		;	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		;	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		;	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		;	activate "TRASVCO004".gravaParcelaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		;	if ($procerror)       
		;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		;		return(-1)
		;	elseif ($status < 0)
		;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		;		return(-1)
		;	endif	
		;endif
		;;--<
		;------------------------------
		return(0)
	endif	
	;
	;>-- MAC - PRJ 156/400 - 17/09/2010 ---
	if (TP_MODALIDADE.GER_OPERACAO = 4 | TP_MODALIDADE.GER_OPERACAO = 8) & (TP_OPERACAO.TRA_TRANSACAO = "S")
	else
	;if (TP_MODALIDADE.GER_OPERACAO != 4 & TP_MODALIDADE.GER_OPERACAO != 8) | (TP_OPERACAO.TRA_TRANSACAO != "S")
		return(0)
	endif
	;--<
	if ($inSimuladorProduto$ = <TRUE>)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		$keyboard = "KB_GLOBAL"
		activate "TRAFM113".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			return(-1)
		endif
	elseif ($inSimuladorCondPgto$ = <TRUE>)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		$keyboard = "KB_GLOBAL"
		activate "TRAFM123".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			return(-1)
		endif
	elseif ($tpSimuladorFat$ > 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		$keyboard = "KB_GLOBAL"
		activate "TRAFM078".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			return(-1)
		endif
	endif

	if (voParams != "")
		$cdUsuarioDesc$ = $item("CD_USUARIODESC", voParams)
		vDsLstParcela = $item("DS_LSTPARCELA", voParams)
		
		viParams = voParams
		activate "TRASVCO017".gravaFormaPagamento($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif 
		if(vDsLstParcela != "")
			viParams = ""    
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "IN_SOBREPOR", <TRUE>
			putitem/id viParams, "DS_LSTPARCELA", vDsLstParcela
			activate "TRASVCO004".gravaParcelaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
		endif
		
		commit
		if ($status < 0)
			rollback
		else
			$instancehandle->SetHint("ID=APLINFO002")
		endif
	endif
	
	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif	
	
	return(0)
end

;--------------------------
partner operation BT_CTRL_T
;--------------------------
	variables
		string viParams, voParams
		numeric vNrTransacao
	endvariables
	
	if (NR_TRANSACAO.TRA_TRANSACAO = 0)
		return(0)
	endif
	
	if (TP_MODALIDADE.GER_OPERACAO != "8" | TP_OPERACAO.TRA_TRANSACAO != "S")
		return(0)
	endif
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	$keyboard = "KB_GLOBAL"
	activate "TRAFL054".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif 

	return(0)
end

;---Elia Proj. 115/3 11/10/07--
partner operation listaDetalhe
; Alteracao realisada pelo Sr. Fuiza 
;------------------------------

	if ($dbocc("TRA_TRANSITEM"))
		if (CD_BARRAPRD.TRA_TRANSITEM = "")
			CD_BARRAPRD.DETALHE/init = CD_PRODUTO.TRA_TRANSITEM
		else
			CD_BARRAPRD.DETALHE/init = CD_BARRAPRD.TRA_TRANSITEM
		endif

		VL_UNITBRUTO.DETALHE/init = VL_UNITBRUTO.TRA_TRANSITEM
		PR_DESCONTO.DETALHE/init  =	PR_DESCONTO.TRA_TRANSITEM
		VL_UNITDESC.DETALHE/init  = VL_UNITDESC.TRA_TRANSITEM
	endif

	return (0)

end ; operation listaDetalhe

;----------------------------
partner operation buscaLimite
;----------------------------
	variables
		string viParams, voParams
		boolean vInValidaFamiliar
	endvariables
	
	$vlLimite$ = ""
	
	vInValidaFamiliar = $item("IN_LIMITE_FAMILIAR_VD", $xlplemp$)
	if (vInValidaFamiliar = <TRUE>)
		vInValidaFamiliar = <FALSE>
		
		clear/e "TRA_TRANSACADIC"
		CD_EMPRESA.TRA_TRANSACADIC/init = CD_EMPRESA.TRA_TRANSACAO
		DT_TRANSACAO.TRA_TRANSACADIC/init = DT_TRANSACAO.TRA_TRANSACAO
		NR_TRANSACAO.TRA_TRANSACADIC/init = NR_TRANSACAO.TRA_TRANSACAO
		retrieve/e "TRA_TRANSACADIC"
		if ($status >= 0) & (CD_FAMILIAR.TRA_TRANSACADIC != 0)
			vInValidaFamiliar = <TRUE>
		endif
	endif
	
	viParams = ""
	putitem/id viParams, "CD_CLIENTE", CD_PESSOA.PES_PESSOA
	putitem/id viParams, "IN_TOTAL", <TRUE>
	
	if (vInValidaFamiliar = <TRUE>) & (CD_FAMILIAR.TRA_TRANSACADIC != 0)
		putitem/id viParams, "CD_FAMILIAR", CD_FAMILIAR.TRA_TRANSACADIC
	else
		vInValidaFamiliar = <FALSE>
	endif
	
	activate "FCRSVCO015".buscaLimiteCliente($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	if (vInValidaFamiliar = <TRUE>)
		$vlLimite$ = $item("VL_SALDOFAMILIAR", voParams)
	else
		$vlLimite$ = $item("VL_SALDO", voParams)
	endif
	
	$nrDiaAtraso$ = $item("NR_DIAVENCTO", voParams)
	
	return(0)
end

;---Elia Proj. 102/324 30/05/08-------------
partner operation aplicaQtPecasDescontoVlMin
;-------------------------------------------

	variables
		string viParams, voParams, vDsLstTransacao, vDsRegistro, vDsMensagemPRD
		numeric vVlTotalDesc, vPrTotalDesc, vVlResto, vVlCalc, vVlMaior, vNrOcc        
		numeric vVlBrutoTransacao, vQtDesconto, vQtDescontoAplic, vQtDescontoAplicPRD 
	endvariables

	if ($inSimuladorProduto$ = <TRUE>)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível aplicar desconto total o parâmetro por empresa IN_SIMULADOR_FAT_PRODUTO está configurado!", "")
		return(-1)
	endif

	if ($inSimuladorCondPgto$ = <TRUE>)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível aplicar desconto total o parâmetro por empresa IN_SIMULADOR_COND_PGTO está configurado!", "")
		return(-1)
	endif
	
	if ($tpSimuladorFat$ > 0)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Não é possível aplicar desconto total o parâmetro por empresa TP_SIMULADOR_FAT está configurado!", "")
		return(-1)
	endif

	if ($qtPecasDescontoVlMin$ = 0)
		return (0)	
	endif

	;---Elia Proj. 102/529 08/05/09
	askmess "Deseja aplicar desconto?", "Cancelar, Sim, Não"
	if ($status = 1) ; 1 - Cancelar
		return (-1)
	elseif ($status = 3) ; 3 - Não
		return (0)
	endif
	;

	clear/e "TMP_NR10"
	;---Verifica quantos descontos seram dados
	vQtDesconto = (QT_SOLICITADA.TRA_TRANSACAO / $qtPecasDescontoVlMin$)
	vQtDesconto = vQtDesconto[trunc]
	$vlDescAcumulado$ = 0

	;---Carrega o valor o menor para aplicar desconto 
	;a partir da quantidade de desconto que sera dado.
	if (vQtDesconto > 0)
		clear/e "TRA_S_TRANSITEM"	
		CD_EMPRESA.TRA_S_TRANSITEM/init = CD_EMPRESA.TRA_TRANSACAO
		NR_TRANSACAO.TRA_S_TRANSITEM/init = NR_TRANSACAO.TRA_TRANSACAO
		DT_TRANSACAO.TRA_S_TRANSITEM/init = DT_TRANSACAO.TRA_TRANSACAO
		retrieve/e "TRA_S_TRANSITEM"
		if ($status >= 0)
			sort/e "TRA_S_TRANSITEM", "VL_UNITLIQUIDO.TRA_S_TRANSITEM,CD_PRODUTO.TRA_S_TRANSITEM"
			setocc "TRA_S_TRANSITEM", 1
			vQtDescontoAplic = 1
			vQtDescontoAplicPRD = 0
			repeat	
				vQtDescontoAplicPRD = vQtDescontoAplicPRD + 1
				if (QT_SOLICITADA.TRA_S_TRANSITEM >= vQtDescontoAplicPRD)			
					$vlDescAcumulado$ = $vlDescAcumulado$ + VL_UNITLIQUIDO.TRA_S_TRANSITEM
				else
					vQtDescontoAplicPRD = 1
					setocc "TRA_S_TRANSITEM", $curocc("TRA_S_TRANSITEM") + 1
					$vlDescAcumulado$ = $vlDescAcumulado$ + VL_UNITLIQUIDO.TRA_S_TRANSITEM
				endif
			
				;---Monta item para a msg.
				creocc "TMP_NR10", -1
				NR_GERAL.TMP_NR10 = CD_PRODUTO.TRA_S_TRANSITEM
				retrieve/o "TMP_NR10"

				DS_PRODUTO.TMP_NR10 = DS_PRODUTO.TRA_S_TRANSITEM
				VL_UNITARIO.TMP_NR10 = VL_UNITLIQUIDO.TRA_S_TRANSITEM
				QT_DESCONTO.TMP_NR10 = QT_DESCONTO.TMP_NR10 + 1
				;
				vQtDescontoAplic = vQtDescontoAplic + 1			
			until (vQtDescontoAplic > vQtDesconto)
		endif
	endif
	;
		
	if ($vlDescAcumulado$ > 0)	
		;---Gera msg. de desconto
		setocc "TMP_NR10", 1
		while ($status >= 0)
			if(vDsMensagemPRD = "")
				vDsMensagemPRD = "Produto:%%^ %%NR_GERAL.TMP_NR10 - %%DS_PRODUTO.TMP_NR10 - Qt. %%QT_DESCONTO.TMP_NR10 - Vl. unit. %%VL_UNITARIO.TMP_NR10"
			else
				vDsMensagemPRD = "%%vDsMensagemPRD %%^ %%NR_GERAL.TMP_NR10 - %%DS_PRODUTO.TMP_NR10 - Qt. %%QT_DESCONTO.TMP_NR10 - Vl. unit. %%VL_UNITARIO.TMP_NR10"
			endif
			setocc "TMP_NR10", $curocc("TMP_NR10") + 1
		endwhile

		vDsMensagemPRD = "%%vDsMensagemPRD %%^ %%^ Quantidade de produto com desconto: %%vQtDesconto"
		vDsMensagemPRD = "%%vDsMensagemPRD %%^ %%^ Valor bruto transação: %%VL_TOTAL.TRA_TRANSACAO"
		vDsMensagemPRD = "%%vDsMensagemPRD %%^ Valor total desconto: %%$vlDescAcumulado$"
		$vlLiqTransacao$ = VL_TOTAL.TRA_TRANSACAO - $vlDescAcumulado$
		vDsMensagemPRD = "%%vDsMensagemPRD %%^ Valor líquido transação: %%$vlLiqTransacao$"
		;

		viParams = ""
		voParams = ""
		putitem/id viParams,"TITULO", "Informação de Desconto"
		putitem/id viParams,"MENSAGEM", vDsMensagemPRD
		activate "GERFP008".EXEC(viParams,voParams,$xCdErro$,$xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
		askmess "Confirmar desconto?","Sim,Não"
		if ($status = 2)
			return (-1)
		endif

		vVlBrutoTransacao = VL_TRANSACAO.TRA_TRANSACAO + VL_DESCONTO.TRA_TRANSACAO
		vVlTotalDesc = VL_DESCONTO.TRA_TRANSACAO + $vlDescAcumulado$
		vVlCalc = vVlTotalDesc / vVlBrutoTransacao * 100
		vPrTotalDesc = vVlCalc[round ,6]

		vVlResto = vVlTotalDesc
	
		if (!$empty("TRA_TRANSITEM"))
			vVlMaior = 0
			setocc "TRA_TRANSITEM", 1 
			while ($status >= 0)
				;Bloquear desconto para item em promoção
				if (($InBloqDesItemProm$ = <TRUE>) & (CD_PROMOCAO.TRA_TRANSITEM > 0))
				else
					;>-- MAC - PRJ 156/276 - 29/04/2010 ---
					;vVlCalc = VL_UNITLIQUIDO.TRA_TRANSITEM + VL_UNITDESCCAB.TRA_TRANSITEM
					;vVlCalc = vVlCalc * vPrTotalDesc / 100			
					;VL_UNITDESCCAB.TRA_TRANSITEM = vVlCalc[round, 2]
					;vVlCalc = VL_UNITDESCCAB.TRA_TRANSITEM * QT_SOLICITADA.TRA_TRANSITEM
					;VL_TOTALDESCCAB.TRA_TRANSITEM = vVlCalc[round, 2]
					;VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
					;vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
					;VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]

					vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM
					vVlCalc = vVlCalc * vPrTotalDesc / 100			
					VL_TOTALDESCCAB.TRA_TRANSITEM = vVlCalc[round, 2]
					VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
					vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
					VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
					vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
					VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]

					if (VL_TOTALDESCCAB.TRA_TRANSITEM > vVlResto)				
						VL_TOTALDESCCAB.TRA_TRANSITEM = vVlResto 
		   				VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
						vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
						VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
						vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
						VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]
						vVlResto = 0
						break
					endif
					;--<

					vVlResto = vVlResto - VL_TOTALDESCCAB.TRA_TRANSITEM
					
					if (VL_TOTALLIQUIDO.TRA_TRANSITEM > vVlMaior)
						vVlMaior = VL_TOTALLIQUIDO.TRA_TRANSITEM
						vNrOcc = $curocc("TRA_TRANSITEM")
					endif
				endif
				setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
			endwhile
	
			if (vVlResto != 0)
				setocc "TRA_TRANSITEM", vNrOcc
				VL_TOTALDESCCAB.TRA_TRANSITEM = VL_TOTALDESCCAB.TRA_TRANSITEM + vVlResto
				VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - (VL_TOTALDESC.TRA_TRANSITEM + VL_TOTALDESCCAB.TRA_TRANSITEM)
				vVlCalc = VL_TOTALDESCCAB.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
				VL_UNITDESCCAB.TRA_TRANSITEM = vVLCalc[round, 6]
				vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
				VL_UNITLIQUIDO.TRA_TRANSITEM = vVLCalc[round, 6]
			endif	
		
			setocc "TRA_TRANSITEM", 1 
			while ($status >= 0)
				viParams = ""
				putlistitems/occ viParams, "TRA_TRANSITEM"
				putitem/id viParams, "IN_TOTAL", <FALSE>
				activate "TRASVCO004".gravaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
			endwhile

			;Mendes - PRJ=156/TAR=682 - 23/11/2011
			if ($item("DS_MENSAGEM", voParams) != "")
				message/info "%%$item("DS_MENSAGEM", voParams)"
			endif
			;;;
	
			vDsLstTransacao = ""
			vDsRegistro = ""
			putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			putitem vDsLstTransacao, -1, vDsRegistro    
			putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
			activate "TRASVCO004".gravaTotalTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif	
	
			viParams = ""    
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "IN_SOBREPOR", <TRUE>
			activate "TRASVCO004".gravaParcelaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
		endif	

		;---Gera observacao
		vDsLstTransacao = ""
		vDsRegistro = ""
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem vDsLstTransacao, -1, vDsRegistro

		viParams = ""
		putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
		putitem/id viParams, "DS_OBSERVACAO", "Vl. total desc.: %%$vlDescAcumulado$ / Qt. produto com desc.: %%vQtDesconto"
		putitem/id viParams, "CD_COMPONENTE", $componentname
		putitem/id viParams, "IN_OBSNF", <FALSE>		
		activate "TRASVCO016".gravaObsTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)     
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif				
		;
	endif

	return (0)

End ; operation aplicaQtPecasDescontoVlMin

;---Elia Proj. 102/317 10/06/08----------
partner operation buscaDadosAdicTransacao
;----------------------------------------

	variables
		string viParams, voParams
	endvariables

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "TRASVCO016".buscaDadosAdicionais($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	$cdTabPreco$ = $item("CD_TABPRECO", voParams)

	return (0)

End ; operation buscaDadosAdicTransacao

;---Elia Proj. 133/007 15/08/08-----
partner operation carregaBonusCartao
;-----------------------------------

	variables
		string viParams, voParams, vDsLstTransacao, vDsRegistro, vDsLstCartao
		numeric vCdCartao, vVlBrutoTransacao, vPrTotalBonus, vVlResto, vVlTotalBonusItem , vVlCalc
		numeric vVlMaior, vNrOcc, vCdCliente
	endvariables

	vDsLstCartao = ""
	vVlCalc = ""

	viParams = ""
	$keyboard = "KB_GLOBAL"
	putitem/id viParams, "NR_CARTAO", $nrCartao$ ;---Elia Proj. 102/492 13/04/09
	;==BY BIANCHINI[PRJ/TAREFA 186/0275] 18/10/2011 ==;
	putitem/id viParams, "VL_TRANSACAO", VL_TRANSACAO.TRA_TRANSACAO
	;==
	activate "CTCFP003".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		return(-1)
	endif 

	vCdCartao = $item("CD_CARTAO", voParams)
	vCdCliente = $item("CD_CLIENTE", voParams)
	$vlBonusUtil$ = $item("VL_BONUSUTIL", voParams)
	vDsLstCartao = voParams

	if (vCdCartao != 0)
		;---Altera cliente da transacao
		CD_PESSOA.TRA_TRANSACAO = vCdCliente
		viParams = ""
		putlistitems/occ viParams, "TRA_TRANSACAO"
		activate "TRASVCO004".gravaCapaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif

		;---Aplica Bonus do cartao alterando valor do produto
		if ($vlBonusUtil$ != 0)
			;---Elia Proj. 102/538 07/05/09 Logica movida para o TRASVCO024
			;;vVlBrutoTransacao = VL_TRANSACAO.TRA_TRANSACAO
			;vVlCalc = $vlBonusUtil$ / vVlBrutoTransacao * 100
			;vPrTotalBonus = vVlCalc[round ,6]
			;vVlResto = $vlBonusUtil$
			;
			;if (!$empty("TRA_TRANSITEM"))
			;	vVlMaior = 0
			;	setocc "TRA_TRANSITEM", 1 
			;	while ($status >= 0)
			;		vVlCalc = VL_UNITLIQUIDO.TRA_TRANSITEM
			;		vVlCalc = vVlCalc * vPrTotalBonus / 100	
			;		VL_UNITLIQUIDO.TRA_TRANSITEM = VL_UNITLIQUIDO.TRA_TRANSITEM - vVlCalc[round, 2]
			;		vVlTotalBonusItem = vVlCalc[round, 2] * QT_SOLICITADA.TRA_TRANSITEM
			;		vVlCalc = VL_UNITLIQUIDO.TRA_TRANSITEM * QT_SOLICITADA.TRA_TRANSITEM
			;		VL_TOTALLIQUIDO.TRA_TRANSITEM = vVlCalc[round, 2]		
			;
			;		vVlCalc = VL_UNITBRUTO.TRA_TRANSITEM
			;		vVlCalc = vVlCalc * vPrTotalBonus / 100	
			;		VL_UNITBRUTO.TRA_TRANSITEM = VL_UNITBRUTO.TRA_TRANSITEM - vVlCalc[round, 2]
			;		vVlCalc = VL_UNITBRUTO.TRA_TRANSITEM * QT_SOLICITADA.TRA_TRANSITEM
			;		VL_TOTALBRUTO.TRA_TRANSITEM = vVlCalc[round, 2]
			;
			;		vVlResto = vVlResto - vVlTotalBonusItem
			;		
			;		if (VL_TOTALLIQUIDO.TRA_TRANSITEM > vVlMaior)
			;			vVlMaior = VL_TOTALLIQUIDO.TRA_TRANSITEM
			;			vNrOcc = $curocc("TRA_TRANSITEM")
			;		endif
			;		setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
			;	endwhile
			;
			;	if (vVlResto != 0)
			;		setocc "TRA_TRANSITEM", vNrOcc
			;		VL_TOTALBRUTO.TRA_TRANSITEM = VL_TOTALBRUTO.TRA_TRANSITEM - vVlResto
			;		vVlCalc = VL_TOTALBRUTO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
			;		VL_UNITBRUTO.TRA_TRANSITEM = vVlCalc[round, 2]
			;
			;		VL_TOTALLIQUIDO.TRA_TRANSITEM = VL_TOTALLIQUIDO.TRA_TRANSITEM - vVlResto
			;		vVlCalc = VL_TOTALLIQUIDO.TRA_TRANSITEM / QT_SOLICITADA.TRA_TRANSITEM
			;		VL_UNITLIQUIDO.TRA_TRANSITEM = vVlCalc[round, 2]
			;	endif	
			;
			;	setocc "TRA_TRANSITEM", 1 
			;	while ($status >= 0)
			;		;---Elia Proj. 102/400 09/10/08 no caso do desconto se zerar o valor é lancado 0.01 pois o valor do item nao pode ser zero
			;		if (VL_UNITBRUTO.TRA_TRANSITEM < 0.01)
			;			VL_UNITBRUTO.TRA_TRANSITEM = 0.01
			;			vVlCalc = VL_UNITBRUTO.TRA_TRANSITEM * QT_SOLICITADA.TRA_TRANSITEM
			;			VL_TOTALBRUTO.TRA_TRANSITEM = vVlCalc[round, 2]
			;		endif
			;		;
			;
			;		;---Elia Proj. 102/400 09/10/08 ;no caso do desconto se zerar o valor é lancado 0.01 pois o valor do item nao pode ser zero
			;		if (VL_UNITLIQUIDO.TRA_TRANSITEM < 0.01)
			;			VL_UNITLIQUIDO.TRA_TRANSITEM = 0.01
			;			vVlCalc = VL_UNITLIQUIDO.TRA_TRANSITEM * QT_SOLICITADA.TRA_TRANSITEM
			;			VL_TOTALLIQUIDO.TRA_TRANSITEM = vVlCalc[round, 2]		
			;		endif
			;		;
			;
			;		viParams = ""
			;		putlistitems/occ viParams, "TRA_TRANSITEM"
			;		putitem/id viParams, "IN_TOTAL", <FALSE>
			;		activate "TRASVCO004".gravaItemTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			;		if ($procerror)       
			;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			;			return(-1)
			;		elseif ($status < 0)
			;			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			;			return(-1)
			;		endif
			;		setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
			;	endwhile
			;	
			;	viParams = ""
			;	vDsLstTransacao = ""
			;	vDsRegistro = ""
			;	putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			;	putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			;	putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			;	putitem vDsLstTransacao, -1, vDsRegistro    
			;	putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
			;	activate "TRASVCO004".gravaTotalTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			;	if ($procerror)       
			;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			;		return(-1)
			;	elseif ($status < 0)
			;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			;		return(-1)
			;	endif	
			;
			;	viParams = ""    
			;	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			;	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			;	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			;	putitem/id viParams, "IN_SOBREPOR", <TRUE>
			;	activate "TRASVCO004".gravaParcelaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			;	if ($procerror)       
			;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			;		return(-1)
			;	elseif ($status < 0)
			;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			;		return(-1)
			;	endif
			;endif
			viParams = ""    
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			putitem/id viParams, "VL_BONUS", $vlBonusUtil$
			activate "TRASVCO024".gravaBonusTraItemAdic($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			;
		
			;---Gera observacao
			vDsLstTransacao = ""
			vDsRegistro = ""
			putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
			putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
			putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
			putitem vDsLstTransacao, -1, vDsRegistro		

			viParams = ""
			putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
			putitem/id viParams, "DS_OBSERVACAO", "Utilizado bonus de %%$vlBonusUtil$"
			putitem/id viParams, "CD_COMPONENTE", $componentname
			putitem/id viParams, "IN_OBSNF", <FALSE>		
			activate "TRASVCO016".gravaObsTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)     
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif				
			;
		endif
		;

		;---Grava CTC_TRACARTAO
		viParams = vDsLstCartao
		putitem/id viParams, "CD_EMPTRANSACAO", CD_EMPRESA.TRA_TRANSACAO
		putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		activate "CTCSVCO004".gravarCartaoTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)     
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif	
	endif

	return (0)

End ; operation carregaBonusCartao

;-----------------------------------
partner operation imprimirTransacao
;-----------------------------------
	variables
		string viParams, voParams, vDsLstTransacao, vDsRegistro
		boolean vInImprimir
	endvariables

	vInImprimir = <TRUE>
	if (vInImprimir = <TRUE>)
		viParams = ""
		vDsLstTransacao = ""
		vDsRegistro = ""
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
		putitem/id vDsRegistro, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
		putitem/id vDsRegistro, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
		putitem vDsLstTransacao, -1, vDsRegistro	
		putitem/id viParams, "DS_LSTTRANSACAO", vDsLstTransacao
		if ($tpImpressaoTraVenda$ = 02)
			putitem/id viParams, "IN_DIRETO", <FALSE>
		else
			putitem/id viParams, "IN_DIRETO", <TRUE>
		endif

		$keyboard = "KB_GLOBAL"
		activate "TRAFP004".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
		$keyboard = "KB_PDV"
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif
		if ($status >= 0)
			commit
			if ($status < 0)
				rollback
			else
				$instancehandle->SetHint("ID=APLINFO002")
			endif
		else
			rollback
		endif   
	endif	

	return(0)
end



;----------------------
;imprimi transacao
partner operation BT_CTRL_F11
;----------------------	
	if($dbocc("TRA_TRANSACAO") = 0)
		return(-1)
	endif
	
	$instancehandle->agrupaItem(<FALSE>)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif

	$instancehandle->imprimirTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif

	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif
		
;	$prompt = NR_ITEM.TRA_TRANSITEM

	return(0)
end

;---------------------------------
partner operation buscaAniversario
;---------------------------------
	variables
		numeric vTpAniversario, vDiaNasc, vMesNasc, vDiaAtual, vMesAtual
		date vDtSistema
	endvariables
	
	vTpAniversario = $item("TP_AVISA_ANIVERSARIO", $xlplemp$)
	
	if (vTpAniversario = 1 | vTpAniversario = 4)
		if ($empty("PES_PESFISICA") = 0) & (DT_NASCIMENTO.PES_PESFISICA != "")
			vDtSistema = $item("DT_SISTEMA", $$gParamGlb)
			
			vDiaNasc = DT_NASCIMENTO.PES_PESFISICA[D]
			vMesNasc = DT_NASCIMENTO.PES_PESFISICA[M]
			vDiaAtual = vDtSistema[D]
			vMesAtual = vDtSistema[M]
			
			if (vDiaNasc = vDiaAtual & vMesNasc = vMesAtual)
				message/info "Atenção. Aniversariante!"
			endif
		endif
	endif
	
	return(0)
end

;--------------------------
partner operation simulacao
;--------------------------
	variables
		string  viParams, voParams
	endvariables
	
	if (NR_TRANSACAO.TRA_TRANSACAO = 0)
		return(0)
	endif
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "IN_PDV", <TRUE>
	activate "TRAFM078".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	endif 
	
	return(0)
end

;-----------------------------------
partner operation efetivaTEFPendente
;-----------------------------------
	variables
		string viParams, voParams, vDsLstCupom, vDsRegistro, vDsConteudo, vDsAprovado, vDsMensagem, vDsLstEmpresa, vDsNsu
		boolean vInLoopConfirmacao, vInLoopImpressao
		numeric vNrLinhaCupom, vNrSequencia, vNrTotOcc, vNrOcc
	endvariables
	vDsLstEmpresa = ""

;; Marcus Vinicius - 156/384 - 02/08/2010
;	clear/e "GER_EMPRESA"
;	CD_GRUPOEMPRESA.GER_EMPRESA = CD_GRUPOEMPRESA.TRA_TRANSACAO
;	retrieve/e "GER_EMPRESA"
;	if ($status >= 0)
;		setocc "GER_EMPRESA", -1
;		setocc "GER_EMPRESA", 1
;		putlistitems vDsLstEmpresa, CD_EMPRESA.GER_EMPRESA
;	endif
	viParams = ""
	putitem/id viParams, "IN_VALIDALOCAL", <FALSE>
	if(CD_GRUPOEMPRESA.TRA_TRANSACAO != "")
		putitem/id viParams, "CD_GRUPOEMPRESA", CD_GRUPOEMPRESA.TRA_TRANSACAO
	else
		putitem/id viParams, "CD_GRUPOEMPRESA", $item("CD_GRUPOEMPRESA", $$gParamGlb)
	endif
	activate "GERSVCO032".buscaLstGrupoEmpresa($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif
	vDsLstEmpresa = $item("CD_EMPRESA", voParams)
;;
	vNrTotOcc = 0
	vDsNsu = ""

	clear/e "F_TEF_TRANSACAO"
	CD_EMPRESA.F_TEF_TRANSACAO/init = vDsLstEmpresa
	CD_TERMINAL.F_TEF_TRANSACAO/init = $item("CD_TERMINAL",$$gParamglb)
	TP_SITUACAO.F_TEF_TRANSACAO/init = "1·;2·;4"
	retrieve/e "F_TEF_TRANSACAO"
	if ($status >= 0)
		if ($tpImpTefPAYGO$ = 1) ;-=CANONICO=- (24-11-2011) Parametro ativo cupom resumido
			;-=CANONICO=- (23-11-2011) Quando tiver transacao atendida efetuar CNF - Confirmar a transacao TEF.
			vNrTotOcc = $totocc("F_TEF_TRANSACAO")
			clear/e "TEF_RELTRANSACAO"
			CD_EMPTEF.TEF_RELTRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO
			DT_MOVIMENTO.TEF_RELTRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
			NR_SEQ.TEF_RELTRANSACAO/init = NR_SEQ.F_TEF_TRANSACAO
			retrieve/e "TEF_RELTRANSACAO"
			if ($status >= 0)
				clear/e "TRA_TRANSACAO"
				CD_EMPRESA.TRA_TRANSACAO/init  = CD_EMPTRA.TEF_RELTRANSACAO                          
				NR_TRANSACAO.TRA_TRANSACAO/init = NR_TRANSACAO.TEF_RELTRANSACAO
				DT_TRANSACAO.TRA_TRANSACAO/init = DT_TRANSACAO.TEF_RELTRANSACAO
				retrieve/e "TRA_TRANSACAO"
				if ($status >= 0)
					if (TP_SITUACAO.TRA_TRANSACAO = 4) ;atendida
	
						setocc "F_TEF_TRANSACAO", 1
						while ($status >= 0)
							vDsNsu = "%%vDsNsu%%^%%NR_NSU.F_TEF_TRANSACAO"
							;Transação com cupom fiscal impresso, então envia o CNF	
							$instancehandle->efetivaTEFPendenteGeral_CNF()
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
							endif
							vNrOcc = $curocc("F_TEF_TRANSACAO")
							setocc "F_TEF_TRANSACAO", $curocc("F_TEF_TRANSACAO") + 1
						endwhile
					
						if (vNrOcc >= vNrTotOcc)
							$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação efetuada.%%^ Favor re-imprimir o cupom!%%^ %%vDsNsu", "") 			
						endif		

						clear/e "TRA_TRANSACAO"
						return(0)
					endif
				endif
			endif
		endif
		
		if ($tpTEF$ = 2)
			;ordena TEF_TRANSACAO por TP_SITUACAO, pois no TEF DISCADO usando múltiplos cartões
			;é necessário mandar o NCN da ultima transação cuja o TP_SITUACAO = 1  e depois cancelar
			;todas as transações TP_SITUACAO = 4, ou seja mandar CNC 
			sort/e "F_TEF_TRANSACAO","TP_SITUACAO.F_TEF_TRANSACAO"
		endif
		message/hint "Aguarde. Aplicaçao TEF sendo executada."
		setocc "F_TEF_TRANSACAO", 1
		while ($status >= 0)
			if (TP_SITUACAO.F_TEF_TRANSACAO = 1) 
				;Transaçao autorizada sem cupom impresso
				$instancehandle->efetivaTEFPendenteGeral_NCN()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
				endif
			elseif (TP_SITUACAO.F_TEF_TRANSACAO = 2) 
				;Transação com cupom impresso e não confirmada
				$instancehandle->efetivaTEFPendenteGeral_CNF()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
				endif
			elseif (TP_SITUACAO.F_TEF_TRANSACAO = 4) & ($tpTEF$ = 2) 
				;Transação autorizada e sem cupom impresso SOMENTE PARA DISCADO
				viParams = ""
				putitem/id viParams, "000-000", "CNC"
				putitem/id viParams, "001-000", NR_SEQ.F_TEF_TRANSACAO
				$vlTEF$ = VL_TRANSACAO.F_TEF_TRANSACAO
				putitem/id viParams, "003-000", "%%$vlTEF$"
				putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
				;$nrNSU$ = NR_NSU.F_TEF_TRANSACAO
				;ate então a VISA trabalha somente com 6 digitos na NSU
				$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
				$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"	
				putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
				;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO
				;if (NM_REDETEF.F_TEF_TRANSACAO = "VISANET")
				;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
				;endif
				if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
					putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
				endif
				$dtTEF$ = DT_TRANSACAO.F_TEF_TRANSACAO
				putitem/id viParams, "022-000", "%%$dtTEF$"
				$hrTEF$ = HR_TRANSACAO.F_TEF_TRANSACAO
				putitem/id viParams, "023-000", "%%$hrTEF$"
				putitem/id viParams, "999-999", "0"
				putitem/id viParams, "DS_EXTENSAO", "001"
				putitem/id viParams, "IN_P1", <TRUE>
				activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)    	   
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
				elseif ($status >= 0)
					vDsConteudo = voParams
					vNrLinhaCupom = $item("028-000", vDsConteudo)
					vDsAprovado = $item("009-000", vDsConteudo)
					vDsMensagem = $item("030-000", vDsConteudo)
					if (vDsAprovado != "0");caso nao seja confirmado retorna a mensagem
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%vDsMensagem%%%!", "")   
						return(-1)     
					endif
				elseif($tpTEF$ = 2);Loop aguardando GP ATIVO 
					vInLoopConfirmacao = <FALSE>
					repeat
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						message/hint "Aguardando comunicação..."	
						activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
						elseif ($status >= 0)
							vDsConteudo = voParams
							vNrLinhaCupom = $item("028-000", vDsConteudo)
							vDsAprovado = $item("009-000", vDsConteudo)
							vDsMensagem = $item("030-000", vDsConteudo)
							if (vDsAprovado != "0");caso nao seja confirmado retorna a mensagem
								$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%vDsMensagem%%%!", "")    
								return(-1)    
							endif
							if (vNrLinhaCupom > 0)
								vInLoopConfirmacao = <TRUE>
							endif
						endif
						message/hint " "
					until (vInLoopConfirmacao = <TRUE>)
				endif

				if (vNrLinhaCupom > 0)
					viParams = ""
					putitem/id viParams, "NM_ENTIDADE", "TEF_TRANSACAO"
					activate "GERSVCO031".getNumSeq($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					vNrSequencia = $item("NR_SEQUENCIA", voParams)

					;grava o registro no TEF_TRANSACAO    
					viParams = vDsConteudo
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
					putitem/id viParams, "000-000", "CNC"
					putitem/id viParams, "001-000", vNrSequencia
					$vlTEF$ = VL_TRANSACAO.F_TEF_TRANSACAO
					putitem/id viParams, "003-000", "%%$vlTEF$"
					putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
					;-=CANONICO=- (20/08/2009) HOMOLOGACAO PAY GO, ao enviar a CNC o sistema deve gravar a NSU da CNC
					;putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO
					putitem/id viParams, "011-000", TP_TRANSACAO.F_TEF_TRANSACAO
					putitem/id viParams, "012-000", $item("012-000", vDsConteudo)
					putitem/id viParams, "022-000", $item("022-000", vDsConteudo)
					putitem/id viParams, "023-000", $item("023-000", vDsConteudo)
					putitem/id viParams, "027-000", $item("027-000", vDsConteudo)
					putitem/id viParams, "NR_NSUAUX", NR_NSU.F_TEF_TRANSACAO
					;
					putitem/id viParams, "TP_SITUACAO", 1
					newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
					activate "TEFSVCO011".gravaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					vDsConteudo = $item("DS_CUPOM",voParams)
				endif

				;Imprime cupom TEF
				if (vNrLinhaCupom > 0)
					$instancehandle->efetivaTEFPendenteGeral_CNC(vDsMensagem,vDsConteudo,vNrSequencia)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")        
					endif
				endif
			endif
			setocc "F_TEF_TRANSACAO", $curocc("F_TEF_TRANSACAO") + 1
		endwhile
	endif

	message/hint ""
	
	return(0)
end

;------------------------------
partner operation efetivaTEFPendenteGeral_NCN
;------------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao, vInLoopImpressao
	endvariables

	viParams = ""
	putitem/id viParams, "000-000", "NCN"
	putitem/id viParams, "001-000", NR_SEQ.F_TEF_TRANSACAO
	putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.F_TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"	
	putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
	;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO
	;if (NM_REDETEF.F_TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	if ($tpTEF$ = 2)
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
	endif
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		if (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO", "") 
		elseif (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO > 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO", "") 
		else
			if ($tpTEF$ = 1)
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Transação não efetuada.%%^ Favor reter o cupom!", "") 			
			else
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.F_TEF_TRANSACAO", "") 
			endif
		endif
	elseif ($tpTEF$ = 2) ;somente TEF DISCADO - Loop aguardando GP ATIVO 
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			message/hint "Aguardando comunicação..."	
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				if (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO = 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO", "") 
				elseif (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO > 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO", "") 
				else
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO %%^Valor: %%VL_TRANSACAO.F_TEF_TRANSACAO", "") 
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			message/hint " "
		until (vInLoopConfirmacao = <TRUE>)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	endif

	return(0)

end;efetivaTEFPendenteGeral_NCN

;------------------------------
partner operation efetivaTEFPendenteGeral_CNF
;------------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao, vInLoopImpressao
	endvariables

	viParams = ""
	putitem/id viParams, "000-000", "CNF"
	putitem/id viParams, "001-000", NR_SEQ.F_TEF_TRANSACAO
	putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.F_TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"		
	putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
	;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO
	;if (NM_REDETEF.F_TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
	elseif ($tpTEF$ = 2)
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			message/hint "Aguardando comunicação..."	
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			message/hint " "
		until (vInLoopConfirmacao = <TRUE>)			
	endif	

	return(0)
end;efetivaTEFPendenteGeral_CNF

;------------------------------
partner operation efetivaTEFPendenteGeral_CNC
;------------------------------
	params
		string vDsMensagem : IN
		string vDsConteudo : IN
		numeric vNrSequencia : IN
	endparams
	variables
		string viParams, voParams, vDsLstCupom, vDsRegistro, vDsAprovado, vDsLstEmpresa
		boolean vInLoopConfirmacao, vInLoopImpressao
		numeric vNrLinhaCupom
	endvariables

	vDsLstCupom = ""
	vDsRegistro = ""
	putitem/id vDsRegistro, "DS_MENSAGEM", vDsMensagem
	putitem/id vDsRegistro, "DS_CUPOM", vDsConteudo
	putitem vDsLstCupom, -1, vDsRegistro
	viParams = ""
	putitem/id viParams, "DS_LSTCUPOM", vDsLstCupom
	putitem/id viParams, "DS_FORMAPGTO", ""
	putitem/id viParams, "TP_IMPRESSAO", 2 ;Relatório gerencial
	activate "TEFFP002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		vInLoopImpressao = <TRUE>
		repeat
			askmess "Impressora não responde! Tentar novamente?", "Sim, Não"	
			if ($status = 2) 
				viParams = ""
				;-=CANONICO=- (21/08/2009) Homologacao
				clear/e "TEF_TRANSACAO"
				CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO	
				DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
				CD_ARQUIVO.TEF_TRANSACAO/init = "CNC"	
				TP_TRANSACAO.TEF_TRANSACAO/init = TP_TRANSACAO.F_TEF_TRANSACAO			
				NR_NSUAUX.TEF_TRANSACAO/init = NR_NSU.F_TEF_TRANSACAO 
				retrieve/e "TEF_TRANSACAO"	
				if ($status >= 0)
					putitem/id viParams, "000-000", "NCN"
					putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
					putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
					putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO
					putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
				else
					putitem/id viParams, "000-000", "NCN"
					putitem/id viParams, "001-000", NR_SEQ.F_TEF_TRANSACAO
					putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
					;$nrNSU$ = NR_NSU.TEF_TRANSACAO
					;ate então a VISA trabalha somente com 6 digitos na NSU
					$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
					$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"
					putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
					;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
					;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
					;    putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
					;endif
					if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
						putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
					endif
					putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
				endif
	
			    putitem/id viParams, "999-999", "0"
			    putitem/id viParams, "DS_EXTENSAO", "001"
			    putitem/id viParams, "IN_P1", <FALSE>
			    activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			    if ($procerror)       
				    $instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			    elseif ($status >= 0)
					if (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO = 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO", "") 
					elseif (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO > 0)
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO", "") 
					else
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO %%^Valor: %%VL_TRANSACAO.F_TEF_TRANSACAO", "") 
					endif
			    elseif ($tpTEF$ = 2)
				    vInLoopConfirmacao = <FALSE>
				    repeat
					     $instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					     message/hint "Aguardando comunicação..."	
					     activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					     if ($procerror)       
					         $instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
					     elseif ($status >= 0)
						     if (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO = 0)
						         $instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO", "") 
	                         elseif (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO > 0)
		                         $instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO", "") 
	                         else
		                        $instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.F_TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.F_TEF_TRANSACAO %%^Valor: %%VL_TRANSACAO.F_TEF_TRANSACAO", "") 
	                         endif
		                     vInLoopConfirmacao = <TRUE>
					     endif
					     message/hint " "
					until (vInLoopConfirmacao = <TRUE>)
				endif
			else
				viParams = ""
			    putitem/id viParams, "DS_LSTCUPOM", vDsLstCupom
				putitem/id viParams, "DS_FORMAPGTO", ""
				putitem/id viParams, "TP_IMPRESSAO", 2 ;Relatório gerencial
				activate "TEFFP002".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")                        
				endif
				if ($status >= 0)
					viParams = ""
					;-=CANONICO=- (21/08/2009) Homologacao
					clear/e "TEF_TRANSACAO"	
					CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO	
					DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
					CD_ARQUIVO.TEF_TRANSACAO/init = "CNC"	
					TP_TRANSACAO.TEF_TRANSACAO/init = TP_TRANSACAO.F_TEF_TRANSACAO			
					NR_NSUAUX.TEF_TRANSACAO/init = NR_NSU.F_TEF_TRANSACAO 
					retrieve/e "TEF_TRANSACAO"	
					if ($status >= 0)
						putitem/id viParams, "000-000", "CNF"
						putitem/id viParams, "001-000", vNrSequencia
						putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
						putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO
						putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
					else

						putitem/id viParams, "000-000", "CNF"
						putitem/id viParams, "001-000", vNrSequencia
						putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
						;$nrNSU$ = NR_NSU.TEF_TRANSACAO
						;ate então a VISA trabalha somente com 6 digitos na NSU
						$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
						$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"		
						putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
						;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
						;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
						;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
						;endif
						if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
							putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
						endif
						putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
					endif
					putitem/id viParams, "999-999", "0"
					putitem/id viParams, "DS_EXTENSAO", "001"
					putitem/id viParams, "IN_P1", <FALSE>
					activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status >= 0)
					elseif ($tpTEF$ = 2)
						vInLoopConfirmacao = <FALSE>
						repeat
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							message/hint "Aguardando comunicação..."	
							activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
							if ($procerror)       
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
							elseif ($status >= 0)
								vInLoopConfirmacao = <TRUE>
							endif
							message/hint " "
						until (vInLoopConfirmacao = <TRUE>)
					endif
					;confirma o CNC gerado
					viParams = ""
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
					putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
					putitem/id viParams, "NR_SEQ", vNrSequencia
					putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
					newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
					activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					endif

					;-=CANONICO=- (21/08/2009) Homologacao	
					clear/e "TEF_TRANSACAO"
					CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO	
					DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
					CD_ARQUIVO.TEF_TRANSACAO/init = "CRT"	
					TP_TRANSACAO.TEF_TRANSACAO/init = TP_TRANSACAO.F_TEF_TRANSACAO			
					NR_NSU.TEF_TRANSACAO/init = NR_NSU.F_TEF_TRANSACAO 
					retrieve/e "TEF_TRANSACAO"	

					;altera o status da transação CRT para -1. Que outrora estava em pendência = 4
					viParams = ""
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
					putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
					putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
					putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
					newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
					activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					endif	
					vInLoopImpressao = <FALSE>
				endif
			endif    
		until (vInLoopImpressao = <FALSE>)
	else

		;-=CANONICO=- (21/08/2009) Homologacao
		clear/e "TEF_TRANSACAO"	
		CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPRESA.F_TEF_TRANSACAO	
		DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.F_TEF_TRANSACAO
		CD_ARQUIVO.TEF_TRANSACAO/init = "CNC"	
		TP_TRANSACAO.TEF_TRANSACAO/init = TP_TRANSACAO.F_TEF_TRANSACAO
		TP_SITUACAO.TEF_TRANSACAO/init = 1			
		NR_NSUAUX.TEF_TRANSACAO/init = NR_NSU.F_TEF_TRANSACAO 
		retrieve/e "TEF_TRANSACAO"	
		if ($status >= 0)
			putitem/id viParams, "000-000", "CNF"
			putitem/id viParams, "001-000", vNrSequencia
			putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
			putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO
			putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
		else
			putitem/id viParams, "000-000", "CNF"
			putitem/id viParams, "001-000", vNrSequencia
			putitem/id viParams, "010-000", NM_REDETEF.F_TEF_TRANSACAO
			;$nrNSU$ = NR_NSU.TEF_TRANSACAO
			;ate então a VISA trabalha somente com 6 digitos na NSU
			$nrNSU6DIG$ = NR_NSU.F_TEF_TRANSACAO
			$dsNSU$ = "%%NR_NSU.F_TEF_TRANSACAO"		
			putitem/id viParams, "012-000", NR_NSU.F_TEF_TRANSACAO;"%%$nrNSU$"
			;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO	
			;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
			;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
			;endif
			if (NM_REDETEF.F_TEF_TRANSACAO = "TECBAN")
				putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
			endif
			putitem/id viParams, "027-000", DS_FINALIZACAO.F_TEF_TRANSACAO
		endif

		putitem/id viParams, "999-999", "0"
		putitem/id viParams, "DS_EXTENSAO", "001"
		putitem/id viParams, "IN_P1", <FALSE>
		activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status >= 0)
		elseif ($tpTEF$ = 2)
			vInLoopConfirmacao = <FALSE>
			repeat
			    $instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			    message/hint "Aguardando comunicação..."	
			    activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			    if ($procerror)       
			        $instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			    elseif ($status >= 0)
					vInLoopConfirmacao = <TRUE>
				endif
				message/hint " "
			until (vInLoopConfirmacao = <TRUE>)
		endif
		;confirma o CNC gerado
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", vNrSequencia
		putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		;altera o status da transação CRT para -1. Que outrora estava em pendência = 4
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.F_TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.F_TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
	endif 

	return(0)

end;efetivaTEFPendenteGeral_CNC

;-----------------------------------
partner operation efetivaTEFPendente_MSG
;-----------------------------------
	params
		numeric vCdEmpresa : IN
		numeric vNrSeq : IN
		date vDtMovimento : IN
		numeric vlValor : IN
		string vDsRedeTef : IN
		numeric vCdOperador	: IN	
	endparams
	variables
		string viParams, voParams, vNmLogin
	endvariables

	clear/e "TEF_RELTRANSACAO"
	CD_EMPTEF.TEF_RELTRANSACAO/init = vCdEmpresa
	NR_SEQ.TEF_RELTRANSACAO/init = vNrSeq
	DT_MOVIMENTO.TEF_RELTRANSACAO/init = vDtMovimento
	retrieve/e "TEF_RELTRANSACAO"
	;if ($status >= 0)
	;	clear/e "TEF_TRANSACAO"
	;	CD_EMPRESA.TEF_TRANSACAO/init = CD_EMPTEF.TEF_RELTRANSACAO
	;	NR_SEQ.TEF_TRANSACAO/init = NR_SEQ.TEF_RELTRANSACAO
	;	DT_MOVIMENTO.TEF_TRANSACAO/init = DT_MOVIMENTO.TEF_RELTRANSACAO
	;	retrieve/e "TEF_TRANSACAO"
	;	if ($status >= 0)
	;		$instancehandle->efetua_NCN()
	;		if ($procerror)
	;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;			return(-1)
	;		elseif ($status < 0)
	;			return(-1)
	;		endif
	;	endif
	;endif
	
	clear/e "ADM_USUARIO"
	CD_USUARIO.ADM_USUARIO/init = vCdOperador
	retrieve/e "ADM_USUARIO"
	;--->MNT - Prj 094/1320 - 18/03/2010
	if (CD_USUARIO.ADM_USUARIO > 0)
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_USUARIO", CD_USUARIO.ADM_USUARIO
		activate "ADMSVCO027".validaUsuarioEspecial($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)	
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus("",$xCdErro$, $xCtxErro$, "")
			return(-1)
		endif

		if(voParams != "")
			vNmLogin = $item("NM_LOGIN", voParams)
		endif
	else
		vNmLogin = ""
	endif
	;<---
	;foi incluso esta logica, pois na delfiori estava cancelando transações...
	;com essa logica é a Supervisora de caixa que irá determinar o que vai ser feito durante a venda do TEF
	;somente executa essa logica se o parametro $inUltimaPgtoCartaoTEF$ de não homologação estiver setado
	message/info "Transacao %%NR_TRANSACAO.TEF_RELTRANSACAO da Empresa %%CD_EMPTRA.TEF_RELTRANSACAO no Valor de %%vlValor da rede %%vDsRedeTef efetuada pelo usuario %%vNmLogin esta pendente na operadora."
	
	return(-1)
end



;------------------------
partner operation efetua_NCN 
	;------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao, vInLoopImpressao
	endvariables

	viParams = ""
	putitem/id viParams, "000-000", "NCN"
	putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
	putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.F_TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"	
	putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
	;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO
	;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	if ($tpTEF$ = 2)
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
	endif
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
		if (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO = 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
		elseif (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO > 0)
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO", "") 
		else
			$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
		endif
	elseif ($tpTEF$ = 2) ;somente TEF DISCADO - Loop aguardando GP ATIVO 
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			message/hint "Aguardando comunicação..."	
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", -1 ;Não foi possível imprimir o cupom
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				if (VL_TRANSACAO.TEF_TRANSACAO = 0 & NR_NSU.TEF_TRANSACAO = 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO", "") 
				elseif (VL_TRANSACAO.F_TEF_TRANSACAO = 0 & NR_NSU.F_TEF_TRANSACAO > 0)
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO", "") 
				else
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Cancelada transação: %%^Rede: %%NM_REDETEF.TEF_TRANSACAO %%^Doc. Nr.: %%NR_NSU.TEF_TRANSACAO%%^Valor: %%VL_TRANSACAO.TEF_TRANSACAO", "") 
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			message/hint " "
		until (vInLoopConfirmacao = <TRUE>)
	endif

	return(0)
End ; operation efetua_NCN

;------------------------
partner operation efetua_CNF 
	;------------------------
	variables
		string viParams, voParams
		boolean vInLoopConfirmacao, vInLoopImpressao
	endvariables

	viParams = ""
	putitem/id viParams, "000-000", "CNF"
	putitem/id viParams, "001-000", NR_SEQ.TEF_TRANSACAO
	putitem/id viParams, "010-000", NM_REDETEF.TEF_TRANSACAO
	;$nrNSU$ = NR_NSU.TEF_TRANSACAO
	;ate então a VISA trabalha somente com 6 digitos na NSU
	$nrNSU6DIG$ = NR_NSU.TEF_TRANSACAO
	$dsNSU$ = "%%NR_NSU.TEF_TRANSACAO"	
	putitem/id viParams, "012-000", NR_NSU.TEF_TRANSACAO;"%%$nrNSU$"
	;-=CANONICO=- (17/08/2009) HOMOLOGACAO PAY-GO
	;if (NM_REDETEF.TEF_TRANSACAO = "VISANET")
	;	putitem/id viParams, "012-000", "%%$nrNSU6DIG$"
	;endif
	if (NM_REDETEF.TEF_TRANSACAO = "TECBAN")
		putitem/id viParams, "012-000", "%%$dsNSU$[1:6]"
	endif
	putitem/id viParams, "027-000", DS_FINALIZACAO.TEF_TRANSACAO
	putitem/id viParams, "999-999", "0"
	putitem/id viParams, "DS_EXTENSAO", "001"
	putitem/id viParams, "IN_P1", <FALSE>
	activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
	elseif ($status >= 0)
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
		putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
		putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
		putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
		newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
		activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif
	elseif ($tpTEF$ = 2)
		vInLoopConfirmacao = <FALSE>
		repeat
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			message/hint "Aguardando comunicação..."	
			activate "TEFSVCO010".geraArquivoREQ($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")				
			elseif ($status >= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TEF_TRANSACAO
				putitem/id viParams, "DT_MOVIMENTO", DT_MOVIMENTO.TEF_TRANSACAO
				putitem/id viParams, "NR_SEQ", NR_SEQ.TEF_TRANSACAO
				putitem/id viParams, "TP_SITUACAO", 3 ;Transação confirmada
				newinstance "TEFSVCO011", "TEFSVCO011", "TRANSACTION=TRUE"
				activate "TEFSVCO011".alteraSituacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				endif
				vInLoopConfirmacao = <TRUE>
			endif
			message/hint " "
		until (vInLoopConfirmacao = <TRUE>)			
	endif	

	return(0)
end

;------------------------------
partner operation bonusDesconto
;------------------------------
	variables
		numeric vTpBonus, vVlBonus
		string viParams, voParams
	endvariables
	
	vTpBonus = $item("TP_BONUS_DESCONTO", $xlplemp$)
	
	if (vTpBonus != 1)
		return(0)
	endif

	;* Claudemir - Prj/Tarefa: 180/101 - 14/03/2011
	;clear/e "PES_BONUS"
	;CD_EMPRESA.PES_BONUS/init = CD_EMPRESA.TRA_TRANSACAO
	;CD_PESSOA.PES_BONUS/init = CD_PESSOA.TRA_TRANSACAO
	;TP_BONUS.PES_BONUS/init = vTpBonus
	;retrieve/e "PES_BONUS"
	;if ($status < 0) | (VL_BONUS.PES_BONUS <= 0)
	;	return(0)
	;endif

	viParams = ""
	putitem/id viParams, "CD_PESSOA", CD_PESSOA.TRA_TRANSACAO
	activate "PESSVCO035".buscaSaldoBonus($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	vVlBonus = $item("VL_BONUS", voParams)

	if (vVlBonus <= 0)
		return(0)
	endif	 ;*
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	$keyboard = "KB_GLOBAL"
	activate "TRAFP060".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		return(-1) 
	endif
	
	return(0)
end

;----------------------------
partner operation mostraTotal
;----------------------------
	variables
		numeric vNrOcc, vTpValidacaoConf
	endvariables
	
	vTpValidacaoConf = $item("TP_VALIDACAO_CONF_TRA", $xlplemp$)
	
	if ($empty("TRA_TRANSITEM") = 0)
		vNrOcc = $curocc("TRA_TRANSITEM")
		setocc "TRA_TRANSITEM", 1
		while ($status >= 0)
			if ($inMostraTotal$ = <TRUE>)
				fieldsyntax NR_ITEM.TRA_TRANSITEM, "HID"
			else
				fieldsyntax NR_ITEM.TRA_TRANSITEM, ""
			endif
			setocc "TRA_TRANSITEM", $curocc("TRA_TRANSITEM") + 1
		endwhile
		setocc "TRA_TRANSITEM", vNrOcc
	endif
	

	if ($inMostraTotal$ = <TRUE>)
		$inMostraTotal$ = <FALSE>
		BT_MOSTRATOTAL.TRA_TRANSACAO/init = "Mostrar %total"
		fieldsyntax BT_NRITEM.SIS_BOTOES2, "HID"		
		fieldsyntax QT_SOLICITADA.TRA_TRANSACAO, "HID"
		fieldsyntax VL_TRANSACAO.TRA_TRANSACAO, "HID"
	else
		$inMostraTotal$ = <TRUE>
		BT_MOSTRATOTAL.TRA_TRANSACAO/init = "Omitir %total"
		fieldsyntax BT_NRITEM.SIS_BOTOES2, ""
		fieldsyntax NR_ITEM.TRA_TRANSITEM, ""
		if (vTpValidacaoConf = 2) | (vTpValidacaoConf = 3)
			fieldsyntax QT_SOLICITADA.TRA_TRANSACAO, "HID"
		else
			fieldsyntax QT_SOLICITADA.TRA_TRANSACAO, ""
		endif
		fieldsyntax VL_TRANSACAO.TRA_TRANSACAO, ""
	endif
	
	$prompt = CD_PRODUTO.TRA_TRANSITEM
	
	return(0)
end

;Tarefa 102-939 Hugo em 14/09/2010
;--------------------------------------
partner operation validaItemCoeficiente
;--------------------------------------
	params
		numeric piCdProduto : IN
		numeric pioVlProduto : INOUT
		numeric poQtSolicitada : INOUT
	endparams
	
	variables
		string viParams, voParams
		numeric vTpLote
	endvariables

	if (piCdProduto = 0)
		return(0)
	endif

	clear/e "PRD_EMBALAGEM"
	CD_PRODUTO.PRD_EMBALAGEM/init = piCdProduto
	retrieve/e "PRD_EMBALAGEM"
	if ($status < 0)
		return(0)
	endif

	viParams = ""
	putitem/id viParams, "CD_PRODUTO", piCdProduto
	putitem/id viParams, "VL_PRODUTO", pioVlProduto
	putitem/id viParams, "IN_CODIGO", IN_CODIGO.SIS_FILTRO
	putitem/id viParams, "CD_BARRAPRD", CD_BARRAPRD.SIS_FILTRO
	$keyboard = "KB_GLOBAL"
	activate "PRDFP051".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$)
	$keyboard = "KB_PDV"
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return (-1)
	elseif ($status < 0)
		return(-1)
	endif

	pioVlProduto = $item("VL_UNITARIO", voParams)
	poQtSolicitada = $item("QT_EMBALAGEM", voParams)

	return(0)
end

;--------------------------------
partner operation excluiSimulacao
;--------------------------------
;Hugo em 30/12/2010 Tarefa 156-494
	variables
		string viParams, voParams
	endvariables
	
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.TRA_TRANSACAO
	putitem/id viParams, "NR_TRANSACAO", NR_TRANSACAO.TRA_TRANSACAO
	putitem/id viParams, "DT_TRANSACAO", DT_TRANSACAO.TRA_TRANSACAO
	activate "TRASVCO017".excluiSimulacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)       
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	
	commit
	if ($status < 0)
		rollback
		return (-1) 
	else
		$instancehandle->SetHint("ID=APLINFO002")
	endif
	
	$instancehandle->recarregaTransacao()
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	endif
	
	return(0)
end


;------------------------;-=CANONICO=- TAR 570 PRJ 156 (10/05/2011) "Inclusao do Portal RFID"
partner operation portal
;------------------------------

	variables
		string viParams, voParams, vDsLstProduto
	endvariables
	
	viParams = ""
	putitem/id viParams, "IN_QUANTIDADEFIXO", <TRUE> ;-=CANONICO=- TAR 663 PRJ 156 (18/11/2011) - Informa para o serviço que os produtos do RFID serão apenas 1, desta forma quando tem kit não é feito a multiplicacao. 
	putitem/id viParams, "IN_SOMENTELEITURA", <FALSE>
	$keyboard = "KB_GLOBAL"
	activate "GERFP042".EXEC(viParams, voParams, $xCdErro$, $xCtxErro$);
	$keyboard = "KB_PDV"
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return (-1)
	elseif ($status < 0)
		return(-1)
	endif

	vDsLstProduto = $item("DS_LSTPRODUTO", voParams)

	if (vDsLstProduto != "")
		$instancehandle->entradaColetor(vDsLstProduto)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return (-1)
		endif

		if ($dbocc("TRA_TRANSACAO"))
			$instancehandle->recarregaTransacao()
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return (-1)
			endif	
		endif
	endif

	return (0)
end; operation portal

;* Claudemir - Prj/Tarefa: 191/2 - 07/10/2011
; verifica se existe transações em andamento para esse usuário na empresa logada
; se existir, será feito o cancelamento
;-----------------------------------------
partner operation verificaTransacaoAberta
;----------------------------------------
	variables
		string viParams, voParams
	endvariables

	clear/e "F_TRA_TRANSACAO"
	CD_EMPRESA.F_TRA_TRANSACAO/init	= $item("CD_EMPRESA", $$gParamGlb)
	CD_OPERADOR.F_TRA_TRANSACAO/init	= $item("CD_USUARIO", $$gParamGlb)
	DT_TRANSACAO.F_TRA_TRANSACAO/init	= $item("DT_SISTEMA", $$gParamGlb)
	TP_SITUACAO.F_TRA_TRANSACAO/init	= 1 ; em andamento
	TP_OPERACAO.F_TRA_TRANSACAO/init	= "S" ; em andamento
	CD_OPERACAO.F_TRA_TRANSACAO/init	= $cdOperacaoVenda$
	retrieve/e "F_TRA_TRANSACAO"
	if ($status >= 0)
		setocc "F_TRA_TRANSACAO", 1
		while ($status > 0)

			$instancehandle->setDisplay("Aguarde, cancelando transação: %%NR_TRANSACAO.F_TRA_TRANSACAO", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif

			viParams	= ""
			putitem/id viParams, "CD_EMPRESA",		CD_EMPRESA.F_TRA_TRANSACAO
			putitem/id viParams, "NR_TRANSACAO",	NR_TRANSACAO.F_TRA_TRANSACAO
			putitem/id viParams, "DT_TRANSACAO",	DT_TRANSACAO.F_TRA_TRANSACAO
			putitem/id viParams, "DS_MOTIVO",		"CANCELAMENTO AUTOMATICO DE TRANSACAO DO USUARIO"
			putitem/id viParams, "TP_SITUACAONF",	"C"
			putitem/id viParams, "IN_PEDIDO",		<FALSE>
			putitem/id viParams, "TP_QUANTIDADEPED", "S"
			putitem/id viParams, "CD_CONFERENTE",	$item("CD_USUARIO", $$gParamGlb)
			putitem/id viParams, "CD_COMPONENTE",	$componentname    
			activate "TRASVCO013".cancelaTransacao($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				rollback
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				rollback
				return(-1)
			endif

			setocc "F_TRA_TRANSACAO", $curocc("F_TRA_TRANSACAO") + 1
		endwhile

		commit	
		if ($status < 0)
			rollback
		endif
	endif

	return(0)

end; verificaTransacaoAberta  ;*