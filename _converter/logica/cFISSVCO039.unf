;------------------------------------
entry converterString
;------------------------------------
	params
		string piString	:In
		string poString	:Out
	endparams
	variables
		string viParams,voParams, vStringAux
	endvariables

	vStringAux = $ltrim(piString," ") ; Tira os espaços em branco a esquerda
	vStringAux = $rtrim(vStringAux," ") ; Tira os espaços em branco a direita

	;poString = $item("DS_STRING",voParams)
	poString   = vStringAux
	
	return (0)
end;

;---------------
Entry ConvString
;---------------
	params
		String  Campo     : IN
		string  StringIn  : IN
		numeric Tamanho   : IN
		string  StringOut : OUT
	endparams
	variables
		string  vChar, vString, vStringAux, v1
		numeric vAux, vPos, vCont
	endvariables
	v1         = " "
	vStringAux = ""
	length StringIn
	vPos   = $result
	if (vPos < 0)
		vPos = 1
	endif
	vCont  = 0
	vAux   = 1
	repeat
		vCont = vCont + 1
		vChar = StringIn[vCont:1] 
		if (Campo = "NR_INSCESTL.FIS_NF")          | %\
			(Campo = "NR_INSCESTL.PES_PESJURIDICA") | %\
			(Campo = "NR_RGINSCREST.FIS_NFREMDES")
			selectcase vChar
				case " "
					vChar = ""
				case "."
					vChar = ""
				case "-"
					vChar = ""
				case "_"
					vChar = ""
				case "\"
					vChar = ""
				case "/"
					vChar = ""
				case "|"
					vChar = ""
				case "*"
					vChar = ""
				case "("
					vChar = ""
				case ")"
					vChar = ""  
			endselectcase
		endif
		vString = "%%vString%%vChar"
		vAux = vAux + 1
	until (vAux > vPos)
	if  (Campo = "NR_INSCESTL.FIS_NF")          | %\
		(Campo = "NR_INSCESTL.PES_PESJURIDICA") | %\
		(Campo = "NR_RGINSCREST.FIS_NFREMDES")
		if (StringIn[1:5] = "ISENT"    )
			StringIn = "ISENTO"
		endif
	endif
	;alinhar a esquerda e completar com espaços em branco à direita
	length vString
	vPos   = $result
	if (vPos <= 0)
		vPos = 0
	endif
	vCont  = 1
	vAux   = 1
	repeat
		if (vAux <= vPos)
			vChar      = vString[vCont:1] 
			vStringAux = "%%vStringAux%%vChar"
			vCont      = vCont + 1
		else
			vStringAux = "%%vStringAux%%v1"
		endif
		vAux = vAux + 1
	until (vAux > Tamanho)
	StringOut = vStringAux
end; endcall ConvString

;----------------
Entry ConvNumeric
;----------------
	params
		string  NumericIn  : IN
		numeric Tamanho    : IN
		string  NumericOut : OUT
	endparams
	variables
		string  vChar, vString, vStringAux, v1
		numeric vAux, vPos, vCont, vTamanho, vQtDigitos
	endvariables
	length NumericIn
	vTamanho = $result
	vCont      = 0
	vStringAux = ""
	;1o. verificar quantos caracteres inválidos existem no meio da informação
	repeat
		vCont = vCont + 1
		vChar = NumericIn[vCont:1] 
		selectcase vChar
			case " "
				vChar = ""
			case "."
				vChar = ""
			case ","
				vChar = ""
			case "+"
				vChar = ""  
			case "-"
				vChar = ""  
			case "\"
				vChar = ""
			case "/"
				vChar = ""
			case "|"
				vChar = ""
			case "*"
				vChar = ""
			case "("
				vChar = ""
			case ")"
				vChar = ""  
			case "_"
				vChar = ""  
		endselectcase
		vString = "%%vString%%vChar"
	until (vCont > vTamanho)

	v1   = "0"
	vAux = 1
	length vString
	;-- MAD [Proj/Tar.170/270] - 01/06/2011
	;vPos = Tamanho - $result
	;if (vPos < 0 )
	;	vPos = 1
	;endif
	vQtDigitos = $result
	vPos = Tamanho - vQtDigitos
	if (vPos < 0)
		vPos = vQtDigitos - Tamanho
		vStringAux = vString[vPos+1,vQtDigitos]
	else
	;;
		vCont  = 0
		;montar o numero, alinhado à direita com zeros à esquerda
		repeat
			if (vAux > vPos)
				vCont = vCont + 1
				vChar = vString[vCont:1] 
				vStringAux = "%%vStringAux%%vChar"
			else
				vStringAux = "%%vStringAux%%v1"
			endif
			vAux = vAux + 1
		until (vAux > Tamanho)
	endif
	NumericOut = vStringAux
	return(0)
end; endcall ConvNumeric

;-------------
Entry EditarNr
;-------------
	params
		numeric  TamInt   :IN
		numeric  TamDec   :IN
		string   ValorIN  :IN
		string   ValorOUT :OUT
	endparams
	variables
		numeric vTam, vInteiro, vDecimal, vCont, v1
		string  vDec, vInt, vAux
	endvariables

	v1       = "0"
	vAux     = ValorIn
	vInteiro = vAux[trunc] ;retira a parte inteira
	vDecimal = vAux[fraction] ;retira a parte decimal
	;para o caso do valor ser maior que a quantidade de bytes do arq.
	length vInteiro
	vTam = $result
	if (vTam > TamInt)
		vTam     = vTam - TamInt
		vInteiro = vInteiro[vTam:TamInt]
		vInt     = vInteiro
	else
		vInt = vInteiro
	endif
	vDec = vDecimal
	if (vDec = 0)
		vDec   = "0"
		vCont  = 1
		repeat
			vDec  = "%%vDec%%v1"
			vCont = vCont + 1
		until (vCont >= TamDec)
	else
		vDec = vDec[3:TamDec]
		length vDec
		vCont = $result
		if (vCont < TamDec )
			repeat
				vDec  = "%%vDec%%v1"
				vCont = vCont + 1
			until (vCont >= TamDec)
		elseif (vCont > TamDec )
			message/error "Erro na Decimal"
		endif  
	endif
	ValorOUT = "%%vInt%%vDec"

End; EditarNr
	

;-----------------
Entry RegistroTpInvent
;-----------------
	params
		numeric pTipo : IN
	endparams
	variables
		numeric vQtDig, vQtSaldo, vVlUnitario, vVlTotal, vTipoEstoque, vNrFat, vQtSaldoTerc
		string vProd, vCdItem, vDsItem, vProdDesc,  viParams, voParams, poCdErro, poCtxErro, vFisTipi
	endvariables
	if (pTipo = 1)
		;if ($scan($produtos$, "-%%CD_PRODUTO.F_PRD_PRODUTOSVC-") = 0)
		;	$produtos$ = "%%$produtos$-%%CD_PRODUTO.F_PRD_PRODUTOSVC-"
		;else
		;	return(-1)
		;endif
		vQtSaldo = 0
		vTipoEstoque = pTipo ; Implementado por Deusdete, verificar c/ Ilis pois não estava gerando o registro H005
		if (vTipoEstoque = 1)
			call buscaSaldo(CD_PRODUTO.F_PRD_PRODUTOSVC, $item("DT_SALDO", $parametro$), vQtSaldo)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
		elseif (vTipoEstoque = 2)
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.F_PRD_PRODUTOSVC
			putitem/id viParams,"CD_EMPRESA", $item("CD_EMPRESA", $parametro$)
			activate "FISSVCO032".buscaQt($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($xCtxErro$)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			vQtSaldo = $item("VL_QTDE", voParams)
		endif

		;--> VSOUZA PRJ/TAR 170/392 11/11/2011
		;if ($item("IN_SALDOTERCEIRO", $parametro$) = <TRUE>)
		;	vQtSaldoTerc = 0
		;	call buscaSaldoTer(CD_PRODUTO.F_PRD_PRODUTOSVC, vQtSaldoTerc, vNrFat)
		;	if ($procerror)
		;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		;	endif
		;endif
		;-------------------------------------<

		if ($item("TP_TIPOSALDO", $parametro$) = 1)
			call buscaValor(CD_PRODUTO.F_PRD_PRODUTOSVC, vVlUnitario)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif       
		endif

		if((($item("TP_TIPOSALDO", $parametro$) = 1) & (vQtSaldo > 0) & (vVlUnitario > 0)) | %\
		   (($item("TP_TIPOSALDO", $parametro$) = 2) & (vQtSaldo < 0)) | %\
		   (($item("TP_TIPOSALDO", $parametro$) = 3) & (vQtSaldo = 0)) | %\
		   ($item("TP_TIPOSALDO", $parametro$) = ""))
		;Registro Tipo 74
			creocc "CSV_SINT74",-1 
			CAMPO01.CSV_SINT74 = "74"
			if ($item("TP_CODPRODUTO", $parametro$) = 1);Grupo
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.F_PRD_PRODUTOSVC
				putitem/id viParams,"CD_SEQ", ""
				activate "FISSVCO032".achaGrupo($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)       
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($xCtxErro$)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				vProd 		= $item("CD_PRODUTO", voParams)
				vProdDesc	= $item("DS_PRODUTO", voParams)

			elseif ($item("TP_CODPRODUTO", $parametro$) = 2);Classificação
				if ($item("CD_TIPOCLAS_ITEM_NF",$xlplemp$) != "")
					vCdItem = ""
					vDsItem = ""
					clear/e "PRD_PRODUTOCLSVC"
					CD_TIPOCLAS.PRD_PRODUTOCLSVC/init = $item("CD_TIPOCLAS_ITEM_NF",$xlplemp$)
					CD_PRODUTO.PRD_PRODUTOCLSVC/init = CD_PRODUTO.F_PRD_PRODUTOSVC
					retrieve/e "PRD_PRODUTOCLSVC"
					if ($status >= 0)
						while ($status >= 0)
							vCdItem = "%%vCdItem%%CD_CLASSIFICACAO.PRD_PRODUTOCLSVC"
							vDsItem = "%%vDsItem%%DS_CLASSIFICACAO.PRD_CLASSIFICSVC "
							setocc "PRD_PRODUTOCLSVC", $curocc("PRD_PRODUTOCLSVC") + 1
						endwhile
						vProd = vCdItem
						vProdDesc = vDsItem
					else
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.F_PRD_PRODUTOSVC
						putitem/id viParams,"CD_SEQ", ""
						activate "FISSVCO032".achaGrupo($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)       
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($xCtxErro$)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif
						vProd 		= $item("CD_PRODUTO", voParams)
						vProdDesc	= $item("DS_PRODUTO", voParams)
					endif
				else
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.F_PRD_PRODUTOSVC
					putitem/id viParams,"CD_SEQ", ""
					activate "FISSVCO032".achaGrupo($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($xCtxErro$)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
					vProd 		= $item("CD_PRODUTO", voParams)
					vProdDesc	= $item("DS_PRODUTO", voParams)
				endif
			elseif ($item("TP_CODPRODUTO", $parametro$) = 3);NCM
				; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
				vFisTipi = ""
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_TIPI", CD_TIPI.F_PRD_PRODUTOSVC
				activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				if (voParams != "")
					vFisTipi = voParams
					vProd = $item("CD_TIPI",vFisTipi)
					vProdDesc = $item("DS_TIPI",vFisTipi)
				; --\-<@
				else
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.F_PRD_PRODUTOSVC
					putitem/id viParams,"CD_SEQ", ""
					activate "FISSVCO032".achaGrupo($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($xCtxErro$)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
					vProd 		= $item("CD_PRODUTO", voParams)
					vProdDesc	= $item("DS_PRODUTO", voParams)
				endif
			else;Produto
				vProd = CD_PRODUTO.F_PRD_PRODUTOSVC
				vProdDesc = DS_PRODUTO.F_PRD_PRODUTOSVC
			endif
;	==== CFC: Tar. 61/322 24/04/2008 - Testar se o código do prod. tem mais que 14 digitos.
			vQtDig = $length(vProd)
;			if (vQtDig > 14)
;				CAMPO03.CSV_SINT74 = vProd[vQtdig - 13:14]
;			else
				CAMPO03.CSV_SINT74 = vProd
;			endif
			;campo 6 código da posse - por enquanto só mercadorias da empresa em sua posse (1)
			;(2 nossa mercadoria cedida a outrem)(3 mercadoria de outrem em nosso poder)

;ICJ 10/02/2011  - A pedido da Analista (Sandra) foi fixado zero para posteriormente 
;                  inserir a validação correta
			;CAMPO06.CSV_SINT74 = vTipoEstoque
			;if (vQtSaldoTerc > 0)
			;	CAMPO06.CSV_SINT74 = "1"
			;else
				CAMPO06.CSV_SINT74 = "0"
			;endif
;ICJ [PROJ/TAR 61/480] (24/09/2008)
			if ($item("TP_CODPRODUTO", $parametro$) != 4)
				retrieve/o "CSV_SINT74"
			endif
			CD_PRODUTO.CSV_SINT74 = CD_PRODUTO.F_PRD_PRODUTOSVC		
			DS_PRODUTO.CSV_SINT74 = vProdDesc
			if ($status = 0) | ($item("TP_CODPRODUTO", $parametro$) = 4)
				CAMPO02.CSV_SINT74 = $item("DT_SALDO", $parametro$) ;$DataFim$
				CAMPO04.CSV_SINT74 = vQtSaldo
				;CAMPO04.CSV_SINT74 = CAMPO04.CSV_SINT74 + vQtSaldo
				vVlUnitario=0
				call buscaValor(CD_PRODUTO.F_PRD_PRODUTOSVC, vVlUnitario)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif       
				vVlTotal = vVlUnitario * vQtSaldo
				;09/02/2011 - ICJ
				;CAMPO05.CSV_SINT74  = vVlTotal[round,2]
				CAMPO05.CSV_SINT74  = vVlUnitario
				CAMPO15.CSV_SINT74  = CAMPO15.CSV_SINT74 + vVlTotal[round,2]
				
				;Campo 7 CNPJ - 1 zeros, 2 CNPJ do quem esta com a mercadoria de outro, 3 CNPJ de quem cedeu a mercadoria
				CAMPO07.CSV_SINT74 = "0"
				;Campo 8 Inscrição Estadual - 1 brancos, 2 Inscr. Est. do outrem, 3 Inscr. Est. do Outrem
				CAMPO08.CSV_SINT74 = " "
				;Campo 9 UF - 1 brancos, 2 do outrem, 3 do Outrem
				CAMPO09.CSV_SINT74 = " "
				;Campo 10 brancos pos 82 a 126
				CAMPO10.CSV_SINT74 = " "
;				call RegistroTp75("P", vProd, vProdDesc)
;ICJ[PROJ/TAR 61/480] (24/09/2008)
			elseif ($status = 4)
				;;09/02/2011 - ICJ
				CAMPO04.CSV_SINT74 = CAMPO04.CSV_SINT74 + vQtSaldo
				;CAMPO04.CSV_SINT74 = vQtSaldo
				vVlUnitario=0
				call buscaValor(CD_PRODUTO.F_PRD_PRODUTOSVC, vVlUnitario)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				endif            
				vVlTotal = vVlUnitario * vQtSaldo
				;09/01/2011 - ICJ
				;CAMPO05.CSV_SINT74  = CAMPO05.CSV_SINT74 + vVlTotal[round,2]
				CAMPO15.CSV_SINT74  = CAMPO15.CSV_SINT74 + vVlTotal[round,2]
				CAMPO05.CSV_SINT74  = vVlUnitario
			endif
		endif
		vTipoEstoque=vTipoEstoque+1
	else
		vTipoEstoque = 1
		vQtSaldo = 0
		vVlUnitario=0	
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_PRODUTO", ""
		putitem/id viParams,"CD_SEQ", CD_SEQ.PRD_GRUPOSVC
		activate "FISSVCO032".achaGrupo($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($xCtxErro$)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		vProd 		= $item("CD_PRODUTO", voParams)
		vProdDesc	= $item("DS_PRODUTO", voParams)

		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $parametro$)
		putitem/id viParams,"CD_SEQ", CD_SEQ.PRD_GRUPOSVC
		putitem/id viParams,"TP_CUSTO", $item("TP_CUSTO", $parametro$)
		putitem/id viParams,"TP_SALDO", $item("TP_SALDO", $parametro$)
		putitem/id viParams,"DT_SALDO", $item("DT_SALDO", $parametro$)
		putitem/id viParams,"CD_PRODUTOGRADE", CD_PRODUTO.PRD_GRUPOSVC
		putitem/id viParams,"CD_EMPRESAVALOREMP", $item("CD_EMPRESA_VALOR", $xlplemp$)
		putitem/id viParams,"CD_EMPRESAVALORSIS", $cdEmpresaValorSis$
		activate "FISSVCO032".buscaValorSaldo($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($xCtxErro$)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		vVlUnitario = $item("VL_VALOR", voParams)
		vQtSaldo	= $item("VL_QTSALDO", voParams)

		;--> VSOUZA PRJ/TAR 170/392 11/11/2011
		;if ($item("IN_SALDOTERCEIRO", $parametro$) = <TRUE>)
		;	vQtSaldoTerc = 0
		;	call buscaSaldoTer(CD_PRODUTO.F_PRD_PRODUTOSVC, vQtSaldoTerc, vNrFat)
		;	if ($procerror)
		;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		;	endif
		;endif
		;-------------------------------------<
		
		if((($item("TP_TIPOSALDO", $parametro$) = 1) & (vQtSaldo > 0)) | %\
		   (($item("TP_TIPOSALDO", $parametro$) = 2) & (vQtSaldo < 0)) | %\
		   (($item("TP_TIPOSALDO", $parametro$) = 3) & (vQtSaldo = 0)) | %\
		   ($item("TP_TIPOSALDO", $parametro$) = ""))
			;Registro Tipo 74
			creocc "CSV_SINT74",-1 
			CAMPO01.CSV_SINT74 = "74"
;ICJ [PROJ/TAR 61/480] (24/09/2008)
			vQtDig = $length(vProd)
;			if (vQtDig > 14)
;				CAMPO03.CSV_SINT74 = vProd[vQtdig - 13:14]
;			else
				CAMPO03.CSV_SINT74 = vProd
;			endif
			;campo 6 código da posse - por enquanto só mercadorias da empresa em sua posse (1)
			;(2 nossa mercadoria cedida a outrem)(3 mercadoria de outrem em nosso poder)
;ICJ 10/02/2011  - A pedido da Analista (Sandra) foi fixado o zero para posteriormente inserir a 
;                  validação correta 
			;CAMPO06.CSV_SINT74 = vTipoEstoque
			;if (vQtSaldoTerc > 0)
			;	CAMPO06.CSV_SINT74 = "1"
			;else
				CAMPO06.CSV_SINT74 = "0"
			;endif
			CAMPO02.CSV_SINT74 = $item("DT_SALDO", $parametro$) ;$DataFim$
			CAMPO04.CSV_SINT74 = "0" ;vQtSaldo
			vVlTotal = vVlUnitario * vQtSaldo
			;;09/02/2011 - ICJ
			;CAMPO05.CSV_SINT74  = vVlTotal[round,2]
			CAMPO05.CSV_SINT74   = "0" ;vVlUnitario
;
			;Campo 7 CNPJ - 1 zeros, 2 CNPJ do quem esta com a mercadoria de outro, 3 CNPJ de quem cedeu a mercadoria
			CAMPO07.CSV_SINT74 = "0"
			;Campo 8 Inscrição Estadual - 1 brancos, 2 Inscr. Est. do outrem, 3 Inscr. Est. do Outrem
			CAMPO08.CSV_SINT74 = " "
			;Campo 9 UF - 1 brancos, 2 do outrem, 3 do Outrem
			CAMPO09.CSV_SINT74 = " "
			;Campo 10 brancos pos 82 a 126
			CAMPO10.CSV_SINT74 = " "
;			call RegistroTp75("P", vProd, vProdDesc)
		endif
	endif
	return (0)
end ; Fim RegistroTp74

;---------------------------------------;
Entry convValorString                   ;
;---------------------------------------;
;
	params
		numeric pDecimal:IN		
		string  piCampo :IN
		string  poCampo :OUT
	endparams
	variables
		string vStringAux
		numeric vQtPos
	endvariables
	vQtPos = $length(piCampo)

	if (vQtPos > pDecimal)
		vStringAux = piCampo[1:vQtPos-pDecimal]
		poCampo = vStringAux
		vStringAux = ","
		poCampo = "%%poCampo%%vStringAux"
		vStringAux = piCampo[(vQtPos-pDecimal)+1:pDecimal]
		poCampo = "%%poCampo%%vStringAux"
	else
		poCampo = "0,%%piCampo"
	endif

	poCampo = $replace(poCampo, 1, ".", "", -1)

	return(0)
End ;operation convValorString.


;-----------------------------------------;
Entry retirarNaoNumerico            		;
;-----------------------------------------;
;
	params
		string piDadoEntra : IN
		string poDadoSai   : OUT
	endparams
	variables
		numeric vTamDado, vCta
	endvariables
	
	if (piDadoEntra = "")
		piDadoEntra = " "
	endif
	
	length piDadoEntra
	vTamDado = $result
	vCta = 0
	poDadoSai= ""
	repeat
		vCta = vCta + 1
		if (piDadoEntra[vCta:1] >= "0") & (piDadoEntra[vCta:1] <= "9")
			poDadoSai= "%%poDadoSai%%piDadoEntra[vCta:1]"
		endif
	until (vCta = vTamDado) 	
	
	return (0)
End ; retirarNaoNumerico.


;---------------------------
Entry buscaSaldo
;---------------------------
	params		
		numeric	piCdProduto	: IN
		date		piDtSaldo	: IN
		numeric	poQtSaldo	: OUT
	endparams

	variables
		string viParams, viListas, voParams
		numeric vQtSaldo
	endvariables

	poQtSaldo = 0

	viParams = ""    
	putitem/id viParams, "CD_PRODUTO", piCdProduto
	; Implementado por Deusdete, verificar c/ Ilis

; -> rodrigo - PRJ 170 TAR 219 - 31/03/2011
;	putitem/id viParams,"TP_SALDO", $item("TP_SALDO", $parametro$)
	putitem/id viParams,"CD_SALDO", $item("TP_SALDO", $parametro$)
; <- rodrigo - PRJ 170 TAR 219 - 31/03/2011

	putitem/id viParams,"DT_SALDO", $item("DT_SALDO", $parametro$)
	;putitem/id viParams, "CD_SALDO", TP_SALDO.FIS_DUMMY
	;putitem/id viParams, "DT_SALDO", piDtSaldo
	;
	putitem/id viParams, "IN_VALIDALOCAL", <FALSE>
	viListas = $item("CD_EMPRESA", $parametro$)

	;viListas = CD_EMPRESA.FIS_DUMMY
	activate "PRDSVCO006".buscaSaldoData($$gParamGlb, viParams, viListas, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($xCdErro$)
		$instancehandle->SetErroApl($xCtxErro$, $xCdErro$, $xCtxErro$)
		return(-1)
	endif  

	poQtSaldo = $item("QT_SALDO", voParams)

	return(0)

End ;buscaSaldo

;---------------------------
Entry buscaValor
;---------------------------
	params
		numeric piCdProduto : IN
		numeric poVlValor : OUT
	endparams
	variables
		string viParams, viListas, voParams
		numeric vCdEmpresa
	endvariables
	poVlValor = ""
	viParams = ""
	putitem/id viParams, $item("CD_EMPRESA", $parametro$)
	putitem/id viParams, "CD_PRODUTO", piCdProduto
	putitem/id viParams, "TP_VALOR", "C"
	putitem/id viParams, "CD_VALOR", $item("TP_CUSTO", $parametro$)
	putitem/id viParams, "DT_VALOR", $item("DT_SALDO", $parametro$)
	putitem/id viParams, "CD_EMPRESA_VALOR", $item("CD_EMPRESA_VALOR", $xlplemp$)
	putitem/id viParams, "CD_EMPVALOR", $cdEmpresaValorSis$
	putitem/id viParams, "IN_PROMOCAO", <TRUE>
	viListas = ""    
	activate "PRDSVCO007".buscaValorData($$gParamGlb, viParams, viListas, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($xCdErro$)
		$instancehandle->SetErroApl($xCtxErro$,$xCdErro$,$xCtxErro$)
		return(-1)
	endif
	poVlValor = $item("VL_VALOR", voParams)
	return(0)
end ; buscaValor



;ICJ [PROJ/TAR 61/784] (24/03/2010)
;----------------------------------------------;
Entry gerarEFDBloco0Reg0500              	     ;
;----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux
		numeric vNumericAux
		date vDtAux
	endvariables

	clear/e "CTB_PLANOSVC"
	CD_POOLEMPRESA.CTB_PLANOSVC/init = $item("CD_POOLEMPRESA", $$gParamGlb)
	retrieve/e "CTB_PLANOSVC"
	setocc "CTB_PLANOSVC", -1
	sort/e "CTB_PLANOSVC", "CD_CONTA.CTB_PLANOSVC"
	setocc "CTB_PLANOSVC", 1
	while ($status >= 0)		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0500", "", "")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
	
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|0500"
		;DT ALT
		vDtAux = DT_CADASTRO.CTB_PLANOSVC
		vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Código da natureza da conta
		call convNumeric(CD_CONTA.CTB_PLANOSVC[1:1], 2, vStringConv)
		vStringAux = "|%%vStringConv"
		vDsConteudo = "%%vDsConteudo%%vStringAux"

		;Indicador da conta
		vStringAux = "|%%TP_NATUREZACTA.CTB_PLANOSVC"
		vDsConteudo = "%%vDsConteudo%%vStringAux"

		;NIVEL
		vStringAux = "|%%CD_NIVEL.CTB_PLANOSVC"
		vDsConteudo = "%%vDsConteudo%%vStringAux"

		;Código da conta
		vStringAux = "|%%CD_CONTA.CTB_PLANOSVC"
		vDsConteudo = "%%vDsConteudo%%vStringAux"

		;Nome da conta
		vStringAux = "|%%NM_CONTA.CTB_PLANOSVC"
		vDsConteudo = "%%vDsConteudo%%vStringAux"

		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		creocc "SIS_ARQUIVOSVC", -1
		DS_REG.SIS_ARQUIVOSVC = "0500"
		DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
		$instancehandle->totalizarQtdTipoRegistro("0500")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		setocc ("CTB_PLANOSVC"), $curocc("CTB_PLANOSVC") + 1
	endwhile
	
	return(0)
End ;gerarEFDBloco0Reg0500.
;

;-------------------------------------------;
;-- MAD [Proj/Tar.170/078] - 10/11/2010     ;
entry buscaRegistroBlocoG                   ;
;-------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		date    vDtIni, vDtFim, vDtAux
		numeric vNrAux, vNumericAux
		string  vTpEntrada, vDsLstNF, vDsRegistro
	endvariables
	
	vDtIni = $item("DT_PERIODOINI", $parametro$)
	vDtFim = $item("DT_PERIODOFIM", $parametro$)

	$vlSaldoCiap$ = 0
	$vlParcela$   = 0
	$vlOutCred$   = 0

	clear/e "TMP_K03DSDTSVC"

	clear/e "V_PAT_CIAPSVC"
	CD_EMPRESA.V_PAT_CIAPSVC/init = $item("CD_EMPRESA", $parametro$)
	retrieve/e "V_PAT_CIAPSVC"
	if ($status >= 0)
		setocc "V_PAT_CIAPSVC",-1
		setocc "V_PAT_CIAPSVC", 1
		while ($status >= 0)

			clear/e "FIS_CIAPCSVC"
			CD_EMPRESA.FIS_CIAPCSVC/init = CD_EMPRESA.V_PAT_CIAPSVC
			NR_CIAP.FIS_CIAPCSVC/init    = NR_CIAP.V_PAT_CIAPSVC
			retrieve/e "FIS_CIAPCSVC"

			if (DT_AQUISICAO.V_PAT_CIAPSVC >= vDtIni) & (DT_AQUISICAO.V_PAT_CIAPSVC <= vDtFim)

				vTpEntrada = ""
				if (TP_ENTRADA.FIS_CIAPCSVC = 1)
					clear/e "PAT_IMOBFICHISVC"
					CD_PRODUTO.PAT_IMOBFICHISVC/init = CD_PRODUTO.V_PAT_CIAPSVC
					NR_SEQIMOB.PAT_IMOBFICHISVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
					retrieve/e "PAT_IMOBFICHISVC"
					if ($status >= 0)
						vTpEntrada = "IA"
					else
						vTpEntrada = "IM"
					endif
				elseif (TP_ENTRADA.FIS_CIAPCSVC = 2)
					vTpEntrada = "CI"
				elseif (TP_ENTRADA.FIS_CIAPCSVC = 3)
					vTpEntrada = "MC"
				endif

				if (vTpEntrada != "")
					creocc "TMP_K03DSDTSVC", -1
					DS_CAMPO1.TMP_K03DSDTSVC = NR_CHAPA.V_PAT_CIAPSVC
					DS_CAMPO2.TMP_K03DSDTSVC = vTpEntrada
					DT_DATA.TMP_K03DSDTSVC   = DT_AQUISICAO.V_PAT_CIAPSVC
					retrieve/o "TMP_K03DSDTSVC"
					if ($status = 4)
						retrieve/x "TMP_K03DSDTSVC"
					elseif ($status = 0)
						CD_PRODUTO.TMP_K03DSDTSVC/init = CD_PRODUTO.V_PAT_CIAPSVC			;ICJ [PROJ/TAR 170/200] (09/03/2011)
						NR_SEQUENCIA.TMP_K03DSDTSVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC	;ICJ [PROJ/TAR 170/200] (09/03/2011)
						if (vTpEntrada = "CI")
							vDsLstNF = ""
							clear/e "PAT_IMOBFICHISVC"
							CD_PRODUTO.PAT_IMOBFICHISVC/init = CD_PRODUTO.V_PAT_CIAPSVC
							NR_SEQIMOB.PAT_IMOBFICHISVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
							retrieve/e "PAT_IMOBFICHISVC"
							if ($status >= 0)
								setocc "PAT_IMOBFICHISVC", 1
								while ($status >= 0)
							
									if (TP_ITEM.PAT_IMOBFICHISVC = 1)
										call buscaRegistroBlocoGItem(1)
										if ($procerror)
											$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
											poCdErro  = $xCdErro$
											poCtxErro = $xCtxErro$
											return(-1)
										elseif ($status < 0)
											$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
											poCdErro  = $xCdErro$
											poCtxErro = $xCtxErro$
											return(-1)
										endif

										if (vDtIni >= "01/01/2011" & vDtFim <= "31/01/2011")
											vDsRegistro = ""
											putitem/id vDsRegistro, "CD_EMPRESA" CD_EMPRESA.PAT_IMOBFICHISVC
											putitem/id vDsRegistro, "NR_FATURA"  NR_FATURA.PAT_IMOBFICHISVC
											putitem/id vDsRegistro, "DT_FATURA"  DT_FATURA.PAT_IMOBFICHISVC
											putitem/id vDsRegistro, "NR_ITEM"    NR_ITEM.PAT_IMOBFICHISVC
											putitem vDsLstNF, -1, vDsRegistro								
										endif
									
									else
										clear/e "PAT_IMOBILIZASVC"
										CD_PRODUTO.PAT_IMOBILIZASVC/init   = CD_PRODCOMP.PAT_IMOBFICHISVC
										NR_SEQUENCIA.PAT_IMOBILIZASVC/init = NR_SEQCOMP.PAT_IMOBFICHISVC
										retrieve/e "PAT_IMOBILIZASVC"
										if ($status >= 0) & (NR_FATURA.PAT_IMOBILIZASVC > 0)
	
											call buscaRegistroBlocoGItem(2)
											if ($procerror)
												$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
												poCdErro  = $xCdErro$
												poCtxErro = $xCtxErro$
												return(-1)
											elseif ($status < 0)
												$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
												poCdErro  = $xCdErro$
												poCtxErro = $xCtxErro$
												return(-1)
											endif

											if (vDtIni >= "01/01/2011" & vDtFim <= "31/01/2011")
												vDsRegistro = ""
												putitem/id vDsRegistro, "CD_EMPRESA" CD_EMPFAT.PAT_IMOBILIZASVC
												putitem/id vDsRegistro, "NR_FATURA"  NR_FATURA.PAT_IMOBILIZASVC
												putitem/id vDsRegistro, "DT_FATURA"  DT_FATURA.PAT_IMOBILIZASVC
												putitem/id vDsRegistro, "NR_ITEM"    NR_ITEMFAT.PAT_IMOBILIZASVC
												putitem vDsLstNF, -1, vDsRegistro
											endif

										endif
									endif
									setocc "PAT_IMOBFICHISVC", $curocc("PAT_IMOBFICHISVC") + 1
								endwhile
							endif
							CD_EMPRESA.TMP_K03DSDTSVC = ""
							NR_FATURA.TMP_K03DSDTSVC  = ""
							DT_FATURA.TMP_K03DSDTSVC  = ""
							NR_ITEM.TMP_K03DSDTSVC    = ""
							DS_LSTNF.TMP_K03DSDTSVC   = vDsLstNF

						else
							clear/e "PAT_IMOBILIZASVC"
							CD_PRODUTO.PAT_IMOBILIZASVC/init   = CD_PRODUTO.V_PAT_CIAPSVC
							NR_SEQUENCIA.PAT_IMOBILIZASVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
							retrieve/e "PAT_IMOBILIZASVC"
							if ($status >= 0) & (NR_FATURA.PAT_IMOBILIZASVC > 0)

								call buscaRegistroBlocoGItem(2)
								if ($procerror)
									$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									poCdErro  = $xCdErro$
									poCtxErro = $xCtxErro$
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									poCdErro  = $xCdErro$
									poCtxErro = $xCtxErro$
									return(-1)
								endif	
							endif
						endif

						clear/e "PAT_IMOBILIZASVC"
						CD_PRODUTO.PAT_IMOBILIZASVC/init   = CD_PRODUTO.V_PAT_CIAPSVC
						NR_SEQUENCIA.PAT_IMOBILIZASVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
						retrieve/e "PAT_IMOBILIZASVC"

						NR_PARCELA.TMP_K03DSDTSVC = 1
						NR_CIAP.TMP_K03DSDTSVC    = NR_CIAP.V_PAT_CIAPSVC

						call buscaRegistroBlocoGItem(3)
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif	
					endif
				endif
			else
				if (DT_AQUISICAO.V_PAT_CIAPSVC < vDtIni)

					if (vDtIni >= "01/01/2011" & vDtFim <= "31/01/2011") & (TP_ENTRADA.FIS_CIAPCSVC = 2) ; "CI"
						vTpEntrada = "SI"
					else
						clear/e "PAT_IMOBFICHISVC"
						CD_PRODUTO.PAT_IMOBFICHISVC/init = CD_PRODUTO.V_PAT_CIAPSVC
						NR_SEQIMOB.PAT_IMOBFICHISVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
						retrieve/e "PAT_IMOBFICHISVC"
						if ($status >= 0)
							vTpEntrada = "IA"
						else	
							vTpEntrada = "SI"
						endif
					endif

					creocc "TMP_K03DSDTSVC", -1
					DS_CAMPO1.TMP_K03DSDTSVC = NR_CHAPA.V_PAT_CIAPSVC
					DS_CAMPO2.TMP_K03DSDTSVC = vTpEntrada
					DT_DATA.TMP_K03DSDTSVC   = vDtIni
					retrieve/o "TMP_K03DSDTSVC"
					if ($status = 4)
						retrieve/x "TMP_K03DSDTSVC"
					elseif ($status = 0)
						CD_PRODUTO.TMP_K03DSDTSVC/init = CD_PRODUTO.V_PAT_CIAPSVC			;ICJ [PROJ/TAR 170/200] (09/03/2011)
						NR_SEQUENCIA.TMP_K03DSDTSVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC	;ICJ [PROJ/TAR 170/200] (09/03/2011)
						clear/e "PAT_IMOBILIZASVC"
						CD_PRODUTO.PAT_IMOBILIZASVC/init   = CD_PRODUTO.V_PAT_CIAPSVC
						NR_SEQUENCIA.PAT_IMOBILIZASVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
						retrieve/e "PAT_IMOBILIZASVC"
						if ($status >= 0) & (NR_FATURA.PAT_IMOBILIZASVC > 0)

							call buscaRegistroBlocoGItem(2)
							if ($procerror)
								$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								poCdErro  = $xCdErro$
								poCtxErro = $xCtxErro$
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								poCdErro  = $xCdErro$
								poCtxErro = $xCtxErro$
								return(-1)
							endif	
						endif

						vNrAux = 1
						vDtAux = DT_AQUISICAO.V_PAT_CIAPSVC
						While (vDtAux < vDtIni)
							vNrAux = vNrAux + 1
							addmonths 1, vDtAux
							vDtAux = $result
						endwhile

						NR_PARCELA.TMP_K03DSDTSVC = vNrAux
						NR_CIAP.TMP_K03DSDTSVC    = NR_CIAP.V_PAT_CIAPSVC

						call buscaRegistroBlocoGItem(3)
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif

						if (vDtIni >= "01/01/2011" & vDtFim <= "31/01/2011") & (TP_ENTRADA.FIS_CIAPCSVC = 2) ; "CI"

							vDsLstNF = ""
							clear/e "PAT_IMOBFICHISVC"
							CD_PRODUTO.PAT_IMOBFICHISVC/init = CD_PRODUTO.V_PAT_CIAPSVC
							NR_SEQIMOB.PAT_IMOBFICHISVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
							retrieve/e "PAT_IMOBFICHISVC"
							if ($status >= 0)
								setocc "PAT_IMOBFICHISVC", 1
								while ($status >= 0)
					
									if (TP_ITEM.PAT_IMOBFICHISVC = 1)
										vDsRegistro = ""
										putitem/id vDsRegistro, "CD_EMPRESA" CD_EMPRESA.PAT_IMOBFICHISVC
										putitem/id vDsRegistro, "NR_FATURA"  NR_FATURA.PAT_IMOBFICHISVC
										putitem/id vDsRegistro, "DT_FATURA"  DT_FATURA.PAT_IMOBFICHISVC
										putitem/id vDsRegistro, "NR_ITEM"    NR_ITEM.PAT_IMOBFICHISVC
										putitem vDsLstNF, -1, vDsRegistro								
									else
										clear/e "PAT_IMOBILIZASVC"
										CD_PRODUTO.PAT_IMOBILIZASVC/init   = CD_PRODCOMP.PAT_IMOBFICHISVC
										NR_SEQUENCIA.PAT_IMOBILIZASVC/init = NR_SEQCOMP.PAT_IMOBFICHISVC
										retrieve/e "PAT_IMOBILIZASVC"
										if ($status >= 0) & (NR_FATURA.PAT_IMOBILIZASVC > 0)
											vDsRegistro = ""
											putitem/id vDsRegistro, "CD_EMPRESA" CD_EMPFAT.PAT_IMOBILIZASVC
											putitem/id vDsRegistro, "NR_FATURA"  NR_FATURA.PAT_IMOBILIZASVC
											putitem/id vDsRegistro, "DT_FATURA"  DT_FATURA.PAT_IMOBILIZASVC
											putitem/id vDsRegistro, "NR_ITEM"    NR_ITEMFAT.PAT_IMOBILIZASVC
											putitem vDsLstNF, -1, vDsRegistro
										endif
									endif
									setocc "PAT_IMOBFICHISVC", $curocc("PAT_IMOBFICHISVC") + 1
								endwhile
								DS_LSTNF.TMP_K03DSDTSVC = vDsLstNF
							endif
						endif
					endif
				endif

				if (DT_BAIXA.FIS_CIAPCSVC != "") & (DT_BAIXA.FIS_CIAPCSVC >= vDtIni & DT_BAIXA.FIS_CIAPCSVC <= vDtFim)
					if (TP_BAIXA.FIS_CIAPCSVC = 3)
						vTpEntrada = "AT"
					elseif (TP_BAIXA.FIS_CIAPCSVC = 4 | TP_BAIXA.FIS_CIAPCSVC = 5)
						vTpEntrada = "PE"
					else
						vTpEntrada = "OT"
					endif

					creocc "TMP_K03DSDTSVC", -1
					DS_CAMPO1.TMP_K03DSDTSVC = NR_CHAPA.V_PAT_CIAPSVC
					DS_CAMPO2.TMP_K03DSDTSVC = vTpEntrada
					DT_DATA.TMP_K03DSDTSVC   = DT_BAIXA.FIS_CIAPCSVC
					retrieve/o "TMP_K03DSDTSVC"
					if ($status = 4)
						retrieve/x "TMP_K03DSDTSVC"
					elseif ($status = 0)
						CD_PRODUTO.TMP_K03DSDTSVC/init = CD_PRODUTO.V_PAT_CIAPSVC			;ICJ [PROJ/TAR 170/200] (09/03/2011)
						NR_SEQUENCIA.TMP_K03DSDTSVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC	;ICJ [PROJ/TAR 170/200] (09/03/2011)
						clear/e "PAT_IMOBALTVLSVC"
						CD_PRODUTO.PAT_IMOBALTVLSVC/init = CD_PRODUTO.V_PAT_CIAPSVC
						NR_SEQIMOB.PAT_IMOBALTVLSVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
						retrieve/e "PAT_IMOBALTVLSVC"
						if ($status >= 0)
							setocc "PAT_IMOBALTVLSVC", 1
							while ($status >= 0)
								clear/e "PAT_OPERACAOSVC"
								CD_OPERACAO.PAT_OPERACAOSVC/init   = CD_OPERACAO.PAT_IMOBALTVLSVC
								TP_MODALIDADE.PAT_OPERACAOSVC/init = 3 ; Baixa
								retrieve/e "PAT_OPERACAOSVC"
								if ($status >= 0)
									clear/e "FIS_NFSVC"
									CD_EMPRESAORI.FIS_NFSVC/init   = CD_EMPTRANSACAO.PAT_IMOBALTVLSVC
									NR_TRANSACAOORI.FIS_NFSVC/init = NR_TRANSACAO.PAT_IMOBALTVLSVC
									DT_TRANSACAOORI.FIS_NFSVC/init = DT_TRANSACAO.PAT_IMOBALTVLSVC
									retrieve/e "FIS_NFSVC"
									if ($status >= 0)
										clear/e "FIS_NFITEMSVC"
										CD_EMPRESA.FIS_NFITEMSVC/init = CD_EMPRESA.FIS_NFSVC
										DT_FATURA.FIS_NFITEMSVC/init  = DT_FATURA.FIS_NFSVC
										NR_FATURA.FIS_NFITEMSVC/init  = NR_FATURA.FIS_NFSVC
										retrieve/e "FIS_NFITEMSVC"
										if ($status >= 0)
											setocc "FIS_NFITEMSVC", 1
											while ($status >= 0)
												if (CD_PRODUTO.V_PAT_CIAPSVC = CD_PRODUTO.FIS_NFITEMPROSVC)
													CD_EMPRESA.TMP_K03DSDTSVC = CD_EMPRESA.FIS_NFITEMSVC
													NR_FATURA.TMP_K03DSDTSVC  = NR_FATURA.FIS_NFITEMSVC
													DT_FATURA.TMP_K03DSDTSVC  = DT_FATURA.FIS_NFITEMSVC
													NR_ITEM.TMP_K03DSDTSVC    = NR_ITEM.FIS_NFITEMSVC
													break
												endif
												setocc "FIS_NFITEMSVC", $curocc("FIS_NFITEMSVC") + 1
											endwhile
										endif
									endif
								endif
								setocc "PAT_IMOBALTVLSVC", $curocc("PAT_IMOBALTVLSVC") + 1
							endwhile
						endif

						clear/e "PAT_IMOBILIZASVC"
						VL_ICMS.TMP_K03DSDTSVC     = ""
						VL_SUBTRIB.TMP_K03DSDTSVC  = ""
						VL_FRETE.TMP_K03DSDTSVC    = ""
						VL_DIFALIQ.TMP_K03DSDTSVC  = ""
						NR_PARCELA.TMP_K03DSDTSVC  = ""
						VL_PARCELA.TMP_K03DSDTSVC  = ""
						NR_CIAP.TMP_K03DSDTSVC     = NR_CIAP.V_PAT_CIAPSVC

						call buscaRegistroBlocoGItem(3)
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif
					endif
					IN_GERA.TMP_K03DSDTSVC = <TRUE>
				endif
				vNrAux = 1
				vDtAux = DT_AQUISICAO.V_PAT_CIAPSVC
				While (vDtAux < vDtIni)
					vNrAux = vNrAux + 1
					addmonths 1, vDtAux
					vDtAux = $result
				endwhile
				;if (DT_SAIDA.FIS_CIAPCSVC != "") & (DT_SAIDA.FIS_CIAPCSVC >= vDtIni & DT_SAIDA.FIS_CIAPCSVC <= vDtFim)
				if (vNrAux = 48) | (vNrAux = 60)
					vTpEntrada = "BA"

					creocc "TMP_K03DSDTSVC", -1
					DS_CAMPO1.TMP_K03DSDTSVC = NR_CHAPA.V_PAT_CIAPSVC
					DS_CAMPO2.TMP_K03DSDTSVC = vTpEntrada
					DT_DATA.TMP_K03DSDTSVC   = vDtIni
					retrieve/o "TMP_K03DSDTSVC"
					if ($status = 4)
						retrieve/x "TMP_K03DSDTSVC"
					elseif ($status = 0)
						CD_PRODUTO.TMP_K03DSDTSVC/init = CD_PRODUTO.V_PAT_CIAPSVC			;ICJ [PROJ/TAR 170/200] (09/03/2011)
						NR_SEQUENCIA.TMP_K03DSDTSVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC	;ICJ [PROJ/TAR 170/200] (09/03/2011)
						clear/e "PAT_IMOBILIZASVC"
						VL_ICMS.TMP_K03DSDTSVC    = ""
						VL_SUBTRIB.TMP_K03DSDTSVC = ""
						VL_FRETE.TMP_K03DSDTSVC   = ""
						VL_DIFALIQ.TMP_K03DSDTSVC = ""
						NR_PARCELA.TMP_K03DSDTSVC = ""
						VL_PARCELA.TMP_K03DSDTSVC = ""
						NR_CIAP.TMP_K03DSDTSVC    = NR_CIAP.V_PAT_CIAPSVC

						call buscaRegistroBlocoGItem(3)
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif
					endif
					IN_GERA.TMP_K03DSDTSVC = <TRUE>
				endif
			endif
			discard "V_PAT_CIAPSVC"
			if ($status = 0)
				$status = -1
			endif
		endwhile
	endif

	clear/e "PAT_IMOBILIZASVC"

	clear/e "PAT_IMOBFICHISVC"
	if (vDtIni < "01/01/2011" | vDtFim > "31/01/2011")
		DT_FATURA.PAT_IMOBFICHISVC/init = $item("DT_PERIODO", $parametro$)
	endif
	TP_ITEM.PAT_IMOBFICHISVC/init = 1
	retrieve/e "PAT_IMOBFICHISVC"
	if ($status >= 0)
		setocc "PAT_IMOBFICHISVC", 1
		while ($status >= 0)

			creocc "TMP_K03DSDTSVC", -1
			DS_CAMPO1.TMP_K03DSDTSVC = CD_PRODFAT.PAT_IMOBFICHISVC
			DS_CAMPO2.TMP_K03DSDTSVC = "IA"
			DT_DATA.TMP_K03DSDTSVC   = DT_FATURA.FIS_NFSVC
			retrieve/o "TMP_K03DSDTSVC"
			if ($status = 4)
				retrieve/x "TMP_K03DSDTSVC"
			elseif ($status = 0)
				CD_PRODUTO.TMP_K03DSDTSVC/init = CD_PRODFAT.PAT_IMOBFICHISVC			;ICJ [PROJ/TAR 170/200] (09/03/2011)
				NR_SEQUENCIA.TMP_K03DSDTSVC/init = NR_SEQIMOB.PAT_IMOBFICHISVC		;ICJ [PROJ/TAR 170/200] (09/03/2011)
				call buscaRegistroBlocoGItem(1)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif

				NR_PARCELA.TMP_K03DSDTSVC = ""
				VL_PARCELA.TMP_K03DSDTSVC = ""
				NR_CIAP.TMP_K03DSDTSVC    = NR_CIAP.V_PAT_CIAPSVC

				call buscaRegistroBlocoGItem(3)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif

				clear/e "FIS_DIFALIQCSVC"
				CD_EMPRESA.FIS_DIFALIQCSVC/init = CD_EMPRESA.PAT_IMOBFICHISVC
				NR_FATURA.FIS_DIFALIQCSVC/init  = NR_FATURA.PAT_IMOBFICHISVC
				DT_FATURA.FIS_DIFALIQCSVC/init  = DT_FATURA.PAT_IMOBFICHISVC
				retrieve/e "FIS_DIFALIQCSVC"
				if ($status >= 0)
					vNumericAux   = VL_DIFALIQ.FIS_DIFALIQCSVC
					vNumericAux   = vNumericAux[round,2]
					$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
					;VL_DIFALIQ.TMP_K03DSDTSVC = VL_DIFALIQ.FIS_DIFALIQCSVC + vNumericAux
					VL_DIFALIQ.TMP_K03DSDTSVC = 0
				endif
			endif
			setocc "PAT_IMOBFICHISVC", $curocc("PAT_IMOBFICHISVC") + 1
		endwhile
	endif
	clear/e "PAT_IMOBFICHISVC"

	return(0)

End ; buscaRegistroBlocoG
;;

;-------------------------------------------;
;-- MAD [Proj/Tar.170/078] - 10/11/2010     ;
entry buscaRegistroBlocoGItem               ;
;-------------------------------------------;

	params
		numeric piTpBusca : IN
	endparams	

	variables
		date    vDtIni, vDtFim
		numeric vNumericAux
	endvariables

	vDtIni = $item("DT_PERIODOINI", $parametro$)
	vDtFim = $item("DT_PERIODOFIM", $parametro$)

	if (piTpBusca = 1)
		CD_EMPRESA.TMP_K03DSDTSVC = CD_EMPRESA.PAT_IMOBFICHISVC
		NR_FATURA.TMP_K03DSDTSVC  = NR_FATURA.PAT_IMOBFICHISVC
		DT_FATURA.TMP_K03DSDTSVC  = DT_FATURA.PAT_IMOBFICHISVC
		NR_ITEM.TMP_K03DSDTSVC    = NR_ITEM.PAT_IMOBFICHISVC

		;---- WMC - 16/02/2011 - CONFORME INSTRUÇÕES DO RENAN
		;clear/e "FIS_NFITEMIMPSVC"
		;CD_EMPRESA.FIS_NFITEMIMPSVC/init = CD_EMPRESA.PAT_IMOBFICHISVC
		;NR_FATURA.FIS_NFITEMIMPSVC/init  = NR_FATURA.PAT_IMOBFICHISVC
		;DT_FATURA.FIS_NFITEMIMPSVC/init  = DT_FATURA.PAT_IMOBFICHISVC
		;NR_ITEM.FIS_NFITEMIMPSVC/init    = NR_ITEM.PAT_IMOBFICHISVC
		;CD_IMPOSTO.FIS_NFITEMIMPSVC/init = 1
		;retrieve/e "FIS_NFITEMIMPSVC"
		;if ($status >= 0)
		;	vNumericAux   = VL_IMPOSTO.FIS_NFITEMIMPSVC
		;	vNumericAux   = vNumericAux[round,2]
		;	$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
		;	VL_ICMS.TMP_K03DSDTSVC = VL_ICMS.TMP_K03DSDTSVC + vNumericAux
		;endif

		;-- MAD [Proj/Tar.189/144] - 26/04/2012
		if (DT_BAIXA.FIS_CIAPCSVC != "" & (DT_BAIXA.FIS_CIAPCSVC < vDtIni | (DT_BAIXA.FIS_CIAPCSVC >= vDtIni & DT_BAIXA.FIS_CIAPCSVC <= vDtFim))) | %\
		   (DT_SAIDA.FIS_CIAPCSVC != "" & (DT_SAIDA.FIS_CIAPCSVC < vDtIni | (DT_SAIDA.FIS_CIAPCSVC >= vDtIni & DT_SAIDA.FIS_CIAPCSVC <= vDtFim)))
			vNumericAux = 0
		else
		;;
			vNumericAux = VL_ICMS.FIS_CIAPCSVC
		endif
		vNumericAux   = vNumericAux[round,2]
		$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
		VL_ICMS.TMP_K03DSDTSVC = VL_ICMS.TMP_K03DSDTSVC + vNumericAux
		;------//------//------

		clear/e "FIS_NFITEMIMPSVC"
		CD_EMPRESA.FIS_NFITEMIMPSVC/init = CD_EMPRESA.PAT_IMOBFICHISVC
		NR_FATURA.FIS_NFITEMIMPSVC/init  = NR_FATURA.PAT_IMOBFICHISVC
		DT_FATURA.FIS_NFITEMIMPSVC/init  = DT_FATURA.PAT_IMOBFICHISVC
		NR_ITEM.FIS_NFITEMIMPSVC/init    = NR_ITEM.PAT_IMOBFICHISVC
		CD_IMPOSTO.FIS_NFITEMIMPSVC/init = 2
		retrieve/e "FIS_NFITEMIMPSVC"
		if ($status >= 0)
			vNumericAux   = VL_IMPOSTO.FIS_NFITEMIMPSVC
			vNumericAux   = vNumericAux[round,2]
			$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
			;VL_SUBTRIB.TMP_K03DSDTSVC = VL_SUBTRIB.TMP_K03DSDTSVC + vNumericAux
			VL_SUBTRIB.TMP_K03DSDTSVC = 0
		endif
	
		clear/e "FIS_NFIMPOSTOSVC"
		CD_EMPRESA.FIS_NFIMPOSTOSVC/init = CD_EMPRESA.PAT_IMOBFICHISVC
		DT_FATURA.FIS_NFIMPOSTOSVC/init  = DT_FATURA.PAT_IMOBFICHISVC
		NR_FATURA.FIS_NFIMPOSTOSVC/init  = NR_FATURA.PAT_IMOBFICHISVC
		CD_IMPOSTO.FIS_NFIMPOSTOSVC/init = 1
		retrieve/e "FIS_NFIMPOSTOSVC"
		if ($status >= 0)
			vNumericAux   = VL_IMPOSTO.FIS_NFIMPOSTOSVC
			vNumericAux   = vNumericAux[round,2]
			$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
			;VL_FRETE.TMP_K03DSDTSVC = VL_FRETE.TMP_K03DSDTSVC + vNumericAux
			VL_FRETE.TMP_K03DSDTSVC = 0
		endif

	elseif (piTpBusca = 2)
		CD_EMPRESA.TMP_K03DSDTSVC = CD_EMPFAT.PAT_IMOBILIZASVC
		NR_FATURA.TMP_K03DSDTSVC  = NR_FATURA.PAT_IMOBILIZASVC
		DT_FATURA.TMP_K03DSDTSVC  = DT_FATURA.PAT_IMOBILIZASVC
		NR_ITEM.TMP_K03DSDTSVC    = NR_ITEMFAT.PAT_IMOBILIZASVC

		;---- WMC - 16/02/2011 - CONFORME INSTRUÇÕES DO RENAN
		;clear/e "FIS_NFITEMIMPSVC"
		;CD_EMPRESA.FIS_NFITEMIMPSVC/init = CD_EMPFAT.PAT_IMOBILIZASVC
		;NR_FATURA.FIS_NFITEMIMPSVC/init  = NR_FATURA.PAT_IMOBILIZASVC
		;DT_FATURA.FIS_NFITEMIMPSVC/init  = DT_FATURA.PAT_IMOBILIZASVC
		;NR_ITEM.FIS_NFITEMIMPSVC/init    = NR_ITEMFAT.PAT_IMOBILIZASVC
		;CD_IMPOSTO.FIS_NFITEMIMPSVC/init = 1
		;retrieve/e "FIS_NFITEMIMPSVC"
		;if ($status >= 0)
		;	vNumericAux   = VL_IMPOSTO.FIS_NFITEMIMPSVC
		;	vNumericAux   = vNumericAux[round,2]
		;	$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
		;	VL_ICMS.TMP_K03DSDTSVC = VL_ICMS.TMP_K03DSDTSVC + vNumericAux
		;endif

		;-- MAD [Proj/Tar.189/144] - 26/04/2012
		if (DT_BAIXA.FIS_CIAPCSVC != "" & (DT_BAIXA.FIS_CIAPCSVC < vDtIni | (DT_BAIXA.FIS_CIAPCSVC >= vDtIni & DT_BAIXA.FIS_CIAPCSVC <= vDtFim))) | %\
		   (DT_SAIDA.FIS_CIAPCSVC != "" & (DT_SAIDA.FIS_CIAPCSVC < vDtIni | (DT_SAIDA.FIS_CIAPCSVC >= vDtIni & DT_SAIDA.FIS_CIAPCSVC <= vDtFim)))
			vNumericAux = 0
		else
		;;
			vNumericAux = VL_ICMS.FIS_CIAPCSVC
		endif
		vNumericAux   = vNumericAux[round,2]
		$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
		VL_ICMS.TMP_K03DSDTSVC = VL_ICMS.TMP_K03DSDTSVC + vNumericAux
		;------//------//------

		clear/e "FIS_NFITEMIMPSVC"
		CD_EMPRESA.FIS_NFITEMIMPSVC/init = CD_EMPFAT.PAT_IMOBILIZASVC
		NR_FATURA.FIS_NFITEMIMPSVC/init  = NR_FATURA.PAT_IMOBILIZASVC
		DT_FATURA.FIS_NFITEMIMPSVC/init  = DT_FATURA.PAT_IMOBILIZASVC
		NR_ITEM.FIS_NFITEMIMPSVC/init    = NR_ITEMFAT.PAT_IMOBILIZASVC
		CD_IMPOSTO.FIS_NFITEMIMPSVC/init = 2
		retrieve/e "FIS_NFITEMIMPSVC"
		if ($status >= 0)
			vNumericAux   = VL_IMPOSTO.FIS_NFITEMIMPSVC
			vNumericAux   = vNumericAux[round,2]
			$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
			;VL_SUBTRIB.TMP_K03DSDTSVC = VL_SUBTRIB.TMP_K03DSDTSVC + vNumericAux
			VL_SUBTRIB.TMP_K03DSDTSVC = 0
		endif
		
		clear/e "FIS_NFIMPOSTOSVC"
		CD_EMPRESA.FIS_NFIMPOSTOSVC/init = CD_EMPFAT.PAT_IMOBILIZASVC
		DT_FATURA.FIS_NFIMPOSTOSVC/init  = DT_FATURA.PAT_IMOBILIZASVC
		NR_FATURA.FIS_NFIMPOSTOSVC/init  = NR_FATURA.PAT_IMOBILIZASVC
		CD_IMPOSTO.FIS_NFIMPOSTOSVC/init = 1
		retrieve/e "FIS_NFIMPOSTOSVC"
		if ($status >= 0)
			vNumericAux   = VL_IMPOSTO.FIS_NFIMPOSTOSVC
			vNumericAux   = vNumericAux[round,2]
			$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
			;VL_FRETE.TMP_K03DSDTSVC = VL_FRETE.TMP_K03DSDTSVC + vNumericAux
			VL_FRETE.TMP_K03DSDTSVC = 0
		endif

	elseif (piTpBusca = 3)
		if (NR_CIAP.TMP_K03DSDTSVC > 0)
			clear/e "FIS_CIAPOUTSVC"
			CD_EMPRESA.FIS_CIAPOUTSVC/init = $item("CD_EMPRESA", $parametro$)
			DT_MESANO.FIS_CIAPOUTSVC/init  = "01%%%/%%vDtIni[m]%%%/%%vDtFim[y]"
			NR_CIAP.FIS_CIAPOUTSVC/init    = NR_CIAP.TMP_K03DSDTSVC
			retrieve/e "FIS_CIAPOUTSVC"
			if ($status >= 0)
				vNumericAux = VL_APROP.FIS_CIAPOUTSVC
				vNumericAux = vNumericAux[round,2]
				$vlOutCred$ = $vlOutCred$ + vNumericAux
			endif
		endif

		if (NR_PARCELA.TMP_K03DSDTSVC > 0)
			clear/e "FIS_CIAPISVC"
			;-- MAD [Proj/Tar.170/320] - 04/07/2011
			;NR_SEQ.FIS_CIAPISVC/init = NR_PARCELA.TMP_K03DSDTSVC
			DT_MESANO.FIS_CIAPISVC/init = "01%%%/%%vDtIni[m]%%%/%%vDtIni[y]"
			;;
			retrieve/e "FIS_CIAPISVC"
			if ($status >= 0)
				;-- MAD [Proj/Tar.175/189] - 14/07/2011
				;vNumericAux = VL_APROPRIACAO.FIS_CIAPISVC
				;vNumericAux = vNumericAux[round,2]
				;$vlParcela$ = $vlParcela$ + vNumericAux
				;VL_PARCELA.TMP_K03DSDTSVC = vNumericAux
				$vlParcela$ = $vlParcela$ + VL_APROPRIACAO.FIS_CIAPISVC
				VL_PARCELA.TMP_K03DSDTSVC = VL_APROPRIACAO.FIS_CIAPISVC
				;;
				if (VL_APROPRIACAO.FIS_CIAPISVC >= 0)
					IN_GERA.TMP_K03DSDTSVC = <TRUE>
				else
					IN_GERA.TMP_K03DSDTSVC = <FALSE>
				endif
			endif
		endif

		if (NR_FATURA.PAT_IMOBILIZASVC > 0)
			clear/e "FIS_DIFALIQCSVC"
			CD_EMPRESA.FIS_DIFALIQCSVC/init = CD_EMPFAT.PAT_IMOBILIZASVC
			NR_FATURA.FIS_DIFALIQCSVC/init  = NR_FATURA.PAT_IMOBILIZASVC
			DT_FATURA.FIS_DIFALIQCSVC/init  = DT_FATURA.PAT_IMOBILIZASVC
			retrieve/e "FIS_DIFALIQCSVC"
			if ($status >= 0)
				vNumericAux   = VL_DIFALIQ.FIS_DIFALIQCSVC
				vNumericAux   = vNumericAux[round,2]
				$vlSaldoCiap$ = $vlSaldoCiap$ + vNumericAux
				;VL_DIFALIQ.TMP_K03DSDTSVC = VL_DIFALIQ.FIS_DIFALIQCSVC + vNumericAux
				VL_DIFALIQ.TMP_K03DSDTSVC = 0
			endif
		endif
	endif

	return(0)

End ; buscaRegistroBlocoGItem
;;

;-------------------------------------------;
;-- MAD [Proj/Tar.170/329] - 03/08/2011     ;
entry achaNumero                            ;
;-------------------------------------------;

	params        
		string  piNumero : IN
		numeric poNumero : OUT
	endparams
	
	length(piNumero)
	while ($result > 0)
		if (piNumero[1 : 1] >= 0 & piNumero[1 : 1] <= 9 & piNumero[1 : 1] != " ")
			poNumero = "%%poNumero%%piNumero[1 : 1]"
		endif
		piNumero = piNumero[2]
		length(piNumero)
	endwhile

	poNumero = (poNumero / 100)

	return(0)

End ; achaNumero
;;

;--------------------------------------
;entry buscaSaldoTer
;;--> VSOUZA PRJ/TAR 170/392 11/11/2011
;;--------------------------------------
;params;
;	numeric piCdProduto	: IN
;	numeric pQtde			: OUT
;	numeric pNrFAT			: OUT
;endparams
;
;variables
;	string  vpiParams, vpoParams, voParams, viParams
;	numeric vQtSaldoTerc
;endvariables
;
;	clear/e "PRD_PESMOVSVC"
;	CD_EMPRESA.PRD_PESMOVSVC/init 	= $item("CD_EMPRESA", $parametro$)
;	CD_PRODUTO.PRD_PESMOVSVC/init 	= piCdProduto
;	DT_MOVIMENTO.PRD_PESMOVSVC/init	= $item("DT_SALDO", $parametro$)
;	retrieve/e "PRD_PESMOVSVC"
;	if ($status >=0)
;		setocc "PRD_PESMOVSVC", -1
;		sort "PRD_PESMOVSVC", "DT_MOVIMENTO.PRD_PESMOVSVC DESC"
;		setocc "PRD_PESMOVSVC", 1
;		vQtSaldoTerc = 0
;		pNrFAT = NR_DCTOORIGEM.PRD_PESMOVSVC
;		while ($status >= 0)
;			vQtSaldoTerc = vQtSaldoTerc + QT_MOVIMENTADA.PRD_PESMOVSVC
;			setocc "PRD_PESMOVSVC", $curocc("PRD_PESMOVSVC") + 1
;		endwhile
;	endif
;
;	pQtde = vQtSaldoTerc
;
;	return(0)
;
;End ; buscaSaldoTer



;-----------------
Entry RegistroPrdInv
;-----------------
	variables
		numeric vQtDig 
		string vProd, vProdDesc, viParams, voParams, vPesPessoa, vStringAux, vDsEndereco
		string vPesFisica, vPesJuridica, vPesCliente, vGlbLogradouro, vCdEstado, vPesEndereco
	endvariables
	
	creocc "CSV_SINT74",-1 
	CAMPO01.CSV_SINT74 = "74"
	vProd = CD_IMPRESSAO.PRD_INVISVC
	vProdDesc = DS_IMPRESSAO.PRD_INVISVC
	vQtDig = $length(vProd)
;	if (vQtDig > 14)
;		CAMPO03.CSV_SINT74 = vProd[vQtdig - 13:14]
;	else
		CAMPO03.CSV_SINT74 = vProd
;	endif
	;campo 6 código da posse - por enquanto só mercadorias da empresa em sua posse (1)
	;(2 nossa mercadoria cedida a outrem)(3 mercadoria de outrem em nosso poder)

	if (TP_PROCESSAMENTO.PRD_INVCSVC = "3")
		CAMPO06.CSV_SINT74 = "1"	
	else
		CAMPO06.CSV_SINT74 = "0"	
	endif
	CD_PRODUTO.CSV_SINT74 = vProd
	DS_PRODUTO.CSV_SINT74 = vProdDesc
	CAMPO02.CSV_SINT74 = $item("DT_SALDO", $parametro$) ;$DataFim$
	CAMPO04.CSV_SINT74 = QT_SALDO.PRD_INVISVC
	CAMPO05.CSV_SINT74  = VL_UNITARIO.PRD_INVISVC
	CAMPO15.CSV_SINT74  = VL_TOTAL.PRD_INVISVC

	if (TP_PROCESSAMENTO.PRD_INVCSVC != 3) | ((TP_PROCESSAMENTO.PRD_INVCSVC = 3) & (CD_PESSOA.PRD_INVISVC = ""))
				
		;Campo 7 CNPJ - 1 zeros, 2 CNPJ do quem esta com a mercadoria de outro, 3 CNPJ de quem cedeu a mercadoria
		CAMPO07.CSV_SINT74 = "0"
		;Campo 8 Inscrição Estadual - 1 brancos, 2 Inscr. Est. do outrem, 3 Inscr. Est. do Outrem
		CAMPO08.CSV_SINT74 = " "
		;Campo 9 UF - 1 brancos, 2 do outrem, 3 do Outrem
		CAMPO09.CSV_SINT74 = " "
		;Campo 10 brancos pos 82 a 126
		CAMPO10.CSV_SINT74 = " "
	else
		CD_PESSOA.CSV_SINT74 = CD_PESSOA.PRD_INVISVC
		viParams = ""		
		voParams = ""
		putitem/id viParams,"CD_PESSOA", CD_PESSOA.PRD_INVISVC
		activate "PESSVCO005".buscaDadosPessoa($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
         	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif				
		;Campo 7 CNPJ - 1 zeros, 2 CNPJ do quem esta com a mercadoria de outro, 3 CNPJ de quem cedeu a mercadoria
		CAMPO07.CSV_SINT74 = $item("NR_CPFCNPJ", voParams)
		;Campo 8 Inscrição Estadual - 1 brancos, 2 Inscr. Est. do outrem, 3 Inscr. Est. do Outrem
		CAMPO08.CSV_SINT74 = $item("NR_INSCESTL", voParams)

		viParams = ""		
		voParams = ""
		putitem/id viParams,"CD_PESSOA", CD_PESSOA.PRD_INVISVC
		activate "PESSVCO005".buscarEndereco(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
         	;$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			;$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif				
		;Campo 9 UF - 1 brancos, 2 do outrem, 3 do Outrem
		CAMPO09.CSV_SINT74 = $item("DS_SIGLAESTADO", voParams)
		;;
		CAMPO10.CSV_SINT74 = " "

		creocc "F_TMP_NR09SVC", -1
		nr_geral.f_tmp_nr09svc = CD_PESSOA.PRD_INVISVC
		retrieve/o "F_TMP_NR09SVC"
		if ($status = 4)
			retrieve/x "F_TMP_NR09SVC"
		endif
	
		viParams   = ""
		vPesPessoa = ""
		putitem/id viParams, "CD_PESSOA",CD_PESSOA.PRD_INVISVC
		activate "FISSVCO032".carregaPessoa($$gParamGlb, viParams, vPesPessoa, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		nm_cliente.f_tmp_nr09svc = $item("NM_PESSOA",vPesPessoa)
		tp_pessoa.f_tmp_nr09svc  = $item("TP_PESSOA",vPesPessoa)

		if (tp_pessoa.f_tmp_nr09svc = "F")
			viParams   = ""
			vPesFisica = ""
			putitem/id viParams, "CD_PESSOA", CD_PESSOA.PRD_INVISVC
			activate "FISSVCO032".carregaPesFisica($$gParamGlb, viParams, vPesFisica, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			nr_cpf.f_tmp_nr09svc     = $item("NR_CPFCNPJ",vPesPessoa)
			nr_rginscr.f_tmp_nr09svc = $item("NR_RG",vPesFisica)
		else
			viParams     = ""
			vPesJuridica = ""
			putitem/id viParams, "CD_PESSOA", CD_PESSOA.PRD_INVISVC
			activate "FISSVCO032".carregaPesJuridica($$gParamGlb, viParams, vPesJuridica, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			nr_cnpj.f_tmp_nr09svc    = $item("NR_CPFCNPJ",vPesPessoa)
			nr_rginscr.f_tmp_nr09svc = $item("NR_INSCESTL",vPesJuridica)
		endif
	
		vPesCliente = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_CLIENTE", CD_PESSOA.PRD_INVISVC
		activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vPesCliente = voParams
		endif
		NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)

		viParams     = ""
		vPesEndereco = ""
		putitem/id viParams, "CD_PESSOA", CD_PESSOA.PRD_INVISVC
		activate "FISSVCO032".carregaVEndereco($$gParamGlb, viParams, vPesEndereco, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		vStringAux  = $item("DS_SIGLALOGRAD",vPesEndereco)
		vDsEndereco = $item("NM_LOGRADOURO",vPesEndereco)
		ds_logradouro.f_tmp_nr09svc = "%%vStringAux %%vDsEndereco"
		nr_logradouro.f_tmp_nr09svc = $item("NR_LOGRADOURO",vPesEndereco)
		nm_bairro.f_tmp_nr09svc     = $item("DS_BAIRRO",vPesEndereco)

		if ($item("CD_CEP",vPesEndereco) != 99999999)
			vGlbLogradouro = ""
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_CEP", $item("CD_CEP",vPesEndereco)
			activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			if (voParams != "")
				vGlbLogradouro = voParams
			endif				
			vCdEstado = ""
			vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
			
			cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
			cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
			ds_estado.f_tmp_nr09svc    = vCdEstado
			ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
		endif



	endif
	return (0)
end ; Fim RegistroPrdInv

;;ICJ [PROJ/TAR 189/64] (12/01/2012)
;-----------------
Entry RegistroInventTerc
;-----------------
	Params
		numeric pQtEstoque : IN
	endParams

	variables
		numeric vQtDig, vVlTotal, vVlUnitario, vQtSaldo
 		string vProd, vProdDesc, viParams, voParams, vStringAux, vDsEndereco, vPesPessoa
		string vPesFisica, vPesJuridica, vPesCliente, vGlbLogradouro, vCdEstado, vPesEndereco
	endvariables

	if((($item("TP_TIPOSALDO", $parametro$) = 1) & (pQtEstoque > 0)) | %\
	   (($item("TP_TIPOSALDO", $parametro$) = 2) & (pQtEstoque < 0)) | %\
	   (($item("TP_TIPOSALDO", $parametro$) = 3) & (pQtEstoque = 0)) | %\
	   ($item("TP_TIPOSALDO", $parametro$) = ""))
	
		creocc "CSV_SINT74",-1 
		CAMPO01.CSV_SINT74 = "74"
		clear/e "F_PRD_PRODUTOSVC"
		CD_PRODUTO.F_PRD_PRODUTOSVC/init = CD_PRODUTO.PRD_PESMOVSVC
		retrieve/e "F_PRD_PRODUTOSVC"
		if ($status >= 0)
			vProd = CD_PRODUTO.F_PRD_PRODUTOSVC
			vProdDesc = DS_PRODUTO.F_PRD_PRODUTOSVC
		endif
		vQtDig = $length(vProd)
;		if (vQtDig > 14)
;			CAMPO03.CSV_SINT74 = vProd[vQtdig - 13:14]
;		else
			CAMPO03.CSV_SINT74 = vProd
;		endif
		;campo 6 código da posse - por enquanto só mercadorias da empresa em sua posse (1)
		;(2 nossa mercadoria cedida a outrem)(3 mercadoria de outrem em nosso poder)
		CAMPO06.CSV_SINT74 = "1"	
		CD_PRODUTO.CSV_SINT74 = vProd
		DS_PRODUTO.CSV_SINT74 = vProdDesc
		CAMPO02.CSV_SINT74 = $item("DT_SALDO", $parametro$) ;$DataFim$
		vQtSaldo = pQtEstoque
		CAMPO04.CSV_SINT74 = vQtSaldo

		vVlUnitario=0
		call buscaValor(CD_PRODUTO.PRD_PESMOVSVC, vVlUnitario)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		endif       
		vVlTotal = vVlUnitario * vQtSaldo
		CAMPO05.CSV_SINT74  = vVlUnitario
		CAMPO15.CSV_SINT74  = vVlTotal
		CD_PESSOA.CSV_SINT74 = CD_PESSOA.PRD_PESMOVSVC
		viParams = ""		
		voParams = ""
		putitem/id viParams,"CD_PESSOA", CD_PESSOA.PRD_PESMOVSVC
		activate "PESSVCO005".buscaDadosPessoa($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
	   	  	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif				
		;Campo 7 CNPJ - 1 zeros, 2 CNPJ do quem esta com a mercadoria de outro, 3 CNPJ de quem cedeu a mercadoria
		CAMPO07.CSV_SINT74 = $item("NR_CPFCNPJ", voParams)
		;Campo 8 Inscrição Estadual - 1 brancos, 2 Inscr. Est. do outrem, 3 Inscr. Est. do Outrem
		CAMPO08.CSV_SINT74 = $item("NR_INSCESTL", voParams)

		viParams = ""		
		voParams = ""
		putitem/id viParams,"CD_PESSOA", CD_PESSOA.PRD_PESMOVSVC
		activate "PESSVCO005".buscarEndereco(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)       
	     	;$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		elseif ($status < 0)
			;$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		endif				
		;Campo 9 UF - 1 brancos, 2 do outrem, 3 do Outrem
		CAMPO09.CSV_SINT74 = $item("DS_SIGLAESTADO", voParams)
		;;
		CAMPO10.CSV_SINT74 = " "

		creocc "F_TMP_NR09SVC", -1
		nr_geral.f_tmp_nr09svc = CD_PESSOA.PRD_PESMOVSVC
		retrieve/o "F_TMP_NR09SVC"
		if ($status = 4)
			retrieve/x "F_TMP_NR09SVC"
		endif
	
		viParams   = ""
		vPesPessoa = ""
		putitem/id viParams, "CD_PESSOA",CD_PESSOA.PRD_PESMOVSVC
		activate "FISSVCO032".carregaPessoa($$gParamGlb, viParams, vPesPessoa, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		nm_cliente.f_tmp_nr09svc = $item("NM_PESSOA",vPesPessoa)
		tp_pessoa.f_tmp_nr09svc  = $item("TP_PESSOA",vPesPessoa)

		if (tp_pessoa.f_tmp_nr09svc = "F")
			viParams   = ""
			vPesFisica = ""
			putitem/id viParams, "CD_PESSOA", CD_PESSOA.PRD_PESMOVSVC
			activate "FISSVCO032".carregaPesFisica($$gParamGlb, viParams, vPesFisica, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			nr_cpf.f_tmp_nr09svc     = $item("NR_CPFCNPJ",vPesPessoa)
			nr_rginscr.f_tmp_nr09svc = $item("NR_RG",vPesFisica)
		else
			viParams     = ""
			vPesJuridica = ""
			putitem/id viParams, "CD_PESSOA", CD_PESSOA.PRD_PESMOVSVC
			activate "FISSVCO032".carregaPesJuridica($$gParamGlb, viParams, vPesJuridica, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			nr_cnpj.f_tmp_nr09svc    = $item("NR_CPFCNPJ",vPesPessoa)
			nr_rginscr.f_tmp_nr09svc = $item("NR_INSCESTL",vPesJuridica)
		endif
	
		vPesCliente = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_CLIENTE", CD_PESSOA.PRD_PESMOVSVC
		activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vPesCliente = voParams
		endif
		NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)

		viParams     = ""
		vPesEndereco = ""
		putitem/id viParams, "CD_PESSOA", CD_PESSOA.PRD_PESMOVSVC
		activate "FISSVCO032".carregaVEndereco($$gParamGlb, viParams, vPesEndereco, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		vStringAux  = $item("DS_SIGLALOGRAD",vPesEndereco)
		vDsEndereco = $item("NM_LOGRADOURO",vPesEndereco)
		ds_logradouro.f_tmp_nr09svc = "%%vStringAux %%vDsEndereco"
		nr_logradouro.f_tmp_nr09svc = $item("NR_LOGRADOURO",vPesEndereco)
		nm_bairro.f_tmp_nr09svc     = $item("DS_BAIRRO",vPesEndereco)

		if ($item("CD_CEP",vPesEndereco) != 99999999)
			vGlbLogradouro = ""
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_CEP", $item("CD_CEP",vPesEndereco)
			activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			if (voParams != "")
				vGlbLogradouro = voParams
			endif				
			vCdEstado = ""
			vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
			
			cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
			cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
			ds_estado.f_tmp_nr09svc    = vCdEstado
			ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
		endif
	endif
	return (0)
end ; RegistroInventTerc
;;

;----------------------------------
entry validaConta
; rodrigo - prj 189 tar 220 - 04/09/2012
;----------------------------------
	params
		numeric piReduzido 	: IN
		string  poCdConta		: OUT
	endparams

	variables
		string viParams, voParams
	endvariables

	clear/e "CTB_PLANOSVC"
	CD_POOLEMPRESA.CTB_PLANOSVC/init = $item("CD_POOLEMPRESA", $$gParamGlb)
	CD_REDUZIDO.CTB_PLANOSVC/init = piReduzido
	retrieve/e "CTB_PLANOSVC"
	if ($status >= 0)
		poCdConta = CD_CONTA.CTB_PLANOSVC
	endif

	return (0)

End ; validaConta

;---------------------
public operation Init
;---------------------
	variables
		string viParams, voParams
	endvariables

	#include <LIB_PADRAO>:PRC_INIT

	viParams = ""
	putitem viParams, -1, "CD_EMPVALOR"
	putitem viParams, -1, "DS_SIGLA_EXTIPI" ;--> VSOUZA PRJ/TAR 170/397 18/11/2011
	putitem viParams, -1, "CD_TPCLASS_PROD" ; rodrigo - prj 189 tar 220 - 04/09/2012
	activate "ADMSVCO001".GetLstParametro(viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($xCdErro$)
		$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=%%$item("DESCRICAO", $xCtxErro$)", "ADICIONAL=Operação->FISSVCO039")
		return(-1)
	elseif ($status < 0)
		return(-1)
	endif
	$cdEmpresaValorSis$ = $item("CD_EMPVALOR"    , voParams)
	$dsSiglaExTipi$     = $item("DS_SIGLA_EXTIPI", voParams)
	$cdTpClassProd$     = $item("CD_TPCLASS_PROD", voParams); rodrigo - prj 189 tar 220 - 04/09/2012

	;Parametros por empresa
	$xlplemp$ = ""
	putitem $xlplemp$, -1, "CD_TIPOCLAS_ITEM_NF"
	putitem $xlplemp$, -1, "CD_EMPRESA_VALOR"
	putitem $xlplemp$, -1, "NATUREZA_COMERCIAL_EMP"
	putitem $xlplemp$, -1, "UF_ORIGEM"
	putitem $xlplemp$, -1, "CD_CONSUMO_ENERGIA"
	putitem $xlplemp$, -1, "CD_TIPO_LIGACAO"
	putitem $xlplemp$, -1, "CD_GRUPO_TENSAO"
	putitem $xlplemp$, -1, "IN_GERA_REGC140_FIN"       ;-- ICJ [PROJ/TAR 170/87]   (23/09/2010)
	putitem $xlplemp$, -1, "IN_ESCRITURA_CIAP"         ;-- MAD [Proj/Tar.170/074] - 15/10/2010
	putitem $xlplemp$, -1, "IN_GERAR_STDEV_OBS"        ;-- ICJ [PROJ/TAR 170/118]  (07/11/2010)
	putitem $xlplemp$, -1, "IN_INFORMA_BCICMS_OUT"     ;-- MAD [Proj/Tar.170/117] - 22/11/2010
	putitem $xlplemp$, -1, "IN_CONSIDERA_DTEMIS_NFSAI" ;-- WMC [Proj 175 Tar 052] -(08/02/2011)
	putitem $xlplemp$, -1, "CD_EMP_PADRAO_PRD"	         ;-- ICJ [PROJ/TAR 170/196]  (17/02/2011)
	putitem $xlplemp$, -1, "TP_CCUSTO_PAT"             ; rodrigo - PRJ 166 TAR 78
	putitem $xlplemp$, -1, "IN_GERA_REG_CARTAO"        ; --\-<@ Virginia - 175/142 - 12/05/2011
	putitem $xlplemp$, -1, "IN_OPT_SIMPLES"            ;-- MAD [Proj/Tar.170/329] - 03/08/2011
	putitem $xlplemp$, -1, "TP_APUR_ICMS" 				 ;ICJ [PROJ/TAR 170/419] (20/04/2012)
	putitem $xlplemp$, -1, "IN_GERA_C170_SPED" 		 ; rodrigo - prj 170 tar 549 - 17/09/2012
	putitem $xlplemp$, -1, "IN_CALC_IMPDEV_SN" 		 ;->RIM [170/555] 21/09/2012
	activate "ADMSVCO001".GetParamEmpresa($item("CD_EMPRESA", $$gParamGlb), $xlplemp$, $xlplemp$, $xcderro$, $xctxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	elseif ($xcdErro$)
		$instancehandle->SetErroApl($xCtxErro$, $xCdErro$, $xCtxErro$)
	endif

	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	$inConsideraDtemisNfsai$ = $item("IN_CONSIDERA_DTEMIS_NFSAI", $xlplemp$)
	;------//------//------
	$tpCCustoPat$     = $item("TP_CCUSTO_PAT"     , $xlplemp$) ; rodrigo - PRJ 166 TAR 78
	$inGeraRegCartao$ = $item("IN_GERA_REG_CARTAO", $xlplemp$) ; --\-<@ Virginia - 175/142 - 12/05/2011
	$inOptSimples$    = $item("IN_OPT_SIMPLES"    , $xlplemp$) ;-- MAD [Proj/Tar.170/329] - 03/08/2011
	$tpApurIcms$      = $item("TP_APUR_ICMS"	    , $xlplemp$) ;ICJ [PROJ/TAR 170/419] (20/04/2012)
	$inGeraC170Sped$  = $item("IN_GERA_C170_SPED" , $xlplemp$) ; rodrigo - prj 170 tar 549 - 17/09/2012
	$inCalcImpdevSn$  = $item("IN_CALC_IMPDEV_SN" , $xlplemp$) ;->RIM [170/555] 21/09/2012

End ; operation Init

----------------------------
public operation gerarEFD 
;----------------------------
	params
		string  piGlobal  :IN
		string  piParams  :IN
		string  poParams  :OUT
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams

	variables
		date   vDtInicial
		string viParams, voParams, vOcc, vDsArquivoPath
	endvariables

	$nrLinhaArquivo$ = 0
	vDsArquivoPath   = $item("DS_PATH", $parametro$)
	$inGeraReg0600$  = <FALSE>

	clear/e "TMP_DS40SVC"
	clear/e "CSV_SINT74"
	clear/e "F_TMP_NRDSSVC"

	$parametro$ = piParams

	;Abertura do bloco 0.
	$instancehandle->gerarEFDBloco0($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	endif

	;Abertura do bloco C.
	$instancehandle->gerarEFDBlocoC($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	endif
	
	;Abertura do bloco D.
	$instancehandle->gerarEFDBlocoD($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	endif
	
	;Abertura do bloco E.
	$instancehandle->gerarEFDBlocoE($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	endif

	;-- MAD [Proj/Tar.170/077] - 26/10/2010
	vDtInicial = $item("DT_PERIODOINI", $parametro$)
	if (vDtInicial >= "01/01/2011")
		;Abertura do bloco G.
		$instancehandle->gerarEFDBlocoG($xCdErro$,$xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			rollback
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			rollback
			return(-1)
		endif
	endif
	;;
	
	;Abertura do bloco H.
	$instancehandle->gerarEFDBlocoH($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	endif
	
	;Abertura do bloco 1.
	$instancehandle->gerarEFDBloco1($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	endif
	
	;Abertura do bloco 9.
	$instancehandle->gerarEFDBloco9($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	endif
	
	;Gerar arquivo texto.
	$instancehandle->gerarEFDArquivoTexto($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		rollback
		return(-1)
	endif
	
	clear
	rollback

	return(0)
End ;operation gerarEFD.

;---------------------------------------------------;
partner operation gerarEFDBloco0                    ;
;---------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams

	variables
		date vDataini, vDataFim
	endvariables

	clear/e "SIS_ARQUIVOSVC"
	clear/e "TMP_NRDSSVC"
	clear/e "F_TMP_NR09SVC"
	$nrLinhaBloco$ = ""

	;Abertura do arquivo digital e identificacao do contribuinte.
	$instancehandle->gerarEFDBloco0Reg0000($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Abertura do bloco 0.
	$instancehandle->gerarEFDBloco0Reg0001($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Dados complementares da entidade.
	$instancehandle->gerarEFDBloco0Reg0005($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Dados do contabilista.
	$instancehandle->gerarEFDBloco0Reg0100($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

;--> VSOUZA PRJ/TAR 189/008 06/09/2011 - Gerar o bloco 0150 SEMPRE	
;	;Tabela de cadastro do participante.
;	;------ WMC - PRJ 175 TAR 064 - 15/02/2011
;	clear/e "FIS_NFSVC"
;	CD_EMPFAT.fis_nfsvc/init       = $item("CD_EMPRESA", $parametro$)

;	if ($inConsideraDtemisNfsai$ = <TRUE>)
;		DT_EMISSAO.FIS_NFSVC/init      = $item("DT_PERIODO", $parametro$)
;	else
;		DT_SAIDAENTRADA.FIS_NFSVC/init = $item("DT_PERIODO", $parametro$)
;	endif
;	tp_situacao.fis_nfsvc/init      = "E"
;	tp_moddctofiscal.fis_nfsvc/init = "01·;55·;85·;86·;87" ;Incluído mod. 86 e 87 -- MAD [Proj/Tar.170/245] - 04/05/2011
;	retrieve/e "FIS_NFSVC"

;	if ($status >= 0)
	$instancehandle->gerarEFDBloco0Reg0150($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
;	endif
;	;------//------//------
;---------------------------------> VSOUZA - Gerar o bloco 0150 SEMPRE	
	
	;Identificacao das unidades de medida.
	$instancehandle->gerarEFDBloco0Reg0190($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	
	;Tabela de identificacao do item.
	$instancehandle->gerarEFDBloco0Reg0200($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	;-- MAD [Proj/Tar.170/074] - 15/10/2010
	if ($item("IN_ESCRITURA_CIAP",$xlplemp$) = 1)
		;Cadastro de Bens Imobilizados.
		$instancehandle->gerarEFDBloco0Reg0300($xCdErro$,$xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	;;
	
	;Tabela de natureza da operacao/Prestacao.
	$instancehandle->gerarEFDBloco0Reg0400($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	;-- MAD [Proj/Tar.170/238] - 27/04/2011
	;Tabela de informação complementar do documento fiscal
	$instancehandle->gerarEFDBloco0Reg0450($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	;Tabela de observações do lançamento fiscal
	$instancehandle->gerarEFDBloco0Reg0460($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	;;

	;-- MAD [Proj/Tar.170/075] - 18/10/2010
	if ($item("IN_ESCRITURA_CIAP",$xlplemp$) = 1)
		;Cadastro do Plano de Contas
		$instancehandle->gerarEFDBloco0Reg0500($xCdErro$,$xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		;-- MAD [Proj/Tar.170/076] - 19/10/2010
		;Cadastro do Centro de Custo
		$instancehandle->gerarEFDBloco0Reg0600($xCdErro$,$xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		;;
	endif
	;;

	;;ICJ [PROJ/TAR 61/784] 24/03/2010
;	vDataini = $item("DT_PERIODOINI", $parametro$)
;	vDataFim = $item("DT_PERIODOFIM", $parametro$)
;	if (vDataini >= "01/07/2010") | (vDataFim >= "01/07/2010")
;		call gerarEFDBloco0Reg0500($xCdErro$,$xCtxErro$)
;	endif
	;;

	;Encerramento do bloco 0.
	$instancehandle->gerarEFDBloco0Reg0990($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBloco0.


;-----------------------------------------------;
partner operation gerarEFDBloco0Reg0000         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	variables
		string  vDsConteudo, vStringConv, vStringAux, vStrAux, viParams, voParams
		numeric vCdEstado
		string  vNumericAux
		date    vDtAux
		string  vPesCliente, vPesFisica, vPesJuridica, vGlbMunIBGE, vPessoa, vPesEndereco, vVPesEndereco
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0000", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|0000"
	;Codigo da versao do layout.
   ; @>-/-- Virginia - 15/08/2011 - versao para 2010
	;vStringAux = "|003" Sandra PRJ 175 - TAR 057 - 03/02/11
	vDtAux = $item("DT_PERIODOINI", $parametro$)
	if (vDtAux[Y] = "2010")
		vStringAux = "|003"
	elseif (vDtAux[Y] = "2011")
		vStringAux = "|004"
	else
		;; ICJ [PROJ/TAR 189/173] (19/07/2012)
		;vStringAux = "|005"
		if (vDtAux >= "01/07/2012")
			vStringAux = "|006"
		elseif (vDtAux >= "01/01/2012") & (vDtAux <= "30/06/2012")
			vStringAux = "|005"
		endif
		;;
	endif
 	; --\-<@
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Codigo da finalidade do arquivo.
	call convNumeric($item("TP_FINALIDADE", $parametro$), 1, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Data inicial das informacoes contidas no arquivo.
	vDtAux = $item("DT_PERIODOINI", $parametro$)
	vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;Data final das informacoes contidas no arquivo.
	vDtAux = $item("DT_PERIODOFIM", $parametro$)
	vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	
	; @>-/-- Virginia - PRJ 061 - TAR 772 - 17/02/10
	vPessoa = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaPessoa($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPessoa = voParams
	endif
	
	vPesEndereco = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPesEndereco = voParams
	endif
	
	vVPesEndereco = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vVPesEndereco = voParams
	endif
	
	; --\-<@
	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
	vPesFisica = ""
	vPesJuridica = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaPesFisica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPesFisica = voParams
	endif
	
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaPesJuridica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPesJuridica = voParams
	endif
	
	vPesCliente = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_CLIENTE", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPesCliente = voParams
	endif
	; --\-<@
	
	;Nome empresarial da entidade.
	; @>-/-- Virginia - PRJ 061 - TAR 772 - 17/02/10
	;vStringAux = "|%%NM_PESSOA.PES_PESSOASVC"
	vStringAux = "|%%$item("NM_PESSOA",vPessoa)"
	; --\-<@
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;if (TP_PESSOA.PES_PESSOASVC = "J")
	if ($item("TP_PESSOA",vPessoa) = "J")
		;Cnpj da entidade.
		; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
		;vNumericAux = NR_CNPJ.PES_PESJURIDISVC
		vNumericAux = $item("NR_CNPJ",vPesJuridica)
		; --\-<@
		call convNumeric(vNumericAux, 14, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Cpf da entidade.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
	else
		;Cnpj da entidade.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Cpf da entidade.
		; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
		;vNumericAux = NR_CPF.PES_PESFISICASVC
		vNumericAux = $item("NR_CPF", vPesFisica)
		; --\-<@
		call convNumeric(vNumericAux, 11, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	endif
	
	;Sigla unidade da federacao da entidade.
	;    call convString("ds_siglaestado.v_pes_endereco", DS_SIGLAESTADO.V_PES_ENDERECSVC, 2, vStringConv)
	call convString("ds_siglaestado.v_pes_endereco", $item("DS_SIGLAESTADO",vVPesEndereco), 2, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Inscricao estadual da entidade.
	;if (TP_PESSOA.PES_PESSOASVC = "J")
	if ($item("TP_PESSOA",vPessoa) = "J")
		;-- MAD [Proj/Tar.061/591] - 27/04/2009
		;vStringAux = "|%%nr_inscestl.pes_pesjuridica"
		;call convString("nr_inscestl.pes_pesjuridica", NR_INSCESTL.PES_PESJURIDISVC, 20, vStringConv)
		; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
		;vStringAux = "|%%NR_INSCESTL.PES_PESJURIDISVC"
		vStrAux = $item("NR_INSCESTL",vPesJuridica)
		vStringAux = "|%%vStrAux"
		; --\-<@
		;;
		vDsConteudo = "%%vDsConteudo%%vStringAux"
	else
		; @>-/-- Virginia - PRJ 061 TAR 473 - 03/02/10
		;vStringAux = "|%%NR_RG.PES_PESFISICASVC"
		vStrAux = $item("NR_RG",vPesFisica)
		vStringAux = "|%%vStrAux"
		; --\-<@
		vDsConteudo = "%%vDsConteudo%%vStringAux"
	endif
	;Codigo do municipio de domicilio fiscal da entidade.
	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
	vGlbMunIBGE = ""
	viParams = ""
	voParams = ""
	;putitem/id viParams, "CD_ESTADO", CD_ESTADO.GLB_ESTADOSVC
	putitem/id viParams, "CD_ESTADO", $item("CD_ESTADO",vPesEndereco)
	;putitem/id viParams, "CD_MUNICIPIO", CD_MUNICIPIO.PES_ENDERECOSVC
	putitem/id viParams, "CD_MUNICIPIO", $item("CD_MUNICIPIO",vPesEndereco)
	activate "FISSVCO032".carregaMunIBGE($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vGlbMunIBGE = voParams
	endif
	; --\-<@    
	vCdEstado = ""
	vCdEstado = $item("DS_ESTADO",vPesEndereco)
	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
	;call convNumeric(CD_MUNICIPIOIBGE.GLB_MUNIBGESVC, 5, vStringConv)
	call convNumeric($item("CD_MUNICIPIOIBGE",vGlbMunIBGE), 5, vStringConv)    
	; --\-<@
	vStringConv = "%%vCdEstado%%vStringConv"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Inscricao municipal da entidade.
	vStringAux = "|"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Inscricao da entidade na SUFRAMA.
	; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10    
	;vStringConv = NR_SUFRAMA.PES_CLIENTESVC
	vStringConv = $item("NR_SUFRAMA",vPesCliente)
	; --\-<@
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Perfil de apresentação do arquivo fiscal.
	vStringAux = $item("TP_PERFIL", $parametro$)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;Indicador de atividade.
	if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4) ;ICJ 02/06/2010
		vStringAux = "|0"
	else
		vStringAux = "|1"
	endif
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "0000"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("0000")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)

End ;operation gerarEFDBloco0Reg0000.

;--------------------------------------------------;
entry totalizarQtdTipoRegistro         ;
;--------------------------------------------------;
	params
		string piTpRegistro :IN
	endparams
	creocc "TMP_DS40SVC", -1
	DS_40.TMP_DS40SVC = piTpRegistro
	retrieve/o "TMP_DS40SVC"
	if ($status = 4)
		retrieve/x "TMP_DS40SVC"
	endif
	QT_REGISTRO.TMP_DS40SVC = QT_REGISTRO.TMP_DS40SVC + 1
	
	return(0)

End ;operation totalizarQtdTipoRegistro.

;-----------------------------------------------;
partner operation gerarEFDBloco0Reg0001         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0001", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|0001"
	;Indicador de movimento.
	vStringAux = "|0"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0001"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("0001")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	return(0)

End ;operation gerarEFDBloco0Reg0001.

;-----------------------------------------------;
partner operation gerarEFDBloco0Reg0005         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vStrAux, viParams, voParams, vPesTelefone, vPesEmail, vPessoa, vVPesEndereco
		string  vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0005", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|0005"
	;Nome fantasia associado ao nome empresarial.
	; @>-/-- Virginia - PRJ 061 - TAR 772 - 17/02/10
	vPessoa = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaPessoa($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPessoa = voParams
	endif
	
	vVPesEndereco = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vVPesEndereco = voParams
	endif
	; --\-<@
	;vStringAux = "|%%NM_PESSOA.PES_PESSOASVC"
	vStringAux = "|%%$item("NM_PESSOA",vPessoa)"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Codigo de enderecamento postal.
	;call convNumeric(CD_CEP.V_PES_ENDERECSVC, 8, vStringConv)
	call convNumeric($item("CD_CEP", vVPesEndereco), 8, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Logradouro e endereco do imovel.
	;vStringAux = "|%%DS_SIGLALOGRAD.V_PES_ENDERECSVC %%NM_LOGRADOURO.V_PES_ENDERECSVC"
	vStringAux = "|%%$item("DS_SIGLALOGRAD",vVPesEndereco) %%$item("NM_LOGRADOURO",vVPesEndereco)"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Numero do imovel.
	;vStringAux = "|%%NR_LOGRADOURO.V_PES_ENDERECSVC"
	vStringAux = "|%%$item("NR_LOGRADOURO",vVPesEndereco)"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Dados complementares do endereco.
	vStringAux = "|"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Bairro em que o imovel esta situado.
	;vStringAux = "|%%DS_BAIRRO.V_PES_ENDERECSVC"
	vStringAux = "|%%$item("DS_BAIRRO",vVPesEndereco)"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Numero do telefone.
	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
	vPesTelefone = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaPesTelefone($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPesTelefone = voParams
	endif
	;call convNumeric(NR_TELEFONE.PES_TELEFONESVC, 10, vStringConv)
	call convNumeric($item("NR_TELEFONE",vPesTelefone), 10, vStringConv)
	; --\-<@
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Numero do fax.
	vStringAux = "|"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Endereco do correio eletronico.
	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
	vPesEmail = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaPesEmail($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPesEmail = voParams
	endif
	vStrAux = $item("DS_EMAIL",vPesEmail)
	;vStringAux = "|%%DS_EMAIL.PES_EMAILSVC"
	vStringAux = "|%%vStrAux"
	; --/-<@
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0005"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("0005")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBloco0Reg0005.


;-----------------------------------------------;
partner operation gerarEFDBloco0Reg0100         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vStrAux
		numeric vCdEstado
		string  vPesTelefone, vPesEmail, vPesFisica, vFisCont, vGlbMunIBGE, vPessoa, vPesEndereco, vVPesEndereco, vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0100", "", "")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	
	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
	vFisCont = ""
	viParams = ""
	voParams = ""

	putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA",$parametro$)

	; -> RODRIGO - PRJ 175 TAR 196 - 22/07/2011
	putitem/id viParams, "DT_PERIODO", $item("DT_PERIODOINI", $parametro$)
	; <- RODRIGO - PRJ 175 TAR 196 - 22/07/2011

	putitem/id viParams, "CONT_SOCIO", "C"  ;-- MAD [Proj/Tar.175/004] - 19/11/2010
	activate "FISSVCO032".carregaContSocio($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams = "")
		return (0)    
	endif
	
	vFisCont = voParams

	; @>-/-- Virginia - PRJ 061 - TAR 772 - 17/02/10
	vPessoa = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", vFisCont)
	activate "FISSVCO032".carregaPessoa($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPessoa = voParams    
	endif
	
	;if ($status >= 0)
	if (vPessoa != "")
		
		vPesEndereco = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", vFisCont)
		activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vPesEndereco = voParams    
		endif
		; --\-<@
		; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
		vPesFisica = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", vFisCont)
		activate "FISSVCO032".carregaPesFisica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vPesFisica = voParams
		endif
		
		vPesTelefone = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", vFisCont)
		activate "FISSVCO032".carregaPesTelefone($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vPesTelefone = voParams
		endif
		
		vPesEmail = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", vFisCont)
		activate "FISSVCO032".carregaPesEmail($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vPesEmail = voParams
		endif
		; --\-<@
		
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|0100"
		;Nome do contabilista.
		;vStringAux = "|%%NM_PESSOA.PES_PESSOASVC"
		vStringAux = "|%%$item("NM_PESSOA",vPessoa)"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;if (TP_PESSOA.PES_PESSOASVC = "J")
		if ($item("TP_PESSOA",vPessoa) = "J")
			;Cpf do contabilista.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
		else
			;Cpf do contabilista.
			; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
			;vNumericAux = NR_CPF.PES_PESFISICASVC
			vNumericAux = $item("NR_CPF", vPesFisica)
			; --\-<@
			call convNumeric(vNumericAux, 11, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		endif
		;Numero de inscricao do contabilista no conselho regional de contabilidade.
		; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
		;vStringConv = DS_CRC.FIS_CONTSOCIOSVC
		vStringConv = $item("DS_CRC", vFisCont)
		; --\-<@
		;call convString("ds_crc.fis_contsocio", DS_CRC.FIS_CONTSOCIOSVC, 11, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Número de inscrição do escritório de contabilidade.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		
		vVPesEndereco = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", vFisCont)
		activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vVPesEndereco = voParams
		endif
		; --\-<@
		;Codigo de enderecamento postal.
		;vNumericAux = CD_CEP.V_PES_ENDERECSVC
		vNumericAux = $item("CD_CEP",vVPesEndereco)
		call convNumeric(vNumericAux, 8, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Logradouro e endereco do imovel.
		;vStringAux = "|%%DS_SIGLALOGRAD.V_PES_ENDERECSVC %%NM_LOGRADOURO.V_PES_ENDERECSVC"
		vStringAux = "|%%$item("DS_SIGLALOGRAD",vVPesEndereco) %%$item("NM_LOGRADOURO",vVPesEndereco)"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Numero do imovel.
		;vStringAux = "|%%NR_LOGRADOURO.V_PES_ENDERECSVC"
		vStringAux = "|%%$item("NR_LOGRADOURO",vVPesEndereco)"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Dados complementares do endereco.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Bairro em que o imovel esta situado.
		;vStringAux = "|%%DS_BAIRRO.V_PES_ENDERECSVC"
		vStringAux = "|%%$item("DS_BAIRRO",vVPesEndereco)"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Numero do telefone.
		; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
		call convNumeric($item("NR_TELEFONE",vPesTelefone), 10, vStringConv)
		;vStringAux = "|%%NR_TELEFONE.PES_TELEFONESVC"
		vStringAux = "|%%vStringConv"
		; --\-<@
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Numero do fax.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Endereco do correio eletronico.
		; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
		vStrAux = $item("DS_EMAIL",vPesEmail)
		;vStringAux = "|%%DS_EMAIL.PES_EMAILSVC"
		vStringAux = "|%%vStrAux"
		; --\-<@
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		
		;Codigo do municipio.
		; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
		vGlbMunIBGE = ""
		viParams = ""
		voParams = ""
		;putitem/id viParams, "CD_ESTADO", CD_ESTADO.GLB_ESTADOSVC
		putitem/id viParams, "CD_ESTADO", $item("CD_ESTADO",vPesEndereco)
		;putitem/id viParams, "CD_MUNICIPIO", CD_MUNICIPIO.PES_ENDERECOSVC
		putitem/id viParams, "CD_MUNICIPIO", $item("CD_MUNICIPIO",vPesEndereco)
		activate "FISSVCO032".carregaMunIBGE($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vGlbMunIBGE = voParams
		endif
		
		vCdEstado = ""
		vCdEstado = $item("DS_ESTADO", vPesEndereco)
		; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
		;call convNumeric(CD_MUNICIPIOIBGE.GLB_MUNIBGESVC, 5, vStringConv)
		call convNumeric($item("CD_MUNICIPIOIBGE",vGlbMunIBGE), 5, vStringConv)    
		; --\-<@
		vStringConv = "%%vCdEstado%%vStringConv"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
		
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		DS_REG.SIS_ARQUIVOSVC = "0100"
		DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("0100")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	
	return(0)
End ;operation gerarEFDBloco0Reg0100.

;-----------------------------------------------;
partner operation gerarEFDBloco0Reg0150         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux
		numeric vCdEstado
		string vNumericAux
	endvariables

	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|0150"
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0150"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("0150")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	return(0)
End ;operation gerarEFDBloco0Reg0150.


;------------------------------------------------;
partner operation gerarEFDBloco0Reg0190          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0190", "", "")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|0190"
	;Codigo da unidade de medida.
	vStringAux = "|"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Descricao da unidade de medida.
	vStringAux = "|"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0190"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("0190")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBloco0Reg0190.


;-----------------------------------------------;
partner operation gerarEFDBloco0Reg0200         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo
	endvariables
	
	clear/e "F_TMP_DS40SVC"
	clear/e "TMP_NR08SVC"
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|0200"
	
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0200"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("0200")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	return(0)
End ;operation gerarEFDBloco0Reg0200.


;----------------------------------------------------;
partner operation gerarEFDBloco0Reg0400              ;
;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo
	endvariables
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|0400"
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0400"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("0400")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBloco0Reg0400.


;-----------------------------------------------;
partner operation gerarEFDBloco0Reg0990         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
	endvariables
	
	$nrLinhaBloco0990$ = 0
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0990", "", "")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|0990"
	;Quantidade total de linhas do bloco 0.
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	vStringAux = "|%%$nrLinhaBloco$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	$nrLinhaBloco0990$ = $nrLinhaBloco$
	vStringaux = $nrlinhabloco0990$
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0990"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("0990")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBloco0Reg0990.


;---------------------------------------------------;
partner operation gerarEFDBlocoC                    ;
;---------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	$nrLinhaBloco$ = ""
	;Abertura do bloco C.
	$instancehandle->gerarEFDBlocoCRegC001($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	if ($item("IN_BLOCOC", $parametro$) = <TRUE>)
		;Documento - nota fiscal(codigo 01 e 07).
		$instancehandle->gerarEFDBlocoCRegC100($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		;Resumo diario das notas fiscais de venda a consumidor.(codigo 02).
		$instancehandle->gerarEFDBlocoCRegC300($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		;Nota fiscal de venda a consumidor.(codigo 02).
		$instancehandle->gerarEFDBlocoCRegC350($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		;Equipamento ECF - (codigo 02 e 2D).
		$instancehandle->gerarEFDBlocoCRegC400($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		;Resumo Mensal de itens do ECF por estabelecimento - (codigo 02 e 2D).
		$instancehandle->gerarEFDBlocoCRegC495($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		;Nota fiscal/conta de energia eletrica - (codigo 06).
		$instancehandle->gerarEFDBlocoCRegC500($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	
	;Encerramento do bloco C.
	$instancehandle->gerarEFDBlocoCRegC990($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoC.


;-----------------------------------------------;
partner operation gerarEFDBlocoCRegC001         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		boolean vInMovimento
	endvariables
	
	;Verificando se ha movimento.
	vInMovimento = <FALSE>

	clear/e "FIS_NFSVC"
	CD_EMPFAT.FIS_NFSVC/init       = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init      = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	TP_SITUACAO.FIS_NFSVC/init      = "E·;C"
	TP_OPERACAO.FIS_NFSVC/init      = "S" ; --\-<@ Virginia - 12/08/2011 - 175/219
	;TP_MODDCTOFISCAL.FIS_NFSVC/init = "01·;02·;06·;07"
	tp_moddctofiscal.fis_nfsvc/init = "01·;55·;85·;86·;87" ;Incluído mod. 86 e 87 -- MAD [Proj/Tar.170/245] - 04/05/2011
	retrieve/e "FIS_NFSVC"
	if ($status >= 0)
		vInMovimento = <TRUE>
	endif

   ; @>-/-- Virginia - 12/08/2011 - 175/219
	clear/e "FIS_NFSVC"
	CD_EMPFAT.FIS_NFSVC/init       = $item("CD_EMPRESA", $parametro$)
	DT_SAIDAENTRADA.FIS_NFSVC/init = $item("DT_PERIODO", $parametro$)
	TP_SITUACAO.FIS_NFSVC/init      = "E·;C"
	TP_OPERACAO.FIS_NFSVC/init      = "E"
	;TP_MODDCTOFISCAL.FIS_NFSVC/init = "01·;02·;06·;07"
	tp_moddctofiscal.fis_nfsvc/init = "01·;55·;85·;86·;87" ;Incluído mod. 86 e 87 -- MAD [Proj/Tar.170/245] - 04/05/2011
	retrieve/e "FIS_NFSVC"
	if ($status >= 0)
		vInMovimento = <TRUE>
	endif

	clear/e "FIS_REDZMSVC"
	cd_empresa.fis_redzmsvc/init = $item("CD_EMPRESA", $parametro$)
	dt_emissao.fis_redzmsvc/init = $item("DT_PERIODO", $parametro$)
	retrieve/e "FIS_REDZMSVC"
	if ($status >= 0)
		vInMovimento = <TRUE>
	endif
	; --\-<@

	;--> VSOUZA PRJ/TAR 189/020 27/09/2011
	clear/e "FIS_NFSVC"
	CD_EMPFAT.FIS_NFSVC/init        = $item("CD_EMPRESA", $parametro$)
	DT_SAIDAENTRADA.FIS_NFSVC/init  = $item("DT_PERIODO", $parametro$)
	TP_SITUACAO.FIS_NFSVC/init      = "E"
	TP_OPERACAO.FIS_NFSVC/init      = "E"
	TP_MODDCTOFISCAL.FIS_NFSVC/init = 06
	retrieve/e "FIS_NFSVC"
	if ($status >= 0)
		vInMovimento = <TRUE>
	endif 
	;-------------------------------------<
	clear/e "FIS_NFSVC"
	clear/e "FIS_REDZMSVC"
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C001", "", "")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif

	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|C001"
	;Indicador de movimento.
	if (vInMovimento = <TRUE>)
		vStringAux = "|0"
	else
		vStringAux = "|1"
	endif
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "C001"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("C001")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoCRegC001.


;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC100              ;
;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vGlbLogradouro, vPesCliente
		numeric vCdEstado, vNumerico
		date    vDtAux, vDtPeriodo
		boolean vGeraC120, vPrazo, vInProcessaItem, vInGerar
		string  vNumericAux, vTpModDocFis
	endvariables

	vInProcessaItem = <FALSE>
	
	vDtPeriodo = $item("DT_PERIODOINI", $parametro$) ;RAR [Proj/Tar.170/498] 

	;;ICJ [PROJ/TAR 175/70] (01/03/2011)
	if ($inConsideraDtEmisNfSai$ = <TRUE>)
		clear/e "FIS_NFSVC"
		
		;busca as NFs de saída pela data de emissão	
		clear/e "FIS_S_NFSVC"
		CD_EMPFAT.FIS_S_NFSVC/init   = $item("CD_EMPRESA", $parametro$)
		DT_EMISSAO.FIS_S_NFSVC/init  = $item("DT_PERIODO", $parametro$)
		TP_SITUACAO.FIS_S_NFSVC/init = "E·|C·|D"; incluido o tipo D para considerar as Nfe Denegadas - Sandra Proj/Tarefa 175/63, 11/02/2011.
		tp_moddctofiscal.fis_s_nfsvc/init = "01·;55·;70·;85·;86·;87" ;Incluído mod. 86 e 87 -- MAD [Proj/Tar.170/245] - 04/05/2011 ;;ICJ [PROJ/TAR 175/332] (22/03/2012) Incluído 70
		TP_OPERACAO.FIS_S_NFSVC/init = "S"
		retrieve/e "FIS_S_NFSVC"
		if ($status >= 0)
			vInProcessaItem = <TRUE> ;--> VSOUZA PRJ/TAR 189/020 28/09/2011
			setocc "FIS_S_NFSVC",1
			while ($status >= 0)
				creocc "FIS_NFSVC", -1
				CD_EMPRESA.FIS_NFSVC = CD_EMPRESA.FIS_S_NFSVC
				NR_FATURA.FIS_NFSVC  = NR_FATURA.FIS_S_NFSVC
				DT_FATURA.FIS_NFSVC  = DT_FATURA.FIS_S_NFSVC
				retrieve/o "FIS_NFSVC"
				if ($status = -7)
					retrieve/x "FIS_NFSVC"
				endif
				setocc "FIS_S_NFSVC", $curocc("FIS_S_NFSVC") + 1
			endwhile
		endif
		clear/e "FIS_S_NFSVC"
		CD_EMPFAT.FIS_S_NFSVC/init   = $item("CD_EMPRESA", $parametro$)
		DT_SAIDAENTRADA.FIS_S_NFSVC/init  = $item("DT_PERIODO", $parametro$)
		TP_SITUACAO.FIS_S_NFSVC/init = "E·|C·|D"; incluido o tipo D para considerar as Nfe Denegadas - Sandra Proj/Tarefa 175/63, 11/02/2011.
		tp_moddctofiscal.fis_s_nfsvc/init = "01·;55·;70·;85·;86·;87" ;Incluído mod. 86 e 87 -- MAD [Proj/Tar.170/245] - 04/05/2011 ;;ICJ [PROJ/TAR 175/332] (22/03/2012) Incluído 70
		TP_OPERACAO.FIS_S_NFSVC/init	= "E"
		retrieve/e "FIS_S_NFSVC"
		if ($status >= 0)
			vInProcessaItem = <TRUE>
			setocc "FIS_S_NFSVC",1
			while ($status >= 0)
				creocc "FIS_NFSVC", -1
				CD_EMPRESA.FIS_NFSVC = CD_EMPRESA.FIS_S_NFSVC
				NR_FATURA.FIS_NFSVC  = NR_FATURA.FIS_S_NFSVC
				DT_FATURA.FIS_NFSVC  = DT_FATURA.FIS_S_NFSVC
				retrieve/o "FIS_NFSVC"
				if ($status = -7)
					retrieve/x "FIS_NFSVC"
				endif
				setocc "FIS_S_NFSVC", $curocc("FIS_S_NFSVC") + 1
			endwhile
		endif
		clear/e "FIS_S_NFSVC"
	else
		clear/e "FIS_NFSVC"
		CD_EMPFAT.fis_nfsvc/init       = $item("CD_EMPRESA", $parametro$)
		;------ WMC - PRJ 175 TAR 052 - 08/02/2011
		DT_SAIDAENTRADA.FIS_NFSVC/init = $item("DT_PERIODO", $parametro$)
		;------//------//------
		;;ICJ [PROJ/TAR 170/150] (09/12/2010)
		;tp_situacao.fis_nfsvc/init     = "E·;C"
		TP_SITUACAO.FIS_NFSVC/init      = "E·;C·;D" ;-- buscar notas fiscais eletrônicas denegadas
		;;
		TP_MODDCTOFISCAL.FIS_NFSVC/init = "01·;55·;70·;85·;86·;87" ;Incluído mod. 86 e 87 -- MAD [Proj/Tar.170/245] - 04/05/2011 ;;ICJ [PROJ/TAR 175/332] (22/03/2012) Incluído 70
		retrieve/e "FIS_NFSVC"
		if ($status < 0)
			return(0)
		else
			vInProcessaItem = <TRUE>
		endif
	endif
	;;
	if (vInProcessaItem)
		setocc "FIS_NFSVC", 1
		while ($status >= 0)
		
			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C100 / %%dt_fatura.fis_nfsvc", "", "")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif
			;ICJ [PROJ/TAR 170/118] (07/11/2010)		
			if ($item("IN_GERAR_STDEV_OBS",$xlplemp$) = 1) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (VL_ICMSSUBST.FIS_NFSVC > 0)
	   		VL_BASEICMSSUBS.FIS_NFSVC/init	= 0
				VL_ICMSSUBST.FIS_NFSVC/init  	= 0

; -> comentado por RODRIGO - PRJ 170 TAR 217 - 30/03/2011
;			VL_BASEICMS.FIS_NFSVC 	= 0
;			VL_ICMS.FIS_NFSVC			= 0
; <- comentado por RODRIGO - PRJ 170 TAR 217 - 30/03/2011

				IN_ZEROU.FIS_NFSVC/init = <TRUE>
			endif
			;;

			;-- MAD [Proj/Tar.170/117] - 22/11/2010
			if (TP_OPERACAO.FIS_NFSVC = "S") & ($item("IN_INFORMA_BCICMS_OUT",$xlplemp$) = 1) & ($item("UF_ORIGEM",$xlplemp$) = "CE") & %\
			   (($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4))

				VL_BASEICMS.FIS_NFSVC/init = 0
				VL_ICMS.FIS_NFSVC/init     = 0
			endif

			;->RIM [170/555] - 21/09/2012
			if(($inCalcImpdevSn$) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (TP_ORIGEMEMISSAO.FIS_NFSVC = 1) & ($inOptSimples$ = "S"))
				VL_BASEICMS.FIS_NFSVC     = 0 
   			VL_ICMS.FIS_NFSVC         = 0
				IN_ZEROU.FIS_NFSVC/init = <TRUE>
			endif
			;<-

			;;
			clear/e "FIS_NFITEMSVC"
			CD_EMPFAT.FIS_NFITEMSVC/init = CD_EMPFAT.FIS_NFSVC
			DT_FATURA.FIS_NFITEMSVC/init = DT_FATURA.FIS_NFSVC
			NR_FATURA.FIS_NFITEMSVC/init = NR_FATURA.FIS_NFSVC
			retrieve/e "FIS_NFITEMSVC"					
			;;ICJ [PROJ/TAR 170/419] (20/04/2012)	
			vInGerar = <TRUE>
			;if (CD_CFOP.FIS_NFITEMSVC != 5605) & (CD_CFOP.FIS_NFITEMSVC != 1605)
			if (CD_CFOP.FIS_NFITEMSVC = 1605)
				vInGerar = <FALSE>
			endif
			if ($tpApurIcms$ = 2)
				if  (CD_CFOP.FIS_NFITEMSVC = 1601) |  %\
			 		(CD_CFOP.FIS_NFITEMSVC = 1602) |  %\	
					(CD_CFOP.FIS_NFITEMSVC = 5601) |  %\
					(CD_CFOP.FIS_NFITEMSVC = 5602) |  %\
					(CD_CFOP.FIS_NFITEMSVC = 5605)
					vInGerar = <FALSE>
				endif
			endif
			if (vInGerar = <TRUE>)
			;;						
			;if ($item("UF_ORIGEM",$xlplemp$) = "") | ($item("UF_ORIGEM",$xlplemp$) = ds_siglaestado.fis_nfremdessvc)
				if (tp_situacao.fis_nfsvc = "E") 
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|C100"
					;Indicador do tipo de operacao.
					if (tp_operacao.fis_nfsvc = "E")
						;Entrada.
						vStringAux = "|0"
					else
						;Saida.
						vStringAux = "|1"
					endif
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Indicador do emitente do documento fiscal.
					if (tp_origememissao.fis_nfsvc = "1")
						;Emissao propria.
						vStringAux = "|0"
					else
						;Emissao terceiros.
						vStringAux = "|1"
					endif
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					
					clear/e "FIS_S_NFREMDESVC"
					CD_EMPFAT.fis_S_nfremdesvc/init = CD_EMPFAT.fis_nfsvc
					dt_fatura.fis_s_nfremdesvc/init  = dt_fatura.fis_nfsvc
					nr_fatura.fis_s_nfremdesvc/init  = nr_fatura.fis_nfsvc
					retrieve/e "FIS_S_NFREMDESVC"
					if ($status >= 0)
	
						;-- MAD [Proj/Tar.061/526] - 18/12/2008
						creocc "F_TMP_NR09SVC", -1
						nr_geral.f_tmp_nr09svc = cd_pessoa.fis_s_nfremdesvc
						retrieve/o "F_TMP_NR09SVC"
						if ($status = 4)
							retrieve/x "F_TMP_NR09SVC"
						endif
						;;
						nm_cliente.f_tmp_nr09svc = nm_nome.fis_s_nfremdesvc
						tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_s_nfremdesvc
						if (tp_pessoa.fis_s_nfremdesvc = "F")
							nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_s_nfremdesvc
						else
							nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_s_nfremdesvc
						endif
						nr_rginscr.f_tmp_nr09svc    = nr_rginscrest.fis_s_nfremdesvc
						; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
						vPesCliente = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_s_nfremdesvc
						activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vPesCliente = voParams
						endif
					
						NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)
						;nr_suframa.f_tmp_nr09svc    = nr_suframa.pes_clientesvc
						; --\-<@
						ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_s_nfremdesvc %%nm_logradouro.fis_s_nfremdesvc"
						nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_s_nfremdesvc
						nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_s_nfremdesvc
						if (cd_cep.fis_s_nfremdesvc != 99999999)
							; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
							vGlbLogradouro = ""
							viParams = ""
							voParams = ""
							putitem/id viParams, "CD_CEP", cd_cep.fis_s_nfremdesvc
							activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								return(-1)
							endif
							if (voParams != "")
								vGlbLogradouro = voParams
							endif
							
							vCdEstado = ""
							vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
						
							cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
							cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
							ds_estado.f_tmp_nr09svc    = vCdEstado
							ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
						endif
					endif
	
					;Codigo do participante.
					call convNumeric(cd_pessoa.fis_s_nfremdesvc, 9, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					
					;Codigo do modelo do documento fiscal.
					;-- MAD [Proj/Tar.170/245] - 04/05/2011
					;if (tp_moddctofiscal.fis_nfsvc = 85)
					if (tp_moddctofiscal.fis_nfsvc = 85) | (tp_moddctofiscal.fis_nfsvc = 86) | (tp_moddctofiscal.fis_nfsvc = 87)
						if (ds_chaveacesso.fis_nfesvc != "")
							vNumericAux = 55
						else
					;;
							vNumericAux = 1
						endif
					else
						vNumericAux = tp_moddctofiscal.fis_nfsvc
					endif
					;;ICJ [PROJ/TAR 175/332] (22/03/2012)
					if (tp_moddctofiscal.fis_nfsvc = 70)
						vStringConv = "1B"
						vTpModDocFis = vStringConv
					else
					;;
						vTpModDocFis = vNumericAux
						call convNumeric(vNumericAux, 2, vStringConv)
					endif
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Codigo da situacao do documento fiscal.
					if (tp_situacao.fis_nfsvc = "E")
						; @>-/-- Virginia - 111/1776 - Brascol
						if (tp_moddctofiscal.fis_nfsvc = 85) | (tp_moddctofiscal.fis_nfsvc = 86) | (tp_moddctofiscal.fis_nfsvc = 87)
							;Nota complementar
							vStringAux = "|06"
						else
							;Nota emitida.
							vStringAux = "|00"
						endif
						; --\-<@
					elseif (tp_situacao.fis_nfsvc = "C")
						;Nota cancelada.
						vStringAux = "|02"
					;;ICJ [PROJ/TAR 170/150] (09/12/2010)
					elseif (tp_situacao.fis_nfsvc = "D")
						;Nota denegada.
						vStringAux = "|04"
					endif
					;;
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Serie do documento fiscal.
					vStringAux = "|%%cd_serie.fis_nfsvc"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Numero do documento fiscal.
					call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Chave da nota fiscal eletronica.
					vStringAux = ""
                      ;Sandra e Camargo 20/02/2012, não estava trazendo a chave p/NF de complemento
					;if (TP_MODDCTOFISCAL.FIS_NFSVC = 55) & (TP_SITUACAO.FIS_NFSVC = "E")
					if (vTpModDocFis = "55") & (TP_SITUACAO.FIS_NFSVC = "E")
					;;
						viParams = ""
						voParams = ""
						;;ICJ [PROJ/TAR 170/2] (17/06/2010)	
						putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.FIS_NFSVC
						putitem/id viParams, "NR_FATURA",  NR_FATURA.FIS_NFSVC
						putitem/id viParams, "DT_FATURA",  DT_FATURA.FIS_NFSVC
						putitem/id viParams, "NM_CARREGATABELA", "FIS_NFE"
						activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						vStringAux = $item("DS_CHAVEACESSO",voParams)
					endif
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Data de emissao do documento fiscal.
					vDtAux = dt_emissao.fis_nfsvc
					vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	
					;Data da entrada ou da saida.
	; -> RODRIGO - PRJ 170 TAR 345 - 22/08/2011
	;				vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
	;				vDtAux = vStringAux
					if(TP_OPERACAO.FIS_NFSVC = "S")
						if($inConsideraDtEmisNfSai$ != <TRUE>)
							vDtAux = dt_saidaentrada.fis_nfsvc
						else
							if(DT_SAIDAENTRADA.FIS_NFSVC > $item("DT_PERIODOFIM", $parametro$))
								vDtAux = ""
							else
								vDtAux = dt_emissao.fis_nfsvc
							endif
						endif
					else
						vDtAux = dt_saidaentrada.fis_nfsvc
					endif
	
					if(vDtAux != "")
						vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
					else
						vStringAux = ""
					endif
	
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	; <- RODRIGO - PRJ 170 TAR 345 - 22/08/2011
	
					;Valor total do documento fiscal.
					vNumericAux = vl_totalnota.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Indicador do tipo de pagamento.
					
					;;ICJ [PROJ/TAR 170/87] (23/09/2010)
					clear/e "TRA_TRANSACADSVC"
					CD_EMPRESA.TRA_TRANSACADSVC/init	= CD_EMPRESAORI.FIS_NFSVC
					NR_TRANSACAO.TRA_TRANSACADSVC/init	= NR_TRANSACAOORI.FIS_NFSVC
					DT_TRANSACAO.TRA_TRANSACADSVC/init	= DT_TRANSACAOORI.FIS_NFSVC
					retrieve/e "TRA_TRANSACADSVC"
					if ($status >= 0)
						if (NR_PRAZOMEDIO.TRA_TRANSACADSVC > 0)
							;A prazo.
							vStringAux = "|1"
							vPrazo = <TRUE>
						else
							;-- MAD [Proj/Tar.175/259] - 04/11/2011
							if (NR_PRAZOMEDIO.TRA_TRANSACADSVC = "")
								;-RAR [Proj/Tar.170/498 - 05/07/2012]
								if(vDtPeriodo < $date("01-07-2012"))
									;Sem Pagamento
									vStringAux = "|9"
									vPrazo = <FALSE>
								else
									;Outros
									vStringAux = "|2"
									vPrazo = <FALSE>
								endif
							else
							;;
								;A vista.
								vStringAux = "|0"
								vPrazo = <FALSE>
							endif
						endif
					else
						;-- MAD [Proj/Tar.175/259] - 04/11/2011
						;vStringAux = "|0"
						;-RAR [Proj/Tar.170/498 - 05/07/2012]
								if(vDtPeriodo < $date("01-07-2012"))
									;Sem Pagamento
									vStringAux = "|9"
									vPrazo = <FALSE>
								else
									;Outros
									vStringAux = "|2"
									vPrazo = <FALSE>
								endif
						;;
						vPrazo = <FALSE>	
					endif
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					
					;if (cd_condpgto.fis_nfsvc > 1)
					;	;A prazo.
					;	vStringAux = "|1"
					;else
					;	;A vista.
					;	vStringAux = "|0"
					;endif
					;;
					;Valor total do desconto.
					vNumericAux = vl_desconto.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Abatimento nao tributavel
					vStringAux = "|"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Valor das mercadorias.
					vNumericAux = vl_totalnota.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Indicador do tipo do frete.
					;-- MAD [Proj/Tar.170/044] - 24/08/2010
					;if (tp_frete.fis_nftranspsvc = "1")
					;	;Por conta do emitente.
					;	vStringAux = "|0"
					;else
					;	;Por conta do destinatario.
					;	vStringAux = "|1"
					;endif
					;--> VSOUZA PRJ/TAR 189/006 06/09/2011
					if (DT_SAIDAENTRADA.FIS_NFSVC < "01/01/2012")
						if (TP_FRETE.FIS_NFTRANSPSVC = "3") 
							vStringAux = "|0"
						elseif(TP_FRETE.FIS_NFTRANSPSVC = "4") | (TP_FRETE.FIS_NFTRANSPSVC = "") ;Arley / Sandra - 06/10/2011
							vStringAux = "|9"
						else
							vStringAux = "|%%TP_FRETE.FIS_NFTRANSPSVC"
						endif    
					else
						; Por conta do Emitente
						if (TP_FRETE.FIS_NFTRANSPSVC = "1")
							vStringAux = "|0"
						; Por conta do destinatario
						elseif (TP_FRETE.FIS_NFTRANSPSVC = "2")
							vStringAux = "|1"
						; Por conta de terceiros
						elseif (TP_FRETE.FIS_NFTRANSPSVC = "3")
							vStringAux = "|2"
						; Sem frete
						else
							vStringAux = "|9"
						endif
					endif				
					;---------------------------------------->
					;;
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Valor do frete.
					vNumericAux = vl_frete.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do seguro.
					vNumericAux = vl_seguro.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor de outras despesas acessorias.
					vNumericAux = vl_despacessor.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor da base de calculo do ICMS.
					vNumericAux = vl_baseicms.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do ICMS.
					vNumericAux = vl_icms.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor da base de calculo do ICMS substituicao tributaria.
					vNumericAux = vl_baseicmssubs.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do ICMS retido por substituicao tributaria.
					vNumericAux = vl_icmssubst.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do IPI.
					vNumericAux = vl_ipi.fis_nfsvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do PIS.
					clear/e "FIS_NFIMPOSTOSVC"
					CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
					dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
					nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
					cd_imposto.fis_nfimpostosvc/init = 6
					retrieve/e "FIS_NFIMPOSTOSVC"
					if ($status < 0)
						clear/e "FIS_NFIMPOSTOSVC"
					endif
					
					vNumericAux = vl_imposto.fis_nfimpostosvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do COFINS.
					clear/e "FIS_NFIMPOSTOSVC"
					CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
					dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
					nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
					cd_imposto.fis_nfimpostosvc/init = 5
					retrieve/e "FIS_NFIMPOSTOSVC"
					if ($status < 0)
						clear/e "FIS_NFIMPOSTOSVC"
					endif
					
					vNumericAux = vl_imposto.fis_nfimpostosvc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor total do PIS retido por substituicao tributaria.
					vStringAux = "|"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Valor total do COFINS retido por substituicao tributaria.
					vStringAux = "|"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"
					
					;filedump/append vDsConteudo, ds_path.sis_filtro
					creocc "SIS_ARQUIVOSVC", -1
					ds_reg.sis_arquivosvc = "C100"
					ds_registro.sis_arquivosvc = vDsConteudo
					
					$nrLinhaBloco$   = $nrLinhaBloco$   + 1
					$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
					$nrRegistroArq$  = $nrRegistroArq$  + 1
					
					$instancehandle->totalizarQtdTipoRegistro("C100")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
	
					;-- MAD [Proj/Tar.170/238] - 27/04/2011
					;Informação complementar da NF
					$instancehandle->gerarEFDBlocoCRegC110($xCdErro$, $xCtxErro$)
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
					;;
					
					if (tp_operacao.fis_nfsvc = "E")
						clear/e "FIS_NFITEMSVC"
						CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
						dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
						nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
						retrieve/e "FIS_NFITEMSVC"					
						;if (!$empty("FIS_NFITEMSVC"))
						if ($status >= 0)
							vGeraC120 = <FALSE>    
							setocc "FIS_NFITEMSVC", 1
							while ($status >= 0)
								if (CD_CFOP.FIS_NFITEMSVC[1:1] = 3 & ds_siglaestado.fis_nfremdessvc = "EX" & tp_moddctofiscal.fis_nfsvc = 01)
									vGeraC120 = <TRUE>
									$status = -1
								else
									setocc "FIS_NFITEMSVC", $curocc("FIS_NFITEMSVC") + 1
								endif
							endwhile
							
							if (vGeraC120 = <TRUE>) & (tp_moddctofiscal.fis_nfsvc != 55)
								$instancehandle->gerarEFDBlocoCRegC120($xCdErro$, $xCtxErro$)
								if ($procerror)
									$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									poCdErro  = $xCdErro$
									poCtxErro = $xCtxErro$
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									poCdErro  = $xCdErro$
									poCtxErro = $xCtxErro$
									return(-1)
								endif
							endif
						endif
					endif
					;Complemento do documento - fatura.
					;Indicador do tipo de pagamento.
					; @>-/-- Virginia - PRJ 061 TAR 743 - 04/02/10
					;if (cd_condpgto.fis_nfsvc > 1) & ((tp_moddctofiscal.fis_nfsvc = 1) | (tp_moddctofiscal.fis_nfsvc = 55))
					;;ICJ [PROJ/TAR 170/87] (23/09/2010)
					;if (cd_condpgto.fis_nfsvc > 1) & (tp_moddctofiscal.fis_nfsvc = 1)
					if (vPrazo = <TRUE>) & (tp_moddctofiscal.fis_nfsvc = 1)
					;;	
						;A prazo.
						$instancehandle->gerarEFDBlocoCRegC140($xCdErro$, $xCtxErro$)
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif
					endif
					; --\-<@                
					;Volumes transportados.
					$instancehandle->gerarEFDBlocoCRegC160($xCdErro$, $xCtxErro$)
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
					
					;Itens do documento.
; -> rodrigo - prj 170 tar 549 - 17/09/2012
;					if (TP_MODDCTOFISCAL.FIS_NFSVC != 55 | (TP_MODDCTOFISCAL.FIS_NFSVC = 55 & tp_origememissao.fis_nfsvc != "1")) & %\
;					   (TP_MODDCTOFISCAL.FIS_NFSVC != 85 & TP_MODDCTOFISCAL.FIS_NFSVC != 86 & TP_MODDCTOFISCAL.FIS_NFSVC != 87) ;-- MAD [Proj/Tar.175/127] - 25/05/2011
					if ($inGeraC170Sped$ = <TRUE>) |((TP_MODDCTOFISCAL.FIS_NFSVC != 55 | (TP_MODDCTOFISCAL.FIS_NFSVC = 55 & tp_origememissao.fis_nfsvc != "1")) & %\
					   (TP_MODDCTOFISCAL.FIS_NFSVC != 85 & TP_MODDCTOFISCAL.FIS_NFSVC != 86 & TP_MODDCTOFISCAL.FIS_NFSVC != 87))
; <- rodrigo - prj 170 tar 549 - 17/09/2012
						;CFC: 25/02/2010 
						clear/e "FIS_NFITEMSVC"
						CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
						dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
						nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
						retrieve/e "FIS_NFITEMSVC"
						;
						$instancehandle->gerarEFDBlocoCRegC170($xCdErro$, $xCtxErro$)
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif
					endif
				;;ICJ [PROJ/TAR 170/150] (09/12/2010)
				else
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|C100"
					;Indicador do tipo de operacao.
					if (tp_operacao.fis_nfsvc = "E")
						;Entrada.
						vStringAux = "|0"
					else
						;Saida.
						vStringAux = "|1"
					endif
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Indicador do emitente do documento fiscal.
					if (tp_origememissao.fis_nfsvc = "1")
						;Emissao propria.
						vStringAux = "|0"
					else
						;Emissao terceiros.
						vStringAux = "|1"
					endif
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					
					clear/e "FIS_S_NFREMDESVC"
					CD_EMPFAT.fis_S_nfremdesvc/init = CD_EMPFAT.fis_nfsvc
					dt_fatura.fis_s_nfremdesvc/init  = dt_fatura.fis_nfsvc
					nr_fatura.fis_s_nfremdesvc/init  = nr_fatura.fis_nfsvc
					retrieve/e "FIS_S_NFREMDESVC"
					if ($status >= 0)
						
						;creocc "F_TMP_NR09SVC", -1
						;nr_geral.f_tmp_nr09svc = cd_pessoa.fis_s_nfremdesvc
						;retrieve/o "F_TMP_NR09SVC"
						;if ($status = 4)
						;	retrieve/x "F_TMP_NR09SVC"
						;endif
						;
						;nm_cliente.f_tmp_nr09svc = nm_nome.fis_s_nfremdesvc
						;tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_s_nfremdesvc
						;if (tp_pessoa.fis_s_nfremdesvc = "F")
						;	nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_s_nfremdesvc
						;else
						;	nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_s_nfremdesvc
						;endif
						;nr_rginscr.f_tmp_nr09svc    = nr_rginscrest.fis_s_nfremdesvc
						; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
						;vPesCliente = ""
						;viParams = ""
						;voParams = ""
						;putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_s_nfremdesvc
						;activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						;if ($procerror)
						;	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						;	return(-1)
						;elseif ($status < 0)
						;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						;	return(-1)
						;endif
						;if (voParams != "")
						;	vPesCliente = voParams
						;endif
						;NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)
						;nr_suframa.f_tmp_nr09svc    = nr_suframa.pes_clientesvc
						; --\-<@
						;ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_s_nfremdesvc %%nm_logradouro.fis_s_nfremdesvc"
						;nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_s_nfremdesvc
						;nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_s_nfremdesvc
						;if (cd_cep.fis_s_nfremdesvc != 99999999)
							; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
						;	vGlbLogradouro = ""
						;	viParams = ""
						;	voParams = ""
						;	putitem/id viParams, "CD_CEP", cd_cep.fis_s_nfremdesvc
						;	activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						;	if ($procerror)
						;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						;		return(-1)
						;	elseif ($status < 0)
						;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						;		return(-1)
						;	endif
						;	if (voParams != "")
						;		vGlbLogradouro = voParams
						;	endif
						;	
						;	vCdEstado = ""
						;	vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
						;	
						;	cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
						;	cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
						;	ds_estado.f_tmp_nr09svc    = vCdEstado
						;	ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
						;endif
					endif
					
					;Codigo do participante.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					
					;Codigo do modelo do documento fiscal.
					;-- MAD [Proj/Tar.170/245] - 04/05/2011
					;if (tp_moddctofiscal.fis_nfsvc = 85)
					if (tp_moddctofiscal.fis_nfsvc = 85) | (tp_moddctofiscal.fis_nfsvc = 86) | (tp_moddctofiscal.fis_nfsvc = 87)
						if (ds_chaveacesso.fis_nfesvc != "")
							vNumericAux = 55
						else
					;;
							vNumericAux = 1
						endif
					else
						vNumericAux = tp_moddctofiscal.fis_nfsvc
					endif
					;;ICJ [PROJ/TAR 175/332] (22/03/2012)
					if (tp_moddctofiscal.fis_nfsvc = 70)
						vStringConv = "1B"
						vTpModDocFis = vStringConv
					else
					;;
						vTpModDocFis = vNumericAux
						call convNumeric(vNumericAux, 2, vStringConv)
					endif

					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Codigo da situacao do documento fiscal.
					if (tp_situacao.fis_nfsvc = "C")
						;Nota cancelada.
						vStringAux = "|02"
					;;ICJ [PROJ/TAR 170/150] (09/12/2010)
					elseif (tp_situacao.fis_nfsvc = "D")
						;Nota denegada.
						vStringAux = "|04"
					endif
					;;
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Serie do documento fiscal.
					vStringAux = "|%%cd_serie.fis_nfsvc"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Numero do documento fiscal.
					call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Chave da nota fiscal eletronica.
					vStringAux = ""
					;-- MAD [Proj/Tar.175/356] - 27/04/2012
					;;--> VSOUZA PRJ/TAR 175/304 02/02/2012					
					;;Sandra e Camargo 20/02/2012, não estava trazendo a chave p/NF de complemento
					;;if (TP_MODDCTOFISCAL.FIS_NFSVC = 55) & (TP_PROCESSAMENTO.FIS_NFESVC = "C") & (TP_ORIGEMEMISSAO.FIS_NFSVC = "1")
					;if (vTpModDocFis = "55") & (TP_PROCESSAMENTO.FIS_NFESVC = "C") & (TP_ORIGEMEMISSAO.FIS_NFSVC = "1")
					;;;
					;	viParams = ""
					;	voParams = ""
					;	putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.FIS_NFSVC
					;	putitem/id viParams, "NR_FATURA",  NR_FATURA.FIS_NFSVC
					;	putitem/id viParams, "DT_FATURA",  DT_FATURA.FIS_NFSVC
					;	putitem/id viParams, "NM_CARREGATABELA", "FIS_NFE"
					;	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					;	if ($procerror)
					;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					;		return(-1)
					;	elseif ($status < 0)
					;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					;		return(-1)
					;	endif
					;	vStringAux = $item("DS_CHAVEACESSO",voParams)
					;endif
					if (vTpModDocFis = "55") & (TP_ORIGEMEMISSAO.FIS_NFSVC = "1")
						vStringAux = DS_CHAVEACESSO.FIS_NFESVC
					endif
					;;
					;--------------------------------------<
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Data de emissao do documento fiscal.
					vStringAux = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Data da entrada ou da saida.
					vStringAux = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Valor total do documento fiscal.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Indicador do tipo de pagamento.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor total do desconto.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Abatimento nao tributavel
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor das mercadorias.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Indicador do tipo do frete.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do frete.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do seguro.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor de outras despesas acessorias.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor da base de calculo do ICMS.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do ICMS.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor da base de calculo do ICMS substituicao tributaria.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do ICMS retido por substituicao tributaria.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do IPI.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do PIS.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor do COFINS.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor total do PIS retido por substituicao tributaria.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Valor total do COFINS retido por substituicao tributaria.
					vStringConv = ""
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"
					
					;filedump/append vDsConteudo, ds_path.sis_filtro
					creocc "SIS_ARQUIVOSVC", -1
					ds_reg.sis_arquivosvc = "C100"
					ds_registro.sis_arquivosvc = vDsConteudo
					
					$nrLinhaBloco$   = $nrLinhaBloco$   + 1
					$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
					$nrRegistroArq$  = $nrRegistroArq$  + 1
					
					$instancehandle->totalizarQtdTipoRegistro("C100")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
	
					;-- MAD [Proj/Tar.170/238] - 27/04/2011
					;Informação complementar da NF
					$instancehandle->gerarEFDBlocoCRegC110($xCdErro$, $xCtxErro$)
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
					;;
				;;
				endif
			;endif
			
				;Registro analitico do documento.
				$instancehandle->gerarEFDBlocoCRegC190($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
	
				;-- MAD [Proj/Tar.170/238] - 27/04/2011
				;Observação do lançamento fiscal
				$instancehandle->gerarEFDBlocoCRegC195($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				;;

				; -> rodrigo - prj 189 tar 52 - 07/12/2011
				;Diferencial de aliquota
				$instancehandle->gerarEFDBlocoCRegC197($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				; <- rodrigo - prj 189 tar 52 - 07/12/2011

				;-- MAD [Proj/Tar.170/381] - 27/10/2011
				;Informações refrente ao registro 1700
				if (TP_ORIGEMEMISSAO.FIS_NFSVC = 1) & (TP_AMBIENTE.FIS_NFEXMLSVC = 1) & (TP_EMISSAO.FIS_NFEXMLSVC = 5)
					creocc "F_TMP_NRDSSVC", -1
					NR_GERAL.F_TMP_NRDSSVC  = NR_NF.FIS_NFSVC
					DS_GERAL.F_TMP_NRDSSVC  = CD_SERIE.FIS_NFSVC
					retrieve/o "F_TMP_NRDSSVC"
					if ($status = -7)
						retrieve/x "F_TMP_NRDSSVC"
					endif
					TP_MODDOCFIS.F_TMP_NRDSSVC = vTpModDocFis
					TP_SITUACAO.F_TMP_NRDSSVC  = TP_SITUACAO.FIS_NFSVC
					NR_RECIBO.F_TMP_NRDSSVC    = NR_RECIBO.FIS_NFESVC
				endif
				;;
			endif

			discard "FIS_NFSVC"
			if ($status = 0)
				$status = -1
			endif
		endwhile
	endif
	clear/e "FIS_NFSVC"

	return(0)
End ;operation gerarEFDBlocoCRegC100.

;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC140              ;
	;----------------------------------------------------;
	; @>-/-- Virginia - PRJ 061 TAR 743 - 04/02/10
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vDsIndTit, vDsNumTit, vDsDescTit
		string  vLstDuplicata, vDsRegistro
		numeric vQtParcela, vNrDoc, vVlDoc
		string  vNumericAux
		boolean vInGera
	endvariables
	
	if ($item("IN_GERA_REGC140_FIN", $xlplemp$) = 1) ;ICJ [PROJ/TAR 170/87] (23/09/2010)
		if (tp_operacao.fis_nfsvc = "E")
			;busca faturas pelo contas a pagar FGR_LIQITEMCC
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_EMPRESAORI"  , CD_EMPRESAORI.FIS_NFSVC
			putitem/id viParams, "NR_TRANSACAOORI", NR_TRANSACAOORI.FIS_NFSVC
			putitem/id viParams, "DT_TRANSACAOORI", DT_TRANSACAOORI.FIS_NFSVC
			activate "FISSVCO048".geraContaPagar($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
		else	
			;busca faturas pelo contas a receber FGR_LIQITEMCR
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_EMPRESAORI"  , CD_EMPRESAORI.FIS_NFSVC
			putitem/id viParams, "NR_TRANSACAOORI", NR_TRANSACAOORI.FIS_NFSVC
			putitem/id viParams, "DT_TRANSACAOORI", DT_TRANSACAOORI.FIS_NFSVC
			activate "FISSVCO048".geraContaReceber($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)       
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
		endif
		vLstDuplicata = voParams
	
		if (vLstDuplicata != "")
			repeat
				getitem vDsRegistro, vLstDuplicata, 1

				vInGera = <FALSE>
				;busca qtde parcelas
				;;ICJ [PROJ/TAR 61/845] (03/08/2010)
				if (tp_operacao.fis_nfsvc = "E")
					if (vNrDoc != $item("NR_DUPLICATA",vDsRegistro))
						vInGera = <TRUE>
						vNrDoc = $item("NR_DUPLICATA",vDsRegistro)
					
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.FIS_NFSVC
						putitem/id viParams, "CD_FORNECEDOR", CD_PESSOA.FIS_NFREMDESSVC
						putitem/id viParams, "NR_DUPLICATA", $item("NR_DUPLICATA",vDsRegistro)
						activate "FISSVCO032".buscaParcelasFCP($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
					
						vQtParcela = $item("QT_PARCELA",voParams)
						vVlDoc     = $item("VL_DOC",voParams)
					endif
				else
					if (vNrDoc != $item("NR_FATURA",vDsRegistro))
						vInGera = <TRUE>
						vNrDoc = $item("NR_FATURA",vDsRegistro)
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.FIS_NFSVC
						putitem/id viParams, "CD_CLIENTE", CD_PESSOA.FIS_NFREMDESSVC
						putitem/id viParams, "NR_FAT", $item("NR_FATURA",vDsRegistro)
						activate "FISSVCO032".buscaParcelasFCR($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
				
						vQtParcela = $item("QT_PARCELA",voParams)
						vVlDoc     = $item("VL_DOC",voParams)
					endif
				endif
				;;ICJ [PROJ/TAR 61/845] (03/08/2010)
				if (vInGera = <TRUE>) ;;ICJ [PROJ/TAR 61/845] (03/08/2010)
	
					vDsNumTit  = $item("NR_FATURA",vDsRegistro)	

					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_EMPRESAORI"  , CD_EMPRESAORI.FIS_NFSVC
					putitem/id viParams, "NR_TRANSACAOORI", NR_TRANSACAOORI.FIS_NFSVC
					putitem/id viParams, "DT_TRANSACAOORI", DT_TRANSACAOORI.FIS_NFSVC
					putitem/id viParams, "ENT_SAI", tp_operacao.fis_nfsvc 
					activate "FISSVCO048".contaParcelas($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)       
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
	
					vDsIndTit  = $item("IND_TIT",voParams)
					vDsDescTit = $item("DESC_TIT",voParams)
			
					$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C140", "", "")
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
					endif
				
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|C140"
					;Indicador do emitente do titulo.
					if (tp_origememissao.fis_nfsvc = "1")
						;Emissao propria.
						vStringAux = "|0"
					else
						;Emissao terceiros.
						vStringAux = "|1"
					endif
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Indicador do tipo de titulo de credito.
					vStringAux = "|%%vDsIndTit"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Descricao complementar do titulo de credito.
					vStringAux = "|%%vDsDescTit"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Numero ou codigo identificador do titulo de credito.
					call retirarNaoNumerico(vDsNumTit, vStringAux)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Quantidade de parcelas a pagar.
					vStringAux = "|%%vQtParcela"	
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Valor original do titulo de credito.
					vNumericAux = vVlDoc
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"	
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"
		
					;filedump/append vDsConteudo, ds_path.sis_filtro
					creocc "SIS_ARQUIVOSVC", -1
					ds_reg.sis_arquivosvc = "C140"
					ds_registro.sis_arquivosvc = vDsConteudo
				
					$nrLinhaBloco$   = $nrLinhaBloco$   + 1
					$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
					$nrRegistroArq$  = $nrRegistroArq$  + 1
		
					$instancehandle->totalizarQtdTipoRegistro("C140")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif

				;Vencimento da fatura.
				;;ICJ [PROJ/TAR 61/845] (03/08/2010)
				$instancehandle->gerarEFDBlocoCRegC141(vDsRegistro,$xCdErro$, $xCtxErro$)
				;$instancehandle->gerarEFDBlocoCRegC141($xCdErro$, $xCtxErro$)
				;;	
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
	
				delitem vLstDuplicata, 1
			until (vLstDuplicata = "")
		endif	
	else
		;;ICJ [PROJ/TAR 170/87] (23/09/2010)
		clear/e "FIS_NFVENCTOSVC"
		CD_EMPRESA.FIS_NFVENCTOSVC/init = CD_EMPRESA.FIS_NFSVC
		NR_FATURA.FIS_NFVENCTOSVC/init  = NR_FATURA.FIS_NFSVC
		DT_FATURA.FIS_NFVENCTOSVC/init  = DT_FATURA.FIS_NFSVC
		retrieve/e "FIS_NFVENCTOSVC"
		if ($status >= 0)
			vQtParcela = 0
			vVlDoc     = 0
			setocc "FIS_NFVENCTOSVC", 1
			while ($status >= 0)
				vVlDoc = vVlDoc + VL_PARCELA.FIS_NFVENCTOSVC
				vQtParcela = vQtParcela + 1
				setocc "FIS_NFVENCTOSVC", $curocc("FIS_NFVENCTOSVC") + 1
			endwhile
			if (tp_operacao.fis_nfsvc = "E")
				vDsIndTit = "00"
				vDsDescTit = ""	
			else
				vDsIndTit = "99"
				vDsDescTit = "FATURA"
			endif

			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|C140"
			;Indicador do emitente do titulo.
			if (tp_origememissao.fis_nfsvc = "1")
				;Emissao propria.
				vStringAux = "|0"
			else
				;Emissao terceiros.
				vStringAux = "|1"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"

			;Indicador do tipo de titulo de credito.
			vStringAux = "|%%vDsIndTit"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Descricao complementar do titulo de credito.
			vStringAux = "|%%vDsDescTit"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Numero ou codigo identificador do titulo de credito.
			vDsNumTit = NR_FATURA.FIS_NFSVC
			call retirarNaoNumerico(vDsNumTit, vStringAux)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Quantidade de parcelas a pagar.
			vStringAux = "|%%vQtParcela"	
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor original do titulo de credito.
			vNumericAux = vVlDoc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"	
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
		
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C140"
			ds_registro.sis_arquivosvc = vDsConteudo
				
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
		
			$instancehandle->totalizarQtdTipoRegistro("C140")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif

		setocc "FIS_NFVENCTOSVC", 1
		while ($status >= 0)
			vDsRegistro = ""
			putitem/id vDsRegistro, "NR_PARCELA"  , NR_PARCELA.FIS_NFVENCTOSVC
			putitem/id vDsRegistro, "DT_VENCTO", DT_VENCIMENTO.FIS_NFVENCTOSVC
			putitem/id vDsRegistro, "VL_DUPLICATA", VL_PARCELA.FIS_NFVENCTOSVC

			;Vencimento da fatura.
			;;ICJ [PROJ/TAR 61/845] (03/08/2010)
			$instancehandle->gerarEFDBlocoCRegC141(vDsRegistro,$xCdErro$, $xCtxErro$)
			;$instancehandle->gerarEFDBlocoCRegC141($xCdErro$, $xCtxErro$)
			;;	
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			setocc "FIS_NFVENCTOSVC", $curocc("FIS_NFVENCTOSVC") + 1
		endwhile
		;;
	endif

	return(0)
End ;operation gerarEFDBlocoCRegC140.


;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC141              ;
	;----------------------------------------------------;
	; @>-/-- Virginia - PRJ 061 TAR 743 - 04/02/10
	params
		string  poRegistro:IN
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vLstDuplicata, vDsAux, vDsRegistro
		numeric vQtParcela
		string  vNumericAux
		date    vDtAux
	endvariables

;;ICJ [PROJ/TAR 61/845] (03/08/2010) -Comentado este código pois o registro vem por parâmetro pelo registro C140
;	if (tp_operacao.fis_nfsvc = "E")
;		;busca faturas pelo contas a pagar FGR_LIQITEMCC
;		viParams = ""
;		voParams = ""
;		putitem/id viParams, "CD_EMPRESAORI"  , CD_EMPRESAORI.FIS_NFSVC
;		putitem/id viParams, "NR_TRANSACAOORI", NR_TRANSACAOORI.FIS_NFSVC
;		putitem/id viParams, "DT_TRANSACAOORI", DT_TRANSACAOORI.FIS_NFSVC
;		activate "FISSVCO048".geraContaPagar($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
;		if ($procerror)       
;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			return(-1)
;		elseif ($status < 0)
;			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;			return(-1)
;		endif
;	else
;		;busca faturas pelo contas a receber FGR_LIQITEMCR
;		viParams = ""
;		voParams = ""
;		putitem/id viParams, "CD_EMPRESAORI"  , CD_EMPRESAORI.FIS_NFSVC
;		putitem/id viParams, "NR_TRANSACAOORI", NR_TRANSACAOORI.FIS_NFSVC
;		putitem/id viParams, "DT_TRANSACAOORI", DT_TRANSACAOORI.FIS_NFSVC
;		activate "FISSVCO048".geraContaReceber($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
;		if ($procerror)       
;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			return(-1)
;		elseif ($status < 0)
;			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;			return(-1)
;		endif
;	endif
	
;	vLstDuplicata = voParams
;	
;	if (vLstDuplicata != "")
;		repeat
;			getitem vDsRegistro, vLstDuplicata, 1
;;
			vDsregistro = poRegistro
			;Texto fixo.
			vDsConteudo = "|C141|"
			;Número da Parcela
			vStringAux  = $item("NR_PARCELA",vDsRegistro)
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Data de vencimento
			vDtAux = $item("DT_VENCTO",vDsRegistro)
			vStringAux  = "|%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"	
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor da duplicata
			vNumericAux = $item("VL_DUPLICATA",vDsRegistro)
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C141"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("C141")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif   
;;ICJ [PROJ/TAR 61/845] (03/08/2010)
;			delitem vLstDuplicata, 1
;		until (vLstDuplicata = "")
;	endif    
;;	
	return(0)
End ;operation gerarEFDBlocoCRegC141.
; --\-<@

;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC160              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux
		numeric vQtParcela
		string  vNumericAux
	endvariables

	tp_frete.fis_nftranspsvc/init = 1
	if ($empty("FIS_NFTRANSPSVC")) | (tp_frete.fis_nftranspsvc = 1)
		return(0)
	endif
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C160", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	
	setocc "FIS_NFTRANSPSVC", 1
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|C160"
	;Codigo do participante. Transportador se houver.
	vStringAux = "|%%cd_transport.fis_nftranspsvc"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Placa de identificacao do veiculo.
	vStringAux = "|%%nr_placa.fis_nftranspsvc"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Quantidade de volumes transportados.
	vStringAux = "|%%qt_volume.fis_nftranspsvc"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Peso bruto dos volumes transportados (em Kg).
	vStringAux = "|%%qt_pesobruto.fis_nftranspsvc"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Peso liquido dos volumes transportados (em Kg).
	vStringAux = "|%%qt_pesoliquido.fis_nftranspsvc"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "C160"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("C160")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	;-- MAD [Proj/Tar.170/494] - 24/07/2012
	;A lógica abaixo foi comentada pois o registro C115 é filho do registro C110
	;
	;;Coleta e entrega.
	;$instancehandle->gerarEFDBlocoCRegC115($xCdErro$, $xCtxErro$)
	;if ($procerror)
	;	$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;	poCdErro  = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;	return(-1)
	;elseif ($status < 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	poCdErro  = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;	return(-1)
	;endif
	;
	;;Coleta e entrega.
	;$instancehandle->gerarEFDBlocoCRegC115($xCdErro$, $xCtxErro$)
	;if ($procerror)
	;	$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;	poCdErro  = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;	return(-1)
	;elseif ($status < 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	poCdErro  = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;	return(-1)
	;endif
	;;

	return(0)
End ;operation gerarEFDBlocoCRegC160.


;---------------------------------------------------;
partner operation gerarEFDBlocoCRegC120             ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux
		numeric vQtParcela
		string  vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C120", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|C120"
	;COD DOC IMP
	vStringAux = TP_DOCUMENTO.FIS_NFIMPSVC
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;NUM DOC IMP
	vStringAux = NR_DECLARACAO.FIS_NFIMPSVC
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;PIS_IMP.
	vNumericAux = VL_PISIMP.FIS_NFIMPSVC
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;COFINS_IMP.
	vNumericAux = VL_COFINSIMP.FIS_NFIMPSVC
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	
	; @>-/-- Virginia - PRJ 061 TAR 743 - 02/02/10
	; Número do Ato Concessório do regime Drawback
	vStringAux = DS_ACDRAW.FIS_NFIMPSVC
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	; --\-<@
	
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "C120"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("C120")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoCRegC120.

;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC115              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vPesFisica, vPesJuridica, vPesEndereco, vVPesEndereco
		numeric vCdEstado
		string  vNumericAux
	endvariables

	;-- MAD [Proj/Tar.170/494] - 24/07/2012
	;$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C115", "", "")
	;if ($procerror)
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	poCdErro  = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;endif
	;	
	;vDsConteudo = ""
	;;Texto fixo.
	;vDsConteudo = "|C115"
	;;Indicador do tipo de transporte da carga coletada.
	;vStringAux = "|0"
	;vDsConteudo = "%%vDsConteudo%%vStringAux"
	;	
	;;Informacoes do local de coleta.
	;; @>-/-- Virginia - PRJ 061 TAR 772 - 17/02/10    
	;vPesEndereco = ""
	;viParams = ""
	;voParams = ""
	;putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	;activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	;if ($procerror)
	;	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;	return(-1)
	;elseif ($status < 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	return(-1)
	;endif
	;if (voParams != "")
	;	vPesEndereco = voParams
	;	
	;	vVPesEndereco = ""
	;	viParams = ""
	;	voParams = ""
	;	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	;	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	;	if ($procerror)
	;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;		return(-1)
	;	elseif ($status < 0)
	;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;		return(-1)
	;	endif
	;	if (voParams != "")
	;		vVPesEndereco = voParams
	;	endif
	;endif
	;; --\-<@
	;; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10    
	;vPesJuridica = ""
	;viParams = ""
	;voParams = ""
	;putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	;activate "FISSVCO032".carregaPesJuridica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	;if ($procerror)
	;	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;	return(-1)
	;elseif ($status < 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	return(-1)
	;endif
	;if (voParams != "")
	;	vPesJuridica = voParams
	;endif
	;; --\-<@
	;	
	;;Numero de inscricao do contribuinte no CNPJ do local de coleta.
	;; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10    
	;;vNumericAux = nr_cnpj.pes_pesjuridisvc
	;vNumericAux = $item("NR_CNPJ",vPesJuridica)
	;; --\-<@
	;call convNumeric(vNumericAux, 14, vStringConv)
	;vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;;Inscricao estadual do contribuinte do local de coleta.
	;;-- MAD [Proj/Tar.061/591] - 27/04/2009
	;;vStringAux = "|%%nr_inscestl.pes_pesjuridica"
	;; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10    
	;;call convString("nr_inscestl.pes_pesjuridica", nr_inscestl.pes_pesjuridisvc, 20, vStringConv)
	;call convString("nr_inscestl.pes_pesjuridica", $item("NR_INSCESTL",vPesJuridica) , 20, vStringConv)
	;vStringAux = "|%%vStringConv"
	;;;
	;vDsConteudo = "%%vDsConteudo%%vStringAux"
	;;CPF do contribuinte do local de coleta das mercadorias.
	;vStringAux = "|"
	;vDsConteudo = "%%vDsConteudo%%vStringAux"
	;;Codigo do municipio do local de coleta.
	;;vNumericAux = cd_municipio.pes_enderecosvc
	;vNumericAux = $item("CD_MUNICIPIO",vPesEndereco)
	;call convNumeric(vNumericAux, 7, vStringConv)
	;vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;	
	;;Informacoes do local de entrega.
	;; @>-/-- Virginia - PRJ 061 TAR 772 - 17/02/10    
	;vPesEndereco = ""
	;viParams = ""
	;voParams = ""
	;putitem/id viParams, "CD_PESSOA", cd_pessoa.fis_nfsvc
	;activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	;if ($procerror)
	;	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;	return(-1)
	;elseif ($status < 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	return(-1)
	;endif
	;if (voParams != "")
	;	vPesEndereco = voParams
	;		
	;	vVPesEndereco = ""
	;	viParams = ""
	;	voParams = ""
	;	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	;	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	;	if ($procerror)
	;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;		return(-1)
	;	elseif ($status < 0)
	;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;		return(-1)
	;	endif
	;	if (voParams != "")
	;		vVPesEndereco = voParams
	;	endif
	;endif
	;; --\-<@
	;	
	;; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10    
	;vPesJuridica = ""
	;viParams = ""
	;voParams = ""
	;putitem/id viParams, "CD_PESSOA", cd_pessoa.fis_nfsvc
	;activate "FISSVCO032".carregaPesJuridica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	;if ($procerror)
	;	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;	return(-1)
	;elseif ($status < 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	return(-1)
	;endif
	;if (voParams != "")
	;	vPesJuridica = voParams
	;endif
	;; --\-<@
	;
	;;Numero de inscricao do contribuinte no CNPJ do local de entrega.
	;; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10    
	;;vNumericAux = nr_cnpj.pes_pesjuridisvc
	;vNumericAux = $item("NR_CNPJ",vPesJuridica)
	;; --\-<@
	;call convNumeric(vNumericAux, 14, vStringConv)
	;vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;;Inscricao estadual do contribuinte do local de entrega.
	;;-- MAD [Proj/Tar.061/591] - 27/04/2009
	;;vStringAux = "|%%nr_inscestl.pes_pesjuridica"
	;; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10    
	;;call convString("nr_inscestl.pes_pesjuridica", nr_inscestl.pes_pesjuridisvc, 20, vStringConv)
	;call convString("nr_inscestl.pes_pesjuridica", $item("NR_INSCESTL",vPesJuridica) , 20, vStringConv)
	;; --\-<@
	;vStringAux = "|%%vStringConv"
	;;;
	;vDsConteudo = "%%vDsConteudo%%vStringAux"
	;;CPF do contribuinte do local de entrega das mercadorias.
	;vStringAux = "|"
	;vDsConteudo = "%%vDsConteudo%%vStringAux"
	;;Codigo do municipio do local de entrega.
	;;vNumericAux = cd_municipio.pes_enderecosvc
	;vNumericAux = $item("CD_MUNICIPIO",vPesEndereco)
	;call convNumeric(vNumericAux, 7, vStringConv)
	;vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;;Marcador.
	;vDsConteudo = "%%vDsConteudo%%%|%%^"
	;	
	;;filedump/append vDsConteudo, ds_path.sis_filtro
	;creocc "SIS_ARQUIVOSVC", -1
	;ds_reg.sis_arquivosvc = "C115"
	;ds_registro.sis_arquivosvc = vDsConteudo
	;	
	;$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	;$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	;$nrRegistroArq$  = $nrRegistroArq$  + 1
	;	
	;$instancehandle->totalizarQtdTipoRegistro("C115")
	;if ($procerror)
	;	$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;	poCdErro  = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;	return(-1)
	;elseif ($status < 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	poCdErro  = $xCdErro$
	;	poCtxErro = $xCtxErro$
	;	return(-1)
	;endif

	if ($empty("FIS_ENDAUXSVC"))
		return(0)
	endif
	
	setocc "FIS_ENDAUXSVC",1
	while ($status >= 0)
		if (TP_ENDERECO.FIS_ENDAUXSVC = 5) ; Entrega

			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C115", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif

			vDsConteudo = ""

			;Texto fixo.
			vDsConteudo = "|C115"

			;Indicador do tipo de transporte da carga coletada.
			vStringAux  = "|0"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
	
			;Número do CNPJ do contribuinte do local de coleta
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
			activate "FISSVCO032".carregaPesJuridica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			vStringAux = $item("NR_CNPJ",voParams)
			call convNumeric(vStringAux, 14, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

			;Inscricao estadual do contribuinte do local de coleta.
			vStringAux  = $item("NR_INSCESTL",voParams)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

			;CPF do contribuinte do local de coleta das mercadorias.
			vStringAux  = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"

			;Codigo do municipio do local de coleta (IBGE).
			vPesEndereco = ""
			viParams     = ""
			voParams     = ""
			putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
			activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			vPesEndereco = voParams

			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_ESTADO"   , $item("CD_ESTADO"   ,vPesEndereco)
			putitem/id viParams, "CD_MUNICIPIO", $item("CD_MUNICIPIO",vPesEndereco)
			activate "FISSVCO032".carregaMunIBGE($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			vCdEstado = $item("DS_ESTADO",vPesEndereco)
			call convNumeric($item("CD_MUNICIPIOIBGE",voParams), 5, vStringConv)    
			vStringConv = "%%vCdEstado%%vStringConv"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

			;Numero do CNPJ do contribuinte do local de entrega.
			vStringAux = NR_CPFCNPJ.FIS_ENDAUXSVC
			call convNumeric(vStringAux, 14, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

			;Inscricao estadual do contribuinte do local de entrega.
			vStringAux  = NR_RGINSCREST.FIS_ENDAUXSVC
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

			;CPF do contribuinte do local de entrega das mercadorias.
			vStringAux  = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"

			;Codigo do municipio do local de entrega (IBGE).
			vPesEndereco = ""
			viParams     = ""
			voParams     = ""
			putitem/id viParams, "CD_PESSOA", CD_PESSOA.FIS_ENDAUXSVC
			activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			vPesEndereco = voParams

			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_ESTADO"   , $item("CD_ESTADO"   ,vPesEndereco)
			putitem/id viParams, "CD_MUNICIPIO", $item("CD_MUNICIPIO",vPesEndereco)
			activate "FISSVCO032".carregaMunIBGE($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			vCdEstado = $item("DS_ESTADO",vPesEndereco)
			call convNumeric($item("CD_MUNICIPIOIBGE",voParams), 5, vStringConv)    
			vStringConv = "%%vCdEstado%%vStringConv"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"

			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C115"
			ds_registro.sis_arquivosvc = vDsConteudo

			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
	
			$instancehandle->totalizarQtdTipoRegistro("C115")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		setocc "FIS_ENDAUXSVC", $curocc("FIS_ENDAUXSVC") + 1
	endwhile
	;;	
	
	return(0)

End ;operation gerarEFDBlocoCRegC115.

;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC170              ;
;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		boolean vInSomou, vInGerar
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, viParams, voParams, vStrAux, vFisCfop, vFisTipi
		string  vCtIpi, vNumericAux, vCdCST
		numeric vContador, vVlBaseIcms, vVlIcms, vTotDig, vTotBaseIcms, vTotBaseIcmsArred, vTotIcms, vTotIcmsArred
		numeric vTotBaseST, vTotBaseSTArred, vTotST, vTotSTArred, vDifBaseIcms, vDifIcms, vDifBaseST, vDifST
	endvariables
	
	if ($empty("FIS_NFITEMSVC"))
		return(0)
	endif

	vInSomou = <FALSE>

	clear/e "FIS_S_NFITEMSVC"

	setocc "FIS_NFITEMSVC", -1
	sort/e "FIS_NFITEMSVC", "CD_CFOP.FIS_NFITEMSVC"
	setocc "FIS_NFITEMSVC", 1
	while ($status >= 0)
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C170 / %%cd_produto.fis_nfitemsvc", "", "")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		;;ICJ [PROJ/TAR 170/419] (20/04/2012)	
		vInGerar = <TRUE>
		if (CD_CFOP.FIS_NFITEMSVC = 1605)
			vInGerar = <FALSE>
		endif
		if ($tpApurIcms$ = 2)
			if  (CD_CFOP.FIS_NFITEMSVC = 1601) |  %\
		 		(CD_CFOP.FIS_NFITEMSVC = 1602) |  %\	
				(CD_CFOP.FIS_NFITEMSVC = 5601) |  %\
				(CD_CFOP.FIS_NFITEMSVC = 5602) |  %\
				(CD_CFOP.FIS_NFITEMSVC = 5605)
				vInGerar = <FALSE>
			endif
		endif
		if (vInGerar = <TRUE>)
		;;	
			;-- MAD [Proj/Tar.189/176] - 25/07/2012
			;if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "") & (CD_CFOP.FIS_NFITEMSVC != 5605) & (CD_CFOP.FIS_NFITEMSVC != 1605)
			if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
			;;
				;-- MAD [Proj/Tar.170/160] - 04/01/2011
				if (cd_cfop.fis_s_nfitemsvc != cd_cfop.fis_nfitemsvc)
	
					vTotBaseIcms      = 0
					vTotBaseIcmsArred = 0
					vTotIcms          = 0
					vTotIcmsArred     = 0
					vTotBaseST        = 0
					vTotBaseSTArred   = 0
					vTotST            = 0
					vTotSTArred       = 0
					vDifBaseIcms      = 0
					vDifIcms          = 0
					vDifBaseST        = 0
					vDifST            = 0
	
					clear/e "FIS_S_NFITEMSVC"
					cd_empfat.fis_s_nfitemsvc/init = cd_empfat.fis_nfitemsvc
					dt_fatura.fis_s_nfitemsvc/init = dt_fatura.fis_nfitemsvc
					nr_fatura.fis_s_nfitemsvc/init = nr_fatura.fis_nfitemsvc
					cd_cfop.fis_s_nfitemsvc/init   = cd_cfop.fis_nfitemsvc
					retrieve/e "FIS_S_NFITEMSVC"
					if ($status >= 0)
						setocc "FIS_S_NFITEMSVC",1
						while ($status >= 0)
	
							clear/e "FIS_NFITEMIMPSVC"
							cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_s_nfitemsvc
							nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_s_nfitemsvc
							dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_s_nfitemsvc
							nr_item.fis_nfitemimpsvc/init    = nr_item.fis_s_nfitemsvc
							cd_imposto.fis_nfitemimpsvc/init = 1
							retrieve/e "FIS_NFITEMIMPSVC"
							if ($status >= 0)
								vNumericAux       = vl_basecalc.fis_nfitemimpsvc
								vNumericAux       = vNumericAux[round,2]
								vTotBaseIcms      = vTotBaseIcms + vl_basecalc.fis_nfitemimpsvc
								vTotBaseIcmsArred = vTotBaseIcmsArred + vNumericAux
	
								vNumericAux   = vl_imposto.fis_nfitemimpsvc
								vNumericAux   = vNumericAux[round,2]
								vTotIcms      = vTotIcms + vl_imposto.fis_nfitemimpsvc
								vTotIcmsArred = vTotIcmsArred + vNumericAux
							endif

							clear/e "FIS_NFITEMIMPSVC"
							cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_s_nfitemsvc
							nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_s_nfitemsvc
							dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_s_nfitemsvc
							nr_item.fis_nfitemimpsvc/init    = nr_item.fis_s_nfitemsvc
							cd_imposto.fis_nfitemimpsvc/init = 2
							retrieve/e "FIS_NFITEMIMPSVC"
							if ($status >= 0)
								vNumericAux     = vl_basecalc.fis_nfitemimpsvc
								vNumericAux     = vNumericAux[round,2]
								vTotBaseST      = vTotBaseST + vl_basecalc.fis_nfitemimpsvc
								vTotBaseSTArred = vTotBaseSTArred + vNumericAux
	
								vNumericAux = vl_imposto.fis_nfitemimpsvc
								vNumericAux = vNumericAux[round,2]
								vTotST      = vTotST + vl_imposto.fis_nfitemimpsvc
								vTotSTArred = vTotSTArred + vNumericAux
							endif
							setocc "FIS_S_NFITEMSVC", $curocc(FIS_S_NFITEMSVC) + 1
						endwhile
					endif
	
					vTotBaseIcms = vTotBaseIcms[round,2]
					vTotIcms     = vTotIcms[round,2]
					vTotBaseST   = vTotBaseST[round,2]
					vTotST       = vTotST[round,2]

					vDifBaseIcms = vTotBaseIcmsArred - vTotBaseIcms
					vDifIcms     = vTotIcmsArred - vTotIcms
					vDifBaseST   = vTotBaseSTArred - vTotBaseST
					vDifST       = vTotSTArred - vTotST
				endif
				;;

				setocc "FIS_NFITEMPROSVC", 1
				vContador = vContador + 1
				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|C170"
				;Numero sequencial do item no documento fiscal.
				;vStringAux = "|%%nr_item.fis_nfitem"
				vStringAux = "|%%vContador"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
			
				;Codigo do item.
				;-- MAD [Proj/Tar.061/526] - 18/12/2008
				;call convNumeric(cd_produto.fis_nfitemprod, 9, vStringConv)
				if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")|(CD_ESPECIE.FIS_NFITEMSVC = "SV");--> VSOUZA PRJ/TAR 189/019 22/09/2011
;					vTotDig = $length(cd_produto.fis_nfitemsvc)
					;vTotDig = 14
;					call convNumeric(cd_produto.fis_nfitemsvc, vTotDig, vStringConv)
					vStringConv = cd_produto.fis_nfitemsvc
				else
;					vTotDig = $length(cd_produto.fis_nfitemprosvc)
					;vTotDig = 14
;					call convNumeric(cd_produto.fis_nfitemprosvc, vTotDig, vStringConv)
					vStringConv = cd_produto.fis_nfitemprosvc
				endif
				;;
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				
				creocc "F_TMP_DS40SVC", -1
				if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")|(CD_ESPECIE.FIS_NFITEMSVC = "SV");--> VSOUZA PRJ/TAR 189/019 22/09/2011
					DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
				else
					DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
				endif

				if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
					clear/e "PRD_PRDCONVMESVC"
					CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
					retrieve/e "PRD_PRDCONVMESVC"
					if ($status >= 0)
						$instancehandle->totalizarQtdTipoRegistro("0220")
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif
					endif
				endif
	
				retrieve/o "F_TMP_DS40SVC"
				if ($status = 4)
					retrieve/x "F_TMP_DS40SVC"
					vCdEspecie = ds_especie.F_TMP_DS40SVC
				else
					ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
					ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
					vCdEspecie = cd_especie.fis_nfitemsvc
					if (cd_tipi.fis_nfitemsvc = "")
						if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")|(CD_ESPECIE.FIS_NFITEMSVC = "SV");--> VSOUZA PRJ/TAR 189/019 22/09/2011
							;                        se for serviço não vai ter ncm                              
						else
							clear/e "PRD_PRODUTOSVC"
							cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
							retrieve/e "PRD_PRODUTOSVC"
							if ($status >= 0)
								if (CD_ESPECIE.FIS_NFITEMSVC = "")
									ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
									vCdEspecie = cd_especie.prd_produtosvc
								endif
								if (cd_tipi.prd_produtosvc != "")
									; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
									vFisTipi = ""
									viParams = ""
									voParams = ""
									putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
									activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
									if ($procerror)
										$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
										return(-1)
									elseif ($status < 0)
										$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
										return(-1)
									endif
									if (voParams != "")
										vFisTipi = voParams
										vStrAux = $item("CD_TIPI",vFisTipi)
										vStrAux = $replace(vStrAux, 1, ".","",-1)
										cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
									endif
									; --\-<@
								endif
							endif
						endif
					else
						cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
						cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
					endif

					creocc "TMP_NRDSSVC", -1
					nr_geral.tmp_nrdssvc = 1
					ds_geral.tmp_nrdssvc = vCdEspecie
					retrieve/o "TMP_NRDSSVC"
					if ($status = 4)
						retrieve/x "TMP_NRDSSVC"
					endif
				endif
	
				;-- MAD [Proj/Tar.170/263] - 27/05/2011
				if (DS_40.F_TMP_DS40SVC != "")
					clear/e "FIS_NFITEMUNSVC"
					CD_EMPRESA.FIS_NFITEMUNSVC/init = CD_EMPRESA.FIS_NFITEMSVC
					NR_FATURA.FIS_NFITEMUNSVC/init  = NR_FATURA.FIS_NFITEMSVC
					DT_FATURA.FIS_NFITEMUNSVC/init  = DT_FATURA.FIS_NFITEMSVC
					NR_ITEM.FIS_NFITEMUNSVC/init    = NR_ITEM.FIS_NFITEMSVC
					CD_PRODUTO.FIS_NFITEMUNSVC/init = DS_40.F_TMP_DS40SVC
					retrieve/e "FIS_NFITEMUNSVC"
					if ($status >= 0) & (CD_ESPECIE.FIS_NFITEMUNSVC != vCdEspecie)
						vCdEspecie = CD_ESPECIE.FIS_NFITEMUNSVC
		
						clear/e "GTT_DS01SVC"
						creocc "GTT_DS01SVC", -1
						NR_GERAL.GTT_DS01SVC = DS_40.F_TMP_DS40SVC
						DS_GERAL.GTT_DS01SVC = vCdEspecie
						retrieve/o "GTT_DS01SVC"
						if ($status = -7)
							retrieve/x "GTT_DS01SVC"
						endif
						QT_CONVERSAO.GTT_DS01SVC = QT_CONVERSAO.FIS_NFITEMUNSVC
						$collhandle("GTT_DS01SVC")->Salvar()
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
	
						creocc "TMP_NRDSSVC", -1
						nr_geral.tmp_nrdssvc = 1
						ds_geral.tmp_nrdssvc = vCdEspecie
						retrieve/o "TMP_NRDSSVC"
						if ($status = 4)
							retrieve/x "TMP_NRDSSVC"
						endif
	
						creocc "TMP_DS40SVC", -1
						DS_40.TMP_DS40SVC = "0220"
						retrieve/o "TMP_DS40SVC"
						if ($status = -7)
							retrieve/x "TMP_DS40SVC"
						endif
					endif
				endif
				;;
		
				creocc "TMP_NR08SVC", -1
				nr_08.tmp_nr08svc = cd_cfop.fis_nfitemsvc
				retrieve/o "TMP_NR08SVC"
				if ($status = 4)
					retrieve/x "TMP_NR08SVC"
				else
					; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
					vFisCfop = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_CFOP", cd_cfop.fis_nfitemsvc
					activate "FISSVCO032".carregaFisCfop($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vFisCfop = voParams
						ds_cfop.tmp_nr08svc = $item("DS_CFOP",vFisCfop)
					endif
					; --\-<@            
				endif
			
				;Descricao complementar do item.
				call converterString(ds_produto.fis_nfitemsvc,vStringConv)
				vStringAux = "|%%vStringConv"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Quantidade do item.
				vNumericAux = qt_faturado.fis_nfitemsvc
				call editarNr(12, 5, vNumericAux, vNumericAux)
				call convValorString(5,vNumericAux, vStringConv)
				; @>-/-- Virginia - 111/1776 - Brascol
				if (tp_moddctofiscal.fis_nfsvc = 85) | (tp_moddctofiscal.fis_nfsvc = 86) | (tp_moddctofiscal.fis_nfsvc = 87)
					;Nota complementar o campo deve ser nulo
					vDsConteudo = "%%vDsConteudo%%%|"
				else
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				endif
				; --\-<@
				;Unidade do item.
				vStringAux = "|%%vCdEspecie"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Valor do item.
				;-- MAD [Proj/Tar.170/245] - 04/05/2011
				;if (tp_moddctofiscal.fis_nfsvc = 85)
				if (tp_moddctofiscal.fis_nfsvc = 85) | (tp_moddctofiscal.fis_nfsvc = 86) | (tp_moddctofiscal.fis_nfsvc = 87)
				;;
					vNumericAux = 0
				else
					vNumericAux = vl_totalliquido.fis_nfitemsvc
				endif
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor do desconto.
				;-- MAD [Proj/Tar.170/245] - 04/05/2011
				;if (tp_moddctofiscal.fis_nfsvc = 85)
				if (tp_moddctofiscal.fis_nfsvc = 85) | (tp_moddctofiscal.fis_nfsvc = 86) | (tp_moddctofiscal.fis_nfsvc = 87)
				;;
					vNumericAux = 0
				else
					vNumericAux = vl_totaldesc.fis_nfitemsvc
				endif
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Indicador de movimentacao real ou simbolica.
				vStringAux = "|0"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				
				clear/e "PRD_PRODUTOSVC"
				cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemsvc
				retrieve/e "PRD_PRODUTOSVC"
				if ($status < 0)
					clear/e "PRD_PRODUTOSVC"
				endif
				;Codigo da situacao tributaria.
				;-- MAD [Proj/Tar.170/117] - 22/11/2010
				if (TP_OPERACAO.FIS_NFSVC = "S") & ($item("IN_INFORMA_BCICMS_OUT",$xlplemp$) = 1) & ($item("UF_ORIGEM",$xlplemp$) = "CE") & %\
				   (($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4))
	
					vStringAux = cd_cst.fis_nfitemsvc[1,1]
					vCdCST     = cd_cst.fis_nfitemsvc[2,3]
					if (vCdCST = "00")
						vCdCST = "90"
						cd_cst.fis_nfitemsvc = "%%vStringAux%%vCdCST"
					endif
				endif

				;->RIM [170/555] - 21/09/2012
				if($inCalcImpdevSn$) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (TP_ORIGEMEMISSAO.FIS_NFSVC = 1) & ($inOptSimples$ = "S") & (IN_ZEROU.FIS_NFSVC = <TRUE>)
					vStringAux = cd_cst.fis_nfitemsvc[1,1]
					vCdCST     = cd_cst.fis_nfitemsvc[2,3]
				endif
				;<-

				;;
				call convNumeric(cd_cst.fis_nfitemsvc, 3, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Codigo fiscal de operacao e prestacao.
				call convNumeric(cd_cfop.fis_nfitemsvc, 4, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Codigo da natureza da operacao.
				vStringAux = "|%%cd_cfop.fis_nfitemsvc"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				
				;ICMS.
				;;ICJ [PROJ/TAR 170/118] (07/11/2010)		
; rodrigo - comentado IF - PRJ 170 TAR 217 - 30/03/2011
;				if ($item("IN_GERAR_STDEV_OBS",$xlplemp$) = 1) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (IN_ZEROU.FIS_NFSVC = <TRUE>)
;					vNumericAux = 0
;				else
				;;
					clear/e "FIS_NFITEMIMPSVC"
					CD_EMPFAT.fis_nfitemimpsvc/init  = CD_EMPFAT.fis_nfitemsvc
					nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
					dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
					nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
					cd_imposto.fis_nfitemimpsvc/init = 1
					retrieve/e "FIS_NFITEMIMPSVC"
					if ($status < 0)
						clear/e "FIS_NFITEMIMPSVC"
					else
						;-- MAD [Proj/Tar.170/286] - 07/06/2011
						if (vInSomou = <FALSE>)
							clear/e "FIS_NFIMPOSTOSVC"
							cd_empfat.fis_nfimpostosvc/init  = cd_empfat.fis_nfitemsvc
							nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfitemsvc
							dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfitemsvc
							cd_imposto.fis_nfimpostosvc/init = 1
							retrieve/e "FIS_NFIMPOSTOSVC"
							if ($status < 0)
								vInSomou = <TRUE>
							else
								if (pr_aliquota.fis_nfitemimpsvc = pr_aliquota.fis_nfimpostosvc) | ($next(nr_item.fis_nfitemsvc) = "")
									vl_basecalc.fis_nfitemimpsvc = vl_basecalc.fis_nfitemimpsvc + vl_basecalc.fis_nfimpostosvc
										vl_imposto.fis_nfitemimpsvc  = vl_imposto.fis_nfitemimpsvc  + vl_imposto.fis_nfimpostosvc
									vInSomou = <TRUE>
								endif
							endif
						endif
						;;
					endif
	
					;-- MAD [Proj/Tar.170/117] - 22/11/2010
					if (TP_OPERACAO.FIS_NFSVC = "S") & ($item("IN_INFORMA_BCICMS_OUT",$xlplemp$) = 1) & ($item("UF_ORIGEM",$xlplemp$) = "CE") & %\
					   (($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4))
	
						vl_outro.fis_nfitemimpsvc    = vl_outro.fis_nfitemimpsvc + vl_basecalc.fis_nfitemimpsvc
						vl_basecalc.fis_nfitemimpsvc = 0
						vl_imposto.fis_nfitemimpsvc  = 0
						pr_aliquota.fis_nfitemimpsvc = 0
					endif
					;;		

					;->RIM [170/555] - 21/09/2012
					if($inCalcImpdevSn$) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (TP_ORIGEMEMISSAO.FIS_NFSVC = 1) & ($inOptSimples$ = "S") & (IN_ZEROU.FIS_NFSVC = <TRUE>)
						vl_outro.fis_nfitemimpsvc    = vl_outro.fis_nfitemimpsvc + vl_basecalc.fis_nfitemimpsvc
						vl_basecalc.fis_nfitemimpsvc = 0
						vl_imposto.fis_nfitemimpsvc  = 0
						pr_aliquota.fis_nfitemimpsvc = 0
					endif	
					;<-	

					;Valor da base de calculo do ICMS.
						vNumericAux = vl_basecalc.fis_nfitemimpsvc
						vNumericAux = vNumericAux[round,2]
					;-- MAD [Proj/Tar.170/160] - 04/01/2011
					if (vNumericAux > 0 & vNumericAux > vDifBaseIcms)
						vNumericAux  = vNumericAux - vDifBaseIcms
						vDifBaseIcms = 0
					endif
					;;
;				endif
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Aliquota do ICMS.
				if (pr_aliquota.fis_nfitemimpsvc > 0)
					$vlAux$ = pr_aliquota.fis_nfitemimpsvc
					vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
				else
					$vlAux$ = 0
					vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
				endif

				;Valor do ICMS.
				;;ICJ [PROJ/TAR 170/118] (07/11/2010)		
; rodrigo - comentado IF - PRJ 170 TAR 217 - 30/03/2011
;				if ($item("IN_GERAR_STDEV_OBS",$xlplemp$) = 1) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (IN_ZEROU.FIS_NFSVC = <TRUE>)
;					vNumericAux = 0
;				else
				;;	
					vNumericAux = vl_imposto.fis_nfitemimpsvc + vVlIcms
					vNumericAux = vNumericAux[round,2]
	
					;-- MAD [Proj/Tar.170/160] - 04/01/2011
					if (vNumericAux > 0 & vNumericAux > vDifIcms)
						vNumericAux = vNumericAux - vDifIcms
						vDifIcms    = 0
					endif
					;;
;				endif
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				vVlBaseIcms = ""
				vVlIcms     = ""
				
				;;ICJ [PROJ/TAR 170/118] (07/11/2010)		
				if ($item("IN_GERAR_STDEV_OBS",$xlplemp$) = 1) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (IN_ZEROU.FIS_NFSVC = <TRUE>)
;					vNumericAux = 0
					vDsConteudo = "%%vDsConteudo%%%|0,00"
					vDsConteudo = "%%vDsConteudo%%%|0,00"
				else
				;;
					;ICMS com substituicao tributaria.
					clear/e "FIS_NFITEMIMPSVC"
					CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
					nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
					dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
					nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
					cd_imposto.fis_nfitemimpsvc/init = 2
					retrieve/e "FIS_NFITEMIMPSVC"
					if ($status < 0)
						clear/e "FIS_NFITEMIMPSVC"
					endif
			
					;Valor da base de calculo referente a substituicao tributaria.
					vNumericAux = vl_basecalc.fis_nfitemimpsvc
					vNumericAux = vNumericAux[round,2]
					;-- MAD [Proj/Tar.170/160] - 04/01/2011
					if (vNumericAux > 0 & vNumericAux > vDifBaseST)
						vNumericAux = vNumericAux - vDifBaseST
						vDifBaseST  = 0
					endif
					;;
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Aliquota do ICMS da substituicao tributaria na unidade da federacao de destino.
					if (pr_aliquota.fis_nfitemimpsvc > 0)
						$vlAux$ = pr_aliquota.fis_nfitemimpsvc
						vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
					else
						vStringAux 	= "|"
						vDsConteudo 	= "%%vDsConteudo%%vStringAux"
					endif
					;Va	lor do ICMS referente a substituicao tributaria.
				endif
	
				;;ICJ [PROJ/TAR 170/118] (07/11/2010)		
				if ($item("IN_GERAR_STDEV_OBS",$xlplemp$) = 1) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (IN_ZEROU.FIS_NFSVC = <TRUE>)
					vNumericAux = 0
				else
				;;
					vNumericAux = vl_imposto.fis_nfitemimpsvc
					vNumericAux = vNumericAux[round,2]
					;-- MAD [Proj/Tar.170/160] - 04/01/2011
					if (vNumericAux > 0 & vNumericAux > vDifST)
						vNumericAux = vNumericAux - vDifST
						vDifST      = 0
					endif
					;;
				endif
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Indicador de periodo de apuracao do IPI.
				vStringAux = "|0"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				
				;IPI.
				clear/e "FIS_NFITEMIMPSVC"
				CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
				nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
				dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
				nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
				cd_imposto.fis_nfitemimpsvc/init = 3
				retrieve/e "FIS_NFITEMIMPSVC"
				if ($status < 0)
					clear/e "FIS_NFITEMIMPSVC"
				endif
				
				;Codigo de tributacao do IPI creditado/debitada.
				if ($empty("FIS_NFITEMIMPSVC"))
					vStringAux = "|"
				else
					vCtIpi = ""

					; Ranghetti - 170/521 - 14/08/2012 ->
					if(CD_CST.FIS_NFITEMIMPSVC != "")
						vCtIpi = CD_CST.FIS_NFITEMIMPSVC
					else ;<-

						if (tp_operacao.fis_nfsvc = "E")
							;Entrada.
							if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4)
								if (vl_imposto.fis_nfitemimpsvc > 0)
									vCtIpi = "00" ;Entrada com recuperação de crédito
								elseif (vl_basecalc.fis_nfitemimpsvc > 0) & %\
									((vl_imposto.fis_nfitemimpsvc = "") | (vl_imposto.fis_nfitemimpsvc = 0)) & %\
									((pr_aliquota.fis_nfitemimpsvc = "") | (pr_aliquota.fis_nfitemimpsvc = 0))
								
									vCtIpi = "01" ;Entrada tributada com alíquota zero
								elseif (vl_isento.fis_nfitemimpsvc > 0)
									vCtIpi = "02" ;Entrada isenta, quando tiver valor no campo de isento
								elseif (vl_imposto.fis_nfitemimpsvc = "") | (vl_imposto.fis_nfitemimpsvc = 0)
									vCtIpi = "05" ;Entrada com suspensão
								endif
							endif
							if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 2) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 3)
								vCtIpi = "49" ;Outras entradas
							endif
						else
							;Saida.
							if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4)
								if (vl_imposto.fis_nfitemimpsvc > 0)
									vCtIpi = "50" ;Saída tributada
								elseif (vl_basecalc.fis_nfitemimpsvc > 0) & %\
									((vl_imposto.fis_nfitemimpsvc = "") | (vl_imposto.fis_nfitemimpsvc = 0)) & %\
									((pr_aliquota.fis_nfitemimpsvc = "") | (pr_aliquota.fis_nfitemimpsvc = 0))
									vCtIpi = "51" ;Saída tributada com alíquota zero
								elseif (vl_isento.fis_nfitemimpsvc > 0)
									vCtIpi = "52" ;Saída isenta
								elseif (vl_imposto.fis_nfitemimpsvc = "") | (vl_imposto.fis_nfitemimpsvc = 0)
									vCtIpi = "55" ;Saída com suspensão
								endif
							endif
							if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 2) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 3)
								vCtIpi = "99" ;Outas saídas
							endif
						endif

				endif ; 170/521

					vStringAux = "|%%vCtIpi"
				endif
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Codigo de enquadramento legal do IPI.
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Valor da base de calculo do IPI.
				vNumericAux = vl_basecalc.fis_nfitemimpsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Aliquota do IPI.
				if (pr_aliquota.fis_nfitemimpsvc > 0)
					$vlAux$ = pr_aliquota.fis_nfitemimpsvc
					vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
				else
					vStringAux = "|"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
				endif
				;Valor do IPI.
				vNumericAux = vl_imposto.fis_nfitemimpsvc
				vNumericAux = vNumericAux[round,2]
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				
				;PIS.
				clear/e "FIS_NFITEMIMPSVC"
				CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
				nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
				dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
				nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
				cd_imposto.fis_nfitemimpsvc/init = 6
				retrieve/e "FIS_NFITEMIMPSVC"
				if ($status < 0)
					clear/e "FIS_NFITEMIMPSVC"
				endif
				
				;Codigo de situacao tributaria referente ao PIS.
				if(CD_CST.FIS_NFITEMIMPSVC != "") ; rodrigo - prj 189 tar 161 - 08/06/2012
					; -> rodrigo - prj 170 tar 491 - 02/07/2012
					; vStringAux	= "|%%CD_CST.FIS_NFITEMIMPSVC"
					length CD_CST.FIS_NFITEMIMPSVC
					if($result = 1)
						vStringAux	= "|0%%CD_CST.FIS_NFITEMIMPSVC"
					else
						vStringAux	= "|%%CD_CST.FIS_NFITEMIMPSVC"
					endif
					; <- rodrigo - prj 170 tar 491 - 02/07/2012
				elseif (pr_aliquota.fis_nfitemimpsvc > 0)
					vStringAux = "|01"
				else
					vStringAux = "|06"
				endif
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Valor da base de calculo do PIS.
				vNumericAux = vl_basecalc.fis_nfitemimpsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Aliquota do PIS.
				if (pr_aliquota.fis_nfitemimpsvc > 0)
					$vlAux$ = pr_aliquota.fis_nfitemimpsvc
					vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
				else
					vStringAux = "|"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
				endif
				;Qu	antidade - Base de calculo PIS.
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Aliquota do PIS (em reais).
				if (pr_aliquota.fis_nfitemimpsvc > 0)
					$vlAux$ = pr_aliquota.fis_nfitemimpsvc
					vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
				else
					vStringAux = "|"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
				endif
				;Valor do PIS.
				vNumericAux = vl_imposto.fis_nfitemimpsvc
				vNumericAux = vNumericAux[round,2]
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				
				;COFINS.
  				clear/e "FIS_NFITEMIMPSVC"
				CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
				nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
				dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
				nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
				cd_imposto.fis_nfitemimpsvc/init = 5
				retrieve/e "FIS_NFITEMIMPSVC"
				if ($status < 0)
					clear/e "FIS_NFITEMIMPSVC"
				endif

				;Codigo de situacao tributaria referente ao COFINS.
				if(CD_CST.FIS_NFITEMIMPSVC != "") ; rodrigo - prj 189 tar 161 - 08/06/2012
					; -> rodrigo - prj 170 tar 491 - 02/07/2012
					; vStringAux	= "|%%CD_CST.FIS_NFITEMIMPSVC"
					length CD_CST.FIS_NFITEMIMPSVC
					if($result = 1)
						vStringAux	= "|0%%CD_CST.FIS_NFITEMIMPSVC"
					else
						vStringAux	= "|%%CD_CST.FIS_NFITEMIMPSVC"
					endif
					; <- rodrigo - prj 170 tar 491 - 02/07/2012
				elseif (pr_aliquota.fis_nfitemimpsvc > 0)
					vStringAux = "|01"
				else
					vStringAux = "|06"
				endif
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Valor da base de calculo da COFINS.
				vNumericAux = vl_basecalc.fis_nfitemimpsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
	 			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Aliquota da COFINS (em percentual).
				if (pr_aliquota.fis_nfitemimpsvc > 0)
					$vlAux$ = pr_aliquota.fis_nfitemimpsvc
					vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
				else
					vStringAux = "|"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
				endif
				;Quantidade - Base de calculo COFINS.
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Aliquota da COFINS (em reais).
				if (pr_aliquota.fis_nfitemimpsvc > 0)
					$vlAux$ = pr_aliquota.fis_nfitemimpsvc
					vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
				else
					vStringAux = "|"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
				endif
				;Valor da COFINS.
				vNumericAux = vl_imposto.fis_nfitemimpsvc
				vNumericAux = vNumericAux[round,2]
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Codigo da conta analitica contabil debitada/creditada.
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"
			
				;filedump/append vDsConteudo, ds_path.sis_filtro
				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "C170"
				ds_registro.sis_arquivosvc = vDsConteudo
			
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
			
				$instancehandle->totalizarQtdTipoRegistro("C170")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				;-- MAD [Proj/Tar.061/526] - 18/12/2008
				;ISS.
				if (TP_OPERACAO.FIS_NFSVC = "S")
					clear/e "FIS_NFITEMIMPSVC"
					cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
					nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
					dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
					nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
					cd_imposto.fis_nfitemimpsvc/init = 4
					retrieve/e "FIS_NFITEMIMPSVC"
					if ($status < 0)
						clear/e "FIS_NFITEMIMPSVC"
					else
						$instancehandle->gerarEFDBlocoCRegC172($xCdErro$, $xCtxErro$)
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif
					endif
				endif
				;;	
			endif
		endif	
		discard "FIS_NFITEMSVC"
		if ($status = 0)
			$status = -1
		endif
	endwhile
		
	return(0)
End ;operation gerarEFDBlocoCRegC170.

;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC172              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux
		string  vNumericAux
	endvariables
		
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C172 / %%cd_produto.fis_nfitemsvc", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|C172"
	
	;Base do ISS            
	vNumericAux = vl_basecalc.fis_nfitemimpsvc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	
	;Aliquota do ISS.
	if (pr_aliquota.fis_nfitemimpsvc > 0)
		$vlAux$ = pr_aliquota.fis_nfitemimpsvc
		vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
	else
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
	endif
	
	;Valor do ISS.
	vNumericAux = vl_imposto.fis_nfitemimpsvc
	vNumericAux = vNumericAux[round,2]
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "C172"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("C172")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	return(0)
	
End ;operation gerarEFDBlocoCRegC172

;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC190              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdCST
		boolean vInGerou, vInVlOutro, vInGerar, vInZerouImp1
		numeric vQtParcela, vVlAdicional, vVlIcms, vCount, vAliq
		string  vNumericAux
	endvariables
		
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C190", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif

	clear/e "V_FIS_APURACASVC"
	CD_EMPFAT.v_fis_apuracasvc/init        = CD_EMPFAT.fis_nfsvc
	nr_fatura.v_fis_apuracasvc/init        = nr_fatura.fis_nfsvc
	dt_fatura.v_fis_apuracasvc/init        = dt_fatura.fis_nfsvc
	;    cd_empfat.v_fis_apuracasvc/init        = cd_empfat.fis_nfsvc
	;    tp_situacao.v_fis_apuracasvc/init      = tp_situacao.fis_nfsvc
	;    cd_pessoa.v_fis_apuracasvc/init        = cd_pessoa.fis_nfsvc
	;    nr_nf.v_fis_apuracasvc/init            = nr_nf.fis_nfsvc
	;    cd_serie.v_fis_apuracasvc/init         = cd_serie.fis_nfsvc

	;SANDRA/CFC PRJ/TRF 175/219 10/08/2011 - Inserida a lógica abaixo devido a validação do parametro, 
											;só poderá ser validado para as notas de saídas.
	if ($inConsideraDtEmisNfSai$ = <TRUE>) & (tp_operacao.fis_nfsvc = "S")
		dt_emissao.v_fis_apuracasvc/init       = dt_emissao.fis_nfsvc
	else
		dt_saidaentrada.v_fis_apuracasvc/init  = dt_saidaentrada.fis_nfsvc
	endif

	;tp_operacao.v_fis_apuracasvc/init      = tp_operacao.fis_nfsvc
	;tp_origememissao.v_fis_apuracasvc/init = tp_origememissao.fis_nfsvc
	cd_imposto.v_fis_apuracasvc/init       = "1·;2·;3" ;1-ICMS / 2-SUBST. TRIBUTARIA / 3-IPI.
	tp_situacao.v_fis_apuracasvc/init      = "E"
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", -1
		sort/e "V_FIS_APURACASVC", "cd_imposto.v_fis_apuracasvc"
		setocc "V_FIS_APURACASVC", 1
		;vInGerou = <FALSE>
		vCount = 0
		while ($status >= 0)
			;;ICJ [PROJ/TAR 170/419] (20/04/2012)	
			vInGerar = <TRUE>
			if (CD_CFOP.V_FIS_APURACASVC = 1605)
				vInGerar = <FALSE>
			endif
			if ($tpApurIcms$ = 2)
				if  (CD_CFOP.V_FIS_APURACASVC = 1601) |  %\
			 		(CD_CFOP.V_FIS_APURACASVC = 1602) |  %\	
					(CD_CFOP.V_FIS_APURACASVC = 5601) |  %\
					(CD_CFOP.V_FIS_APURACASVC = 5602) |  %\
					(CD_CFOP.V_FIS_APURACASVC = 5605)
					vInGerar = <FALSE>
				endif
			endif
			if (vInGerar = <TRUE>)
			;;						
				;-- MAD [Proj/Tar.170/117] - 22/11/2010
				vInVlOutro = <FALSE>
				if (tp_operacao.v_fis_apuracasvc = "S") & ($item("IN_INFORMA_BCICMS_OUT",$xlplemp$) = 1) & ($item("UF_ORIGEM",$xlplemp$) = "CE") & %\
				   (($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4))
					
					if (cd_imposto.v_fis_apuracasvc = 1)
						vInVlOutro = <TRUE>
						vl_outro.v_fis_apuracasvc    = vl_outro.v_fis_apuracasvc + vl_basecalc.v_fis_apuracasvc
						vl_basecalc.v_fis_apuracasvc = 0
						vl_imposto.v_fis_apuracasvc  = 0
						pr_aliquota.v_fis_apuracasvc = 0

						vStringAux = cd_cst.v_fis_apuracasvc[1,1]
						vCdCST     = cd_cst.v_fis_apuracasvc[2,3]
						if (vCdCST = "00")
							vCdCST = "90"
							cd_cst.v_fis_apuracasvc = "%%vStringAux%%vCdCST"
						endif
					endif
				endif
				;;



				;if (CD_CFOP.V_FIS_APURACASVC != 5605) & (CD_CFOP.V_FIS_APURACASVC !=1605); Comentado ;-- MAD [Proj/Tar.189/176] - 25/07/2012
					;CFC: 27/04/2010 - Criado a lógica abaixo para verificar se tem o imposto 1, isto para acumular corretamente o imposto 2
					selectdb count(cd_imposto) from "f_v_fis_apurasvc" %\
							u_where (cd_empresa.f_v_fis_apurasvc = cd_empresa.v_fis_apuracasvc & %\
								      nr_fatura.f_v_fis_apurasvc  = nr_fatura.v_fis_apuracasvc  & %\
									   dt_fatura.f_v_fis_apurasvc  = dt_fatura.v_fis_apuracasvc  & %\
									   cd_cfop.f_v_fis_apurasvc    = cd_cfop.v_fis_apuracasvc    & %\
									   cd_imposto.f_v_fis_apurasvc = 1) to vcount
					;	
					; @>-/-- Virginia - 111/1776 - Brascol - verificar também a aliquota do imposto 1 e o total liquido
					selectdb pr_aliquota from "f_v_fis_apurasvc" %\
							u_where (cd_empresa.f_v_fis_apurasvc = cd_empresa.v_fis_apuracasvc & %\
							     nr_fatura.f_v_fis_apurasvc  = nr_fatura.v_fis_apuracasvc  & %\
								 dt_fatura.f_v_fis_apurasvc  = dt_fatura.v_fis_apuracasvc  & %\
								 cd_cfop.f_v_fis_apurasvc    = cd_cfop.v_fis_apuracasvc    & %\
								 vl_totalliquido.f_v_fis_apurasvc    = vl_totalliquido.v_fis_apuracasvc    & %\
								 cd_imposto.f_v_fis_apurasvc = 1) to vAliq
	
					;->RIM [170/555] - 21/09/2012
					if($inCalcImpdevSn$) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (TP_ORIGEMEMISSAO.FIS_NFSVC = 1) & ($inOptSimples$ = "S") & (IN_ZEROU.FIS_NFSVC = <TRUE>)  
						vAliq = 0
						if (cd_imposto.v_fis_apuracasvc = 1)
							vl_basecalc.v_fis_apuracasvc = 0
							vl_imposto.v_fis_apuracasvc  = 0
							pr_aliquota.v_fis_apuracasvc = 0
	
							vStringAux = cd_cst.v_fis_apuracasvc[1,1]
							vCdCST     = cd_cst.v_fis_apuracasvc[2,3]
						endif
					endif
					;<-	

					if (cd_imposto.v_fis_apuracasvc = 1)
						;vInGerou = <TRUE> CFC: 27/04/2010
						creocc "TMP_K03NR2VL1SVC", -1
						nr_k01.tmp_k03nr2vl1svc = cd_cst.v_fis_apuracasvc
						nr_k02.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
						vl_k03.tmp_k03nr2vl1svc = pr_aliquota.v_fis_apuracasvc
						retrieve/o "TMP_K03NR2VL1SVC"
						if ($status = 4)
							retrieve/x "TMP_K03NR2VL1SVC"
						endif
					;el	seif (cd_imposto.v_fis_apuracasvc = 2 & vInGerou = <FALSE>)  CFC: 27/04/2010
					elseif (cd_imposto.v_fis_apuracasvc = 2) & (vCount = 0)
						;vInGerou = <TRUE>
						creocc "TMP_K03NR2VL1SVC", -1
						nr_k01.tmp_k03nr2vl1svc = cd_cst.v_fis_apuracasvc
						nr_k02.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
						vl_k03.tmp_k03nr2vl1svc = pr_aliquota.v_fis_apuracasvc
						retrieve/o "TMP_K03NR2VL1SVC"
						if ($status = 4)
							retrieve/x "TMP_K03NR2VL1SVC"
						endif
					; se já gerou para imposto 1 só posiciona	
					elseif ((cd_imposto.v_fis_apuracasvc = 2) | (cd_imposto.v_fis_apuracasvc = 3)) & (vCount > 0) 
						creocc "TMP_K03NR2VL1SVC", -1
						nr_k01.tmp_k03nr2vl1svc = cd_cst.v_fis_apuracasvc
						nr_k02.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
						vl_k03.tmp_k03nr2vl1svc = vAliq
						retrieve/o "TMP_K03NR2VL1SVC"
						if ($status = 4)
							retrieve/x "TMP_K03NR2VL1SVC"
						endif
					endif
					; --\-<@				
					if (cd_imposto.v_fis_apuracasvc = 1)
		
						vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_totalliquido.v_fis_apuracasvc
						vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.v_fis_apuracasvc
						vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.v_fis_apuracasvc
						;-- MAD [Proj/Tar.170/117] - 22/11/2010
		
						if (vInVlOutro = <TRUE>)
							vl_outroicms.tmp_k03nr2vl1svc = vl_outroicms.tmp_k03nr2vl1svc + vl_outro.v_fis_apuracasvc
						else
						;;
							;CFC: 27/04/2010 - Incluido a rotina a pedido do Renan
							if (cd_cst.v_fis_apuracasvc = "020") | (cd_cst.v_fis_apuracasvc = "070")
								if (vl_isento.v_fis_apuracasvc > 0)
									vl_outroicms.tmp_k03nr2vl1svc = vl_outroicms.tmp_k03nr2vl1svc + vl_isento.v_fis_apuracasvc
								else
									vl_outroicms.tmp_k03nr2vl1svc = vl_outroicms.tmp_k03nr2vl1svc + vl_outro.v_fis_apuracasvc
								endif
							endif
						endif
					endif
					if (cd_imposto.v_fis_apuracasvc = 2)
						; CFC: 28/04/2010 - Acumular o vl. total liquido em caso de tiver apenas o imposto 2
						if (vCount = 0)
							vl_contabil.tmp_k03nr2vl1svc  = vl_contabil.tmp_k03nr2vl1svc      + vl_totalliquido.v_fis_apuracasvc
						else
							vl_contabil.tmp_k03nr2vl1svc  = vl_contabil.tmp_k03nr2vl1svc      + vl_imposto.v_fis_apuracasvc
						endif
						vl_baseicmssubst.tmp_k03nr2vl1svc = vl_baseicmssubst.tmp_k03nr2vl1svc + vl_basecalc.v_fis_apuracasvc
						vl_icmssubst.tmp_k03nr2vl1svc     = vl_icmssubst.tmp_k03nr2vl1svc     + vl_imposto.v_fis_apuracasvc
					endif
					if (cd_imposto.v_fis_apuracasvc = 3)
						vl_contabil.tmp_k03nr2vl1svc      = vl_contabil.tmp_k03nr2vl1svc      + vl_imposto.v_fis_apuracasvc
						vl_ipi.tmp_k03nr2vl1svc           = vl_ipi.tmp_k03nr2vl1svc           + vl_imposto.v_fis_apuracasvc
					endif
				;endif
			endif
			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
	
		if ($next(nr_nf.fis_nfsvc)           != nr_nf.fis_nfsvc)     | %\
		   ($next(cd_pessoa.fis_nfsvc)       != cd_pessoa.fis_nfsvc) | %\
		   ($next(dt_saidaentrada.fis_nfsvc) != dt_saidaentrada.fis_nfsvc)
			;; ICJ [PROJ/TAR 61/868] (21/09/2010)
			;vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_despacessor.fis_nfsvc + vl_frete.fis_nfsvc + vl_seguro.fis_nfsvc + vl_ipi.fis_nfsvc
			vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_despacessor.fis_nfsvc + vl_frete.fis_nfsvc + vl_seguro.fis_nfsvc
			;;

			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 1 ;ICMS.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status >= 0)
				setocc "FIS_NFIMPOSTOSVC", 1
				while ($status >= 0)

					;-- MAD [Proj/Tar.170/117] - 22/11/2010
					if (TP_OPERACAO.FIS_NFSVC = "S") & ($item("IN_INFORMA_BCICMS_OUT",$xlplemp$) = 1) & ($item("UF_ORIGEM",$xlplemp$) = "CE") & %\
					   (($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4))

						vl_outro.fis_nfimpostosvc    = vl_outro.fis_nfimpostosvc + vl_basecalc.fis_nfimpostosvc
						vl_basecalc.fis_nfimpostosvc = 0
						vl_imposto.fis_nfimpostosvc  = 0
						pr_aliquota.fis_nfimpostosvc = 0
					endif
					;;
					;->RIM [170/555] - 21/09/2012
					if($inCalcImpdevSn$) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (TP_ORIGEMEMISSAO.FIS_NFSVC = 1) & ($inOptSimples$ = "S") & (IN_ZEROU.FIS_NFSVC = <TRUE>)
						vl_basecalc.fis_nfimpostosvc = 0
						vl_imposto.fis_nfimpostosvc  = 0
						pr_aliquota.fis_nfimpostosvc = 0
					endif
					;<-


					;-- MAD [Proj/Tar.170/286] - 07/06/2011
					;vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.fis_nfimpostosvc
					;vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.fis_nfimpostosvc

					setocc "TMP_K03NR2VL1SVC", 1
					while ($status >= 0)
						if (vl_k03.tmp_k03nr2vl1svc = pr_aliquota.fis_nfimpostosvc) | ($next(vl_k03.tmp_k03nr2vl1svc) = "")
							vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.fis_nfimpostosvc
							vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.fis_nfimpostosvc
							break
						endif
						setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
					endwhile
					;;					
					setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
				endwhile
			endif

			;; ICJ [PROJ/TAR 61/868] (21/09/2010)
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 2 ;ICMS Subst Tributária.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status >= 0)
				setocc "FIS_NFIMPOSTOSVC", 1
				while ($status >= 0)
					vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_imposto.fis_nfimpostosvc
					setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
				endwhile
			endif
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 3 ;IPI
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status >= 0)
				setocc "FIS_NFIMPOSTOSVC", 1
				while ($status >= 0)
					vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_imposto.fis_nfimpostosvc
					vl_baseipi.tmp_k03nr2vl1svc = vl_baseipi.tmp_k03nr2vl1svc + vl_basecalc.fis_nfimpostosvc
					vl_ipi.tmp_k03nr2vl1svc     = vl_ipi.tmp_k03nr2vl1svc     + vl_imposto.fis_nfimpostosvc

					setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
				endwhile
			endif
			;;
		endif
	endif

	clear/e "V_FIS_APURACASVC"

	if ($empty("TMP_K03NR2VL1SVC"))
		return(0)
	endif
setocc "TMP_K03NR2VL1SVC", 1
while ($status >= 0)
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|C190"
	;Codigo da situacao tributaria.
	call convNumeric(nr_k01.tmp_k03nr2vl1svc, 3, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Codigo fiscal de operacao e prestacao.
	call convNumeric(nr_k02.tmp_k03nr2vl1svc, 4, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Aliquota do ICMS.
	if (vl_k03.tmp_k03nr2vl1svc > 0) & (nr_k01.tmp_k03nr2vl1svc != 60)
		$vlAux$ = vl_k03.tmp_k03nr2vl1svc
		vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
	else
		;vStringAux = "|"
		$vlAux$ = 0
		vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
	endif
	;Parcela correspondente ao valor contabil referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_contabil.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	;;ICJ [PROJ/TAR 170/118] (07/11/2010)
; rodrigo - comentado IF - PRJ 170 TAR 217 - 30/03/2011
;	if ($item("IN_GERAR_STDEV_OBS",$xlplemp$) = 1) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (IN_ZEROU.FIS_NFSVC = <TRUE>)
;		vl_baseicms.tmp_k03nr2vl1svc = 0
;		vNumericAux = 0
;	else
	;;
	vNumericAux = vl_baseicms.tmp_k03nr2vl1svc
;	endif
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	;;ICJ [PROJ/TAR 170/118] (07/11/2010)		
; rodrigo - comentado IF - PRJ 170 TAR 217 - 30/03/2011
;	if ($item("IN_GERAR_STDEV_OBS",$xlplemp$) = 1) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (IN_ZEROU.FIS_NFSVC = <TRUE>)
;
;		vl_icms.tmp_k03nr2vl1svc = 0
;		vNumericAux = 0 
;	else
	;;
	vNumericAux = vl_icms.tmp_k03nr2vl1svc
;	endif
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor da base de calculo do ICMS da substituicao tributaria referente a combinacao CFOP, CST e aliquota de ICMS.
	;;ICJ [PROJ/TAR 170/118] (07/11/2010)		
	if ($item("IN_GERAR_STDEV_OBS",$xlplemp$) = 1) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (IN_ZEROU.FIS_NFSVC = <TRUE>)

		vl_baseicmssubst.tmp_k03nr2vl1svc = 09
		vNumericAux = 0 
	else
	;;
		vNumericAux = vl_baseicmssubst.tmp_k03nr2vl1svc
	endif
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor do ICMS da substituicao tributaria referente a combinacao CFOP, CST e aliquota de ICMS.
	;;ICJ [PROJ/TAR 170/118] (07/11/2010)		
	if ($item("IN_GERAR_STDEV_OBS",$xlplemp$) = 1) & (TP_MODALIDADE.GER_OPERACAOSVC = 3) & (IN_ZEROU.FIS_NFSVC = <TRUE>)

		vl_icmssubst.tmp_k03nr2vl1svc = 0
		vNumericAux = 0 
	else
	;;
		vNumericAux = vl_icmssubst.tmp_k03nr2vl1svc
	endif
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor nao tributado em funcao da reducao da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_outroicms.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor do IPI referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_ipi.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	
	; @>-/-- Virginia - PRJ 061 TAR 743 - 02/02/10
	; Código da observação do lançamento fiscal - CD_OBS a ser criado
	vStringAux = ""
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	; --\-<@
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "C190"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("C190")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
endwhile
clear/e "TMP_K03NR2VL1SVC"

return(0)
End ;operation gerarEFDBlocoCRegC190.


;----------------------------------------------------------;
partner operation gerarEFDBlocoCRegC300                    ;
	;----------------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux
		string  vNumericAux
		date    vDtAux
	endvariables

	if ($item("TP_PERFIL",$parametro$) != "B") 
		return(0)
	endif

	clear/e "TMP_K03DSDTSVC"

	clear/e "FIS_NFSVC"
	cd_empfat.fis_nfsvc/init        = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init      = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	tp_situacao.fis_nfsvc/init      = "E·;C"
	tp_moddctofiscal.fis_nfsvc/init = 02
	tp_operacao.fis_nfsvc/init      = "S"
	retrieve/e "FIS_NFSVC"
	if ($status < 0)
		return(0)
	endif
	
	setocc "FIS_NFSVC", 1
	while ($status >= 0)
		
		creocc "TMP_K03DSDTSVC", -1
		dt_data.tmp_k03dsdtsvc   = dt_saidaentrada.fis_nfsvc
		ds_campo1.tmp_k03dsdtsvc = "%%cd_serie.fis_nfsvc"
		ds_campo2.tmp_k03dsdtsvc = "1"
		retrieve/o "TMP_K03DSDTSVC"
		if ($status = 4)
			retrieve/x "TMP_K03DSDTSVC"
		endif

		if (nr_nfini.tmp_k03dsdtsvc = "")
			nr_nfini.tmp_k03dsdtsvc = nr_nf.fis_nfsvc
		else
			if (nr_nf.fis_nfsvc < nr_nfini.tmp_k03dsdtsvc)
				nr_nfini.tmp_k03dsdtsvc = nr_nf.fis_nfsvc
			endif
		endif

		if (nr_nffim.tmp_k03dsdtsvc = "")
			nr_nffim.tmp_k03dsdtsvc = nr_nf.fis_nfsvc
		else
			if (nr_nf.fis_nfsvc > nr_nffim.tmp_k03dsdtsvc)
				nr_nffim.tmp_k03dsdtsvc = nr_nf.fis_nfsvc
			endif
		endif

		tp_moddctofiscal.tmp_k03dsdtsvc = tp_moddctofiscal.fis_nfsvc
		
		;;ICJ [PROJ/TAR 175/349](13/04/2012)
		if (TP_SITUACAO.FIS_NFSVC = "E")
		;;
			vl_total.tmp_k03dsdtsvc = vl_total.tmp_k03dsdtsvc + vl_totalnota.fis_nfsvc

			; Valor do Pis (capa/item)
			clear/e "FIS_NFIMPOSTOSVC"
			cd_empfat.fis_nfimpostosvc/init  = cd_empfat.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 6 
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status >= 0)
				vl_pis.tmp_k03dsdtsvc = vl_pis.tmp_k03dsdtsvc + vl_imposto.fis_nfimpostosvc
			endif
	
			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfitemimpsvc/init = 6
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status >= 0)
				setocc "FIS_NFITEMIMPSVC", 1
				while ($status >= 0)
					vl_pis.tmp_k03dsdtsvc = vl_pis.tmp_k03dsdtsvc + vl_imposto.fis_nfitemimpsvc
					setocc "FIS_NFITEMIMPSVC", $curocc("FIS_NFITEMIMPSVC") + 1
				endwhile
			endif

			; Valor do Cofins (capa/item)
			clear/e "FIS_NFIMPOSTOSVC"
			cd_empfat.fis_nfimpostosvc/init  = cd_empfat.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 5 
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status >= 0)
				vl_cofins.tmp_k03dsdtsvc = vl_cofins.tmp_k03dsdtsvc + vl_imposto.fis_nfimpostosvc
			endif

			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfitemimpsvc/init = 5
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status >= 0)
				setocc "FIS_NFITEMIMPSVC", 1
				while ($status >= 0)
					vl_cofins.tmp_k03dsdtsvc = vl_cofins.tmp_k03dsdtsvc + vl_imposto.fis_nfitemimpsvc
					setocc "FIS_NFITEMIMPSVC", $curocc("FIS_NFITEMIMPSVC") + 1
				endwhile
			endif
		endif
		discard "FIS_NFSVC"
		if ($status = 0)
			$status = -1
		endif
	endwhile

	if (!$empty("TMP_K03DSDTSVC"))
		setocc "TMP_K03DSDTSVC",-1
		sort/e "TMP_K03DSDTSVC","DT_DATA.TMP_K03DSDTSVC,DS_CAMPO1.TMP_K03DSDTSVC"
		setocc "TMP_K03DSDTSVC",1
		while ($status >= 0)

			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C300 / %%dt_data.tmp_k03dsdtsvc", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif

			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|C300"
			;Codigo do modelo do documento fiscal.
			vNumericAux = tp_moddctofiscal.tmp_k03dsdtsvc
			call convNumeric(vNumericAux, 2, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Serie do documento fiscal.
			vStringAux = "|%%ds_campo1.tmp_k03dsdtsvc"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Subserie do documento fiscal.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Numero do documento fiscal inicial.
			call retirarNaoNumerico(nr_nfini.tmp_k03dsdtsvc, vStringAux)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Numero do documento fiscal final.
			call retirarNaoNumerico(nr_nffim.tmp_k03dsdtsvc, vStringAux)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Data de emissao do documento fiscal.
			vDtAux = dt_data.tmp_k03dsdtsvc
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Valor total do documento fiscal.
			vNumericAux = vl_total.tmp_k03dsdtsvc
			vStringConv = ""
			;if (vNumericAux > 0) ;(Comentado);-- MAD [Proj/Tar.170/434] - 09/05/2012
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			;endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor total do PIS.		
			vNumericAux = vl_pis.tmp_k03dsdtsvc
			vStringConv = ""
			;if (vNumericAux > 0) ;(Comentado);-- MAD [Proj/Tar.170/434] - 09/05/2012
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			;endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor total do COFINS.	
			vStringConv = ""
			;if (vNumericAux > 0) ;(Comentado);-- MAD [Proj/Tar.170/434] - 09/05/2012
				vNumericAux = vl_cofins.tmp_k03dsdtsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			;endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da conta analitica contabil debitada/creditada.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C300"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("C300")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif

			;Notas fiscais canceladas
			$instancehandle->gerarEFDBlocoCRegC310($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
	
			;Registro analitico do resumo diario.
			if ($item("TP_PERFIL", $parametro$) != "C")
				$instancehandle->gerarEFDBlocoCRegC320($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
		
			setocc "TMP_K03DSDTSVC", $curocc("TMP_K03DSDTSVC") + 1
		endwhile
	endif

	clear/e "TMP_K03DSDTSVC"
	;;

	clear/e "FIS_NFSVC"

	return(0)
End ;operation gerarEFDBlocoCRegC300.

;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC320              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		numeric vQtParcela, vVlAdicional, vVlIcms
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C320", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif

	clear/e "TMP_K07NDD"
	clear/e "TMP_K03NR2VL1SVC"

	;-- MAD [Proj/Tar.170/094] - 26/10/2010
	;clear/e "V_FIS_APURACASVC"
	;CD_EMPFAT.v_fis_apuracasvc/init       = CD_EMPFAT.fis_nfsvc
	;nr_fatura.v_fis_apuracasvc/init        = nr_fatura.fis_nfsvc
	;dt_fatura.v_fis_apuracasvc/init        = dt_fatura.fis_nfsvc
	;cd_empfat.v_fis_apuracasvc/init        = cd_empfat.fis_nfsvc
	;tp_situacao.v_fis_apuracasvc/init      = tp_situacao.fis_nfsvc
	;cd_pessoa.v_fis_apuracasvc/init        = cd_pessoa.fis_nfsvc
	;nr_nf.v_fis_apuracasvc/init            = nr_nf.fis_nfsvc
	;cd_serie.v_fis_apuracasvc/init         = cd_serie.fis_nfsvc
	;dt_emissao.v_fis_apuracasvc/init       = dt_emissao.fis_nfsvc
	;dt_saidaentrada.v_fis_apuracasvc/init  = dt_saidaentrada.fis_nfsvc
	;tp_operacao.v_fis_apuracasvc/init      = tp_operacao.fis_nfsvc
	;tp_origememissao.v_fis_apuracasvc/init = tp_origememissao.fis_nfsvc
	;cd_imposto.v_fis_apuracasvc/init       = 1
	;tp_situacao.v_fis_apuracasvc/init      = "E"
	;retrieve/e "V_FIS_APURACASVC"

	clear/e "FIS_NFSVC"
	cd_empfat.fis_nfsvc/init        = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init      = dt_data.tmp_k03dsdtsvc
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init = dt_data.tmp_k03dsdtsvc
	endif
	;------//------//------
	tp_situacao.fis_nfsvc/init      = "E"
	tp_moddctofiscal.fis_nfsvc/init = 02
	tp_operacao.fis_nfsvc/init      = "S"
	nr_nf.fis_nfsvc/init            = "·>·=%%nr_nfini.tmp_k03dsdtsvc·&·<·=%%nr_nffim.tmp_k03dsdtsvc"
	cd_serie.fis_nfsvc/init         = "%%ds_campo1.tmp_k03dsdtsvc"
	retrieve/e "FIS_NFSVC"
	if ($status >= 0)
		setocc "FIS_NFSVC", 1
		while ($status >= 0)

			clear/e "V_FIS_APURACASVC"
			cd_empfat.v_fis_apuracasvc/init  = cd_empfat.fis_nfsvc
			nr_fatura.v_fis_apuracasvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.v_fis_apuracasvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.v_fis_apuracasvc/init = 1
			retrieve/e "V_FIS_APURACASVC"
	;;
			if ($status >= 0)
				setocc "V_FIS_APURACASVC", 1
				while ($status >= 0)		
					creocc "TMP_K03NR2VL1SVC", -1
					nr_k01.tmp_k03nr2vl1svc = cd_cst.v_fis_apuracasvc
					nr_k02.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
					vl_k03.tmp_k03nr2vl1svc = pr_aliquota.v_fis_apuracasvc
					retrieve/o "TMP_K03NR2VL1SVC"
					if ($status = 4)
						retrieve/x "TMP_K03NR2VL1SVC"
					endif
					vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_totalliquido.v_fis_apuracasvc
					vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.v_fis_apuracasvc
					vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.v_fis_apuracasvc

					;-- MAD [Proj/Tar.170/094] - 26/10/2010
					if ($item("TP_PERFIL", $parametro$) != "C")
						clear/e "FIS_NFITEMSVC"
						cd_empfat.fis_nfitemsvc/init = cd_empfat.fis_nfsvc
						nr_fatura.fis_nfitemsvc/init = nr_fatura.fis_nfsvc
						dt_fatura.fis_nfitemsvc/init = dt_fatura.fis_nfsvc
						retrieve/e "FIS_NFITEMSVC"

						;Itens do resumo diario dos documentos.
						$instancehandle->gerarEFDBlocoCRegC321(<FALSE>,$xCdErro$, $xCtxErro$)
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif
					endif
					;;	
					setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
				endwhile
		
				if ($next(nr_nf.fis_nfsvc)            != nr_nf.fis_nfsvc)     | %\
					($next(cd_pessoa.fis_nfsvc)       != cd_pessoa.fis_nfsvc) | %\
					($next(dt_saidaentrada.fis_nfsvc) != dt_saidaentrada.fis_nfsvc)
					vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_despacessor.fis_nfsvc + vl_frete.fis_nfsvc + vl_seguro.fis_nfsvc

					clear/e "FIS_NFIMPOSTOSVC"
					CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
					nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
					dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
					cd_imposto.fis_nfimpostosvc/init = 1 ;ICMS.
					retrieve/e "FIS_NFIMPOSTOSVC"
					if ($status >= 0)
						setocc "FIS_NFIMPOSTOSVC", 1
						while ($status >= 0)
							vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.fis_nfimpostosvc
							vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.fis_nfimpostosvc
				
							setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
						endwhile
					endif
				endif
			endif
			discard "FIS_NFSVC"
			if ($status = 0)
				$status = -1
			endif
		endwhile
	endif

	clear/e "V_FIS_APURACASVC"

	if ($empty("TMP_K03NR2VL1SVC"))
		return(0)
	endif
	sort/e "TMP_K07NDD","NR_CHAVE01.TMP_K07NDD,NR_CHAVE02.TMP_K07NDD,NR_CHAVE03.TMP_K07NDD,NR_CHAVE04.TMP_K07NDD"

setocc "TMP_K03NR2VL1SVC",-1
sort/e "TMP_K03NR2VL1SVC","NR_K01.TMP_K03NR2VL1SVC,NR_K02.TMP_K03NR2VL1SVC,VL_K03.TMP_K03NR2VL1SVC"
setocc "TMP_K03NR2VL1SVC", 1
while ($status >= 0)
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|C320"
	;Codigo da situacao tributaria.
	call convNumeric(nr_k01.tmp_k03nr2vl1svc, 3, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Codigo fiscal de operacao e prestacao.
	call convNumeric(nr_k02.tmp_k03nr2vl1svc, 4, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Aliquota do ICMS.
	if (vl_k03.tmp_k03nr2vl1svc > 0)
		$vlAux$ = vl_k03.tmp_k03nr2vl1svc
		vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
	else
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
	endif
	;Parcela correspondente ao valor contabil referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_contabil.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_baseicms.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_icms.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor nao tributado em funcao da reducao da base de calculo de ICMS.
	vNumericAux = 0
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Codigo da observacao do lancamento fiscal.
	vStringAux = "|"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "C320"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("C320")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	; @>-/-- Virginia - SM 32004 - 111/1563 - 30/09/2010
	;if (($item("TP_PERFIL", $parametro$) != "B") & ($item("TP_PERFIL", $parametro$) != "C"))
	if ($item("TP_PERFIL", $parametro$) != "C")
	; --\-<@
		
		;clear/e "FIS_NFITEMSVC"
		;CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
		;nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
		;dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
		;retrieve/e "FIS_NFITEMSVC"

		;Itens do resumo diario dos documentos.
		$instancehandle->gerarEFDBlocoCRegC321(<TRUE>,$xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	
	setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
endwhile
clear/e "TMP_K03NR2VL1SVC"
clear/e "TMP_K07NDD"

return(0)
End ;operation gerarEFDBlocoCRegC320.

;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC321              ;
;----------------------------------------------------
	params
		boolean piGeraReg :IN
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, viParams, voParams, vStrAux, vFisCfop, vFisTipi
		numeric vQtParcela, vVlBaseIcms, vVlIcms, vTotDig
		string  vNumericAux
	endvariables

	if (piGeraReg != <TRUE>)
		if ($empty("FIS_NFITEMSVC"))
			return(0)
		endif
	
		setocc "FIS_NFITEMSVC", 1
		while ($status >= 0)
		
			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C321 / %%cd_produto.fis_nfitemsvc", "", "")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			endif
			if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
				setocc "FIS_NFITEMPROSVC", 1
				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|C321"
				;Codigo do item.
				; @>-/-- Virginia - SC 36669 - 24/08/2011 - MAF
				;call convNumeric(cd_produto.fis_nfitemprosvc, 9, vStringConv)
				if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
;					vTotDig = $length(cd_produto.fis_nfitemsvc)
;					vTotDig = 14
;					call convNumeric(cd_produto.fis_nfitemsvc, vTotDig, vStringConv)
					vStringConv = cd_produto.fis_nfitemsvc
				else
;					vTotDig = $length(cd_produto.fis_nfitemprosvc)
;					;vTotDig = 14
;					call convNumeric(cd_produto.fis_nfitemprosvc, vTotDig, vStringConv)
					vStringConv = cd_produto.fis_nfitemprosvc
				endif
				; --\-<@ 
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
				creocc "F_TMP_DS40SVC", -1
				if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
					DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
				else
					DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
				endif

				if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
					clear/e "PRD_PRDCONVMESVC"
					CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
					retrieve/e "PRD_PRDCONVMESVC"
					if ($status >= 0)
						$instancehandle->totalizarQtdTipoRegistro("0220")
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							poCdErro  = $xCdErro$
							poCtxErro = $xCtxErro$
							return(-1)
						endif
					endif
				endif

				retrieve/o "F_TMP_DS40SVC"
				if ($status = 4)
					retrieve/x "F_TMP_DS40SVC"
					vCdEspecie = ds_especie.F_TMP_DS40SVC
				else
					ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
					ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
					vCdEspecie = cd_especie.fis_nfitemsvc
					if (cd_tipi.fis_nfitemsvc = "")
					
						if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
							;se for serviço não vai ter ncm
						else
							Clear/e "PRD_PRODUTOSVC"        
							cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
							retrieve/e "PRD_PRODUTOSVC"
							if ($status >= 0)
								if (CD_ESPECIE.FIS_NFITEMSVC = "")
									ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
									vCdEspecie = cd_especie.prd_produtosvc
								endif
								if (cd_tipi.prd_produtosvc != "")
									; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
									vFisTipi = ""
									viParams = ""
									voParams = ""
									putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
									activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
									if ($procerror)
										$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
										return(-1)
									elseif ($status < 0)
										$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
										return(-1)
									endif
									if (voParams != "")
										vFisTipi = voParams
										vStrAux = $item("CD_TIPI",vFisTipi)
										vStrAux = $replace(vStrAux, 1, ".","",-1)
										cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
									endif
									; --\-<@
								endif
							endif
						endif
					else
						cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
						cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
					endif
				
					creocc "TMP_NRDSSVC", -1
					nr_geral.tmp_nrdssvc = 1
					ds_geral.tmp_nrdssvc = vCdEspecie
					retrieve/o "TMP_NRDSSVC"
					if ($status = 4)
						retrieve/x "TMP_NRDSSVC"
					endif
				endif

				;-- MAD [Proj/Tar.170/263] - 27/05/2011
				if (DS_40.F_TMP_DS40SVC != "")
					clear/e "FIS_NFITEMUNSVC"
					CD_EMPRESA.FIS_NFITEMUNSVC/init = CD_EMPRESA.FIS_NFITEMSVC
					NR_FATURA.FIS_NFITEMUNSVC/init  = NR_FATURA.FIS_NFITEMSVC
					DT_FATURA.FIS_NFITEMUNSVC/init  = DT_FATURA.FIS_NFITEMSVC
					NR_ITEM.FIS_NFITEMUNSVC/init    = NR_ITEM.FIS_NFITEMSVC
					CD_PRODUTO.FIS_NFITEMUNSVC/init = DS_40.F_TMP_DS40SVC
					retrieve/e "FIS_NFITEMUNSVC"
					if ($status >= 0) & (CD_ESPECIE.FIS_NFITEMUNSVC != vCdEspecie)
						vCdEspecie = CD_ESPECIE.FIS_NFITEMUNSVC
	
						clear/e "GTT_DS01SVC"
						creocc "GTT_DS01SVC", -1
						NR_GERAL.GTT_DS01SVC = DS_40.F_TMP_DS40SVC
						DS_GERAL.GTT_DS01SVC = vCdEspecie
						retrieve/o "GTT_DS01SVC"
						if ($status = -7)
							retrieve/x "GTT_DS01SVC"
						endif
						QT_CONVERSAO.GTT_DS01SVC = QT_CONVERSAO.FIS_NFITEMUNSVC
						$collhandle("GTT_DS01SVC")->Salvar()
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif

						creocc "TMP_NRDSSVC", -1
						nr_geral.tmp_nrdssvc = 1
						ds_geral.tmp_nrdssvc = vCdEspecie
						retrieve/o "TMP_NRDSSVC"
						if ($status = 4)
							retrieve/x "TMP_NRDSSVC"
						endif

						creocc "TMP_DS40SVC", -1
						DS_40.TMP_DS40SVC = "0220"
						retrieve/o "TMP_DS40SVC"
						if ($status = -7)
							retrieve/x "TMP_DS40SVC"
						endif
					endif
				endif
				;;
		
; @>-/-- Virginia - SC 36690 - 24/08/2011 - MAF
;				creocc "TMP_NR08SVC", -1
;				nr_08.tmp_nr08svc = cd_cfop.fis_nfitemsvc
;				retrieve/o "TMP_NR08SVC"
;				if ($status = 4)
;					retrieve/x "TMP_NR08SVC"
;				else
;					; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
;					vFisCfop = ""
;					viParams = ""
;					voParams = ""
;					putitem/id viParams, "CD_CFOP", cd_cfop.fis_nfitemsvc
;					activate "FISSVCO032".carregaFisCfop($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
;					if ($procerror)
;						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;						return(-1)
;					elseif ($status < 0)
;						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;						return(-1)
;					endif
;					if (voParams != "")
;						vFisCfop = voParams
;						ds_cfop.tmp_nr08svc = $item("DS_CFOP",vFisCfop)
;					endif
;					; --\-<@            
;				endif
; --\-<@            

	;-- MAD [Proj/Tar.170/094] - 26/10/2010
	;			;Quantidade do item.
	;			vNumericAux = qt_faturado.fis_nfitemsvc
	;			call editarNr(11, 3, vNumericAux, vNumericAux)
	;			call convValorString(3,vNumericAux, vStringConv)
	;			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;			;Unidade do item.
	;			vStringAux = "|%%vCdEspecie"
	;			vDsConteudo = "%%vDsConteudo%%vStringAux"
	;			
	;			;Valor do item.
	;			vNumericAux = vl_totalliquido.fis_nfitemsvc
	;			call editarNr(12, 2, vNumericAux, vNumericAux)
	;			call convValorString(2,vNumericAux, vStringConv)
	;			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;			;Valor do desconto.
	;			vNumericAux = vl_totaldesc.fis_nfitemsvc
	;			call editarNr(12, 2, vNumericAux, vNumericAux)
	;			call convValorString(2,vNumericAux, vStringConv)
	;			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;			
	;			;ICMS.
	;			clear/e "FIS_NFITEMIMPSVC"
	;			CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
	;			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
	;			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
	;			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
	;			cd_imposto.fis_nfitemimpsvc/init = 1
	;			retrieve/e "FIS_NFITEMIMPSVC"
	;			if ($status < 0)
	;				clear/e "FIS_NFITEMIMPSVC"
	;			endif
	;			
	;			;Valor da base de calculo do ICMS.
	;			vNumericAux = vl_basecalc.fis_nfitemimpsvc + vVlBaseIcms
	;			call editarNr(12, 2, vNumericAux, vNumericAux)
	;			call convValorString(2,vNumericAux, vStringConv)
	;			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;			;Valor do ICMS.
	;			vNumericAux = vl_imposto.fis_nfitemimpsvc + vVlIcms
	;			vNumericAux = vNumericAux[round,2]
	;			call editarNr(12, 2, vNumericAux, vNumericAux)
	;			call convValorString(2,vNumericAux, vStringConv)
	;			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;			vVlBaseIcms = ""
	;			vVlIcms     = ""
	;		
	;			;PIS.
	;			clear/e "FIS_NFITEMIMPSVC"
	;			CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
	;			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
	;			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
	;			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
	;			cd_imposto.fis_nfitemimpsvc/init = 6
	;			retrieve/e "FIS_NFITEMIMPSVC"
	;			if ($status < 0)
	;				clear/e "FIS_NFITEMIMPSVC"
	;			endif
	;			
	;			;Valor do PIS.
	;			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
	;			call editarNr(12, 2, vNumericAux, vNumericAux)
	;			call convValorString(2,vNumericAux, vStringConv)
	;			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;		
	;			;COFINS.
	;			clear/e "FIS_NFITEMIMPSVC"
	;			CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
	;			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
	;			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
	;			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
	;			cd_imposto.fis_nfitemimpsvc/init = 5
	;			retrieve/e "FIS_NFITEMIMPSVC"
	;			if ($status < 0)
	;				clear/e "FIS_NFITEMIMPSVC"
	;			endif
	;			
	;			;Valor do COFINS.
	;			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
	;			call editarNr(12, 2, vNumericAux, vNumericAux)
	;			call convValorString(2,vNumericAux, vStringConv)
	;			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;			;Marcador.
	;			vDsConteudo = "%%vDsConteudo%%%|%%^"
	;				
	;			creocc "SIS_ARQUIVOSVC", -1
	;			ds_reg.sis_arquivosvc = "C321"
	;			ds_registro.sis_arquivosvc = vDsConteudo
	;
	;			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	;			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	;			$nrRegistroArq$  = $nrRegistroArq$  + 1
	;		
	;			$instancehandle->totalizarQtdTipoRegistro("C321")
	;			if ($procerror)
	;				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;				poCdErro  = $xCdErro$
	;				poCtxErro = $xCtxErro$
	;				return(-1)
	;			elseif ($status < 0)
	;				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;				poCdErro  = $xCdErro$
	;				poCtxErro = $xCtxErro$
	;				return(-1)
	;			endif

				if (cd_cst.fis_nfitemsvc = cd_cst.v_fis_apuracasvc) & (cd_cfop.fis_nfitemsvc = cd_cfop.v_fis_apuracasvc)
					creocc "TMP_K07NDD", -1
					nr_chave01.tmp_k07ndd = cd_cst.v_fis_apuracasvc
					nr_chave02.tmp_k07ndd = cd_cfop.v_fis_apuracasvc
					nr_chave03.tmp_k07ndd = pr_aliquota.v_fis_apuracasvc
					nr_chave04.tmp_k07ndd = cd_produto.fis_nfitemprosvc
					nr_chave05.tmp_k07ndd = 1
					dt_chave06.tmp_k07ndd = "01/01/2000"
					ds_chave07.tmp_k07ndd = "1"
					retrieve/o "TMP_K07NDD"
					if ($status = 4)
						retrieve/x "TMP_K07NDD"
					endif
					qt_faturado.tmp_k07ndd = qt_faturado.tmp_k07ndd + qt_faturado.fis_nfitemsvc
					cd_especie.tmp_k07ndd  = vCdEspecie
					vl_item.tmp_k07ndd     = vl_item.tmp_k07ndd + vl_totalliquido.fis_nfitemsvc		
					vl_desconto.tmp_k07ndd = vl_desconto.tmp_k07ndd + vl_totaldesc.fis_nfitemsvc

					;ICMS.
					clear/e "FIS_NFITEMIMPSVC"
					cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
					nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
					dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
					nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
					cd_imposto.fis_nfitemimpsvc/init = 1
					retrieve/e "FIS_NFITEMIMPSVC"
					if ($status < 0)
						clear/e "FIS_NFITEMIMPSVC"
					endif	
					vl_baseicms.tmp_k07ndd = vl_baseicms.tmp_k07ndd + vl_basecalc.fis_nfitemimpsvc
					vl_icms.tmp_k07ndd     = vl_icms.tmp_k07ndd + vl_imposto.fis_nfitemimpsvc

					;PIS.
					clear/e "FIS_NFITEMIMPSVC"
					cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
					nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
					dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
					nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
					cd_imposto.fis_nfitemimpsvc/init = 6
					retrieve/e "FIS_NFITEMIMPSVC"
					if ($status < 0)
						clear/e "FIS_NFITEMIMPSVC"
					endif
					vl_pis.tmp_k07ndd = vl_pis.tmp_k07ndd + vl_imposto.fis_nfitemimpsvc

					;COFINS.
					clear/e "FIS_NFITEMIMPSVC"
					cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
					nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
					dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
					nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
					cd_imposto.fis_nfitemimpsvc/init = 5
					retrieve/e "FIS_NFITEMIMPSVC"
					if ($status < 0)
						clear/e "FIS_NFITEMIMPSVC"
					endif
					vl_cofins.tmp_k07ndd   = vl_cofins.tmp_k07ndd + vl_imposto.fis_nfitemimpsvc
				endif
			endif
		
			discard "FIS_NFITEMSVC"
			if ($status = 0)
				$status = -1
			endif
		endwhile

	else
		if ($empty("TMP_K07NDD"))
			return(0)
		endif
	
		setocc "TMP_K07NDD", 1
		while ($status >= 0)

			if (nr_k01.tmp_k03nr2vl1svc = nr_chave01.tmp_k07ndd) & (nr_k02.tmp_k03nr2vl1svc = nr_chave02.tmp_k07ndd) & %\
			   (vl_k03.tmp_k03nr2vl1svc = nr_chave03.tmp_k07ndd)

				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|C321"
				;Codigo do item.
				; @>-/-- Virginia - SC 36669 - 24/08/2011 - MAF
				;call convNumeric(nr_chave04.tmp_k07ndd, 9, vStringConv)
				vTotDig = $length(nr_chave04.tmp_k07ndd)
				call convNumeric(nr_chave04.tmp_k07ndd, vTotDig, vStringConv)
				; --\-<@ 
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Quantidade do item.
				vNumericAux = qt_faturado.tmp_k07ndd
				call editarNr(11, 3, vNumericAux, vNumericAux)
				call convValorString(3,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Unidade do item.
				vStringAux  = "|%%cd_especie.tmp_k07ndd"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Valor do item.
				vNumericAux = vl_item.tmp_k07ndd
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor do desconto.
				vNumericAux = vl_desconto.tmp_k07ndd
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor da base de calculo do ICMS.
				vNumericAux = vl_baseicms.tmp_k07ndd[round,2]
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor do ICMS.
				vNumericAux = vl_icms.tmp_k07ndd[round,2]
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor do PIS.
				vNumericAux = vl_pis.tmp_k07ndd[round,2]
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor do Cofins.
				vNumericAux = vl_cofins.tmp_k07ndd[round,2]
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"
				
				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "C321"
				ds_registro.sis_arquivosvc = vDsConteudo
			
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
			
				$instancehandle->totalizarQtdTipoRegistro("C321")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
		
				discard "TMP_K07NDD"
				if ($status = 0)
					$status = -1
				endif
			else
				setocc "TMP_K07NDD", $curocc("TMP_K07NDD") + 1
			endif
		endwhile
	endif
	;;
	
	return(0)

End ;operation gerarEFDBlocoCRegC321.


;----------------------------------------------------------;
partner operation gerarEFDBlocoCRegC350                    ;
	;----------------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vPesFisica, vPesJuridica, vPessoa, vNumericAux
		date    vDtAux
	endvariables
	
	clear/e "FIS_NFSVC"
	CD_EMPFAT.fis_nfsvc/init       = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init       = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init  = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	tp_situacao.fis_nfsvc/init      = "E·;C"
	tp_moddctofiscal.fis_nfsvc/init = 02
	retrieve/e "FIS_NFSVC"
	if ($status < 0)
		return(0)
	endif
	
	setocc "FIS_NFSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C350 / %%nr_fatura.fis_nfsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		;CFC: 25/02/2010 - COMENTADO A PEDIDO DO DEUSDETE
		;if ($item("UF_ORIGEM",$xlplemp$) = "") | ($item("UF_ORIGEM",$xlplemp$) = ds_siglaestado.fis_nfremdessvc)
			if ($item("TP_PERFIL", $parametro$) != "B")
				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|C350"
				;Serie do documento fiscal.
				vStringAux = "|%%cd_serie.fis_nfsvc"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Subserie do documento fiscal.
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Numero do documento fiscal.
				call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Data de emissao do documento fiscal.
				vDtAux = dt_saidaentrada.fis_nfsvc
				vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;CNPF ou CPF do destinatario.
				; @>-/-- Virginia - PRJ 061 - TAR 772 - 17/02/10
				vPessoa = ""
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_PESSOA", cd_pessoa.fis_nfsvc
				activate "FISSVCO032".carregaPessoa($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				if (voParams != "")
					vPessoa = voParams
				endif
				; --\-<@
				; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
				vPesFisica = ""
				vPesJuridica = ""
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_PESSOA", cd_pessoa.fis_nfsvc
				activate "FISSVCO032".carregaPesFisica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				if (voParams != "")
					vPesFisica = voParams
				endif
				
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_PESSOA", cd_pessoa.fis_nfsvc
				activate "FISSVCO032".carregaPesJuridica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				if (voParams != "")
					vPesJuridica = voParams
				endif
				; --\-<@
				
				;if (tp_pessoa.pes_pessoasvc = "F")
				if ($item("TP_PESSOA",vPessoa) = "F")
					; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
					vNumericAux = $item("NR_CPF",vPesFisica)
					; --\-<@
				else
					; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
					vNumericAux = $item("NR_CNPJ",vPesJuridica)
					; --\-<@
				endif
				call convNumeric(vNumericAux, 14, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor das mercadorias.
				vNumericAux = vl_totalnota.fis_nfsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor total do documento fiscal.
				vNumericAux = vl_totalnota.fis_nfsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor total do desconto.
				vNumericAux = vl_desconto.fis_nfsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor total do PIS.
				clear/e "FIS_NFIMPOSTOSVC"
				CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
				nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
				dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
				cd_imposto.fis_nfimpostosvc/init = 6
				retrieve/e "FIS_NFIMPOSTOSVC"
				
				vNumericAux = vl_imposto.fis_nfimpostosvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Valor total da COFINS.
				clear/e "FIS_NFIMPOSTOSVC"
				CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
				nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
				dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
				cd_imposto.fis_nfimpostosvc/init = 5
				retrieve/e "FIS_NFIMPOSTOSVC"
				
				vNumericAux = vl_imposto.fis_nfimpostosvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Codigo da conta analitica contabil debitada/creditada.
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"
				
				;filedump/append vDsConteudo, ds_path.sis_filtro
				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "C350"
				ds_registro.sis_arquivosvc = vDsConteudo
				
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
				
				$instancehandle->totalizarQtdTipoRegistro("C350")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				
				;Itens do documento.
				clear/e "FIS_NFITEMSVC"
				CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
				nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
				dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
				retrieve/e "FIS_NFITEMSVC"

				$instancehandle->gerarEFDBlocoCRegC370($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				
				;Registro analitico das notas fiscais de venda a consumidor.
				$instancehandle->gerarEFDBlocoCRegC390($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
		;endif
		
		discard "FIS_NFSVC"
		if ($status = 0)
			$status = -1
		endif
		;setocc "FIS_NFSVC", $curocc(FIS_NFSVC) + 1
	endwhile
	clear/e "FIS_NFSVC"
	
	return(0)
End ;operation gerarEFDBlocoCRegC350.


;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC370              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, viParams, voParams, vStrAux, vFisCfop, vFisTipi
		numeric vQtParcela, vContador
		string  vNumericAux
	endvariables
	
	if ($empty("FIS_NFITEMSVC"))
		return(0)
	endif
	
	setocc "FIS_NFITEMSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C370 / %%cd_produto.fis_nfitemsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
			setocc "FIS_NFITEMPROSVC", 1
			vContador = vContador + 1
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|C370"
			;Numero sequencial do item no documento fiscal.
			;vStringAux = "|%%nr_item.fis_nfitem"
			vStringAux = "|%%vContador"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Codigo do item.
			;-- MAD [Proj/Tar.175/179] - 06/07/2011
			;call convNumeric(cd_produto.fis_nfitemprosvc, 9, vStringConv)
			;call convNumeric(cd_produto.fis_nfitemprosvc, 14, vStringConv)
			;;
			vStringConv = cd_produto.fis_nfitemprosvc
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			creocc "F_TMP_DS40SVC", -1
			if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
			else
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
			endif

			if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
				clear/e "PRD_PRDCONVMESVC"
				CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "PRD_PRDCONVMESVC"
				if ($status >= 0)
					$instancehandle->totalizarQtdTipoRegistro("0220")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			retrieve/o "F_TMP_DS40SVC"
			if ($status = 4)
				retrieve/x "F_TMP_DS40SVC"
				vCdEspecie = ds_especie.F_TMP_DS40SVC
			else
				ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
				ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
				vCdEspecie = cd_especie.fis_nfitemsvc
				if (cd_tipi.fis_nfitemsvc = "")
					if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
						;se serviço não vai ter ncm
					else
						clear/e "PRD_PRODUTOSVC"
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
						retrieve/e "PRD_PRODUTOSVC"
						if ($status >= 0)
							if (CD_ESPECIE.FIS_NFITEMSVC = "")
								ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
								vCdEspecie = cd_especie.prd_produtosvc
							endif
							if (cd_tipi.prd_produtosvc != "")
								; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
								vFisTipi = ""
								viParams = ""
								voParams = ""
								putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
								activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
								if ($procerror)
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									return(-1)
								endif
								if (voParams != "")
									vFisTipi = voParams
									vStrAux = $item("CD_TIPI",vFisTipi)
									vStrAux = $replace(vStrAux, 1, ".","",-1)
									cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
								endif
								; --\-<@
							endif
						endif
					endif
				else
					cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
					cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
				endif
			
				creocc "TMP_NRDSSVC", -1
				nr_geral.tmp_nrdssvc = 1
				ds_geral.tmp_nrdssvc = vCdEspecie
				retrieve/o "TMP_NRDSSVC"
				if ($status = 4)
					retrieve/x "TMP_NRDSSVC"
				endif
			endif

			;-- MAD [Proj/Tar.170/263] - 27/05/2011
			if (DS_40.F_TMP_DS40SVC != "")
				clear/e "FIS_NFITEMUNSVC"
				CD_EMPRESA.FIS_NFITEMUNSVC/init = CD_EMPRESA.FIS_NFITEMSVC
				NR_FATURA.FIS_NFITEMUNSVC/init  = NR_FATURA.FIS_NFITEMSVC
				DT_FATURA.FIS_NFITEMUNSVC/init  = DT_FATURA.FIS_NFITEMSVC
				NR_ITEM.FIS_NFITEMUNSVC/init    = NR_ITEM.FIS_NFITEMSVC
				CD_PRODUTO.FIS_NFITEMUNSVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "FIS_NFITEMUNSVC"
				if ($status >= 0) & (CD_ESPECIE.FIS_NFITEMUNSVC != vCdEspecie)
					vCdEspecie = CD_ESPECIE.FIS_NFITEMUNSVC

					clear/e "GTT_DS01SVC"
					creocc "GTT_DS01SVC", -1
					NR_GERAL.GTT_DS01SVC = DS_40.F_TMP_DS40SVC
					DS_GERAL.GTT_DS01SVC = vCdEspecie
					retrieve/o "GTT_DS01SVC"
					if ($status = -7)
						retrieve/x "GTT_DS01SVC"
					endif
					QT_CONVERSAO.GTT_DS01SVC = QT_CONVERSAO.FIS_NFITEMUNSVC
					$collhandle("GTT_DS01SVC")->Salvar()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif

					creocc "TMP_NRDSSVC", -1
					nr_geral.tmp_nrdssvc = 1
					ds_geral.tmp_nrdssvc = vCdEspecie
					retrieve/o "TMP_NRDSSVC"
					if ($status = 4)
						retrieve/x "TMP_NRDSSVC"
					endif

					creocc "TMP_DS40SVC", -1
					DS_40.TMP_DS40SVC = "0220"
					retrieve/o "TMP_DS40SVC"
					if ($status = -7)
						retrieve/x "TMP_DS40SVC"
					endif
				endif
			endif
			;;
			
			;-- MAD [Proj/Tar.170/543] - 05/09/2012
			; A lógica abaixo foi comentada
			;creocc "TMP_NR08SVC", -1
			;nr_08.tmp_nr08svc = cd_cfop.fis_nfitemsvc
			;retrieve/o "TMP_NR08SVC"
			;if ($status = 4)
			;	retrieve/x "TMP_NR08SVC"
			;else
			;	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
			;	vFisCfop = ""
			;	viParams = ""
			;	voParams = ""
			;	putitem/id viParams, "CD_CFOP", cd_cfop.fis_nfitemsvc
			;	activate "FISSVCO032".carregaFisCfop($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			;	if ($procerror)
			;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			;		return(-1)
			;	elseif ($status < 0)
			;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			;		return(-1)
			;	endif
			;	if (voParams != "")
			;		vFisCfop = voParams
			;		ds_cfop.tmp_nr08svc = $item("DS_CFOP",vFisCfop)
			;	endif
			;	; --\-<@            
			;endif
			;;

			;Quantidade do item.
			vNumericAux = qt_faturado.fis_nfitemsvc
			call editarNr(11, 3, vNumericAux, vNumericAux)
			call convValorString(3,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			vStringAux = "|%%vCdEspecie"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			
			;Valor total do item.
			vNumericAux = vl_totalliquido.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do desconto.
			vNumericAux = vl_totaldesc.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C370"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("C370")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		
		discard "FIS_NFITEMSVC"
		if ($status = 0)
			$status = -1
		endif
		;setocc "FIS_NFITEMSVC", $curocc(FIS_NFITEMSVC) + 1
	endwhile
	
	return(0)
End ;operation gerarEFDBlocoCRegC370.


;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC390              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux
		numeric vQtParcela, vVlAdicional, vVlIcms
		string  vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C390", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	clear/e "TMP_K03NR2VL1SVC"
	
	;ICMS.
	clear/e "V_FIS_APURACASVC"
	CD_EMPFAT.v_fis_apuracasvc/init       = CD_EMPFAT.fis_nfsvc
	nr_fatura.v_fis_apuracasvc/init        = nr_fatura.fis_nfsvc
	dt_fatura.v_fis_apuracasvc/init        = dt_fatura.fis_nfsvc
	cd_empfat.v_fis_apuracasvc/init        = cd_empfat.fis_nfsvc
	nr_nf.v_fis_apuracasvc/init            = nr_nf.fis_nfsvc
	cd_serie.v_fis_apuracasvc/init         = cd_serie.fis_nfsvc
	dt_emissao.v_fis_apuracasvc/init       = dt_emissao.fis_nfsvc
	dt_saidaentrada.v_fis_apuracasvc/init  = dt_saidaentrada.fis_nfsvc
	tp_operacao.v_fis_apuracasvc/init      = tp_operacao.fis_nfsvc
	tp_origememissao.v_fis_apuracasvc/init = tp_origememissao.fis_nfsvc
	cd_imposto.v_fis_apuracasvc/init       = 1
	tp_situacao.v_fis_apuracasvc/init      = "E"  
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", 1
		while ($status >= 0)
			
			creocc "TMP_K03NR2VL1SVC", -1
			nr_k01.tmp_k03nr2vl1svc = cd_cst.v_fis_apuracasvc
			nr_k02.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
			vl_k03.tmp_k03nr2vl1svc = pr_aliquota.v_fis_apuracasvc
			retrieve/o "TMP_K03NR2VL1SVC"
			if ($status = 4)
				retrieve/x "TMP_K03NR2VL1SVC"
			endif
			vl_totalliquido.tmp_k03nr2vl1svc = vl_totalliquido.tmp_k03nr2vl1svc +  vl_totalliquido.v_fis_apuracasvc
			vl_contabil.tmp_k03nr2vl1svc     = vl_contabil.tmp_k03nr2vl1svc     + vl_totalliquido.v_fis_apuracasvc
			vl_baseicms.tmp_k03nr2vl1svc     = vl_baseicms.tmp_k03nr2vl1svc     + vl_basecalc.v_fis_apuracasvc
			vl_icms.tmp_k03nr2vl1svc         = vl_icms.tmp_k03nr2vl1svc         + vl_imposto.v_fis_apuracasvc
			
			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
		
		if ($next(nr_nf.fis_nfsvc)        != nr_nf.fis_nfsvc)     | %\
		($next(cd_pessoa.fis_nfsvc)       != cd_pessoa.fis_nfsvc) | %\
		($next(dt_saidaentrada.fis_nfsvc) != dt_saidaentrada.fis_nfsvc)
		
		vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_despacessor.fis_nfsvc + vl_frete.fis_nfsvc + vl_seguro.fis_nfsvc
		clear/e "FIS_NFIMPOSTOSVC"
		CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
		nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
		dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
		cd_imposto.fis_nfimpostosvc/init = 1 ;ICMS.
		retrieve/e "FIS_NFIMPOSTOSVC"
		if ($status >= 0)
			setocc "FIS_NFIMPOSTOSVC", 1
			while ($status >= 0)
				
				vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.fis_nfimpostosvc
				vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.fis_nfimpostosvc
				
				setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
			endwhile
		endif
	endif
endif
clear/e "V_FIS_APURACASVC"

if ($empty("TMP_K03NR2VL1SVC"))
	return(0)
endif

setocc "TMP_K03NR2VL1SVC", 1
while ($status >= 0)
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|C390"
	;Codigo da situacao tributaria.
	call convNumeric(nr_k01.tmp_k03nr2vl1svc, 3, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Codigo fiscal de operacao e prestacao.
	call convNumeric(nr_k02.tmp_k03nr2vl1svc, 4, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Aliquota do ICMS.
	if (vl_k03.tmp_k03nr2vl1svc > 0)
		$vlAux$ = vl_k03.tmp_k03nr2vl1svc
		vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
	else
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
	endif
	;Valor total acumulado das operacoes referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_contabil.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_baseicms.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_icms.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor nao tributado em funcao da reducao da base de calculo do ICMS, referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = 0
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Codigo da observacao do lancamento fiscal.
	vStringAux = "|"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "C390"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("C390")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
endwhile
clear/e "TMP_K03NR2VL1SVC"

return(0)
End ;operation gerarEFDBlocoCRegC390.


;-----------------------------------------------;
partner operation gerarEFDBlocoCRegC400         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vTotDig, vNumericAux
		boolean vInMovimento, vInGerar
	endvariables
	
	clear/e "FIS_ECFSVC"
	CD_EMPRESA.fis_ecfsvc/init = $item("CD_EMPRESA", $parametro$)
	retrieve/e "FIS_ECFSVC"
	if ($status >= 0)
		setocc "FIS_ECFSVC", 1
		while ($status >= 0)
			;; ICJ [PROJ/TAR 170/105] (22/10/2010)
			;$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C400", "", "")
			;if ($procerror)
			;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			;	poCdErro  = $xCdErro$
			;	poCtxErro = $xCtxErro$
			;endif
			;
			;vDsConteudo = ""
			;Texto fixo.
			;vDsConteudo = "|C400"
			;;
			;Codigo do modelo do documento fiscal.
			clear/e "FIS_REDZMSVC"
			cd_empresa.fis_redzmsvc/init = cd_empresa.fis_ecfsvc
			nr_ecf.fis_redzmsvc/init     = nr_ecf.fis_ecfsvc
			dt_emissao.fis_redzmsvc/init = $item("DT_PERIODO", $parametro$)	; ICJ [PROJ/TAR 170/105] (22/10/2010)
			retrieve/e "FIS_REDZMSVC"
		
			;; ICJ [PROJ/TAR 170/105] (22/10/2010)
			if ($status >= 0) 
				$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C400", "", "")
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
				endif

				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|C400"
			;;
			
				;vStringAux = "|%%tp_moddctofiscal.fis_redzmsvc"
				vStringAux = "|%%%2D"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Modelo do equipamento.
				;vStringAux = "|%%ds_ecf.fis_ecfsvc"
				vTotDig = $length(ds_ecf.fis_ecfsvc)
				if (vTotDig <= 20)
					call convString("ds_ecf.fis_ecf", ds_ecf.fis_ecfsvc, vTotDig, vStringAux)
				else
					call convString("ds_ecf.fis_ecf", ds_ecf.fis_ecfsvc, 20, vStringAux) 
				endif

				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Numero de serie de fabricacao do ECF.
				;vStringAux = "|%%cd_seriefab.fis_ecfsvc"
				vTotDig = $length(cd_seriefab.fis_ecfsvc)
				if (vTotDig <= 20)
					call convString("cd_seriefab.fis_ecf", cd_seriefab.fis_ecfsvc, vTotDig, vStringAux)
				else
					call convString("cd_seriefab.fis_ecf", cd_seriefab.fis_ecfsvc, 20, vStringAux)
				endif
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Numero do caixa atribuido ao ECF.
				;@>-/-- Virginia - 111/1777 - Brascol
				;vStringAux = "|%%nr_ecf.fis_ecfsvc"
				;vDsConteudo = "%%vDsConteudo%%vStringAux"
				vNumericAux = nr_ecf.fis_ecfsvc
				call convNumeric(vNumericAux, 3, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				; --\-<@
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"
			
				;filedump/append vDsConteudo, ds_path.sis_filtro
				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "C400"
				ds_registro.sis_arquivosvc = vDsConteudo
			
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
				
				$instancehandle->totalizarQtdTipoRegistro("C400")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
					return(-1)
				endif
				
				;Reducao Z (Codigo 02 e 2D).
				$instancehandle->gerarEFDBlocoCRegC405($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif		
			endif ; ICJ [PROJ/TAR 170/105] (22/10/2010)
			setocc "FIS_ECFSVC", $curocc(FIS_ECFSVC) + 1
		endwhile
	endif
	
	return(0)
End ;operation gerarEFDBlocoCRegC400.


;------------------------------------------------;
partner operation gerarEFDBlocoCRegC405          ;
	;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		numeric vPrAliq, vVlCancelamento, vVlDesconto, vVlBaseCalcIcms
		numeric vVlIcms, vVlSaidaIsenta, vVlSaidaNaoInc, vVlSubTrib
		date    vDtAux
		boolean vInGerar
	endvariables
		
	clear/e "FIS_REDZMSVC"
	cd_empresa.fis_redzmsvc/init = cd_empresa.fis_ecfsvc
	nr_ecf.fis_redzmsvc/init     = nr_ecf.fis_ecfsvc
	dt_emissao.fis_redzmsvc/init = $item("DT_PERIODO", $parametro$)
	retrieve/e "FIS_REDZMSVC"
	if ($status >= 0)
		setocc "FIS_REDZMSVC", -1
		setocc "FIS_REDZMSVC", 1
		while ($status >= 0)
			;CFC:25/01/2010 - Comentado provisóriamente, autorizado pelo Deusdete.
			vInGerar = <FALSE>
			
			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C405 / %%nr_ecf.fis_redzmsvc", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif
			
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|C405"
			;Data do movimento a que se refere a reducao Z.
			vDtAux = dt_emissao.fis_redzmsvc
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Posicao do contador de reinicio de operacao.
			vStringAux = "|%%nr_reinicio.fis_redzmsvc"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Posicao do contador de reducao Z.
			vStringAux = "|%%nr_reducaoz.fis_redzmsvc"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Numero do contador de ordem de operacao do ultimo documento emitido no dia.
			vStringAux = "|%%nr_cupomfim.fis_redzmsvc"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor do grande total final.
			vNumericAux = vl_totalacum.fis_redzmsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor da venda bruta.
			vNumericAux = vl_vendabruta.fis_redzmsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C405"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("C405")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			;PIS e COFINS totalizados no dia.
			$instancehandle->gerarEFDBlocoCRegC410($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			$instancehandle->gerarEFDBlocoCRegC420($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			if (($item("TP_PERFIL", $parametro$) != "B") & ($item("TP_PERFIL", $parametro$) != "C")) ;-- MAD [Proj/Tar.061/526] - 18/12/2008
				;Documento fiscal emitido por ECF.
				$instancehandle->gerarEFDBlocoCRegC460($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
			
			;Registro analitico do movimento diario.
			$instancehandle->gerarEFDBlocoCRegC490($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			;endif
			
			setocc "FIS_REDZMSVC", $curocc(FIS_REDZMSVC) + 1
		endwhile
		clear/e "FIS_REDZMSVC"
	endif
	
	return(0)
End ;operation gerarEFDBlocoCRegC405.


;-----------------------------------------------;
partner operation gerarEFDBlocoCRegC410         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux, viParams, voParams, vListaNFe, vNRFaturas, vDsRegistro
		numeric vVlPis, vVlCofins
		Boolean vIngera
	endvariables
	
	vVlPis    = 0
	vVlCofins = 0
	
	viParams = ""
	voParams = ""
	;;ICJ [PROJ/TAR 170/2] (17/06/2010)	
	putitem/id viParams, "CD_EMPECF", CD_EMPRESA.FIS_REDZMSVC
	putitem/id viParams, "NR_ECF",    NR_ECF.FIS_REDZMSVC
	putitem/id viParams, "DT_FATURA", DT_EMISSAO.FIS_REDZMSVC
	putitem/id viParams, "NM_CARREGATABELA", "FIS_NFECF"
	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")

		;; ICJ [PROJ/TAR 170/143] (05/12/2010)
		vListaNFe = $item("LST_NF", voParams)    
		vNRFaturas = ""
		repeat
			getitem vDsRegistro, vListaNFe, 1
			if (vNRFaturas	 = "")
				vNRFaturas = $item("NR_FATURA",vDsRegistro)
			else
				vNRFaturas = "%%vNRFaturas%%%·;%%$item("NR_FATURA",vDsRegistro)" 
			endif
			delitem vListaNFe, 1
		until (vListaNFe = "")

		clear/e "FIS_NFSVC"
		;CD_EMPFAT.fis_nfsvc/init  = $item("CD_EMPFAT",voParams)
		;nr_fatura.fis_nfsvc/init  = $item("NR_FATURA",voParams) 
		;dt_fatura.fis_nfsvc/init  = $item("DT_FATURA",voParams)
		CD_EMPFAT.fis_nfsvc/init  = CD_EMPRESA.FIS_REDZMSVC
		nr_fatura.fis_nfsvc/init  = vNRFaturas 
		dt_fatura.fis_nfsvc/init  = DT_EMISSAO.FIS_REDZMSVC
		;;
		retrieve/e "FIS_NFSVC"
		if ($status >= 0)
			setocc "FIS_NFSVC", 1
			while ($status >= 0)
				
				vIngera = <FALSE>
				$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C410 / %%nr_fatura.fis_nfsvc", "", "")
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
				endif

				;CFC: 25/02/2010 
				clear/e "FIS_NFITEMSVC"
				CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
				nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
				dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
				retrieve/e "FIS_NFITEMSVC"
				;
				setocc "FIS_NFITEMSVC", 1
				while ($status >= 0)
					if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
						clear/e "FIS_NFITEMIMPSVC"
						CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
						nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
						dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
						nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
						cd_imposto.fis_nfitemimpsvc/init = "5·;6" ;5-COFINS/6-PIS.
						retrieve/e "FIS_NFITEMIMPSVC"
						if ($status >= 0)
							vIngera = <TRUE>
							
							setocc "FIS_NFITEMIMPSVC", 1
							while ($status >= 0)
								
								if (cd_imposto.fis_nfitemimpsvc = 5)
									;Cofins.
									vVlCofins = vVlCofins + vl_imposto.fis_nfitemimpsvc[round,2]
								else
									;Pis.
									vVlPis = vVlPis + vl_imposto.fis_nfitemimpsvc[round,2]
								endif
								
								setocc "FIS_NFITEMIMPSVC", $curocc(FIS_NFITEMIMPSVC) + 1
							endwhile
						endif
					endif
					
					discard "FIS_NFITEMSVC"
					if ($status = 0)
						$status = -1
					endif
					;setocc "FIS_NFITEMSVC", $curocc(FIS_NFITEMSVC) + 1
				endwhile
				
				discard "FIS_NFSVC"
				if ($status = 0)
					$status = -1
				endif
				;setocc "FIS_NFSVC", $curocc(FIS_NFSVC) + 1
			endwhile
		endif
	endif
	clear/e "FIS_NFSVC"
	
	if (vIngera = <TRUE>)
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|C410"
		;Valor total do PIS.
		vNumericAux = vVlPis
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor total da COFINS.
		vNumericAux = vVlCofins
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
		
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "C410"
		ds_registro.sis_arquivosvc = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("C410")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	
	return(0)
End ;operation gerarEFDBlocoCRegC410.


;-----------------------------------------------;
partner operation gerarEFDBlocoCRegC420         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		numeric vValor, vAux1
	endvariables
	vValor = 0
	vAux1 = 0
	setocc "FIS_REDZASVC", 1
	sort "FIS_REDZASVC","CD_SITALIQ.FIS_REDZASVC"
	while ($status >= 0)
		vValor = vValor + vl_totalacum.fis_redzasvc
		if (CD_SITALIQ.FIS_REDZASVC != $next(CD_SITALIQ.FIS_REDZASVC))
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|C420"
			;Código do totalizador. 7
			if (CD_SITALIQ.FIS_REDZASVC != "CANC") & (CD_SITALIQ.FIS_REDZASVC != "DESC")
				if (CD_SITALIQ.FIS_REDZASVC = "F") | (CD_SITALIQ.FIS_REDZASVC = "I") | (CD_SITALIQ.FIS_REDZASVC = "N") ;ICJ 02/06/2010
					vStringAux = "%%CD_SITALIQ.FIS_REDZASVC%%%1"
				else
					vAux1 = vAux1 + 1
					call convNumeric(vAux1, 2, vStringConv)
					vStringAux = "%%vStringConv%%%T%%CD_SITALIQ.FIS_REDZASVC"
					call convString("CD_SITALIQ", vStringAux, 7, vStringAux)
				endif
			elseif (CD_SITALIQ.FIS_REDZASVC = "CANC")
				vStringAux = "Can-T"
				call convString("CD_SITALIQ", vStringAux, 5, vStringAux)
			else
				vStringAux = "DT"
				call convString("CD_SITALIQ", vStringAux, 2, vStringAux)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Valor acumulado.
			vNumericAux = vValor
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;NR_TOT
;			vAux1 = vAux1 + 1

			if (CD_SITALIQ.FIS_REDZASVC = "CANC" | CD_SITALIQ.FIS_REDZASVC = "DESC" | CD_SITALIQ.FIS_REDZASVC = "I" | CD_SITALIQ.FIS_REDZASVC = "N" | CD_SITALIQ.FIS_REDZASVC = "F")
				vStringConv = ""
			else
				call convNumeric(vAux1, 2, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

			;Descricao da situação tributária.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			vValor = 0
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C420"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("C420")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			if (CD_SITALIQ.FIS_REDZASVC != "CANC") & (CD_SITALIQ.FIS_REDZASVC != "DESC") & %\
			   ($item("TP_PERFIL",$parametro$) != "A") ;-- MAD [Proj/Tar.170/061] - 08/09/2010

				$instancehandle->gerarEFDBlocoCRegC425($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif	
		endif
		setocc("FIS_REDZASVC"), $curocc("FIS_REDZASVC") + 1
	endwhile
	
	return(0)
End ;operation gerarEFDBlocoCRegC420.


;-----------------------------------------------;
partner operation gerarEFDBlocoCRegC425         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, vFisTipi, viParams, voParams, vsTraux, vTipo, vNumericAux
		numeric vVlPis, vVlCofins, vQt, vVlProduto, vTotDig, vCdSitAliq
		boolean vEmite
	endvariables 

	;-- MAD [Proj/Tar.170/434] - 09/05/2012
	; A tabela temporária F_TMP_NR10SVC foi substituida pela TMP_DS60SVC para que a chave 
	; da tabela aceite caracteres alfanuméricos, pois o campo CD_PRODUTO.FIS_NFITEM é um DS_20.
	;;

	vVlPis = 0
	vVlCofins = 0
	vQt = 0
	clear/e "TMP_DS60SVC"
	clear/e "FIS_NFSVC"
	CD_EMPFAT.fis_nfsvc/init = cd_empresa.fis_redzmsvc
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init      = dt_emissao.fis_redzmsvc
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init = dt_emissao.fis_redzmsvc
	endif
	;------//------//------
	cd_serie.fis_nfsvc/init    = "ECF"
	tp_situacao.fis_nfsvc/init = "E"
	tp_operacao.fis_nfsvc/init = "S"
	retrieve/e "FIS_NFSVC"
	if ($status >= 0)
		setocc "FIS_NFSVC", 1
		while ($status >= 0)
			viParams = ""
			voParams = ""
			;;ICJ [PROJ/TAR 170/2] (17/06/2010)	
			putitem/id viParams, "CD_EMPECF", CD_EMPFAT.FIS_NFSVC
			putitem/id viParams, "NR_FATURA", NR_FATURA.FIS_NFSVC
			putitem/id viParams, "DT_FATURA", DT_FATURA.FIS_NFSVC
			putitem/id viParams, "NM_CARREGATABELA", "FIS_NFECF"
			activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			if (voParams != "")
				if ($item("NR_ECF",voParams) = nr_ecf.fis_redzmsvc)
					$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C425 / %%dt_fatura.fis_nfsvc", "", "")
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
					endif

					vVlCofins = 0
					vVlPis    = 0

					;CFC: 25/02/2010
					clear/e "FIS_NFITEMSVC"
					CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
					nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
					dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
					retrieve/e "FIS_NFITEMSVC"
					;
					setocc "FIS_NFITEMSVC", -1
					sort "FIS_NFITEMSVC","CD_PRODUTO.FIS_NFITEMSVC"
					setocc "FIS_NFITEMSVC", 1
					while ($status >= 0)
						if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
							vCdSitAliq = CD_SITALIQ.FIS_REDZASVC
							vEmite = <FALSE>
							if ((CD_SITALIQ.FIS_REDZASVC = "F") & (CD_CST.FIS_NFITEMSVC[2:2] = "60")) |  %\
							   ((CD_SITALIQ.FIS_REDZASVC = "I") & (CD_CST.FIS_NFITEMSVC[2:2] = "40")) |	 %\
							   ((CD_SITALIQ.FIS_REDZASVC = "N") & (CD_CST.FIS_NFITEMSVC[2:2] = "41")) |	 %\
								(vCdSitAliq > 0)
								vEmite = <TRUE>
								if (vCdSitAliq > 0)
									clear/e "FIS_NFITEMIMPSVC"
									CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
									nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
									dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
									nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc    
									cd_imposto.fis_nfitemimpsvc/init = 1
									vCdSitAliq = vCdSitAliq/100
									pr_aliquota.fis_nfitemimpsvc/init = vCdSitAliq
									retrieve/e "FIS_NFITEMIMPSVC"
									if ($status < 0)
										vEmite = <FALSE>
									endif
								endif
							endif
							if (vEmite = <TRUE>)
								clear/e "FIS_NFITEMIMPSVC"
								CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
								nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
								dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
								nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc    
								cd_imposto.fis_nfitemimpsvc/init = 5 ;5-COFINS
								retrieve/e "FIS_NFITEMIMPSVC"
								if ($status >= 0)
									;->RIM [175/392] 03/08/2012
									;vVlCofins = vVlCofins + vl_imposto.fis_nfitemimpsvc[round,2] 
									vVlCofins = vl_imposto.fis_nfitemimpsvc[round,2] 
									;<-
								endif
	
								clear/e "FIS_NFITEMIMPSVC"
								CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
								nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
								dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
								nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc    
								cd_imposto.fis_nfitemimpsvc/init = 6 ;6-PIS
								retrieve/e "FIS_NFITEMIMPSVC"
								if ($status >= 0)
									;->RIM [175/392] 03/08/2012
									;vVlPis = vVlPis + vl_imposto.fis_nfitemimpsvc[round,2] 
									vVlPis = vl_imposto.fis_nfitemimpsvc[round,2] 
									;<-
								endif
		
								;;ICJ [PROJ/TAR 61/831] (28/05/2010)  
								creocc "TMP_DS60SVC", -1
								DS_60.TMP_DS60SVC = CD_PRODUTO.FIS_NFITEMSVC
								retrieve/o "TMP_DS60SVC"
								if ($status = 4)
									retrieve/x "TMP_DS60SVC"
								endif
								NR_QTDE.TMP_DS60SVC 	 	 = NR_QTDE.TMP_DS60SVC 	+ QT_FATURADO.FIS_NFITEMSVC
								CD_ESPECIE.TMP_DS60SVC  	 = CD_ESPECIE.FIS_NFITEMSVC
								DS_PRODUTO.TMP_DS60SVC  	 = DS_PRODUTO.FIS_NFITEMSVC
								VL_TOTALLIQUIDO.TMP_DS60SVC = VL_TOTALLIQUIDO.TMP_DS60SVC	+ VL_TOTALLIQUIDO.FIS_NFITEMSVC
								VL_PIS.TMP_DS60SVC 			 = VL_PIS.TMP_DS60SVC 		+ vVlPis
								VL_COFINS.TMP_DS60SVC 		 = VL_COFINS.TMP_DS60SVC 	+ vVlCofins
							;;
							endif
						endif
	
						discard "FIS_NFITEMSVC"
						if ($status = 0)
							$status = -1
						endif
					;setocc "FIS_NFITEMSVC", $curocc(FIS_NFITEMSVC) + 1
					endwhile
				endif	
			endif
			vVlPis = 0
			vVlCofins = 0
			vQt    = 0
			vVlProduto = 0

			discard "FIS_NFSVC"
			if ($status = 0)
				$status = -1
			endif
		endwhile
	endif

	;-- MAD [Proj/Tar.170/434] - 09/05/2012
	if ($empty("TMP_DS60SVC"))
		return(0)
	endif
	;;

	setocc "TMP_DS60SVC", 1
	while ($status >= 0)
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|C425"
		;Código do item. 60
		;-- MAD [Proj/Tar.170/210] - 10/03/2011
		;vTotDig = $length(DS_60.TMP_DS60SVC)
		;call convString("CD_PRODUTO", DS_60.TMP_DS60SVC, vTotDig, vStringAux)
		;vTotDig = 14
		;call convNumeric(DS_60.TMP_DS60SVC, vTotDig, vStringAux)
		vStringAux = DS_60.TMP_DS60SVC
		;;
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Quantidade acumulada
		;vNumericAux = vQt CFC: 19/04/2010
		vNumericAux = NR_QTDE.TMP_DS60SVC
		call editarNr(12, 3, vNumericAux, vNumericAux)
		call convValorString(3,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Unidade do item 6
		vTotDig = $length(CD_ESPECIE.TMP_DS60SVC)
		call convString("CD_ESPECIE", CD_ESPECIE.TMP_DS60SVC, vTotDig, vStringAux)
		;call convString("CD_ESPECIE", CD_ESPECIE.FIS_NFITEMSVC, 6, vStringAux) CFC: 19/04/2010
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;CFC: 25/01/2010 - Campo obrigatório no registro.	
		;Valor item.
		;vNumericAux = vVlProduto CFC: 19/04/2010
		vNumericAux = VL_TOTALLIQUIDO.TMP_DS60SVC
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor PIS.
		vNumericAux = VL_PIS.TMP_DS60SVC
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor Cofins.
		vNumericAux = VL_COFINS.TMP_DS60SVC
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
							
		vDsConteudo = "%%vDsConteudo%%%|%%^"
							
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "C425"
		ds_registro.sis_arquivosvc = vDsConteudo
							
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		$instancehandle->totalizarQtdTipoRegistro("C425")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		creocc "TMP_NRDSSVC", -1
		nr_geral.tmp_nrdssvc = 1
		ds_geral.tmp_nrdssvc = CD_ESPECIE.TMP_DS60SVC
		retrieve/o "TMP_NRDSSVC"
		if ($status = 4)
			retrieve/x "TMP_NRDSSVC"
		endif

		;;ICJ [PROJ/TAR 61/831] (28/05/2010)
		creocc "F_TMP_DS40SVC", -1
		DS_40.F_TMP_DS40SVC = DS_60.TMP_DS60SVC

		if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
			clear/e "PRD_PRDCONVMESVC"
			CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
			retrieve/e "PRD_PRDCONVMESVC"
			if ($status >= 0)
				$instancehandle->totalizarQtdTipoRegistro("0220")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
		endif

		retrieve/o "F_TMP_DS40SVC"
		if ($status = 4)
			retrieve/x "F_TMP_DS40SVC"
			vCdEspecie = ds_especie.F_TMP_DS40SVC
		else
			ds_produto.F_TMP_DS40SVC = DS_PRODUTO.TMP_DS60SVC
			ds_especie.F_TMP_DS40SVC = CD_ESPECIE.TMP_DS60SVC
			vCdEspecie = CD_ESPECIE.TMP_DS60SVC
			if (cd_tipi.fis_nfitemsvc = "")
				clear/e "PRD_PRODUTOSVC"
				cd_produto.prd_produtosvc/init = DS_60.TMP_DS60SVC
				retrieve/e "PRD_PRODUTOSVC"
				if ($status >= 0)
					if (cd_tipi.prd_produtosvc != "")
						vFisTipi = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
						activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vFisTipi = voParams
							vStrAux = $item("CD_TIPI",vFisTipi)
							vStrAux = $replace(vStrAux, 1, ".","",-1)
							cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
						endif
					endif
				endif
			endif

			creocc "TMP_NRDSSVC", -1
			nr_geral.tmp_nrdssvc = 1
			ds_geral.tmp_nrdssvc = vCdEspecie
			retrieve/o "TMP_NRDSSVC"
			if ($status = 4)
				retrieve/x "TMP_NRDSSVC"
			endif
		endif
		;;
		discard "TMP_DS60SVC"
		if ($status = 0)
			$status = -1
		endif
	endwhile

	clear/e "TMP_DS60SVC"

	return(0)
End ;operation gerarEFDBlocoCRegC425.


;-----------------------------------------------;
partner operation gerarEFDBlocoCRegC460         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo, vStringConv, vStringAux, viParams, voParams, vPesFisica, vPesJuridica, vPessoa, vNumericAux
		string vDsRegistro, vDsLstNf, vNrCupom
		date   vDtAux
	endvariables

	;-- MAD [Proj/Tar.170/323] - 05/07/2011
	;viParams = ""
	;voParams = ""
	;;;ICJ [PROJ/TAR 170/2] (17/06/2010)	
	;putitem/id viParams, "CD_EMPECF"       , CD_EMPRESA.FIS_REDZMSVC
	;putitem/id viParams, "NR_ECF"          , NR_ECF.FIS_REDZMSVC
	;putitem/id viParams, "DT_FATURA"       , DT_EMISSAO.FIS_REDZMSVC ;-- MAD [Proj/Tar.170/127] - 23/11/2010
	;putitem/id viParams, "NM_CARREGATABELA", "FIS_NFECF"
	;activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	;if ($procerror)
	;	$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
	;	return(-1)
	;elseif ($status < 0)
	;	$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
	;	return(-1)
	;endif
	;if (voParams != "")
	;
	;	;-- MAD [Proj/Tar.170/127] - 23/11/2010
	;	;clear/e "FIS_NFSVC"
	;	;CD_EMPFAT.fis_nfsvc/init = $item("CD_EMPFAT",voParams)
	;	;nr_fatura.fis_nfsvc/init = $item("NR_FATURA",voParams) 
	;	;dt_fatura.fis_nfsvc/init = $item("DT_FATURA",voParams)
	;	;retrieve/e "FIS_NFSVC"
	;	;if ($status >= 0)
	;	;	setocc "FIS_NFSVC", 1
	;	;	while ($status >= 0)
	;
	;	vDsLstNf = $item("LST_NF", voParams)    
	;	repeat
	;		getitem vDsRegistro, vDsLstNf, 1
	;		clear/e "FIS_NFSVC"
	;		cd_empfat.fis_nfsvc/init = $item("CD_EMPFAT",vDsRegistro)
	;		nr_fatura.fis_nfsvc/init = $item("NR_FATURA",vDsRegistro)
	;		dt_fatura.fis_nfsvc/init = $item("DT_FATURA",vDsRegistro)
	;		retrieve/e "FIS_NFSVC"
	;		if ($status >= 0)
	;	;;

	clear/e "FIS_NFSVC"
	CD_EMPFAT.FIS_NFSVC/init  = CD_EMPRESA.FIS_REDZMSVC
	DT_EMISSAO.FIS_NFSVC/init = DT_EMISSAO.FIS_REDZMSVC
	CD_SERIE.FIS_NFSVC/init   = "ECF"
	retrieve/e "FIS_NFSVC"
	if ($status >= 0)
		sort/e "FIS_NFSVC", "NR_FATURA.FIS_NFSVC"
		setocc "FIS_NFSVC", 1
		while ($status >= 0)

			clear/e "FIS_NFECFSVC"
			CD_EMPFAT.FIS_NFECFSVC/init = CD_EMPFAT.FIS_NFSVC
			NR_FATURA.FIS_NFECFSVC/init = NR_FATURA.FIS_NFSVC
			DT_FATURA.FIS_NFECFSVC/init = DT_FATURA.FIS_NFSVC
			NR_ECF.FIS_NFECFSVC/init    = NR_ECF.FIS_REDZMSVC
			retrieve/e "FIS_NFECFSVC"
			if ($status >= 0)
	;;
				$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C460 / %%nr_fatura.fis_nfsvc", "", "")
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
				endif
				
				;CFC: 25/02/2010 - COMENTADO A PEDIDO DO DEUSDETE
				;if ($item("UF_ORIGEM",$xlplemp$) = "") | ($item("UF_ORIGEM",$xlplemp$) = ds_siglaestado.fis_nfremdessvc)
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|C460"
					;Codigo do modelo do documento fiscal.
					if (tp_moddctofiscal.fis_nfsvc = 71)
						vNumericAux = "2D"
					else
						vNumericAux = "02"
					endif
					call convNumeric(vNumericAux, 2, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Codigo da situacao do documento fiscal.
					if (tp_situacao.fis_nfsvc = "E")
						;Nota emitida.
						vStringAux = "|00"
					else
						;Nota cancelada.
						vStringAux = "|02"
					endif
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Numero do documento fiscal.
					;@>-/-- Virginia - 111/1776 - Brascol
					if (tp_moddctofiscal.fis_nfsvc = 71)
						putitem/id viParams, "CD_EMPECF"       , CD_EMPFAT.FIS_NFSVC
						putitem/id viParams, "NR_FATURA"       , NR_FATURA.FIS_NFSVC
						putitem/id viParams, "DT_FATURA"       , DT_FATURA.FIS_NFSVC
						putitem/id viParams, "NM_CARREGATABELA", "FIS_NFECF"
						activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vNrCupom = $item("NR_CUPOM", voParams)
							call retirarNaoNumerico(vNrCupom, vStringAux)
						endif
					else
						call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
					endif
					;call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
					; --\-<@
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					if (tp_situacao.fis_nfsvc != "C") ;ICJ [PROJ/TAR 175/45] (26/01/2011)
						;Data de emissao do documento fiscal.
						vDtAux = dt_saidaentrada.fis_nfsvc
						vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
						;Valor total do documento fiscal.
						vNumericAux = vl_totalnota.fis_nfsvc
						call editarNr(12, 2, vNumericAux, vNumericAux)
						call convValorString(2,vNumericAux, vStringConv)
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
						;Valor do PIS.
						clear/e "FIS_NFIMPOSTOSVC"
						CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
						nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
						dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
						cd_imposto.fis_nfimpostosvc/init = 6
						retrieve/e "FIS_NFIMPOSTOSVC"
					
						vNumericAux = vl_imposto.fis_nfimpostosvc
						call editarNr(12, 2, vNumericAux, vNumericAux)
						call convValorString(2,vNumericAux, vStringConv)
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
						;Valor do COFINS.
						clear/e "FIS_NFIMPOSTOSVC"
						CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
						nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
						dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
						cd_imposto.fis_nfimpostosvc/init = 5
						retrieve/e "FIS_NFIMPOSTOSVC"
						
						vNumericAux = vl_imposto.fis_nfimpostosvc
						call editarNr(12, 2, vNumericAux, vNumericAux)
						call convValorString(2,vNumericAux, vStringConv)
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
						;CPF ou CNPJ do adquirente.
						; @>-/-- Virginia - PRJ 061 - TAR 772 - 17/02/10
						vPessoa = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_PESSOA", cd_pessoa.fis_nfremdessvc
						activate "FISSVCO032".carregaPessoa($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vPessoa = voParams
						endif
						; --/-<@
						; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
						vPesFisica = ""
						vPesJuridica = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_PESSOA", cd_pessoa.fis_nfremdessvc
						activate "FISSVCO032".carregaPesFisica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vPesFisica = voParams
						endif
						
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_PESSOA", cd_pessoa.fis_nfremdessvc
						activate "FISSVCO032".carregaPesJuridica($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vPesJuridica = voParams
						endif
						; --\-<@
						;if (TP_PESSOA.PES_PESSOASVC = "F")
						vStringConv = "" ;ICJ [PROJ/TAR 175/49] (01/02/2011)
						if ($item("TP_PESSOA",vPessoa) = "F")
							if ($item("NR_CPF",vPesFisica) != "") ;ICJ [PROJ/TAR 175/49] (01/02/2011)
								; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
								vNumericAux = $item("NR_CPF",vPesFisica)
								call convNumeric(vNumericAux, 11, vStringConv) ;-- MAD [Proj/Tar.061/899] - 22/11/2010
								; --\-<@
							endif
						else
							if ($item("NR_CNPJ",vPesJuridica) != "") ;ICJ [PROJ/TAR 175/49] (01/02/2011)
								; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
								vNumericAux = $item("NR_CNPJ",vPesJuridica)
								call convNumeric(vNumericAux, 14, vStringConv) ;-- MAD [Proj/Tar.061/899] - 22/11/2010
								; --\-<@
							endif
						endif
						;call convNumeric(vNumericAux, 14, vStringConv)        ;-- MAD [Proj/Tar.061/899] - 22/11/2010
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
						;Nome do adquirente.
						;vStringAux = "|%%nm_pessoa.pes_pessoasvc"
						vStringAux = "|%%$item("NM_PESSOA",vPessoa)"
						vDsConteudo = "%%vDsConteudo%%vStringAux"	
					;;ICJ [PROJ/TAR 175/45] (26/01/2011)
					else
						;Data de emissao do documento fiscal.
						vStringAux = ""
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
						;Valor total do documento fiscal.
						vStringConv = ""
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
						;Valor do PIS.
						vStringConv = ""
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
						;Valor do COFINS.
						vStringConv = ""
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
						;CPF ou CNPJ do adquirente.
						vStringConv = ""
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
						;Nome do adquirente.
						vStringConv = ""
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					endif
					;;
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"
						
					;filedump/append vDsConteudo, ds_path.sis_filtro
					creocc "SIS_ARQUIVOSVC", -1
					ds_reg.sis_arquivosvc = "C460"
					ds_registro.sis_arquivosvc = vDsConteudo
					
					$nrLinhaBloco$   = $nrLinhaBloco$   + 1
					$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
					$nrRegistroArq$  = $nrRegistroArq$  + 1
					
					$instancehandle->totalizarQtdTipoRegistro("C460")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
					
					if (($item("TP_PERFIL", $parametro$)  != "B") & ($item("TP_PERFIL", $parametro$) != "C")) ;-- MAD [Proj/Tar.061/526] - 18/12/2008                            
						;CFC: 25/02/2010
						if (tp_situacao.fis_nfsvc != "C") ;ICJ [PROJ/TAR 175/45] (26/01/2011)
							clear/e "FIS_NFITEMSVC"
							CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
							nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
							dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
							retrieve/e "FIS_NFITEMSVC"
							;
							$instancehandle->gerarEFDBlocoCRegC470($xCdErro$, $xCtxErro$)
							if ($procerror)
								$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								poCdErro  = $xCdErro$
								poCtxErro = $xCtxErro$
								return(-1)
							endif
						endif		
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				;endif
			;	delitem vDsLstNf, 1
			;until (vDsLstNf = "")

			endif		
			discard "FIS_NFSVC"
			if ($status = 0)
				$status = -1
			endif
		endwhile
	endif

	clear/e "FIS_NFSVC"
	
	return(0)
End ;operation gerarEFDBlocoCRegC460.


;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC470              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, viParams, voParams, vStrAux, vFisCfop, vFisTipi, vNumericAux
		numeric vQtParcela, vTotDig
	endvariables
	
	if ($empty("FIS_NFITEMSVC"))
		return(0)
	endif
	
	setocc "FIS_NFITEMSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C470 / %%cd_produto.fis_nfitemsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
			setocc "FIS_NFITEMPROSVC", 1
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|C470"
			;Codigo do item.
			;call convNumeric(cd_produto.fis_nfitemprosvc, 9, vStringConv)
; -> rodrigo  - PRJ 170 TAR 231 - 31/03/2011
;			vTotDig = $length(cd_produto.fis_nfitemprosvc)
;			call convString("CD_PRODUTO", cd_produto.fis_nfitemprosvc, vTotDig, vStringConv)
			;vTotDig = 14
;			call convNumeric(cd_produto.fis_nfitemprosvc, vTotDig, vStringConv)
			vStringConv = cd_produto.fis_nfitemprosvc
; <- rodrigo  - PRJ 170 TAR 231 - 31/03/2011
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			creocc "F_TMP_DS40SVC", -1
			if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
			else
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
			endif

			if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
				clear/e "PRD_PRDCONVMESVC"
				CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "PRD_PRDCONVMESVC"
				if ($status >= 0)
					$instancehandle->totalizarQtdTipoRegistro("0220")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			retrieve/o "F_TMP_DS40SVC"
			if ($status = 4)
				retrieve/x "F_TMP_DS40SVC"
				vCdEspecie = ds_especie.F_TMP_DS40SVC
			else
				ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
				ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
				vCdEspecie = cd_especie.fis_nfitemsvc
				if (cd_tipi.fis_nfitemsvc = "")
					if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
						;se for serviço não vai ter ncm
					else
						clear/e "PRD_PRODUTOSVC"
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
						retrieve/e "PRD_PRODUTOSVC"
						if ($status >= 0)
							if (CD_ESPECIE.FIS_NFITEMSVC = "")
								ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
								vCdEspecie = cd_especie.prd_produtosvc
							endif
							if (cd_tipi.prd_produtosvc != "")
								; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
								vFisTipi = ""
								viParams = ""
								voParams = ""
								putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
								activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
								if ($procerror)
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									return(-1)
								endif
								if (voParams != "")
									vFisTipi = voParams
									vStrAux = $item("CD_TIPI",vFisTipi)	
									vStrAux = $replace(vStrAux, 1, ".","",-1)
									cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
								endif
								; --\-<@
							endif
						endif
					endif
				else
					cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
					cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
				endif
				
				creocc "TMP_NRDSSVC", -1
				nr_geral.tmp_nrdssvc = 1
				ds_geral.tmp_nrdssvc = vCdEspecie
				retrieve/o "TMP_NRDSSVC"
				if ($status = 4)
					retrieve/x "TMP_NRDSSVC"
				endif
			endif

			;-- MAD [Proj/Tar.170/263] - 27/05/2011
			if (DS_40.F_TMP_DS40SVC != "")
				clear/e "FIS_NFITEMUNSVC"
				CD_EMPRESA.FIS_NFITEMUNSVC/init = CD_EMPRESA.FIS_NFITEMSVC
				NR_FATURA.FIS_NFITEMUNSVC/init  = NR_FATURA.FIS_NFITEMSVC
				DT_FATURA.FIS_NFITEMUNSVC/init  = DT_FATURA.FIS_NFITEMSVC
				NR_ITEM.FIS_NFITEMUNSVC/init    = NR_ITEM.FIS_NFITEMSVC
				CD_PRODUTO.FIS_NFITEMUNSVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "FIS_NFITEMUNSVC"
				if ($status >= 0) & (CD_ESPECIE.FIS_NFITEMUNSVC != vCdEspecie)
					vCdEspecie = CD_ESPECIE.FIS_NFITEMUNSVC
	
					clear/e "GTT_DS01SVC"
					creocc "GTT_DS01SVC", -1
					NR_GERAL.GTT_DS01SVC = DS_40.F_TMP_DS40SVC
					DS_GERAL.GTT_DS01SVC = vCdEspecie
					retrieve/o "GTT_DS01SVC"
					if ($status = -7)
						retrieve/x "GTT_DS01SVC"
					endif
					QT_CONVERSAO.GTT_DS01SVC = QT_CONVERSAO.FIS_NFITEMUNSVC
					$collhandle("GTT_DS01SVC")->Salvar()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif

					creocc "TMP_NRDSSVC", -1
					nr_geral.tmp_nrdssvc = 1
					ds_geral.tmp_nrdssvc = vCdEspecie
					retrieve/o "TMP_NRDSSVC"
					if ($status = 4)
						retrieve/x "TMP_NRDSSVC"
					endif

					creocc "TMP_DS40SVC", -1
					DS_40.TMP_DS40SVC = "0220"
					retrieve/o "TMP_DS40SVC"
					if ($status = -7)
						retrieve/x "TMP_DS40SVC"
					endif
				endif
			endif
			;;
			
			; @>-/-- Virginia - 111/1776 - Brascol
			;creocc "TMP_NR08SVC", -1
			;nr_08.tmp_nr08svc = cd_cfop.fis_nfitemsvc
			;retrieve/o "TMP_NR08SVC"
			;if ($status = 4)
			;	retrieve/x "TMP_NR08SVC"
			;else
			;	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
			;	vFisCfop = ""
			;	viParams = ""
			;	voParams = ""
			;	putitem/id viParams, "CD_CFOP", cd_cfop.fis_nfitemsvc
			;	activate "FISSVCO032".carregaFisCfop($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			;	if ($procerror)
			;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			;		return(-1)
			;	elseif ($status < 0)
			;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			;		return(-1)
			;	endif
			;	if (voParams != "")
			;		vFisCfop = voParams
			;		ds_cfop.tmp_nr08svc = $item("DS_CFOP",vFisCfop)
			;	endif
				; --\-<@            
			;endif
			; --\-<@            
			
			;Quantidade do item.
			vNumericAux = qt_faturado.fis_nfitemsvc
			call editarNr(11, 3, vNumericAux, vNumericAux)
			call convValorString(3,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Quantidade cancelada do item.
			vNumericAux = 0
			call editarNr(11, 3, vNumericAux, vNumericAux)
			call convValorString(3,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Unidade do item.
			vStringAux = "|%%vCdEspecie"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			
			;Valor do item.
			vNumericAux = vl_totalliquido.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da situacao tributaria.
			call convNumeric(cd_cst.fis_nfitemsvc, 3, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo fiscal de operacao e prestacao.
			call convNumeric(cd_cfop.fis_nfitemsvc, 4, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;ICMS.
			clear/e "FIS_NFITEMIMPSVC"
			CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 1
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			
			;Aliquota do ICMS - carga tributaria efetiva em percentual.
			if (pr_aliquota.fis_nfitemimpsvc > 0)
				$vlAux$ = pr_aliquota.fis_nfitemimpsvc
				vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
			else
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
			endif
			
			;Valor do PIS.
			clear/e "FIS_NFITEMIMPSVC"
			CD_EMPFAT.fis_nfitemimpsvc/init = $item("CD_EMPRESA", $parametro$)
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 6
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor da COFINS.
			clear/e "FIS_NFITEMIMPSVC"
			CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 5
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C470"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("C470")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		
		discard "FIS_NFITEMSVC"
		if ($status = 0)
			$status = -1
		endif
		;setocc "FIS_NFITEMSVC", $curocc(FIS_NFITEMSVC) + 1
	endwhile
	
	return(0)
End ;operation gerarSUPBlocoCRegC470.


;--------------------------------------------------;
partner operation gerarEFDBlocoCRegC490            ;
;--------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux, vFisCfop, viParams, voParams
		numeric vPrAliq, vVlCancelamento, vVlDesconto, vVlBaseCalcIcms, vTotalAliquota, vPosMaiorVl, vVlMaior, vImpostoRedza
		numeric vVlIcms, vVlSaidaIsenta, vVlSaidaNaoInc, vVlSubTrib
		date    vDtAux
	endvariables
	
	clear/e "TMP_NR10SVC"
	clear/e "F_FIS_REDZMSVC"
	cd_empresa.f_fis_redzmsvc/init    = $item("CD_EMPRESA", $parametro$)
	dt_emissao.f_fis_redzmsvc/init    = $item("DT_PERIODO", $parametro$)
	nr_ecf.f_fis_redzmsvc/init        = nr_ecf.fis_ecfsvc
	dt_emissao.f_fis_redzmsvc/init    = dt_emissao.fis_redzmsvc
;	tp_moddctofiscal.f_fis_nfsvc/init = 02; "2;2D"
	retrieve/e "F_FIS_REDZMSVC"
	if ($status < 0)
		return(0)
	endif
	
	setocc "F_FIS_REDZMSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C490 / %%NR_ECF.F_FIS_REDZMSVC", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		;--> VSOUZA PRJ/TAR 189/007 06/09/2011 - Retirado o looping na FIS_NF
		clear/e "V_FIS_APURACASVC"
		CD_EMPFAT.V_FIS_APURACASVC/init           = CD_EMPRESA.F_FIS_REDZMSVC
		CD_SERIE.V_FIS_APURACASVC/init            = "ECF"
		if ($inConsideraDtemisNfsai$ = <TRUE>)
			DT_EMISSAO.V_FIS_APURACASVC/init       = DT_EMISSAO.F_FIS_REDZMSVC
		else
			DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = DT_EMISSAO.F_FIS_REDZMSVC
		endif
		TP_OPERACAO.V_FIS_APURACASVC/init         = "S"
		CD_IMPOSTO.V_FIS_APURACASVC/init          = "1·;2" ; --\-<@ Virginia - 111/1776 - Brascol
		TP_SITUACAO.V_FIS_APURACASVC/init         = "E"
		retrieve/e "V_FIS_APURACASVC"

		if ($status >= 0)
			while ($status >= 0)		
				viParams = ""
				voParams = ""
				;;ICJ [PROJ/TAR 170/2] (17/06/2010)	
				putitem/id viParams, "CD_EMPECF", CD_EMPFAT.V_FIS_APURACASVC
				putitem/id viParams, "NR_FATURA", NR_FATURA.V_FIS_APURACASVC
				putitem/id viParams, "DT_FATURA", DT_FATURA.V_FIS_APURACASVC
				putitem/id viParams, "NM_CARREGATABELA", "FIS_NFECF"
				activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				if (voParams != "")
					if ($item("NR_ECF",voParams) = NR_ECF.FIS_REDZMSVC)
					
						creocc "TMP_K03NR2VL1SVC", -1
						NR_K01.TMP_K03NR2VL1SVC = CD_CST.V_FIS_APURACASVC
						NR_K02.TMP_K03NR2VL1SVC = CD_CFOP.V_FIS_APURACASVC
						VL_K03.TMP_K03NR2VL1SVC = PR_ALIQUOTA.V_FIS_APURACASVC
						retrieve/o "TMP_K03NR2VL1SVC"
						
						if ($status = 4)
							retrieve/x "TMP_K03NR2VL1SVC"
						endif
						VL_CONTABIL.TMP_K03NR2VL1SVC = VL_CONTABIL.TMP_K03NR2VL1SVC + VL_TOTALLIQUIDO.V_FIS_APURACASVC
						VL_BASEICMS.TMP_K03NR2VL1SVC = VL_BASEICMS.TMP_K03NR2VL1SVC + VL_BASECALC.V_FIS_APURACASVC
						;--> VSOUZA PRJ/TAR 189/007 06/09/2011
						;VL_ICMS.TMP_K03NR2VL1SVC     = VL_ICMS.TMP_K03NR2VL1SVC     + VL_BASECALC.V_FIS_APURACASVC * (PR_ALIQUOTA.V_FIS_APURACASVC/100));VL_IMPOSTO.V_FIS_APURACASVC
						VL_ICMS.TMP_K03NR2VL1SVC     = VL_ICMS.TMP_K03NR2VL1SVC     + VL_IMPOSTO.V_FIS_APURACASVC
						;-------------------------------------->
					
					endif
				endif
				setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
			endwhile

; -> rodrigo - PRJ 175 TAR 245 - 07/10/2011
			clear/e "F_FIS_REDZASVC"
			CD_EMPRESA.F_FIS_REDZASVC/init 	= CD_EMPRESA.F_FIS_REDZMSVC
			NR_ECF.F_FIS_REDZASVC/init 		= NR_ECF.F_FIS_REDZMSVC
			DT_EMISSAO.F_FIS_REDZASVC/init 	= DT_EMISSAO.F_FIS_REDZMSVC
			retrieve/e "F_FIS_REDZASVC"
			if($status >= 0)
				setocc "F_FIS_REDZASVC", -1
				setocc "F_FIS_REDZASVC", 1
				while($status >= 0)
					if(CD_SITALIQ.F_FIS_REDZASVC != "CANC")|(CD_SITALIQ.F_FIS_REDZASVC != "DESC") & %\
						(CD_SITALIQ.F_FIS_REDZASVC != "F") & (CD_SITALIQ.F_FIS_REDZASVC != "S") & %\
						   (CD_SITALIQ.F_FIS_REDZASVC != "I") & (CD_SITALIQ.F_FIS_REDZASVC != "N")

						call achaNumero(CD_SITALIQ.F_FIS_REDZASVC, vPrAliq)
						if ($procerror)
							$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
					else
						vPrAliq = 0
					endif

					vTotalAliquota 	= 0
					vVlMaior 			= 0
					vPosMaiorVl			= 0

					if(vPrAliq != 0)
						setocc "TMP_K03NR2VL1SVC", -1
						sort/e "TMP_K03NR2VL1SVC", "VL_K03.TMP_K03NR2VL1SVC"
						setocc "TMP_K03NR2VL1SVC", 1
						while($status >= 0)
							if(VL_K03.TMP_K03NR2VL1SVC = vPrAliq)
								vTotalAliquota = vTotalAliquota + VL_ICMS.TMP_K03NR2VL1SVC

								if(vVlMaior < VL_ICMS.TMP_K03NR2VL1SVC)
									vVlMaior		 	= VL_ICMS.TMP_K03NR2VL1SVC
									vPosMaiorVl 	= $curocc(TMP_K03NR2VL1SVC)
								endif

								if($next(VL_K03.TMP_K03NR2VL1SVC) != vPrAliq)
									setocc "TMP_K03NR2VL1SVC", -1
								endif
							endif

							setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) +1
						endwhile

						vImpostoRedza = VL_TOTALACUM.F_FIS_REDZASVC * (vPrAliq / 100)
						vImpostoRedza = vImpostoRedza * 100
						vImpostoRedza = vImpostoRedza[trunc]
						vImpostoRedza = vImpostoRedza / 100
						if(vTotalAliquota != vImpostoRedza)
							setocc "TMP_K03NR2VL1SVC", vPosMaiorVl
							VL_ICMS.TMP_K03NR2VL1SVC = VL_ICMS.TMP_K03NR2VL1SVC + (vImpostoRedza - vTotalAliquota)
						endif
					endif

					setocc "F_FIS_REDZASVC", $curocc(F_FIS_REDZASVC) +1
				endwhile
			endif
; <- rodrigo - PRJ 175 TAR 245 - 07/10/2011

		endif
		;----------------------------------------------------> VSOUZA - Retirado o looping na FIS_NF
		setocc "F_FIS_REDZMSVC", $curocc(F_FIS_REDZMSVC) + 1
	endwhile
	
	if ($empty("TMP_K03NR2VL1SVC"))
		return(0)
	endif
	
	setocc "TMP_K03NR2VL1SVC", 1
	while ($status >= 0)
		
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|C490"
		;Codigo da situacao tributaria.
		call convNumeric(nr_k01.tmp_k03nr2vl1svc, 3, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Codigo fiscal de operacao e prestacao.
		call convNumeric(nr_k02.tmp_k03nr2vl1svc, 4, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

		;Aliquota do ICMS.
		if (vl_k03.tmp_k03nr2vl1svc > 0)
			$vlAux$ = vl_k03.tmp_k03nr2vl1svc
			vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
		else
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
		endif
		;Parcela correspondente ao valor contabil referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_contabil.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_baseicms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_icms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Codigo da observacao do lancamento fiscal.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
		
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "C490"
		ds_registro.sis_arquivosvc = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("C490")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
	endwhile
	clear/e "TMP_K03NR2VL1SVC"
	
	return(0)
End ;operation gerarEFDBlocoCRegC490.


;------------------------------------------------;
partner operation gerarEFDBlocoCRegC495          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, viParams, voParams, vStrAux, vFisTipi, vNumericAux
		numeric vPrAliq, vVlCancelamento, vVlDesconto, vVlBaseCalcIcms
		numeric vVlIcms, vVlSaidaIsenta, vVlSaidaNaoInc, vVlSubTrib
		date    vDtAux
	endvariables
	
	clear/e "TMP_NR10SVC"
	clear/e "F_FIS_REDZMSVC"
	cd_empresa.f_fis_redzmsvc/init    = $item("CD_EMPRESA", $parametro$)
	dt_emissao.f_fis_redzmsvc/init    = $item("DT_PERIODO", $parametro$)
;	tp_moddctofiscal.fis_nfsvc/init = 02 ;"2·;2D"
	retrieve/e "F_FIS_REDZMSVC"
	if ($status < 0)
		return(0)
	endif
	
	setocc "F_FIS_REDZMSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C495 / %%nr_ecf.f_fis_redzmsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		
		viParams = ""
		voParams = ""
		;;ICJ [PROJ/TAR 170/2] (17/06/2010)	
		putitem/id viParams, "CD_EMPECF", CD_EMPRESA.F_FIS_REDZMSVC
		putitem/id viParams, "NR_ECF", 	  NR_ECF.F_FIS_REDZMSVC
		putitem/id viParams, "NM_CARREGATABELA", "FIS_NFECF"
		activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			clear/e "FIS_NFSVC"
			CD_EMPFAT.fis_nfsvc/init = $item("CD_EMPFAT",voParams)
			nr_fatura.fis_nfsvc/init = $item("NR_FATURA",voParams)
			dt_fatura.fis_nfsvc/init = $item("DT_FATURA",voParams)
			retrieve/e "FIS_NFSVC"
			if ($status >= 0)
				;CFC: 25/02/2010
				clear/e "FIS_NFITEMSVC"
				CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
				nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
				dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
				retrieve/e "FIS_NFITEMSVC"
				;if (!$empty("FIS_NFITEMSVC")) & ($item("UF_ORIGEM",$xlplemp$) = "BA")
				;
				if ($status >= 0) & ($item("UF_ORIGEM",$xlplemp$) = "BA")
					setocc "FIS_NFITEMSVC", 1
					while ($status >= 0)
						if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
							setocc "FIS_NFITEMPROSVC", 1
							creocc "TMP_NR10SVC", -1
							if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
								nr_geral.tmp_nr10svc = cd_produto.fis_nfitemsvc
							else
								nr_geral.tmp_nr10svc = cd_produto.fis_nfitemprosvc
							endif
							retrieve/o "TMP_NR10SVC"
							if ($status = 4)
								retrieve/x "TMP_NR10SVC"
							else
								ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
								ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
								if (cd_tipi.fis_nfitemsvc = "")
									if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
										;Se for serviço não tem ncm
									else
										clear/e "PRD_PRODUTOSVC"
										cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
										retrieve/e "PRD_PRODUTOSVC"
										if ($status >= 0)
											if (cd_tipi.prd_produtosvc != "")
												; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
												vFisTipi = ""
												viParams = ""
												voParams = ""
												putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
												activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
												if ($procerror)
													$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
													return(-1)
												elseif ($status < 0)
													$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
													return(-1)
												endif
												if (voParams != "")
													vFisTipi = voParams
													vStrAux = $item("CD_TIPI",vFisTipi)
													vStrAux = $replace(vStrAux, 1, ".","",-1)
													cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
												endif
												; --\-<@
											endif    
										endif
									endif
								else
									cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
									cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
								endif
							endif
							
							ds_produto.tmp_nr10svc   = ds_produto.fis_nfitemsvc
							qt_acumulada.tmp_nr10svc = qt_acumulada.tmp_nr10svc + qt_faturado.fis_nfitemsvc
							cd_especie.tmp_nr10svc   = cd_especie.fis_nfitemsvc
							vl_acumulado.tmp_nr10svc = vl_acumulado.tmp_nr10svc + vl_totalliquido.fis_nfitemsvc
							vl_desconto.tmp_nr10svc  = vl_desconto.tmp_nr10svc  + vl_totaldesc.fis_nfitemsvc
							
							clear/e "FIS_NFITEMIMPSVC"
							CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
							nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
							dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
							nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
							cd_imposto.fis_nfitemimpsvc/init = 1 ;ICMS
							retrieve/e "FIS_NFITEMIMPSVC"
							if ($status < 0)
								clear/e "FIS_NFITEMIMPSVC"
							endif
							vl_baseicms.tmp_nr10svc    = vl_baseicms.tmp_nr10svc    + vl_basecalc.fis_nfitemimpsvc
							pr_aliquota.tmp_nr10svc    = pr_aliquota.fis_nfitemimpsvc
							vl_icms.tmp_nr10svc        = vl_icms.tmp_nr10svc        + vl_imposto.fis_nfitemimpsvc[round,2]
							vl_saidaisenta.tmp_nr10svc = vl_saidaisenta.tmp_nr10svc + vl_isento.fis_nfitemimpsvc
							vl_saidanaoinc.tmp_nr10svc = vl_saidanaoinc.tmp_nr10svc + vl_outro.fis_nfitemimpsvc
							
							clear/e "FIS_NFITEMIMPSVC"
							CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
							nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
							dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
							nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
							cd_imposto.fis_nfitemimpsvc/init = 2 ;Substituicao tributaria.
							retrieve/e "FIS_NFITEMIMPSVC"
							if ($status < 0)
								clear/e "FIS_NFITEMIMPSVC"
							endif
							vl_subtrib.tmp_nr10svc   = vl_subtrib.tmp_nr10svc   + vl_imposto.fis_nfitemimpsvc[round,2]
						endif
						
						discard "FIS_NFITEMSVC"
						if ($status = 0)
							$status = -1
						endif
						;setocc "FIS_NFITEMSVC", $curocc("FIS_NFITEMSVC") + 1
					endwhile
				endif    
			endif
		endif    
		
		setocc "F_FIS_REDZMSVC", $curocc(F_FIS_REDZMSVC) + 1
	endwhile
	
	if ($empty("TMP_NR10SVC"))
		return(0)
	endif
	
	setocc "TMP_NR10SVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C495 / %%nr_geral.tmp_nr10svc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|C495"
		;Aliquota do ICMS.
		if (pr_aliquota.tmp_nr10svc > 0)
			$vlAux$ = pr_aliquota.tmp_nr10svc
			vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
		else
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
		endif
		;Codigo do item.
		call convNumeric(nr_geral.tmp_nr10svc, 9, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		
		creocc "F_TMP_DS40SVC", -1
		DS_40.F_TMP_DS40SVC = nr_geral.tmp_nr10svc

		if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
			clear/e "PRD_PRDCONVMESVC"
			CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
			retrieve/e "PRD_PRDCONVMESVC"
			if ($status >= 0)
				$instancehandle->totalizarQtdTipoRegistro("0220")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
		endif

		retrieve/o "F_TMP_DS40SVC"
		if ($status = 4)
			retrieve/x "F_TMP_DS40SVC"
			vCdEspecie = ds_especie.F_TMP_DS40SVC
		else
			clear/e "PRD_PRODUTOSVC"
			cd_produto.prd_produtosvc/init = nr_geral.tmp_nr10svc
			retrieve/e "PRD_PRODUTOSVC"
			if ($status >= 0)
				ds_produto.F_TMP_DS40SVC = ds_produto.tmp_nr10svc
				ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
				vCdEspecie = cd_especie.prd_produtosvc
				if (cd_tipi.prd_produtosvc != "")
					; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
					vFisTipi = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
					activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vFisTipi = voParams
						vStrAux = $item("CD_TIPI",vFisTipi)
						vStrAux = $replace(vStrAux, 1, ".","",-1)	
						cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
					endif
					; --\-<@
				endif
			endif

			creocc "TMP_NRDSSVC", -1
			nr_geral.tmp_nrdssvc = 1
			ds_geral.tmp_nrdssvc = vCdEspecie
			retrieve/o "TMP_NRDSSVC"
			if ($status = 4)
				retrieve/x "TMP_NRDSSVC"
			endif
		endif
		
		;Quantidade acumulada do item.
		vNumericAux = qt_acumulada.tmp_nr10svc
		call editarNr(11, 3, vNumericAux, vNumericAux)
		call convValorString(3,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Quantidade cancelada acumulada no caso de cancelamento parcial do item.
		vNumericAux = 0
		call editarNr(11, 3, vNumericAux, vNumericAux)
		call convValorString(3,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		vStringAux = "|%%vCdEspecie"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		
		;Valor acumulado do item.
		vNumericAux = vl_acumulado.tmp_nr10svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado dos descontos.
		vNumericAux = vl_desconto.tmp_nr10svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado dos cancelamentos.
		vNumericAux = 0
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado dos acrescimos.
		vNumericAux = 0
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado da base de calculo do ICMS.
		vNumericAux = vl_baseicms.tmp_nr10svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado do ICMS.
		vNumericAux = vl_icms.tmp_nr10svc[round,2]
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado das saidas isentas do ICMS.
		vNumericAux = vl_saidaisenta.tmp_nr10svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado das saidas sob nao-incidencia pelo ICMS.
		vNumericAux = vl_saidanaoinc.tmp_nr10svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado das saidas de mercadorias adquiridas com substituicao tributaria do ICMS.
		vNumericAux = vl_subtrib.tmp_nr10svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
		
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "C495"
		ds_registro.sis_arquivosvc = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("C495")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		setocc "TMP_NR10SVC", $curocc(TMP_NR10SVC) + 1
	endwhile
	
	return(0)
End ;operation gerarEFDBlocoCRegC495.


;-------------------------------------------------------------;
partner operation gerarEFDBlocoCRegC500                       ;
	;-------------------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vGlbLogradouro, vPesCliente, vNumericAux
		numeric vCdEstado
		date    vDtAux
	endvariables
	
	;;ICJ [PROJ/TAR 175/70] (01/03/2011)
;	if ($inConsideraDtEmisNfSai$ = <TRUE>)
;		clear/e "FIS_NFSVC"
;		
;		;busca as NFs de saída pela data de emissão		
;		clear/e "FIS_S_NFSVC"
;		CD_EMPFAT.FIS_S_NFSVC/init   = $item("CD_EMPRESA", $parametro$)
;		DT_EMISSAO.FIS_S_NFSVC/init  = $item("DT_PERIODO", $parametro$)
;		TP_SITUACAO.FIS_S_NFSVC/init = "E·|C"
;		tp_moddctofiscal.fis_nfsvc/init = 06
;		TP_OPERACAO.FIS_NFSVC/init	= "S"
;		retrieve/e "FIS_S_NFSVC"
;		if ($status >= 0)
;			setocc "FIS_S_NFSVC",1
;			while ($status >= 0)
;				creocc "FIS_NFSVC", -1
;				CD_EMPRESA.FIS_NFSVC = CD_EMPRESA.FIS_S_NFSVC
;				NR_FATURA.FIS_NFSVC  = NR_FATURA.FIS_S_NFSVC
;				DT_FATURA.FIS_NFSVC  = DT_FATURA.FIS_S_NFSVC
;				retrieve/o "FIS_NFSVC"
;				if ($status = -7)
;					retrieve/x "FIS_NFSVC"
;				endif
;				setocc "FIS_S_NFSVC", $curocc("FIS_S_NFSVC") + 1
;			endwhile
;		endif
;		clear/e "FIS_S_NFSVC"
;
;		clear/e "FIS_S_NFSVC"
;		CD_EMPFAT.FIS_S_NFSVC/init   = $item("CD_EMPRESA", $parametro$)
;		DT_SAIDAENTRADA.FIS_S_NFSVC/init  = $item("DT_PERIODO", $parametro$)
;		TP_SITUACAO.FIS_S_NFSVC/init = "E·|C"
;		tp_moddctofiscal.fis_nfsvc/init = 06
;		TP_OPERACAO.FIS_NFSVC/init	= "E"
;		retrieve/e "FIS_S_NFSVC"
;		if ($status >= 0)
;			setocc "FIS_S_NFSVC",1
;			while ($status >= 0)
;				creocc "FIS_NFSVC", -1
;				CD_EMPRESA.FIS_NFSVC = CD_EMPRESA.FIS_S_NFSVC
;				NR_FATURA.FIS_NFSVC  = NR_FATURA.FIS_S_NFSVC
;				DT_FATURA.FIS_NFSVC  = DT_FATURA.FIS_S_NFSVC
;				retrieve/o "FIS_NFSVC"
;				if ($status = -7)
;					retrieve/x "FIS_NFSVC"
;				endif
;				setocc "FIS_S_NFSVC", $curocc("FIS_S_NFSVC") + 1
;			endwhile
;		endif
;
;	else
		clear/e "FIS_NFSVC"
		CD_EMPFAT.fis_nfsvc/init       = $item("CD_EMPRESA", $parametro$)
		;------ WMC - PRJ 175 TAR 052 - 08/02/2011
		DT_SAIDAENTRADA.FIS_NFSVC/init  = $item("DT_PERIODO", $parametro$)
		;------//------//------
		tp_situacao.fis_nfsvc/init      = "E"
		TP_OPERACAO.FIS_NFSVC/init	= "E"
		tp_moddctofiscal.fis_nfsvc/init = 06
		retrieve/e "FIS_NFSVC"
		if ($status < 0)
			return(0)
		endif
;	endif
	;;

	setocc "FIS_NFSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C500 / %%nr_fatura.fis_nfsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		;CFC: 25/02/2010 - COMENTADO A PEDIDO DO DEUSDETE
		;if ($item("UF_ORIGEM",$xlplemp$) = "") | ($item("UF_ORIGEM",$xlplemp$) = ds_siglaestado.fis_nfremdessvc)
			vDsConteudo = ""
			;1 - Texto fixo.
			vDsConteudo = "|C500"
			
			;-- MAD [Proj/Tar.061/526] - 18/12/2008
			;2 - Tipo de operacao.
			if (TP_OPERACAO.FIS_NFSVC= "E")
				vStringAux = "|0"
			else
				vStringAux = "|1"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;;
			
			if (tp_origememissao.fis_nfsvc = "1")
				;3 - Emissao propria.
				vStringAux = "|0"
			else
				;3 - Emissao terceiros.
				vStringAux = "|1"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			
			clear/e "FIS_S_NFREMDESVC"
			CD_EMPFAT.fis_s_nfremdesvc/init = CD_EMPFAT.fis_nfsvc
			dt_fatura.fis_s_nfremdesvc/init  = dt_fatura.fis_nfsvc
			nr_fatura.fis_s_nfremdesvc/init  = nr_fatura.fis_nfsvc
			retrieve/e "FIS_S_NFREMDESVC"
			if ($status >= 0)
				
				if(TP_SITUACAO.FIS_NFSVC != "C")&(TP_SITUACAO.FIS_NFSVC != "D") ; rodrigo - PRJ 170 TAR 345 - 22/08/2011
					;-- MAD [Proj/Tar.061/526] - 18/12/2008
					creocc "F_TMP_NR09SVC", -1
					nr_geral.f_tmp_nr09svc = cd_pessoa.fis_s_nfremdesvc
					retrieve/o "F_TMP_NR09SVC"
					if ($status = 4)
						retrieve/x "F_TMP_NR09SVC"
					endif
					;;
				
					nm_cliente.f_tmp_nr09svc = nm_nome.fis_s_nfremdesvc
					tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_s_nfremdesvc
					if (tp_pessoa.fis_s_nfremdesvc = "F")
						nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_s_nfremdesvc
					else
						nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_s_nfremdesvc
					endif
					nr_rginscr.f_tmp_nr09svc    = nr_rginscrest.fis_s_nfremdesvc
					; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
					vPesCliente = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_s_nfremdesvc
					activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vPesCliente = voParams
					endif
				
					NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)
					;nr_suframa.f_tmp_nr09svc    = nr_suframa.pes_clientesvc
					; --\-<@
					ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_s_nfremdesvc %%nm_logradouro.fis_s_nfremdesvc"
					nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_s_nfremdesvc
					nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_s_nfremdesvc
				
					if (cd_cep.fis_s_nfremdesvc != 99999999)
						; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
						vGlbLogradouro = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_CEP", cd_cep.fis_s_nfremdesvc
						activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vGlbLogradouro = voParams
						endif
					
						vCdEstado = ""
						vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
						cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
						cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
						ds_estado.f_tmp_nr09svc    = vCdEstado
						ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
					endif
				endif
			endif
			
			;4 - Codigo do participante.
			call convNumeric(cd_pessoa.fis_s_nfremdesvc, 9, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;5 - Codigo do modelo do documento fiscal.
			vNumericAux = tp_moddctofiscal.fis_nfsvc
			call convNumeric(vNumericAux, 2, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;6 - Codigo da situacao do documento fiscal.
			if (tp_situacao.fis_nfsvc = "E")
				;Nota emitida.
				vStringAux = "|00"
			else
				;Nota cancelada.
				vStringAux = "|02"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;7 - Serie do documento fiscal.
			vStringAux = cd_serie.fis_nfsvc
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;8 - Subserie do documento fiscal. neste caso vai nulo
			vDsConteudo = "%%vDsConteudo%%%|"
			;9 - Codigo de classe de consumo.
			vStringAux = $item("CD_CONSUMO_ENERGIA",$xlplemp$)
			; @>-/-- Virginia - 111/1780 - Brascol
			call convNumeric(vStringAux, 2, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			; --/-<@
			;10 - Numero do documento fiscal.
			vStringAux = nr_nf.fis_nfsvc
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;11 - Data de emissao do documento fiscal.
			;vDtAux = dt_saidaentrada.fis_nfsvc ;-- > RAR[Proj/Tar.189/250] - 28/09/2012
			vDtAux = DT_EMISSAO.FIS_NFSVC ;< --
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;12 - Data da entrada ou da saida.
			vDtAux = dt_saidaentrada.fis_nfsvc
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;13 - Valor total do documento fiscal.
			vNumericAux = vl_totalnota.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;14 - Valor total do desconto.
			vNumericAux = vl_desconto.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;15 - Valor total fornecido/consumido.
			vNumericAux = vl_totalnota.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;16 - Valor total dos servicos nao-tributados pelo ICMS.
			vNumericAux = 0
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;17 - Valor cobrado em nome de terceiros.
			vNumericAux = 0
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;18 - Valor de despesas acessorias indicadas no documento fiscal.
			vNumericAux = 0
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;19 - Valor da base de calculo do ICMS.
			vNumericAux = vl_baseicms.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;20 - Valor do ICMS.
			vNumericAux = vl_icms.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 2 ;Substituicao tributaria.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status < 0)
				clear/e "FIS_NFIMPOSTOSVC"
			endif
			
			;21 - Valor acumulado da base de calculo do ICMS substituicao tributaria.
			vNumericAux = vl_basecalc.fis_nfimpostosvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;22 - Valor acumulado do ICMS retido por substituicao tributaria.
			vNumericAux = vl_imposto.fis_nfimpostosvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;23 - Codigo da informacao complementar do documento fiscal.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 6 ;PIS.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status < 0)
				clear/e "FIS_NFIMPOSTOSVC"
			endif
			
			;24 - Valor do PIS.
			vNumericAux = vl_imposto.fis_nfimpostosvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 5 ;COFINS.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status < 0)
				clear/e "FIS_NFIMPOSTOSVC"
			endif
			
			;25  -Valor do COFINS.
			vNumericAux = vl_imposto.fis_nfimpostosvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

			;26 - TP_LIGACAO.
			vNumericAux = $item("CD_TIPO_LIGACAO",$xlplemp$)
			call convNumeric(vNumericAux, 1, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

			;27 - COD_GRUPO_TENSAO.
			vNumericAux = $item("CD_GRUPO_TENSAO",$xlplemp$)
			call convNumeric(vNumericAux, 2, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"


			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C500"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("C500")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			;Itens do documento nota fiscal/energia eletrica.
			if (TP_OPERACAO.FIS_NFSVC = "S")
				;CFC: 25/02/2010
				clear/e "FIS_NFITEMSVC"
				CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
				dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
				nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
				retrieve/e "FIS_NFITEMSVC"
				;
				$instancehandle->gerarEFDBlocoCRegC510($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
			;Registro analitico do documento nota fiscal/energia eletrica.
			$instancehandle->gerarEFDBlocoCRegC590($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		;endif
		
		discard "FIS_NFSVC"
		if ($status = 0)
			$status = -1
		endif
		;setocc "FIS_NFSVC", $curocc(FIS_NFSVC) + 1
	endwhile
	clear/e "FIS_NFSVC"
	
	return(0)
End ;operation gerarEFDBlocoCRegC500.


;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC510              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, viParams, voParams, vStrAux, vNumericAux
		numeric vQtParcela, vContador, vCdEstado, vVlBaseIcms, vVlIcms
		string  vFisCfop, vFisTipi, vGlbLogradouro, vPesCliente
	endvariables
	
	if ($empty("FIS_NFITEMSVC"))
		return(0)
	endif
	
	setocc "FIS_NFITEMSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C510 / %%cd_produto.fis_nfitemsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
			setocc "FIS_NFITEMPROSVC", 1
			vContador = vContador + 1
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|C510"
			;Numero sequencial do item no documento fiscal.
			vStringAux = "|%%vContador"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Codigo do item.
			call convNumeric(cd_produto.fis_nfitemprosvc, 9, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			creocc "F_TMP_DS40SVC", -1
			if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
			else
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
			endif

			if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
				clear/e "PRD_PRDCONVMESVC"
				CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "PRD_PRDCONVMESVC"
				if ($status >= 0)
					$instancehandle->totalizarQtdTipoRegistro("0220")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			retrieve/o "F_TMP_DS40SVC"
			if ($status = 4)
				retrieve/x "F_TMP_DS40SVC"
				vCdEspecie = ds_especie.F_TMP_DS40SVC
			else
				ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
				ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
				vCdEspecie = cd_especie.fis_nfitemsvc
				if (cd_tipi.fis_nfitemsvc = "")
					if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
						;se for serviço não vai ter ncm
					else
						clear/e "PRD_PRODUTOSVC"
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
						retrieve/e "PRD_PRODUTOSVC"
						if ($status >= 0)
							if (CD_ESPECIE.FIS_NFITEMSVC = "")
								ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
								vCdEspecie = cd_especie.prd_produtosvc
							endif
							if (cd_tipi.prd_produtosvc != "")
								; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
								vFisTipi = ""
								viParams = ""
								voParams = ""
								putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
								activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
								if ($procerror)
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									return(-1)
								endif
								if (voParams != "")
									vFisTipi = voParams
									vStrAux = $item("CD_TIPI",vFisTipi)
									vStrAux = $replace(vStrAux, 1, ".","",-1)		
									cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
								endif
								; --\-<@
							endif
						endif
					endif
				else
					cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
					cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
				endif
			
				creocc "TMP_NRDSSVC", -1
				nr_geral.tmp_nrdssvc = 1
				ds_geral.tmp_nrdssvc = vCdEspecie
				retrieve/o "TMP_NRDSSVC"
				if ($status = 4)
					retrieve/x "TMP_NRDSSVC"
				endif
			endif

			;-- MAD [Proj/Tar.170/263] - 27/05/2011
			if (DS_40.F_TMP_DS40SVC != "")
				clear/e "FIS_NFITEMUNSVC"
				CD_EMPRESA.FIS_NFITEMUNSVC/init = CD_EMPRESA.FIS_NFITEMSVC
				NR_FATURA.FIS_NFITEMUNSVC/init  = NR_FATURA.FIS_NFITEMSVC
				DT_FATURA.FIS_NFITEMUNSVC/init  = DT_FATURA.FIS_NFITEMSVC
				NR_ITEM.FIS_NFITEMUNSVC/init    = NR_ITEM.FIS_NFITEMSVC
				CD_PRODUTO.FIS_NFITEMUNSVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "FIS_NFITEMUNSVC"
				if ($status >= 0) & (CD_ESPECIE.FIS_NFITEMUNSVC != vCdEspecie)
					vCdEspecie = CD_ESPECIE.FIS_NFITEMUNSVC
	
					clear/e "GTT_DS01SVC"
					creocc "GTT_DS01SVC", -1
					NR_GERAL.GTT_DS01SVC = DS_40.F_TMP_DS40SVC
					DS_GERAL.GTT_DS01SVC = vCdEspecie
					retrieve/o "GTT_DS01SVC"
					if ($status = -7)
						retrieve/x "GTT_DS01SVC"
					endif
					QT_CONVERSAO.GTT_DS01SVC = QT_CONVERSAO.FIS_NFITEMUNSVC
					$collhandle("GTT_DS01SVC")->Salvar()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif

					creocc "TMP_NRDSSVC", -1
					nr_geral.tmp_nrdssvc = 1
					ds_geral.tmp_nrdssvc = vCdEspecie
					retrieve/o "TMP_NRDSSVC"
					if ($status = 4)
						retrieve/x "TMP_NRDSSVC"
					endif

					creocc "TMP_DS40SVC", -1
					DS_40.TMP_DS40SVC = "0220"
					retrieve/o "TMP_DS40SVC"
					if ($status = -7)
						retrieve/x "TMP_DS40SVC"
					endif
				endif
			endif
			;;
			
			creocc "TMP_NR08SVC", -1
			nr_08.tmp_nr08svc = cd_cfop.fis_nfitemsvc
			retrieve/o "TMP_NR08SVC"
			if ($status = 4)
				retrieve/x "TMP_NR08SVC"
			else
				; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
				vFisCfop = ""
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_CFOP", cd_cfop.fis_nfitemsvc
				activate "FISSVCO032".carregaFisCfop($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				if (voParams != "")
					vFisCfop = voParams
					ds_cfop.tmp_nr08svc = $item("DS_CFOP",vFisCfop)
				endif
				; --\-<@            
			endif
			
			;Codigo de classificacao do item.
			vStringAux = "|00"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Quantidade do item.
			vNumericAux = qt_faturado.fis_nfitemsvc
			call editarNr(11, 3, vNumericAux, vNumericAux)
			call convValorString(3,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Unidade do item.
			vStringAux = "|%%vCdEspecie"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			
			;Valor do item.
			vNumericAux = vl_totalliquido.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do desconto.
			vNumericAux = vl_totaldesc.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da situacao tributaria.
			call convNumeric(cd_cst.fis_nfitemsvc, 3, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo fiscal de operacao e prestacao.
			call convNumeric(cd_cfop.fis_nfitemsvc, 4, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;ICMS.
			clear/e "FIS_NFITEMIMPSVC"
			CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 1
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			
			;Valor da base de calculo do ICMS.
			vNumericAux = vl_basecalc.fis_nfitemimpsvc + vVlBaseIcms
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Aliquota do ICMS.
			if (pr_aliquota.fis_nfitemimpsvc > 0)
				$vlAux$ = pr_aliquota.fis_nfitemimpsvc
				vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
			else
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
			endif
			;Valor do ICMS.
			vNumericAux = vl_imposto.fis_nfitemimpsvc + vVlIcms
			vNumericAux = vNumericAux[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			vVlBaseIcms = ""
			vVlIcms     = ""
			
			;Sustituicao tributaria.
			clear/e "FIS_NFITEMIMPSVC"
			CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 2
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			
			;Valor da base de calculo referente a substituicao tributaria.
			vNumericAux = vl_basecalc.fis_nfitemimpsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Aliquota do ICMS da substituicao tributaria.
			if (pr_aliquota.fis_nfitemimpsvc > 0)
				$vlAux$ = pr_aliquota.fis_nfitemimpsvc
				vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
			else
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
			endif
			;Valor do ICMS referente a substituicao tributaria.
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round, 2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Indicador do tipo de receita.
			if (tp_origememissao.fis_nfsvc = "1")
				;Emissao propria.
				vStringAux = "|0"
			else
				;Emissao terceiros.
				vStringAux = "|1"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Codigo do participante receptor da receita, terceiro da operacao.
			call convNumeric(cd_pessoa.fis_s_nfremdesvc, 9, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
				if(TP_SITUACAO.FIS_NFSVC != "C")&(TP_SITUACAO.FIS_NFSVC != "D") ; rodrigo - PRJ 170 TAR 345 - 22/08/2011
					creocc "F_TMP_NR09SVC", -1
					nr_geral.f_tmp_nr09svc = cd_pessoa.fis_s_nfremdesvc
					retrieve/o "F_TMP_NR09SVC"
					if ($status = 4)
						retrieve/x "F_TMP_NR09SVC"
					endif
				
					nm_cliente.f_tmp_nr09svc = nm_nome.fis_s_nfremdesvc
					tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_s_nfremdesvc
					if (tp_pessoa.fis_s_nfremdesvc = "F")
						nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_s_nfremdesvc
					else
						nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_s_nfremdesvc
					endif
					nr_rginscr.f_tmp_nr09svc    = nr_rginscrest.fis_s_nfremdesvc
					; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
					vPesCliente = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_s_nfremdesvc
					activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vPesCliente = voParams
					endif

					NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)
					;nr_suframa.f_tmp_nr09svc    = nr_suframa.pes_clientesvc
					; --\-<@
					ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_s_nfremdesvc %%nm_logradouro.fis_s_nfremdesvc"
					nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_s_nfremdesvc
					nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_s_nfremdesvc
				
					if (cd_cep.fis_s_nfremdesvc != 99999999)    
						; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
						vGlbLogradouro = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_CEP", cd_cep.fis_s_nfremdesvc
						activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vGlbLogradouro = voParams
						endif

						vCdEstado = ""
						vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
						cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
						cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
						ds_estado.f_tmp_nr09svc    = vCdEstado
						ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
					endif
				endif
			endif        
			;PIS.
			clear/e "FIS_NFITEMIMPSVC"
			CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 6
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			
			;Valor do PIS.
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;COFINS.
			clear/e "FIS_NFITEMIMPSVC"
			CD_EMPFAT.fis_nfitemimpsvc/init = CD_EMPFAT.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 5
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			
			;Valor da COFINS.
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da conta analitica contabil debitada/creditada.
			vStringAux = $item("CD_CONTACONTABIL", $parametro$)

			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C510"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("C510")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		
		discard "FIS_NFITEMSVC"
		if ($status = 0)
			$status = -1
		endif
		;setocc "FIS_NFITEMSVC", $curocc(FIS_NFITEMSVC) + 1
	endwhile
	
	return(0)
End ;operation gerarEFDBlocoCRegC510.


;----------------------------------------------------;
partner operation gerarEFDBlocoCRegC590              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams

	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux, vCdCst
		numeric vVlBaseCalc, vVlIcmsSubst, vTotalBaseST, vTotalImpostoST
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C590", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	clear/e "TMP_K03NR2VL1SVC"
	
	;ICMS.
	clear/e "V_FIS_APURACASVC"
	CD_EMPFAT.v_fis_apuracasvc/init       = CD_EMPFAT.fis_nfsvc
	nr_fatura.v_fis_apuracasvc/init        = nr_fatura.fis_nfsvc
	dt_fatura.v_fis_apuracasvc/init        = dt_fatura.fis_nfsvc
	nr_nf.v_fis_apuracasvc/init            = nr_nf.fis_nfsvc
	cd_serie.v_fis_apuracasvc/init         = cd_serie.fis_nfsvc
	dt_emissao.v_fis_apuracasvc/init       = dt_emissao.fis_nfsvc
	dt_saidaentrada.v_fis_apuracasvc/init  = dt_saidaentrada.fis_nfsvc
	tp_operacao.v_fis_apuracasvc/init      = tp_operacao.fis_nfsvc
	tp_origememissao.v_fis_apuracasvc/init = tp_origememissao.fis_nfsvc
	cd_imposto.v_fis_apuracasvc/init       = 1
	tp_situacao.v_fis_apuracasvc/init      = "E"  
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", 1
		while ($status >= 0)
			
			creocc "TMP_K03NR2VL1SVC", -1
			nr_k01.tmp_k03nr2vl1svc = cd_cst.v_fis_apuracasvc
			nr_k02.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
			vl_k03.tmp_k03nr2vl1svc = pr_aliquota.v_fis_apuracasvc
			retrieve/o "TMP_K03NR2VL1SVC"
			if ($status = 4)
				retrieve/x "TMP_K03NR2VL1SVC"
			endif
			vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_totalliquido.v_fis_apuracasvc
			vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.v_fis_apuracasvc
			vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.v_fis_apuracasvc
			
			;CFC: 27/04/2010  - Incluido a rotina conferme pedido do Renan 
			if (cd_imposto.v_fis_apuracasvc = 1)
				if (cd_cst.v_fis_apuracasvc = "020") | (cd_cst.v_fis_apuracasvc = "070")
					if (vl_isento.v_fis_apuracasvc > 0)
						vl_outroicms.tmp_k03nr2vl1svc = vl_outroicms.tmp_k03nr2vl1svc + vl_isento.v_fis_apuracasvc
					else
						vl_outroicms.tmp_k03nr2vl1svc = vl_outroicms.tmp_k03nr2vl1svc + vl_outro.v_fis_apuracasvc
					endif
				endif
			endif

			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
		
		if ($next(nr_nf.fis_nfsvc)        != nr_nf.fis_nfsvc)     | %\
			($next(cd_pessoa.fis_nfsvc)       != cd_pessoa.fis_nfsvc) | %\
			($next(dt_saidaentrada.fis_nfsvc) != dt_saidaentrada.fis_nfsvc)
		
			vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_despacessor.fis_nfsvc + vl_frete.fis_nfsvc + vl_seguro.fis_nfsvc
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 1 ;ICMS.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status >= 0)
				setocc "FIS_NFIMPOSTOSVC", 1
				while ($status >= 0)
					vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.fis_nfimpostosvc
					vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.fis_nfimpostosvc
				
					setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
				endwhile
			endif
		endif
	endif
	clear/e "V_FIS_APURACASVC"

	if ($empty("TMP_K03NR2VL1SVC"))
		return(0)
	endif

	;-- MAD [Proj/Tar.170/494] - 24/07/2012
	;Soma o total de subst. tributária da NF
	vTotalBaseST    = 0
	vTotalImpostoST = 0

	clear/e "V_FIS_APURACASVC"
	CD_EMPFAT.V_FIS_APURACASVC/init        = CD_EMPFAT.FIS_NFSVC
	NR_FATURA.V_FIS_APURACASVC/init        = NR_FATURA.FIS_NFSVC
	DT_FATURA.V_FIS_APURACASVC/init        = DT_FATURA.FIS_NFSVC
	NR_NF.V_FIS_APURACASVC/init            = NR_NF.FIS_NFSVC
	DT_EMISSAO.V_FIS_APURACASVC/init       = DT_EMISSAO.FIS_NFSVC
	DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = DT_SAIDAENTRADA.FIS_NFSVC
	TP_OPERACAO.V_FIS_APURACASVC/init      = TP_OPERACAO.FIS_NFSVC
	TP_ORIGEMEMISSAO.V_FIS_APURACASVC/init = TP_ORIGEMEMISSAO.FIS_NFSVC
	CD_IMPOSTO.V_FIS_APURACASVC/init       = 2
	TP_SITUACAO.V_FIS_APURACASVc/init      = "E"  
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC",1
		while ($status >= 0)
			vTotalBaseST    = vTotalBaseST    + VL_BASECALC.V_FIS_APURACASVC
			vTotalImpostoST = vTotalImpostoST + VL_IMPOSTO.V_FIS_APURACASVC
			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
	endif
	;;

	setocc "TMP_K03NR2VL1SVC", 1
	while ($status >= 0)
	
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|C590"
		;Codigo da situacao tributaria.
		call convNumeric(nr_k01.tmp_k03nr2vl1svc, 3, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		vCdCst = vStringConv
		;Codigo fiscal de operacao e prestacao.
		call convNumeric(nr_k02.tmp_k03nr2vl1svc, 4, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Aliquota do ICMS.
		if (vl_k03.tmp_k03nr2vl1svc > 0)
			$vlAux$ = vl_k03.tmp_k03nr2vl1svc
			vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
		else
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
		endif
		;Parcela correspondente ao valor contabil referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_contabil.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_baseicms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_icms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	
		;Sustituicao tributaria.
		;-- MAD [Proj/Tar.170/494] - 24/07/2012
		;;;ICJ [PROJ/TAR 61/784] (24/03/2010)
		;vVlBaseCalc = 0
		;vVlIcms 	= 0
		;vVlOutro	= 0
		;clear/e "V_FIS_APURACASVC"
		;CD_EMPFAT.v_fis_apuracasvc/init       = CD_EMPFAT.fis_nfsvc
		;nr_fatura.v_fis_apuracasvc/init        = nr_fatura.fis_nfsvc
		;dt_fatura.v_fis_apuracasvc/init        = dt_fatura.fis_nfsvc
		;cd_empfat.v_fis_apuracasvc/init        = cd_empfat.fis_nfsvc
		;nr_nf.v_fis_apuracasvc/init            = nr_nf.fis_nfsvc
		;cd_serie.v_fis_apuracasvc/init         = cd_serie.fis_nfsvc
		;dt_emissao.v_fis_apuracasvc/init       = dt_emissao.fis_nfsvc
		;dt_saidaentrada.v_fis_apuracasvc/init  = dt_saidaentrada.fis_nfsvc
		;tp_operacao.v_fis_apuracasvc/init      = tp_operacao.fis_nfsvc
		;tp_origememissao.v_fis_apuracasvc/init = tp_origememissao.fis_nfsvc
		;cd_imposto.v_fis_apuracasvc/init       = 2
		;tp_situacao.v_fis_apuracasvc/init      = "E"  
		;retrieve/e "V_FIS_APURACASVC"
		;if ($status >= 0)	
		;	while ($status >= 0)
		;		vVlOutro		= vVlOutro + vl_outro.v_fis_apuracasvc
		;		vVlBaseCalc 	= vVlBaseCalc + vl_basecalc.v_fis_apuracasvc
		;		vVlIcmsSubst 	= vVlIcmsSubst + vl_imposto.v_fis_apuracasvc
		;		setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		;	endwhile
		;endif
		;
		vVlBaseCalc  = 0
		vVlIcmsSubst = 0
		if ($next(NR_K01.TMP_K03NR2VL1SVC) = "")
			vVlBaseCalc  = vTotalBaseST
			vVlIcmsSubst = vTotalImpostoST
		else
			clear/e "V_FIS_APURACASVC"
			CD_EMPFAT.V_FIS_APURACASVC/init        = CD_EMPFAT.FIS_NFSVC
			NR_FATURA.V_FIS_APURACASVC/init        = NR_FATURA.FIS_NFSVC
			DT_FATURA.V_FIS_APURACASVC/init        = DT_FATURA.FIS_NFSVC
			NR_NF.V_FIS_APURACASVC/init            = NR_NF.FIS_NFSVC
			DT_EMISSAO.V_FIS_APURACASVC/init       = DT_EMISSAO.FIS_NFSVC
			DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = DT_SAIDAENTRADA.FIS_NFSVC
			TP_OPERACAO.V_FIS_APURACASVC/init      = TP_OPERACAO.FIS_NFSVC
			TP_ORIGEMEMISSAO.V_FIS_APURACASVC/init = TP_ORIGEMEMISSAO.FIS_NFSVC
			CD_IMPOSTO.V_FIS_APURACASVC/init       = 2
			TP_SITUACAO.V_FIS_APURACASVc/init      = "E"
			CD_CST.V_FIS_APURACASVC/init           = vCdCst
			CD_CFOP.V_FIS_APURACASVC/init          = NR_K02.TMP_K03NR2VL1SVC
			PR_ALIQUOTA.V_FIS_APURACASVC/init      = VL_K03.TMP_K03NR2VL1SVC
			retrieve/e "V_FIS_APURACASVC"
			if ($status >= 0)
				setocc "V_FIS_APURACASVC",1
				while ($status >= 0)
					vVlBaseCalc  = vVlBaseCalc  + VL_BASECALC.V_FIS_APURACASVC
					vVlIcmsSubst = vVlIcmsSubst + VL_IMPOSTO.V_FIS_APURACASVC
					setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
				endwhile
			endif
			vTotalBaseST    = vTotalBaseST    - vVlBaseCalc
			vTotalImpostoST = vTotalImpostoST - vVlIcmsSubst
		endif
		;;
		;Valor da base de calculo da substituicao tributaria referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vVlBaseCalc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor do ICMS da substituicao tributaria referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vVlIcmsSubst[round,2]
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor nao tributado em funcao da reducao da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		;vNumericAux = vVlOutro
		vNumericAux = vl_outroicms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Codigo da observacao do lancamento fiscal.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "C590"
		ds_registro.sis_arquivosvc = vDsConteudo
	
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("C590")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
	endwhile

	clear/e "TMP_K03NR2VL1SVC"

	return(0)

End ;operation gerarEFDBlocoCRegC590.


;-----------------------------------------------;
partner operation gerarEFDBlocoCRegC990         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C990", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|C990"
	;Quantidade total de linhas do bloco C.
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	vStringAux = "|%%$nrLinhaBloco$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "C990"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("C990")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoCRegC990.


;---------------------------------------------------;
partner operation gerarEFDBlocoD                    ;
	;---------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	$nrLinhaBloco$ = ""
	;Abertura do bloco D.
	$instancehandle->gerarEFDBlocoDRegD001($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	if ($item("IN_BLOCOD", $parametro$) = <TRUE>)
		;Documento - nota fiscal(codigo 07 e 08).
		$instancehandle->gerarEFDBlocoDRegD100($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		;-- MAD [Proj/Tar.061/875] - 29/09/2010
		;NF de entrada/saida de serviço de comunicação e telecomunicação (codigo 21 e 22).
		;if ($item("TP_PERFIL", $parametro$) != "B") ;;ICJ [PROJ/TAR 175/41] (20/01/2011)
			$instancehandle->gerarEFDBlocoDRegD500($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		;endif

		;NF de saida de serviço de comunicação e telecomunicação (codigo 21 e 22).
		if ($item("TP_PERFIL", $parametro$) != "A")
			$instancehandle->gerarEFDBlocoDRegD600($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		;;
	endif
	
	;Encerramento do bloco D.
	$instancehandle->gerarEFDBlocoDRegD990($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoD.


;-----------------------------------------------;
partner operation gerarEFDBlocoDRegD001         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		boolean vInMovimento
	endvariables
	
	;Verificando se ha movimento.
	vInMovimento = <FALSE>

	clear/e "FIS_NFSVC"
	CD_EMPFAT.fis_nfsvc/init       = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init       = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init  = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	tp_situacao.fis_nfsvc/init      = "E·;C"
	tp_moddctofiscal.fis_nfsvc/init = "07·;08·;09·;10·;11·;21·;22·;26"
	retrieve/e "FIS_NFSVC"
	if ($status >= 0)
        ;CFC: 25/02/2010 - COMENTADO A PEDIDO DO DEUSDETE
		;if ($item("UF_ORIGEM",$xlplemp$) != "")
		;	setocc "FIS_NFSVC", 1
		;	while ($status >= 0)
		;		if ($item("UF_ORIGEM",$xlplemp$) = ds_siglaestado.fis_nfremdessvc)
		;			vInMovimento = <TRUE>
		;			break
		;		endif
		;		
		;		setocc "FIS_NFSVC", $curocc(FIS_NFSVC) + 1
		;	endwhile
		;else
			vInMovimento = <TRUE>
		;endif
		;
	endif
	clear/e "FIS_NFSVC"
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D001", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|D001"
	;Indicador de movimento.
	if (vInMovimento = <TRUE>)
		vStringAux = "|0"
	else
		vStringAux = "|1"
	endif
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "D001"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("D001")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoDRegD001.


;----------------------------------------------------;
partner operation gerarEFDBlocoDRegD100              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams

	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vGlbLogradouro, vPesCliente, vNumericAux
		numeric vCdEstado
		date    vDtAux
		Boolean inMovtoPeriodo
	endvariables
	
	inMovtoPeriodo = <FALSE>

	clear/e "FIS_NFSVC"
	CD_EMPFAT.fis_nfsvc/init       = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init       = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init  = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	tp_situacao.fis_nfsvc/init      = "E·;C"
	tp_operacao.fis_nfsvc/init      = "S"   ;SANDRA/CFC PRJ/TRF 175/219 10/08/2011 - Validar o parametro $inConsideraDtemisNfsai$ apenas nas saidas
	; @>-/-- Virginia - SC 36635 - 22/08/2011
	;tp_moddctofiscal.fis_nfsvc/init = "07·;08·;09·;10·;11·;26"
	tp_moddctofiscal.fis_nfsvc/init = "07·;08·;09·;10·;11·;26·;27·;57"
	; --\-<@
	retrieve/e "FIS_NFSVC"
	;if ($status < 0)
	;	return(0)
	;endif
	
	if ($status >= 0)
		inMovtoPeriodo = <TRUE>
		setocc "FIS_NFSVC", 1
		while ($status >= 0)
			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D100 / %%nr_fatura.fis_nfsvc", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif

			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|D100"
			;Indicador do tipo de operacao.
			;if (tp_operacao.fis_nfsvc = "E")
			;	;Aquisicao.
			;	vStringAux = "|0"
			;else
				;Prestacao.
			vStringAux = "|1"
			;endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Indicador do emitente do documento fiscal.
			if (tp_origememissao.fis_nfsvc = "1")
				;Emissao propria.
				vStringAux = "|0"
			else
				;Emissao terceiro.
				vStringAux = "|1"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			
			clear/e "FIS_S_NFREMDESVC"
			CD_EMPFAT.fis_s_nfremdesvc/init = CD_EMPFAT.fis_nfsvc
			dt_fatura.fis_s_nfremdesvc/init  = dt_fatura.fis_nfsvc
			nr_fatura.fis_s_nfremdesvc/init  = nr_fatura.fis_nfsvc
			retrieve/e "FIS_S_NFREMDESVC"
			if ($status >= 0)
				
				if(TP_SITUACAO.FIS_NFSVC != "C")&(TP_SITUACAO.FIS_NFSVC != "D") ; rodrigo - PRJ 170 TAR 345 - 22/08/2011
					;-- MAD [Proj/Tar.061/526] - 18/12/2008
					creocc "F_TMP_NR09SVC", -1
					nr_geral.f_tmp_nr09svc = cd_pessoa.fis_s_nfremdesvc
					retrieve/o "F_TMP_NR09SVC"
					if ($status = 4)
						retrieve/x "F_TMP_NR09SVC"
					endif
					;;
				
					nm_cliente.f_tmp_nr09svc = nm_nome.fis_s_nfremdesvc
					tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_s_nfremdesvc
					if (tp_pessoa.fis_s_nfremdesvc = "F")
						nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_s_nfremdesvc
					else
						nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_s_nfremdesvc
					endif
					nr_rginscr.f_tmp_nr09svc    = nr_rginscrest.fis_s_nfremdesvc
					; @>-/-- Virginia - PRJ 061 TAR 743 - 03/02/10
					vPesCliente = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_s_nfremdesvc
					activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vPesCliente = voParams
					endif
				
					NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)
					;nr_suframa.f_tmp_nr09svc    = nr_suframa.pes_clientesvc
					; --\-<@
					ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_s_nfremdesvc %%nm_logradouro.fis_s_nfremdesvc"
					nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_s_nfremdesvc
					nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_s_nfremdesvc
				
					if (cd_cep.fis_s_nfremdesvc != 99999999)
						; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
						vGlbLogradouro = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_CEP", cd_cep.fis_s_nfremdesvc
						activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vGlbLogradouro = voParams
						endif
					
						vCdEstado = ""
						vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
						cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
						cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
						ds_estado.f_tmp_nr09svc    = vCdEstado
						ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
					endif
				endif
			endif
			
			;Codigo do participante.
			call convNumeric(cd_pessoa.fis_s_nfremdesvc, 9, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;Codigo do modelo do documento fiscal.
			vNumericAux = tp_moddctofiscal.fis_nfsvc
			call convNumeric(vNumericAux, 2, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da situacao do documento fiscal.
			if (tp_situacao.fis_nfsvc = "E")
				;Nota emitida.
				vStringAux = "|00"
			else
				;Nota cancelada.
				vStringAux = "|02"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Serie do documento fiscal.
			vStringAux = "|%%cd_serie.fis_nfsvc"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Subserie do documento fiscal.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Numero do documento fiscal.
			call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Chave do conhecimento de Transporte Eletrônico
			if (tp_moddctofiscal.fis_nfsvc = 57)
				;lógica 20/01/2009
				if(DS_CHAVEACESSO.FIS_NFESVC != "")
					vDsConteudo = "%%vDsConteudo%%%|%%DS_CHAVEACESSO.FIS_NFESVC" ; RAR [PRJ/TAR 175/324 - 09/03/2012]
				else
					vDsConteudo = "%%vDsConteudo%%%|" 	; @>-/-- Virginia - SC 36635 - 24/08/2011 - incluir chave da NF-e futuramente
				endif
			else
				vDsConteudo = "%%vDsConteudo%%%|"
			endif
			;Data de emissao do documento fiscal.
			vDtAux = dt_emissao.fis_nfsvc
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Data da aquisicao ou da prestacao do servico.
			vDtAux = dt_saidaentrada.fis_nfsvc
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			
			;Tipo de CT-e
			if (tp_moddctofiscal.fis_nfsvc = 57)
				;lógica 20/01/2009
				vDsConteudo = "%%vDsConteudo%%%|" ; @>-/-- Virginia - SC 36635 - 24/08/2011 - incluir tipo do CT-e futuramente
			else
				vDsConteudo = "%%vDsConteudo%%%|"
			endif
			;Chave do CT-e de referência
			if (tp_moddctofiscal.fis_nfsvc = 57)
				;lógica 20/01/2009
						vDsConteudo = "%%vDsConteudo%%%|" ; @>-/-- Virginia - SC 36635 - 24/08/2011 - incluir chave da NF-e ref futuramente
			else
				vDsConteudo = "%%vDsConteudo%%%|"
			endif
			
			;Valor total do documento fiscal.
			vNumericAux = vl_totalnota.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor total do desconto.
			vNumericAux = vl_desconto.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Indicador do tipo do frete.
			;-- MAD [Proj/Tar.170/044] - 24/08/2010
			;if (tp_frete.fis_nftranspsvc = "1")
			;	;Por conta do emitente.
			;	vStringAux = "|0"
			;else
			;	;Por conta do destinatario.
			;	vStringAux = "|1"
			;endif
			if (tp_frete.fis_nftranspsvc = "1")
				;Por conta do emitente.
				vStringAux = "|0"
			elseif (tp_frete.fis_nftranspsvc = "2")
				;Por conta do destinatario.
				vStringAux = "|1"
			elseif (tp_frete.fis_nftranspsvc = "3")
				;Por conta de terceiros.
				vStringAux = "|2"
			else
				;Sem frete
				vStringAux = "|9"
			endif
			;;
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor total da prestacao de servico.
			vNumericAux = vl_totalnota.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor da base de calculo do ICMS.
			vNumericAux = vl_baseicms.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do ICMS.
			vNumericAux = vl_icms.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor nao tributavel.
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 1
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status < 0)
				clear/e "FIS_NFIMPOSTOSVC"
			endif
			
			vNumericAux = vl_isento.fis_nfimpostosvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da informacao complementar do documento fiscal.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor do PIS.
			;Codigo da conta analitica contabil debitada/creditada.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "D100"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("D100")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			;CFC: 25/02/2010
			clear/e "FIS_NFITEMSVC"
			CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
			dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
			nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
			retrieve/e "FIS_NFITEMSVC"
			;
			;Itens da nota fiscal de servico de transporte.
			$instancehandle->gerarEFDBlocoDRegD110($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			;Complemento da nota fiscal de servicos de transporte.
			$instancehandle->gerarEFDBlocoDRegD120($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			;Registro analitico dos documentos.
			$instancehandle->gerarEFDBlocoDRegD190($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif

			discard "FIS_NFSVC"
			if ($status = 0)
				$status = -1
			endif
		endwhile
	endif

	;SANDRA/CFC PRJ/TRF 175/219 10/08/2011 -  a lógica abaixo foi inserida devido a validação do parametro
											; $inConsideraDtemisNfsai$, onde só deverá ser validado
											; para notas fiscais de saidas.

	clear/e "FIS_NFSVC"
	cd_empfat.fis_nfsvc/init        = $item("CD_EMPRESA", $parametro$)
	dt_saidaentrada.fis_nfsvc/init  = $item("DT_PERIODO", $parametro$)
	tp_situacao.fis_nfsvc/init      = "E·;C"
	tp_operacao.fis_nfsvc/init      = "E"
	; @>-/-- Virginia - SC 36635 - 22/08/2011
	;tp_moddctofiscal.fis_nfsvc/init = "07·;08·;09·;10·;11·;26"
	tp_moddctofiscal.fis_nfsvc/init = "07·;08·;09·;10·;11·;26·;27·;57"
	; --\-<@
	retrieve/e "FIS_NFSVC"
	if ($status >= 0)	
		inMovtoPeriodo = <TRUE>
		setocc "FIS_NFSVC", 1
		while ($status >= 0)
		
			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D100 / %%nr_fatura.fis_nfsvc", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif

			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|D100"
			;Indicador do tipo de operacao.
			;Aquisicao.
			vStringAux = "|0"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Indicador do emitente do documento fiscal.
			if (tp_origememissao.fis_nfsvc = "1")
				;Emissao propria.
				vStringAux = "|0"
			else
				;Emissao terceiro.
				vStringAux = "|1"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			
			clear/e "FIS_S_NFREMDESVC"
			CD_EMPFAT.fis_s_nfremdesvc/init = CD_EMPFAT.fis_nfsvc
			dt_fatura.fis_s_nfremdesvc/init  = dt_fatura.fis_nfsvc
			nr_fatura.fis_s_nfremdesvc/init  = nr_fatura.fis_nfsvc
			retrieve/e "FIS_S_NFREMDESVC"
			if ($status >= 0)
				if(TP_SITUACAO.FIS_NFSVC != "C")&(TP_SITUACAO.FIS_NFSVC != "D") ; rodrigo - PRJ 170 TAR 345 - 22/08/2011
					creocc "F_TMP_NR09SVC", -1
					nr_geral.f_tmp_nr09svc = cd_pessoa.fis_s_nfremdesvc
					retrieve/o "F_TMP_NR09SVC"
					if ($status = 4)
						retrieve/x "F_TMP_NR09SVC"
					endif
					;;
				
					nm_cliente.f_tmp_nr09svc = nm_nome.fis_s_nfremdesvc
					tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_s_nfremdesvc
					if (tp_pessoa.fis_s_nfremdesvc = "F")
						nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_s_nfremdesvc
					else
						nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_s_nfremdesvc
					endif
					nr_rginscr.f_tmp_nr09svc    = nr_rginscrest.fis_s_nfremdesvc
					vPesCliente = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_s_nfremdesvc
					activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vPesCliente = voParams
					endif
				
					NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)
					ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_s_nfremdesvc %%nm_logradouro.fis_s_nfremdesvc"
					nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_s_nfremdesvc
					nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_s_nfremdesvc
				
					if (cd_cep.fis_s_nfremdesvc != 99999999)
						vGlbLogradouro = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_CEP", cd_cep.fis_s_nfremdesvc
						activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vGlbLogradouro = voParams
						endif
					
						vCdEstado = ""
						vCdEstado                  = $item("DS_ESTADO",vGlbLogradouro)
						cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
						cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
						ds_estado.f_tmp_nr09svc    = vCdEstado
						ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
					endif
				endif
			endif
			
			;Codigo do participante.
			call convNumeric(cd_pessoa.fis_s_nfremdesvc, 9, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;Codigo do modelo do documento fiscal.
			vNumericAux = tp_moddctofiscal.fis_nfsvc
			call convNumeric(vNumericAux, 2, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da situacao do documento fiscal.
			if (tp_situacao.fis_nfsvc = "E")
				;Nota emitida.
				vStringAux = "|00"
			else
				;Nota cancelada.
				vStringAux = "|02"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Serie do documento fiscal.
			vStringAux = "|%%cd_serie.fis_nfsvc"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Subserie do documento fiscal.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Numero do documento fiscal.
			call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Chave do conhecimento de Transporte Eletrônico
			if (tp_moddctofiscal.fis_nfsvc = 57)
				;lógica 20/01/2009
				if(DS_CHAVEACESSO.FIS_NFESVC != "")
					vDsConteudo = "%%vDsConteudo%%%|%%DS_CHAVEACESSO.FIS_NFESVC" ; RAR [PRJ/TAR 175/324 - 09/03/2012]
				else
					vDsConteudo = "%%vDsConteudo%%%|" ; @>-/-- Virginia - SC 36635 - 24/08/2011 - incluir chave da NF-e futuramente
				endif
			else
				vDsConteudo = "%%vDsConteudo%%%|"
			endif
			;Data de emissao do documento fiscal.
			vDtAux = dt_emissao.fis_nfsvc
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Data da aquisicao ou da prestacao do servico.
			vDtAux = dt_saidaentrada.fis_nfsvc
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			
			;Tipo de CT-e
			if (tp_moddctofiscal.fis_nfsvc = 57)
				;lógica 20/01/2009
				vDsConteudo = "%%vDsConteudo%%%|" ; @>-/-- Virginia - SC 36635 - 24/08/2011 - incluir tipo do CT-e futuramente
			else
				vDsConteudo = "%%vDsConteudo%%%|"
			endif
			;Chave do CT-e de referência
			if (tp_moddctofiscal.fis_nfsvc = 57)
				;lógica 20/01/2009
				vDsConteudo = "%%vDsConteudo%%%|" ; @>-/-- Virginia - SC 36635 - 24/08/2011 - incluir chave da NF-e ref futuramente				
			else
				vDsConteudo = "%%vDsConteudo%%%|"
			endif
			
			;Valor total do documento fiscal.
			vNumericAux = vl_totalnota.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor total do desconto.
			vNumericAux = vl_desconto.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

			if (tp_frete.fis_nftranspsvc = "1")
				;Por conta do emitente.
				vStringAux = "|0"
			elseif (tp_frete.fis_nftranspsvc = "2")
				;Por conta do destinatario.
				vStringAux = "|1"
			elseif (tp_frete.fis_nftranspsvc = "3")
				;Por conta de terceiros.
				vStringAux = "|2"
			else
				;Sem frete
				vStringAux = "|9"
			endif
			;;
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor total da prestacao de servico.
			vNumericAux = vl_totalnota.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor da base de calculo do ICMS.
			vNumericAux = vl_baseicms.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do ICMS.
			vNumericAux = vl_icms.fis_nfsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor nao tributavel.
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 1
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status < 0)
				clear/e "FIS_NFIMPOSTOSVC"
			endif
			
			vNumericAux = vl_isento.fis_nfimpostosvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da informacao complementar do documento fiscal.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor do PIS.
			;Codigo da conta analitica contabil debitada/creditada.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "D100"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("D100")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			clear/e "FIS_NFITEMSVC"
			CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
			dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
			nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
			retrieve/e "FIS_NFITEMSVC"
			;
			;Itens da nota fiscal de servico de transporte.
			$instancehandle->gerarEFDBlocoDRegD110($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			;Complemento da nota fiscal de servicos de transporte.
			$instancehandle->gerarEFDBlocoDRegD120($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			;Registro analitico dos documentos.
			$instancehandle->gerarEFDBlocoDRegD190($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif

			discard "FIS_NFSVC"
			if ($status = 0)
				$status = -1
			endif
		endwhile
	endif

	clear/e "FIS_NFSVC"
	
	return(0)
End ;operation gerarEFDBlocoDRegD100.


;------------------------------------------------;
partner operation gerarEFDBlocoDRegD110          ;
	;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vStrAux, vFisCfop, vFisTipi, vNumericAux
		numeric vQtParcela, vContador
	endvariables
	;; ICJ [PROJ/TAR 175/334] (22/03/2012) 	
	;if ($empty("FIS_NFITEMSVC")) | (tp_moddctofiscal.fis_nfsvc != 07)
	if ($empty("FIS_NFITEMSVC")) | (tp_moddctofiscal.fis_nfsvc != 07) | (tp_origememissao.fis_nfsvc != "1")
	;;
		return(0)
	endif
	
	setocc "FIS_NFITEMSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D110 / %%cd_produto.fis_nfitemsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
			setocc "FIS_NFITEMPROSVC", 1
			vContador = vContador + 1
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|D110"
			;Numero sequencial do item no documento fiscal.
			;vStringAux = "|%%nr_item.fis_nfitem"
			vStringAux = "|%%vContador"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Codigo do item.
			call convNumeric(cd_produto.fis_nfitemprosvc, 9, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			creocc "F_TMP_DS40SVC", -1
			if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
			else
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
			endif
			if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
				clear/e "PRD_PRDCONVMESVC"
				CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "PRD_PRDCONVMESVC"
				if ($status >= 0)
					$instancehandle->totalizarQtdTipoRegistro("0220")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			retrieve/o "F_TMP_DS40SVC"
			if ($status = 4)
				retrieve/x "F_TMP_DS40SVC"
			else
				ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
				ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
				if (cd_tipi.fis_nfitemsvc = "")
					if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemsvc
					else
						clear/e "PRD_PRODUTOSVC"
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
						retrieve/e "PRD_PRODUTOSVC"
						if ($status >= 0)
							if (CD_ESPECIE.FIS_NFITEMSVC = "")
								ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
							endif
							if (cd_tipi.prd_produtosvc != "")
								; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
								vFisTipi = ""
								viParams = ""
								voParams = ""
								putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
								activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
								if ($procerror)
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									return(-1)
								endif
								if (voParams != "")
									vFisTipi = voParams
									vStrAux = $item("CD_TIPI",vFisTipi)
									vStrAux = $replace(vStrAux, 1, ".","",-1)	
									cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
								endif
								; --\-<@
							endif
						endif
					endif
				else
					cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
					cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
				endif
			endif
			
			creocc "TMP_NR08SVC", -1
			nr_08.tmp_nr08svc = cd_cfop.fis_nfitemsvc
			retrieve/o "TMP_NR08SVC"
			if ($status = 4)
				retrieve/x "TMP_NR08SVC"
			else
				; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
				vFisCfop = ""
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_CFOP", cd_cfop.fis_nfitemsvc
				activate "FISSVCO032".carregaFisCfop($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				if (voParams != "")
					vFisCfop = voParams
					ds_cfop.tmp_nr08svc = $item("DS_CFOP",vFisCfop)
				endif
				; --\-<@            
			endif
			
			;Valor do servico.
			vNumericAux = vl_totalliquido.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Outros valores.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "D110"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("D110")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		
		discard "FIS_NFITEMSVC"
		if ($status = 0)
			$status = -1
		endif
		;setocc "FIS_NFITEMSVC", $curocc(FIS_NFITEMSVC) + 1
	endwhile
	
	return(0)
End ;operation gerarEFDBlocoDRegD110.


;----------------------------------------------------;
partner operation gerarEFDBlocoDRegD120              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vGlbMunIBGE, vPesEndereco, vVPesEndereco, vNumericAux
		numeric vCdEstado
	endvariables
	
	if ($empty("FIS_NFTRANSPSVC"))
		return(0)
	endif
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D120", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|D120"
	;Codigo do municipio de origem do servico.
	; @>-/-- Virginia - PRJ 061 TAR 772 - 17/02/10    
	vPesEndereco = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPesEndereco = voParams
		
		vVPesEndereco = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
		activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vVPesEndereco = voParams
		endif
	endif
	; --\-<@
	
	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
	vGlbMunIBGE = ""
	viParams = ""
	voParams = ""
	;putitem/id viParams, "CD_ESTADO", CD_ESTADO.GLB_ESTADOSVC
	putitem/id viParams, "CD_ESTADO", $item("CD_ESTADO",vPesEndereco)
	;putitem/id viParams, "CD_MUNICIPIO", CD_MUNICIPIO.PES_ENDERECOSVC
	putitem/id viParams, "CD_MUNICIPIO", $item("CD_MUNICIPIO",vPesEndereco)
	activate "FISSVCO032".carregaMunIBGE($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vGlbMunIBGE = voParams
	endif
	; --\-<@    
	
	vCdEstado = ""
	vCdEstado = $item("DS_ESTADO",vPesEndereco)
	
	;if (ds_sigla.glb_estadosvc = "EX")
	if ($item("DS_SIGLA",vPesEndereco) = "EX")
		vStringAux = ""
		call convNumeric(vStringAux, 7, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	else
		; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
		;call convNumeric(CD_MUNICIPIOIBGE.GLB_MUNIBGESVC, 5, vStringConv)
		call convNumeric($item("CD_MUNICIPIOIBGE",vGlbMunIBGE), 5, vStringConv)    
		; --\-<@
		vStringConv = "%%vCdEstado%%vStringConv"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	endif
	;Codigo do municipio de destino.
	; @>-/-- Virginia - PRJ 061 TAR 772 - 17/02/10    
	vPesEndereco = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", cd_pessoa.fis_nfsvc
	activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vPesEndereco = voParams
		
		vVPesEndereco = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
		activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vVPesEndereco = voParams
		endif
	endif
	; --\-<@
	
	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
	vGlbMunIBGE = ""
	viParams = ""
	voParams = ""
	;putitem/id viParams, "CD_ESTADO", CD_ESTADO.GLB_ESTADOSVC
	putitem/id viParams, "CD_ESTADO", $item("CD_ESTADO",vPesEndereco)
	;putitem/id viParams, "CD_MUNICIPIO", CD_MUNICIPIO.PES_ENDERECOSVC
	putitem/id viParams, "CD_MUNICIPIO", $item("CD_MUNICIPIO",vPesEndereco)
	activate "FISSVCO032".carregaMunIBGE($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vGlbMunIBGE = voParams
	endif
	; --\-<@    
	vCdEstado = ""
	vCdEstado = $item("DS_ESTADO",vPesEndereco)
	
	;if (ds_sigla.glb_estadosvc = "EX")
	if ($item("DS_SIGLA",vPesEndereco) = "EX")
		vStringAux = ""
		call convNumeric(vStringAux, 7, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	else
		; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
		call convNumeric($item("CD_MUNICIPIOIBGE",vGlbMunIBGE), 5, vStringConv)    
		; --\-<@
		vStringConv = "%%vCdEstado%%vStringConv"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	endif
	;Placa de identificacao do veiculo.
	vStringAux = "|%%nr_placa.fis_nftranspsvc"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "D120"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("D120")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoDRegD120.


;----------------------------------------------------;
partner operation gerarEFDBlocoDRegD190              ;
	;----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		numeric vQtParcela, vVlAdicional, vVlIcms
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D190", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	clear/e "TMP_K03NR2VL1SVC"
	
	;ICMS.
	clear/e "V_FIS_APURACASVC"
	cd_empfat.v_fis_apuracasvc/init          = cd_empfat.fis_nfsvc
	nr_fatura.v_fis_apuracasvc/init          = nr_fatura.fis_nfsvc
	dt_fatura.v_fis_apuracasvc/init          = dt_fatura.fis_nfsvc
	;cd_empfat.v_fis_apuracasvc/init          = cd_empfat.fis_nfsvc
	;nr_nf.v_fis_apuracasvc/init              = nr_nf.fis_nfsvc
	;cd_serie.v_fis_apuracasvc/init           = cd_serie.fis_nfsvc

	;SANDRA/CFC PRJ/TRF 175/219 10/08/2011 -  a lógica abaixo foi inserida devido a validação do parametro
											; $inConsideraDtemisNfsai$, onde só deverá ser validado
											; para notas fiscais de saidas.
	if ($inConsideraDtEmisNfSai$ = <TRUE>) & (tp_operacao.fis_nfsvc = "S")
		dt_emissao.v_fis_apuracasvc/init      = dt_emissao.fis_nfsvc
	else
		dt_saidaentrada.v_fis_apuracasvc/init = dt_saidaentrada.fis_nfsvc
	endif
	;---

	;tp_operacao.v_fis_apuracasvc/init        = tp_operacao.fis_nfsvc
	;tp_origememissao.v_fis_apuracasvc/init   = tp_origememissao.fis_nfsvc
	cd_imposto.v_fis_apuracasvc/init         = 1
	tp_situacao.v_fis_apuracasvc/init        = "E"
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", 1
		while ($status >= 0)
			creocc "TMP_K03NR2VL1SVC", -1
			nr_k01.tmp_k03nr2vl1svc = cd_cst.v_fis_apuracasvc
			nr_k02.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
			vl_k03.tmp_k03nr2vl1svc = pr_aliquota.v_fis_apuracasvc
			retrieve/o "TMP_K03NR2VL1SVC"
			if ($status = 4)
				retrieve/x "TMP_K03NR2VL1SVC"
			endif
			;
			vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_totalliquido.v_fis_apuracasvc
			vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.v_fis_apuracasvc
			vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.v_fis_apuracasvc
		
			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
			
		if ($next(nr_nf.fis_nfsvc)           != nr_nf.fis_nfsvc)     | %\
			($next(cd_pessoa.fis_nfsvc)       != cd_pessoa.fis_nfsvc) | %\
			($next(dt_saidaentrada.fis_nfsvc) != dt_saidaentrada.fis_nfsvc)
			vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_despacessor.fis_nfsvc + vl_frete.fis_nfsvc + vl_seguro.fis_nfsvc
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 1 ;ICMS.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status >= 0)
				setocc "FIS_NFIMPOSTOSVC", 1
				while ($status >= 0)
					vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.fis_nfimpostosvc
					vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.fis_nfimpostosvc
					
					setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
				endwhile
			endif
		endif
	endif
	clear/e "V_FIS_APURACASVC"

	if ($empty("TMP_K03NR2VL1SVC"))
		return(0)
	endif

setocc "TMP_K03NR2VL1SVC", 1
while ($status >= 0)
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|D190"
	;Codigo da situacao tributaria.
	call convNumeric(nr_k01.tmp_k03nr2vl1svc, 3, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Codigo fiscal de operacao e prestacao.
	call convNumeric(nr_k02.tmp_k03nr2vl1svc, 4, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Aliquota do ICMS.
	if (vl_k03.tmp_k03nr2vl1svc > 0)
		$vlAux$ = vl_k03.tmp_k03nr2vl1svc
		vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
	else
		vStringAux = "00,00"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	endif
	;Parcela correspondente ao valor contabil referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_contabil.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_baseicms.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Parcela correspondente ao valor do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = vl_icms.tmp_k03nr2vl1svc
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor nao tributado em funcao da reducao da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
	vNumericAux = 0 ;vl_outro.fis_nfitemimpost
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Codigo da observacao do lancamento fiscal.
	vStringAux = "|"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "D190"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("D190")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
endwhile
clear/e "TMP_K03NR2VL1SVC"

return(0)
End ;operation gerarEFDBlocoDRegD190.


;-----------------------------------------------;
partner operation gerarEFDBlocoDRegD990         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D990", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|D990"
	;Quantidade total de linhas do bloco D.
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	vStringAux = "|%%$nrLinhaBloco$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "D990"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("D990")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoDRegD990.


;---------------------------------------------------;
partner operation gerarEFDBlocoE                    ;
	;---------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	$nrLinhaBloco$ = ""
	;Abertura do bloco E.
	$instancehandle->gerarEFDBlocoERegE001($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	if ($item("IN_BLOCOE", $parametro$) = <TRUE>)
		;Periodo de apuracao do ICMS.
		$instancehandle->gerarEFDBlocoERegE100($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		;Periodo de apuracao do ICMS - substituicao tributaria.
		$instancehandle->gerarEFDBlocoERegE200($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		; @>-/-- Virginia - SC 35407 - Brascol - 19/05/2011
		if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4)
			;Periodo de apuracao do IPI.
			$instancehandle->gerarEFDBlocoERegE500($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		; --\-<@
	endif
	
	;Encerramento do bloco E.
	$instancehandle->gerarEFDBlocoERegE990($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoE.

;-----------------------------------------------;
partner operation gerarEFDBlocoERegE001         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		boolean vInMovimento
	endvariables
	
	;Verificando se ha movimento.
	vInMovimento = <FALSE>

	if ($item("IN_BLOCOE", $parametro$) = <TRUE>)

		;-- MAD [Proj/Tar.170/279] - 02/06/2011
		;clear/e "V_FIS_APURACASVC"
		;CD_EMPFAT.v_fis_apuracasvc/init       = $item("CD_EMPRESA", $parametro$)
		;;------ WMC - PRJ 175 TAR 052 - 08/02/2011
		;if ($inConsideraDtemisNfsai$ = <TRUE>)
		;	DT_EMISSAO.V_FIS_APURACASVC/init       = $item("DT_PERIODO", $parametro$)
		;else
		;	DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = $item("DT_PERIODO", $parametro$)
		;endif
		;;------//------//------
		;cd_imposto.v_fis_apuracasvc/init      = 1 ;ICMS.
		;tp_situacao.v_fis_apuracasvc/init     = "E"  
		;retrieve/e "V_FIS_APURACASVC"
		;if ($status >= 0)
		;	setocc "V_FIS_APURACASVC", 1
		;	if ($status >= 0)
		;		vInMovimento = <TRUE>
		;	endif
		;endif

		vInMovimento = <TRUE>
		;;
	endif
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E001", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif

	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|E001"
	;Indicador de movimento.
	if (vInMovimento = <TRUE>)
		vStringAux = "|0"
	else
		vStringAux = "|1"
	endif
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "E001"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	$instancehandle->totalizarQtdTipoRegistro("E001")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoERegE001.


;-----------------------------------------------;
partner operation gerarEFDBlocoERegE100         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		date    vDtAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E100", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|E100"
	;Data inicial a que a apuracao se refere.
	vDtAux = $item("DT_PERIODOINI", $parametro$)
	vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;Data final a que a apuracao se refere.
	vDtAux = $item("DT_PERIODOFIM", $parametro$)
	vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "E100"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$ = $nrLinhaBloco$ + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("E100")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Apuracao do ICMS - Operacoes proprias.
	$instancehandle->gerarEFDBlocoERegE110($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif    
	return(0)
End ;operation gerarEFDBlocoERegE100.


;-------------------------------------------------;
partner operation gerarEFDBlocoERegE110           ;
	;-------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vAux, vUf, vNumericAux, vTabFisSaldoImposto, viParams, voParams, vVlAux
		numeric vVlIcmsRecolher, vCodigoReceita, vlImpEntrada, vlImpSaida, vlImpDetCredito, vlImpDetDebito, vlIcmsRecolher
		numeric vEstornoCred, vEstornoDeb, vDed, vVlSaldoCredor, vMes, vAliqIcms, vVlImpAux
		date    vDtAux, vDtInicial
		boolean vInListar, vGeraE111, vInSoma, vInGerar
	endvariables
	
	vlImpEntrada    = 0
	vlImpSaida      = 0
	vlImpDetCredito = 0
	vlImpDetDebito  = 0
	vlIcmsRecolher  = 0
	vEstornoCred    = 0
 	vEstornoDeb     = 0
	vDed            = 0
	vVlAux          = 0

	; Ranghetti - 175/316 - 28/02/2012 ->
	vInSoma = <TRUE>
	if ($item("IN_INFORMA_BCICMS_OUT",$xlplemp$) = 1) & ($item("UF_ORIGEM",$xlplemp$) = "CE") & (($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4))
		vInSoma = <FALSE>
	endif
	; <-

	;Listar imposto ICMS referente a SAIDA.
	clear/e "V_FIS_APURACASVC"
	cd_empfat.v_fis_apuracasvc/init       = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.V_FIS_APURACASVC/init       = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	cd_imposto.v_fis_apuracasvc/init      = 1 ;ICMS.
	tp_situacao.v_fis_apuracasvc/init     = "E"
	tp_operacao.v_fis_apuracasvc/init     = "S" ;SANDRA/CFC PRJ/TRF 175/219 10/08/2011- SOMENTE AS SAÍDAS PODEM VALIDAR A DATA DE EMISSÃO
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", 1
		while ($status >= 0)
			if (CD_SERIE.V_FIS_APURACASVC != "ECF") ;-- MAD [Proj/Tar.170/329] - 03/08/2011
		
				;if (vInListar = <TRUE>)
				;if (tp_operacao.v_fis_apuracasvc = "E")
				 	;Valor total imposto referente a entrada.
					;ICJ [PROJ/TAR 61/831] (28/05/2010)  
					;if (CD_CFOP.V_FIS_APURACASVC != 1605) & (CD_CFOP.V_FIS_APURACASVC != 5605)
					;	
					;	vlImpEntrada = vlImpEntrada + vl_imposto.v_fis_apuracasvc
					;endif
				;else
					;Valor total imposto referente a saida.
					;-- CFC & MAD - 15/07/2011 - DMetal
				if ($item("IN_INFORMA_BCICMS_OUT",$xlplemp$) = 1) & ($item("UF_ORIGEM",$xlplemp$) = "CE") & %\
				   (($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4))
					vl_basecalc.fis_nfitemimpsvc = 0
					vl_imposto.fis_nfitemimpsvc  = 0
					pr_aliquota.fis_nfitemimpsvc = 0
				endif

				;->RIM [170/555] - 21/09/2012
				if(($inCalcImpdevSn$) & (TP_ORIGEMEMISSAO.V_FIS_APURACASVC = 1) & ($inOptSimples$ = "S"))
					clear/e "FIS_NFSVC"
					CD_EMPRESA.FIS_NFSVC/init = CD_EMPRESA.V_FIS_APURACASVC
					NR_FATURA.FIS_NFSVC/init = NR_FATURA.V_FIS_APURACASVC
					DT_FATURA.FIS_NFSVC/init = DT_FATURA.V_FIS_APURACASVC
					retrieve/e "FIS_NFSVC"
					if($status >=0)
						if(TP_MODALIDADE.GER_OPERACAOSVC = 3)
							vl_basecalc.fis_nfitemimpsvc = 0
							vl_imposto.fis_nfitemimpsvc  = 0
							pr_aliquota.fis_nfitemimpsvc = 0
							vInSoma = <FALSE>
						endif
					endif
				endif
				;<-	
					;;
				;;ICJ [PROJ/TAR 61/831] (28/05/2010)
				;;;ICJ [PROJ/TAR 170/419] (20/04/2012)	
				vInGerar = <TRUE>
				if (CD_CFOP.V_FIS_APURACASVC = 1605)
					vInGerar = <FALSE>
				endif
				if ($tpApurIcms$ = 2)
					if  (CD_CFOP.V_FIS_APURACASVC = 1601) |  %\
				 		(CD_CFOP.V_FIS_APURACASVC = 1602) |  %\	
						(CD_CFOP.V_FIS_APURACASVC = 5601) |  %\
						(CD_CFOP.V_FIS_APURACASVC = 5602) |  %\
						(CD_CFOP.V_FIS_APURACASVC = 5605)
						vInGerar = <FALSE>
					endif
				endif
				if (vInGerar = <TRUE>)
					;if (CD_CFOP.V_FIS_APURACASVC != 5605) & (vInSoma = <TRUE>); Ranghetti - 175/316 - 29/02/2012 <-
					if (vInSoma = <TRUE>)
				;;;
						if (CD_SERIE.V_FIS_APURACASVC = "ECF")
							vlImpSaida = vlImpSaida + (vl_basecalc.v_fis_apuracasvc * (pr_aliquota.v_fis_apuracasvc/100))
						else
					;;
							vlImpSaida = vlImpSaida + vl_imposto.v_fis_apuracasvc
						endif
					endif
				endif
				;endif

				if ($next(nr_nf.V_FIS_APURACASVC)           != nr_nf.V_FIS_APURACASVC)     | %\
				   ($next(cd_pessoa.V_FIS_APURACASVC)       != cd_pessoa.V_FIS_APURACASVC) | %\
				   ($next(dt_saidaentrada.V_FIS_APURACASVC) != dt_saidaentrada.V_FIS_APURACASVC)

					clear/e "FIS_NFIMPOSTOSVC"
					CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.V_FIS_APURACASVC
					nr_fatura.fis_nfimpostosvc/init  = nr_fatura.V_FIS_APURACASVC
					dt_fatura.fis_nfimpostosvc/init  = dt_fatura.V_FIS_APURACASVC
					cd_imposto.fis_nfimpostosvc/init = 1 ;ICMS.
					retrieve/e "FIS_NFIMPOSTOSVC"
					if ($status >= 0)
						setocc "FIS_NFIMPOSTOSVC", 1
						while ($status >= 0)
							;if (tp_operacao.v_fis_apuracasvc = "E")
							;vlImpEntrada = vlImpEntrada + vl_imposto.fis_nfimpostosvc
							;else
							if(vInSoma = <TRUE>); Ranghetti - 175/316 - 29/02/2012 <-
								vlImpSaida = vlImpSaida + vl_imposto.fis_nfimpostosvc
							endif
							;endif	
							setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
						endwhile
					endif
				endif
			endif		
			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
	endif

	;;SANDRA/CFC PRJ/TRF 175/219 10/08/2011 -  Inserida as lógicas abaixo para acumular sepadado as entradas
                                               ;pois as entradas deverão sempre validar somente data de entrada/saida

	clear/e "V_FIS_APURACASVC"
	cd_empfat.v_fis_apuracasvc/init        = $item("CD_EMPRESA", $parametro$)
	dt_saidaentrada.v_fis_apuracasvc/init  = $item("DT_PERIODO", $parametro$)
	cd_imposto.v_fis_apuracasvc/init       = 1 ;ICMS.
	tp_situacao.v_fis_apuracasvc/init      = "E"
	tp_operacao.v_fis_apuracasvc/init      = "E"
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", 1
		while ($status >= 0)

			;;;ICJ [PROJ/TAR 170/419] (20/04/2012)	
			vInGerar = <TRUE>
			if (CD_CFOP.V_FIS_APURACASVC = 1605)
				vInGerar = <FALSE>
			endif
			if ($tpApurIcms$ = 2)
				if  (CD_CFOP.V_FIS_APURACASVC = 1601) |  %\
			 		(CD_CFOP.V_FIS_APURACASVC = 1602) |  %\	
					(CD_CFOP.V_FIS_APURACASVC = 5601) |  %\
					(CD_CFOP.V_FIS_APURACASVC = 5602) |  %\
					(CD_CFOP.V_FIS_APURACASVC = 5605)
					vInGerar = <FALSE>
				endif
			endif
			if (vInGerar = <TRUE>)
			;if (CD_CFOP.V_FIS_APURACASVC != 1605)
			;;;
				vlImpEntrada = vlImpEntrada + vl_imposto.v_fis_apuracasvc
			endif

			if ($next(nr_nf.V_FIS_APURACASVC)           != nr_nf.V_FIS_APURACASVC)     | %\
			   ($next(cd_pessoa.V_FIS_APURACASVC)       != cd_pessoa.V_FIS_APURACASVC) | %\
			   ($next(dt_saidaentrada.V_FIS_APURACASVC) != dt_saidaentrada.V_FIS_APURACASVC)

				clear/e "FIS_NFIMPOSTOSVC"
				CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.V_FIS_APURACASVC
				nr_fatura.fis_nfimpostosvc/init  = nr_fatura.V_FIS_APURACASVC
				dt_fatura.fis_nfimpostosvc/init  = dt_fatura.V_FIS_APURACASVC
				cd_imposto.fis_nfimpostosvc/init = 1 ;ICMS.
				retrieve/e "FIS_NFIMPOSTOSVC"
				if ($status >= 0)
					setocc "FIS_NFIMPOSTOSVC", 1
					while ($status >= 0)
						vlImpEntrada = vlImpEntrada + vl_imposto.fis_nfimpostosvc
						setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
					endwhile
				endif
			endif

			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
	endif
	clear/e "V_FIS_APURACASVC"

	;-- MAD [Proj/Tar.170/329] - 03/08/2011
	;if ($InOptSimples$ != "S")
	if ($InOptSimples$ != "S") | ($item("UF_ORIGEM",$xlplemp$) = "MT") ; --\-<@ Virginia SC 37868 - Damagal - 14/11/2011
		clear/e "FIS_REDZMSVC"
		CD_EMPRESA.FIS_REDZMSVC/init = $item("CD_EMPRESA", $parametro$)
		DT_EMISSAO.FIS_REDZMSVC/init = $item("DT_PERIODO", $parametro$)
		retrieve/e "FIS_REDZMSVC"
		if ($status >= 0)
			setocc "FIS_REDZMSVC", 1
			while ($status >= 0)
				if (!$empty("FIS_REDZASVC"))
					setocc "FIS_REDZASVC", 1
					while ($status >= 0)

						if (CD_SITALIQ.FIS_REDZASVC != "I") & (CD_SITALIQ.FIS_REDZASVC != "N") & (CD_SITALIQ.FIS_REDZASVC != "F") & %\
						   (CD_SITALIQ.FIS_REDZASVC != "CANC") & (CD_SITALIQ.FIS_REDZASVC != "DESC")

							vAliqIcms = 0
							$aliquotaIcms$ = CD_SITALIQ.FIS_REDZASVC

							if ($aliquotaIcms$ != 0)
								call achaNumero($aliquotaIcms$,vAliqIcms)
									if ($procerror)
									$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									return(-1)
								endif
							endif

							$aliquotaIcms$     = vAliqIcms / 100
							$valorImpostoIcms$ = (VL_TOTALACUM.FIS_REDZASVC * $aliquotaIcms$)
							vVlImpAux          = $valorImpostoIcms$ * 100
							vVlImpAux          = vVlImpAux[trunc]
							vVlimpAux          = vVlImpAux / 100
							$valorImpostoIcms$ = vVlImpAux
							if(vInSoma = <TRUE>); Ranghetti - 175/316 - 29/02/2012 <-
								vlImpSaida  = vlImpSaida + $valorImpostoIcms$
							endif
						endif
						setocc "FIS_REDZASVC", $curocc("FIS_REDZASVC") + 1
					endwhile
				endif
				setocc "FIS_REDZMSVC", $curocc("FIS_REDZMSVC") + 1
			endwhile	
		endif
		clear/e "FIS_REDZMSVC"
	endif
	;;
	
	clear/e "FIS_DETALHEICSVC"
	cd_empresa.fis_detalheicsvc/init = $item("CD_EMPRESA", $parametro$)
	dt_mesano.fis_detalheicsvc/init  = $item("DT_PERIODO", $parametro$)
	cd_imposto.fis_detalheicsvc/init = 1 ;ICMS.
	retrieve/e "FIS_DETALHEICSVC"
	if ($status >= 0)
		setocc "FIS_DETALHEICSVC", 1
		while ($status >= 0)
			
			if (ds_debcred.fis_tipodeticsvc = "C")
				;Credito.
				vlImpDetCredito = vlImpDetCredito + vl_detalhe.fis_detalheicsvc
			;;ICJ [PROJ/TAR 61/831] (28/05/2010)
			elseif (ds_debcred.fis_tipodeticsvc = "D")
				;Debito.
				vlImpDetDebito = vlImpDetDebito + vl_detalhe.fis_detalheicsvc
			elseif (ds_debcred.fis_tipodeticsvc = "E")
				;Estorno de Débito
			 	vEstornoDeb		= vEstornoDeb + vl_detalhe.fis_detalheicsvc
			elseif (ds_debcred.fis_tipodeticsvc = "F")
				;Estorno de Crédito
				vEstornoCred	= vEstornoCred + vl_detalhe.fis_detalheicsvc
			elseif (ds_debcred.fis_tipodeticsvc = "X")
				;Deduções
				vDed	= vDed + vl_detalhe.fis_detalheicsvc
			endif
			;;

			if (vCodigoReceita = "")
				vCodigoReceita = ds_descricao.fis_detalheicsvc
			endif
			
			setocc "FIS_DETALHEICSVC", $curocc(FIS_DETALHEICSVC) + 1
		endwhile
	endif
	clear/e "FIS_DETALHEICSVC"
	
	;Valor a recolher de ICMs.
	vlIcmsRecolher = vlImpSaida - vlImpEntrada + vlImpDetDebito - vlImpDetCredito + vEstornoCred - vEstornoDeb - vDed
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E110", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vGeraE111 = <FALSE>
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|E110"
	;02 - Valor total dos debitos por SAIDAS E PRESTACOES COM DEBITO DO IMPOSTO.
	vNumericAux = vlImpSaida
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;03 - Valor total dos ajustes a debito decorrentes do documento fiscal.
	vNumericAux = 0 ;$vlImpDetDebito$
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;04 - Valor total dos ajustes a debito.
	if (vlImpDetDebito > 0)
		vGeraE111 = <TRUE>
	endif
	vNumericAux = vlImpDetDebito ;0 ;$vlImpSaida$ + $vlImpDetDebito$
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;05 - Valor total de ajustes ESTORNOS DE CREDITOS.
	if (vEstornoCred > 0)
		vGeraE111 = <TRUE>
	endif
	vNumericAux = vEstornoCred
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;06 - Valor total dos creditos por ENTRADAS E AQUISICOES COM CREDITO DO IMPOSTO.
	vNumericAux = vlImpEntrada
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;07 - Valor total de ajustes a credito.
	vNumericAux = 0;$vlImpDetCredito$
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;08 - Valor total de ajustes a credito.
	if (vlImpDetCredito > 0)
		vGeraE111 = <TRUE>
	endif
	vNumericAux = vlImpDetCredito ;0 ;$vlImpEntrada$ + $vlImpDetCredito$
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;09 - Valor total de ajustes ESTORNOS DE DEBITOS.
	if (vEstornoDeb > 0)
		vGeraE111 = <TRUE>
	endif
	vNumericAux = vEstornoDeb
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	
	viParams = ""
	voParams = ""
	;;ICJ [PROJ/TAR 170/2] (17/06/2010)	
	putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $parametro$)
	putitem/id viParams, "DT_MESANO",  $item("DT_PERIODO", $parametro$)
	putitem/id viParams, "TP_IMPOSTO", 1
	putitem/id viParams, "NM_CARREGATABELA", "FIS_SALDOIMPOSTO"
	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	vTabFisSaldoImposto	= ""
	if (voParams != "")
		vTabFisSaldoImposto = voParams
	endif
	
	;10 - Valor total de SALDO CREDOR DO PERIODO ANTERIOR.
	vVlSaldoCredor = $item("VL_SALDOCREDOR", vTabFisSaldoImposto) 
	vNumericAux = vVlSaldoCredor
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;11 - Valor total de SALDO DEVEDOR (02+03+04+05-06-07-08-09-10).
	vNumericAux =  (vlImpSaida + vlImpDetDebito + vEstornoCred) - (vlImpEntrada + vlImpDetCredito + vVlSaldoCredor + vEstornoDeb) 
	if (vNumericAux < 0)
		vNumericAux = 0
	endif
	vVlIcmsRecolher = vNumericAux
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;12 - Valor total de DEDUCOES.
	if (vDed > 0)
		vGeraE111 = <TRUE>
	endif
	vNumericAux = vDed
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;13 - Valor total de ICMS A RECOLHER (11-12).
	vNumericAux = vVlIcmsRecolher - vDed
	vVlAux = vNumericAux  ;-- MAD [Proj/Tar.061/894] - 23/11/2010
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;14 - Valor total de SALDO CREDOR A TRANSPORTAR PARA O PERIODO SEGUINTE.
	;-- MAD [Proj/Tar.061/894] - 23/11/2010
	if (vVlAux != 0)
		vNumericAux = 0
	else
	;;SANDRA/CFC PRJ/TRF 175/219 10/08/2011 - incluido o estorno de credito e débito
		vNumericAux = (vlImpEntrada + vlImpDetCredito + vVlSaldoCredor + vEstornoDeb) - (vlImpSaida + vlImpDetDebito + vEstornoCred)
		if (vNumericAux < 0)
			vNumericAux = 0
		endif
	endif
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;15 - Valores recolhidos ou a recolher, extra-apuracao.
	vNumericAux = 0
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "E110"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("E110")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	vUf = $item("UF_ORIGEM",$xlplemp$)
	if (vGeraE111 = <TRUE>)
		clear/e "FIS_DETALHEICSVC"
		cd_empresa.fis_detalheicsvc/init = $item("CD_EMPRESA", $parametro$)
		dt_mesano.fis_detalheicsvc/init  = $item("DT_PERIODO", $parametro$)
		cd_imposto.fis_detalheicsvc/init = 1 ;ICMS.
		retrieve/e "FIS_DETALHEICSVC"
		if ($status >= 0)
			setocc "FIS_DETALHEICSVC", 1
			while ($status >= 0)
				if (DS_DEBCRED.FIS_TIPODETICSVC != "Y") ;-- MAD [Proj/Tar.061/886] - 20/10/2010
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|E111"
					;-- MAD [Proj/Tar.170/246] - 09/05/2011
					if (CD_SPEDFISCAL.FIS_TIPODETICSVC != "")
						;Codigo COD_AJ_APUR.
						vStringAux  = "|%%CD_SPEDFISCAL.FIS_TIPODETICSVC"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
						;Descrição complementar.
						vStringAux  = "|%%DS_DETALHADA.GLB_AJUSTEICMSVC"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
					else
					;;
						;Codigo COD_AJ_APUR.
						vStringAux = "|%%vUf"
						vAux = "" 
						if (DS_DEBCRED.FIS_TIPODETICSVC = "D")
							vAux = "00"
						elseif (DS_DEBCRED.FIS_TIPODETICSVC = "C")
							vAux = "02"
						elseif (DS_DEBCRED.FIS_TIPODETICSVC = "F")
							vAux = "01"
						elseif (DS_DEBCRED.FIS_TIPODETICSVC = "E")
							vAux = "03"
						elseif (DS_DEBCRED.FIS_TIPODETICSVC = "X")
							vAux = "04"
						endif
						vNumericAux = 9999
						call convNumeric(vNumericAux, 4, vStringConv)
						vStringAux = "|%%vUf%%vAux%%vNumericAux"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
						;Descrição complementar.
						vStringAux = "|"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
					endif
					;13 - Valor complementar
					vNumericAux = VL_DETALHE.FIS_DETALHEICSVC
					call editarNr(12, 2, vNumericAux, vNumericAux)
					call convValorString(2,vNumericAux, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"
					;filedump/append vDsConteudo, ds_path.sis_filtro
					creocc "SIS_ARQUIVOSVC", -1
					ds_reg.sis_arquivosvc = "E111"
					ds_registro.sis_arquivosvc = vDsConteudo
				
					$nrLinhaBloco$   = $nrLinhaBloco$   + 1
					$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
					$nrRegistroArq$  = $nrRegistroArq$  + 1
				
					$instancehandle->totalizarQtdTipoRegistro("E111")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
				setocc "FIS_DETALHEICSVC", $curocc(FIS_DETALHEICSVC) + 1
			endwhile
		endif
	endif

	vlIcmsRecolher = vlIcmsRecolher - vVlSaldoCredor ;-- MAD [Proj/Tar.170/283] - 06/06/2011

	;Obrigacoes do ICMS a recolher - operacoes proprias.
	if (vlIcmsRecolher > 0)
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E116", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|E116"
		;Codigo da obrigacao a recolher.
		vStringAux = "|000"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Valor da obrigacao a recolher.
		vNumericAux = vlIcmsRecolher
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Data de vencimento da obrigacao.
		vDtAux = $item("DT_VENCTOIMP", $parametro$)
		vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Codigo da receita referente a obrigacao, proprio da unidade da federacao.
		if (vCodigoReceita = "")
			vCodigoReceita = "TESTE"
		endif
		vDsConteudo = "%%vDsConteudo%%%|%%vCodigoReceita"
		;Numero do processo ao qual a obrigacao esta vinculada, se houver.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Indicador da origem do processo.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Descricao do processo que embasou o lancamento.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Descricao complementar das obrigacoes a recolher.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;-- MAD [Proj/Tar.170/082] - 28/10/2010
		;Mês/Ano de referência
		vDtInicial = $item("DT_PERIODOINI", $parametro$)
		if (vDtInicial >= "01/01/2011")
			vMes = vDtInicial[m]
			if (vMes < 10)
				vAux = "%%%0%%vMes"
			else
				vAux = "%%vMes"
			endif
			vStringAux = "%%%|%%vAux%%vDtInicial[y]"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
		endif
		;;
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
		
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "E116"
		ds_registro.sis_arquivosvc = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("E116")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	
	return(0)
End ;operation gerarEFDBlocoERegE110.


;-----------------------------------------------;
partner operation gerarEFDBlocoERegE200         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		date    vDtAux
	endvariables
	
	clear/e "TMP_K07NDD"
	clear/e "TMP_DS60SVC"

	clear/e "FIS_NFSVC"
	CD_EMPFAT.fis_nfsvc/init       = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init       = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init  = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	tp_situacao.fis_nfsvc/init      = "E·;C"
	;tp_moddctofiscal.fis_nfsvc/init = 02
	retrieve/e "FIS_NFSVC"
	if ($status < 0)
		return(0)
	endif
	
	setocc "FIS_NFSVC", 1
	while ($status >= 0)

		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E200 / %%nr_fatura.fis_nfsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		;CFC:  25/02/2010 - COMENTADO A PEDIDO DO DEUSDETE
		;if ($item("UF_ORIGEM",$xlplemp$) = "") | ($item("UF_ORIGEM",$xlplemp$) = ds_siglaestado.fis_nfremdessvc)
			;CFC: 28/04/2010 - Somente gerar se houver icms subst. retido.
			if (vl_icmssubst.fis_nfsvc != 0)&(vl_icmssubst.fis_nfsvc != "")
				creocc "TMP_DS60SVC", -1
				;ds_60.tmp_ds60svc = ds_siglaestado.fis_s_nfremdesvc; esta entidade não esta pintada no fis_nfsvc
				ds_60.tmp_ds60svc = ds_siglaestado.fis_nfremdessvc
				retrieve/o "TMP_DS60SVC"
				if ($status = 4)
					retrieve/x "TMP_DS60SVC"
				endif
			
				creocc "TMP_K07NDD", -1
				nr_chave01.tmp_k07ndd = 1
				nr_chave02.tmp_k07ndd = 1
				nr_chave03.tmp_k07ndd = 1
				nr_chave04.tmp_k07ndd = cd_empresa.fis_nfsvc
				nr_chave05.tmp_k07ndd = nr_fatura.fis_nfsvc
				dt_chave06.tmp_k07ndd = dt_fatura.fis_nfsvc
				ds_chave07.tmp_k07ndd = ds_siglaestado.fis_nfremdessvc
				retrieve/o "TMP_K07NDD"
				if ($status = 4)
					retrieve/x "TMP_K07NDD"
				endif
			endif
			;
		;endif
		
		discard "FIS_NFSVC"
		if ($status = 0)
			$status = -1
		endif
		;setocc "FIS_NFSVC", $curocc(FIS_NFSVC) + 1
	endwhile
	
	if ($empty("TMP_DS60SVC"))
		return(0)
	endif
	
	setocc "TMP_DS60SVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E200 / %%ds_60.tmp_ds60svc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|E200"
		;Sigla da unidade de federacao.
		call convString("ds_60.tmp_ds60svc", ds_60.tmp_ds60svc, 2, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Data inicial a que a apuracao se refere.
		vDtAux = $item("DT_PERIODOINI", $parametro$)
		vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Data final a que a apuracao se refere.
		vDtAux = $item("DT_PERIODOFIM", $parametro$)
		vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
		
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "E200"
		ds_registro.sis_arquivosvc = vDsConteudo
		
		$nrLinhaBloco$ = $nrLinhaBloco$ + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("E200")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		;Apuracao do ICMS - substituicao tributaria.
		$instancehandle->gerarEFDBlocoERegE210($xCdErro$, $xCtxErro$, ds_60.tmp_ds60svc)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		setocc "TMP_DS60SVC", $curocc(TMP_DS60SVC) + 1
	endwhile
	clear/e "TMP_DS60SVC"
	clear/e "TMP_K07NDD"
	
	return(0)
End ;operation gerarEFDBlocoERegE200.


;-------------------------------------------------;
partner operation gerarEFDBlocoERegE210           ;
	;-------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
		string  poDsUfOrig:OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vDsUfOrigem, vDsUfDestino, vDsUfEmpresa, viParams, voParams, vVPesEndereco, vSiglaEstado, vAux
		numeric vVlIcmsRecolher, vCodigoReceita, vlImpEntrada, vlImpSaida, vlImpDetCredito, vlImpDetDebito, vlIcmsRecolher, vVlSaldoCredor, vMes
		numeric vDed, vEstornoCredito, vEstornoDebito, vImpDetDebEsp, vlImpDevolucao
		date    vDtAux
		string  vNumericAux, vTabFisSaldoImposto
		Boolean vInGerou220
	endvariables

	vInGerou220 		= <false> ; rodrigo - PRJ 170 TAR 242 - 14/04/2011
	vlImpEntrada    	= 0
	vlImpSaida      	= 0
	vlImpDetCredito 	= 0
	vlImpDetDebito  	= 0
	vlIcmsRecolher  	= 0
	vDed				= 0
	vEstornoCredito	    = 0
	vEstornoDebito	    = 0
	vImpDetDebEsp	    = 0
	vlImpDevolucao    = ; --\-<@ Virginia - 111/1780 - Brascol

	;Verificando estado da empresa.
	; @>-/-- Virginia - PRJ 061 - TAR 772 - 17/02/10
	vVPesEndereco = ""
	viParams = ""
	voParams = ""
	putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	if (voParams != "")
		vVPesEndereco = voParams
	endif
	
	;call convString("ds_siglaestado.v_pes_enderecsvc", ds_siglaestado.v_pes_enderecsvc, 2, vDsUfEmpresa)
	call convString(vSiglaEstado, $item("DS_SIGLAESTADO",vVPesEndereco), 2, vDsUfEmpresa)
	call convString("ds_60.tmp_ds60svc", ds_60.tmp_ds60svc, 2, vDsUfOrigem)

	setocc "TMP_K07NDD", 1
	while ($status >= 0)
		call convString("ds_chave07.tmp_k07ndd", ds_chave07.tmp_k07ndd, 2, vDsUfDestino)
		if (vDsUfOrigem = vDsUfDestino)
			;Listar imposto ICMS - substituicao tributaria referente a ENTRADA e SAIDA.
			clear/e "V_FIS_APURACASVC"
			CD_EMPFAT.v_fis_apuracasvc/init  = nr_chave04.tmp_k07ndd
			nr_fatura.v_fis_apuracasvc/init   = nr_chave05.tmp_k07ndd
			dt_fatura.v_fis_apuracasvc/init   = dt_chave06.tmp_k07ndd
			cd_imposto.v_fis_apuracasvc/init  = 2 ;ICMS - substituicao tributaria.
			tp_situacao.v_fis_apuracasvc/init = "E"
			retrieve/e "V_FIS_APURACASVC"
			if ($status >= 0)
				setocc "V_FIS_APURACASVC", 1
				while ($status >= 0)
					if (tp_operacao.v_fis_apuracasvc = "E")
						; @>-/-- Virginia - 111/1780 - Brascol
; -> rodrigo - prj 175 tar 398 - 20/08/2012
;						if (tp_origememissao.v_fis_apuracasvc = 1) & (cd_cfop.v_fis_apuracasvc != 1949) & (cd_cfop.v_fis_apuracasvc != 2949)
						if	(CD_CFOP.V_FIS_APURACASVC = 1410) | (CD_CFOP.V_FIS_APURACASVC = 1411) | (CD_CFOP.V_FIS_APURACASVC = 1414) | (CD_CFOP.V_FIS_APURACASVC = 1415) | %\
							(CD_CFOP.V_FIS_APURACASVC = 1660) | (CD_CFOP.V_FIS_APURACASVC = 1661) | (CD_CFOP.V_FIS_APURACASVC = 1662) | %\
							(CD_CFOP.V_FIS_APURACASVC = 2410) | (CD_CFOP.V_FIS_APURACASVC = 2411) | (CD_CFOP.V_FIS_APURACASVC = 2414) | (CD_CFOP.V_FIS_APURACASVC = 2415) | %\
							(CD_CFOP.V_FIS_APURACASVC = 2660) | (CD_CFOP.V_FIS_APURACASVC = 2661) | (CD_CFOP.V_FIS_APURACASVC = 2662)
; <- rodrigo - prj 175 tar 398 - 20/08/2012
							;Valor total imposto referente a devoluções.
							vlImpDevolucao = vlImpDevolucao + vl_imposto.v_fis_apuracasvc
						else
						; --\-<@
							;Valor total imposto referente a entrada.
							vlImpEntrada = vlImpEntrada + vl_imposto.v_fis_apuracasvc
						endif
					else
						;Valor total imposto referente a saida.
						vlImpSaida = vlImpSaida + vl_imposto.v_fis_apuracasvc
					endif
					
					setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
				endwhile
			endif
			clear/e "V_FIS_APURACASVC"
		endif
		setocc "TMP_K07NDD", $curocc(TMP_K07NDD) + 1
	endwhile

	; -> rodrigo - PRJ 170 TAR 242 - 15/04/2011
	clear/e "FIS_DETALHEICSVC"
	cd_empresa.fis_detalheicsvc/init = $item("CD_EMPRESA", $parametro$)
	dt_mesano.fis_detalheicsvc/init  = $item("DT_PERIODO", $parametro$)
	cd_imposto.fis_detalheicsvc/init = 1 ;ICMS.
	retrieve/e "FIS_DETALHEICSVC"
	if ($status >= 0)
		setocc "FIS_DETALHEICSVC", -1
		setocc "FIS_DETALHEICSVC", 1
		while ($status >= 0)
			if(CD_SPEDFISCAL.FIS_TIPODETICSVC[1:2] = DS_60.TMP_DS60SVC) & (CD_SPEDFISCAL.FIS_TIPODETICSVC[3:1] = 1)
				if(CD_SPEDFISCAL.FIS_TIPODETICSVC[4:1] = 0)
					vlImpDetDebito = vlImpDetDebito + VL_DETALHE.FIS_DETALHEICSVC
				endif
				if(CD_SPEDFISCAL.FIS_TIPODETICSVC[4:1] = 1)
					vEstornoCredito = vEstornoCredito + VL_DETALHE.FIS_DETALHEICSVC
				endif
				if(CD_SPEDFISCAL.FIS_TIPODETICSVC[4:1] = 2)
					vlImpDetCredito = vlImpDetCredito + VL_DETALHE.FIS_DETALHEICSVC
				endif
				if(CD_SPEDFISCAL.FIS_TIPODETICSVC[4:1] = 3)
					vEstornoDebito = vEstornoDebito + VL_DETALHE.FIS_DETALHEICSVC
				endif
				if(CD_SPEDFISCAL.FIS_TIPODETICSVC[4:1] = 4)
					vDed = vDed + VL_DETALHE.FIS_DETALHEICSVC
				endif
				if(CD_SPEDFISCAL.FIS_TIPODETICSVC[4:1] = 5)
					vImpDetDebEsp = vImpDetDebEsp + VL_DETALHE.FIS_DETALHEICSVC
				endif
			endif
			setocc "FIS_DETALHEICSVC", $curocc(FIS_DETALHEICSVC)+1
		endwhile
	endif
	; <- rodrigo - PRJ 170 TAR 242 - 15/04/2011

	;Valor a recolher de ICMS - substituicao tributaria.
	; -> rodrigo - PRJ 170 TAR 242 - 15/04/2011
;	vlIcmsRecolher = vlImpSaida - vlImpEntrada + vlImpDetDebito - vlImpDetCredito
	; @>-/-- Virgínia - 111/1787 - Brascol
	;vlIcmsRecolher = vlImpSaida - vlImpEntrada + vlImpDetDebito - vlImpDetCredito + vEstornoCredito - vEstornoDebito - vDed + vImpDetDebEsp
	vlIcmsRecolher = vlImpSaida - vlImpEntrada + vlImpDetDebito - vlImpDetCredito + vEstornoCredito - vEstornoDebito - vDed + vImpDetDebEsp - vlImpDevolucao
	; --\-<@
	; <- rodrigo - PRJ 170 TAR 242 - 15/04/2011
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E210", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""

	;01 - Texto fixo.
	vDsConteudo = "|E210"

	;02 - Indicador de movimento.
	vStringAux = "|0"
	if (vlImpEntrada > 0) | (vlImpSaida > 0) | (vlImpDetCredito > 0) | (vlImpDetDebito > 0)
		vStringAux = "|1"
	endif
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	
	viParams = ""
	voParams = ""
	;;ICJ [PROJ/TAR 170/2] (17/06/2010)	
	putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $parametro$)
	putitem/id viParams, "DT_MESANO",  $item("DT_PERIODO", $parametro$)
	putitem/id viParams, "TP_IMPOSTO", 2
	putitem/id viParams, "NM_CARREGATABELA", "FIS_SALDOIMPOSTO"
	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	vTabFisSaldoImposto	= ""
	if (voParams != "")
		vTabFisSaldoImposto = voParams
	endif
	vVlSaldoCredor = $item("VL_SALDOCREDOR", vTabFisSaldoImposto) 

	;03 - Valor do SALDO CREDOR DO PERIODO ANTERIOR - substituicao tributaria.
	vNumericAux = vVlSaldoCredor
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;04 - Valor total do ICMS ST de devolucao de mercadorias.
	; @>-/-- Virginia - 111/1780 - Brascol
	if (vlImpDevolucao > 0)
		vNumericAux = vlImpDevolucao
	else
	; --\-<@
		vNumericAux = 0
	endif
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;05 - Valor total do ICMS ST de ressarcimentos.
	vNumericAux = 0
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;06 - Valor total de ajustes (outros creditos ST e estorno de debito ST).
	vNumericAux = vlImpEntrada + vlImpDetCredito
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;07 - Valor total de ajustes a credito de ICMS ST.
	vNumericAux = vlImpDetCredito
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;08 - Valor total do ICMS retido por substituicao tributaria.
	; @>-/-- Virginia - PRJ 061 TAR 743 - 02/02/10
	; vNumericAux = 0
	vNumericAux = vlImpSaida
	; --\-<@
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;09 - Valor total dos ajustes (outros debitos ST e estorno de credito ST).
	;CFC: 29/04/2010 - foi comentado prorivísóriamente a pedido do Renan e mover sempre zero para o valor
	;vNumericAux = vlImpSaida + vlImpDetDebito

	; -> rodrigo = PRJ 170 TAR 242 - 15/04/2011 - ALIMENTAR com valor da somatória de outros débitos
;	vNumericAux = 0
	vNumericAux = vlImpDetDebito
	; <- rodrigo = PRJ 170 TAR 242 - 15/04/2011 - ALIMENTAR com valor da somatória de outros débitos
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;10 - Valor total dos ajustes a debito de ICMS decorrentes do documento fiscal.
	vNumericAux = vlImpDetDebito
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;11 - Valor total de SALDO DEVEDOR antes das deducoes (08+09+10)-(03+04+05+06+07).
	; @>-/-- Virginia - 111/1780 - Brascol
	;vNumericAux =  (vlImpSaida + vlImpDetDebito) - (vlImpEntrada + vlImpDetCredito + vVlSaldoCredor)
	vNumericAux =  (vlImpSaida + vlImpDetDebito) - (vlImpEntrada + vlImpDevolucao + vlImpDetCredito + vVlSaldoCredor)
	; --\-<@
	if (vNumericAux < 0)
		vNumericAux = 0
	endif
	vVlIcmsRecolher = vNumericAux
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;12 - Valor total de DEDUCOES ST.
	; -> rodrigo = PRJ 170 TAR 242 - 15/04/2011 - ALIMENTAR com valor da somatória de deduções
;	vNumericAux = 0
	vNumericAux = vDed
	; <- rodrigo = PRJ 170 TAR 242 - 15/04/2011 - ALIMENTAR com valor da somatória de deduções
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;13 - Imposto a recolher (11-12).
	; @>-/-- Virginia - 111/1780 - Brascol
	vVlIcmsRecolher = vVlIcmsRecolher - vDed
	; --\-<@
	vNumericAux = vVlIcmsRecolher
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;14 - Saldo credor de ST A TRANSPORTAR PARA O PERIODO SEGUINTE.
	vNumericAux = (vlImpEntrada + vlImpDetCredito + vVlSaldoCredor) - (vlImpSaida + vlImpDetDebito)
	if (vNumericAux < 0)
		vNumericAux = 0
	endif
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;15 - Valores recolhidos ou a recolher, extra-apuracao.
	; -> rodrigo = PRJ 170 TAR 242 - 15/04/2011 - ALIMENTAR com valor da somatória de debitos especiais
;	vNumericAux = 0
	vNumericAux = vImpDetDebEsp
	; <- rodrigo = PRJ 170 TAR 242 - 15/04/2011 - ALIMENTAR com valor da somatória de debitos especiais
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "E210"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("E210")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	;;ICJ [PROJ/TAR 170/206] 17/03/2011
	clear/e "FIS_DETALHEICSVC"
	cd_empresa.fis_detalheicsvc/init = $item("CD_EMPRESA", $parametro$)
	dt_mesano.fis_detalheicsvc/init  = $item("DT_PERIODO", $parametro$)
	cd_imposto.fis_detalheicsvc/init = 1 ;ICMS.
	retrieve/e "FIS_DETALHEICSVC"
	if ($status >= 0)
		setocc "FIS_DETALHEICSVC", -1
		setocc "FIS_DETALHEICSVC", 1
		while ($status >= 0)
			if (CD_SPEDFISCAL.FIS_TIPODETICSVC[1:2] = DS_60.TMP_DS60SVC) & (CD_SPEDFISCAL.FIS_TIPODETICSVC[3:1] = 1)
				vInGerou220 = <true> ; rodrigo - PRJ 170 TAR 242 - 14/04/2011

				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|E220"
				;Codigo COD_AJ_APUR.
				vStringAux = "|%%CD_SPEDFISCAL.FIS_TIPODETICSVC"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Descrição complementar.
				vStringAux = "|%%DS_DETALHADA.GLB_AJUSTEICMSVC"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;13 - Valor complementar
				vNumericAux = VL_DETALHE.FIS_DETALHEICSVC
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"
				;filedump/append vDsConteudo, ds_path.sis_filtro
				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "E220"
				ds_registro.sis_arquivosvc = vDsConteudo
			
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
			
				$instancehandle->totalizarQtdTipoRegistro("E220")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
			setocc "FIS_DETALHEICSVC", $curocc(FIS_DETALHEICSVC) + 1
		endwhile
	endif

	;;

	; -> rodrigo - PRJ 170 TAR 242 - 14/04/2011
	if(vInGerou220 = <true>)
		clear/e "FIS_NFITEMSVC"
		CD_EMPFAT.FIS_NFITEMSVC/init	= NR_CHAVE04.TMP_K07NDD
		dt_fatura.FIS_NFITEMSVC/init	= DT_CHAVE06.TMP_K07NDD
		nr_fatura.FIS_NFITEMSVC/init	= NR_CHAVE05.TMP_K07NDD
		retrieve/e "FIS_NFITEMSVC"
		if($status >= 0)
			setocc "FIS_NFITEMSVC", -1
			setocc "FIS_NFITEMSVC", 1
			while($status >= 0)
				if(VL_SUBTRIB.FIS_NFISELOENSVC != 0)&(VL_SUBTRIB.FIS_NFISELOENSVC != "")
					vDsConteudo = ""

					;Texto fixo.
					vDsConteudo = "|E240"

					clear/e "FIS_NFSVC"
					CD_EMPRESA.FIS_NFSVC/init	= NR_CHAVE04.TMP_K07NDD
					DT_FATURA.FIS_NFSVC/init	= DT_CHAVE06.TMP_K07NDD
					NR_FATURA.FIS_NFSVC/init	= NR_CHAVE05.TMP_K07NDD
					retrieve/e "FIS_NFSVC"
					if($status >= 0)
						;Codigo PAR
						vStringAux = "|%%CD_PESSOA.FIS_NFREMDESSVC"
						vDsConteudo = "%%vDsConteudo%%vStringAux"

						; Codigo MOD
						$tpModDoctoFiscal$ = TP_MODDCTOFISCAL.FIS_NFSVC
						vStringAux = "|%%$tpModDoctoFiscal$"
						vDsConteudo = "%%vDsConteudo%%vStringAux"

						; Serie
						vStringAux = "|%%CD_SERIE.FIS_NFSVC"
						vDsConteudo = "%%vDsConteudo%%vStringAux"

						; Sub
						vDsConteudo = "%%vDsConteudo%%%|" ; ficará em branco

						; Num. documento
						vStringAux = "|%%NR_NF.FIS_NFSVC"
						vDsConteudo = "%%vDsConteudo%%vStringAux"

						; Data de emissao
						vStringAux = "|%%DT_EMISSAO.FIS_NFSVC"
						vStringAux = $replace(vStringAux, 1, "/", "", -1)
						vDsConteudo = "%%vDsConteudo%%vStringAux"
					else
						vStringAux = "%%||||||"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
					endif

					; Codigo item
					vStringAux = "|%%CD_PRODUTO.FIS_NFITEMPROSVC"
					vDsConteudo = "%%vDsConteudo%%vStringAux"

					; Vl. ajuste item
					vStringAux = "|%%VL_SUBTRIB.FIS_NFISELOENSVC"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					vDsConteudo = "%%vDsConteudo%%%|%%^"

					creocc "SIS_ARQUIVOSVC", -1
					ds_reg.sis_arquivosvc = "E240"
					ds_registro.sis_arquivosvc = vDsConteudo


					$nrLinhaBloco$   = $nrLinhaBloco$   + 1
					$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
					$nrRegistroArq$  = $nrRegistroArq$  + 1

					$instancehandle->totalizarQtdTipoRegistro("E240")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
				setocc "FIS_NFITEMSVC", $curocc(FIS_NFITEMSVC) +1
			endwhile
		endif
	endif
	; <- rodrigo - PRJ 170 TAR 242 - 14/04/2011

	;Obrigacoes do ICMS a recolher - substituicao tributaria.
	if (vlIcmsRecolher != 0)
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E250", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|E250"
		;Codigo da obrigacao a recolher.
		;vStringAux = "|000" CFC: 28/04/2010 Comentado esta linha e criadas as linhas abaixo para validar a uforig/ufdestino
		;if (poDsUfOrig = $item("UF_ORIGEM",$xlplemp$))
		if  (vDsUfEmpresa = vDsUfOrigem)
			vStringAux = "|002"
		else
			vStringAux = "|999"
		endif
		;
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Valor da obrigacao a recolher.
		vNumericAux = vlIcmsRecolher
		; @>-/-- Virginia - 111/1776 - Brascol
		if (vNumericAux < 0)
			vNumericAux = 0
		endif
		; --\-<@
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Data de vencimento da obrigacao.
		vDtAux = $item("DT_VENCTOIMP", $parametro$)
		vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Codigo da receita referente a obrigacao, proprio da unidade da federacao.
		if (vCodigoReceita = "")
			vCodigoReceita = "TESTE"
		endif
		vDsConteudo = "%%vDsConteudo%%%|%%vCodigoReceita"
		;Numero do processo ao qual a obrigacao esta vinculada, se houver.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Indicador da origem do processo.
		;vStringAux = "|9"
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Descricao do processo que embasou o lancamento.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Descricao complementar das obrigacoes a recolher.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;-- MAD [Proj/Tar.170/082] - 28/10/2010
		;Mês/Ano de referência
		vDtAux = $item("DT_PERIODOINI", $parametro$)
		if (vDtAux >= "01/01/2011")
			vMes = vDtAux[m]
			if (vMes < 10)
				vAux = "%%%0%%vMes"
			else
				vAux = "%%vMes"
			endif
			vStringAux = "%%%|%%vAux%%vDtAux[y]"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
		endif
		;;
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "E250"
		ds_registro.sis_arquivosvc = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("E250")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	
	return(0)
End ;operation gerarEFDBlocoERegE210.


;-----------------------------------------------;
partner operation gerarEFDBlocoERegE500         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringAux, vNumericAux
		date    vDtAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E500", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|E500"
	;Indicador de periodo de apuracao do IPI.
	vStringAux = "|0"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Data inicial a que a apuracao se refere.
	vDtAux = $item("DT_PERIODOINI", $parametro$)
	vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;Data final a que a apuracao se refere.
	vDtAux = $item("DT_PERIODOFIM", $parametro$)
	vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "E500"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("E500")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Consolidacao dos valores do IPI por CFOP e codigo de tributacao do IPI.
	$instancehandle->gerarEFDBlocoERegE510($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Apuracao do IPI.
	$instancehandle->gerarEFDBlocoERegE520($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoERegE500.


;-----------------------------------------------------;
partner operation gerarEFDBlocoERegE510               ;
	;-----------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNulo, vCtIpi, vNumericAux
		numeric vVlSubTributaria
		boolean vInListar
	endvariables
	
	vNulo = ""
	clear/e "V_FIS_APURACASVC"
	CD_EMPFAT.v_fis_apuracasvc/init      = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.V_FIS_APURACASVC/init       = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	cd_imposto.v_fis_apuracasvc/init      = 3 ;IPI.
	tp_situacao.v_fis_apuracasvc/init     = "E"  ;aki
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", 1
		while ($status >= 0)
			
			;if (vInListar = <TRUE>)
				vCtIpi = ""
				if (tp_operacao.v_fis_apuracasvc = "E")
					;Entrada.
					if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4)
						if (vl_imposto.v_fis_apuracasvc > 0)
							vCtIpi = "00" ;Entrada com recuperação de crédito
						elseif (vl_basecalc.v_fis_apuracasvc > 0) & %\
							((vl_imposto.v_fis_apuracasvc = "") | (vl_imposto.v_fis_apuracasvc = 0)) & %\
							((pr_aliquota.v_fis_apuracasvc = "") | (pr_aliquota.v_fis_apuracasvc = 0))
							
							vCtIpi = "01" ;Entrada tributada com alíquota zero
						elseif (vl_isento.v_fis_apuracasvc > 0)
							vCtIpi = "02" ;Entrada isenta, quando tiver valor no campo de isento
						elseif (vl_imposto.v_fis_apuracasvc = "") | (vl_imposto.v_fis_apuracasvc = 0)
							vCtIpi = "05" ;Entrada com suspensão
						endif
					endif
					if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 2) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 3)
						vCtIpi = "49" ;Outras entradas
					endif
				else
					;Saida.
					if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 1) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 4)
						if (vl_imposto.v_fis_apuracasvc > 0)
							vCtIpi = "50" ;Saída tributada
						elseif (vl_basecalc.v_fis_apuracasvc > 0) & %\
							((vl_imposto.v_fis_apuracasvc = "") | (vl_imposto.v_fis_apuracasvc = 0)) & %\
							((pr_aliquota.v_fis_apuracasvc = "") | (pr_aliquota.v_fis_apuracasvc = 0))
							vCtIpi = "51" ;Saída tributada com alíquota zero
						elseif (vl_isento.v_fis_apuracasvc > 0)
							vCtIpi = "52" ;Saída isenta
						elseif (vl_imposto.v_fis_apuracasvc = "") | (vl_imposto.v_fis_apuracasvc = 0)
							vCtIpi = "55" ;Saída com suspensão
						endif
					endif
					if ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 2) | ($item("NATUREZA_COMERCIAL_EMP",$xlplemp$) = 3)
						vCtIpi = "99" ;Outas saídas
					endif
				endif
				
				creocc "TMP_K03NR2VL1SVC", -1
				nr_k01.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
				nr_k02.tmp_k03nr2vl1svc = vCtIpi
				vl_k03.tmp_k03nr2vl1svc = 1
				retrieve/o "TMP_K03NR2VL1SVC"
				if ($status = 4)
					retrieve/x "TMP_K03NR2VL1SVC"
				endif
				vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_totalliquido.v_fis_apuracasvc
				vl_baseipi.tmp_k03nr2vl1svc  = vl_baseipi.tmp_k03nr2vl1svc  + vl_basecalc.v_fis_apuracasvc
				vl_ipi.tmp_k03nr2vl1svc      = vl_ipi.tmp_k03nr2vl1svc      + vl_imposto.v_fis_apuracasvc
				
				if ($next(nr_nf.v_fis_apuracasvc)           != nr_nf.v_fis_apuracasvc)     | %\
				($next(cd_pessoa.v_fis_apuracasvc)       != cd_pessoa.v_fis_apuracasvc) | %\
				($next(dt_saidaentrada.v_fis_apuracasvc) != dt_saidaentrada.v_fis_apuracasvc)
				
				clear/e "FIS_S_NFSVC"
				CD_EMPFAT.fis_s_nfsvc/init = CD_EMPFAT.v_fis_apuracasvc
				nr_fatura.fis_s_nfsvc/init  = nr_fatura.v_fis_apuracasvc
				dt_fatura.fis_s_nfsvc/init  = dt_fatura.v_fis_apuracasvc
				retrieve/e "FIS_S_NFSVC"
				vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_despacessor.fis_s_nfsvc + vl_frete.fis_s_nfsvc + vl_seguro.fis_s_nfsvc + vl_ipi.fis_s_nfsvc
			;endif
		endif
		
		setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
	endwhile
endif
clear/e "V_FIS_APURACASVC"
clear/e "FIS_NFITEMIMPSVC"

if (!$empty("TMP_K03NR2VL1SVC"))
	sort/e "TMP_K03NR2VL1SVC", "nr_k01.tmp_k03nr2vl1svc, nr_k02.tmp_k03nr2vl1svc"
	setocc "TMP_K03NR2VL1SVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E510 / %%nr_k01.tmp_k03nr2vl1svc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|E510"
		;Codigo fiscal de operacao e prestacao do agrupamento de itens.
		vNumericAux = nr_k01.tmp_k03nr2vl1svc
		call convNumeric(vNumericAux, 4, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Codigo de tributacao do IPI.
		if (nr_k02.tmp_k03nr2vl1svc = "") | (nr_k02.tmp_k03nr2vl1svc = 0)
			vStringAux = "00"
		elseif (nr_k02.tmp_k03nr2vl1svc = "5")
			vStringAux = "05"
		elseif (nr_k02.tmp_k03nr2vl1svc = "49")
			vStringAux = "49"
		elseif (nr_k02.tmp_k03nr2vl1svc = "50")
			vStringAux = "50"
		elseif (nr_k02.tmp_k03nr2vl1svc = "55")
			vStringAux = "55"
		elseif (nr_k02.tmp_k03nr2vl1svc = "99")
			vStringAux = "99"
		;-- MAD [Proj/Tar.175/189] - 14/07/2011
		elseif (nr_k02.tmp_k03nr2vl1svc = "1")
			vStringAux = "01"
		elseif (nr_k02.tmp_k03nr2vl1svc = "2")
			vStringAux = "02"
		else
			vStringAux = "%%nr_k02.tmp_k03nr2vl1svc"
		;;
		endif
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Parcela correspondente ao valor contabil referente ao CFOP e ao codigo de tributacao do IPI.
		vNumericAux = vl_contabil.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor da base de calculo do IPI referente ao CFOP e ao codigo de tributacao do IPI.
		vNumericAux = vl_baseipi.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor do IPI referente ao CFOP e ao codigo de tributacao do IPI.
		vNumericAux = vl_ipi.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
		
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "E510"
		ds_registro.sis_arquivosvc = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("E510")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
	endwhile
endif
clear/e "TMP_K03NR2VL1SVC"

return(0)
End ;operation gerarEFDBlocoERegE510.


;------------------------------------------------;
partner operation gerarEFDBlocoERegE520          ;
	;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux, vTabFisSaldoImposto, viParams, voParams
		numeric vSaldoCredorIpi, vSaldoDevedorIpi, vlImpEntrada, vlImpSaida, vlImpDetCredito, vlImpDetDebito, vVlSaldoCredor
		boolean vInListar
	endvariables
	
	vlImpEntrada    = 0
	vlImpSaida      = 0
	vlImpDetCredito = 0
	vlImpDetDebito  = 0
	
	;Listar imposto ICMS referente a ENTRADA e SAIDA.
	clear/e "V_FIS_APURACASVC"
	CD_EMPFAT.v_fis_apuracasvc/init      = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.V_FIS_APURACASVC/init       = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	cd_imposto.v_fis_apuracasvc/init      = 3 ;IPI.
	tp_situacao.v_fis_apuracasvc/init     = "E"  ;aki
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", 1
		while ($status >= 0)
			;if (vInListar = <TRUE>)
				if (tp_operacao.v_fis_apuracasvc = "E")
					;Valor total imposto referente a entrada.
					vlImpEntrada = vlImpEntrada + vl_imposto.v_fis_apuracasvc
				else
					;Valor total imposto referente a saida.
					vlImpSaida = vlImpSaida + vl_imposto.v_fis_apuracasvc
				endif
			;endif
			
			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
	endif
	clear/e "V_FIS_APURACASVC"
	
	clear/e "FIS_DETALHEICSVC"
	cd_empresa.fis_detalheicsvc/init = $item("CD_EMPRESA", $parametro$)
	dt_mesano.fis_detalheicsvc/init  = $item("DT_PERIODO", $parametro$)
	cd_imposto.fis_detalheicsvc/init = 3 ;IPI.
	retrieve/e "FIS_DETALHEICSVC"
	if ($status >= 0)
		setocc "FIS_DETALHEICSVC", 1
		while ($status >= 0)
			
			;; ICJ [PROJ/TAR 189/91] ()16/02/2012)
			;if (ds_debcred.fis_tipodeticsvc = "D")
			if (DS_DEBCRED.FIS_TIPODETICSVC = "D") | (DS_DEBCRED.FIS_TIPODETICSVC = "F")
			;;
				;Debito.
				vlImpDetDebito = vlImpDetDebito + vl_detalhe.fis_detalheicsvc
			else
				;Credito.
				vlImpDetCredito = vlImpDetCredito + vl_detalhe.fis_detalheicsvc
			endif
			
			setocc "FIS_DETALHEICSVC", $curocc(FIS_DETALHEICSVC) + 1
		endwhile
	endif
	clear/e "FIS_DETALHEICSVC"
	
	viParams = ""
	voParams = ""
	;;ICJ [PROJ/TAR 170/2] (17/06/2010)	
	putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $parametro$)
	putitem/id viParams, "DT_MESANO",  $item("DT_PERIODO", $parametro$)
	putitem/id viParams, "TP_IMPOSTO", 3
	putitem/id viParams, "NM_CARREGATABELA", "FIS_SALDOIMPOSTO"
	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif
	vTabFisSaldoImposto	= ""
	if (voParams != "")
		vTabFisSaldoImposto = voParams
	endif
	
	vVlSaldoCredor = $item("VL_SALDOCREDOR", vTabFisSaldoImposto) 
	
	$instancehandle->setDisplay("Gerando Escrituragão Fiscal Digital: Bloco E - registro E520", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|E520"
	;Saldo credor do IPI transferido do periodo anterior.
	vNumericAux = vVlSaldoCredor
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor total dos debitos por SAIDAS COM DEBITO DO IMPOSTO.
	vNumericAux = vlImpSaida
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor total dos creditos por ENTRADAS E AQUISICOES COM CREDITO DO IMPOSTO.
	vNumericAux = vlImpEntrada
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor de OUTROS DEBITOS do IPI (inclusive estornos de credito).
	vNumericAux = vlImpDetDebito
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor de OUTROS CREDITOS do IPI (inclusive estornos de debito).
	vNumericAux = vlImpDetCredito
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor do saldo credor do IPI a transportar para o periodo seguinte.
	vSaldoCredorIpi  = (vlImpSaida + vlImpDetDebito) - (vVlSaldoCredor + vlImpEntrada + vlImpDetCredito)
	vSaldoDevedorIpi = (vlImpSaida + vlImpDetDebito) - (vVlSaldoCredor + vlImpEntrada + vlImpDetCredito)
	if (vSaldoCredorIpi < 0)
		vSaldoCredorIpi = vSaldoCredorIpi * -1
		vSaldoDevedorIpi = 0
	elseif (vSaldoDevedorIpi > 0)
		vSaldoCredorIpi = 0
	endif
	call editarNr(12, 2, vSaldoCredorIpi, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Valor do saldo devedor do IPI a recolher.
	call editarNr(12, 2, vSaldoDevedorIpi, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "E520"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("E520")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Ajustes da apuracao do IPI.
	$instancehandle->gerarEFDBlocoERegE530($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoERegE520.


;------------------------------------------------;
partner operation gerarEFDBlocoERegE530          ;
	;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		numeric vVlSubTributaria
		date    vDtAux
	endvariables
	
	clear/e "FIS_DETALHEICSVC"
	cd_empresa.fis_detalheicsvc/init = $item("CD_EMPRESA", $parametro$)
	dt_mesano.fis_detalheicsvc/init  = $item("DT_PERIODO", $parametro$)
	cd_imposto.fis_detalheicsvc/init = 3 ;IPI.
	retrieve/e "FIS_DETALHEICSVC"
	if ($status >= 0)
		sort/e "FIS_DETALHEICSVC", "dt_mesano.fis_detalheicsvc"
		setocc "FIS_DETALHEICSVC", 1
		while ($status >= 0)
			$instancehandle->setDisplay("Gerando Escrituragão Fiscal Digital: Bloco E - registro E530 / %%nr_sequencia.fis_detalheicsvc", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|E530"
			;Indicador do tipo de ajuste.
			;; ICJ [PROJ/TAR 189/91] ()16/02/2012)
			;if (ds_debcred.fis_tipodeticsvc = "D")
			if (DS_DEBCRED.FIS_TIPODETICSVC = "D") | (DS_DEBCRED.FIS_TIPODETICSVC = "F")
			;;
				;Ajuste a debito.
				vStringAux = "|0"
			else
				;Ajuste a credito.
				vStringAux = "|1"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor do ajuste.
			vNumericAux = vl_detalhe.fis_detalheicsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo do ajuste da apuracao.
			;-- MAD [Proj/Tar.170/253] - 26/05/2011
			;vNumericAux = cd_detalhamento.fis_detalheicsvc
			vNumericAux = cd_ajusteipi.fis_tipodeticsvc
			;;
			call convNumeric(vNumericAux, 3, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Indicador da origem do documento vinculado ao ajuste.
			vStringAux = "|9"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Numero do documento/processo/declaracao.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Descricao detalhada do ajuste.
			vStringAux = "|%%ds_descricao.fis_detalheicsvc"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "E530"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("E530")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			setocc "FIS_DETALHEICSVC", $curocc(FIS_DETALHEICSVC) + 1
		endwhile
	endif
	clear/e "FIS_DETALHEICSVC"
	
	return(0)
End ;operation gerarEFDBlocoERegE530.


;-----------------------------------------------;
partner operation gerarEFDBlocoERegE990         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco E - registro E990", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|E990"
	;Quantidade total de linhas do bloco E.
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	vStringAux = "|%%$nrLinhaBloco$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "E990"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("E990")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoERegE990.


;---------------------------------------------------;
partner operation gerarEFDBlocoH                    ;
	;---------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	$nrLinhaBloco$ = ""
	;Abertura do bloco H.
	$instancehandle->gerarEFDBlocoHRegH001($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	if ($item("IN_BLOCOH", $parametro$) = <TRUE>)
		;Totais do inventario.
		$instancehandle->gerarEFDBlocoHRegH005($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	
	;Encerramento do bloco H.
	$instancehandle->gerarEFDBlocoHRegH990($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoH.


;-----------------------------------------------;
partner operation gerarEFDBlocoHRegH001         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		boolean vInMovimento
	endvariables

	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco H - registro H001", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|H001"
	;Indicador de movimento.
	if ($item("IN_BLOCOH", $parametro$) = <TRUE>)
		vStringAux = "|0"
	else
		vStringAux = "|1"
	endif
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "H001"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("H001")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoHRegH001.


;------------------------------------------------;
partner operation gerarEFDBlocoHRegH005          ;
	;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vpiParams, vpoParams, vNumericAux, voParams, viParams, vcdEspecie, vTipo, vfisTipi, vCaminho
		numeric vVlInventario, vVlItem, vQtSaldo, vVlUnitario, vTotdig
		date    vDtAux
		string vDsLstInventario, vDsLinha
		numeric vCdEmpresa, vCdInventario, vQtMovimentada
	endvariables


	if ($item("TP_INVENTARIO", $parametro$) = 1)	
		if ($item("TP_CODPRODUTO", $parametro$) != 1);Grupo
			clear/e "F_PRD_PRODUTOSVC"
			retrieve/e "F_PRD_PRODUTOSVC"    
			if ($status >=0)
				while ($status>=0)
					$instancehandle->setDisplay("Processando inventário - Produto: %%CD_PRODUTO.F_PRD_PRODUTOSVC", "", "")
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
					endif	
					call RegistroTpinvent(1)
					setocc "F_PRD_PRODUTOSVC", $curocc(F_PRD_PRODUTOSVC)+ 1
				endwhile
			endif
		else
			clear/e "PRD_GRUPOSVC"
			CD_GRADE.PRD_GRUPOSVC/init = "·>0"
			retrieve/e "PRD_GRUPOSVC"
			if ($status >= 0)
				setocc "PRD_GRUPOSVC", -1
				setocc "PRD_GRUPOSVC", 1
				sort/e "PRD_GRUPOSVC", "CD_SEQ.PRD_GRUPOSVC"
				while ($status >= 0)    
					$instancehandle->setDisplay("Processando inventário - Grupo: %%CD_SEQ.PRD_GRUPOSVC", "", "")
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
					endif
					call RegistroTpinvent(2)
					setocc "PRD_GRUPOSVC", $curocc(PRD_GRUPOSVC)+ 1
				endwhile
			endif

			clear/e "F_PRD_PRODUTOSVC"
			retrieve/e "F_PRD_PRODUTOSVC"    
			if ($status >=0)
		   	while ($status>=0)
					$instancehandle->setDisplay("Processando inventário Tipo 2 - Produto: %%CD_PRODUTO.F_PRD_PRODUTOSVC", "", "")
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
					endif
					call RegistroTpinvent(1)
					setocc "F_PRD_PRODUTOSVC", $curocc(F_PRD_PRODUTOSVC)+ 1
				endwhile
			endif
		endif
	elseif ($item("TP_INVENTARIO", $parametro$) = 2)
		if ($item("DS_LSTINVENTARIO", $parametro$) != "")
			clear/e "PRD_INVCSVC"
			vDsLstInventario = $item("DS_LSTINVENTARIO", $parametro$)
			repeat
				getitem vDsLinha, vDsLstInventario, 1
				vCdEmpresa = $item("CD_EMPRESA", vDsLinha)
				vCdInventario = $item("CD_INVENTARIO", vDsLinha)
				creocc "PRD_INVCSVC" - 1
				CD_EMPRESA.PRD_INVCSVC = vCdEmpresa
				CD_INVENTARIO.PRD_INVCSVC = vCdInventario
				retrieve/o "PRD_INVCSVC"
				if ($status = -7)
					retrieve/x "PRD_INVCSVC"
				endif
				delitem vDsLstInventario, 1
			until (vDsLstInventario = "")
			setocc "PRD_INVCSVC", 1
			while ($status > 0)
				setocc "PRD_INVISVC", 1
				while ($status > 0)
					if((($item("TP_TIPOSALDO", $parametro$) = 1) & (QT_SALDO.PRD_INVISVC > 0)) | %\
					   (($item("TP_TIPOSALDO", $parametro$) = 2) & (QT_SALDO.PRD_INVISVC < 0)) | %\
					   (($item("TP_TIPOSALDO", $parametro$) = 3) & (QT_SALDO.PRD_INVISVC = 0)) | %\
					   ($item("TP_TIPOSALDO", $parametro$)  = ""))
						call RegistroPrdInv()
					endif				
					setocc "PRD_INVISVC", $curocc("PRD_INVISVC") + 1
				endwhile
				setocc "PRD_INVCSVC", $curocc("PRD_INVCSVC") + 1
			endwhile
		endif
	endif
	;;ICJ [PROJ/TAR 189/64] (12/01/2012)
	if ($item("IN_SALDOTERCEIRO", $parametro$) = <TRUE>)
		clear/e "PRD_PESMOVSVC"
		CD_EMPRESA.PRD_PESMOVSVC/init 	= $item("CD_EMPRESA", $parametro$)
		DT_MOVIMENTO.PRD_PESMOVSVC/init	= $item("DT_SALDO", $parametro$)
		retrieve/e "PRD_PESMOVSVC"
		if ($status >=0)
			setocc "PRD_PESMOVSVC", -1
			sort "PRD_PESMOVSVC", "CD_PRODUTO.PRD_PESMOVSVC, CD_PESSOA.PRD_PESMOVSVC"
			setocc "PRD_PESMOVSVC", 1
			while ($status >= 0)
				if ($next(CD_PRODUTO.PRD_PESMOVSVC) = CD_PRODUTO.PRD_PESMOVSVC) & ($next(CD_PESSOA.PRD_PESMOVSVC) = CD_PESSOA.PRD_PESMOVSVC)
					vQtMovimentada = vQtMovimentada + QT_MOVIMENTADA.PRD_PESMOVSVC
				else
					call RegistroInventTerc(vQtMovimentada)
					vQtMovimentada = 0
				endif
				setocc "PRD_PESMOVSVC", $curocc("PRD_PESMOVSVC") + 1
			endwhile
		endif
	endif
	;;

	if ($empty("CSV_SINT74"))
		return(0)
	endif

	vVlInventario = 0
	setocc "CSV_SINT74", 1
	while ($status >= 0)
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco H - registro H005 / %%CAMPO01.CSV_SINT74", "", "")
		if ($procerror)    
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		;09/02/2011 - ICJ
		;vVlInventario = vVlInventario + CAMPO05.CSV_SINT74
		vVlInventario = vVlInventario + CAMPO15.CSV_SINT74
		setocc "CSV_SINT74", $curocc(CSV_SINT74) + 1
	endwhile
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco H - registro H005", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|H005"
	;Data do inventario.
	vDtAux = $item("DT_SALDO", $parametro$)
	vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;Valor total do estoque.
	vNumericAux = vVlInventario
	call editarNr(12, 2, vNumericAux, vNumericAux)
	call convValorString(2,vNumericAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	;-- MAD [Proj/Tar.170/539] - 06/09/2012
	;Motivo do Inventário
	vStringAux  = $item("TP_MOTIVOINVENTARIO", $parametro$)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
	;;
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "H005"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("H005")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	if (vVlInventario > 0)
		;Inventario.
		$instancehandle->gerarEFDBlocoHRegH010($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
			
	endif
	
	return(0)
End ;operation gerarEFDBlocoHRegH005.


;------------------------------------------------;
partner operation gerarEFDBlocoHRegH010          ;
	;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vpiParams, vpoParams, vCdEspecie, vNumericAux, vFisTipi
		string  vTipo, vsTraux, vTotDig, viParams, voParams, vDsItem, vAux, vCdTipi
		numeric vVlSubTributaria, vQtSaldo, vVlUnitario, vVlItem
		date    vDtAux
	endvariables

	clear/e "F_TMP_DS60SVC"
	setocc "CSV_SINT74", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco H - registro H010 / %%campo03.CSV_SINT74", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|H010"
		;Codigo do item.
		;call convNumeric(CAMPO01.CSV_SINT74, 9, vStringConv) ;Comentado por Deusdete, pois o cod. do produto está no campo03
		;call convNumeric(CAMPO03.CSV_SINT74, 14, vStringConv)
		vStringConv = CAMPO03.CSV_SINT74
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Unidade do item.
		clear/e "PRD_PRODUTOSVC"
		cd_produto.prd_produtosvc/init = CAMPO03.CSV_SINT74
		retrieve/e "PRD_PRODUTOSVC"
		
		vCdEspecie = cd_especie.prd_produtosvc    
		vCdTipi	  = cd_tipi.prd_produtosvc    
		clear/e "PRD_TIPOESPECSVC"
		cd_especie.prd_tipoespecsvc/init = cd_especie.prd_produtosvc
		retrieve/e "PRD_TIPOESPECSVC"
		if ($status < 0)
			vCdEspecie = ""
		endif
		if (vCdEspecie = "")
			clear/e "PRD_TIPOESPECSVC"
			retrieve/e "PRD_TIPOESPECSVC"
			setocc "PRD_TIPOESPECSVC", 1
			vCdEspecie = cd_especie.prd_tipoespecsvc
		endif
		vStringAux = "|%%vCdEspecie"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Quantidade do item.
		call editarNr(13, 2, CAMPO04.CSV_SINT74, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor unitario do item.
		call editarNr(10, 6, CAMPO05.CSV_SINT74, vNumericAux)
		call convValorString(6,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor do item.
		call editarNr(12, 2, CAMPO15.CSV_SINT74, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Indicador de propriedade/posse do item
		vStringAux = "|%%CAMPO06.CSV_SINT74"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;--> VSOUZA PRJ/TAR 170/392 11/11/2011
		;Codigo do participante.
		if (CAMPO06.CSV_SINT74 = "1")
			;;ICJ [PROJ/TAR 189/64] (12/01/2012)
			;call convNumeric(CD_PESSOA.FIS_S_NFREMDESVC, 9, vStringConv)
			call convNumeric(CD_PESSOA.CSV_SINT74, 9, vStringConv)
			;;
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		else
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
		endif
		;--------------------------------------<
		;Descricao complementar.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Codigo da conta analitica contabil debitada/creditada.
		vStringAux = $item("CD_CONTACONTABIL", $parametro$)

		; -> rodrigo - PRJ 189 TAR 220 - 04/09/2012
		if(vStringAux = "")&($cdTpClassProd$ != "")
			clear/e "PRD_PRODUTOCLSVC"
			CD_PRODUTO.PRD_PRODUTOCLSVC/init	= CD_PRODUTO.PRD_PRODUTOSVC
			CD_TIPOCLAS.PRD_PRODUTOCLSVC/init	= $cdTpClassProd$
			retrieve/e "PRD_PRODUTOCLSVC"
			if($status >= 0)
				clear/e "CTB_DPLINPRDSVC"
				CD_TIPOCLAS.CTB_DPLINPRDSVC/init 	= CD_TIPOCLAS.PRD_PRODUTOCLSVC
				CD_LINHA.CTB_DPLINPRDSVC/init		= CD_CLASSIFICACAO.PRD_PRODUTOCLSVC
				retrieve/e "CTB_DPLINPRDSVC"
				if($status >= 0)
					if(CD_REDUZIDO.CTB_DPLINPRDSVC != "")
						call validaConta(CD_REDUZIDO.CTB_DPLINPRDSVC, vStringAux)
					endif
				endif
			endif

			clear/e "PRD_PRODUTOCLSVC"
			clear/e "CTB_DPLINPRDSVC"
		endif
		; <- rodrigo - PRJ 189 TAR 220 - 04/09/2012

		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
		
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "H010"
		ds_registro.sis_arquivosvc = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("H010")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	
		;;ICJ [PROJ/TAR 170/196] (16/02/2011)
		if ($item("TP_CODPRODUTO", $parametro$) = 4)
			creocc "F_TMP_DS40SVC", -1
			DS_40.F_TMP_DS40SVC = CAMPO03.CSV_SINT74
			if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
				clear/e "PRD_PRDCONVMESVC"
				CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "PRD_PRDCONVMESVC"
				if ($status >= 0)
					$instancehandle->totalizarQtdTipoRegistro("0220")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			retrieve/o "F_TMP_DS40SVC"
			if ($status = 4)
				retrieve/x "F_TMP_DS40SVC"
			else
				clear/e "PRD_PRODUTOSVC"
				cd_produto.prd_produtosvc/init = CAMPO03.CSV_SINT74
				retrieve/e "PRD_PRODUTOSVC"
				if ($status >= 0)
					ds_produto.F_TMP_DS40SVC = ds_produto.prd_produtosvc
					ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
					vCdEspecie = cd_especie.prd_produtosvc
					if (cd_tipi.prd_produtosvc != "")
						vFisTipi = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
						activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vFisTipi = voParams
							vStrAux = $item("CD_TIPI",vFisTipi)
							vStrAux = $replace(vStrAux, 1, ".","",-1)	
							cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
						endif
						; --\-<@
					endif
				endif
				creocc "TMP_NRDSSVC", -1
				nr_geral.tmp_nrdssvc = 1
				ds_geral.tmp_nrdssvc = vCdEspecie
				retrieve/o "TMP_NRDSSVC"
				if ($status = 4)
					retrieve/x "TMP_NRDSSVC"
				endif
			endif
		
		else
			creocc "F_TMP_DS60SVC", -1
			;call convNumeric(CAMPO03.CSV_SINT74, 14, DS_60.F_TMP_DS60SVC)
			DS_60.F_TMP_DS60SVC = CAMPO03.CSV_SINT74
			if (DS_60.F_TMP_DS60SVC != "") ; --/-<@ Virginia - 24/05/2011
				clear/e "PRD_PRDCONVMESVC"
				CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_60.F_TMP_DS60SVC
				retrieve/e "PRD_PRDCONVMESVC"
				if ($status >= 0)
					$instancehandle->totalizarQtdTipoRegistro("0220")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			retrieve/o "F_TMP_DS60SVC"
			if ($status = 4)
				retrieve/x "F_TMP_DS60SVC"
			else
				DS_PRODUTO.F_TMP_DS60SVC	= DS_PRODUTO.CSV_SINT74
				DS_ESPECIE.F_TMP_DS60SVC 	= vCdEspecie
				CD_TIPI.F_TMP_DS60SVC  	= vCdTipi
				CD_PRODUTO.F_TMP_DS60SVC	= CD_PRODUTO.CSV_SINT74

				creocc "TMP_NRDSSVC", -1
				nr_geral.tmp_nrdssvc = 1
				ds_geral.tmp_nrdssvc = vCdEspecie
				retrieve/o "TMP_NRDSSVC"
				if ($status = 4)
					retrieve/x "TMP_NRDSSVC"
				endif
			endif
		endif
		;;

		;-- MAD [Proj/Tar.170/540] - 11/09/2012
		if ($item("TP_MOTIVOINVENTARIO",$parametro$) != "" & $item("TP_MOTIVOINVENTARIO",$parametro$) != "01") & %\
		   (CAMPO15.CSV_SINT74 > 0)

			;Informação complementar do Inventário
			$instancehandle->gerarEFDBlocoHRegH020($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		;;

		setocc "CSV_SINT74", $curocc(CSV_SINT74) + 1
	endwhile
		
	return(0)
End ;operation gerarEFDBlocoHRegH010.


;------------------------------------------;
;-- MAD [Proj/Tar.170/540] - 11/09/2012    ;
partner operation gerarEFDBlocoHRegH020    ;
;------------------------------------------;

	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		numeric vCdRegraFiscal, vPrAliquota, vVlIcms, vVlBaseCalc
		string  vDsConteudo, vStringConv, vStringAux, vCdCst
	endvariables
	
	vCdRegraFiscal = ""
	vPrAliquota    = ""
	vCdCst         = "0"
	vVlIcms        = 0
	vVlBaseCalc    = CAMPO15.CSV_SINT74

	if ($item("CD_OPERACAO", $parametro$) != "")

		if (PR_ALIQICMS.FIS_ALIQUOTAISVC = "")
			clear/e "FIS_ALIQUOTAISVC"
			CD_UFORIGEM.FIS_ALIQUOTAISVC/init  = $item("UF_ORIGEM",$xlplemp$)
			CD_UFDESTINO.FIS_ALIQUOTAISVC/init = $item("UF_ORIGEM",$xlplemp$)
			retrieve/e "FIS_ALIQUOTAISVC"
			if ($status < 0)
				clear/e "FIS_ALIQUOTAISVC"
			endif
		endif

		clear/e "F_PRD_PRODUTOSVC"
		CD_PRODUTO.F_PRD_PRODUTOSVC/init = CAMPO03.CSV_SINT74
		retrieve/e "F_PRD_PRODUTOSVC"    
		if ($status >= 0)
			vCdCST = CD_CST.F_PRD_PRODUTOSVC[1:1]
		endif

		clear/e "PRD_PRDREGRAFSVC"
		CD_PRODUTO.PRD_PRDREGRAFSVC/init  = CAMPO03.CSV_SINT74
		CD_OPERACAO.PRD_PRDREGRAFSVC/init = $item("CD_OPERACAO", $parametro$)
		retrieve/e "PRD_PRDREGRAFSVC"
		if ($status >= 0)
			vCdRegraFiscal = CD_REGRAFISCAL.PRD_PRDREGRAFSVC
		else
			if (CD_REGRAFISCAL.GER_S_OPERACASVC = "")
				clear/e "GER_S_OPERACASVC"
				CD_OPERACAO.GER_S_OPERACASVC/init = $item("CD_OPERACAO", $parametro$)
				retrieve/e "GER_S_OPERACASVC"
				if ($status < 0)
					clear/e "GER_S_OPERACASVC"
				endif
			endif
			vCdRegraFiscal = CD_REGRAFISCAL.GER_S_OPERACASVC
		endif

		clear/e "FIS_REGRAFISCSVC"
		CD_REGRAFISCAL.FIS_REGRAFISCSVC/init = vCdRegraFiscal
		retrieve/e "FIS_REGRAFISCSVC"
		if ($status >= 0)
			if (IN_NOVAREGRA.FIS_REGRAADICSVC = <TRUE>)
				
				clear/e "FIS_REGRAIMPOSVC"
				CD_IMPOSTO.FIS_REGRAIMPOSVC/init = 1 
				retrieve/e "FIS_REGRAIMPOSVC"
				if ($status >= 0)

					vCdCst = "%%vCdCST%%CD_CST.FIS_REGRAIMPOSVC[1:2]"

					if (PR_ALIQUOTA.FIS_REGRAIMPOSVC != "")
						vPrAliquota = PR_ALIQUOTA.FIS_REGRAIMPOSVC
					else
						vPrAliquota = PR_ALIQICMS.FIS_ALIQUOTAISVC
					endif

					if (PR_REDUBASE.FIS_REGRAIMPOSVC > 0)
						vVlBaseCalc = vVlBaseCalc - (vVlBaseCalc * PR_REDUBASE.FIS_REGRAIMPOSVC / 100)
					endif

					if (PR_REDUIMP.FIS_REGRAIMPOSVC > 0)
						vVlIcms = (vVlBaseCalc * ((100 - PR_REDUIMP.FIS_REGRAIMPOSVC)/100) * vPrAliquota) / 100
					else
						vVlIcms = vVlBaseCalc * vPrAliquota / 100
					endif
				endif

			else
				vCdCst = "%%vCdCST%%CD_CST.FIS_REGRAFISCSVC[1:2]"

				if (PR_ALIQICMS.FIS_REGRAFISCSVC != "")
					vPrAliquota = PR_ALIQICMS.FIS_REGRAFISCSVC
				else
					vPrAliquota = PR_ALIQICMS.FIS_ALIQUOTAISVC
				endif

				if (TP_REDUCAO.FIS_REGRAFISCSVC = "A" | TP_REDUCAO.FIS_REGRAFISCSVC = "C" | %\
					TP_REDUCAO.FIS_REGRAFISCSVC = "G" | TP_REDUCAO.FIS_REGRAFISCSVC = "I")

					vVlBaseCalc = vVlBaseCalc - (vVlBaseCalc * PR_REDUBASE.FIS_REGRAFISCSVC / 100)
				endif

				if (TP_REDUCAO.FIS_REGRAFISCSVC = "B" | TP_REDUCAO.FIS_REGRAFISCSVC = "C" | %\
					TP_REDUCAO.FIS_REGRAFISCSVC = "H" | TP_REDUCAO.FIS_REGRAFISCSVC = "I")

					vVlIcms = (vVlBaseCalc * ((100 - PR_REDUBASE.FIS_REGRAFISCSVC)/100) * vPrAliquota) / 100
				else
					vVlIcms = vVlBaseCalc * vPrAliquota / 100
				endif
			endif	
		endif
	endif

	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco H - registro H020 / %%CAMPO03.CSV_SINT74", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif

	vDsConteudo = ""

	;Texto fixo.
	vDsConteudo = "|H020"

	;CST do ICMS
	vStringAux = vCdCst
	call convNumeric(vStringAux, 3, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;Base de cálculo do ICMS
	vStringAux = vVlBaseCalc
	call editarNr(12, 2, vStringAux, vStringAux)
	call convValorString(2,vStringAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;Valor do ICMS a ser debitado ou creditado
	vStringAux = vVlIcms
	call editarNr(12, 2, vStringAux, vStringAux)
	call convValorString(2,vStringAux, vStringConv)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
		
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "H020"
	ds_registro.sis_arquivosvc = vDsConteudo
		
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
		
	$instancehandle->totalizarQtdTipoRegistro("H020")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	return(0)

End ; operation gerarEFDBlocoHRegH020.
;;

;-----------------------------------------------;
partner operation gerarEFDBlocoHRegH990         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco H - registro H990", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|H990"
	;Quantidade total de linhas do bloco H.
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	vStringAux = "|%%$nrLinhaBloco$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "H990"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("H990")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBlocoHRegH990.


;---------------------------------------------------;
partner operation gerarEFDBloco1                    ;
	;---------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	$nrLinhaBloco$ = ""
	;Abertura do bloco 1.
	$instancehandle->gerarEFDBloco1Reg1001($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	; @>-/-- Virginia - 170/142 - 12/05/2011
	;Geração do registro 1600 - Operações com Cartão de Crédito ou Débito.
	if ($inGeraRegCartao$ = 1)
		$instancehandle->gerarEFDBloco1Reg1600($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	; --\-<@

	;-- MAD [Proj/Tar.170/381] - 27/10/2011
	;Documentos fiscais utilizados
	$instancehandle->gerarEFDBloco1Reg1700($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	;;

	;Encerramento do bloco 1.
	$instancehandle->gerarEFDBloco1Reg1990($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBloco1.


;-----------------------------------------------;
partner operation gerarEFDBloco1Reg1001         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		boolean vInMovimento, vInCartao
		numeric vTpModDocFis
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 1 - registro 1001", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	
	vInMovimento = <FALSE>    ; Deusdete
	vInCartao    = <FALSE>    ; --\-<@ Virginia - 175/142 - 13/05/2011

	clear/e "FIS_NFEXPSVC"
	cd_empresa.fis_nfEXPsvc/init = $item("CD_EMPRESA", $parametro$)
	dt_declaracao.fis_nfEXPsvc/init  = $item("DT_PERIODO", $parametro$)
	retrieve/e "FIS_NFEXPSVC"
	if ($status >= 0)
		setocc "FIS_NFEXPSVC", 1
		while ($status >= 0)
			clear/e "FIS_NFSVC"
			CD_EMPFAT.fis_nfsvc/init = cd_empresa.fis_nfexpsvc
			nr_fatura.fis_nfsvc/init  = nr_fatura.fis_nfexpsvc
			TP_SITUACAO.FIS_NFSVC/init = "E"
			dt_fatura.fis_nfsvc/init  = dt_fatura.fis_nfexpsvc
			retrieve/e "FIS_NFSVC"
			if ($status >= 0)
				;CFC: 25/02/2010 - COMENTADO A PEDIDO DO DEUSDETE
				;if ($item("UF_ORIGEM",$xlplemp$) = "") | ($item("UF_ORIGEM",$xlplemp$) = ds_siglaestado.fis_nfremdessvc)
					vInMovimento = <TRUE>
				;endif
				; -> rodrigo - 170/529 - 14/08/2012
				putitem/id $verificaMov$, "REG1100", <TRUE>
				; <- rodrigo - 170/529 - 14/08/2012
			endif
			setocc "FIS_NFEXPSVC", $curocc("FIS_NFEXPSVC") + 1
		endwhile
	endif

	if ($inGeraRegCartao$ = 1) ;-- MAD [Proj/Tar.170/281] - 03/06/2011
		; @>-/-- Virginia - 175/142 - 13/05/2011 - gerar registro 1600
		clear/e "FCR_FATURAISVC"
		CD_EMPRESA.FCR_FATURAISVC/init = $item("CD_EMPRESA", $parametro$)
		DT_EMISSAO.FCR_FATURAISVC/init = $item("DT_PERIODO", $parametro$)
		TP_DOCUMENTO.FCR_FATURAISVC/init =  "4·;5" ; 4-CARTÃO CRÉDITO ou 5-CARTÃO DÉBITO
		TP_COBRANCA.FCR_FATURAISVC/init  =  14 ; OPERADORA DE CRÉDITO
		TP_SITUACAO.FCR_FATURAISVC/init  =  1  ; NORMAL 
		retrieve/e "FCR_FATURAISVC"
		if ($status >= 0)
			vInCartao = <TRUE>
			; -> RODRIGO - 170/529 - 14/08/2012
			putitem/id $verificaMov$, "REG1600", <TRUE>
			; <- RODRIGO - 170/529 - 14/08/2012
		endif
		; --\-<@
	endif

	;-- MAD [Proj/Tar.170/381] - 27/10/2011
	;Informações refrente ao registro 1700
	clear/e "FIS_NFEINUTSVC"
	CD_EMPRESA.FIS_NFEINUTSVC/init = $item("CD_EMPRESA", $parametro$)
	DT_FATURA.FIS_NFEINUTSVC/init  = $item("DT_PERIODO", $parametro$)
	retrieve/e "FIS_NFEINUTSVC"
	if ($status >= 0)
		setocc "FIS_NFEINUTSVC", 1
		while ($status >= 0)
			
			clear/e "FIS_NFSVC"
			CD_EMPFAT.FIS_NFSVC/init        = CD_EMPRESA.FIS_NFEINUTSVC
			DT_FATURA.FIS_NFSVC/init        = DT_FATURA.FIS_NFEINUTSVC
			NR_NF.FIS_NFSVC/init            = "·>·=%%NR_NFINICIAL.FIS_NFEINUTSVC·&·<·=%%NR_NFFINAL.FIS_NFEINUTSVC"
			CD_SERIE.FIS_NFSVC/init         = CD_SERIE.FIS_NFEINUTSVC
			TP_MODDCTOFISCAL.FIS_NFSVC/init = "01·;55·;85·;86·;87"
			TP_ORIGEMEMISSAO.FIS_NFSVC/init = 1
			retrieve/e "FIS_NFSVC"
			if ($status >= 0)
				setocc "FIS_NFSVC", 1
				while ($status >= 0)
					if (TP_AMBIENTE.FIS_NFEXMLSVC = 1) & (TP_EMISSAO.FIS_NFEXMLSVC = 5)
					
						if (TP_MODDCTOFISCAL.FIS_NFSVC = 85) | (TP_MODDCTOFISCAL.FIS_NFSVC = 86) | (TP_MODDCTOFISCAL.FIS_NFSVC= 87)
							if (DS_CHAVEACESSO.FIS_NFESVC != "")
								vTpModDocFis = 55
							else
								vTpModDocFis = 1
							endif
						else
							vTpModDocFis = TP_MODDCTOFISCAL.FIS_NFSVC
						endif

						creocc "F_TMP_NRDSSVC", -1
						NR_GERAL.F_TMP_NRDSSVC  = NR_NF.FIS_NFSVC
						DS_GERAL.F_TMP_NRDSSVC  = CD_SERIE.FIS_NFSVC
						retrieve/o "F_TMP_NRDSSVC"
						if ($status = -7)
							retrieve/x "F_TMP_NRDSSVC"
						endif
						TP_MODDOCFIS.F_TMP_NRDSSVC = vTpModDocFis
						TP_SITUACAO.F_TMP_NRDSSVC  = "I"
						NR_RECIBO.F_TMP_NRDSSVC    = NR_RECIBO.FIS_NFESVC
					endif
					setocc "FIS_NFSVC", $curocc("FIS_NFSVC") + 1
				endwhile
			endif
		setocc "FIS_NFEINUTSVC", $curocc("FIS_NFEINUTSVC") + 1
		endwhile
	endif

	if (!$empty("F_TMP_NRDSSVC"))
		vInMovimento = <TRUE>
		; -> RODRIGO- 170/529 - 14/08/2012
		putitem/id $verificaMov$, "REG1700", <TRUE>
		; <- RODRIGO- 170/529 - 14/08/2012
	endif
	;;
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|1001"
	;Indicador de movimento.
; -> rodrigo - prj 170 tar 549 - 20/09/2012 - sempre terá movimento pois o registro 1010 é obrigatório
;	if (vInMovimento = <TRUE>) | (vInCartao = <TRUE>)
		vStringAux = "|0"
;	else
;		vStringAux = "|1"
;	endif
; <- rodrigo - prj 170 tar 549 - 20/09/2012

	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "1001"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("1001")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	; -> rodrigo - prj 170 tar 529 - 24/08/2012
	$instancehandle->gerarEFDBloco1Reg1010($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	; <- rodrigo - prj 170 tar 529 - 24/08/2012

	if (vInMovimento = <TRUE>)
		$instancehandle->gerarEFDBloco1Reg1100($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	
	return(0)
End ;operation gerarEFDBloco1Reg1001.

;---------------------------------------------------;
partner operation gerarEFDBloco1Reg1100             ;
	;---------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		numeric vVlInventario, vVlItem, vQtSaldo, vVlUnitario
		date    vDtAux
	endvariables

	if ($empty("FIS_NFEXPSVC"))
		return(0)
	endif
	
	setocc "FIS_NFEXPSVC", 1
	while ($status >= 0)
		clear/e "FIS_NFSVC"
		CD_EMPFAT.fis_nfsvc/init = cd_empresa.fis_nfexpsvc
		nr_fatura.fis_nfsvc/init  = nr_fatura.fis_nfexpsvc
		TP_SITUACAO.FIS_NFSVC/init = "E" ; RODRIGO - PRJ 170 TAR 312 - 27/06/2011
		dt_fatura.fis_nfsvc/init  = dt_fatura.fis_nfexpsvc
		retrieve/e "FIS_NFSVC"
		if ($status >= 0)
			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 1 - registro 1100", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif

			;CFC: 25/02/2010 - COMENTADO A PEDIDO DO DEUSDETE
			;if ($item("UF_ORIGEM",$xlplemp$) = "") | ($item("UF_ORIGEM",$xlplemp$) = ds_siglaestado.fis_nfremdessvc)
				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|1100"
				;Informe o tipo de documento.
				vStringAux = TP_DOCUMENTO.FIS_NFEXPSVC
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Numero da declaracao.
				vStringAux = NR_DECLARACAO.FIS_NFEXPSVC
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Data da declaracao.
				vDtAux = dt_DECLARACAO.fis_nfEXPsvc
				vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Preencher com.
				;vStringAux = "|0"
				;->RIM [170/512] 23/07/2012
				;Natureza exportação
				if (TP_NATEXP.FIS_NFEXPSVC = "0") | (TP_NATEXP.FIS_NFEXPSVC = "2")
					vStringAux = "|0"
				elseif (TP_NATEXP.FIS_NFEXPSVC = "1") | (TP_NATEXP.FIS_NFEXPSVC = "3")
					vStringAux = "|1"
				else
					vStringAux = "|0"
				endif
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;<-
				;Numero do registro da exportacao.
				vStringAux = NR_REGISTROEXP.FIS_NFEXPSVC
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Data do registro da exportacao.
				vDtAux = DT_REGISTROEXP.FIS_NFEXPSVC
				vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Numero do conhecimento de embarque.
				vStringAux = NR_CONEMB.FIS_NFEXPSVC
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Data do conhecimento de embarque.
				vDtAux = DT_CONEMB.FIS_NFEXPSVC
				vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Data da averbacao da declaracao de exportacao.
				vDtAux = DT_AVERBACAO.FIS_NFEXPSVC
				vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Informacao do tipo de conhecimento de transporte.
				call convNumeric(TP_CONHECIMENTO.FIS_NFEXPSVC, 2, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Codigo do pais de destino da mercadoria.
				call convNumeric(cd_paissiscomex.FIS_NFEXPSVC, 3, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"
				
				;filedump/append vDsConteudo, ds_path.sis_filtro
				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "1100"
				ds_registro.sis_arquivosvc = vDsConteudo
				
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
				
				$instancehandle->totalizarQtdTipoRegistro("1100")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				
				;Documentos Fiscais de exportacao.

				;CFC: 25/02/2010 
				clear/e "FIS_NFITEMSVC"
				CD_EMPFAT.fis_nfitemsvc/init = CD_EMPFAT.fis_nfsvc
				nr_fatura.fis_nfitemsvc/init  = nr_fatura.fis_nfsvc
				dt_fatura.fis_nfitemsvc/init  = dt_fatura.fis_nfsvc
				retrieve/e "FIS_NFITEMSVC"
				;
				$instancehandle->gerarEFDBloco1Reg1105($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			;endif
			;
		endif
		setocc "FIS_NFEXPSVC", $curocc(FIS_NFEXPSVC) + 1
	endwhile
	
	return(0)
End ;operation gerarEFDBloco1Reg1100.


;------------------------------------------------;
partner operation gerarEFDBloco1Reg1105          ;
	;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vStrAux, vFisCfop, vFisTipi, vNumericAux
		numeric vVlSubTributaria
		date    vDtAux
	endvariables
	
	if ($empty("FIS_NFITEMSVC"))
		return(0)
	endif
	
	setocc "FIS_NFITEMSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 1 - registro 1105 / %%cd_produto.fis_nfitemsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
			setocc "FIS_NFITEMPROSVC", 1
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|1105"
			;Codigo do modelo do documento fiscal.
			vNumericAux = tp_moddctofiscal.fis_nfsvc
			call convNumeric(vNumericAux, 2, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Serie do documento fiscal.
			vStringAux = "|%%cd_serie.fis_nfsvc"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Numero do documento fiscal.
			call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Chave da nota fiscal eletronica.
			vStringAux = ""
			if (tp_moddctofiscal.fis_nfsvc = 55) & (tp_situacao.fis_nfsvc = "E")
				viParams = ""
				voParams = ""
				;;ICJ [PROJ/TAR 170/2] (17/06/2010)
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.FIS_NFEXPSVC
				putitem/id viParams, "NR_FATURA",  NR_FATURA.FIS_NFEXPSVC
				putitem/id viParams, "DT_FATURA",  DT_FATURA.FIS_NFEXPSVC
				putitem/id viParams, "NM_CARREGATABELA", "FIS_NFE"
				activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				vStringAux = $item("DS_CHAVEACESSO",voParams)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Data da emissao da NF de exportacao.
			vDtAux = DT_FATURA.FIS_NFEXPSVC
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Codigo do item.
; -> rodrigo  - PRJ 170 TAR 312 - 27/06/2011
;			call convNumeric(cd_produto.fis_nfitemprosvc, 9, vStringConv)
;			call convNumeric(cd_produto.fis_nfitemprosvc, 14, vStringConv)
			vStringConv = cd_produto.fis_nfitemprosvc
; <- rodrigo  - PRJ 170 TAR 312 - 27/06/2011

			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			creocc "F_TMP_DS40SVC", -1
			if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
			else
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
			endif
			if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
				clear/e "PRD_PRDCONVMESVC"
				CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "PRD_PRDCONVMESVC"
				if ($status >= 0)
					$instancehandle->totalizarQtdTipoRegistro("0220")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			retrieve/o "F_TMP_DS40SVC"
			if ($status = 4)
				retrieve/x "F_TMP_DS40SVC"
			else
				ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
				ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
				if (cd_tipi.fis_nfitemsvc = "")
					if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
						;se for serviço não tera ncm
					else
						clear/e "PRD_PRODUTOSVC"
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
						retrieve/e "PRD_PRODUTOSVC"
						if ($status >= 0)
							if (CD_ESPECIE.FIS_NFITEMSVC = "")
								ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
							endif
							if (cd_tipi.prd_produtosvc != "")
								; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
								vFisTipi = ""
								viParams = ""
								voParams = ""
								putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
								activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
								if ($procerror)
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									return(-1)
								endif
								if (voParams != "")
									vFisTipi = voParams
									vStrAux = $item("CD_TIPI",vFisTipi)
									vStrAux = $replace(vStrAux, 1, ".","",-1)	
									cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
								endif
								; --\-<@
							endif
						endif
					endif
				else
					cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
					cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
				endif
			endif

			;-- MAD [Proj/Tar.189/059] - 29/12/2011			
			;creocc "TMP_NR08SVC", -1
			;nr_08.tmp_nr08svc = cd_cfop.fis_nfitemsvc
			;retrieve/o "TMP_NR08SVC"
			;if ($status = 4)
			;	retrieve/x "TMP_NR08SVC"
			;else
			;	; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
			;	vFisCfop = ""
			;	viParams = ""
			;	voParams = ""
			;	putitem/id viParams, "CD_CFOP", cd_cfop.fis_nfitemsvc
			;	activate "FISSVCO032".carregaFisCfop($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			;	if ($procerror)
			;		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			;		return(-1)
			;	elseif ($status < 0)
			;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			;		return(-1)
			;	endif
			;	if (voParams != "")
			;		vFisCfop = voParams
			;		ds_cfop.tmp_nr08svc = $item("DS_CFOP",vFisCfop)
			;	endif
			;	; --\-<@            
			;endif
			;;

			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "1105"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("1105")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
		endif
		
		discard "FIS_NFITEMSVC"
		if ($status = 0)
			$status = -1
		endif
		;setocc "FIS_NFITEMSVC", $curocc(FIS_NFITEMSVC) + 1
	endwhile
	
	return(0)
End ;operation gerarEFDBloco1Reg1105.

; @>-/-- Virginia - 175/142 - 12/05/2011
;---------------------------------------------------;
partner operation gerarEFDBloco1Reg1600             ;
	;---------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux, vDsEndereco, vGlbLogradouro
		string  vPesPessoa, vPesEndereco, vPesFisica, vPesJuridica, vPesCliente, viParams, voParams
		numeric vVlInventario, vVlItem, vQtSaldo, vVlUnitario, vCdEstado
		date    vDtAux
	endvariables
	
	clear/e "F_TMP_NR10SVC"

	clear/e "FCR_FATURAISVC"
	CD_EMPRESA.FCR_FATURAISVC/init = $item("CD_EMPRESA", $parametro$)
	DT_EMISSAO.FCR_FATURAISVC/init = $item("DT_PERIODO", $parametro$)
	TP_DOCUMENTO.FCR_FATURAISVC/init =  "4·;5" ; 4-CARTÃO CRÉDITO ou 5-CARTÃO DÉBITO
	TP_COBRANCA.FCR_FATURAISVC/init  =  14 ; OPERADORA DE CRÉDITO
	TP_SITUACAO.FCR_FATURAISVC/init  =  1 ; NORMAL 
	retrieve/e "FCR_FATURAISVC"
	if ($status >= 0)
		setocc "FCR_FATURAISVC", -1
		setocc "FCR_FATURAISVC", 1
		while ($status >= 0)
			creocc "F_TMP_NR10SVC", -1
			NR_GERAL.F_TMP_NR10SVC/init = CD_CLIENTE.FCR_FATURAISVC
			retrieve/o "F_TMP_NR10SVC"
			if ($status = 4)
				retrieve/x "F_TMP_NR10SVC"
			endif
	
			if (TP_DOCUMENTO.FCR_FATURAISVC = 4) ; cartão crédito
				VL_CREDITO.F_TMP_NR10SVC = VL_CREDITO.F_TMP_NR10SVC + VL_FATURA.FCR_FATURAISVC
			else
				VL_DEBITO.F_TMP_NR10SVC = VL_DEBITO.F_TMP_NR10SVC + VL_FATURA.FCR_FATURAISVC
			endif
	
			setocc "FCR_FATURAISVC", $curocc(FCR_FATURAISVC) + 1
		endwhile
	

		setocc "F_TMP_NR10SVC", 1
		while ($status >= 0)
	
			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 1 - registro 1600 / %%nr_geral.f_tmp_nr10svc", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif
	
			vDsConteudo = ""
			;1 - Texto fixo.
			vDsConteudo = "|1600"
			;2 - Código do participante.
	
			creocc "F_TMP_NR09SVC", -1
			nr_geral.f_tmp_nr09svc = NR_GERAL.F_TMP_NR10SVC
			retrieve/o "F_TMP_NR09SVC"
			if ($status = 4)
				retrieve/x "F_TMP_NR09SVC"
			endif
	
			viParams   = ""
			vPesPessoa = ""
			putitem/id viParams, "CD_PESSOA",NR_GERAL.F_TMP_NR10SVC
			activate "FISSVCO032".carregaPessoa($$gParamGlb, viParams, vPesPessoa, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			nm_cliente.f_tmp_nr09svc = $item("NM_PESSOA",vPesPessoa)
			tp_pessoa.f_tmp_nr09svc  = $item("TP_PESSOA",vPesPessoa)

			if (tp_pessoa.f_tmp_nr09svc = "F")
				viParams   = ""
				vPesFisica = ""
				putitem/id viParams, "CD_PESSOA", NR_GERAL.F_TMP_NR10SVC
				activate "FISSVCO032".carregaPesFisica($$gParamGlb, viParams, vPesFisica, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				nr_cpf.f_tmp_nr09svc     = $item("NR_CPFCNPJ",vPesPessoa)
				nr_rginscr.f_tmp_nr09svc = $item("NR_RG",vPesFisica)

			else
				viParams     = ""
				vPesJuridica = ""
				putitem/id viParams, "CD_PESSOA", NR_GERAL.F_TMP_NR10SVC
				activate "FISSVCO032".carregaPesJuridica($$gParamGlb, viParams, vPesJuridica, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				nr_cnpj.f_tmp_nr09svc    = $item("NR_CPFCNPJ",vPesPessoa)
				nr_rginscr.f_tmp_nr09svc = $item("NR_INSCESTL",vPesJuridica)
			endif
	
			vPesCliente = ""
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_CLIENTE", NR_GERAL.F_TMP_NR10SVC
			activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			if (voParams != "")
				vPesCliente = voParams
			endif
			NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)

			viParams     = ""
			vPesEndereco = ""
			putitem/id viParams, "CD_PESSOA", NR_GERAL.F_TMP_NR10SVC	
			activate "FISSVCO032".carregaVEndereco($$gParamGlb, viParams, vPesEndereco, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			vStringAux  = $item("DS_SIGLALOGRAD",vPesEndereco)
			vDsEndereco = $item("NM_LOGRADOURO",vPesEndereco)
			ds_logradouro.f_tmp_nr09svc = "%%vStringAux %%vDsEndereco"
			nr_logradouro.f_tmp_nr09svc = $item("NR_LOGRADOURO",vPesEndereco)
			nm_bairro.f_tmp_nr09svc     = $item("DS_BAIRRO",vPesEndereco)

			if ($item("CD_CEP",vPesEndereco) != 99999999)
				vGlbLogradouro = ""
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_CEP", $item("CD_CEP",vPesEndereco)
				activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				if (voParams != "")
					vGlbLogradouro = voParams
				endif				
				vCdEstado = ""
				vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
			
				cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
				cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
				ds_estado.f_tmp_nr09svc    = vCdEstado
				ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
			endif
	
			call convNumeric(nr_geral.f_tmp_nr10svc, 9, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;3 - Total de Crédito.
			vNumericAux = VL_CREDITO.F_TMP_NR10SVC
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;4 - Total de Débito.
			vNumericAux = VL_DEBITO.F_TMP_NR10SVC
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
					
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "1600"
			ds_registro.sis_arquivosvc = vDsConteudo
					
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
					
			$instancehandle->totalizarQtdTipoRegistro("1600")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
					
			setocc "F_TMP_NR10SVC", $curocc(F_TMP_NR10SVC) + 1
		endwhile
	endif
	clear/e "F_TMP_NR10SVC"
	
	return(0)
End ;operation gerarEFDBloco1Reg1600.
; --/-<@

;-----------------------------------------------;
partner operation gerarEFDBloco1Reg1990         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 1 - registro 1990", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|1990"
	;Quantidade total de linhas do bloco 1.
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	vStringAux = "|%%$nrLinhaBloco$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "1990"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("1990")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	return(0)
End ;operation gerarEFDBloco1Reg1990.


;-------------------------------------------------;
partner operation gerarEFDBloco9                  ;
	;-------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	$nrLinhaBloco$ = ""
	;Abertura do bloco 9.
	$instancehandle->gerarEFDBloco9Reg9001($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Registros do arquivo.
	$instancehandle->gerarEFDBloco9Reg9900($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Encerramento do bloco 9.
	$instancehandle->gerarEFDBloco9Reg9990($xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	;Encerramento do arquivo digital.
;	$instancehandle->gerarEFDBloco9Reg9999($xCdErro$, $xCtxErro$)
;	if ($procerror)
;		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;		poCdErro  = $xCdErro$
;		poCtxErro = $xCtxErro$
;		return(-1)
;	elseif ($status < 0)
;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;		poCdErro  = $xCdErro$
;		poCtxErro = $xCtxErro$
;		return(-1)
;	endif
	
	return(0)
End ;operation gerarEFDBloco9.


;-----------------------------------------------;
partner operation gerarEFDBloco9Reg9001         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 9 - registro 9001", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|9001"
	;Indicador de movimento.
	vStringAux = "|0"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "9001"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("9001")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ;operation gerarEFDBloco9Reg9001.


;-----------------------------------------------;
partner operation gerarEFDBloco9Reg9900         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
		numeric vContador, vNumerico, vQtReg
		boolean vInGerar0150, vInGerar0190, vInGerar0200, vInGerar0400, vInGerou9001, vInGerar0300
	endvariables
	
	vInGerar0150 = <TRUE>
	vInGerar0190 = <TRUE>
	vInGerar0200 = <TRUE>
	vInGerar0300 = <TRUE> ;; ICJ [PROJ/TAR 170/200] (03/03/2011)
	vInGerar0400 = <TRUE>
	vInGerou9001 = <FALSE>
	
	$qtRegEspecie$ = 0
	if (!$empty("TMP_NRDSSVC"))
		sort/e "TMP_NRDSSVC", "ds_geral.tmp_nrdssvc"
		setocc "TMP_NRDSDVC", 1
		setocc "TMP_NRDSSVC", -1
		$qtRegEspecie$ = $totocc("TMP_NRDSSVC")
	endif
	$qtRegPessoaNf$ = 0
	if (!$empty("F_TMP_NR09SVC"))
		sort/e "F_TMP_NR09SVC", "nr_geral.f_tmp_nr09svc"
		setocc "F_TMP_NR09SVC", 1
		setocc "F_TMP_NR09SVC", -1
		$qtRegPessoaNf$ = $totocc("F_TMP_NR09SVC")
	endif
	
	$qtRegProduto$ = 0
	if (!$empty("F_TMP_DS40SVC"))
		sort/e "F_TMP_DS40SVC", "DS_40.F_TMP_DS40SVC"
		setocc "F_TMP_DS40SVC", 1
		setocc "F_TMP_DS40SVC", -1
		$qtRegProduto$ = $totocc("F_TMP_DS40SVC")
	endif

	;; ICJ [PROJ/TAR 170/196] (17/02/2011)
	if (!$empty("F_TMP_DS60SVC"))
		sort/e "F_TMP_DS60SVC", "DS_60.F_TMP_DS60SVC"
		setocc "F_TMP_DS60SVC", 1
		setocc "F_TMP_DS60SVC", -1
		$qtRegProduto$ = $qtRegProduto$ + $totocc("F_TMP_DS60SVC")
	endif
	;;

	$qtRegCfop$ = 0
	if (!$empty("TMP_NR08SVC"))
		sort/e "TMP_NR08SVC", "nr_08.tmp_nr08svc"
		setocc "TMP_NR08SVC", 1
		setocc "TMP_NR08SVC", -1
		$qtRegCfop$ = $totocc("TMP_NR08SVC")
	endif

	;; ICJ [PROJ/TAR 170/200] (03/03/2011)
	$qtReg0300$ = 0
	$qtReg0305$ = 0	
	if (!$empty("F2_TMP_DS60SVC"))
		sort/e "F2_TMP_DS60SVC", "DS_60.F2_TMP_DS60SVC"
		setocc "F2_TMP_DS60SVC", 1
		setocc "F2_TMP_DS60SVC", -1
		$qtReg0300$ = $qtReg0300$ + $totocc("F2_TMP_DS60SVC")
	endif
	;;
	
	vContador = 0
	sort/e "TMP_DS40SVC", "ds_40.tmp_ds40svc"

	setocc "TMP_DS40SVC", 1
	while ($status >= 0)
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 9 - registro 9900", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		
		vNumericAux = ds_40.tmp_ds40svc
		vNumerico = $qtRegPessoaNf$
		if ($qtRegPessoaNf$ > 0) & (vInGerar0150 = <TRUE>) & (vNumericAux = 150)
			
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|9900"
			;Registro que sera totalizado no proximo campo.
			vStringAux = "|0150"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Total de registros do tipo informado no campo anterior.
			vNumericAux = $qtRegPessoaNf$
			vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "9900"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			vContador        = vContador + 1
			vInGerar0150     = <FALSE>
			
		elseif ($qtRegEspecie$ > 0) & (vInGerar0190 = <TRUE>) & (vNumericAux = 190)
			
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|9900"
			;Registro que sera totalizado no proximo campo.
			vStringAux = "|0190"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Total de registros do tipo informado no campo anterior.
			vNumericAux = $qtRegEspecie$
			vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "9900"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			vContador        = vContador + 1
			vInGerar0190     = <FALSE>
			
		elseif ($qtRegProduto$ > 0) & (vInGerar0200 = <TRUE>) & (vNumericAux = 200)
			
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|9900"
			;Registro que sera totalizado no proximo campo.
			vStringAux = "|0200"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Total de registros do tipo informado no campo anterior.
			vNumericAux = $qtRegProduto$
			vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "9900"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			vContador        = vContador + 1
			vInGerar0200     = <FALSE>
			
		elseif ($qtRegCfop$ > 0) & (vInGerar0400 = <TRUE>) & (vNumericAux = 400)
			
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|9900"
			;Registro que sera totalizado no proximo campo.
			vStringAux = "|0400"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Total de registros do tipo informado no campo anterior.
			vNumericAux = $qtRegCfop$
			vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "9900"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			vContador        = vContador + 1
			vInGerar0400     = <FALSE>
		;; ICJ [PROJ/TAR 170/200] (03/03/2011)
		elseif ($qtReg0300$ > 0) & (vInGerar0300 = <TRUE>) & (vNumericAux = 300)
			
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|9900"
			;Registro que sera totalizado no proximo campo.
			vStringAux = "|0300"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Total de registros do tipo informado no campo anterior.
			vNumericAux = $qtReg0300$
			vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			$qtReg0305$ = $qtReg0300$
			;filedump/append vDsConteudo, ds_path.sis_filtro
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "9900"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			vContador        = vContador + 1
			vInGerar0300     = <FALSE>
		;;

		;-- MAD [Proj/Tar.170/238] - 27/04/2011
		elseif (vNumericAux = 450)
			vQtReg = 0
			selectdb count(NR_SEQUENCIA) from "GTT_OBSNFSVC"   %\
					u_where (TP_OBSNF.GTT_OBSNFSVC = 1) to vQtReg

			if (vQtReg > 0)
				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|9900"
				;Registro que sera totalizado no proximo campo.
				vStringAux = "|0450"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Total de registros do tipo informado no campo anterior.
				vNumericAux = vQtReg
				vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"

				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "9900"
				ds_registro.sis_arquivosvc = vDsConteudo
			
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
				vContador        = vContador + 1
			endif

		elseif (vNumericAux = 460)
			vQtReg = 0
			selectdb count(NR_SEQUENCIA) from "GTT_OBSNFSVC"   %\
					u_where (TP_OBSNF.GTT_OBSNFSVC = 2) to vQtReg

			if (vQtReg > 0)
				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|9900"
				;Registro que sera totalizado no proximo campo.
				vStringAux = "|0460"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Total de registros do tipo informado no campo anterior.
				vNumericAux = vQtReg
				vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"

				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "9900"
				ds_registro.sis_arquivosvc = vDsConteudo
			
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
				vContador        = vContador + 1
			endif
		;;

		else
			if (vNumericAux != 150) & (vNumericAux != 190) & (vNumericAux != 200) & (vNumericAux != 300) & (vNumericAux != 400)
				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|9900"
				;Registro que sera totalizado no proximo campo.
				vStringAux = "|%%ds_40.tmp_ds40svc"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Total de registros do tipo informado no campo anterior.
				vNumericAux = qt_registro.tmp_ds40svc
				vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"
				
				;filedump/append vDsConteudo, ds_path.sis_filtro
				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "9900"
				ds_registro.sis_arquivosvc = vDsConteudo
				
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
				vContador        = vContador + 1

				;-- MAD [Proj/Tar.061/873] - 16/09/2010
				if (ds_40.tmp_ds40svc = "9001")
					vInGerou9001 = <TRUE>
					vContador    = vContador - 1
				endif
				;;

				;-- MAD [Proj/Tar.170/278] - 31/05/2011
				if (ds_40.tmp_ds40svc = "0220")
					clear/e "GTT_DS01SVC"
					retrieve/e "GTT_DS01SVC"
					if ($status < 0)
						$nrLinhaBloco$   = $nrLinhaBloco$   - 1
						$nrLinhaArquivo$ = $nrLinhaArquivo$ - 1
						$nrRegistroArq$  = $nrRegistroArq$  - 1
						vContador        = vContador        - 1
					endif
				endif
				;;
			endif
		endif
		
		setocc "TMP_DS40SVC", $curocc(TMP_DS40SVC) + 1
	endwhile
	clear/e "TMP_DS40SVC"

	if (vInGerou9001 = <FALSE>) ;-- MAD [Proj/Tar.061/873] - 16/09/2010
		;Gravar linha registro 9001.
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|9900"
		;Registro que sera totalizado no proximo campo.
		vStringAux = "|9001"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Total de registros do tipo informado no campo anterior.
		vNumericAux = 1
		vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		;filedump/append vDsConteudo, ds_path.sis_filtro
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "9900"
		ds_registro.sis_arquivosvc = vDsConteudo
	
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	endif
	
	;Gravar linha registro 9900.
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|9900"
	;Registro que sera totalizado no proximo campo.
	vStringAux = "|9900"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Total de registros do tipo informado no campo anterior.
	vNumericAux = vContador + 4
	vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "9900"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	;Gravar linha registro 9990.
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|9900"
	;Registro que sera totalizado no proximo campo.
	vStringAux = "|9990"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Total de registros do tipo informado no campo anterior.
	vNumericAux = 1
	vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "9900"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	;Gravar linha registro 9999.
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|9900"
	;Registro que sera totalizado no proximo campo.
	vStringAux = "|9999"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Total de registros do tipo informado no campo anterior.
	vNumericAux = 1
	vDsConteudo = "%%vDsConteudo%%%|%%vNumericAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "9900"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	return(0)
End ;operation gerarEFDBloco9Reg9900.


;-----------------------------------------------;
partner operation gerarEFDBloco9Reg9990         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 9 - registro 9990", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|9990"
	;Quantidade total de linhas do bloco 9.
	$nrLinhaBloco$ = $nrLinhaBloco$ + 2
	vStringAux = "|%%$nrLinhaBloco$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "9990"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	return(0)
End ;operation gerarEFDBloco9Reg9990.


;-----------------------------------------------;
partner operation gerarEFDBloco9Reg9999         ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 9 - registro 9999", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|9999"
	;Quantidade total de linhas do arquivo digital.
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1 + $qtRegEspecie$ + $qtRegPessoaNf$ + $qtRegProduto$ + $qtRegCfop$ + $qtReg0300$ + $qtReg0305$ + $Cont0220$
	vStringAux = "|%%$nrLinhaArquivo$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	;filedump/append vDsConteudo, ds_path.sis_filtro
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "9999"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	
	return(0)
End ;operation gerarEFDBloco9Reg9999.


;-----------------------------------------------;
partner operation gerarEFDArquivoTexto          ;
	;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, vCpfCnpj, vTipo, vCaminho, vArquivo, vEOF, vNumericAux, vIE
		numeric vContador, vCdEstado, vTam, vPos, vTotDig
		boolean vFlag, vGerou0220, vInGera
		string  viParams, voParams, vFisTipi, vGlbMunIBGE, vPesEndereco, vPais
		numeric vCdCCustoPadraoFcp, vNaturezaComercialEmp, vCdProduto
	endvariables

	vGerou0220 = <FALSE>
	$Cont0220$ = 0
	vDsConteudo = ""    
	vCaminho = "D:\VirtualAge\Storeage\temp\"
	vArquivo = $item("DS_PATH", $parametro$)
	vPos = $scan(vArquivo, "\")
	while (vPos != 0)
		vPos = $scan(vArquivo, "\")
		vTam = $length(vArquivo)
		vArquivo = vArquivo[vPos+1:vTam-vPos]
	endwhile
	vCaminho = "%%vCaminho%%vArquivo"
	vPos = ""
	filedump vDsConteudo, vCaminho
	setocc "SIS_ARQUIVOSVC", 1
	while ($status >= 0)
		$instancehandle->setDisplay("Gerando arquivo Escrituração Fiscal Digital: %%ds_reg.sis_arquivoSVC", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		
		if (ds_reg.sis_arquivoSVC = "0150")
			if (!$empty("F_TMP_NR09SVC"))
				sort/e "F_TMP_NR09SVC", "nr_geral.f_tmp_nr09svc"
				setocc "F_TMP_NR09SVC", 1
				while ($status >= 0)
					
					if (cd_estado.f_tmp_nr09svc = "") | (cd_municipio.f_tmp_nr09svc = "")
						vPesEndereco = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_PESSOA", nr_geral.f_tmp_nr09svc
						activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vPesEndereco = voParams
						endif
						
						;if ($status >= 0)
						if (vPesEndereco != "")
							vCdEstado = ""
							vCdEstado = $item("DS_ESTADO",vPesEndereco)
							cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO", vPesEndereco)
							cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vPesEndereco)
							ds_estado.f_tmp_nr09svc    = vCdEstado
							ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vPesEndereco)
						endif
					endif
					
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|0150"
					;Codigo de identificacao do participante no arquivo.
					call convNumeric(nr_geral.f_tmp_nr09svc, 9, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Nome pessoal do participante.
					length $ltrim(nm_cliente.f_tmp_nr09svc, " ")
					vTam = $result
					$instancehandle->substituiCaractereEspecial($ltrim(nm_cliente.f_tmp_nr09svc, ""), vTam, vStringAux)
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					endif
					vStringAux = "|%%vStringAux"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Codigo do país do participante.
					vPais = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_ESTADO", CD_ESTADO.f_tmp_nr09svc
					activate "FISSVCO032".carregaPais($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vPais = voParams
					endif
					;                    vNumericAux = CD_PAISBCB.GLB_PAISSVC
					vNumericAux = $item("CD_PAISBCB",vPais)
					call convNumeric(vNumericAux, 5, vStringConv)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					if (ds_sigla.f_tmp_nr09svc != "EX")
						if (tp_pessoa.f_tmp_nr09svc = "F")
							;Cnpj do participante.
							vStringAux = "|"
							vDsConteudo = "%%vDsConteudo%%vStringAux"
							;Cpf do participante.							
							vCpfCnpj = nr_cpf.f_tmp_nr09svc
							vCpfCnpj = $replace(vCpfCnpj, 1, ".","",-1)
							vCpfCnpj = $replace(vCpfCnpj, 1, "/","",-1)
							vCpfCnpj = $replace(vCpfCnpj, 1, "-","",-1)
							call convNumeric(vCpfCnpj, 11, vStringConv)
							vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
							;Inscricao estadual do participante.
							vStringAux = "|"
							vDsConteudo = "%%vDsConteudo%%vStringAux"
						else
							;Cnpj do participante.					
							vCpfCnpj = nr_cnpj.f_tmp_nr09svc
							vCpfCnpj = $replace(vCpfCnpj, 1, ".","",-1)
							vCpfCnpj = $replace(vCpfCnpj, 1, "/","",-1)
							vCpfCnpj = $replace(vCpfCnpj, 1, "-","",-1)
							call convNumeric(vCpfCnpj, 14, vStringConv)
							vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
							;Cnpj do participante.
							vStringAux = "|"
							vDsConteudo = "%%vDsConteudo%%vStringAux"
							;Inscricao estadual do participante.
							if (nr_rginscr.f_tmp_nr09svc = "ISENTO")
								vStringAux = "|"
							else
								vIE	= nr_rginscr.f_tmp_nr09svc
								vIE = $replace(vIE, 1, ".","",-1)
								vIE = $replace(vIE, 1, "/","",-1)
								vIE	= $replace(vIE, 1, "-","",-1)
								vStringAux = "|%%vIE"
							endif
							vDsConteudo = "%%vDsConteudo%%vStringAux"
						endif
					else
						vStringAux = "|||"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
					endif
					
					;Codigo do municipio.
					; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
					vGlbMunIBGE = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_ESTADO", cd_estado.f_tmp_nr09svc
					putitem/id viParams, "CD_MUNICIPIO", cd_municipio.f_tmp_nr09svc
					activate "FISSVCO032".carregaMunIBGE($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vGlbMunIBGE = voParams
					endif
					; --\-<@
					
					vCdEstado = ""
					if (ds_sigla.f_tmp_nr09svc = "RO")
						;Roraima.
						vCdEstado = 11
					elseif (ds_sigla.f_tmp_nr09svc = "AC")
						;Acre.
						vCdEstado = 12
					elseif (ds_sigla.f_tmp_nr09svc = "AM")
						;Amazonas.
						vCdEstado = 13
					elseif (ds_sigla.f_tmp_nr09svc = "RR")
						;Roraima.
						vCdEstado = 14
					elseif (ds_sigla.f_tmp_nr09svc = "PA")
						;Para.
						vCdEstado = 15
					elseif (ds_sigla.f_tmp_nr09svc = "AP")
						;Amapa.
						vCdEstado = 16
					elseif (ds_sigla.f_tmp_nr09svc = "TO")
						;Tocantins.
						vCdEstado = 17
					elseif (ds_sigla.f_tmp_nr09svc = "MA")
						;Maranhao.
						vCdEstado = 21
					elseif (ds_sigla.f_tmp_nr09svc = "PI")
						;Piaui.
						vCdEstado = 22
					elseif (ds_sigla.f_tmp_nr09svc = "CE")
						;Ceara.
						vCdEstado = 23
					elseif (ds_sigla.f_tmp_nr09svc = "RN")
						;Rio grande do norte.
						vCdEstado = 24
					elseif (ds_sigla.f_tmp_nr09svc = "PB")
						;Paraiba.
						vCdEstado = 25
					elseif (ds_sigla.f_tmp_nr09svc = "PE")
						;Pernambuco.
						vCdEstado = 26
					elseif (ds_sigla.f_tmp_nr09svc = "AL")
						;Alagoas.
						vCdEstado = 27
					elseif (ds_sigla.f_tmp_nr09svc = "SE")
						;Sergipe.
						vCdEstado = 28
					elseif (ds_sigla.f_tmp_nr09svc = "BA")
						;Bahia.
						vCdEstado = 29
					elseif (ds_sigla.f_tmp_nr09svc = "MG")
						;Minas gerais.
						vCdEstado = 31
					elseif (ds_sigla.f_tmp_nr09svc = "ES")
						;Espirito santo.
						vCdEstado = 32
					elseif (ds_sigla.f_tmp_nr09svc = "RJ")
						;Rio de janeiro.
						vCdEstado = 33
					elseif (ds_sigla.f_tmp_nr09svc = "SP")
						;Sao paulo.
						vCdEstado = 35
					elseif (ds_sigla.f_tmp_nr09svc = "PR")
						;Parana.
						vCdEstado = 41
					elseif (ds_sigla.f_tmp_nr09svc = "SC")
						;Santa catarina.
						vCdEstado = 42
					elseif (ds_sigla.f_tmp_nr09svc = "RS")
						;Rio grande do sul.
						vCdEstado = 43
					elseif (ds_sigla.f_tmp_nr09svc = "MS")
						;Mato grosso do sul.
						vCdEstado = 50
					elseif (ds_sigla.f_tmp_nr09svc = "MT")
						;Mato grosso.
						vCdEstado = 51
					elseif (ds_sigla.f_tmp_nr09svc = "GO")
						;Goias.
						vCdEstado = 52
					elseif (ds_sigla.f_tmp_nr09svc = "DF")
						;Distrito federal.
						vCdEstado = 53
					endif
					
					if (ds_sigla.f_tmp_nr09svc = "EX")
						vStringConv = ""
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					else
						; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
						;call convNumeric(CD_MUNICIPIOIBGE.GLB_MUNIBGESVC, 5, vStringConv)
						call convNumeric($item("CD_MUNICIPIOIBGE",vGlbMunIBGE), 5, vStringConv)    
						; --\-<@
						vStringConv = "%%vCdEstado%%vStringConv"
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					endif
					;Numero de inscricao do participante no suframa.
					vStringConv  = ""
					vStringConv = nr_suframa.f_tmp_nr09svc
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;Logradouro e endereco do imovel.

					;CFC: 17/05/2010 - Pegar no máximo 60 caracteres ou se não houver mover nulo ||
					;vStringAux = "|%%ds_logradouro.f_tmp_nr09svc"
					;vDsConteudo = "%%vDsConteudo%%vStringAux"

					;-- MAD [Proj/Tar.170/160] - 04/01/2011
					;length $ltrim(ds_logradouro.f_tmp_nr09svc, " ")
					;vTam = $result
					call converterString(ds_logradouro.f_tmp_nr09svc,ds_logradouro.f_tmp_nr09svc)
					vTam = $length(ds_logradouro.f_tmp_nr09svc)
					;;			
					if (vTam > 60)
						vTam = 60
					endif
					if (vTam > 0)
						vStringAux = ds_logradouro.f_tmp_nr09svc
						call convString("ds_logradouro.f_tmp_nr09svc", vStringAux, vTam, vStringConv)
					else
						vStringConv = ""		
					endif
					vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
					;
					;Numero do imovel.
					vStringAux = "|%%nr_logradouro.f_tmp_nr09svc"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Dados complementares do endereco.
					vStringAux = "|"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Bairro em que o imovel esta situado.
					vStringAux = "|%%nm_bairro.f_tmp_nr09svc"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"
					filedump/append vDsConteudo, vCaminho
					
					setocc "F_TMP_NR09SVC", $curocc(F_TMP_NR09SVC) + 1
				endwhile
				clear/e "F_TMP_NR09SVC"
			endif
			
		elseif (ds_reg.sis_arquivosvc = "0190")
			if (!$empty("TMP_NRDSSVC"))
				sort/e "TMP_NRDSSVC", "ds_geral.tmp_nrdssvc"
				setocc "TMP_NRDSSVC", 1
				while ($status >= 0)
					
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|0190"
					clear/e "PRD_TIPOESPECSVC"
					cd_especie.prd_tipoespecsvc/init = ds_geral.tmp_nrdssvc
					retrieve/e "PRD_TIPOESPECSVC"
					
					;Codigo da unidade de medida.
					vStringAux = "|%%ds_geral.tmp_nrdssvc"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Descricao da unidade de medida.
					;-- MAD [Proj/Tar.061/873] - 16/09/2010
					;A descrição foi "descomentada" para corrigir o erro na validação do arquivo
					vStringAux = "|%%ds_especie.prd_tipoespecsvc"
					;;
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"
					filedump/append vDsConteudo, vCaminho
					
					setocc "TMP_NRDSSVC", $curocc(TMP_NRDSSVC) + 1
				endwhile
				clear/e "TMP_NRDSSVC"
			endif
		
		elseif (ds_reg.sis_arquivosvc = "0200")
			if (!$empty("F_TMP_DS40SVC"))
				sort/e "F_TMP_DS40SVC", "DS_40.F_TMP_DS40SVC"
				setocc "F_TMP_DS40SVC", 1
				while ($status >= 0)
					if (DS_40.F_TMP_DS40SVC != "")
						vDsConteudo = ""
						;Texto fixo.
						vDsConteudo = "|0200"
						;Codigo do item.
						;vTotDig = $length(DS_40.F_TMP_DS40SVC)
						;vTotDig = 14
						;call convNumeric(DS_40.F_TMP_DS40SVC, vTotDig, vStringAux)
						;call convNumeric(DS_40.F_TMP_DS40SVC, 9, vStringConv)
						vStringAux = DS_40.F_TMP_DS40SVC
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
						;Descricao do item.
						call converterString(ds_produto.F_TMP_DS40SVC,vStringConv)
						vStringAux = "|%%vStringConv"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
						;Representacao alfanumerico do codigo de barra.
						vStringAux = "|"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
						;Codigo anterior do item.
						vStringAux = "|"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
						;Unidade de medida.
						vCdEspecie = ds_especie.F_TMP_DS40SVC
						vStringAux = "|%%ds_especie.F_TMP_DS40SVC"  ; CFC: 15/10/2009 - Pegar a especie q esta na temporária.
						vDsConteudo = "%%vDsConteudo%%vStringAux"
						;Tipo do item.
						vTipo = ""
						if (DS_ESPECIE.F_TMP_DS40SVC = "SVC")
							vTipo = "09"
						else
							;;ICJ [PROJ/TAR 170/2] (17/06/2010)
							viParams = ""
							voParams = ""
							if ($item("CD_EMP_PADRAO_PRD",$xlplemp$) = "")
								putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $$gParamGlb)
							else
								putitem/id viParams, "CD_EMPRESA", $item("CD_EMP_PADRAO_PRD",$xlplemp$)
							endif				
							putitem/id viParams, "CD_PRODUTO", DS_40.F_TMP_DS40SVC
							putitem/id viParams, "NM_CARREGATABELA", "PRD_PRDINFO"
							activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								return(-1)
							endif
							if (voParams != "")
							;;
								if ($item("IN_PRODACABADO",voParams) 	= <TRUE>)
									vTipo = "04"
								elseif ($item("IN_MATPRIMA",voParams)	= <TRUE>)
									vTipo = "01"    
								elseif ($item("IN_MATCONSUMO",voParams) = <TRUE>)
									vTipo = "07"    
								elseif ($item("IN_PATRIMONIO",voParams) = <TRUE>)
									vTipo = "08"    
								else
									vTipo = "99"    
								endif
							else
								vTipo = "99"
							endif    
						endif
						
						vStringAux = "|%%vTipo"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
						;Codigo da nomeclatura comum do mercosul.
						vStringAux = ""
						;;ICJ [PROJ/TAR 61/846] (06/08/2010)
						if (cd_ncm.F_TMP_DS40SVC = "")
							if (DS_ESPECIE.F_TMP_DS40SVC = "SVC")
								;Se for serviço não tem ncm
							else
								clear/e "PRD_PRODUTOSVC"
								cd_produto.prd_produtosvc/init = DS_40.F_TMP_DS40SVC
								retrieve/e "PRD_PRODUTOSVC"
								if ($status >= 0)
									if (cd_tipi.prd_produtosvc != "")
										; @>-/-- Virginia - PRJ 061 - TAR 743 - 03/02/10
										vFisTipi = ""
										viParams = ""
										voParams = ""
										putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
										activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
										if ($procerror)
											$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
											return(-1)
										elseif ($status < 0)
											$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
											return(-1)
										endif
										if (voParams != "")
											vFisTipi = voParams
											vFisTipi = $replace(vFisTipi, 1, ".","",-1)	
											vStringAux = $item("CD_TIPI",vFisTipi)
										endif
										; --\-<@
									endif
								endif
							endif
						else
							vStringAux = cd_ncm.F_TMP_DS40SVC
						endif
						;vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux[1:8]"
						;Codigo EX, conforme a TIPI.
						;vStringAux = "|"
						;vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
						;--> VSOUZA PRJ/TAR 170/397 18/11/2011
						if (CD_NCM.F_TMP_DS40SVC[9:2] != "") & (CD_NCM.F_TMP_DS40SVC[9:2] != $dsSiglaExTipi$)
							vDsConteudo = "%%vDsConteudo%%%|%%vStringAux[9:2]"
						else
							vStringAux = ""
							vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
						endif
						;----------------------------------------<
						;;
						;Codigo do genero do item.
						call convNumeric(cd_ncm.F_TMP_DS40SVC[1:2], 2, vStringConv)
						if (vStringConv = "00")
							vStringConv = ""
						endif
						vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
						;Codigo do servico.
						vStringAux = "|"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
						;Aliquota de ICMS aplicavel ao item.
						vStringAux = "|"
						vDsConteudo = "%%vDsConteudo%%vStringAux"
						;Marcador.
						vDsConteudo = "%%vDsConteudo%%%|%%^"
						filedump/append vDsConteudo, vCaminho

						;;ICJ [PROJ/TAR 61/910] (23/03/2011)
						if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011

							;-- MAD [Proj/Tar.170/278] - 31/05/2011							
							;clear/e "PRD_PRDCONVMESVC"
							;CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
							;retrieve/e "PRD_PRDCONVMESVC"
							;while ($status >= 0)
							;	vGerou0220 = <TRUE>		
							;	$Cont0220$ = $Cont0220$ + 1
							;	vDsConteudo = ""
							;	;Texto fixo.
							;	vDsConteudo = "|0220"
							;	;Unidade Conv.	
							;	call converterString(CD_ESPECIECONV.PRD_PRDCONVMESVC,vStringConv)
							;	vStringAux = "|%%vStringConv"
							;	vDsConteudo = "%%vDsConteudo%%vStringAux"
							;	;Fat Conv.	
							;	call converterString(QT_CONVERSAO.PRD_PRDCONVMESVC,vStringConv)
							;	vStringAux = "|%%vStringConv"
							;	vDsConteudo = "%%vDsConteudo%%vStringAux"
							;	;Marcador.
							;	vDsConteudo = "%%vDsConteudo%%%|%%^"
							;	filedump/append vDsConteudo, vCaminho
							;	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
							;	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
							;	$nrRegistroArq$  = $nrRegistroArq$  + 1
							;	setocc "PRD_PRDCONVMESVC", $curocc(PRD_PRDCONVMESVC) + 1
							;endwhile

							clear/e "GTT_DS01SVC"
							NR_GERAL.GTT_DS01SVC/init = DS_40.F_TMP_DS40SVC
							retrieve/e "GTT_DS01SVC"
							if ($status >= 0)
								setocc "GTT_DS01SVC",1
								while ($status >= 0)					
									vGerou0220  = <TRUE>		
									$Cont0220$  = $Cont0220$ + 1
									vDsConteudo = ""
									;Texto fixo.
									vDsConteudo = "|0220"
									;Unidade Conv.	
									call converterString(DS_GERAL.GTT_DS01SVC,vStringConv)
									vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
									;Fat Conv.
									vNumericAux = QT_CONVERSAO.GTT_DS01SVC
									call editarNr(8, 6, vNumericAux, vNumericAux)
									call convValorString(6,vNumericAux, vStringConv)
									vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
									;Marcador.
									vDsConteudo = "%%vDsConteudo%%%|%%^"
									filedump/append vDsConteudo, vCaminho
									$nrLinhaBloco$   = $nrLinhaBloco$   + 1
									$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
									$nrRegistroArq$  = $nrRegistroArq$  + 1
									setocc "GTT_DS01SVC", $curocc(GTT_DS01SVC) + 1
								endwhile
							endif
							;;
						endif
						;;
					endif
					setocc "F_TMP_DS40SVC", $curocc(F_TMP_DS40SVC) + 1
				endwhile
				;;ICJ [PROJ/TAR 195/64] (15/03/2012)
				;clear/e "F_TMP_DS40SVC" 
				setocc "F_TMP_DS40SVC", 1
				;;
			endif
			;; ICJ [PROJ/TAR 170/196] (17/02/2011)
			if (!$empty("F_TMP_DS60SVC"))
				sort/e "F_TMP_DS60SVC", "DS_60.F_TMP_DS60SVC"
				setocc "F_TMP_DS60SVC", 1
				while ($status >= 0)
					if (DS_60.F_TMP_DS60SVC != "")
						;;ICJ [PROJ/TAR 195/64] (15/03/2012)	
						vInGera = <TRUE>
						if ($length(DS_60.F_TMP_DS60SVC) <= 9)
							vCdProduto = DS_60.F_TMP_DS60SVC
							creocc "F_TMP_DS40SVC", -1
							DS_40.F_TMP_DS40SVC = vCdProduto
							retrieve/o "F_TMP_DS40SVC"
							if ($status = 4)
								vInGera = <FALSE>
								$qtRegProduto$ = $qtRegProduto$ - 1
							endif
						endif
						if (vInGera = <TRUE>)
						;;
							vDsConteudo = ""
							;Texto fixo.
							vDsConteudo = "|0200"
							;Codigo do item.
							;vTotDig = $length(DS_60.F_TMP_DS60SVC)
							;vTotDig = 14
							;call convNumeric(DS_60.F_TMP_DS60SVC, vTotDig, vStringAux)	
							;call convNumeric(DS_40.F_TMP_DS40SVC, 9, vStringConv)
							vStringAux = DS_60.F_TMP_DS60SVC
							vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
							;Descricao do item.
							call converterString(DS_PRODUTO.F_TMP_DS60SVC,vStringConv)
							vStringAux = "|%%vStringConv"
							vDsConteudo = "%%vDsConteudo%%vStringAux"
							;Representacao alfanumerico do codigo de barra.
							vStringAux = "|"
							vDsConteudo = "%%vDsConteudo%%vStringAux"
							;Codigo anterior do item.
							vStringAux = "|"
							vDsConteudo = "%%vDsConteudo%%vStringAux"
							;Unidade de medida.
							vCdEspecie = DS_ESPECIE.F_TMP_DS60SVC
							vStringAux = "|%%DS_ESPECIE.F_TMP_DS60SVC"  ; CFC: 15/10/2009 - Pegar a especie q esta na temporária.
							vDsConteudo = "%%vDsConteudo%%vStringAux"
							;Tipo do item.
							vTipo = ""
							if (DS_ESPECIE.F_TMP_DS60SVC = "SVC")
								vTipo = "09"
							else
								;;ICJ [PROJ/TAR 170/2] (17/06/2010)
								viParams = ""
								voParams = ""
								if ($item("CD_EMP_PADRAO_PRD",$xlplemp$) = "")
									putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $$gParamGlb)
								else
									putitem/id viParams, "CD_EMPRESA", $item("CD_EMP_PADRAO_PRD",$xlplemp$)
								endif				
								putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.F_TMP_DS60SVC
								putitem/id viParams, "NM_CARREGATABELA", "PRD_PRDINFO"
								activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
								if ($procerror)
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									return(-1)
								endif
								if (voParams != "")
								;;
									if ($item("IN_PRODACABADO",voParams) 	= <TRUE>)
										vTipo = "04"
									elseif ($item("IN_MATPRIMA",voParams)	= <TRUE>)
										vTipo = "01"    
									elseif ($item("IN_MATCONSUMO",voParams) = <TRUE>)
										vTipo = "07"    
									elseif ($item("IN_PATRIMONIO",voParams) = <TRUE>)
										vTipo = "08"    
									else
										vTipo = "99"    
									endif
								else
									vTipo = "99"
								endif    
							endif
							
							vStringAux = "|%%vTipo"
							vDsConteudo = "%%vDsConteudo%%vStringAux"
							;Codigo da nomeclatura comum do mercosul.
							vStringAux = ""
							vStringAux = cd_tipi.F_TMP_DS60SVC
							vDsConteudo = "%%vDsConteudo%%%|%%vStringAux[1:8]"
							;Codigo EX, conforme a TIPI.
							;vStringAux = "|"
							;vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
							vDsConteudo = "%%vDsConteudo%%%|%%vStringAux[9:2]"
							;;
							;Codigo do genero do item.
							call convNumeric(cd_tipi.F_TMP_DS60SVC[1:2], 2, vStringConv)
							if (vStringConv = "00")
								vStringConv = ""
							endif
							vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
							;Codigo do servico.
							vStringAux = "|"
							vDsConteudo = "%%vDsConteudo%%vStringAux"
							;Aliquota de ICMS aplicavel ao item.
							vStringAux = "|"
							vDsConteudo = "%%vDsConteudo%%vStringAux"
							;Marcador.
							vDsConteudo = "%%vDsConteudo%%%|%%^"
							filedump/append vDsConteudo, vCaminho
	
							;;ICJ [PROJ/TAR 61/910] (23/03/2011)
							if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
	
								;-- MAD [Proj/Tar.170/278] - 31/05/2011
								;clear/e "PRD_PRDCONVMESVC"
								;CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
								;retrieve/e "PRD_PRDCONVMESVC"
								;while ($status >= 0)
								;	vGerou0220 = <TRUE>	
								;	$Cont0220$ = $Cont0220$ + 1
								;	vDsConteudo = ""
								;	;Texto fixo.
								;	vDsConteudo = "|0220"
								;	;Unidade Conv.	
								;	call converterString(DS_60.F_TMP_DS60SVC,vStringConv)
								;	vStringAux = "|%%vStringConv"
								;	vDsConteudo = "%%vDsConteudo%%vStringAux"
								;	;Fat Conv.	
								;	call converterString(QT_CONVERSAO.PRD_PRDCONVMESVC,vStringConv)
								;	vStringAux = "|%%vStringConv"
								;	vDsConteudo = "%%vDsConteudo%%vStringAux"
								;	;Marcador.
								;	vDsConteudo = "%%vDsConteudo%%%|%%^"
								;	filedump/append vDsConteudo, vCaminho
								;	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
								;	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
								;	$nrRegistroArq$  = $nrRegistroArq$  + 1
								;	$instancehandle->totalizarQtdTipoRegistro("0220")
								;	if ($procerror)
								;		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								;		poCdErro  = $xCdErro$
								;		poCtxErro = $xCtxErro$
								;		return(-1)
								;	elseif ($status < 0)
								;		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								;		poCdErro  = $xCdErro$
								;		poCtxErro = $xCtxErro$
								;		return(-1)
								;	endif
								;	setocc "PRD_PRDCONVMESVC", $curocc(PRD_PRDCONVMESVC) + 1
								;endwhile
	
								clear/e "GTT_DS01SVC"
								NR_GERAL.GTT_DS01SVC/init = DS_60.F_TMP_DS60SVC
								if (NR_GERAL.GTT_DS01SVC > 0)
									retrieve/e "GTT_DS01SVC"
									if ($status >= 0)					
										setocc "GTT_DS01SVC",1
										while ($status >= 0)					
											vGerou0220  = <TRUE>		
											$Cont0220$  = $Cont0220$ + 1
											vDsConteudo = ""
											;Texto fixo.
											vDsConteudo = "|0220"
											;Unidade Conv.	
											call converterString(DS_GERAL.GTT_DS01SVC,vStringConv)
											vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
											;Fat Conv.
											vNumericAux = QT_CONVERSAO.GTT_DS01SVC
											call editarNr(8, 6, vNumericAux, vNumericAux)
											call convValorString(6,vNumericAux, vStringConv)
											vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
											;Marcador.
											vDsConteudo = "%%vDsConteudo%%%|%%^"
											filedump/append vDsConteudo, vCaminho
											$nrLinhaBloco$   = $nrLinhaBloco$   + 1
											$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
											$nrRegistroArq$  = $nrRegistroArq$  + 1
											setocc "GTT_DS01SVC", $curocc(GTT_DS01SVC) + 1
										endwhile
									endif
								endif
								;;
							endif
							;;
						endif
					endif
					setocc "F_TMP_DS60SVC", $curocc(F_TMP_DS60SVC) + 1
				endwhile
				clear/e "F_TMP_DS60SVC"
				clear/e "F_TMP_DS40SVC" 
			endif
			;;	
		;; ICJ [PROJ/TAR 170/200] (03/03/2011)
		elseif (ds_reg.sis_arquivosvc = "0300")
			if (!$empty("F2_TMP_DS60SVC"))
				sort/e "F2_TMP_DS60SVC", "DS_60.F2_TMP_DS60SVC"
				setocc "F2_TMP_DS60SVC", 1
				while ($status >= 0)
					if (DS_60.F2_TMP_DS60SVC != "")
						vDsConteudo = ""
						;Texto fixo.
						vDsConteudo = "|0300"
						;Código individualizado do bem
						vStringAux = "%%DS_60.F2_TMP_DS60SVC"
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"	
						;Identificação do tipo de mercadoria (1=bem | 2=componente)
						vStringAux = "%%TP_MERCADORIA.F2_TMP_DS60SVC"
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"	
						;Descrição do bem 
						call converterString(DS_BEM.F2_TMP_DS60SVC,vStringAux)
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"	
						;Código de cadastro do bem principal
						vStringAux = "%%CD_BEM.F2_TMP_DS60SVC"
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"	
						;Código da conta analítica de contabilização do bem
						vStringAux = "%%CD_CONTA.F2_TMP_DS60SVC"
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"	
						;Número total de parcelas a serem apropriadas
						vStringAux = "%%NR_PARCELA.F2_TMP_DS60SVC"
						vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"	
						;Marcador.
						vDsConteudo = "%%vDsConteudo%%%|%%^"
						filedump/append vDsConteudo, vCaminho
					
						;Informação sobre a utilização do bem (Centro de Custo)
						clear/e "PAT_IMOBINFOSVC"
						CD_PRODUTO.PAT_IMOBINFOSVC/init   = CD_PRODUTO.F2_TMP_DS60SVC
						NR_SEQUENCIA.PAT_IMOBINFOSVC/init = NR_SEQUENCIA.F2_TMP_DS60SVC
						retrieve/e "PAT_IMOBINFOSVC"
						if ($status >= 0)

							$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0305", "", "")
							if ($procerror)
								$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								poCdErro  = $xCdErro$
								poCtxErro = $xCtxErro$
							endif
	
							setocc "PAT_IMOBINFOSVC",-1
							sort/e "PAT_IMOBINFOSVC", "PR_PARTICIPACAO.PAT_IMOBINFOSVC desc"
							setocc "PAT_IMOBINFOSVC",1
	
							vDsConteudo = ""
							;Texto fixo.
							vDsConteudo = "|0305"
							;Código do centro de custo
							viParams = ""
							putitem viParams, -1, "NATUREZA_COMERCIAL_EMP"
							putitem viParams, -1, "CD_CCUSTOPADRAO_FCP"
							activate "ADMSVCO001".GetParamEmpresa(CD_EMPRESA.PAT_IMOBINFOSVC, viParams, voParams, $xcderro$, $xctxerro$)
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								return(-1)
							endif
							vNaturezaComercialEmp 	= $item("NATUREZA_COMERCIAL_EMP",	voParams)
							vCdCCustoPadraoFcp    	= $item("CD_CCUSTOPADRAO_FCP"   ,	voParams)
	
					     	;---- WMC - 16/02/2011 - A PEDIDO DO RENAN
					;		if (CD_CCUSTO.PAT_IMOBINFOSVC != vCdCCustoPadraoFcp)
					;		if (CD_CCUSTO.PAT_IMOBINFOSVC != 999)
							if ($tpCCustoPat$ = 2) ; rodrigo - PRJ 166 TAR 78
								vDsConteudo = "%%vDsConteudo%%%|%%CD_CCUSTO.PAT_IMOBINFOSVC"
							else
								if (TP_AREA.PAT_IMOBINFOSVC = 2)
									vStringAux = "1"
								elseif (TP_AREA.PAT_IMOBINFOSVC = 3)
									vStringAux = "4"
								elseif (TP_AREA.PAT_IMOBINFOSVC = 4)
									vStringAux = "3"
								elseif (TP_AREA.PAT_IMOBINFOSVC = 1) 
									if (vNaturezaComercialEmp = 2 | vNaturezaComercialEmp = 3)
										vStringAux = "2"
									else
										vStringAux = "5"
									endif
								endif
								vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
							endif
	
							;Descrição da função do bem
							call converterString(DS_FUNCAO.PAT_IMOBINFOSVC,vStringAux)
							vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
							;Vida útil estimada do bem, em número de meses
							vNumericAux = NR_VIDAUTIL.F2_TMP_DS60SVC * 12
							call convNumeric(vNumericAux, 3, vStringAux)
							vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
							;Marcador.
							vDsConteudo = "%%vDsConteudo%%%|%%^"
							filedump/append vDsConteudo, vCaminho
						endif
					endif

					setocc "F2_TMP_DS60SVC", $curocc(F2_TMP_DS60SVC) + 1
				endwhile
				clear/e "F2_TMP_DS60SVC"
			endif
		;;
		elseif (ds_reg.sis_arquivosvc = "0400")
			if (!$empty("TMP_NR08SVC"))
				sort/e "TMP_NR08SVC", "nr_08.tmp_nr08svc"
				setocc "TMP_NR08SVC", 1
				while ($status >= 0)
					
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|0400"
					;Codigo da natureza da operacao/prestacao.
					vStringAux = "|%%nr_08.tmp_nr08svc"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Descricao da natureza da operacao/prestacao.
					vStringAux = "|%%ds_cfop.tmp_nr08svc"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"
					filedump/append vDsConteudo, vCaminho
					
					setocc "TMP_NR08SVC", $curocc(TMP_NR08SVC) + 1
				endwhile
				clear/e "TMP_NR08SVC"
			endif

		;-- MAD [Proj/Tar.170/238] - 27/04/2011
		elseif (ds_reg.sis_arquivosvc = "0450")
			clear/e "GTT_OBSNFSVC"
			TP_OBSNF.GTT_OBSNFSVC/init = 1 ; Informação complementar
			retrieve/e "GTT_OBSNFSVC"
			if ($status >= 0)
				sort/e "GTT_OBSNFSVC", "NR_SEQUENCIA.GTT_OBSNFSVC"
				setocc "GTT_OBSNFSVC", 1
				while ($status >= 0)
					
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|0450"
					;Código da informação complementar do documento fiscal.
					vStringAux = "|%%NR_SEQUENCIA.GTT_OBSNFSVC"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Texto livre da informação complementar existente no documento fiscal.
					vStringAux = "|%%DS_OBSNF.GTT_OBSNFSVC"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"

					filedump/append vDsConteudo, vCaminho
					$nrLinhaArquivo$   = $nrLinhaArquivo$   + 1
					$nrLinhaBloco0990$ = $nrLinhaBloco0990$ + 1

					discard "GTT_OBSNFSVC", 0
					if ($status = 0)
						$status = -1
					endif
				endwhile
			endif

		elseif (ds_reg.sis_arquivosvc = "0460")
			clear/e "GTT_OBSNFSVC"
			TP_OBSNF.GTT_OBSNFSVC/init = 2 ; Obs. Fisco
			retrieve/e "GTT_OBSNFSVC"
			if ($status >= 0)
				sort/e "GTT_OBSNFSVC", "NR_SEQUENCIA.GTT_OBSNFSVC"
				setocc "GTT_OBSNFSVC", 1
				while ($status >= 0)
					
					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|0460"
					;Código da Observação do lançamento fiscal
					vStringAux = "|%%NR_SEQUENCIA.GTT_OBSNFSVC"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Descrição da observação vinculada ao lançamento fiscal
					vStringAux = "|%%DS_OBSNF.GTT_OBSNFSVC"
					vDsConteudo = "%%vDsConteudo%%vStringAux"
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"

					filedump/append vDsConteudo, vCaminho
					$nrLinhaArquivo$   = $nrLinhaArquivo$   + 1
					$nrLinhaBloco0990$ = $nrLinhaBloco0990$ + 1

					discard "GTT_OBSNFSVC", 0
					if ($status = 0)
						$status = -1
					endif
				endwhile
			endif
		;;
		;;ICJ [PROJ/TAR 195/64] (15/03/2012)
		elseif (DS_REGISTRO.SIS_ARQUIVOSVC[2:4] = "9900") & (DS_REGISTRO.SIS_ARQUIVOSVC[7:4] = "0200")
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|9900"
			;Tipo Arquivo.
			vStringAux = "|0200"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Quantidade total de linhas do bloco 0.
			vNumericAux= $qtRegProduto$
			vStringAux = "|%%vNumericAux"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			ds_registro.sis_arquivosvc = vDsConteudo
			vDsConteudo = ds_registro.sis_arquivosvc
			filedump/append vDsConteudo, vCaminho
		;;
		;;ICJ [PROJ/TAR 61/910] (23/03/2011)
		elseif (DS_REGISTRO.SIS_ARQUIVOSVC[2:4] = "9900") & (DS_REGISTRO.SIS_ARQUIVOSVC[7:4] = "0220")
			if (vGerou0220)
				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|9900"
				;Tipo Arquivo.
				vStringAux = "|0220"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Quantidade total de linhas do bloco 0.
				vNumericAux= $Cont0220$
				vStringAux = "|%%vNumericAux"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"
				ds_registro.sis_arquivosvc = vDsConteudo
				vDsConteudo = ds_registro.sis_arquivosvc
				filedump/append vDsConteudo, vCaminho
			endif
		;;
		else
			if (ds_reg.sis_arquivosvc = "0990")
				vDsConteudo = ""
				;Texto fixo.
				vDsConteudo = "|0990"
				;Quantidade total de linhas do bloco 0.
				vNumericAux= $nrLinhaBloco0990$ + $qtRegEspecie$ + $qtRegPessoaNf$ + $qtRegCfop$ + $qtRegProduto$ + $qtReg0300$ + $qtReg0305$ + $Cont0220$
				vStringAux = "|%%vNumericAux"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
				;Marcador.
				vDsConteudo = "%%vDsConteudo%%%|%%^"
				ds_registro.sis_arquivosvc = vDsConteudo
			endif
			vDsConteudo = ds_registro.sis_arquivosvc
			filedump/append vDsConteudo, vCaminho
		endif
		
		setocc "SIS_ARQUIVOSVC", $curocc(SIS_ARQUIVOSVC) + 1
	endwhile
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|9999"
	;Quantidade total de linhas do arquivo digital.
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1 + $qtRegEspecie$ + $qtRegPessoaNf$ + $qtRegProduto$ + $qtRegCfop$ + $qtReg0300$ + $qtReg0305$ 
	vStringAux = "|%%$nrLinhaArquivo$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	filedump/append vDsConteudo, vCaminho

	vFlag = <FALSE>
	activate "vbfileman".arqexiste(vFlag,$item("DS_PATH", $parametro$)) ;Localiza e apaga o arquivo existente
	if (vFlag)
		activate "vbfileman".apagaarquivo($item("DS_PATH", $parametro$))
	endif
	activate "vbfileman".movearquivo(vEOF,vCaminho,$item("DS_PATH", $parametro$))
	vFlag = <FALSE>
	activate "vbfileman".arqexiste(vFlag,vCaminho) 
	if (vFlag)
		activate "vbfileman".apagaarquivo(vCaminho)
	endif
	
	clear/e "SIS_ARQUIVOSVC"
	
	return(0)
End ;operation gerarEFDArquivoTexto.


;-------------------------------------------
partner operation substituiCaractereEspecial
	;-------------------------------------------
	params
		string  piDadoEntra : IN
		numeric piTamFinal  : IN
		string  poDadoSai   : OUT
	endparams
	
	variables
		string  vDadoEntra, vDadoSai, vPos
		numeric vTamDado, vCta
	endvariables
	
	length piDadoEntra
	vTamDado = $result
	uppercase piDadoEntra, vDadoEntra    
	vCta = 0
	vDadoSai = ""
	if (vTamDado < 1)
		return (0)
	endif
	repeat
		vCta = vCta + 1
		if ((vDadoEntra [vCta:1] >= "0") & (vDadoEntra [vCta:1] <= "9")) | %\
		((vDadoEntra [vCta:1] >= "A") & (vDadoEntra [vCta:1] <= "Z")) | %\
		(vDadoEntra [vCta:1] >= " ")            
		vDadoSai = "%%vDadoSai%%vDadoEntra[vCta:1]"
	else
		selectcase vDadoEntra[vCta:1]
			case "Ã" 
				vPos = "A"
			case "À" 
				vPos = "A"
			case "Á" 
				vPos = "A"
			case "Â" 
				vPos = "A"
			case "Ä" 
				vPos = "A"
			case "È"
				vPos = "E"
			case "É" 
				vPos = "E"
			case "Ê" 
				vPos = "E"
			case "Ë" 
				vPos = "E"
			case "Ì" 
				vPos = "I"
			case "Í" 
				vPos = "I"
			case "Î" 
				vPos = "I"
			case "Ï" 
				vPos = "I"
			case "Õ" 
				vPos = "O"
			case "Ò" 
				vPos = "O"
			case "Ó" 
				vPos = "O"
			case "Ô" 
				vPos = "O"
			case "Ö" 
				vPos = "O"
			case "Ù" 
				vPos = "U"
			case "Ú" 
				vPos = "U"
			case "Û" 
				vPos = "U"
			case "Ü" 
				vPos = "U"
			case "U" 
				vPos = "U"
			case "U" 
				vPos = "U"
			case "Ñ" 
				vPos = "N"
			case "~" 
				vPos = " "
			case "^" 
				vPos = " "
			case "`" 
				vPos = " "
			case "" 
				vPos = " "
			elsecase 
				vPos = vDadoEntra[vCta:1]                      
		endselectcase 
		vDadoSai = "%%vDadoSai%%vPos"
	endif
until (vCta = vTamDado)     

$instancehandle->preencheEspacosDireita(vDadoSai,piTamFinal,poDadoSai)
return (0)
end ; entry substituiCaractereEspecial


;---------------------------------------
partner operation preencheEspacosDireita
	;---------------------------------------
	params
		string  piDadoEntra : IN
		numeric piTamFinal : IN
		string  poDadoSai : OUT
	endparams
	variables
		numeric vTam
		string  vEspaco
	endvariables
	
	length piDadoEntra
	vTam = $result
	if (vTam < piTamFinal)
		poDadoSai = piDadoEntra
		vEspaco = " "
		repeat 
			poDadoSai = "%%poDadoSai%%vEspaco"
			vTam = vTam + 1
		until (vTam = piTamFinal)
	else
		poDadoSai = piDadoEntra[1:piTamFinal]    
	endif
	
	return(0)
end ; entry preencheEspacosDireita


;--------------------------------------------------;
;-- MAD [Proj/Tar.061/875] - 29/09/2010            ;
partner operation gerarEFDBlocoDRegD500            ;
;--------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vGlbLogradouro, vPesCliente, vNumericAux
		numeric vCdEstado
		date    vDtAux
	endvariables
	
	clear/e "FIS_NFSVC"
	CD_EMPFAT.FIS_NFSVC/init        = $item("CD_EMPRESA", $parametro$)
;--> VSOUZA PRJ/TAR 189/040 18/10/2011
;	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
;	if ($inConsideraDtemisNfsai$ = <TRUE>)
;		DT_EMISSAO.FIS_NFSVC/init       = $item("DT_PERIODO", $parametro$)
;	else
	DT_SAIDAENTRADA.FIS_NFSVC/init  = $item("DT_PERIODO", $parametro$)
;	endif
;	;------//------//------
;------------------------------------<
	TP_SITUACAO.FIS_NFSVC/init      = "E·;C"
	TP_MODDCTOFISCAL.FIS_NFSVC/init = "21·;22"
	retrieve/e "FIS_NFSVC"
	if ($status < 0)
		return(0)
	endif

	setocc "FIS_NFSVC",-1
	setocc "FIS_NFSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D500 / %%nr_fatura.fis_nfsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		;;ICJ [PROJ/TAR 175/41] (20/01/2011)
		;if ($item("TP_PERFIL", $parametro$) != "B")
		if ($item("TP_PERFIL", $parametro$) != "B") | (TP_OPERACAO.FIS_NFSVC = "E") 
		;;
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|D500"
			;Indicador do tipo de operacao.
			if (tp_operacao.fis_nfsvc = "E")
				;Aquisicao.
				vStringAux = "|0"
			else
				;Prestacao.
				vStringAux = "|1"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Indicador do emitente do documento fiscal.
			if (tp_origememissao.fis_nfsvc = "1")
				;Emissao propria.
				vStringAux = "|0"
			else
				;Emissao terceiro.
				vStringAux = "|1"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
				
			clear/e "FIS_S_NFREMDESVC"
			cd_empfat.fis_s_nfremdesvc/init  = cd_empfat.fis_nfsvc
			dt_fatura.fis_s_nfremdesvc/init  = dt_fatura.fis_nfsvc
			nr_fatura.fis_s_nfremdesvc/init  = nr_fatura.fis_nfsvc
			retrieve/e "FIS_S_NFREMDESVC"
			if ($status >= 0)
				if(TP_SITUACAO.FIS_NFSVC != "C")&(TP_SITUACAO.FIS_NFSVC != "D") ; rodrigo - PRJ 170 TAR 345 - 22/08/2011
					creocc "F_TMP_NR09SVC", -1
					nr_geral.f_tmp_nr09svc = cd_pessoa.fis_s_nfremdesvc
					retrieve/o "F_TMP_NR09SVC"
					if ($status = 4)
						retrieve/x "F_TMP_NR09SVC"
					endif
				
					nm_cliente.f_tmp_nr09svc = nm_nome.fis_s_nfremdesvc
					tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_s_nfremdesvc
					if (tp_pessoa.fis_s_nfremdesvc = "F")
						nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_s_nfremdesvc
					else
						nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_s_nfremdesvc
					endif
					nr_rginscr.f_tmp_nr09svc    = nr_rginscrest.fis_s_nfremdesvc

						vPesCliente = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_s_nfremdesvc
					activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vPesCliente = voParams
					endif
				
					nr_suframa.f_tmp_nr09svc = $item("NR_SUFRAMA",vPesCliente)
					ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_s_nfremdesvc %%nm_logradouro.fis_s_nfremdesvc"
					nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_s_nfremdesvc
					nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_s_nfremdesvc
				
					if (cd_cep.fis_s_nfremdesvc != 99999999)
						vGlbLogradouro = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_CEP", cd_cep.fis_s_nfremdesvc
						activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vGlbLogradouro = voParams
						endif
					
						vCdEstado = ""
						vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
						cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
						cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
						ds_estado.f_tmp_nr09svc    = vCdEstado
						ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
					endif
				endif
			endif

			;Codigo do participante.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				call convNumeric(cd_pessoa.fis_s_nfremdesvc, 9, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo do modelo do documento fiscal.
			vNumericAux = tp_moddctofiscal.fis_nfsvc
			call convNumeric(vNumericAux, 2, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da situacao do documento fiscal.
			if (tp_situacao.fis_nfsvc = "E")
				;Nota emitida.
				vStringAux = "|00"
			else
				;Nota cancelada.
				vStringAux = "|02"
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Serie do documento fiscal.
			vStringAux = "|%%cd_serie.fis_nfsvc"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Subserie do documento fiscal.
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Numero do documento fiscal.
			call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Data de emissao do documento fiscal.
			vDtAux = dt_emissao.fis_nfsvc
			vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Data da entrada (aquisição) ou da saída (prestação do serviço)
			if (tp_situacao.fis_nfsvc = "C")
				vStringAux = ""
			else
				vDtAux = dt_saidaentrada.fis_nfsvc
				vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Valor total do documento fiscal.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = vl_totalnota.fis_nfsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor total do desconto.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = vl_desconto.fis_nfsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor da prestacao de servico.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = vl_totalnota.fis_nfsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor total dos servicos nao-tributados pelo ICMS.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = 0
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor cobrado em nome de terceiros.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = 0
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor de de outras despesas indicadas no documento fiscal.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = 0
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor da base de calculo do ICMS.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = vl_baseicms.fis_nfsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do ICMS.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = vl_icms.fis_nfsvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da informacao complementar
			vStringAux = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"

			clear/e "FIS_NFIMPOSTOSVC"
			cd_empfat.fis_nfimpostosvc/init  = cd_empfat.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 6 ;PIS.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status < 0)
				clear/e "FIS_NFIMPOSTOSVC"
			endif
			;Valor do PIS.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = vl_imposto.fis_nfimpostosvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		
			clear/e "FIS_NFIMPOSTOSVC"
			cd_empfat.fis_nfimpostosvc/init  = cd_empfat.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 5 ;COFINS.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status < 0)
				clear/e "FIS_NFIMPOSTOSVC"
			endif
			;Valor do COFINS.
			if (tp_situacao.fis_nfsvc = "C")
				vStringConv = ""
			else
				vNumericAux = vl_imposto.fis_nfimpostosvc
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringConv)
			endif
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da conta analitica contabil debitada/creditada.
			vStringAux  = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Código do Tipo de Assinante
			if (tp_situacao.fis_nfsvc = "C")
				vStringAux = "|"
			else
				vStringAux = "|1" ; Comercial/Industrial
			endif
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
				
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "D500"
			ds_registro.sis_arquivosvc = vDsConteudo
		
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
		
			$instancehandle->totalizarQtdTipoRegistro("D500")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			
			clear/e "FIS_NFITEMSVC"
			cd_empfat.fis_nfitemsvc/init = cd_empfat.fis_nfsvc
			dt_fatura.fis_nfitemsvc/init = dt_fatura.fis_nfsvc
			nr_fatura.fis_nfitemsvc/init = nr_fatura.fis_nfsvc
			retrieve/e "FIS_NFITEMSVC"
	
			if (tp_operacao.fis_nfsvc = "S")
				;Itens da nota fiscal de servico de comunicação.
				$instancehandle->gerarEFDBlocoDRegD510($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
		
			if (tp_situacao.fis_nfsvc = "E")
				;Registro analitico dos documentos.
				$instancehandle->gerarEFDBlocoDRegD590($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
		endif
		discard "FIS_NFSVC"
		if ($status = 0)
			$status = -1
		endif
	endwhile
	clear/e "FIS_NFSVC"
	
	return(0)

End ;operation gerarEFDBlocoDRegD500.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.061/875] - 29/09/2010          ;
partner operation gerarEFDBlocoDRegD510          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, viParams, voParams, vStrAux, vNumericAux
		numeric vContador, vCdEstado, vVlBaseIcms, vVlIcms, vTotDig
		string  vFisCfop, vFisTipi, vGlbLogradouro, vPesCliente
	endvariables
	
	if ($empty("FIS_NFITEMSVC"))
		return(0)
	endif
	
	setocc "FIS_NFITEMSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D510 / %%cd_produto.fis_nfitemsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
			setocc "FIS_NFITEMPROSVC", 1
			vContador = vContador + 1
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|D510"
			;Numero sequencial do item no documento fiscal.
			vStringAux = "|%%vContador"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Codigo do item.
			;vTotDig = $length(cd_produto.fis_nfitemprosvc)
;			call convString("CD_PRODUTO", cd_produto.fis_nfitemprosvc, vTotDig, vStringConv)
; -> rodrigo - PRJ 170 TAR 231 - 31/03/2011
			;vTotDig = 14
;			call convNumeric(cd_produto.fis_nfitemprosvc, vTotDig, vStringConv)
			vStringConv = cd_produto.fis_nfitemprosvc
; <- rodrigo - PRJ 170 TAR 231 - 31/03/2011

			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			creocc "F_TMP_DS40SVC", -1
			if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
			else
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
			endif
			if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
				clear/e "PRD_PRDCONVMESVC"
				CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "PRD_PRDCONVMESVC"
				if ($status >= 0)
					$instancehandle->totalizarQtdTipoRegistro("0220")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			retrieve/o "F_TMP_DS40SVC"
			if ($status = 4)
				retrieve/x "F_TMP_DS40SVC"
				vCdEspecie = ds_especie.F_TMP_DS40SVC
			else
				ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
				ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
				vCdEspecie = cd_especie.fis_nfitemsvc
				if (cd_tipi.fis_nfitemsvc = "")
					if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemsvc
					else
						clear/e "PRD_PRODUTOSVC"
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
						retrieve/e "PRD_PRODUTOSVC"
						if ($status >= 0)
							if (CD_ESPECIE.FIS_NFITEMSVC = "")
								ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
								vCdEspecie = cd_especie.prd_produtosvc
							endif
							if (cd_tipi.prd_produtosvc != "")
								vFisTipi = ""
								viParams = ""
								voParams = ""
								putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
								activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
								if ($procerror)
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									return(-1)
								endif
								if (voParams != "")
									vFisTipi = voParams
									vStrAux = $item("CD_TIPI",vFisTipi)
									vStrAux = $replace(vStrAux, 1, ".","",-1)		
									cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
								endif
							endif
						endif
					endif
				else
					cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
					cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
				endif
			
				creocc "TMP_NRDSSVC", -1
				nr_geral.tmp_nrdssvc = 1
				ds_geral.tmp_nrdssvc = vCdEspecie
				retrieve/o "TMP_NRDSSVC"
				if ($status = 4)
					retrieve/x "TMP_NRDSSVC"
				endif
			endif

			;-- MAD [Proj/Tar.170/263] - 27/05/2011
			if (DS_40.F_TMP_DS40SVC != "")
				clear/e "FIS_NFITEMUNSVC"
				CD_EMPRESA.FIS_NFITEMUNSVC/init = CD_EMPRESA.FIS_NFITEMSVC
				NR_FATURA.FIS_NFITEMUNSVC/init  = NR_FATURA.FIS_NFITEMSVC
				DT_FATURA.FIS_NFITEMUNSVC/init  = DT_FATURA.FIS_NFITEMSVC
				NR_ITEM.FIS_NFITEMUNSVC/init    = NR_ITEM.FIS_NFITEMSVC
				CD_PRODUTO.FIS_NFITEMUNSVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "FIS_NFITEMUNSVC"
				if ($status >= 0) & (CD_ESPECIE.FIS_NFITEMUNSVC != vCdEspecie)
					vCdEspecie = CD_ESPECIE.FIS_NFITEMUNSVC
	
					clear/e "GTT_DS01SVC"
					creocc "GTT_DS01SVC", -1
					NR_GERAL.GTT_DS01SVC = DS_40.F_TMP_DS40SVC
					DS_GERAL.GTT_DS01SVC = vCdEspecie
					retrieve/o "GTT_DS01SVC"
					if ($status = -7)
						retrieve/x "GTT_DS01SVC"
					endif
					QT_CONVERSAO.GTT_DS01SVC = QT_CONVERSAO.FIS_NFITEMUNSVC
					$collhandle("GTT_DS01SVC")->Salvar()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif

					creocc "TMP_NRDSSVC", -1
					nr_geral.tmp_nrdssvc = 1
					ds_geral.tmp_nrdssvc = vCdEspecie
					retrieve/o "TMP_NRDSSVC"
					if ($status = 4)
						retrieve/x "TMP_NRDSSVC"
					endif

					creocc "TMP_DS40SVC", -1
					DS_40.TMP_DS40SVC = "0220"
					retrieve/o "TMP_DS40SVC"
					if ($status = -7)
						retrieve/x "TMP_DS40SVC"
					endif
				endif
			endif
			;;
		
			creocc "TMP_NR08SVC", -1
			nr_08.tmp_nr08svc = cd_cfop.fis_nfitemsvc
			retrieve/o "TMP_NR08SVC"
			if ($status = 4)
				retrieve/x "TMP_NR08SVC"
			else
				vFisCfop = ""
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_CFOP", cd_cfop.fis_nfitemsvc
				activate "FISSVCO032".carregaFisCfop($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				if (voParams != "")
					vFisCfop = voParams
					ds_cfop.tmp_nr08svc = $item("DS_CFOP",vFisCfop)
				endif
			endif
			
			;Codigo de classificacao do item.
			vStringAux = "|0599"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Quantidade do item.
			vNumericAux = qt_faturado.fis_nfitemsvc
			call editarNr(11, 3, vNumericAux, vNumericAux)
			call convValorString(3,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Unidade do item.
			vStringAux = "|%%vCdEspecie"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor do item.
			vNumericAux = vl_totalliquido.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do desconto.
			vNumericAux = vl_totaldesc.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da situacao tributaria.
			call convNumeric(cd_cst.fis_nfitemsvc, 3, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo fiscal de operacao e prestacao.
			call convNumeric(cd_cfop.fis_nfitemsvc, 4, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;ICMS.
			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 1
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			
			;Valor da base de calculo do ICMS.
			vNumericAux = vl_basecalc.fis_nfitemimpsvc + vVlBaseIcms
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Aliquota do ICMS.
			if (pr_aliquota.fis_nfitemimpsvc > 0)
				$vlAux$ = pr_aliquota.fis_nfitemimpsvc
				vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
			else
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
			endif
			;Valor do ICMS.
			vNumericAux = vl_imposto.fis_nfitemimpsvc + vVlIcms
			vNumericAux = vNumericAux[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			vVlBaseIcms = ""
			vVlIcms     = ""
			
			;Sustituicao tributaria.
			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 2
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			
			;Valor da base de calculo referente a substituicao tributaria.
			vNumericAux = vl_basecalc.fis_nfitemimpsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do ICMS referente a substituicao tributaria.
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round, 2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Indicador do tipo de receita.
			vStringAux  = "|0" ; Receita própria - serviços prestados
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Codigo do participante receptor da receita, terceiro da operacao.
			call convNumeric(cd_pessoa.fis_s_nfremdesvc, 9, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
				if(TP_SITUACAO.FIS_NFSVC != "C")&(TP_SITUACAO.FIS_NFSVC != "D") ; rodrigo - PRJ 170 TAR 345 - 22/08/2011
					creocc "F_TMP_NR09SVC", -1
					nr_geral.f_tmp_nr09svc = cd_pessoa.fis_s_nfremdesvc
					retrieve/o "F_TMP_NR09SVC"
					if ($status = 4)
						retrieve/x "F_TMP_NR09SVC"
					endif
					
					nm_cliente.f_tmp_nr09svc = nm_nome.fis_s_nfremdesvc
					tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_s_nfremdesvc
					if (tp_pessoa.fis_s_nfremdesvc = "F")
						nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_s_nfremdesvc
					else
						nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_s_nfremdesvc
					endif
					nr_rginscr.f_tmp_nr09svc    = nr_rginscrest.fis_s_nfremdesvc
					vPesCliente = ""
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_s_nfremdesvc
					activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
					if (voParams != "")
						vPesCliente = voParams
					endif
				
					NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)
					ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_s_nfremdesvc %%nm_logradouro.fis_s_nfremdesvc"
					nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_s_nfremdesvc
					nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_s_nfremdesvc
				
					if (cd_cep.fis_s_nfremdesvc != 99999999)    
						vGlbLogradouro = ""
						viParams = ""
						voParams = ""
						putitem/id viParams, "CD_CEP", cd_cep.fis_s_nfremdesvc
						activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status < 0)
							$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
							return(-1)
						endif
						if (voParams != "")
							vGlbLogradouro = voParams
						endif
						
						vCdEstado = ""
						vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
						cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
						cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
						ds_estado.f_tmp_nr09svc    = vCdEstado
						ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
					endif
				endif
			endif

			;PIS.
			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 6
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif	
			;Valor do PIS.
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;COFINS.
			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 5
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			;Valor da COFINS.
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da conta analitica contabil debitada/creditada.
			vStringAux  = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "D510"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("D510")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		
		discard "FIS_NFITEMSVC"
		if ($status = 0)
			$status = -1
		endif
	endwhile
	
	return(0)

End ;operation gerarEFDBlocoDRegD510.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.061/875] - 29/09/2010          ;
partner operation gerarEFDBlocoDRegD590          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux, vCdCst
		numeric vVlBaseCalc, vVlIcmsSubst, vTotalBaseST, vTotalImpostoST
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D590", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	clear/e "TMP_K03NR2VL1SVC"

	;ICMS.
	clear/e "V_FIS_APURACASVC"
	cd_empfat.v_fis_apuracasvc/init        = cd_empfat.fis_nfsvc
	nr_fatura.v_fis_apuracasvc/init        = nr_fatura.fis_nfsvc
	dt_fatura.v_fis_apuracasvc/init        = dt_fatura.fis_nfsvc
	nr_nf.v_fis_apuracasvc/init            = nr_nf.fis_nfsvc
	cd_serie.v_fis_apuracasvc/init         = cd_serie.fis_nfsvc
	dt_emissao.v_fis_apuracasvc/init       = dt_emissao.fis_nfsvc
	dt_saidaentrada.v_fis_apuracasvc/init  = dt_saidaentrada.fis_nfsvc
	tp_operacao.v_fis_apuracasvc/init      = tp_operacao.fis_nfsvc
	tp_origememissao.v_fis_apuracasvc/init = tp_origememissao.fis_nfsvc
	cd_imposto.v_fis_apuracasvc/init       = 1
	tp_situacao.v_fis_apuracasvc/init      = "E" 
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", 1
		while ($status >= 0)
			
			creocc "TMP_K03NR2VL1SVC", -1
			nr_k01.tmp_k03nr2vl1svc = cd_cst.v_fis_apuracasvc
			nr_k02.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
			vl_k03.tmp_k03nr2vl1svc = pr_aliquota.v_fis_apuracasvc
			retrieve/o "TMP_K03NR2VL1SVC"
			if ($status = 4)
				retrieve/x "TMP_K03NR2VL1SVC"
			endif
			vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_totalliquido.v_fis_apuracasvc
			vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.v_fis_apuracasvc
			vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.v_fis_apuracasvc
			
			if (cd_imposto.v_fis_apuracasvc = 1)
				if (cd_cst.v_fis_apuracasvc = "020") | (cd_cst.v_fis_apuracasvc = "070")
					if (vl_isento.v_fis_apuracasvc > 0)
						vl_outroicms.tmp_k03nr2vl1svc = vl_outroicms.tmp_k03nr2vl1svc + vl_isento.v_fis_apuracasvc
					else
						vl_outroicms.tmp_k03nr2vl1svc = vl_outroicms.tmp_k03nr2vl1svc + vl_outro.v_fis_apuracasvc
					endif
				endif
			endif

			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
		
		if ($next(nr_nf.fis_nfsvc)            != nr_nf.fis_nfsvc)     | %\
			($next(cd_pessoa.fis_nfsvc)       != cd_pessoa.fis_nfsvc) | %\
			($next(dt_saidaentrada.fis_nfsvc) != dt_saidaentrada.fis_nfsvc)
		
			vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_despacessor.fis_nfsvc + vl_frete.fis_nfsvc + vl_seguro.fis_nfsvc
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 1 ;ICMS.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status >= 0)
				setocc "FIS_NFIMPOSTOSVC", 1
				while ($status >= 0)
					vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.fis_nfimpostosvc
					vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.fis_nfimpostosvc		
					setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
				endwhile
			endif
		endif
	endif

	clear/e "V_FIS_APURACASVC"

	if ($empty("TMP_K03NR2VL1SVC"))
		return(0)
	endif

	;-- MAD [Proj/Tar.170/494] - 24/07/2012
	;Soma o total de subst. tributária da NF
	vTotalBaseST    = 0
	vTotalImpostoST = 0

	clear/e "V_FIS_APURACASVC"
	CD_EMPFAT.V_FIS_APURACASVC/init        = CD_EMPFAT.FIS_NFSVC
	NR_FATURA.V_FIS_APURACASVC/init        = NR_FATURA.FIS_NFSVC
	DT_FATURA.V_FIS_APURACASVC/init        = DT_FATURA.FIS_NFSVC
	NR_NF.V_FIS_APURACASVC/init            = NR_NF.FIS_NFSVC
	DT_EMISSAO.V_FIS_APURACASVC/init       = DT_EMISSAO.FIS_NFSVC
	DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = DT_SAIDAENTRADA.FIS_NFSVC
	TP_OPERACAO.V_FIS_APURACASVC/init      = TP_OPERACAO.FIS_NFSVC
	TP_ORIGEMEMISSAO.V_FIS_APURACASVC/init = TP_ORIGEMEMISSAO.FIS_NFSVC
	CD_IMPOSTO.V_FIS_APURACASVC/init       = 2
	TP_SITUACAO.V_FIS_APURACASVc/init      = "E"  
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC",1
		while ($status >= 0)
			vTotalBaseST    = vTotalBaseST    + VL_BASECALC.V_FIS_APURACASVC
			vTotalImpostoST = vTotalImpostoST + VL_IMPOSTO.V_FIS_APURACASVC
			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
	endif
	;;

	setocc "TMP_K03NR2VL1SVC", 1
	while ($status >= 0)
	
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|D590"
		;Codigo da situacao tributaria.
		call convNumeric(nr_k01.tmp_k03nr2vl1svc, 3, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		vCdCst = vStringConv
		;Codigo fiscal de operacao e prestacao.
		call convNumeric(nr_k02.tmp_k03nr2vl1svc, 4, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Aliquota do ICMS.
		if (vl_k03.tmp_k03nr2vl1svc > 0)
			$vlAux$ = vl_k03.tmp_k03nr2vl1svc
			vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
		else
			vStringAux = "00,00"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		endif
		;Parcela correspondente ao valor contabil referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_contabil.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_baseicms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_icms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	
		;Sustituicao tributaria.
		;-- MAD [Proj/Tar.170/494] - 24/07/2012
		;vVlBaseCalc = 0
		;vVlIcms 	= 0
		;vVlOutro	= 0
		;clear/e "V_FIS_APURACASVC"
		;CD_EMPFAT.v_fis_apuracasvc/init       = CD_EMPFAT.fis_nfsvc
		;nr_fatura.v_fis_apuracasvc/init        = nr_fatura.fis_nfsvc
		;dt_fatura.v_fis_apuracasvc/init        = dt_fatura.fis_nfsvc
		;cd_empfat.v_fis_apuracasvc/init        = cd_empfat.fis_nfsvc
		;nr_nf.v_fis_apuracasvc/init            = nr_nf.fis_nfsvc
		;cd_serie.v_fis_apuracasvc/init         = cd_serie.fis_nfsvc
		;dt_emissao.v_fis_apuracasvc/init       = dt_emissao.fis_nfsvc
		;dt_saidaentrada.v_fis_apuracasvc/init  = dt_saidaentrada.fis_nfsvc
		;tp_operacao.v_fis_apuracasvc/init      = tp_operacao.fis_nfsvc
		;tp_origememissao.v_fis_apuracasvc/init = tp_origememissao.fis_nfsvc
		;cd_imposto.v_fis_apuracasvc/init       = 2
		;tp_situacao.v_fis_apuracasvc/init      = "E"  
		;retrieve/e "V_FIS_APURACASVC"
		;if ($status >= 0)	
		;	while ($status >= 0)
		;		vVlOutro		= vVlOutro + vl_outro.v_fis_apuracasvc
		;		vVlBaseCalc 	= vVlBaseCalc + vl_basecalc.v_fis_apuracasvc
		;		vVlIcmsSubst 	= vVlIcmsSubst + vl_imposto.v_fis_apuracasvc
		;		setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		;	endwhile
		;endif

		vVlBaseCalc  = 0
		vVlIcmsSubst = 0
		if ($next(NR_K01.TMP_K03NR2VL1SVC) = "")
			vVlBaseCalc  = vTotalBaseST
			vVlIcmsSubst = vTotalImpostoST
		else
			clear/e "V_FIS_APURACASVC"
			CD_EMPFAT.V_FIS_APURACASVC/init        = CD_EMPFAT.FIS_NFSVC
			NR_FATURA.V_FIS_APURACASVC/init        = NR_FATURA.FIS_NFSVC
			DT_FATURA.V_FIS_APURACASVC/init        = DT_FATURA.FIS_NFSVC
			NR_NF.V_FIS_APURACASVC/init            = NR_NF.FIS_NFSVC
			DT_EMISSAO.V_FIS_APURACASVC/init       = DT_EMISSAO.FIS_NFSVC
			DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = DT_SAIDAENTRADA.FIS_NFSVC
			TP_OPERACAO.V_FIS_APURACASVC/init      = TP_OPERACAO.FIS_NFSVC
			TP_ORIGEMEMISSAO.V_FIS_APURACASVC/init = TP_ORIGEMEMISSAO.FIS_NFSVC
			CD_IMPOSTO.V_FIS_APURACASVC/init       = 2
			TP_SITUACAO.V_FIS_APURACASVc/init      = "E"
			CD_CST.V_FIS_APURACASVC/init           = vCdCst
			CD_CFOP.V_FIS_APURACASVC/init          = NR_K02.TMP_K03NR2VL1SVC
			PR_ALIQUOTA.V_FIS_APURACASVC/init      = VL_K03.TMP_K03NR2VL1SVC
			retrieve/e "V_FIS_APURACASVC"
			if ($status >= 0)
				setocc "V_FIS_APURACASVC",1
				while ($status >= 0)
					vVlBaseCalc  = vVlBaseCalc  + VL_BASECALC.V_FIS_APURACASVC
					vVlIcmsSubst = vVlIcmsSubst + VL_IMPOSTO.V_FIS_APURACASVC
					setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
				endwhile
			endif
			vTotalBaseST    = vTotalBaseST    - vVlBaseCalc
			vTotalImpostoST = vTotalImpostoST - vVlIcmsSubst
		endif
		;;
		;Valor da base de calculo da substituicao tributaria referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vVlBaseCalc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor do ICMS da substituicao tributaria referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vVlIcmsSubst[round,2]
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor nao tributado em funcao da reducao da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_outroicms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Codigo da observacao do lancamento fiscal.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"

		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "D590"
		ds_registro.sis_arquivosvc = vDsConteudo
	
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("D590")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
	endwhile

	clear/e "TMP_K03NR2VL1SVC"

	return(0)

End ;operation gerarEFDBlocoDRegD590.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.061/875] - 29/09/2010          ;
partner operation gerarEFDBlocoDRegD600          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, viParams, voParams, vNumericAux, vGlbMunIBGE, vPesEndereco
		numeric vCdEstado
		date    vDtAux
	endvariables
	
	clear/e "FIS_NFSVC"
	cd_empfat.fis_nfsvc/init        = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init       = $item("DT_PERIODO", $parametro$)
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init  = $item("DT_PERIODO", $parametro$)
	endif
	;------//------//------
	tp_situacao.fis_nfsvc/init      = "E·;C"
	tp_operacao.fis_nfsvc/init      = "S"
	tp_moddctofiscal.fis_nfsvc/init = "21·;22"
	retrieve/e "FIS_NFSVC"
	if ($status < 0)
		return(0)
	endif

	setocc "FIS_NFSVC",-1
	setocc "FIS_NFSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D600 / %%nr_fatura.fis_nfsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|D600"
		;Codigo do modelo do documento fiscal.
		vNumericAux = tp_moddctofiscal.fis_nfsvc
		call convNumeric(vNumericAux, 2, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		
		vPesEndereco = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_PESSOA", $item("CD_PESSOA", $parametro$)
		activate "FISSVCO032".carregaEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vPesEndereco = voParams
		endif

		vGlbMunIBGE = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_ESTADO"   , $item("CD_ESTADO"   ,vPesEndereco)
		putitem/id viParams, "CD_MUNICIPIO", $item("CD_MUNICIPIO",vPesEndereco)
		activate "FISSVCO032".carregaMunIBGE($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vGlbMunIBGE = voParams
		endif
		;Código do município dos terminais faturados, conforme a tabela IBGE
		vCdEstado = ""
		vCdEstado = $item("DS_ESTADO", vPesEndereco)
		call convNumeric($item("CD_MUNICIPIOIBGE",vGlbMunIBGE), 5, vStringConv)    
		vStringConv = "%%vCdEstado%%vStringConv"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

		;Serie do documento fiscal.
		vStringAux = "|%%cd_serie.fis_nfsvc"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Subserie do documento fiscal.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Código de classe de consumo dos serviços de comunicação ou telecomunicação
		vStringAux = "|99"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Quantidade de documentos consolidados neste registro
		vStringAux = "|1"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Data dos documentos consolidados
		vDtAux = dt_emissao.fis_nfsvc
		vStringAux = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Valor total acumulado dos documentos fiscais
		vNumericAux = vl_totalnota.fis_nfsvc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado dos descontos
		vNumericAux = vl_desconto.fis_nfsvc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado das prestações de serviços tributados pelo ICMS
		vNumericAux = vl_totalnota.fis_nfsvc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado dos serviços não-tributados pelo ICMS
		vNumericAux = 0
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valores cobrados em nome de terceiros
		vNumericAux = 0
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado das despesas acessórias
		vNumericAux = 0
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado da base de cálculo do ICMS
		vNumericAux = vl_baseicms.fis_nfsvc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor acumulado do ICMS
		vNumericAux = vl_icms.fis_nfsvc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

		clear/e "FIS_NFIMPOSTOSVC"
		cd_empfat.fis_nfimpostosvc/init  = cd_empfat.fis_nfsvc
		nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
		dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
		cd_imposto.fis_nfimpostosvc/init = 6 ;PIS.
		retrieve/e "FIS_NFIMPOSTOSVC"
		if ($status < 0)
			clear/e "FIS_NFIMPOSTOSVC"
		endif
		;Valor do PIS.
		vNumericAux = vl_imposto.fis_nfimpostosvc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		
		clear/e "FIS_NFIMPOSTOSVC"
		cd_empfat.fis_nfimpostosvc/init  = cd_empfat.fis_nfsvc
		nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
		dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
		cd_imposto.fis_nfimpostosvc/init = 5 ;COFINS.
		retrieve/e "FIS_NFIMPOSTOSVC"
		if ($status < 0)
			clear/e "FIS_NFIMPOSTOSVC"
		endif
		;Valor do COFINS.
		vNumericAux = vl_imposto.fis_nfimpostosvc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"
			
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "D600"
		ds_registro.sis_arquivosvc = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("D600")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
			
		clear/e "FIS_NFITEMSVC"
		cd_empfat.fis_nfitemsvc/init = cd_empfat.fis_nfsvc
		dt_fatura.fis_nfitemsvc/init = dt_fatura.fis_nfsvc
		nr_fatura.fis_nfitemsvc/init = nr_fatura.fis_nfsvc
		retrieve/e "FIS_NFITEMSVC"

		;Itens da nota fiscal de servico de comunicação e telecomunicação
		$instancehandle->gerarEFDBlocoDRegD610($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
		
		;Registro analitico dos documentos.
		$instancehandle->gerarEFDBlocoDRegD690($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		discard "FIS_NFSVC"
		if ($status = 0)
			$status = -1
		endif
	endwhile
	clear/e "FIS_NFSVC"
	
	return(0)

End ;operation gerarEFDBlocoDRegD600.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.061/875] - 29/09/2010          ;
partner operation gerarEFDBlocoDRegD610          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, viParams, voParams, vStrAux, vNumericAux
		numeric vVlBaseIcms, vVlIcms, vTotDig
		string  vFisCfop, vFisTipi, vGlbLogradouro, vPesCliente
	endvariables
	
	if ($empty("FIS_NFITEMSVC"))
		return(0)
	endif
	
	setocc "FIS_NFITEMSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D610 / %%cd_produto.fis_nfitemsvc", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		if (cd_produto.fis_nfitemsvc != "") & (cd_cfop.fis_nfitemsvc != "")
			setocc "FIS_NFITEMPROSVC", 1
			vDsConteudo = ""
			;Texto fixo.
			vDsConteudo = "|D610"
			;Codigo de classificacao do item.
			vStringAux = "|0599"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Codigo do item.
			;vTotDig = $length(cd_produto.fis_nfitemprosvc)
;			call convString("CD_PRODUTO", cd_produto.fis_nfitemprosvc, vTotDig, vStringConv)

; -> rodrigo - PRJ 170 TAR 231 - 31/03/2011
			;vTotDig = 14
;			call convNumeric(cd_produto.fis_nfitemprosvc, vTotDig, vStringConv)
			vStringConv = cd_produto.fis_nfitemprosvc
; <- rodrigo - PRJ 170 TAR 231 - 31/03/2011

			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		
			creocc "F_TMP_DS40SVC", -1
			if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
			else
				DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
			endif
			if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
				clear/e "PRD_PRDCONVMESVC"
				CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "PRD_PRDCONVMESVC"
				if ($status >= 0)
					$instancehandle->totalizarQtdTipoRegistro("0220")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			retrieve/o "F_TMP_DS40SVC"
			if ($status = 4)
				retrieve/x "F_TMP_DS40SVC"
				vCdEspecie = ds_especie.F_TMP_DS40SVC
			else
				ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
				ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
				vCdEspecie = cd_especie.fis_nfitemsvc
				if (cd_tipi.fis_nfitemsvc = "")
					if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemsvc
					else
						clear/e "PRD_PRODUTOSVC"
						cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
						retrieve/e "PRD_PRODUTOSVC"
						if ($status >= 0)
							if (CD_ESPECIE.FIS_NFITEMSVC = "")
								ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
								vCdEspecie = cd_especie.prd_produtosvc
							endif
							if (cd_tipi.prd_produtosvc != "")
								vFisTipi = ""
								viParams = ""
								voParams = ""
								putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
								activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
								if ($procerror)
									$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									return(-1)
								endif
								if (voParams != "")
									vFisTipi = voParams
									vStrAux = $item("CD_TIPI",vFisTipi)
									vStrAux = $replace(vStrAux, 1, ".","",-1)		
									cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
								endif
							endif
						endif
					endif
				else
					cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
					cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
				endif
			
				creocc "TMP_NRDSSVC", -1
				nr_geral.tmp_nrdssvc = 1
				ds_geral.tmp_nrdssvc = vCdEspecie
				retrieve/o "TMP_NRDSSVC"
				if ($status = 4)
					retrieve/x "TMP_NRDSSVC"
				endif
			endif

			;-- MAD [Proj/Tar.170/263] - 27/05/2011
			if (DS_40.F_TMP_DS40SVC != "")
				clear/e "FIS_NFITEMUNSVC"
				CD_EMPRESA.FIS_NFITEMUNSVC/init = CD_EMPRESA.FIS_NFITEMSVC
				NR_FATURA.FIS_NFITEMUNSVC/init  = NR_FATURA.FIS_NFITEMSVC
				DT_FATURA.FIS_NFITEMUNSVC/init  = DT_FATURA.FIS_NFITEMSVC
				NR_ITEM.FIS_NFITEMUNSVC/init    = NR_ITEM.FIS_NFITEMSVC
				CD_PRODUTO.FIS_NFITEMUNSVC/init = DS_40.F_TMP_DS40SVC
				retrieve/e "FIS_NFITEMUNSVC"
				if ($status >= 0) & (CD_ESPECIE.FIS_NFITEMUNSVC != vCdEspecie)
					vCdEspecie = CD_ESPECIE.FIS_NFITEMUNSVC
	
					clear/e "GTT_DS01SVC"
					creocc "GTT_DS01SVC", -1
					NR_GERAL.GTT_DS01SVC = DS_40.F_TMP_DS40SVC
					DS_GERAL.GTT_DS01SVC = vCdEspecie
					retrieve/o "GTT_DS01SVC"
					if ($status = -7)
						retrieve/x "GTT_DS01SVC"
					endif
					QT_CONVERSAO.GTT_DS01SVC = QT_CONVERSAO.FIS_NFITEMUNSVC
					$collhandle("GTT_DS01SVC")->Salvar()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif

					creocc "TMP_NRDSSVC", -1
					nr_geral.tmp_nrdssvc = 1
					ds_geral.tmp_nrdssvc = vCdEspecie
					retrieve/o "TMP_NRDSSVC"
					if ($status = 4)
						retrieve/x "TMP_NRDSSVC"
					endif

					creocc "TMP_DS40SVC", -1
					DS_40.TMP_DS40SVC = "0220"
					retrieve/o "TMP_DS40SVC"
					if ($status = -7)
						retrieve/x "TMP_DS40SVC"
					endif
				endif
			endif
			;;

			creocc "TMP_NR08SVC", -1
			nr_08.tmp_nr08svc = cd_cfop.fis_nfitemsvc
			retrieve/o "TMP_NR08SVC"
			if ($status = 4)
				retrieve/x "TMP_NR08SVC"
			else
				vFisCfop = ""
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_CFOP", cd_cfop.fis_nfitemsvc
				activate "FISSVCO032".carregaFisCfop($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				if (voParams != "")
					vFisCfop = voParams
					ds_cfop.tmp_nr08svc = $item("DS_CFOP",vFisCfop)
				endif
			endif
			
			;Quantidade do item.
			vNumericAux = qt_faturado.fis_nfitemsvc
			call editarNr(11, 3, vNumericAux, vNumericAux)
			call convValorString(3,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Unidade do item.
			vStringAux = "|%%vCdEspecie"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Valor do item.
			vNumericAux = vl_totalliquido.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do desconto.
			vNumericAux = vl_totaldesc.fis_nfitemsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da situacao tributaria.
			call convNumeric(cd_cst.fis_nfitemsvc, 3, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo fiscal de operacao e prestacao.
			call convNumeric(cd_cfop.fis_nfitemsvc, 4, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;ICMS.
			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 1
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			;Aliquota do ICMS.
			if (pr_aliquota.fis_nfitemimpsvc > 0)
				$vlAux$ = pr_aliquota.fis_nfitemimpsvc
				vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
			else
				vStringAux = "|"
				vDsConteudo = "%%vDsConteudo%%vStringAux"
			endif
			;Valor da base de calculo do ICMS.
			vNumericAux = vl_basecalc.fis_nfitemimpsvc + vVlBaseIcms
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do ICMS.
			vNumericAux = vl_imposto.fis_nfitemimpsvc + vVlIcms
			vNumericAux = vNumericAux[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			vVlBaseIcms = ""
			vVlIcms     = ""
			
			;Sustituicao tributaria.
			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 2
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			
			;Valor da base de calculo referente a substituicao tributaria.
			vNumericAux = vl_basecalc.fis_nfitemimpsvc
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do ICMS referente a substituicao tributaria.
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round, 2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor não tributado em função da redução B.C. do ICMS referente à combinação de CST, CFOP e alíquota do ICMS.
			vNumericAux = 0
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

			;PIS.
			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 6
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif	
			;Valor do PIS.
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			
			;COFINS.
			clear/e "FIS_NFITEMIMPSVC"
			cd_empfat.fis_nfitemimpsvc/init  = cd_empfat.fis_nfitemsvc
			nr_fatura.fis_nfitemimpsvc/init  = nr_fatura.fis_nfitemsvc
			dt_fatura.fis_nfitemimpsvc/init  = dt_fatura.fis_nfitemsvc
			nr_item.fis_nfitemimpsvc/init    = nr_item.fis_nfitemsvc
			cd_imposto.fis_nfitemimpsvc/init = 5
			retrieve/e "FIS_NFITEMIMPSVC"
			if ($status < 0)
				clear/e "FIS_NFITEMIMPSVC"
			endif
			;Valor da COFINS.
			vNumericAux = vl_imposto.fis_nfitemimpsvc[round,2]
			call editarNr(12, 2, vNumericAux, vNumericAux)
			call convValorString(2,vNumericAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Codigo da conta analitica contabil debitada/creditada.
			vStringAux  = "|"
			vDsConteudo = "%%vDsConteudo%%vStringAux"
			;Marcador.
			vDsConteudo = "%%vDsConteudo%%%|%%^"
			
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "D610"
			ds_registro.sis_arquivosvc = vDsConteudo
			
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
			
			$instancehandle->totalizarQtdTipoRegistro("D610")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		
		discard "FIS_NFITEMSVC"
		if ($status = 0)
			$status = -1
		endif
	endwhile
	
	return(0)

End ;operation gerarEFDBlocoDRegD610.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.061/875] - 29/09/2010          ;
partner operation gerarEFDBlocoDRegD690          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams

	variables
		string  vDsConteudo, vStringConv, vStringAux, vNumericAux, vCdCst
		numeric vVlBaseCalc, vVlIcmsSubst, vTotalBaseST, vTotalImpostoST
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco D - registro D690", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	clear/e "TMP_K03NR2VL1SVC"

	;ICMS.
	clear/e "V_FIS_APURACASVC"
	cd_empfat.v_fis_apuracasvc/init        = cd_empfat.fis_nfsvc
	nr_fatura.v_fis_apuracasvc/init        = nr_fatura.fis_nfsvc
	dt_fatura.v_fis_apuracasvc/init        = dt_fatura.fis_nfsvc
	nr_nf.v_fis_apuracasvc/init            = nr_nf.fis_nfsvc
	cd_serie.v_fis_apuracasvc/init         = cd_serie.fis_nfsvc
	dt_emissao.v_fis_apuracasvc/init       = dt_emissao.fis_nfsvc
	dt_saidaentrada.v_fis_apuracasvc/init  = dt_saidaentrada.fis_nfsvc
	tp_operacao.v_fis_apuracasvc/init      = tp_operacao.fis_nfsvc
	tp_origememissao.v_fis_apuracasvc/init = tp_origememissao.fis_nfsvc
	cd_imposto.v_fis_apuracasvc/init       = 1
	tp_situacao.v_fis_apuracasvc/init      = "E"  
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC", 1
		while ($status >= 0)
			
			creocc "TMP_K03NR2VL1SVC", -1
			nr_k01.tmp_k03nr2vl1svc = cd_cst.v_fis_apuracasvc
			nr_k02.tmp_k03nr2vl1svc = cd_cfop.v_fis_apuracasvc
			vl_k03.tmp_k03nr2vl1svc = pr_aliquota.v_fis_apuracasvc
			retrieve/o "TMP_K03NR2VL1SVC"
			if ($status = 4)
				retrieve/x "TMP_K03NR2VL1SVC"
			endif
			vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_totalliquido.v_fis_apuracasvc
			vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.v_fis_apuracasvc
			vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.v_fis_apuracasvc
			
			if (cd_imposto.v_fis_apuracasvc = 1)
				if (cd_cst.v_fis_apuracasvc = "020") | (cd_cst.v_fis_apuracasvc = "070")
					if (vl_isento.v_fis_apuracasvc > 0)
						vl_outroicms.tmp_k03nr2vl1svc = vl_outroicms.tmp_k03nr2vl1svc + vl_isento.v_fis_apuracasvc
					else
						vl_outroicms.tmp_k03nr2vl1svc = vl_outroicms.tmp_k03nr2vl1svc + vl_outro.v_fis_apuracasvc
					endif
				endif
			endif

			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
		
		if ($next(nr_nf.fis_nfsvc)            != nr_nf.fis_nfsvc)     | %\
			($next(cd_pessoa.fis_nfsvc)       != cd_pessoa.fis_nfsvc) | %\
			($next(dt_saidaentrada.fis_nfsvc) != dt_saidaentrada.fis_nfsvc)
		
			vl_contabil.tmp_k03nr2vl1svc = vl_contabil.tmp_k03nr2vl1svc + vl_despacessor.fis_nfsvc + vl_frete.fis_nfsvc + vl_seguro.fis_nfsvc
			clear/e "FIS_NFIMPOSTOSVC"
			CD_EMPFAT.fis_nfimpostosvc/init = CD_EMPFAT.fis_nfsvc
			nr_fatura.fis_nfimpostosvc/init  = nr_fatura.fis_nfsvc
			dt_fatura.fis_nfimpostosvc/init  = dt_fatura.fis_nfsvc
			cd_imposto.fis_nfimpostosvc/init = 1 ;ICMS.
			retrieve/e "FIS_NFIMPOSTOSVC"
			if ($status >= 0)
				setocc "FIS_NFIMPOSTOSVC", 1
				while ($status >= 0)
					vl_baseicms.tmp_k03nr2vl1svc = vl_baseicms.tmp_k03nr2vl1svc + vl_basecalc.fis_nfimpostosvc
					vl_icms.tmp_k03nr2vl1svc     = vl_icms.tmp_k03nr2vl1svc     + vl_imposto.fis_nfimpostosvc		
					setocc "FIS_NFIMPOSTOSVC", $curocc(FIS_NFIMPOSTOSVC) + 1
				endwhile
			endif
		endif
	endif

	clear/e "V_FIS_APURACASVC"

	if ($empty("TMP_K03NR2VL1SVC"))
		return(0)
	endif

	;-- MAD [Proj/Tar.170/494] - 24/07/2012
	;Soma o total de subst. tributária da NF
	vTotalBaseST    = 0
	vTotalImpostoST = 0

	clear/e "V_FIS_APURACASVC"
	CD_EMPFAT.V_FIS_APURACASVC/init        = CD_EMPFAT.FIS_NFSVC
	NR_FATURA.V_FIS_APURACASVC/init        = NR_FATURA.FIS_NFSVC
	DT_FATURA.V_FIS_APURACASVC/init        = DT_FATURA.FIS_NFSVC
	NR_NF.V_FIS_APURACASVC/init            = NR_NF.FIS_NFSVC
	DT_EMISSAO.V_FIS_APURACASVC/init       = DT_EMISSAO.FIS_NFSVC
	DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = DT_SAIDAENTRADA.FIS_NFSVC
	TP_OPERACAO.V_FIS_APURACASVC/init      = TP_OPERACAO.FIS_NFSVC
	TP_ORIGEMEMISSAO.V_FIS_APURACASVC/init = TP_ORIGEMEMISSAO.FIS_NFSVC
	CD_IMPOSTO.V_FIS_APURACASVC/init       = 2
	TP_SITUACAO.V_FIS_APURACASVc/init      = "E"  
	retrieve/e "V_FIS_APURACASVC"
	if ($status >= 0)
		setocc "V_FIS_APURACASVC",1
		while ($status >= 0)
			vTotalBaseST    = vTotalBaseST    + VL_BASECALC.V_FIS_APURACASVC
			vTotalImpostoST = vTotalImpostoST + VL_IMPOSTO.V_FIS_APURACASVC
			setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		endwhile
	endif
	;;

	setocc "TMP_K03NR2VL1SVC", 1
	while ($status >= 0)
	
		vDsConteudo = ""
		;Texto fixo.
		vDsConteudo = "|D690"
		;Codigo da situacao tributaria.
		call convNumeric(nr_k01.tmp_k03nr2vl1svc, 3, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		vCdCst = vStringConv
		;Codigo fiscal de operacao e prestacao.
		call convNumeric(nr_k02.tmp_k03nr2vl1svc, 4, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Aliquota do ICMS.
		if (vl_k03.tmp_k03nr2vl1svc > 0)
			$vlAux$ = vl_k03.tmp_k03nr2vl1svc
			vDsConteudo = "%%vDsConteudo%%%|%%$vlAux$"
		else
			vStringAux = "00,00"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		endif
		;Parcela correspondente ao valor contabil referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_contabil.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_baseicms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Parcela correspondente ao valor do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_icms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
	
		;Sustituicao tributaria.
		;-- MAD [Proj/Tar.170/494] - 24/07/2012
		;vVlBaseCalc = 0
		;vVlIcms 	= 0
		;vVlOutro	= 0
		;clear/e "V_FIS_APURACASVC"
		;CD_EMPFAT.v_fis_apuracasvc/init       = CD_EMPFAT.fis_nfsvc
		;nr_fatura.v_fis_apuracasvc/init        = nr_fatura.fis_nfsvc
		;dt_fatura.v_fis_apuracasvc/init        = dt_fatura.fis_nfsvc
		;cd_empfat.v_fis_apuracasvc/init        = cd_empfat.fis_nfsvc
		;nr_nf.v_fis_apuracasvc/init            = nr_nf.fis_nfsvc
		;cd_serie.v_fis_apuracasvc/init         = cd_serie.fis_nfsvc
		;dt_emissao.v_fis_apuracasvc/init       = dt_emissao.fis_nfsvc
		;dt_saidaentrada.v_fis_apuracasvc/init  = dt_saidaentrada.fis_nfsvc
		;tp_operacao.v_fis_apuracasvc/init      = tp_operacao.fis_nfsvc
		;tp_origememissao.v_fis_apuracasvc/init = tp_origememissao.fis_nfsvc
		;cd_imposto.v_fis_apuracasvc/init       = 2
		;tp_situacao.v_fis_apuracasvc/init      = "E"  
		;retrieve/e "V_FIS_APURACASVC"
		;if ($status >= 0)	
		;	while ($status >= 0)
		;		vVlOutro		= vVlOutro + vl_outro.v_fis_apuracasvc
		;		vVlBaseCalc 	= vVlBaseCalc + vl_basecalc.v_fis_apuracasvc
		;		vVlIcmsSubst 	= vVlIcmsSubst + vl_imposto.v_fis_apuracasvc
		;		setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
		;	endwhile
		;endif

		vVlBaseCalc  = 0
		vVlIcmsSubst = 0
		if ($next(NR_K01.TMP_K03NR2VL1SVC) = "")
			vVlBaseCalc  = vTotalBaseST
			vVlIcmsSubst = vTotalImpostoST
		else
			clear/e "V_FIS_APURACASVC"
			CD_EMPFAT.V_FIS_APURACASVC/init        = CD_EMPFAT.FIS_NFSVC
			NR_FATURA.V_FIS_APURACASVC/init        = NR_FATURA.FIS_NFSVC
			DT_FATURA.V_FIS_APURACASVC/init        = DT_FATURA.FIS_NFSVC
			NR_NF.V_FIS_APURACASVC/init            = NR_NF.FIS_NFSVC
			DT_EMISSAO.V_FIS_APURACASVC/init       = DT_EMISSAO.FIS_NFSVC
			DT_SAIDAENTRADA.V_FIS_APURACASVC/init  = DT_SAIDAENTRADA.FIS_NFSVC
			TP_OPERACAO.V_FIS_APURACASVC/init      = TP_OPERACAO.FIS_NFSVC
			TP_ORIGEMEMISSAO.V_FIS_APURACASVC/init = TP_ORIGEMEMISSAO.FIS_NFSVC
			CD_IMPOSTO.V_FIS_APURACASVC/init       = 2
			TP_SITUACAO.V_FIS_APURACASVc/init      = "E"
			CD_CST.V_FIS_APURACASVC/init           = vCdCst
			CD_CFOP.V_FIS_APURACASVC/init          = NR_K02.TMP_K03NR2VL1SVC
			PR_ALIQUOTA.V_FIS_APURACASVC/init      = VL_K03.TMP_K03NR2VL1SVC
			retrieve/e "V_FIS_APURACASVC"
			if ($status >= 0)
				setocc "V_FIS_APURACASVC",1
				while ($status >= 0)
					vVlBaseCalc  = vVlBaseCalc  + VL_BASECALC.V_FIS_APURACASVC
					vVlIcmsSubst = vVlIcmsSubst + VL_IMPOSTO.V_FIS_APURACASVC
					setocc "V_FIS_APURACASVC", $curocc(V_FIS_APURACASVC) + 1
				endwhile
			endif
			vTotalBaseST    = vTotalBaseST    - vVlBaseCalc
			vTotalImpostoST = vTotalImpostoST - vVlIcmsSubst
		endif
		;;
		;Valor da base de calculo da substituicao tributaria referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vVlBaseCalc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor do ICMS da substituicao tributaria referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vVlIcmsSubst[round,2]
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor nao tributado em funcao da reducao da base de calculo do ICMS referente a combinacao CFOP, CST e aliquota de ICMS.
		vNumericAux = vl_outroicms.tmp_k03nr2vl1svc
		call editarNr(12, 2, vNumericAux, vNumericAux)
		call convValorString(2,vNumericAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Codigo da observacao do lancamento fiscal.
		vStringAux = "|"
		vDsConteudo = "%%vDsConteudo%%vStringAux"
		;Marcador.
		vDsConteudo = "%%vDsConteudo%%%|%%^"

		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "D690"
		ds_registro.sis_arquivosvc = vDsConteudo
	
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("D690")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		setocc "TMP_K03NR2VL1SVC", $curocc(TMP_K03NR2VL1SVC) + 1
	endwhile

	clear/e "TMP_K03NR2VL1SVC"

	return(0)

End ;operation gerarEFDBlocoDRegD690.
;;

;;------------------------------------------------;
;;-- MAD [Proj/Tar.170/074] - 15/10/2010          ;
;partner operation gerarEFDBloco0Reg0300          ;
;;------------------------------------------------;
;	params
;		numeric poCdErro  :OUT
;		string  poCtxErro :OUT
;	endparams
;	
;	variables
;		string vDsConteudo, vStringAux
;	endvariables
;
;	clear/e "V_PAT_CIAPSVC"
;	CD_EMPRESA.V_PAT_CIAPSVC/init = $item("CD_EMPRESA", $parametro$)
;	retrieve/e "V_PAT_CIAPSVC"
;	if ($status >= 0)
;
;		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0300", "", "")
;		if ($procerror)
;			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			poCdErro  = $xCdErro$
;			poCtxErro = $xCtxErro$
;		endif
;
;		setocc "V_PAT_CIAPSVC",-1
;		setocc "V_PAT_CIAPSVC", 1
;		while ($status >= 0)
;
;			clear/e "PAT_IMOBFICHISVC"
;			CD_PRODUTO.PAT_IMOBFICHISVC/init = CD_PRODUTO.V_PAT_CIAPSVC
;			NR_SEQIMOB.PAT_IMOBFICHISVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
;			retrieve/e "PAT_IMOBFICHISVC"
;			if ($status >= 0)
;				setocc "PAT_IMOBFICHISVC",-1
;				setocc "PAT_IMOBFICHISVC", 1
;				while ($status >= 0)
;
;					vDsConteudo = ""
;					;Texto fixo
;					vDsConteudo = "|0300"
;					;Código individualizado do bem
;					vStringAux = ""
;					if (TP_ITEM.PAT_IMOBFICHISVC = 1)
;						vStringAux = "%%NR_CHAPA.V_PAT_CIAPSVC%%NR_SEQITEM.PAT_IMOBFICHISVC"
;					else
;						clear/e "PAT_IMOBILIZASVC"
;						CD_PRODUTO.PAT_IMOBILIZASVC/init   = CD_PRODCOMP.PAT_IMOBFICHISVC
;						NR_SEQUENCIA.PAT_IMOBILIZASVC/init = NR_SEQCOMP.PAT_IMOBFICHISVC
;						retrieve/e "PAT_IMOBILIZASVC"
;						if ($status >= 0)
;							vStringAux = "%%NR_CHAPA.PAT_IMOBILIZASVC"	
;						endif
;					endif
;					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;					;Identificação do tipo de mercadoria (1=bem | 2=componente)
;					vStringAux  = "2"
;					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;					;Descrição do bem 
;					call converterString(DS_IMOBILIZADO.V_PAT_CIAPSVC,vStringAux)
;					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;					;Código de cadastro do bem principal
;					vStringAux  = "%%NR_CHAPA.V_PAT_CIAPSVC"
;					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;					;Código da conta analítica de contabilização do bem
;					clear/e "CTB_PLANOSVC"
;					if (CD_CONTACTB.V_PAT_CIAPSVC != "")
;						CD_REDUZIDO.CTB_PLANOSVC/init = CD_CONTACTB.V_PAT_CIAPSVC
;						retrieve/e "CTB_PLANOSVC"
;					endif
;					vStringAux  = "%%CD_CONTA.CTB_PLANOSVC"
;					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;					;Número total de parcelas a serem apropriadas
;					vStringAux = "48"
;					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;					;Marcador.
;					vDsConteudo = "%%vDsConteudo%%%|%%^"
;
;					creocc "SIS_ARQUIVOSVC", -1
;					DS_REG.SIS_ARQUIVOSVC = "0300"
;					DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
;			
;					$nrLinhaBloco$   = $nrLinhaBloco$   + 1
;					$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
;					$nrRegistroArq$  = $nrRegistroArq$  + 1
;			
;					$instancehandle->totalizarQtdTipoRegistro("0300")
;					if ($procerror)
;						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;						poCdErro  = $xCdErro$
;						poCtxErro = $xCtxErro$
;						return(-1)
;					elseif ($status < 0)
;						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;						poCdErro  = $xCdErro$
;						poCtxErro = $xCtxErro$
;						return(-1)
;					endif
;					setocc "PAT_IMOBFICHISVC", $curocc("PAT_IMOBFICHISVC") + 1
;				endwhile
;
;			else
;				vDsConteudo = ""
;				;Texto fixo
;				vDsConteudo = "|0300"
;				;Código individualizado do bem
;				vStringAux  = "%%NR_CHAPA.V_PAT_CIAPSVC"
;				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;				;Identificação do tipo de mercadoria (1=bem | 2=componente)
;				vStringAux  = "1"
;				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;				;Descrição do bem 
;				call converterString(DS_IMOBILIZADO.V_PAT_CIAPSVC,vStringAux)
;				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;				;Código de cadastro do bem principal
;				vStringAux  = ""
;				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;				;Código da conta analítica de contabilização do bem
;				clear/e "CTB_PLANOSVC"
;				if (CD_CONTACTB.V_PAT_CIAPSVC != "")
;					CD_REDUZIDO.CTB_PLANOSVC/init = CD_CONTACTB.V_PAT_CIAPSVC
;					retrieve/e "CTB_PLANOSVC"
;				endif
;				vStringAux  = "%%CD_CONTA.CTB_PLANOSVC"
;				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;				;Número total de parcelas a serem apropriadas
;				vStringAux = "48"
;				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;				;Marcador.
;				vDsConteudo = "%%vDsConteudo%%%|%%^"
;
;				creocc "SIS_ARQUIVOSVC", -1
;				DS_REG.SIS_ARQUIVOSVC = "0300"
;				DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
;		
;				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
;				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
;				$nrRegistroArq$  = $nrRegistroArq$  + 1
;		
;				$instancehandle->totalizarQtdTipoRegistro("0300")
;				if ($procerror)
;					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;					poCdErro  = $xCdErro$
;					poCtxErro = $xCtxErro$
;					return(-1)
;				elseif ($status < 0)
;					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;					poCdErro  = $xCdErro$
;					poCtxErro = $xCtxErro$
;					return(-1)
;				endif
;
;				;Informação sobre a utilização do bem (Centro de Custo)
;				$instancehandle->gerarEFDBloco0Reg0305($xCdErro$,$xCtxErro$)
;				if ($procerror)
;					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;					poCdErro  = $xCdErro$
;					poCtxErro = $xCtxErro$
;					return(-1)
;				elseif ($status < 0)
;				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;					poCdErro  = $xCdErro$
;					poCtxErro = $xCtxErro$
;					return(-1)
;				endif
;			endif
;
;			discard "V_PAT_CIAPSVC"
;			if ($status = 0)
;				$status = -1
;			endif
;		endwhile
;	endif
;
;	return(0)
;
;End ; operation gerarEFDBloco0Reg0300.
;;;


;------------------------------------------------;
;; ICJ [PROJ/TAR 170/200] (03/03/2011)          ;
partner operation gerarEFDBloco0Reg0300          ;
;------------------------------------------------;
		params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringConv, vStringAux, vCdEspecie, vNumericAux
	endvariables
	
	clear/e "F2_TMP_DS60SVC"
	
	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|0300"
	
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0300"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("0300")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)
End ; operation gerarEFDBloco0Reg0300.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.170/074] - 15/10/2010          ;
;partner operation gerarEFDBloco0Reg0305          ;
;;------------------------------------------------;
;	params
;		numeric poCdErro  :OUT
;		string  poCtxErro :OUT
;	endparams
;	
;	variables
;		numeric vNumericAux, vCdCCustoPadraoFcp, vNaturezaComercialEmp
;		string  vDsConteudo, vStringAux, viParams, voParams
;	endvariables
;
;	clear/e "PAT_IMOBINFOSVC"
;
;	CD_PRODUTO.PAT_IMOBINFOSVC/init   = CD_PRODUTO.F2_TMP_DS60SVC
;	NR_SEQUENCIA.PAT_IMOBINFOSVC/init = NR_SEQUENCIA.F2_TMP_DS60SVC
;	retrieve/e "PAT_IMOBINFOSVC"
;	if ($status >= 0)
;
;		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0305", "", "")
;		if ($procerror)
;			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			poCdErro  = $xCdErro$
;			poCtxErro = $xCtxErro$
;		endif
;
;		setocc "PAT_IMOBINFOSVC",-1
;		sort/e "PAT_IMOBINFOSVC", "PR_PARTICIPACAO.PAT_IMOBINFOSVC desc"
;		setocc "PAT_IMOBINFOSVC",1
;
;		vDsConteudo = ""
;		;Texto fixo.
;		vDsConteudo = "|0305"
;		;Código do centro de custo
;		viParams = ""
;		putitem viParams, -1, "NATUREZA_COMERCIAL_EMP"
;		putitem viParams, -1, "CD_CCUSTOPADRAO_FCP"
;		activate "ADMSVCO001".GetParamEmpresa(CD_EMPRESA.PAT_IMOBINFOSVC, viParams, voParams, $xcderro$, $xctxerro$)
;		if ($procerror)
;			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			return(-1)
;		elseif ($status < 0)
;			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;			return(-1)
;		endif
;		vNaturezaComercialEmp = $item("NATUREZA_COMERCIAL_EMP",voParams)
;		vCdCCustoPadraoFcp    = $item("CD_CCUSTOPADRAO_FCP"   ,voParams)
;
;        	;---- WMC - 16/02/2011 - A PEDIDO DO RENAN
;;		if (CD_CCUSTO.PAT_IMOBINFOSVC != vCdCCustoPadraoFcp)
;		if (CD_CCUSTO.PAT_IMOBINFOSVC != 999)
;			vDsConteudo = "%%vDsConteudo%%%|%%CD_CCUSTO.PAT_IMOBINFOSVC"
;		else
;			if (TP_AREA.PAT_IMOBINFOSVC = 2)
;				vStringAux = "1"
;			elseif (TP_AREA.PAT_IMOBINFOSVC = 3)
;				vStringAux = "4"
;			elseif (TP_AREA.PAT_IMOBINFOSVC = 4)
;				vStringAux = "3"
;			elseif (TP_AREA.PAT_IMOBINFOSVC = 1) 
;				if (vNaturezaComercialEmp = 2 | vNaturezaComercialEmp = 3)
;					vStringAux = "2"
;				else
;					vStringAux = "5"
;				endif
;			endif
;			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;		endif
;
;		$inGeraReg0600$ = <TRUE>
;
;		;Descrição da função do bem
;		call converterString(DS_FUNCAO.PAT_IMOBINFOSVC,vStringAux)
;		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;		;Vida útil estimada do bem, em número de meses
;		vNumericAux = NR_VIDAUTIL.F2_TMP_DS60SVC * 12
;		call convNumeric(vNumericAux, 3, vStringAux)
;		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
;		;Marcador.
;		vDsConteudo = "%%vDsConteudo%%%|%%^"
;
;		creocc "SIS_ARQUIVOSVC", -1
;		DS_REG.SIS_ARQUIVOSVC = "0305"
;		DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
;		
;		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
;		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
;		$nrRegistroArq$  = $nrRegistroArq$  + 1
;		
;		$instancehandle->totalizarQtdTipoRegistro("0305")
;		if ($procerror)
;			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
;			poCdErro  = $xCdErro$
;			poCtxErro = $xCtxErro$
;			return(-1)
;		elseif ($status < 0)
;			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
;			poCdErro  = $xCdErro$
;			poCtxErro = $xCtxErro$
;			return(-1)
;		endif
;	endif
;
;	return(0)
;
;End ; operation gerarEFDBloco0Reg0305.
;;;

;------------------------------------------------;
;-- MAD [Proj/Tar.170/075] - 18/10/2010          ;
partner operation gerarEFDBloco0Reg0500          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams

	variables
		date   vDtAux
		string vDsConteudo, vStringAux, viParams, voParams
	endvariables

	clear/e "V_PAT_CIAPSVC"
	CD_EMPRESA.V_PAT_CIAPSVC/init = $item("CD_EMPRESA", $parametro$)
	retrieve/e "V_PAT_CIAPSVC"
	if ($status >= 0)

		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0500", "", "")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		setocc "V_PAT_CIAPSVC",-1
		sort/e "V_PAT_CIAPSVC", "CD_CONTACTB.V_PAT_CIAPSVC"
		setocc "V_PAT_CIAPSVC", 1
		while ($status >= 0)
			if (CD_CONTACTB.V_PAT_CIAPSVC != "") & (CD_CONTACTB.V_PAT_CIAPSVC != $next(CD_CONTACTB.V_PAT_CIAPSVC))
				clear/e "CTB_PLANOSVC"
				CD_REDUZIDO.CTB_PLANOSVC/init = CD_CONTACTB.V_PAT_CIAPSVC
				retrieve/e "CTB_PLANOSVC"
				if ($status >= 0)

					vDsConteudo = ""
					;Texto fixo.
					vDsConteudo = "|0500"
					;Data da inclusão/alteração
					vDtAux   = $item("DT_PERIODOINI", $parametro$)
					viParams = ""
					voParams = ""
					putitem/id viParams, "CD_ANOEXERCONTABIL", vDtAux[y]
					putitem/id viParams, "IN_NAOVALIDAR"     , <TRUE>

					activate "CTBSVCO001".GetLstParametro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif

					vDtAux = $item("DT_INFERIOR", voParams)

					;---- WMC - Proj 170 Tar 183 - 08/02/2011
					if (vDtAux = "")
						$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Data do parâmetro da contabilidade inválida", "ADICIONAL=Operação->FISSVCO039.gerarEFDBloco0Reg0500")
						poCdErro = $xCdErro$
						poCtxErro = $xCtxErro$
						return (-1)
					endif
					;------//------//------

					vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Código da natureza da conta
					if (CD_TPCONTA.CTB_PLANOSVC = "AT")
						vStringAux = "01"
					elseif (CD_TPCONTA.CTB_PLANOSVC = "PA")
						vStringAux = "02"
					elseif (CD_TPCONTA.CTB_PLANOSVC = "RE")
						vStringAux = "04"
					else
						vStringAux = "09"
					endif
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Indicador do tipo de conta
					vStringAux  = "%%TP_NATUREZACTA.CTB_PLANOSVC"
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Nível da conta
					vStringAux = "%%CD_NIVEL.CTB_PLANOSVC"
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Código da conta
					vStringAux = "%%CD_CONTA.CTB_PLANOSVC"
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Nome da conta
					call converterString(NM_CONTA.CTB_PLANOSVC,vStringAux)
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
					;Marcador.
					vDsConteudo = "%%vDsConteudo%%%|%%^"
	
					creocc "SIS_ARQUIVOSVC", -1
					DS_REG.SIS_ARQUIVOSVC = "0500"
					DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
		
					$nrLinhaBloco$   = $nrLinhaBloco$   + 1
					$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
					$nrRegistroArq$  = $nrRegistroArq$  + 1
		
					$instancehandle->totalizarQtdTipoRegistro("0500")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif

			discard "V_PAT_CIAPSVC"
			if ($status = 0)
				$status = -1
			endif
		endwhile
	endif

	return(0)

End ; operation gerarEFDBloco0Reg0500.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.170/076] - 19/10/2010          ;
partner operation gerarEFDBloco0Reg0600          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		date   vDtAux
		string vDsConteudo, vStringAux, viParams, voParams
	endvariables

	;if ($inGeraReg0600$ != <TRUE>)
	;	return(0)
	;endif

	;---- WMC - Proj 170 Tar 183 - 08/02/2011
	if($TPCCUSTOPAT$ = 1) ; rodrigo - PRJ 166 TAR 78 - 14/03/2011
		$instancehandle->cadastrarcentrodecusto($xCdErro$,$xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	else
	;------//------//------

		clear/e "GEC_CCUSTOSVC"
		retrieve/e "GEC_CCUSTOSVC"
		if ($status >= 0)

			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 0 - registro 0600", "", "")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif

			setocc "GEC_CCUSTOSVC",-1
			sort/e "GEC_CCUSTOSVC", "CD_CCUSTO.GEC_CCUSTOSVC"
			setocc "GEC_CCUSTOSVC", 1

			while ($status >= 0)
				vDsConteudo = ""
				;Texto fixo
				vDsConteudo = "|0600"
				;Data da inclusão/alteração
				vDtAux   = $item("DT_PERIODOINI", $parametro$)
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_ANOEXERCONTABIL", vDtAux[y]
				putitem/id viParams, "IN_NAOVALIDAR"     , <TRUE>
				activate "CTBSVCO001".GetLstParametro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
				vDtAux      = $item("DT_INFERIOR", voParams)
	
				;---- WMC - Proj 170 Tar 183 - 08/02/2011
				if (vDtAux = "")
					$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Data do parametro da contabilidade invalida", "ADICIONAL=Operação->FISSVCO039.gerarEFDBloco0Reg0600")
					poCdErro = $xCdErro$
					poCtxErro = $xCtxErro$
					return (-1)
				endif
				;------//------//------

				vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Código do centro de custo
				vStringAux  = "%%CD_CCUSTO.GEC_CCUSTOSVC"
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Nome do centro de custo
				call converterString(DS_CCUSTO.GEC_CCUSTOSVC,vStringAux)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
				;Marcador
				vDsConteudo = "%%vDsConteudo%%%|%%^"
		
				creocc "SIS_ARQUIVOSVC", -1
				DS_REG.SIS_ARQUIVOSVC = "0600"
				DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
		
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
		
				$instancehandle->totalizarQtdTipoRegistro("0600")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif

				discard "GEC_CCUSTOSVC"
				if ($status = 0)
					$status = -1
				endif
			endwhile
		endif
	endif

	return(0)

End ; operation gerarEFDBloco0Reg0600.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.170/094] - 26/10/2010          ;
partner operation gerarEFDBlocoCRegC310          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo, vStringAux
	endvariables

	clear/e "FIS_NFSVC"
	cd_empfat.fis_nfsvc/init        = $item("CD_EMPRESA", $parametro$)
	;------ WMC - PRJ 175 TAR 052 - 08/02/2011
	if ($inConsideraDtemisNfsai$ = <TRUE>)
		DT_EMISSAO.FIS_NFSVC/init       = dt_data.tmp_k03dsdtsvc
	else
		DT_SAIDAENTRADA.FIS_NFSVC/init  = dt_data.tmp_k03dsdtsvc
	endif
	;------//------//------
	tp_situacao.fis_nfsvc/init      = "C"
	tp_moddctofiscal.fis_nfsvc/init = 02
	tp_operacao.fis_nfsvc/init      = "S"
	nr_nf.fis_nfsvc/init            = "·>·=%%nr_nfini.tmp_k03dsdtsvc·&·<·=%%nr_nffim.tmp_k03dsdtsvc"
	cd_serie.fis_nfsvc/init         = "%%ds_campo1.tmp_k03dsdtsvc"
	retrieve/e "FIS_NFSVC"
	if ($status < 0)
		clear/e "FIS_NFSVC"
		return(0)
	endif

	setocc "FIS_NFSVC",1
	while ($status >= 0)

		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C310", "", "")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		vDsConteudo = ""
		;Texto fixo
		vDsConteudo = "|C310"
		;Numero do documento fiscal cancelado.
		call retirarNaoNumerico(nr_nf.fis_nfsvc, vStringAux)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Marcador
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		creocc "SIS_ARQUIVOSVC", -1
		DS_REG.SIS_ARQUIVOSVC = "C310"
		DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
		
		$instancehandle->totalizarQtdTipoRegistro("C310")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		discard "FIS_NFSVC"
		if ($status = 0)
			$status = -1
		endif
	endwhile

	return(0)

End ; operation gerarEFDBlocoCRegC310.
;;

;--------------------------------------------------;
;-- MAD [Proj/Tar.170/077] - 26/10/2010            ;
partner operation gerarEFDBlocoG                   ;
;--------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams

	$nrLinhaBloco$ = ""

	;Abertura do bloco G
	$instancehandle->gerarEFDBlocoGRegG001($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	if ($item("IN_ESCRITURA_CIAP",$xlplemp$) = 1)
		;CIAP - Crédito do ICMS do Ativo Permanente
		$instancehandle->gerarEFDBlocoGRegG110($xCdErro$,$xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		;Movimentação do imobilizado
		$instancehandle->gerarEFDBlocoGRegG125($xCdErro$,$xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	
	;Encerramento do Bloco G
	$instancehandle->gerarEFDBlocoGRegG990($xCdErro$,$xCtxErro$)
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	return(0)

End ; operation gerarEFDBlocoG
;;

;-----------------------------------------------;
;-- MAD [Proj/Tar.170/077] - 26/10/2010         ;
partner operation gerarEFDBlocoGRegG001         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo, vStringAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco G - registro G001", "", "")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif

	vDsConteudo = ""
	;Texto fixo
	vDsConteudo = "|G001"
	;Indicador de movimento
	if ($item("IN_ESCRITURA_CIAP",$xlplemp$) = 1)
		vStringAux = "|0"
	else
		vStringAux = "|1"
	endif
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "G001"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("G001")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)

End ; operation gerarEFDBlocoGRegG001.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.170/077] - 26/10/2010          ;
partner operation gerarEFDBlocoGRegG110          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		date    vDtAux
		numeric vNumericAux, vVlIndice
		string  vDsConteudo, vStringAux, vStringConv
	endvariables

	vDtAux = $item("DT_PERIODOINI", $parametro$)

	clear/e "FIS_CIAPMODCSVC"
	CD_EMPRESA.FIS_CIAPMODCSVC/init = $item("CD_EMPRESA", $parametro$)
	DT_MESANO.FIS_CIAPMODCSVC/init  =  "01%%%/%%vDtAux[m]%%%/%%vDtAux[y]"
	retrieve/e "FIS_CIAPMODCSVC"
	if ($status >= 0)

		call buscaRegistroBlocoG($xCdErro$,$xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco G - registro G110", "", "")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		vDsConteudo = ""
		;Texto fixo
		vDsConteudo = "|G110"
		;Data inicial a que a apuração se refere
		vDtAux      = $item("DT_PERIODOINI", $parametro$)
		vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Data final a que a apuração se refere
		vDtAux      = $item("DT_PERIODOFIM", $parametro$)
		vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Saldo inicial de ICMS do CIAP
		vNumericAux = 0
		setocc "TMP_K03DSDTSVC",-1
		sort/e "TMP_K03DSDTSVC", "DS_CAMPO1.TMP_K03DSDTSVC"
		setocc "TMP_K03DSDTSVC", 1
		while ($status >= 0)
			if (DS_CAMPO2.TMP_K03DSDTSVC = "SI") & (IN_GERA.TMP_K03DSDTSVC = <TRUE>)
				vNumericAux = vNumericAux + VL_ICMS.TMP_K03DSDTSVC
			endif
			setocc "TMP_K03DSDTSVC", $curocc("TMP_K03DSDTSVC") + 1
		endwhile
		;vNumericAux = $vlSaldoCiap$
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Somatório das parcelas de ICMS
		vNumericAux = $vlParcela$
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor das saídas tributadas e exportação
		vNumericAux = VL_TRIBEXP.FIS_CIAPMODCSVC
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor total de saídas
		vNumericAux = VL_TOTSAIDAS.FIS_CIAPMODCSVC
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Índice de participação
		vVlIndice = VL_TRIBEXP.FIS_CIAPMODCSVC / VL_TOTSAIDAS.FIS_CIAPMODCSVC
		;-- MAD [Proj/Tar.175/189] - 14/07/2011
		;vVlIndice = vVlIndice[round,4]
		vVlIndice = vVlIndice[round,8]
		;;
		call editarNr(12, 8, vVlIndice, vStringAux)
		call convValorString(8,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor a ser apropriado
		;-- MAD [Proj/Tar.170/249] - 12/05/2011
		;vNumericAux = $vlParcela$ * vVlIndice
		vNumericAux = VL_CREDITO.FIS_CIAPMODCSVC
		;;
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor de outros créditos
		vNumericAux = $vlOutCred$
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Marcador
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		creocc "SIS_ARQUIVOSVC", -1
		DS_REG.SIS_ARQUIVOSVC = "G110"
		DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("G110")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	return(0)

End ; operation gerarEFDBlocoGRegG110.
;;

;---------------------------------------------;
;-- MAD [Proj/Tar.170/078] - 10/11/2010       ;
partner operation gerarEFDBlocoGRegG125       ;
;---------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		date    vDtIni, vDtFim, vDtAux
		numeric vNumericAux
		string  vDsConteudo, vStringAux, vStringConv, vDsLstNF, vDsRegistro
	endvariables

	if ($empty("TMP_K03DSDTSVC"))
		return(0)
	endif

	vDtIni = $item("DT_PERIODOINI", $parametro$)
	vDtFim = $item("DT_PERIODOFIM", $parametro$)

	clear/e "FIS_CIAPOUTSVC"

	setocc "TMP_K03DSDTSVC",-1
	sort/e "TMP_K03DSDTSVC", "DS_CAMPO1.TMP_K03DSDTSVC"
	setocc "TMP_K03DSDTSVC", 1

	while ($status >= 0)
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco G - registro G125", "", "")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		
		;--> VSOUZA PRJ/TAR 189/073 25/01/2012
		if (NR_PARCELA.TMP_K03DSDTSVC = 0) | (NR_PARCELA.TMP_K03DSDTSVC = "") | (VL_PARCELA.TMP_K03DSDTSVC = 0) | (VL_PARCELA.TMP_K03DSDTSVC = "")
			IN_GERA.TMP_K03DSDTSVC = <FALSE>
		endif
		;-------------------------------------<

		if (IN_GERA.TMP_K03DSDTSVC = <TRUE>)		
			vDsConteudo = ""
			;Texto fixo
			vDsConteudo = "|G125"
			;Código individualizado do bem
			vStringAux  = "%%DS_CAMPO1.TMP_K03DSDTSVC"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Data da movimentação
			vDtAux      = DT_DATA.TMP_K03DSDTSVC
			vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Tipo de movimentação do bem
			vStringAux  = "%%DS_CAMPO2.TMP_K03DSDTSVC"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
			;Valor do ICMS
			vNumericAux = VL_ICMS.TMP_K03DSDTSVC
			call editarNr(12, 2, vNumericAux, vStringAux)
			call convValorString(2,vStringAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor da Sub. Tributária
			vNumericAux = VL_SUBTRIB.TMP_K03DSDTSVC
			call editarNr(12, 2, vNumericAux, vStringAux)
			call convValorString(2,vStringAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do ICMS sobre Frete	
			vNumericAux = VL_FRETE.TMP_K03DSDTSVC
			call editarNr(12, 2, vNumericAux, vStringAux)
			call convValorString(2,vStringAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Valor do Diferencial de Alíquota
			vNumericAux = VL_DIFALIQ.TMP_K03DSDTSVC
			call editarNr(12, 2, vNumericAux, vStringAux)
			call convValorString(2,vStringAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Número da parcela do ICMS
			if (VL_PARCELA.TMP_K03DSDTSVC = 0)		
				vStringConv = ""
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			else
				vNumericAux = NR_PARCELA.TMP_K03DSDTSVC
				call convNumeric(vNumericAux, 3, vStringConv)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			endif
			;Valor da parcela de ICMS passível de apropriação
			vNumericAux = VL_PARCELA.TMP_K03DSDTSVC
			vNumericAux = vNumericAux[round,4]
			call editarNr(12, 2, vNumericAux, vStringAux)
			call convValorString(2,vStringAux, vStringConv)
			vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
			;Marcador
			vDsConteudo = "%%vDsConteudo%%%|%%^"
	
			creocc "SIS_ARQUIVOSVC", -1
			DS_REG.SIS_ARQUIVOSVC = "G125"
			DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
		
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
	
			$instancehandle->totalizarQtdTipoRegistro("G125")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif

			;; ICJ [PROJ/TAR 170/200] (03/03/2011)
			clear/e "V_PAT_CIAPSVC"
			CD_EMPRESA.V_PAT_CIAPSVC/init 	= $item("CD_EMPRESA", $parametro$)
			NR_CIAP.V_PAT_CIAPSVC/init 		= NR_CIAP.TMP_K03DSDTSVC
			CD_PRODUTO.V_PAT_CIAPSVC/init 	= CD_PRODUTO.TMP_K03DSDTSVC	
			NR_SEQUENCIA.V_PAT_CIAPSVC/init	= NR_SEQUENCIA.TMP_K03DSDTSVC	
			retrieve/e "V_PAT_CIAPSVC"
			if ($status >= 0)
				clear/e "PAT_IMOBFICHISVC"
				CD_PRODUTO.PAT_IMOBFICHISVC/init = CD_PRODUTO.V_PAT_CIAPSVC
				NR_SEQIMOB.PAT_IMOBFICHISVC/init = NR_SEQUENCIA.V_PAT_CIAPSVC
				retrieve/e "PAT_IMOBFICHISVC"
				if ($status >= 0)
					setocc "PAT_IMOBFICHISVC",-1
					setocc "PAT_IMOBFICHISVC", 1
					while ($status >= 0)
						; Geração do registro 0300
						creocc "F2_TMP_DS60SVC", -1
						;Código individualizado do bem
						if (TP_ITEM.PAT_IMOBFICHISVC = 1)
							DS_60.F2_TMP_DS60SVC = "%%NR_CHAPA.V_PAT_CIAPSVC%%NR_SEQITEM.PAT_IMOBFICHISVC"
						else
							clear/e "PAT_IMOBILIZASVC"
							CD_PRODUTO.PAT_IMOBILIZASVC/init   = CD_PRODCOMP.PAT_IMOBFICHISVC
							NR_SEQUENCIA.PAT_IMOBILIZASVC/init = NR_SEQCOMP.PAT_IMOBFICHISVC
							retrieve/e "PAT_IMOBILIZASVC"
							if ($status >= 0)
								DS_60.F2_TMP_DS60SVC = "%%NR_CHAPA.PAT_IMOBILIZASVC"	
							endif
							retrieve/o "F2_TMP_DS60SVC"
							if ($status = 4)
								retrieve/x "F2_TMP_DS60SVC"
							else
								if (DS_60.F2_TMP_DS60SVC != "")
									clear/e "PAT_IMOBINFOSVC"
		
									CD_PRODUTO.PAT_IMOBINFOSVC/init   = CD_PRODUTO.F2_TMP_DS60SVC
									NR_SEQUENCIA.PAT_IMOBINFOSVC/init = NR_SEQUENCIA.F2_TMP_DS60SVC
									retrieve/e "PAT_IMOBINFOSVC"
									if ($status >= 0)
										$instancehandle->totalizarQtdTipoRegistro("0305")
										if ($procerror)
											$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
											poCdErro  = $xCdErro$
											poCtxErro = $xCtxErro$
											return(-1)
										elseif ($status < 0)
											$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
											poCdErro  = $xCdErro$
											poCtxErro = $xCtxErro$
											return(-1)
										endif
										;$nrLinhaBloco$   = $nrLinhaBloco$   + 1
										;$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
										;$nrRegistroArq$  = $nrRegistroArq$  + 1
									endif
								endif
							endif
							;Identificação do tipo de mercadoria (1=bem | 2=componente)
							TP_MERCADORIA.F2_TMP_DS60SVC = "2"
	
							;Descrição do bem 	
							DS_BEM.F2_TMP_DS60SVC = DS_IMOBILIZADO.V_PAT_CIAPSVC
	
							;Código de cadastro do bem principal
							CD_BEM.F2_TMP_DS60SVC = "%%NR_CHAPA.V_PAT_CIAPSVC"
	
							;Código da conta analítica de contabilização do bem
							clear/e "CTB_PLANOSVC"
							if (CD_CONTACTB.V_PAT_CIAPSVC != "")
								CD_REDUZIDO.CTB_PLANOSVC/init = CD_CONTACTB.V_PAT_CIAPSVC
								retrieve/e "CTB_PLANOSVC"
							endif
							CD_CONTA.F2_TMP_DS60SVC = "%%CD_CONTA.CTB_PLANOSVC"
	
							;Número total de parcelas a serem apropriadas
							NR_PARCELA.F2_TMP_DS60SVC = 48
							;;
						endif
						setocc "PAT_IMOBFICHISVC", $curocc("PAT_IMOBFICHISVC") + 1
					endwhile
				else
					creocc "F2_TMP_DS60SVC", -1
					;Código individualizado do bem
					DS_60.F2_TMP_DS60SVC = "%%NR_CHAPA.V_PAT_CIAPSVC"
					retrieve/o "F2_TMP_DS60SVC"
					if ($status = 4)
						retrieve/x "F2_TMP_DS60SVC"
					else	
						if (DS_60.F2_TMP_DS60SVC != "")
							clear/e "PAT_IMOBINFOSVC"
							CD_PRODUTO.PAT_IMOBINFOSVC/init   = CD_PRODUTO.F2_TMP_DS60SVC
							NR_SEQUENCIA.PAT_IMOBINFOSVC/init = NR_SEQUENCIA.F2_TMP_DS60SVC
							retrieve/e "PAT_IMOBINFOSVC"
							if ($status >= 0)
								$instancehandle->totalizarQtdTipoRegistro("0305")
								if ($procerror)
									$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
									poCdErro  = $xCdErro$
									poCtxErro = $xCtxErro$
									return(-1)
								elseif ($status < 0)
									$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
									poCdErro  = $xCdErro$
									poCtxErro = $xCtxErro$
									return(-1)
								endif
								;$nrLinhaBloco$   = $nrLinhaBloco$   + 1
								;$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
								;$nrRegistroArq$  = $nrRegistroArq$  + 1
							endif
						endif
					endif
		
					;Identificação do tipo de mercadoria (1=bem | 2=componente)
					TP_MERCADORIA.F2_TMP_DS60SVC = "1"
	
					;Descrição do bem 	
					DS_BEM.F2_TMP_DS60SVC = DS_IMOBILIZADO.V_PAT_CIAPSVC
	
					;Código de cadastro do bem principal
					CD_BEM.F2_TMP_DS60SVC = ""

					;Código da conta analítica de contabilização do bem
					clear/e "CTB_PLANOSVC"
					if (CD_CONTACTB.V_PAT_CIAPSVC != "")
						CD_REDUZIDO.CTB_PLANOSVC/init = CD_CONTACTB.V_PAT_CIAPSVC
						retrieve/e "CTB_PLANOSVC"
					endif
					CD_CONTA.F2_TMP_DS60SVC = "%%CD_CONTA.CTB_PLANOSVC"
	
					;Número total de parcelas a serem apropriadas
					NR_PARCELA.F2_TMP_DS60SVC = 48
				endif
				CD_PRODUTO.F2_TMP_DS60SVC = CD_PRODUTO.V_PAT_CIAPSVC
				NR_SEQUENCIA.F2_TMP_DS60SVC = NR_SEQUENCIA.V_PAT_CIAPSVC
				NR_VIDAUTIL.F2_TMP_DS60SVC = NR_VIDAUTIL.V_PAT_CIAPSVC
			endif
			;;

			if (NR_CIAP.TMP_K03DSDTSVC != "")
				;Outros créditos CIAP
				$instancehandle->gerarEFDBlocoGRegG126($xCdErro$,$xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
	
			if (vDtIni >= "01/01/2011" & vDtFim <= "31/01/2011") & (DS_LSTNF.TMP_K03DSDTSVC != "")
				vDsLstNF = DS_LSTNF.TMP_K03DSDTSVC
				repeat
					getitem vDsRegistro, vDsLstNF, 1
					CD_EMPRESA.TMP_K03DSDTSVC = $item("CD_EMPRESA", vDsRegistro)
					DT_FATURA.TMP_K03DSDTSVC  = $item("DT_FATURA" , vDsRegistro)
					NR_FATURA.TMP_K03DSDTSVC  = $item("NR_FATURA" , vDsRegistro)
					NR_ITEM.TMP_K03DSDTSVC    = $item("NR_ITEM"   , vDsRegistro)
	
					;Identificação da NF
					$instancehandle->gerarEFDBlocoGRegG130($xCdErro$,$xCtxErro$)
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
	
					delitem vDsLstNF, 1
				until (vDsLstNF = "")
			else
				;; ICJ [PROJ/TAR 170/200] (03/03/2011)
				;if (NR_FATURA.TMP_K03DSDTSVC != "") 
				if (NR_FATURA.TMP_K03DSDTSVC != "") & (((vDtIni > "31/01/2011") & (DT_AQUISICAO.V_PAT_CIAPSVC >= vDtIni) & (DT_AQUISICAO.V_PAT_CIAPSVC <= vDtFim)) | %\
					(vDtIni >= "01/01/2011" & vDtFim <= "31/01/2011"))
				;;
					;Identificação da NF
					$instancehandle->gerarEFDBlocoGRegG130($xCdErro$,$xCtxErro$)
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
			endif
		endif
		discard "TMP_K03DSDTSVC"
		if ($status = 0)
			$status = -1
		endif
	endwhile

	clear/e "TMP_K03DSDTSVC"
	clear/e "FIS_CIAPOUTSVC"

	return(0)

End ; operation gerarEFDBlocoGRegG125.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.170/079] - 27/10/2010          ;
partner operation gerarEFDBlocoGRegG126          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		date    vDtAux
		numeric vNumericAux
		string  vDsConteudo, vStringAux, vStringConv
	endvariables

	vDtAux = $item("DT_PERIODOINI", $parametro$)

	creocc "FIS_CIAPOUTSVC", -1
	CD_EMPRESA.FIS_CIAPOUTSVC = $item("CD_EMPRESA", $parametro$)
	DT_MESANO.FIS_CIAPOUTSVC  = "01%%%/%%vDtAux[m]%%%/%%vDtAux[y]"
	NR_CIAP.FIS_CIAPOUTSVC    = NR_CIAP.TMP_K03DSDTSVC
	retrieve/o "FIS_CIAPOUTSVC"
	if ($status = -7)
		retrieve/x "FIS_CIAPOUTSVC"

		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco G - registro G126", "", "")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		vDsConteudo = ""
		;Texto fixo
		vDsConteudo = "|G126"
		;Data inicial do período de apuração
		vDtAux      = DT_INICIO.FIS_CIAPOUTSVC
		vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Data final do período de apuração
		vDtAux      = DT_FINAL.FIS_CIAPOUTSVC
		vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Número da parcela do ICMS
		vNumericAux = NR_PARC.FIS_CIAPOUTSVC
		call convNumeric(vNumericAux, 3, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor da parcela de ICMS
		vNumericAux = VL_PARCPASS.FIS_CIAPOUTSVC
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor do somatório das saídas tributadas e para exportação
		vNumericAux = VL_TRIBOC.FIS_CIAPOUTSVC
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor total de saídas
		vNumericAux = VL_TOTAL.FIS_CIAPOUTSVC
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Índice de participação
		vNumericAux = PR_INDSAI.FIS_CIAPOUTSVC
		vNumericAux = vNumericAux[round,4]
		call editarNr(12, 4, vNumericAux, vStringAux)
		call convValorString(4,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Valor a ser apropriado
		vNumericAux = VL_APROP.FIS_CIAPOUTSVC
		vNumericAux = vNumericAux[round,2]
		call editarNr(12, 2, vNumericAux, vStringAux)
		call convValorString(2,vStringAux, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Marcador
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		creocc "SIS_ARQUIVOSVC", -1
		DS_REG.SIS_ARQUIVOSVC = "G126"
		DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("G126")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	return(0)

End ; operation gerarEFDBlocoGRegG126.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.170/080] - 11/11/2010          ;
partner operation gerarEFDBlocoGRegG130          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		date    vDtAux
		numeric vNumericAux, vCdEstado, vNumerico
		string  vDsConteudo, vStringAux, vStringConv, vPesCliente
		string  viParams, voParams, vGlbLogradouro
	endvariables

	clear/e "FIS_NFSVC"
	CD_EMPRESA.FIS_NFSVC/init = CD_EMPRESA.TMP_K03DSDTSVC
	NR_FATURA.FIS_NFSVC/init  = NR_FATURA.TMP_K03DSDTSVC
	DT_FATURA.FIS_NFSVC/init  = DT_FATURA.TMP_K03DSDTSVC
	retrieve/e "FIS_NFSVC"
	if ($status >= 0)

		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco G - registro G130", "", "")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		vDsConteudo = ""
		;Texto fixo
		vDsConteudo = "|G130"
		;Indicador do emitente do documento fiscal
		if (TP_ORIGEMEMISSAO.FIS_NFSVC = 1)
			vStringAux = "0"
		else
			vStringAux = "1"
		endif

		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;---- WMC - Proj 170 Tar 183 - 08/02/2011
		;Código do participante
		;vStringAux  = "%%NR_CPFCNPJ.FIS_NFREMDESSVC"
		call convNumeric(CD_PESSOA.FIS_NFREMDESSVC, 9, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"

		;---- WMC - 16/02/2011 - CONFORME INSTRUÇÕES DO RENAN
		creocc "F_TMP_NR09SVC", -1
		nr_geral.f_tmp_nr09svc = cd_pessoa.fis_nfremdessvc
		retrieve/o "F_TMP_NR09SVC"

		if ($status = 4)
			retrieve/x "F_TMP_NR09SVC"
		endif
					
		nm_cliente.f_tmp_nr09svc = nm_nome.fis_nfremdessvc
		tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_nfremdessvc

		if (tp_pessoa.fis_nfremdessvc = "F")
			nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_nfremdessvc
		else
			nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_nfremdessvc
		endif

		nr_rginscr.f_tmp_nr09svc  = nr_rginscrest.fis_nfremdessvc

		vPesCliente = ""
		viParams = ""
		voParams = ""
		putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_nfremdessvc
		activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
		if (voParams != "")
			vPesCliente = voParams
		endif
					
		NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)

		ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_nfremdessvc %%nm_logradouro.fis_nfremdessvc"
		nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_nfremdessvc
		nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_nfremdessvc

		if (cd_cep.fis_nfremdessvc != 99999999)
			vGlbLogradouro = ""
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_CEP", cd_cep.fis_nfremdessvc
			activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			if (voParams != "")
				vGlbLogradouro = voParams
			endif
				
			vCdEstado                  = ""
			vCdEstado                  = $item("DS_ESTADO",vGlbLogradouro)					
			cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
			cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
			ds_estado.f_tmp_nr09svc    = vCdEstado
			ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
		endif
		;------//------//------

		;Código do modelo de documento fiscal
		vNumericAux = TP_MODDCTOFISCAL.FIS_NFSVC
		call convNumeric(vNumericAux, 2, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Série do documento fiscal
		vStringAux  = "%%CD_SERIE.FIS_NFSVC"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Número de documento fiscal
		vNumericAux = NR_NF.FIS_NFSVC
		call convNumeric(vNumericAux, 9, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Chave de acesso da NFe
		vStringAux  = "%%DS_CHAVEACESSO.FIS_NFESVC"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Data do documento fiscal
		vDtAux      = DT_SAIDAENTRADA.FIS_NFSVC
		vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		;Marcador
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		creocc "SIS_ARQUIVOSVC", -1
		DS_REG.SIS_ARQUIVOSVC = "G130"
		DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("G130")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		;Identificação do item da NF
		$instancehandle->gerarEFDBlocoGRegG140($xCdErro$,$xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	return(0)

End ; operation gerarEFDBlocoGRegG130.
;;

;------------------------------------------------;
;-- MAD [Proj/Tar.170/080] - 11/11/2010          ;
partner operation gerarEFDBlocoGRegG140          ;
;------------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		numeric vNumericAux
		string  vDsConteudo, vStringAux, vStringConv, vCdEspecie
		string  viParams, voParams, vFisTipi, vStrAux
	endvariables

	clear/e "FIS_NFITEMSVC"
	CD_EMPRESA.FIS_NFITEMSVC/init = CD_EMPRESA.TMP_K03DSDTSVC
	DT_FATURA.FIS_NFITEMSVC/init  = DT_FATURA.TMP_K03DSDTSVC
	NR_FATURA.FIS_NFITEMSVC/init  = NR_FATURA.TMP_K03DSDTSVC
	NR_ITEM.FIS_NFITEMSVC/init    = NR_ITEM.TMP_K03DSDTSVC
	retrieve/e "FIS_NFITEMSVC"
	if ($status >= 0)

		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco G - registro G140", "", "")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif

		vDsConteudo = ""
		;Texto fixo
		vDsConteudo = "|G140"
		;Número do item
		vNumericAux = NR_ITEM.FIS_NFITEMSVC
		call convNumeric(vNumericAux, 3, vStringConv)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringConv"
		;Código do produto
		;call convNumeric(CD_PRODUTO.FIS_NFITEMPROSVC, 14, vStringAux)
		vStringAux = CD_PRODUTO.FIS_NFITEMPROSVC
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;---- WMC - 16/02/2011 - CONFORME INSTRUÇÕES DO RENAN
		creocc "F_TMP_DS40SVC", -1
		if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
			DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemsvc
		else
			DS_40.F_TMP_DS40SVC = cd_produto.fis_nfitemprosvc
		endif
		if (DS_40.F_TMP_DS40SVC != "") ; --/-<@ Virginia - 24/05/2011
			clear/e "PRD_PRDCONVMESVC"
			CD_PRODUTO.PRD_PRDCONVMESVC/init = DS_40.F_TMP_DS40SVC
			retrieve/e "PRD_PRDCONVMESVC"
			if ($status >= 0)
				$instancehandle->totalizarQtdTipoRegistro("0220")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
		endif
		retrieve/o "F_TMP_DS40SVC"
		if ($status = 4)
			retrieve/x "F_TMP_DS40SVC"
			vCdEspecie = ds_especie.F_TMP_DS40SVC
		else
			ds_produto.F_TMP_DS40SVC = ds_produto.fis_nfitemsvc
			ds_especie.F_TMP_DS40SVC = cd_especie.fis_nfitemsvc
			vCdEspecie = cd_especie.fis_nfitemsvc
			if (cd_tipi.fis_nfitemsvc = "")
				if (CD_ESPECIE.FIS_NFITEMSVC = "SVC")
				else
					clear/e "PRD_PRODUTOSVC"
					cd_produto.prd_produtosvc/init = cd_produto.fis_nfitemprosvc
					retrieve/e "PRD_PRODUTOSVC"
					if ($status >= 0)
						if (CD_ESPECIE.FIS_NFITEMSVC = "")
							ds_especie.F_TMP_DS40SVC = cd_especie.prd_produtosvc
							vCdEspecie = cd_especie.prd_produtosvc
						endif
						if (cd_tipi.prd_produtosvc != "")
							vFisTipi = ""
							viParams = ""
							voParams = ""
							putitem/id viParams, "CD_TIPI", cd_tipi.prd_produtosvc
							activate "FISSVCO032".carregaFisTipi($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
							if ($procerror)
								$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
								return(-1)
							elseif ($status < 0)
								$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
								return(-1)
							endif
							if (voParams != "")
								vFisTipi = voParams
								vStrAux = $item("CD_TIPI",vFisTipi)
								vStrAux = $replace(vStrAux, 1, ".","",-1)
								cd_ncm.F_TMP_DS40SVC = vStrAux;[1:2]
							endif
						endif
					endif
				endif
			else
				cd_ncm.F_TMP_DS40SVC = cd_tipi.fis_nfitemsvc;[1:2]
				cd_ncm.F_TMP_DS40SVC = $replace(cd_ncm.F_TMP_DS40SVC, 1, ".","",-1)
			endif
				
			creocc "TMP_NRDSSVC", -1
			nr_geral.tmp_nrdssvc = 1
			ds_geral.tmp_nrdssvc = vCdEspecie
			retrieve/o "TMP_NRDSSVC"
			if ($status = 4)
			retrieve/x "TMP_NRDSSVC"
			endif
		endif

		;-- MAD [Proj/Tar.170/263] - 27/05/2011
		if (DS_40.F_TMP_DS40SVC != "")
			clear/e "FIS_NFITEMUNSVC"
			CD_EMPRESA.FIS_NFITEMUNSVC/init = CD_EMPRESA.FIS_NFITEMSVC
			NR_FATURA.FIS_NFITEMUNSVC/init  = NR_FATURA.FIS_NFITEMSVC
			DT_FATURA.FIS_NFITEMUNSVC/init  = DT_FATURA.FIS_NFITEMSVC
			NR_ITEM.FIS_NFITEMUNSVC/init    = NR_ITEM.FIS_NFITEMSVC
			CD_PRODUTO.FIS_NFITEMUNSVC/init = DS_40.F_TMP_DS40SVC
			retrieve/e "FIS_NFITEMUNSVC"
			if ($status >= 0) & (CD_ESPECIE.FIS_NFITEMUNSVC != vCdEspecie)
				vCdEspecie = CD_ESPECIE.FIS_NFITEMUNSVC

				clear/e "GTT_DS01SVC"
				creocc "GTT_DS01SVC", -1
				NR_GERAL.GTT_DS01SVC = DS_40.F_TMP_DS40SVC
				DS_GERAL.GTT_DS01SVC = vCdEspecie
				retrieve/o "GTT_DS01SVC"
				if ($status = -7)
					retrieve/x "GTT_DS01SVC"
				endif
				QT_CONVERSAO.GTT_DS01SVC = QT_CONVERSAO.FIS_NFITEMUNSVC
				$collhandle("GTT_DS01SVC")->Salvar()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif

				creocc "TMP_NRDSSVC", -1
				nr_geral.tmp_nrdssvc = 1
				ds_geral.tmp_nrdssvc = vCdEspecie
				retrieve/o "TMP_NRDSSVC"
				if ($status = 4)
					retrieve/x "TMP_NRDSSVC"
				endif

				creocc "TMP_DS40SVC", -1
				DS_40.TMP_DS40SVC = "0220"
				retrieve/o "TMP_DS40SVC"
				if ($status = -7)
					retrieve/x "TMP_DS40SVC"
				endif
			endif
		endif
		;;
		;----//----//----

		;Marcador
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		creocc "SIS_ARQUIVOSVC", -1
		DS_REG.SIS_ARQUIVOSVC = "G140"
		DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
		
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("G140")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	return(0)

End ; operation gerarEFDBlocoGRegG140.
;;

;-----------------------------------------------;
;-- MAD [Proj/Tar.170/077] - 26/10/2010         ;
partner operation gerarEFDBlocoGRegG990         ;
;-----------------------------------------------;
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo, vStringAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco G - registro G990", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif

	vDsConteudo = ""
	;Texto fixo.
	vDsConteudo = "|G990"
	;Quantidade total de linhas do bloco G.
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	vStringAux  = "|%%$nrLinhaBloco$"
	vDsConteudo = "%%vDsConteudo%%vStringAux"
	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "G990"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("G990")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	
	return(0)

End ; operation gerarEFDBlocoGRegG990.
;;

;-----------------------------------------------;
;-- WMC - Proj 170 Tar 183 - 08/02/2011         ;
partner operation cadastrarcentrodecusto        ;
;-----------------------------------------------;

	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams

	variables
		date	vDtAux
		string	vDsConteudo, vStringAux, viParams, voParams
		numeric	vContador
	endvariables

	vContador = 1

	while (vContador < 6)
; -> rodrigo - PRJ 166 TAR 78 - 14/03/2011
;		clear/e    "GEC_CCUSTOSVC"
;		CD_CCUSTO.GEC_CCUSTOSVC = vContador
;		retrieve/e "GEC_CCUSTOSVC"

;		if ($status < 0)
; <- rodrigo - PRJ 166 TAR 78 - 14/03/2011
			vDsConteudo = ""
			;Texto fixo
			vDsConteudo = "|0600"
			;Data da inclusão/alteração
			vDtAux   = $item("DT_PERIODOINI", $parametro$)
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_ANOEXERCONTABIL", vDtAux[y]
			putitem/id viParams, "IN_NAOVALIDAR"     , <TRUE>
			activate "CTBSVCO001".GetLstParametro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif

			vDtAux = $item("DT_INFERIOR", voParams)
	
			if (vDtAux = "")
				$instancehandle->SetStatus(<STS_ERRO>, "GEN0001", "DESCRICAO=Data do parametro da contabilidade invalida", "ADICIONAL=Operação->FISSVCO039.gerarEFDBloco0Reg0600")
				poCdErro = $xCdErro$
				poCtxErro = $xCtxErro$
				return (-1)
			endif

			vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

			;Código do centro de custo
			vStringAux  = "%%vContador"
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

			;Nome do centro de custo
			if (vContador = 1)
				vStringAux = "Area operacional"
			else
				if (vContador = 2)
					vStringAux = "Area administrativa"
				else
					if (vContador = 3)
						vStringAux = "Area produtiva"
					else
						if (vContador = 4)
							vStringAux = "Area apoio a producao"
						else
							vStringAux = "Area administrativa - industria"
						endif
					endif
				endif
			endif

			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

			;Marcador
			vDsConteudo = "%%vDsConteudo%%%|%%^"

			creocc "SIS_ARQUIVOSVC", -1
			DS_REG.SIS_ARQUIVOSVC = "0600"
			DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo

			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1

			$instancehandle->totalizarQtdTipoRegistro("0600")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
;		endif

		vContador = vContador + 1
	endwhile

	return(0)

End ; operation cadastrarcentrodecusto

;-------------------------------------------;
;-- MAD [Proj/Tar.170/238] - 27/04/2011     ;
partner operation gerarEFDBlocoCRegC110     ;
;-------------------------------------------;

	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		boolean vInObs, vInGerarC115
		string  vDsConteudo, vStringAux, vDsNF, vDsCF
		numeric vNrSeq
	endvariables

	; @>-/-- Virginia - 175/142 - 13/05/2011
	if ((TP_MODDCTOFISCAL.FIS_NFSVC = 55) | (TP_MODDCTOFISCAL.FIS_NFSVC = 85) | %\
       (TP_MODDCTOFISCAL.FIS_NFSVC = 86) | (TP_MODDCTOFISCAL.FIS_NFSVC = 87)) & (TP_ORIGEMEMISSAO.FIS_NFSVC = 1)
		return(0)
	endif
	; --\-<@

	if (TP_SITUACAO.FIS_NFSVC = "C") | (TP_SITUACAO.FIS_NFSVC = "D")
		return(0)
	endif

	vInGerarC115 = <FALSE>

	if (!$empty("FIS_NFREFSVC"))
		vDsNF  = ""
		vDsCF  = ""
		vInObs = <FALSE>
		
		if (!$empty("OBS_NFSVC"))
			setocc "OBS_NFSVC",1
			while ($status >= 0)
				if (DS_OBSERVACAO.OBS_NFSVC[1:7] != "FISCAL:")
					vInObs = <TRUE>
					break
				endif
				setocc "OBS_NFSVC", $curocc("OBS_NFSVC") + 1
			endwhile
		endif
	
		if (vInObs = <FALSE>)
			setocc "FIS_NFREFSVC",1
			while ($status >= 0)

				clear/e "FIS_S_NFSVC"
				CD_EMPRESA.FIS_S_NFSVC/init = CD_EMPRESAREF.FIS_NFREFSVC
				NR_FATURA.FIS_S_NFSVC/init  = NR_FATURAREF.FIS_NFREFSVC
				DT_FATURA.FIS_S_NFSVC/init  = DT_FATURAREF.FIS_NFREFSVC
				retrieve/e "FIS_S_NFSVC"
				if ($status >= 0)
					if (TP_REFERENCIAL.FIS_NFREFSVC = 1)
						vDsNF = "%%vDsNF %%NR_NF.FIS_S_NFSVC%%%-%%CD_SERIE.FIS_S_NFSVC"
					elseif (TP_REFERENCIAL.FIS_NFREFSVC = 2) | (TP_REFERENCIAL.FIS_NFREFSVC = 3)
						vDsCF = "%%vDsCF %%NR_NF.FIS_S_NFSVC%%%-%%CD_SERIE.FIS_S_NFSVC"
					endif
				endif
				setocc "FIS_NFREFSVC", $curocc("FIS_NFREFSVC") + 1
			endwhile
		
			if (vDsNF != "")
				vStringAux = "DOCUMENTO FISCAL REFERENCIADO:%%vDsNF"
			endif

			if (vDsCF != "")
				if (vStringAux = "")
					vStringAux = "CUPOM FISCAL REFERENCIADO:%%vDsCF"
				else
					vStringAux = "%%vStringAux - CUPOM FISCAL REFERENCIADO:%%vDsCF"
				endif
			endif

			setocc "OBS_NFSVC",-1
			vNrSeq = $curocc("OBS_NFSVC")
			vNrSeq = vNrSeq + 1

			creocc "OBS_NFSVC", -1
			NR_LINHA.OBS_NFSVC      = vNrSeq
			DS_OBSERVACAO.OBS_NFSVC = vStringAux
		endif
	endif

	if (!$empty("OBS_NFSVC"))
		sort/e "OBS_NFSVC", "NR_LINHA.OBS_NFSVC"
		setocc "OBS_NFSVC",1
		while ($status >= 0)

			if (DS_OBSERVACAO.OBS_NFSVC[1:7] != "FISCAL:")
	
				$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C110", "", "")
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
				endif
	
				clear/e "GTT_OBSNFSVC"
				TP_OBSNF.GTT_OBSNFSVC/init = 1 ; Informação complementar
				DS_OBSNF.GTT_OBSNFSVC/init = DS_OBSERVACAO.OBS_NFSVC
				retrieve/e "GTT_OBSNFSVC"
				if ($status < 0)
		
					vNrSeq = 0
					selectdb max(NR_SEQUENCIA) from "GTT_OBSNFSVC"   %\
						u_where (TP_OBSNF.GTT_OBSNFSVC = 1) to vNrSeq

					vNrSeq = vNrSeq + 1
	
					clear/e "GTT_OBSNFSVC"
					creocc "GTT_OBSNFSVC",-1
					NR_SEQUENCIA.GTT_OBSNFSVC = vNrSeq
					TP_OBSNF.GTT_OBSNFSVC     = 1
					retrieve/o "GTT_OBSNFSVC"
					if ($status = -7)
						retrieve/x "GTT_OBSNFSVC"
					endif
					DS_OBSNF.GTT_OBSNFSVC    = DS_OBSERVACAO.OBS_NFSVC
					CD_OPERADOR.GTT_OBSNFSVC = $item("CD_USUARIO", $$gParamGlb)
					DT_CADASTRO.GTT_OBSNFSVC = $datim

					$collhandle("GTT_OBSNFSVC")->Salvar()
					if ($procerror)
						$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						return(-1)
					endif
				endif
	
				vInGerarC115 = <TRUE>
				vDsConteudo  = ""

				;Texto fixo
				vDsConteudo = "|C110"

				;Código da informação complementar
				vStringAux  = NR_SEQUENCIA.GTT_OBSNFSVC
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

				;Descrição complementar do código de referência
				vStringAux  = ""
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

				;Marcador
				vDsConteudo = "%%vDsConteudo%%%|%%^"
	
				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "C110"
				ds_registro.sis_arquivosvc = vDsConteudo
	
				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
	
				$instancehandle->totalizarQtdTipoRegistro("C110")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
			setocc "OBS_NFSVC", $curocc("OBS_NFSVC") + 1
		endwhile
	endif

	if (!$empty("FIS_NFREFSVC"))
		sort/e "FIS_NFREFSVC","TP_REFERENCIAL.FIS_NFREFSVC"
		setocc "FIS_NFREFSVC",1
		while ($status >= 0)

			if (TP_REFERENCIAL.FIS_NFREFSVC = 1)

				;Documento Fiscal Referenciado
				$instancehandle->gerarEFDBlocoCRegC113($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif

			elseif (TP_REFERENCIAL.FIS_NFREFSVC = 2) | (TP_REFERENCIAL.FIS_NFREFSVC = 3)

				;Cupom Fiscal Referenciado
				$instancehandle->gerarEFDBlocoCRegC114($xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			endif
			setocc "FIS_NFREFSVC", $curocc("FIS_NFREFSVC") + 1
		endwhile
	endif

	;-- MAD [Proj/Tar.170/494] - 24/07/2012
	if (vInGerarC115 = <TRUE>) & (TP_MODDCTOFISCAL.FIS_NFSVC = 1 | TP_MODDCTOFISCAL.FIS_NFSVC = 4) 

		;Local de coleta e/ou entrega
		$instancehandle->gerarEFDBlocoCRegC115($xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif
	;;

	return(0)

End ; operation gerarEFDBlocoCRegC110.
;;

;-------------------------------------------;
;-- MAD [Proj/Tar.170/238] - 27/04/2011     ;
partner operation gerarEFDBlocoCRegC195     ;
;-------------------------------------------;

	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringAux, vDsObs
		numeric vNrSeq
	endvariables

	if ($empty("OBS_NFSVC"))
		return(0)
	endif

	sort/e "OBS_NFSVC", "NR_LINHA.OBS_NFSVC"
	setocc "OBS_NFSVC",1
	while ($status >= 0)

		if (DS_OBSERVACAO.OBS_NFSVC[1:7] = "FISCAL:")

			$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C195", "", "")
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
			endif

			vDsObs = DS_OBSERVACAO.OBS_NFSVC
			vDsObs = $replace(vDsObs, 1, "FISCAL:","",-1)
			vDsObs = $ltrim(vDsObs," ")

			clear/e "GTT_OBSNFSVC"
			TP_OBSNF.GTT_OBSNFSVC/init = 2 ; Obs. Fisco
			DS_OBSNF.GTT_OBSNFSVC/init = vDsObs
			retrieve/e "GTT_OBSNFSVC"
			if ($status < 0)
	
				vNrSeq = 0
				selectdb max(NR_SEQUENCIA) from "GTT_OBSNFSVC"   %\
					u_where (TP_OBSNF.GTT_OBSNFSVC = 2) to vNrSeq

				vNrSeq = vNrSeq + 1

				clear/e "GTT_OBSNFSVC"
				creocc "GTT_OBSNFSVC",-1
				NR_SEQUENCIA.GTT_OBSNFSVC = vNrSeq
				TP_OBSNF.GTT_OBSNFSVC     = 2
				retrieve/o "GTT_OBSNFSVC"
				if ($status = -7)
					retrieve/x "GTT_OBSNFSVC"
				endif
				DS_OBSNF.GTT_OBSNFSVC    = vDsObs
				CD_OPERADOR.GTT_OBSNFSVC = $item("CD_USUARIO", $$gParamGlb)
				DT_CADASTRO.GTT_OBSNFSVC = $datim

				$collhandle("GTT_OBSNFSVC")->Salvar()
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					return(-1)
				endif
			endif
	
			vDsConteudo = ""

			;Texto fixo
			vDsConteudo = "|C195"

			;Código da observação do lançamento fiscal
			vStringAux  = NR_SEQUENCIA.GTT_OBSNFSVC
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

			;Descrição complementar do código de observação
			vStringAux  = ""
			vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

			;Marcador
			vDsConteudo = "%%vDsConteudo%%%|%%^"
	
			creocc "SIS_ARQUIVOSVC", -1
			ds_reg.sis_arquivosvc = "C195"
			ds_registro.sis_arquivosvc = vDsConteudo
	
			$nrLinhaBloco$   = $nrLinhaBloco$   + 1
			$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
			$nrRegistroArq$  = $nrRegistroArq$  + 1
	
			$instancehandle->totalizarQtdTipoRegistro("C195")
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		setocc "OBS_NFSVC", $curocc("OBS_NFSVC") + 1
	endwhile
	
	return(0)

End ; operation gerarEFDBlocoCRegC195.
;;

;-------------------------------------------;
; rodrigo - prj 189 tar 52 - 06/12/2011		 ;
partner operation gerarEFDBlocoCRegC197     ;
;-------------------------------------------;

	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams

	variables
		string  vDsConteudo, vStringAux
		date vDtAux
		Boolean vInGerou95
		numeric vNumericAux
	endvariables

	vInGerou95 = <FALSE>

	vDtAux = $item("DT_PERIODOINI", $parametro$)
	vDtAux = "01/%%vDtAux[M]%%%/%%vDtAux[Y]"

	;----> COMENTADO POR CAMARGO/SANDRA EM 17/02/2012 - DUDALINA
	;clear/e "FIS_DETALHEICSVC"
	;CD_EMPRESA.FIS_DETALHEICSVC/init	= $item("CD_EMPRESA",$parametro$)
	;DT_MESANO.FIS_DETALHEICSVC/init		= vDtAux
	;CD_IMPOSTO.FIS_DETALHEICSVC/init	= 1
	;CD_DETALHAMENTO.FIS_DETALHEICSVC/init = "·!·=1"
	;retrieve/e "FIS_DETALHEICSVC"
	;----->

	clear/e "FIS_DIFALIQISVC"
	CD_EMPRESA.FIS_DIFALIQISVC/init = CD_EMPRESA.FIS_NFSVC
	NR_FATURA.FIS_DIFALIQISVC/init  = NR_FATURA.FIS_NFSVC
	DT_FATURA.FIS_DIFALIQISVC/init  = DT_FATURA.FIS_NFSVC
	retrieve/e "FIS_DIFALIQISVC"
	if($status >= 0)
		;setocc "FIS_DETALHEICSVC", -1
		;setocc "FIS_DETALHEICSVC", 1
		setocc "FIS_DIFALIQISVC", 1
		while($status >= 0)
			;----> COMENTADO POR CAMARGO/SANDRA EM 17/02/2012 - DUDALINA
			;clear/e "FIS_DIFALIQISVC"
			;CD_EMPRESA.FIS_DIFALIQISVC/init = CD_EMPRESA.FIS_DETALHEICSVC
			;CD_DETALHAMENTO.FIS_DIFALIQISVC/init = CD_DETALHAMENTO.FIS_DETALHEICSVC
			;retrieve/e "FIS_DIFALIQISVC"
			;if($status >= 0)
			;---->
				clear/e "FIS_TIPODETICSVC"
				CD_DETALHAMENTO.FIS_TIPODETICSVC = CD_DETALHAMENTO.FIS_DIFALIQISVC
				retrieve/e "FIS_TIPODETICSVC"

				if(vInGerou95 = <FALSE>)

					vInGerou95	= <TRUE>

					vDsConteudo = ""

					;Texto fixo
					vDsConteudo = "|C195"

					;Código
					vStringAux  = 02
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

					;Descrição complementar do código de observação
					vStringAux  = "DIFERENCIAL DE ALIQUOTA"
					vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

					;Marcador
					vDsConteudo = "%%vDsConteudo%%%|%%^"
	
					creocc "SIS_ARQUIVOSVC", -1
					ds_reg.sis_arquivosvc = "C195"
					ds_registro.sis_arquivosvc = vDsConteudo

					$nrLinhaBloco$   = $nrLinhaBloco$   + 1
					$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
					$nrRegistroArq$  = $nrRegistroArq$  + 1

					$instancehandle->totalizarQtdTipoRegistro("C195")
					if ($procerror)
						$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					elseif ($status < 0)
						$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
						poCdErro  = $xCdErro$
						poCtxErro = $xCtxErro$
						return(-1)
					endif
				endif
				
				;Texto fixo
				vDsConteudo = "|C197"

				;Código do ajuste
				vStringAux  = CD_SPEDFISCAL.FIS_TIPODETICSVC
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

				;Descrição complementar do código de observação
				vStringAux  = DS_DESCRICAO.FIS_TIPODETICSVC
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

				;Código do item
				vStringAux  = CD_PRODUTO.FIS_NFITEMSVC
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

				; Base de cálculo
				vNumericAux = VL_BASECALC.FIS_DIFALIQISVC
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringAux)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

				;percentual aliquota do ICMS
				vNumericAux = PR_ALIQUOTA.FIS_DIFALIQISVC
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringAux)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

				;Valor do ICMS
				vNumericAux = VL_DIFALIQ.FIS_DIFALIQISVC
				call editarNr(12, 2, vNumericAux, vNumericAux)
				call convValorString(2,vNumericAux, vStringAux)
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

				;Valor de outros
				vStringAux  = ""
				vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

				;Marcador
				vDsConteudo = "%%vDsConteudo%%%|%%^"

				creocc "SIS_ARQUIVOSVC", -1
				ds_reg.sis_arquivosvc = "C197"
				ds_registro.sis_arquivosvc = vDsConteudo

				$nrLinhaBloco$   = $nrLinhaBloco$   + 1
				$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
				$nrRegistroArq$  = $nrRegistroArq$  + 1
	
				$instancehandle->totalizarQtdTipoRegistro("C197")
				if ($procerror)
					$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
			;endif
			;setocc "FIS_DETALHEICSVC", $curocc(FIS_DETALHEICSVC) +1
			setocc "FIS_DIFALIQISVC", $curocc(FIS_DIFALIQISVC) +1
		endwhile
	endif

	return(0)

End ; gerarEFDBlocoCRegC197

;-------------------------------------------;
;-- MAD [Proj/Tar.170/238] - 27/04/2011     ;
partner operation gerarEFDBloco0Reg0450     ;
;-------------------------------------------;

	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo
	endvariables
	
	vDsConteudo = ""

	;Texto fixo.
	vDsConteudo = "|0450"
	
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0450"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("0450")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	return(0)

End ;operation gerarEFDBloco0Reg0450.
;;

;-------------------------------------------;
;-- MAD [Proj/Tar.170/238] - 27/04/2011     ;
partner operation gerarEFDBloco0Reg0460     ;
;-------------------------------------------;

	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo
	endvariables
	
	vDsConteudo = ""

	;Texto fixo.
	vDsConteudo = "|0460"
	
	creocc "SIS_ARQUIVOSVC", -1
	DS_REG.SIS_ARQUIVOSVC = "0460"
	DS_REGISTRO.SIS_ARQUIVOSVC = vDsConteudo
	
	$instancehandle->totalizarQtdTipoRegistro("0460")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	return(0)

End ;operation gerarEFDBloco0Reg0460.
;;

;-------------------------------------------;
;-- MAD [Proj/Tar.170/244] - 29/04/2011     ;
partner operation gerarEFDBlocoCRegC113     ;
;-------------------------------------------;

	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		date    vDtAux
		numeric vCdEstado
		string  vDsConteudo, vStringAux, vNumericAux, viParams, voParams, vGlbLogradouro, vPesCliente
	endvariables

	if ($empty("FIS_NFREFSVC"))
		return(0)
	endif

	clear/e "FIS_S_NFSVC"
	CD_EMPRESA.FIS_S_NFSVC/init = CD_EMPRESAREF.FIS_NFREFSVC
	NR_FATURA.FIS_S_NFSVC/init  = NR_FATURAREF.FIS_NFREFSVC
	DT_FATURA.FIS_S_NFSVC/init  = DT_FATURAREF.FIS_NFREFSVC
	retrieve/e "FIS_S_NFSVC"
	if ($status >= 0)

		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C113", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		vDsConteudo = ""

		;Texto fixo
		vDsConteudo = "|C113"

		;Indicador do tipo de operação (0-Entrada/1-Saída)
		if (TP_OPERACAO.FIS_S_NFSVC = "E")
			vStringAux = 0
		else
			vStringAux = 1
		endif
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Indicador do emitente do título (0-Emissão própria/1-Terceiros)
		if (TP_ORIGEMEMISSAO.FIS_S_NFSVC = "1")
			vStringAux = 0
		else
			vStringAux = 1
		endif
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		
		;Código do participante emitente
		clear/e "FIS_S_NFREMDESVC"
		CD_EMPFAT.FIS_S_NFREMDESVC/init = CD_EMPFAT.FIS_S_NFSVC
		DT_FATURA.FIS_S_NFREMDESVC/init = DT_FATURA.FIS_S_NFSVC
		NR_FATURA.FIS_S_NFREMDESVC/init = NR_FATURA.FIS_S_NFSVC
		retrieve/e "FIS_S_NFREMDESVC"
		if ($status >= 0)
			creocc "F_TMP_NR09SVC", -1
			nr_geral.f_tmp_nr09svc = cd_pessoa.fis_s_nfremdesvc
			retrieve/o "F_TMP_NR09SVC"
			if ($status = 4)
				retrieve/x "F_TMP_NR09SVC"
			endif
			
			nm_cliente.f_tmp_nr09svc = nm_nome.fis_s_nfremdesvc
			tp_pessoa.f_tmp_nr09svc  = tp_pessoa.fis_s_nfremdesvc
			if (tp_pessoa.fis_s_nfremdesvc = "F")
				nr_cpf.f_tmp_nr09svc  = nr_cpfcnpj.fis_s_nfremdesvc
			else
				nr_cnpj.f_tmp_nr09svc = nr_cpfcnpj.fis_s_nfremdesvc
			endif
			nr_rginscr.f_tmp_nr09svc  = nr_rginscrest.fis_s_nfremdesvc

			vPesCliente = ""
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_CLIENTE", cd_pessoa.fis_s_nfremdesvc
			activate "FISSVCO032".carregaPesCliente($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
			if (voParams != "")
				vPesCliente = voParams
			endif
			NR_SUFRAMA.F_TMP_NR09SVC = $item("NR_SUFRAMA",vPesCliente)
			ds_logradouro.f_tmp_nr09svc = "%%ds_tplogradouro.fis_s_nfremdesvc %%nm_logradouro.fis_s_nfremdesvc"
			nr_logradouro.f_tmp_nr09svc = nr_logradouro.fis_s_nfremdesvc
			nm_bairro.f_tmp_nr09svc     = nm_bairro.fis_s_nfremdesvc
			if (cd_cep.fis_s_nfremdesvc != 99999999)
				vGlbLogradouro = ""
				viParams = ""
				voParams = ""
				putitem/id viParams, "CD_CEP", cd_cep.fis_s_nfremdesvc
				activate "FISSVCO032".carregaLogradouro($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
				if ($procerror)
					$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				elseif ($status < 0)
					$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
					poCdErro  = $xCdErro$
					poCtxErro = $xCtxErro$
					return(-1)
				endif
				if (voParams != "")
					vGlbLogradouro = voParams
				endif				
				vCdEstado = ""
				vCdEstado = $item("DS_ESTADO",vGlbLogradouro)
				
				cd_municipio.f_tmp_nr09svc = $item("CD_MUNICIPIO",vGlbLogradouro)
				cd_estado.f_tmp_nr09svc    = $item("CD_ESTADO",vGlbLogradouro)
				ds_estado.f_tmp_nr09svc    = vCdEstado
				ds_sigla.f_tmp_nr09svc     = $item("DS_SIGLA",vGlbLogradouro)
			endif
		endif

		call convNumeric(cd_pessoa.fis_s_nfremdesvc, 9, vStringAux)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Código do documento fiscal
		if (TP_MODDCTOFISCAL.FIS_S_NFSVC = 85) | (TP_MODDCTOFISCAL.FIS_S_NFSVC = 86) | (TP_MODDCTOFISCAL.FIS_S_NFSVC = 87)
			viParams = ""
			voParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.FIS_S_NFSVC
			putitem/id viParams, "NR_FATURA" , NR_FATURA.FIS_S_NFSVC
			putitem/id viParams, "DT_FATURA" , DT_FATURA.FIS_S_NFSVC
			putitem/id viParams, "NM_CARREGATABELA", "FIS_NFE"
			activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
			if ($item("DS_CHAVEACESSO",voParams) != "")
				vNumericAux = 55
			else
				vNumericAux = 1
			endif
		else
			vNumericAux = TP_MODDCTOFISCAL.FIS_S_NFSVC
		endif
		call convNumeric(vNumericAux, 2, vStringAux)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Série do documento fiscal
		vStringAux  = "%%CD_SERIE.FIS_S_NFSVC"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Subsérie do documento fiscal
		vStringAux  = ""
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Número do documento fiscal
		call retirarNaoNumerico(NR_NF.FIS_S_NFSVC, vStringAux)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Data da emissão do documento fiscal
		vDtAux      = DT_EMISSAO.FIS_S_NFSVC
		vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Marcador
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "C113"
		ds_registro.sis_arquivosvc = vDsConteudo
	
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("C113")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	return(0)

End ; operation gerarEFDBlocoCRegC113.
;;

;-------------------------------------------;
;-- MAD [Proj/Tar.170/244] - 29/04/2011     ;
partner operation gerarEFDBlocoCRegC114     ;
;-------------------------------------------;

	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		date    vDtAux
		numeric vTotDig
		string  vDsConteudo, vStringAux, viParams, voParams
	endvariables

	if ($empty("FIS_NFREFSVC"))
		return(0)
	endif

	clear/e "FIS_S_NFSVC"
	CD_EMPRESA.FIS_S_NFSVC/init = CD_EMPRESAREF.FIS_NFREFSVC
	NR_FATURA.FIS_S_NFSVC/init  = NR_FATURAREF.FIS_NFREFSVC
	DT_FATURA.FIS_S_NFSVC/init  = DT_FATURAREF.FIS_NFREFSVC
	retrieve/e "FIS_S_NFSVC"
	if ($status < 0)
		return(0)
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPECF", CD_EMPFAT.FIS_S_NFSVC
	putitem/id viParams, "NR_FATURA", NR_FATURA.FIS_S_NFSVC
	putitem/id viParams, "DT_FATURA", DT_FATURA.FIS_S_NFSVC
	putitem/id viParams, "NM_CARREGATABELA", "FIS_NFECF"
	activate "FISSVCO032".carregaVEndereco($xlpg$, viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif
	if (voParams != "")

		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco C - registro C114", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		vDsConteudo = ""

		;Texto fixo
		vDsConteudo = "|C114"

		;Código do modelo do documento fiscal
		vStringAux  = "2D"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Número de série de fabricação do ECF
		vStringAux = $item("CD_SERIEFAB",voParams)
		vTotDig    = $length(vStringAux)
		call convString("cd_seriefab.fis_ecf", vStringAux, vTotDig, vStringAux)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Número do caixa atribuído ao ECF
		vStringAux  = $item("NR_ECF",voParams)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Número do documento fiscal
		vStringAux  = $item("NR_CUPOM",voParams)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Data da emissão do documento fiscal
		vDtAux      = DT_EMISSAO.FIS_S_NFSVC
		vStringAux  = "%%vDtAux[7:2]%%vDtAux[5:2]%%vDtAux[1:4]"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Marcador
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "C114"
		ds_registro.sis_arquivosvc = vDsConteudo
	
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("C114")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif
	endif

	return(0)

End ; operation gerarEFDBlocoCRegC114.
;;

;-------------------------------------------;
;-- MAD [Proj/Tar.170/381] - 27/10/2011     ;
partner operation gerarEFDBloco1Reg1700     ;
;-------------------------------------------;
	
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo, vStringAux
	endvariables

	if ($empty("F_TMP_NRDSSVC"))
		return(0)
	endif
	
	setocc "F_TMP_NRDSSVC",-1
	sort/e "F_TMP_NRDSSVC","NR_GERAL.F_TMP_NRDSSVC"
	setocc "F_TMP_NRDSSVC", 1
	while ($status >= 0)
		
		$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 1 - registro 1700 / %%NR_GERAL.F_TMP_NRDSSVC", "", "")
		if ($procerror)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
		endif
		vDsConteudo = ""
		
		;1 - Texto fixo.
		vDsConteudo = "|1700"
		
		;2 - Código dispositivo autorizado
		vStringAux  = "01" ; Formulário de Segurança para Impressão de DANFE
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;3 - Modelo do dispositivo autorizado (documento fiscal)
		vStringAux  = "%%TP_MODDOCFIS.F_TMP_NRDSSVC"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;4 - Série do dispositivo autorizado
		vStringAux  = "%%DS_GERAL.F_TMP_NRDSSVC"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;5 - Subsérie do dispositivo autorizado
		vStringAux  = ""
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"
		
		;6 - Número do dispositivo autorizado inicial
		call retirarNaoNumerico(NR_GERAL.F_TMP_NRDSSVC, vStringAux)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;7 - Número do dispositivo autorizado final
		call retirarNaoNumerico(NR_GERAL.F_TMP_NRDSSVC, vStringAux)
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;8 - Número da autorização
		vStringAux  = "%%NR_RECIBO.F_TMP_NRDSSVC"
		vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

		;Marcador
		vDsConteudo = "%%vDsConteudo%%%|%%^"
	
		creocc "SIS_ARQUIVOSVC", -1
		ds_reg.sis_arquivosvc = "1700"
		ds_registro.sis_arquivosvc = vDsConteudo
	
		$nrLinhaBloco$   = $nrLinhaBloco$   + 1
		$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
		$nrRegistroArq$  = $nrRegistroArq$  + 1
	
		$instancehandle->totalizarQtdTipoRegistro("1700")
		if ($procerror)
			$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		elseif ($status < 0)
			$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
			poCdErro  = $xCdErro$
			poCtxErro = $xCtxErro$
			return(-1)
		endif

		if (TP_SITUACAO.F_TMP_NRDSSVC = "C" | TP_SITUACAO.F_TMP_NRDSSVC = "I")
			;Documentos fiscais cancelados/inutilizados
			$instancehandle->gerarEFDBloco1Reg1710($xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			elseif ($status < 0)
				$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
				poCdErro  = $xCdErro$
				poCtxErro = $xCtxErro$
				return(-1)
			endif
		endif
		
		setocc "F_TMP_NRDSSVC", $curocc("F_TMP_NRDSSVC") + 1
	endwhile
	
	return(0)

End ; operation gerarEFDBloco1Reg1700
;;

;-------------------------------------------;
;-- MAD [Proj/Tar.170/382] - 03/11/2011     ;
partner operation gerarEFDBloco1Reg1710     ;
;-------------------------------------------;
	
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string vDsConteudo, vStringAux
	endvariables
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 1 - registro 1710 / %%NR_GERAL.F_TMP_NRDSSVC", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif
	vDsConteudo = ""
		
	;1 - Texto fixo.
	vDsConteudo = "|1710"
		
	;2 - Número do dispositivo autorizado inicial
	call retirarNaoNumerico(NR_GERAL.F_TMP_NRDSSVC, vStringAux)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;3 - Número do dispositivo autorizado final
	call retirarNaoNumerico(NR_GERAL.F_TMP_NRDSSVC, vStringAux)
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;Marcador
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "1710"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1
	
	$instancehandle->totalizarQtdTipoRegistro("1710")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	return(0)

End ; operation gerarEFDBloco1Reg1710
;;

;---------------------------------------
partner operation gerarEFDBloco1Reg1010
; -> RODRIGO - PRJ 170 TAR 529 - 24/08/2012
;---------------------------------------
	params
		numeric poCdErro  :OUT
		string  poCtxErro :OUT
	endparams
	
	variables
		string  vDsConteudo, vStringAux
	endvariables

	; -> rodrigo - prj 170 tar 529 - 24/08/2012
;	if( $item("REG1100", $verificaMov$) != <TRUE> )&( $item("REG1600", $verificaMov$) != <TRUE> )&( $item("REG1700", $verificaMov$) != <TRUE> )
;		return(0)
;	endif
	; <- rodrigo - prj 170 tar 529 - 24/08/2012
	
	$instancehandle->setDisplay("Gerando Escrituração Fiscal Digital: Bloco 1 - registro 1010", "", "")
	if ($procerror)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
	endif

	vDsConteudo = ""
 	vStringAux = ""

	;Texto fixo.
	vDsConteudo = "|1010"

	;IND_EXP
	if( $item("REG1100", $verificaMov$) = <TRUE> )
		vStringAux = "S"
	else
		vStringAux = "N"
	endif
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;IND_CCRF
	vStringAux = "N"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;IND_COMB
	vStringAux = "N"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;IND_USINA
	vStringAux = "N"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;IND_VA
	vStringAux = "N"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;IND_EE
	vStringAux = "N"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;IND_CART
	if( $item("REG1600", $verificaMov$) = <TRUE> )
		vStringAux = "S"
	else
		vStringAux = "N"
	endif
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;IND_FORM
	if( $item("REG1700", $verificaMov$) = <TRUE> )
		vStringAux = "S"
	else
		vStringAux = "N"
	endif
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;IND_AER
	vStringAux = "N"
	vDsConteudo = "%%vDsConteudo%%%|%%vStringAux"

	;Marcador.
	vDsConteudo = "%%vDsConteudo%%%|%%^"
	
	creocc "SIS_ARQUIVOSVC", -1
	ds_reg.sis_arquivosvc = "1010"
	ds_registro.sis_arquivosvc = vDsConteudo
	
	$nrLinhaBloco$   = $nrLinhaBloco$   + 1
	$nrLinhaArquivo$ = $nrLinhaArquivo$ + 1
	$nrRegistroArq$  = $nrRegistroArq$  + 1


	$instancehandle->totalizarQtdTipoRegistro("1010")
	if ($procerror)
		$instancehandle->setStatus(<STS_ERRO>, $procerror, $procerrorcontext, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	elseif ($status < 0)
		$instancehandle->SetStatus(<STS_ERRO>, $xCdErro$, $xCtxErro$, "")
		poCdErro  = $xCdErro$
		poCtxErro = $xCtxErro$
		return(-1)
	endif

	return(0)

end ;operation gerarEFDBloco1Reg1010